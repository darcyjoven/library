#該程式未解開Section, 採用最新樣板產出!
#該程式為freestyle程式!
{<section id="s_aapp131.description" type="s" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0242(1900-01-01 00:00:00), PR版次:0242(2021-04-12 13:58:34)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000616
#+ Filename...: s_aapp131
#+ Description: 暫估應付批次立帳作業
#+ Creator....: 02097(2014-10-06 15:56:33)
#+ Modifier...: 00000 -SD/PR- 11234
 
{</section>}
 
{<section id="s_aapp131.global" type="s" >}
#應用 p00 樣板自動產生(Version:6)
#add-point:填寫註解說明 name="main.memo"
#141218-00011#5           By albireo  針對產生沖暫估檔增加aapt341,aapt301其他加減項處理
#150106-00011#3           By Belle    修改部門/責任中心預設值
#150121                   By albireo  修改雜項自動沖暫估的金額   
#150126-00012#1  15/01/26 By apo      改為單筆commit方式
#141204-00017#1  15/01/28 By apo      入庫單全部數量立帳的情灀況下,尾差處理
#150128-00005#5  15/01/29 By Belle    產生帳款單時，增加料件的判別
#150210apo       15/02/10 By apo      aapp131增加考慮S-FIN-3012利稅選項;1:不含稅直接取未稅金額給含稅金額,2:含稅則照原處理
#150215          15/02/15 By Belle    修改單身費用科目抓取規則 先抓agli161設定 無資料再抓aapi011設定
#140806-00012#12 15/03/05 By Reanna   增加單價&匯率取位
#150313-00003#2  15/03/18 By Belle    調整會計科目抓取方式(判斷抓進貨科目或者委外加工科目)
#150402          15/04/02 By Belle
#150615          15/06/15 By apo      當參數是不含稅立暫估,且入庫單上的稅別為含稅,那需要把單價先換算成未稅單價才傳入s_tax_ins
#150629-00038#1  15/06/30 By albireo  入庫性質增加20委外採購入庫;17~19借貨相關
#150702-00001#1  15/07/03 By albireo  入庫單性質改以動態抓取
#150821-00003#4  15/08/21 By Hans     收貨單若有輸入發票資料pmdw_t, 則一併將發票資料寫入isam_t
#150812-00010#3  15/08/28 By apo      暫估迴轉否參數抓應付模組;取對應採購單邏輯調整
#150921          15/09/21 By Alberti  因應製造前端進項發票信息欄位異動,不需重新推算本幣
#150921-00148#2  15/09/24 By Belle    AP的付款日期推算, 若採入庫單單張產生帳款者,則推算應付款日及付款到期日應依付款條件aooi716作推算依據。
#150925          15/09/25 By 03538    如果是全部數量立帳,由於原幣金額直接從入庫單重新取得全額,因此本幣金額需要再重新推算
#150930-00012#1  15/09/30 By albireo  對帳單立帳,本幣發票單價應由發票本幣金額回推
#151012-00014#2  15/10/13 By Jessy    帶入日/月平均匯率預設值，依aoos020(S-FIN-3009)設定.
#151014          15/10/15 By albireo  倉退發票呈現負數
#151021          15/10/21 By albireo  倉退折單發票類型取對應入庫單發票類型的折單發票類型
#150703-00021#24 15/11/13 By Hans     增加預算控管
#151124          15/11/24 By albireo  收貨入庫進項發票檔變更欄位,pmdw來源原幣取用邏輯變更
#151130-00015#4  15/12/22 By 02097    訂金沖銷依aoos020 參數S-FIN-3020(是否依單核銷訂金)/IF Y  則只能沖同一張採購單之訂金
#160120-00011#2  16/01/26 By 02097    取用 s_get_item_acc時, 須增加補足可傳入的參數值 
#160519-00011#1  16/05/19 By 03538    效能改善
#160524-00004#1  16/05/31 By 02097    暂估改取单身
#160621-00026#1  16/06/22 By 03538    暫估稅額處理,S-FIN3012含稅立暫估時,要連稅額也產生
#160721-00025#1  16/07/24 By 03538    單頭發票代碼處理
#160603-00009#1  16/07/24 By 03538    沖暫估產生匯差時, 原幣和本幣金額應相同
#160705-00035#3  16/07/26 By Reanna   增加預付&雜項發票立帳流程
#160825-00031#1  16/08/25 By 01727    直接冲账时给未税金额/税额赋值
#160705-00035#5  16/08/30 By Reanna   aapt110的27.待抵寫入直接沖帳時，若是部份沖，未稅金額、稅額、含稅金額是多少就寫入多少
#160816-00022#2  16/09/01 By 06821    暫估單若有稅額時,稅額科目固定取 aapi011 暫估稅額科目
#160816-00022#4  16/09/01 By 06821    1.在沖暫估時價差的比對,用apcb107和沖暫估單的單價apcb101比對,若有差額表示有價差,DIFF 價差應放入未梲金額,稅額不應有 DIFF
#                                     2.若aoos020暫估回轉=Y and立暫估年月<沖暫估年月,則沖暫估訊息apcf科目給null
#160906-00005#1  16/09/06 By albireo  批次拋轉發票來源預設值變更   
#160829-00004#5  16/09/07 By 08729    處理取匯率但取錯幣別
#161014-00046#2  16/10/17 By Reanna   處理倉退單依照不同倉退方式抓取aapi011的會科
#161012-00026#1  16/10/19 By albireo  1.apcb016應依apbb不同類型給予正確的值 2.預付對帳產生的時候應回寫對應訂金多帳期項序的帳款單號
#161026-00048#1  16/11/08 By albireo  s_aapp131_ins_apce_diff apde016需對應給值
#161111-00048#2  16/11/15 By 08171    SUB_程式中DEFINE / INSERT INTO 有星號整批調整
#160802-00007#2  16/11/25 By albireo  加入一次性交易對象處理,從前端來源時承接相同交易對象一路往後帶
#161208-00026#22 16/12/14 By 08732    SUB_程式中DEFINE / INSERT INTO 有星號整批調整(針對SELECT *的部份)
#161215-00061#1  16/12/20 By 05634    修改s_aapp131_ins_apca函式,l_apca.apca008不為NULL再CALL s_fin_date_ap_payable,否則會有sub-01281的訊息
#161216-00021#1  16/12/21 By 05634    沖暫估產生的DIFF,應由本幣/原幣金額反推匯率
#161114-00009#1  17/01/05 By 06821    暫估單單據拋轉效能調校
#170110-00012#1  17/01/10 By 06821    aapp131暫估立帳時付款條件若為空白,造成產生帳款時,取不到付款條件
#170110-00035#1  17/01/20 By Reanna   當對帳來源為7.預付發票立帳時，將apba020給予apca064
#170123-00045#5  17/02/06 By 06821    SQL中撈取資料時使用 rownum 語法撰寫方式調整
#170210-00017#2  17/02/10 by 06814    修正SQL語句沒有ENT條件
#170105-00033#2  17/02/14 By 06821    當對帳單有指定付款到期日時, 作為 aapt300 的票到期日(apca010) ; 當對帳單無指定時, 則依據付款條件計算
#170301-00021#1  17/03/01 By 09263    g_prog整批調整
#161202-00051#1  17/03/06 By 06821    改善預付待抵部分沖銷規格處理(考慮部分預付待抵沖銷diff匯差計算)
#170306-00050#1  17/03/20 By Sabrina  拋轉到aapt300時應抓取入庫單的專案代號到apcb015
#170320-00057#1  17/03/21 By 02114    发票立账时,若单身来源多张对账单,则单头来源单号记录MULTI
#170320-00033#1  17/03/21 By albireo  aapp132拋轉時,計稅基礎(原幣單價*數量)取位幣別需用原幣
#170322-00082#1  17/03/23 By 06821    匯差差異金額判斷調整,請將 s_aapp131_ins_apce_diff_part 與 l_diff_amt > 0 時走 11 類型 ELSE 走 12 類型,11類的是 付款(aapt300) < 帳款(aapq342),12類的是 付款(aapt300) > 帳款(aapq342)
#161102-00015#7  17/03/24 By 06821    未啟用的核算項要放一個空白存檔 
#170322-00115#1  17/03/24 By 05634    1.s_aapp131_ins_apce在計算本幣沖帳金額apce119,應考慮有重評價,需將待抵單多帳期的apcc118+apcc113
#                                     2.s_aapp131_ins_apce_diff增加給apde100
#170323-00106#1  17/03/25 By Sabrina  當程式為aapp134時呼叫s_aapt310_conf_upd
#170324-00130#1  17/03/27 By 06821    轉應付時匯差應以原幣幣別寫入直接付款,否則會造成已付原幣有數字(詢問過中湳)
#170327-00070#1  17/03/27 By 06821    勾選沖訂金待抵,沖銷額不應沖超過立帳額
#170328-00087#1  17/03/29 By 06821    若為銷退單且有維護原始發票號碼時, 應去串原發票類型取出對應的折單類型,發票日期應為原發票日期
#170328-00023#1  17/03/30 By 06821    沖其他暫估單問題: 1.其他沖暫估時若為含稅暫估單, 則沖暫估的寫入錯誤,把含稅暫估金額寫到未稅欄了C20-AP9-170300000003
#                                     2.沖不含稅時會出現二筆一樣的沖暫估資料多出一筆0的資料 ,5區單號:C20-AP9-170300000004
#                                     3.原取暫估單的立帳匯率,改取重評後匯率
#170317-00029#1  17/03/31 By 06821    沖暫估匯率應取暫估單重評匯率 apcc102
#170405-00016#1  17/04/06 By 02599    s_aapp131_ins_apca()中产生单号 时增加axrp141的报错信息
#170406-00053#1  17/04/06 By 06821    原TQC 170328-00087內容改於aapp320 時做調整,mark原修改
#170317-00029#3  17/04/07 By 06821    1.價差寫入 apcf002 ='D1' , 匯差 'D2'以利分攤時選擇   2.沖暫估產生diff時寫沖銷明細檔 apch_t  3.整張沖暫估的本幣部分要以重評匯率重計 4.價差改用計算原幣推算本幣,匯率改用沖暫估t300匯率
#170413-00069#1  17/04/14 By 02114    冲暂估段交易客商,账款客商值给反了
#170405-00030#1  17/04/17 By 06821    寫入apchseq項次應放t300的項次
#170413-00040#1  17/04/18 By 05634    修正s_aapp131_ins_apcf,如有重評價,應將暫估多帳期的 本幣應付金額+重評價調整數 才是本幣可沖暫估金額.
#170420-00033#1  17/04/20 By 02114    预付发票立账,产生的发票开立方式apca060需抓取采购单单头的pmdl046
#170417-00017#1  17/04/24 By 02114    (mark)單身的[存貨科目]取得改為判斷料號若為[E費用性料號],則先看入庫單上有無理由碼
#                                     若有,以【業務部門+理由碼】取費用科目。若無,在判断费用性料号是否有维护成本分群,
#                                     若无,则科目直接给空
#170502-00061#1  17/05/03 By 06821    星號問題未調整,造成沖暫估訊息無產生,導致分錄不平
#161104-00049#6  17/05/04 By Reanna   單身的[存貨科目]取得改為判斷料號若為[E費用性料號]，則先看入庫單上有無理由碼
#                                     若有，以【業務部門+理由碼】取費用科目。若無，依原處理原則，依料號取費用科目。
#170324-00028#1  17/05/04 By 06821    批次拋轉產生的順序,建議排序為: 彙總條件(cond1) > 帳款供應商(pmds008) > 稅別(pmds033) > 付款條件(pmds031) > 入庫/倉退/驗退單號/收票單號(pmdtdocno)
#170510-00041#1  17/05/10 By Hans     1.單頭不再檢核。  
#                                     2.與算細項抓取來源pmdt075，如果沒有就抓abcb021所對應的 預算係項
#                                     3.apca059預算編號給予值
#                                     4.入庫轉立帳回寫轉出金額。
#170430-00006#2  17/05/17 By Sabrina  效能優化
#170519-00002#1  17/05/23 By 06821    直接沖帳部分沖抵時,應是判斷是否有任一單身的待抵單與原始多帳期原幣不同
#170420-00061#1  17/05/25 By Sabrina  應付單身業務部門應抓取請購單的費用部門
#170527-00015#1  17/06/05 By 05634    自動產生沖暫估取消apcc108 - apcc109 <> 0條件,應用數量看
#170503-00065#1  17/06/14 By Hans     aapt110發票立帳 應該帶入發票號碼                  
#170615-00061#1  17/06/15 By 06821    AAP模組多表JOIN時 ent 缺失調整
#170617-00182#1  17/06/17 By 05634    單身能不能打勾沖暫估(apcb023),增加日期的條件去檢查
#170618-00212#1  17/06/21 By Reanna   抓取交易對象的付款對象調整抓法
#170619-00037#1  17/06/23 By Hans     3.單身的發票金額應該呈現對帳單的明細發票號碼  4.預付發票類型修改
#170526-00019#1  17/06/26 By 02114    当了解为E:费用性料件时,若财务分群码没有设置,则科目给空
#170426-00060#1  17/06/30 By Hans     根據單別預設 apca_t之單頭資料
#170619-00025#1  17/07/04 By 06821    aapt110 沒打發票 單身其他減項 , 折讓轉 aapt340 時, 發票號碼 會變 MUTILE
#170706-00015#1  17/07/11 By Hans     預付時，單身預付科目給單頭預付科目
#170710-00040#1  17/07/20 By 05634    修正部份沖暫估有超沖的問題.若是最後一筆交易時(以總數量-之前交易數量=本次數量 則表示最後一次交易),最後一次直接用剩餘金額沖
#170720-00015#1  17/07/24 By 05795    aapt300应付账款维护外币直接冲账时，抛转总账凭证原币金额为未付金额/汇率（凭证日期）倒算出来，导致总账与应付模块应付原币金额产生差异。另外直接冲账时没有体现汇兑损益
#170725-00022#1  17/07/25 By 05634    接續170710-00040#1,EXECUTE s_aapp131_get_apcf320p 抓aapt320立暫估數量,若無則離開FOREACH
#170727-00043#1  17/07/27 By 05634    修正入庫單+項次最後一次沖時,是否超沖的檢查邏輯
#170725-00041#1  17/07/28 By 05795    aapp132产生aapt300，有待抵单可直接冲账，待抵单的汇率和产生的账款单的汇率有差异，会产生汇差资料，目前汇差资料的币别给的原币，但汇率是给的1，汇率也应该给aapt300单头的汇率
#170728-00027#1  170728   By albireo  27的話都以aapt110為主,不要再重算
#170620-00136#1  17/08/07 By 05634    修正由aapp132產生的立帳單，單頭的apca016/apca018為aapt110的資料,應取aapt110發票日期後CALL s_fin_date_ap_payable傳回應付款日
#170620-00129#1  17/08/09 By Sabrina  當aapt110拋到aapt310時，單身會計科目由單頭會計科目帶入
#170822-00003#1  17/08/22 By 05634    修正170526-00019#1在取imag011的sql
#170627-00020#1  17/08/16 By 05634    調整aapt310預付訂金不用全部付完(apcc109>0),待抵單才可以被拿來沖
#170822-00026#1  17/08/24 By 06821    修正#170620-00129#1　原IF l_apcb.apcb001 = '21' THEN　段落排除掉了入庫的科目預帶
#170518-00041#1  17/09/12 By 06821    1.若aapt110 來源作業 apba004 = 18:差異折讓，則要產生對應的差異折讓立帳aapt341且狀態=Y 2.差異折讓產生的aapt341的單據單號(apcadocno)回寫aapt110藍字發票的18:差異折讓來源單號(apba005) 3.差異折讓產生的aapt341的單據需在應付單中的直接沖帳沖掉
#170821-00012#1  17/09/22 By 06821    當aoos020暫估期初迴轉且沖暫估時認列差異(S-FIN-3034)=Y 時,沖暫估訊息給予差異科目,產生差異分錄;為 N時,維持目前規格(不給差異科目),不產生分錄
#170922-00011#1  17/09/25 By 05634    s_aapp131_get_apce027改為稅額去判斷, 如果來源單據單頭稅額=0 則應稅扣抵=N
#170925-00034#1  17/09/29 By 05634    s_aapp131_get_apce027當直接沖帳來源單據的帳款單性質為22:仓退待抵单 或 29:其他待抵单,應稅扣抵(apce027)給予'N'
#170930-00003#1  17/09/30 By 06821    處理差異折讓情境, 需將單頭 帳款科目 放到 單身 13.差異折讓 項次的 存貨科目與稅額科目 如此貸方可與借方到平衡淨額的效果
#170915-00038#8  17/10/30 By 06821    因架構異動, 原沖暫估先進先出撈單號原則取消,改由 aapt301 自行定義原則
#170930-00022#1  17/11/15 By 08729    暫估重評價後是原幣總金額角度重算(多帳期原幣總額*重評價匯率),但沖暫估是沖的數量*aapt320原始原幣單價 再各自*重評價匯率,造成取位落差。
#171120-00011#1  17/11/20 By 05634    修改s_aapp131_ins_apce_diff_part匯差金額的計算
#171204-00022#1  17/12/07 By 05795    头上就写应付暂估时，参数启用冲到明细，修正暂估多账期明细冲到的金额不正确
#171216-00003#1  17/12/18 By 05634    修正s_aapp131_ins_apce,自動寫直接沖帳時,撈aapt110的錢要用SUM的
#171215-00036#1  17/12/20 By 05634    修正171120-00011#1,調整s_aapp131_ins_apce_diff_part匯差計算邏輯
#171109-00014#2  17/12/26 By 04152    入庫立帳時，若有訂單，匯率要分開算
#170618-00029#1  18/01/05 By 10044    在暫估匯差及价差科目產生時,增加判別處理，IF 會計科目有啟用"部門"核算項, 那麼將單頭的"業務部門"帶入沖暫估表中作預設。 apcf026給暫估單單頭業務部門
#171129-00009#1  18/01/10 By 06821    調整原程式寫法:  (l_apca.apca101 * l_apce109_amt)  先取位後再與 l_apce119_amt  減算計算出l_diff
#180109-00036#1  18/01/12 By 06821    未啟用本幣二三則不呼叫傳入幣別取值的處理,避免傳入時檢查幣別為空報錯
#171225-00022#1  18/01/17 By 05016    單頭費用科目沒有帶到單身 沒有取到預算細項時給予警訊, 但仍可形成到aapt3* (因為其他加減項, 可能會修改科目)
#171214-00017#5  18/01/18 By 04152    aapp132若一次性交易單據選擇匯總時，不會拆單
#171214-00017#6  18/01/22 By 04152    aapp133若一次性交易單據選擇匯總時，不會拆單
#171211-00028#13 18/02/08 By 05423    s_axcp500_std_get_std_cost增加参数'产品特征'
#180226-00057#1  18/02/27 By 08734    修正冲暂估时，本币金额变成零问题
#180228-00001#1  18/02/28 By 08734    修正180226-00057单中程式少修改一处问题
#180227-00030#1  18/03/02 By 06821    1.冲销应付暂估单时，冲暂估数量未写入apcf007，目前为空 2.暂估汇差原币单价apcf101应为0
#180307-00027#1  18/03/12 By 06821    來源為其他加項自動產生的直接沖帳調整的匯差有誤
#180306-00040#1  18/03/16 By 06821    1.杂项冲暂估汇差科目抓取错误(错取价差科目) 2.雜項沖暫估匯差diff 不應有原幣金額(僅計算本幣) 且不看aoos020含稅立暫估否,皆以未稅計算
#171229-00043#1  18/03/19 By 06821    單頭的收付款條件為入庫出貨扣帳日選項且單身有入庫出貨等來源單據,重新推算應付款日與到期日與重新展算多帳期(日期推算扣帳日以aooi714設定傳入)
#180314-00018#1  18/03/26 By 00768    产生冲暂估资料时区分组织（aapt300单身可能存在两个据点组织的冲暂估资料）
#180323-00042#1  18/04/04 by 08172    发票立账生成单身时，单身账款对象和付款对象取单头账款对象和付款对象值
#180412-00061#1  18/04/13 By 00768    170317-00029修改的沖暫估匯率應取暫估單重評匯率 apcc102,第一次也是最后一次冲暂估时未按重评价汇率计算，补上(考虑小数误差)
#180327-00063#1  18/04/20 By 08729    在產生直接沖帳裡的預付待抵單時，要跟據預付單的稅別產生稅額再直接沖帳裡
#180425-00047#1  18/04/27 By 00768    修改若待抵有做重评价后，再做aapt110对账，通过aapp132生成aapt300单据时因未考虑重评价汇差导致多产出直接付款apde数据，从而导致科目异常问题
#180313-00054#1  18/05/02 By 05488    新增apca_t時要依單據別抓取參數"D-FIN-0030"給apca037
#180511-00073#1  18/05/11 By 05634    寫沖暫估訊息(apcf_t),如果沖銷參數3,要依暫估單身科目沖
#180516-00002#1  18/05/16 By 05634    延續180511-00073,沖銷參數<>3,維持原處理
#180403-00026#1  18/05/14 By 06821    增加應付帳款單處理雜項暫估差異金額
#180510-00069#1  18/05/22 By 10043    執行aapp132勾選沖銷溢付待抵，報錯:稅種傳入值為空
#180517-00028#1  18/05/24 By 06821    续FUN#180327-00063#直接沖帳金額預帶調整
#180525-00014#1  18/05/25 By 04152    調整拉取待抵單時，增加<立帳單據日期的條件
#180601-00030#1  18/06/05 By 06821    預付單沖銷產生時,判斷稅別同不重推金額(避免有尾差問題)
#180611-00034#1  18/06/11 By 06821    与秋玲确认规则：以本次冲抵的原币税前金额判断是否为全额冲销，若为全额冲销，则不重新推算金额，原币税前、原币税额、原币含税、本币税前、本币税额、本币含税金额都直接抓原订金单金额，部分冲销时维持原来处理。
#180621-00023#1  18/07/05 By 05488    產生暫估單時，應將單頭的帳款對象及付款對象值給到單身的帳款對象及付款對象
#180605-00079#1  18/07/13 By 06821    1.aapp132->aapt300判断是否走自动产生汇差处理，此段判断条件改为：比较订金汇率与立账汇率是否有差，有差额则走自动汇差处理逻辑，无差额则无需走汇差处理的逻辑 
#180711-00016#1  18/07/18 By 05795    冲暂估得时候如果汇率变化，会有多冲得情况
#180130-00050#5  18/07/18 By 10554    INSERT/UPDATE table前，金額匯率相關欄位若為空值須給0
#180718-00024#1  18/07/23 By 06821    杂项发票立账，自动冲账选项勾选“订金待抵”时，自动生成的冲抵金额应不可超过该应付单总金额，目前未卡控，导致生成的应付单总金额变成了负数，多账期无法正常生成
#171005-00006#18 18/07/24 By 10043    增加欄位isam053最終狀態,相關寫入 isam_t 時,統一給 isam036
#180725-00057#1  18/07/26 By 10554    isam014應寫入發票幣別pmds037非pmdw014本幣,避免後續開紅字發票時幣別對不上
#180718-00030#1  18/07/26 By 06821    应付冲账参数=3冲销到明细，含税立暂估,冲暂估信息中冲销的暂估金额不对，比原暂估单本币未税金额多了0.01，造成生成了一笔0.01的暂估差异
#180726-00061#1  18/07/27 By 10043    由aapp141产生的aapt300 呼叫s_aapp131_ins_apca時,核算項帳款對象與付款對象不可為空
#180726-00023#1  18/07/30 By 06821    aapp132參考订金冲销不限制税种相同条件 的參數D-FIN-3008
#180510-00093#1  18/07/31 By 05795    产生汇兑损失的时候要考虑到税额的部分
#180730-00034#1  18/08/01 By 06821    1.對帳單產生帳款單應重新推算票到期日(調整 170105-00033功能,對帳單與帳款單日期相等時才應用直接給付款到期日的處理)  2.單頭業務部門/業務人員若來源單據未取到資訊,則以單頭資訊寫入
#180802-00062#1  18/08/02 By 06821    1. 多角流程產生的單據產生方式為"系統產生" 2.多角產生的帳款不論帳款單別是否自動確認,一律為確認狀態
#180809-00005#2  18/08/17 By 06821    延續170627-00020,改寫SQL組法, for當來源預收付單若為多帳期,單純用apcc109判斷可能不準確,因此改為匯總金額去判斷
#180809-00013#1  18/08/17 By 10043    s_aapp131_ins_apce_diff_part計算差異時,針對相同幣別但匯率不同者,進行直接付款推算
#180823-00003#1  18/08/23 By 08729    直接付款如果是11跟12類的(匯兌損益)後面的帳款性質應該給空
#180620-00006#1  18/08/27 By 10554    若group by選項為7發票開票單號,則將aapt110單頭備註(apbb049)帶到aapt300單頭備註(apca053)
#180704-00022#1  18/08/27 By 10043    自由核算項的取值處理, 依据"費用科目+帳款科目"的聯集, 找出是否有取用自由核算項, 該自由核算項是否有設定在"agli043自由核算項彈性預設作業",若有則自動取值, 若無則不處理。
#180803-00010#1  18/08/28 By 01531    因多角要实现有一站不成功就rollback，所以不能在事务中create tmp
#180904-00066#1  18/09/10 By 05795    s_aapt300_pmdt_up调用得地方加事务回滚
#180910-00069#1  18/09/12 By 05795    单头为空，单身部门不为空的时候，用单身部门传参
#180911-00042#1  18/09/18 By 05488    沖帳金額若為0或是小於0則不寫入沖帳檔(apce)
#180911-00006#2  18/09/21 By 10554    aapp132:待抵單稅別若為含稅,但立帳稅別未含稅會造成超沖
#180914-00037#1  18/09/25 By 05488    暫估開票方式(apca060)應依aoos020參數S-FIN-3012設定而給不同值
#180925-00016#1  18/09/25 By 04152    aapt110抛aapt300时，基准日按扣账日的算法逻辑有错
#181008-00031#1  18/10/09 By 05795    部分冲暂估，考虑来源业务单据一个项次分多笔录入
#180705-00083#1  18/10/15 by 08172    1.单身其他信息页签账款对象,收款对象,业务人员,业务部门为空时给单头
#                                     2.依账款科目+收入科目+税额科目所启用的固定核算项并集，取该固定核算项在agli051的设定值为默认值
#                                     3.依账款科目+收入科目+税额科目所启用的自由核算项并集，取该自由核算项在agli043的设定值为默认值
#181113-00009#1  18/11/13 By 05795    暂估信息得产品类别取应改取apcb012
#181128-00084#1  18/11/29 By 00537    180403-00026改错，把s_aapp131_ins_diff()里汇差的insert段去掉了，导致汇差计算出来的结果不会记录到apcf里
#181030-00022#5  18/11/26 By 05016    修正 預算轉出入改由s_abg進行 
#181203-00041#1  18/12/06 By 05795    其他加项或其他减项如果有料号，收货科目应带出来
#181015-00007#2  18/12/10 By 10554    aapp131產生aapt320時apca060直接寫入1:不開立發票
#181219-00056#1  18/12/19 By 05488    Genero 3.10編譯失敗調整
#180821-00038#16 18/12/25 By 10554    1.對帳單來源作業為16/26拋立帳apcb001轉為19/29,參考單號(apcb008)/項次(apcb009)寫入aapt110對帳單號/項次
#                                     2.改寫s_aapp131_get_apcf新增s_aapp131_get_apcf2
#                                     2.改寫s_aapp131_ins_apcf_diff新增s_aapp131_ins_apcf_diff2,改為直接依帳務歸屬組織抓取apch_t價匯差加總
#190103-00077#1  19/01/07 By 07804    調整委外採購入庫，存貨科目依子件性質細分:代採買抓取agli161存貨科目;其他抓取agli161委外加工費科目
#190104-00036#1  19/01/07 By 05016    修正取imag011 之sql
#190110-00037#1  19/01/10 By 05016    批次立暫估本幣單價取小數位數修正
#190104-00006#1  19/01/10 By 07804    1.修正180412-00061#1中，l_apcf105_sum原幣含稅金額、l_apcf115_sum本幣含稅金額，計算總和位置錯誤，導致出現匯差暫估差異行
#                                     2.修正SQL錯誤
#190124-00045#1  19/01/24 By 10554    1.修正沖銷參數=3時apccseq不存在單身apcb003卻產生apcf_t資料的問題
#                                     2.單價回推未稅:若非雜項使用t300稅別,若為雜項使用t320稅別
#190214-00031#1  19/02/15 By 05016    修正雜項沖暫估單身有兩張不同來源單資料會重複的問題。
#190220-00035#1  19/02/22 By 05634    倉退單若選擇 4:倉退折讓(純金額折讓),單身科目直接取aapi011的"折讓科目"
#190227-00032#1  19/02/27 By 05634    修正190220-00035#1,如果pmds100 null給予空白再判斷
#180920-00015#2  19/03/07 By 10554    對帳單產生至帳款單時, 一併帶入品名資訊 。aapp132 : 單身來源類型為19,29時, 則品名應帶入到AP帳款單身的品名.
#190319-00017#1  19/03/19 By 05795    跨期未暂估不可立账，若有一项跨月未暂估，则整张对账单不进行抛转
#190221-00034#1  19/03/22 By 07804    拆分立帳單時,需增加付款條件的限制
#190329-00027#1  19/04/02 By 05795    判断 直接冲账里的合计原币金额和aapt300立账的原币金额 这个是否相等,如果相等 直接冲账本币金额 和 aapt300立账的本币金额 差 给 汇差
#190416-00030#4  19/04/24 By 05016    新增afat115拋轉其他應付款產生待抵單之方式。
#190424-00024#1  19/04/24 By 05795    管控一下这个入库单是否有暂估单并且暂估日期不要大于立账日期
#190430-00020#1  19/04/30 By 05016    自動展算直接沖帳，推算金額時一律以未稅金額去推算，後續會呼叫s_tax去重新推算。
#190402-00043#1  19/04/23 By 10554    產生apch後,產apcf前要分攤apch含稅本幣金額和apcc未沖本幣金額差異
#190516-00015#1  19/05/17 By 05634    非雜項應取入庫單的稅別,如果拿aapt300的稅別來推算單價,有可能是稅改後的稅別,會造成後續沖暫估金額計算錯誤
#190402-00043#2  19/04/23 By 10554    CALL s_aapp131_get_apcf2前apcc118已被加過apcc113,所以sub裡面不用再加一次apcc113
#190423-00042#1  19/05/14 By 05016    若S-FIN-9025依專案進行帳務處理 則帶入來源單之專案編號以及WBS編號。 
#190605-00072#1  19/06/12 By 05795    全額沖銷得时候需要判断一下待底单是否有被重评价过。如果重评价了那就是它不能取预付单得金额了
#190531-00029#1  19/06/13 By 11234    若apmm202中未维护人员部门，且aapt300有来源单号，应该从来源单aapt110中带出人员部门
#190423-00042#17 19/07/04 By 10043    依專案做帳且沖帳參數為1時,apcf_t錯誤修正
#190731-00005#1  19/07/31 By 05795    纯金额折让单身取aapi011设置需要排除掉委外仓退
#190806-00046#1  19/08/07 By 08729    純金額折讓取科目邏輯修改成 agli161優先，抓不到在去aapi011抓取折讓科目
#190813-00006#1  19/08/15 By 05795    #仓退单存货科目取得原则变更
#190815-00012#1  19/08/16 By 05795    如果启用多库储批收货。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
#190819-00035#1  19/08/19 By 05795    补充#190815-00012#1
#190515-00012#1  19/08/30 By 10554    全額沖銷時,若待抵單的重評匯率<>預付單匯率時,不可直接帶預付單金額，應用重評匯率重推本幣金額
#190812-00010#5  19/09/11 By 01531    抓取收入科目時取 agli161 若有設銷售分群時, 以銷售分群取科目     
#190911-00021#1  19/09/11 By 05795    如果单价为0取消打勾，还需要算上apda014 <> 0 得条件
#191010-00012#1  19/10/11 By 05795    理由码优先序：入库单/仓退单 > 收货单 >采购单 >请购单
#190305-00001#2  19/10/22 By 10500    若【来源作业类型】=21.仓退单 则【出货科目】根据仓退类型优先抓取agli161【仓退/销货退回科目glcc023】【进货金额折让/金额折让科目glccc024】栏位值
#191120-00019#1  19/11/25 By 05795    如果入库单+项次已有在未确认暂估单里，不能产生到账款单里
#181204-00009#1  19/12/11 By 05488    aapt110產生aapt301時，要把單身理由碼欄位給到apcb014且帶出預設的費用科目給apcb021
#191126-00047#1  19/12/23 By 10043    aapp132帳款類別7:預付發票立帳,產生aapt310須一併產生待抵單
#200107-00014#1  20/01/09 By 05795    #用apca018去查apbadocno不正确。因为apca018有可能是MUITL
#200107-00023#1  20/01/10 By 05795    13差异折让在科目取值：存货科目--->aapi011金额折让那一个 ;税额科目--> 取税别设定得科目; 账款科目取单头得
#191226-00040#3  20/01/17 By 10554    1.参数3冲账核销到项次时，产生暂估多账期为立暂估多账期依项次，期别固定0
#                                     2.依料件设置的税种（单身多税种），依入库及仓退单的单身税种重算单身数据(金额）抛转生成
#190423-00042#38 20/02/19 By 10554    參數S-FIN-9025(應收)替換成新參數S-FIN-9026(應付)
#200204-00010#1  20/02/06 By 07804    修正多角產生應付單據aapt300,若來源入庫單數量全部立帳,直接取得原幣與本幣金額,不須重推
#200206-00019#1  20/02/14 By 07804    1.修正入庫單產生立帳單後,立帳單帳款對象=入庫單採購供應商, 付款對象=入庫單[財務資訊]pmds008付款供應商
#                                     2.修正入庫單產生暫估單後,暫估單帳款對象=入庫單採購供應商, 付款對象=入庫單[財務資訊]pmds008付款供應商
#                                     3.對帳產生批次立帳，帳款單的付款對象(apca005)要給對帳單的付款對象(apbb060)
#200210-00028#1  20/02/11 By 05795    如果汇率是1，本币单价就需要推算，直接取原币单价
#200205-00019#1  20/02/14 By 08729    修正當對帳單單身有差異折讓時，產生的直接沖帳金額異常
#191226-00040#7  20/03/10 By 10554    補充191226-00040#3在S-FIN-3012=含稅立暫估時才需控卡
#200218-00040#8  20/03/18 By 05488    相同帳款對象，不同付款對象需拆單
#200407-00022#1  20/04/08 By 05795    27:其他待抵单以aapt110为主，不需要重新推算
#190325-00047#1  20/06/01 By 09406    扣除aapt110的数量
#200402-00022#8  20/07/08 By 10043    稅別為2:依料件設置,aapp132生成的aapt3*時需與aapt110的單身一致
#200612-00001#1  20/07/29 By 10043    拋轉至aapt110，若單身來源為16/26，將理由碼寫入apcb014
#200708-00003#1  20/07/08 by 08172    日期改用USING 
#200828-00021#1  20/08/31 By 10043    aapt110整單操作_轉應付帳款，aapp132勾選訂金待抵，顯示拋轉成功，但實際查無應付單;修改SQL報錯-6372
#200909-00012#1  20/09/10 By 07804    修正多角拋轉單據,aapi011摘要設置有設定商用發票號碼，但分錄沒有取到此資訊
#200904-00065#1  20/10/20 by 08172    多角账款冲销订金待抵时是否按采购单核销订金默认为Y
#200928-00025#1  20/11/04 By 10043    修改aapp131/aapp132/aapp141拋轉立帳單,立帳單別預算管控參數為C,有編預算細項須寫bgbd,沒編的不寫,目前都沒寫bgbd
#201104-00003#1  20/11/04 By 11234    修正190325-00047问题，可立暫估數量 = 計價數量 - 已立帳數量 - 已立暫估數量 - 已对账未立账数量
#201106-00048#1  20/11/09 By 11234    抛转时生成多账期设置优先取aooi200设置，取不到再取aooi716设置
#200805-00007#1  20/11/19 by 08172    费用料件调整理由码取值优先序：请购pmdb031->采购pmdn049->(收货pmdt051->入库(仓退)pmdt051)/收货入库(仓退)pmdt051->空
#200812-00034#1  20/08/13 By 11234    杂项发票的待抵单可产生至aapt301
#200916-00052#1  20/11/25 By 11234    PGS问题修改，子查询返回不止一列
#201127-00012#1  20/12/09 By 14589    調整拋轉立帳單應先轉出入庫單金額再寫入bgbd
#200911-00018#1  20/09/11 By 07804    修正當情境有對帳且立帳，計算可暫估數量=可立帳數量-對帳數量，重複多扣對帳數量
#201223-00041#1  21/01/04 By 08734    修正价差汇差的部门和客商应根据账套科目设置中相应的科目的部门管理和客商管理是否勾选来判断是否带入
#200916-00030#1  20/09/21 By 07804    新增倉退採購合約,計價數量負數相關邏輯處理
#210204-00021#1  21/01/05 By 05795    委个仓退也取agli161的加工费科目
#210218-00022#1  21/02/22 By 05795    本币税前金额如果推算会有差异
#210409-00032#1  21/04/12 By 11234    修正多张对账单立账时折让金额没有回写已付金额的问题
#end add-point
#add-point:填寫註解說明(客製用) name="main.memo_customerization"

#end add-point
#(ver:6) ---start---
#add-point:填寫註解說明(行業用) name="global.memo_industry"

#end add-point
#(ver:6) --- end ---
 
IMPORT os
#add-point:增加匯入項目 name="main.import"
IMPORT util
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
#add-point:增加匯入變數檔 name="global.inc"
GLOBALS "../../../com/sub/4gl/s_axcp500.inc"    #160107-00001#1
#end add-point
 
{</section>}
 
{<section id="s_aapp131.free_style_variable" type="s" >}
#add-point:free_style模組變數(Module Variable) name="free_style.variable"

#end add-point
 
{</section>}
 
{<section id="s_aapp131.global_variable" type="s" >}
#add-point:自定義模組變數(Module Variable) name="global.variable"
TYPE type_apcf_tmp   RECORD
         apca001     LIKE apca_t.apca001,
         apcborga    LIKE apcb_t.apcborga,      #150417-00007#87
         apcfseq     LIKE apcf_t.apcfseq,
         apcf103     LIKE apcf_t.apcf103,
         apcf104     LIKE apcf_t.apcf104,
         apcf105     LIKE apcf_t.apcf105,
         apcf106     LIKE apcf_t.apcf106,
         apcf107     LIKE apcf_t.apcf117,
         apcf113     LIKE apcf_t.apcf113,
         apcf114     LIKE apcf_t.apcf114,
         apcf115     LIKE apcf_t.apcf115,
         apcf116     LIKE apcf_t.apcf116,
         apcf117     LIKE apcf_t.apcf117,
         apcf123     LIKE apcf_t.apcf123,
         apcf124     LIKE apcf_t.apcf124,
         apcf125     LIKE apcf_t.apcf125,
         apcf133     LIKE apcf_t.apcf133,
         apcf134     LIKE apcf_t.apcf134,
         apcf135     LIKE apcf_t.apcf135 
                 END RECORD

DEFINE g_dfin5002    LIKE type_t.chr1     #新增預算控管   #150703-00021#24
DEFINE g_xcag001     LIKE xcag_t.xcag001  #160107-00001#1
DEFINE g_xcat005     LIKE xcat_t.xcat005  #160107-00001#1
DEFINE g_apcacomp    LIKE apca_t.apcacomp #160107-00001#1
DEFINE g_apca100_std LIKE apca_t.apca100  #160107-00001#1
DEFINE g_apca101_std LIKE apca_t.apca100  #160107-00001#1
DEFINE g_glaa015     LIKE glaa_t.glaa015  #160107-00001#1
DEFINE g_glaa019     LIKE glaa_t.glaa019  #160107-00001#1
DEFINE g_apbb055ty2  LIKE apbb_t.apbb055  #170105-00033#2 add
#170430-00006#2---add---start---
DEFINE g_glaa001     LIKE glaa_t.glaa001  
DEFINE g_ooaj003     LIKE ooaj_t.ooaj003  
DEFINE g_ooaj003_g   LIKE ooaj_t.ooaj003  
DEFINE g_ooaj004     LIKE ooaj_t.ooaj004  
DEFINE g_ooaj004_g   LIKE ooaj_t.ooaj004  
DEFINE g_ooaj005     LIKE ooaj_t.ooaj005  
DEFINE g_ooaj005_g   LIKE ooaj_t.ooaj005  
DEFINE g_ooaj006     LIKE ooaj_t.ooaj006  
DEFINE g_ooaj006_g   LIKE ooaj_t.ooaj006  
DEFINE g_ooaj007     LIKE ooaj_t.ooaj007  
DEFINE g_ooaj007_g   LIKE ooaj_t.ooaj007  
DEFINE g_round_type  LIKE ooaa_t.ooaa002  
DEFINE g_ooaj004_g2  LIKE ooaj_t.ooaj004  
DEFINE g_ooaj004_g3  LIKE ooaj_t.ooaj004  
#170430-00006#2---add---end---
DEFINE g_type        LIKE type_t.chr1 #立帳方式 #170706-00015#1 add
#170518-00041#1 --s add 判斷是否執行差異折讓立帳 
GLOBALS
   DEFINE g_apba004_18  LIKE type_t.chr1  
END GLOBALS
#170518-00041#1 --e add
DEFINE g_prog1    STRING  #180704-00022#1 add  #拋轉程式代號
DEFINE g_sel1      LIKE type_t.chr1  #180620-00006#1 add
DEFINE g_sel2      LIKE type_t.chr1  #180620-00006#1 add
DEFINE g_price       LIKE type_t.chr1     #190911-00021#1---add
#end add-point
 
{</section>}
 
{<section id="s_aapp131.other_dialog" type="s" >}

 
{</section>}
 
{<section id="s_aapp131.other_function" readonly="Y" type="s" >}

################################################################################
# Descriptions...: Temp
# Memo...........:
# Usage..........: CALL s_aapp131_cre_tmp()
# Date & Author..: 14/10/06 By Belle
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_cre_tmp()
   WHENEVER ERROR CONTINUE

   DROP TABLE s_aapp131_tmp_g #ODI-ORA#

   CREATE TEMP TABLE s_aapp131_tmp_g(
      pmdsent        LIKE pmds_t.pmdsent,
      pmdsdocdt      LIKE pmds_t.pmdsdocdt,  #單據日期
      pmds000        LIKE pmds_t.pmds000,    #單據性質(SCC:2060--6:入庫/5:驗退/7:倉退)
      pmds007        LIKE pmds_t.pmds007,    #採購供應商(*)==>apca004
      pmds008        LIKE pmds_t.pmds008,    #帳款供應商   ==>apca005
      pmds031        LIKE pmds_t.pmds031,    #付款條件(*)
      pmds033        LIKE pmds_t.pmds033,    #稅別(*)
      pmds037        LIKE pmds_t.pmds037,    #幣別(*)
      pmds038        LIKE pmds_t.pmds038,    #匯率(*)
      pmdtsite       LIKE pmdt_t.pmdtsite,   #營運據點
      pmdtdocno      LIKE pmdt_t.pmdtdocno,  #入庫/倉退/驗退單號/收票單號(*)
      pmdtseq        LIKE pmdt_t.pmdtseq,    #入庫項次/收票項次
      pmdt001        LIKE pmdt_t.pmdt001,    #來源單號
      pmdt006        LIKE pmdt_t.pmdt006,    #料件編號
      pmdt019        LIKE pmdt_t.pmdt019,    #入庫單位
      pmdt024        LIKE pmdt_t.pmdt024,    #入庫數量
      pmdldocno      LIKE pmdl_t.pmdldocno,  #採購單號
      pmdl002        LIKE pmdl_t.pmdl002,    #採購單-採購人員
      pmdl003        LIKE pmdl_t.pmdl003,    #採購單-採購部門
      apcb007        LIKE apcb_t.apcb007,    #可立帳數量      
      apbb050        LIKE apbb_t.apbb050,    #發票性質(*)
      apca007        LIKE apca_t.apca007,    #帳款類型
      cond1          LIKE type_t.chr500,     #彙總條件
      apba005        LIKE apba_t.apba005,    #參考單號
      apba006        LIKE apba_t.apba006,    #參考項次
      pmds028        LIKE pmds_t.pmds028     #一次性交易對象   #160802-00007#2
   );
   IF SQLCA.sqlcode THEN                    
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = FALSE
      CALL cl_err()
   END IF
   #若有需要產生分錄時要呼叫的TEMP TABLE
   CALL s_aapp330_cre_tmp() RETURNING g_sub_success
   CALL s_tax_declare()   #160519-00011#1   
END FUNCTION

################################################################################
# Descriptions...: 立帳單頭
# Memo...........:
# Usage..........: 
# Date & Author..: 14/10/06 By Belle
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apca(ls_js)
DEFINE lc_param_apca RECORD
         type        LIKE type_t.chr1,     #類型(1:p131/2:p132/3:p133)
         sel1        LIKE type_t.chr1,     #立帳方式
         sel2        LIKE type_t.chr1,     #彙總方式(影響取匯率)
         slip        LIKE apca_t.apcadocno,#單別
         site        LIKE apca_t.apcasite, #帳務中心
         ld          LIKE apca_t.apcald,   #帳套
         wc2         STRING,               #沖銷類型
         bgjob       LIKE type_t.chr1,     #是否背景執行
         apca063     LIKE apca_t.apca063   #整帳批序號
         ,price       LIKE type_t.chr1     #190911-00021#1---add
                 END RECORD
#DEFINE p_type       LIKE type_t.chr1      #類型(1:p131/2:p132/3:p133)
#DEFINE p_sel1       LIKE type_t.chr1      #立帳方式
#DEFINE p_sel2       LIKE type_t.chr1      #彙總方式
#DEFINE p_slip       LIKE apca_t.apcadocno #單別
#DEFINE p_site       LIKE apca_t.apcasite  #帳務中心
#DEFINE p_ld         LIKE apca_t.apcald    #帳套
#DEFINE p_wc2        STRING                #沖銷類型
#DEFINE p_bgjob      LIKE type_t.chr1      #是否背景執行
DEFINE r_strno       LIKE apca_t.apcadocno
DEFINE r_endno       LIKE apca_t.apcadocno
DEFINE r_success     LIKE type_t.num5
                    
DEFINE l_amount      RECORD
          apcb103    LIKE apcb_t.apcb103,
          apcb113    LIKE apcb_t.apcb113,
          apcb123    LIKE apcb_t.apcb123,
          apcb133    LIKE apcb_t.apcb133,
          xrcd104    LIKE xrcd_t.xrcd104,
          xrcd114    LIKE xrcd_t.xrcd114,
          xrcd124    LIKE xrcd_t.xrcd124,
          xrcd134    LIKE xrcd_t.xrcd134,
          apca106    LIKE apca_t.apca106,
          apca116    LIKE apca_t.apca116,
          apca126    LIKE apca_t.apca126,
          apca136    LIKE apca_t.apca136,
          apca107    LIKE apca_t.apca107,
          apca117    LIKE apca_t.apca117,
          apca127    LIKE apca_t.apca127,
          apca137    LIKE apca_t.apca137,
          apca108    LIKE apca_t.apca108,
          apca118    LIKE apca_t.apca118,
          apca128    LIKE apca_t.apca128,
          apca138    LIKE apca_t.apca138
                 END RECORD
#DEFINE l_apca        RECORD LIKE apca_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
#161111-00048#2 --e add
DEFINE l_apcacomp    LIKE apca_t.apcacomp
DEFINE l_glaa016     LIKE glaa_t.glaa016
DEFINE l_glaa020     LIKE glaa_t.glaa020
DEFINE l_glaa121     LIKE glaa_t.glaa121
DEFINE l_slip        LIKE apca_t.apcadocno
DEFINE l_sfin2002    LIKE type_t.chr1
DEFINE l_desc        LIKE type_t.chr50
DEFINE l_sql         STRING
DEFINE l_prog        STRING
DEFINE l_date        DATETIME YEAR TO SECOND
DEFINE l_ar          RECORD
         pmdsdocdt   LIKE pmds_t.pmdsdocdt,   #單據日期
         pmds000     LIKE pmds_t.pmds000,     #單據性質
         pmds007     LIKE pmds_t.pmds007,     #採購供應商(交易對象)
         pmds033     LIKE pmds_t.pmds033,     #稅別
         pmds037     LIKE pmds_t.pmds037,     #幣別
         pmds038     LIKE pmds_t.pmds038,     #匯率
         apca007     LIKE apca_t.apca007,     #帳款類型
         cond1       LIKE type_t.chr500,      #彙總條件    
         pmds031     LIKE pmds_t.pmds031,      #付款條件
         pmds028     LIKE pmds_t.pmds028      #一次性交易對象    #160802-00007#2
                END RECORD
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_chr         LIKE type_t.chr1
DEFINE l_apca065     LIKE apca_t.apca065
DEFINE l_apca066     LIKE apca_t.apca066
#DEFINE l_apcb008     LIKE apbb_t.apbb008    #171109-00014#2 mark
DEFINE l_xrcd009     LIKE xrcd_t.xrcd009     #稅額會計科目
DEFINE l_apcc109     LIKE apcc_t.apcc109
DEFINE l_ap_slip     LIKE apca_t.apcadocno
DEFINE l_str         LIKE type_t.chr80
DEFINE l_ecom0005    LIKE type_t.num5        #單號長度   #150126-00012#1
DEFINE l_glaa001     LIKE glaa_t.glaa001     #140806-00012#12
DEFINE l_apcb049     LIKE apcb_t.apcb049  
DEFINE ls_js         STRING
DEFINE lc_param_rate RECORD
         type        LIKE type_t.chr1,       #類型
         apca004     LIKE apca_t.apca004,    #交易對象
         docno       LIKE apca_t.apcadocno   #單號
                 END RECORD
DEFINE l_array DYNAMIC ARRAY OF  RECORD
         chr         LIKE type_t.chr1000,
         dat         LIKE type_t.dat
                END RECORD
DEFINE l_date1       LIKE type_t.dat      #150921-00148#2
DEFINE l_date2       LIKE type_t.dat      #150921-00148#2
DEFINE l_date3       LIKE type_t.dat      #150921-00148#2
DEFINE l_date4       LIKE type_t.dat      #150921-00148#2
DEFINE l_apca018     LIKE apca_t.apca018  #150921-00148#2
DEFINE l_tran  RECORD                     #150703-00021#24  ---s---
         act         LIKE type_t.chr10,   #[1].chr 動作
         site        LIKE ooef_t.ooef001, #[2].chr 預算組織
         dat         LIKE type_t.dat,     #[3].dat 日期
         bgae001     LIKE bgae_t.bgae001  #[4].chr 預算項目
                 END RECORD               #150703-00021#24   ---e---
DEFINE l_success     LIKE type_t.num5     #151125-00006#2--S
DEFINE l_doc_success LIKE type_t.num5
DEFINE l_dfin0031    LIKE type_t.chr1
DEFINE l_count       LIKE type_t.num5     #151125-00006#2--E
DEFINE l_glaa120     LIKE glaa_t.glaa120  #160107-00001#1
DEFINE l_cnt_27      LIKE apcb_t.apcb001  #160705-00035#3
#160829-00004#5--add(s)
DEFINE l_glaa015     LIKE glaa_t.glaa015
DEFINE l_glaa017     LIKE glaa_t.glaa017
DEFINE l_glaa019     LIKE glaa_t.glaa019
DEFINE l_glaa021     LIKE glaa_t.glaa021
#160829-00004#5--add(e)
DEFINE l_pmds100     LIKE pmds_t.pmds100  #161014-00046#2
#170406-00053#1 --s mark
##170328-00087#1 --s add
#DEFINE l_isam008     LIKE isam_t.isam008
#DEFINE l_isam011     LIKE isam_t.isam011
#DEFINE l_isac009     LIKE isam_t.isam008
##170328-00087#1 --e add
#170406-00053#1 --e mark
DEFINE l_apba005     LIKE apba_t.apba005    #170420-00033#1 add lujh
DEFINE l_pmdl046     LIKE pmdl_t.pmdl046    #170420-00033#1 add lujh
DEFINE l_apca059_desc LIKE type_t.chr100    #170510-00041#1
DEFINE l_str2         STRING                 #170430-00006#2 add
DEFINE l_cnt_18       LIKE apcb_t.apcb001   #170518-00041#1 add
#171109-00014#2 add ------
DEFINE lc_param_115  RECORD
          ld            LIKE apca_t.apcald,
          pmdt001       LIKE pmdt_t.pmdt001,
          pmdtdocno     LIKE pmdt_t.pmdtdocno,
          apcbdocno     LIKE apcb_t.apcbdocno,
          apcbseq       LIKE apcb_t.apcbseq,
          apcb103       LIKE apcb_t.apcb103,
          apca012       LIKE apca_t.apca012,
          apca101       LIKE apca_t.apca101
                     END RECORD
DEFINE l_apcb113     LIKE apcb_t.apcb113
DEFINE l_apcb114     LIKE apcb_t.apcb114
DEFINE l_apcb115     LIKE apcb_t.apcb115
DEFINE l_flag2       LIKE type_t.chr10
DEFINE l_apcbseq     LIKE apcb_t.apcbseq
DEFINE l_apcb002     LIKE apcb_t.apcb002
DEFINE l_apcb008     LIKE apcb_t.apcb008
DEFINE l_apcb103     LIKE apcb_t.apcb103
#171109-00014#2 add end---
#171229-00043#1 --s add
DEFINE l_apca009 LIKE apca_t.apca009
DEFINE l_apca010 LIKE apca_t.apca010
#171229-00043#1 --e add
DEFINE l_sfin3012    LIKE type_t.chr1         #暫估含稅否     #180914-00037#1 add
DEFINE l_pmds008     LIKE pmds_t.pmds008      #來源入庫單:[財務資訊]付款供應商 #200206-00019#1 add


   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   LET g_type = ''  #170706-00015#1 add
   
   CALL util.JSON.parse(ls_js,lc_param_apca)
   
   #190911-00021#1---add--str
   LET g_price = lc_param_apca.price
   IF cl_null(g_price) THEN
      LET g_price = 'Y'
   END IF
   #190911-00021#1---add--str
 
   IF cl_null(lc_param_apca.bgjob) THEN LET lc_param_apca.bgjob = 'Y' END IF
   LET l_ecom0005 = cl_get_para(g_enterprise,'','E-COM-0005')
   LET l_str = s_fin_get_colname('aapt300','apcadocno') CLIPPED,':' CLIPPED  
   LET g_sel1 = lc_param_apca.sel1  #180620-00006#1 add
   LET g_sel2 = lc_param_apca.sel2  #180620-00006#1 add
   #150126-00012#1--str--
   #本次立帳之入庫單lock cursor
   LET l_sql = " SELECT pmdtdocno,pmdtseq ",
               " FROM pmdt_t",
               " WHERE pmdtent= ? AND pmdtdocno=? AND pmdtseq=? FOR UPDATE "
   DECLARE s_aapp131_pmdt_cl CURSOR FROM l_sql                 
   #150126-00012#1--end--
   #170430-00006#2---add---start---
   LET l_sql = "SELECT apbbent,apbbownid,apbbowndp,apbbcrtid,apbbcrtdp,",
               " apbbcrtdt,apbbmodid,apbbmoddt,apbbcnfid,apbbcnfdt,",
               " apbbstus,apbbcomp,apbbdocno,apbbseq,apbbdocdt,",
               " apbb001,apbb002,apbb004,apbb006,apbb008,",
               " apbb009,apbb010,apbb011,apbb012,apbb0121,",
               " apbb013,apbb014,apbb015,apbb016,apbb017,", 
               " apbb018,apbb019,apbb020,apbb021,apbb022,",   
               " apbb023,apbb024,apbb025,apbb026,apbb027,", 
               " apbb028,apbb029,apbb030,apbb031,apbb032,", 
               " apbb033,apbb034,apbb035,apbb036,apbb037,", 
               " apbb038,apbb039,apbb040,apbb041,apbb042,", 
               " apbb043,apbb044,apbb045,apbb046,apbb047,", 
               " apbb048,apbb049,apbb050,apbb051,apbb052,", 
               " apbb053,apbb054,apbb107,apbb108,apbb117,", 
               " apbb118,apbb200,apbb201,apbb202,apbb203,", 
               " apbb204,apbb205,apbb206,apbb207,apbb208,", 
               " apbb209,apbb210,apbbud001,apbbud002,apbbud003,", 
               " apbbud004,apbbud005,apbbud006,apbbud007,apbbud008,", 
               " apbbud009,apbbud010,apbbud011,apbbud012,apbbud013,", 
               " apbbud014,apbbud015,apbbud016,apbbud017,apbbud018,", 
               " apbbud019,apbbud020,apbbud021,apbbud022,apbbud023,", 
               " apbbud024,apbbud025,apbbud026,apbbud027,apbbud028,", 
               " apbbud029,apbbud030,apbb055,apbb056,apbb057,", 
               " apbb058,apbb003", 
               " FROM apbb_t ",
               "WHERE apbbent = ? AND apbbdocno = ? "
   PREPARE s_aapp131_apbb_p FROM l_sql
   DECLARE s_aapp131_apbb_c CURSOR FOR s_aapp131_apbb_p 
   LET l_sql = "SELECT apbaent,apbadocno,apbaorga,apba001,apba002,",
               "       apba003,apbaseq,apba004,apba005,apba006,",
               "       apba007,apba008,apba009,apba010,apba011,",
               "       apba012,apba013,apba014,apba015,apba016,",
               "       apba017,apba100,apba103,apba104,apba105,",
               "       apba111,apba113,apba114,apba115,apbaud001,",
               "       apbaud002,apbaud003,apbaud004,apbaud005,apbaud006,",
               "       apbaud007,apbaud008,apbaud009,apbaud010,apbaud011,",
               "       apbaud012,apbaud013,apbaud014,apbaud015,apbaud016,",
               "       apbaud017,apbaud018,apbaud019,apbaud020,apbaud021,",
               "       apbaud022,apbaud023,apbaud024,apbaud025,apbaud026,",
               "       apbaud027,apbaud028,apbaud029,apbaud030,apba018,",
               "       apba019,apba020",
               #"      ,apba022,apba023 ", #190423-00042#1 add       #181204-00009#1 mark
               "      ,apba022,apba021,apba023 ",                    #181204-00009#1 add
               " FROM apba_t ",
               "WHERE apbaent = ? AND apbadocno = ? AND apbaseq = ?"
   PREPARE s_aapp131_apba_p FROM l_sql
   DECLARE s_aapp131_apba_c CURSOR FOR s_aapp131_apba_p 
   LET l_sql = "INSERT INTO apcb_t(apcbent,apcbld,apcblegl,apcborga,apcbsite,",
               " apcbdocno,apcbseq,apcb001,apcb002,apcb003,",
               " apcb004,apcb005,apcb006,apcb007,apcb008,", 
               " apcb009,apcb010,apcb011,apcb012,apcb013,", 
               " apcb014,apcb015,apcb016,apcb017,apcb018,", 
               " apcb019,apcb020,apcb021,apcb022,apcb023,", 
               " apcb024,apcb025,apcb026,apcb027,apcb028,", 
               " apcb029,apcb030,apcb032,apcb033,apcb034,", 
               " apcb035,apcb036,apcb037,apcb038,apcb039,", 
               " apcb040,apcb041,apcb042,apcb043,apcb044,", 
               " apcb045,apcb046,apcb047,apcb048,apcb049,", 
               " apcb050,apcb051,apcb100,apcb101,apcb102,", 
               " apcb103,apcb104,apcb105,apcb106,apcb107,", 
               " apcb108,apcb111,apcb113,apcb114,apcb115,", 
               " apcb116,apcb117,apcb118,apcb119,apcb121,", 
               " apcb123,apcb124,apcb125,apcb126,apcb127,", 
               " apcb128,apcb131,apcb133,apcb134,apcb135,", 
               " apcb136,apcb137,apcb138,apcbud001,apcbud002,", 
               " apcbud003,apcbud004,apcbud005,apcbud006,apcbud007,", 
               " apcbud008,apcbud009,apcbud010,apcbud011,apcbud012,", 
               " apcbud013,apcbud014,apcbud015,apcbud016,apcbud017,", 
               " apcbud018,apcbud019,apcbud020,apcbud021,apcbud022,", 
               " apcbud023,apcbud024,apcbud025,apcbud026,apcbud027,", 
               " apcbud028,apcbud029,apcbud030,apcb052,apcb053,", 
               " apcb054,apcb055) ",
               "VALUES(?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,", 
               "       ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,", 
               "       ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,", 
               "       ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,", 
               "       ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?) "
   PREPARE s_aapp131_ins_apcb_c FROM l_sql
   #170430-00006#2---add---end---
   #160107-00001#1--(S)
   #1.确定"标准成本分类"
   LET g_xcat005 = 'N'
   CALL s_ld_sel_glaa(lc_param_apca.ld,'glaa001|glaa025|glaa018|glaa022|glaa120|glaa015|glaa019')
        RETURNING g_sub_success,g_curr[1].curr,g_curr[1].type2,g_curr[2].type2,g_curr[3].type2,l_glaa120,g_glaa015,g_glaa019
   IF NOT cl_null(l_glaa120) THEN
      #以帳套檢核, 該帳套是否有啟用"標準成本"處理，取agli010的設置成本計算類型glaa120，若在axci100的計價方式值為1.標準成本
      #SELECT count(*) INTO l_cnt      #161114-00009#1 mark
      SELECT count(xcat001) INTO l_cnt #161114-00009#1 add
        FROM xcat_t
       WHERE xcatent = g_enterprise AND xcat005 ='1'
         AND xcat001 = l_glaa120
      IF l_cnt > 0 THEN LET g_xcat005 = 'Y' END IF
      IF g_xcat005 = 'Y' THEN
         SELECT xcaa001 INTO g_xcag001
           FROM xcaa_t
          WHERE xcaaent = g_enterprise AND xcaa002 = 'Y'   
         LET g_field_type = '1'
      END IF
   END IF   
   #160107-00001#1--(E)
   
   CASE lc_param_apca.type
        WHEN '1'  #暫估立帳
                  LET l_sql = "SELECT DISTINCT pmdsdocdt,pmds000,pmds007,pmds033,pmds037,",
                              "                pmds038  ,apca007,cond1"
        WHEN '2'  #發票立帳
                  LET l_sql = "SELECT DISTINCT pmdsdocdt,''     ,pmds007,pmds033,pmds037,",
                              "                pmds038  ,apca007,cond1"
        WHEN '3'  #入庫立帳
                  LET l_sql = "SELECT DISTINCT pmdsdocdt,pmds000,pmds007,pmds033,pmds037,",
                              "                pmds038  ,apca007,cond1"              
   END CASE
   #160829-00004#5--mark(s)
   #CALL s_ld_sel_glaa(lc_param_apca.ld,'glaacomp|glaa001|glaa016|glaa020|glaa121') 
   #     RETURNING  g_sub_success,l_apcacomp,l_glaa001,l_glaa016,l_glaa020,l_glaa121
   #160829-00004#5--mark(e)
   #160829-00004#5--add(s)
   CALL s_ld_sel_glaa(lc_param_apca.ld,'glaacomp|glaa001|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa121')  
        RETURNING  g_sub_success,l_apcacomp,l_glaa001,l_glaa015,l_glaa016,
                    l_glaa017,l_glaa019,l_glaa020,l_glaa021,l_glaa121
   #160829-00004#5--add(e)
   CALL cl_get_para(g_enterprise,l_apcacomp,'S-FIN-2002') RETURNING l_sfin2002
   CALL cl_get_para(g_enterprise,l_apcacomp,'S-FIN-3012') RETURNING l_sfin3012                #180914-00037#1 add
   #170110-00012#1 --s mark
   ##若為沖銷參數1/2 彙總條件增加付款條件
   #IF l_sfin2002 MATCHES '[12]' THEN   
   #   LET l_sql = l_sql,",pmds031"
   #ELSE
   #   LET l_sql = l_sql,",''"
   #END IF
   #170110-00012#1 --e mark
   LET l_sql = l_sql,",pmds031"  #170110-00012#1 add sql組入欄位不需依據沖銷參數,皆直接組入付款條件
   
   #160802-00007#2-----s
   LET l_sql = l_sql,",pmds028"    #一次性交易對象
   #160802-00007#2-----e
   #200206-00019#1-(S) add  
   LET l_sql = l_sql," ,pmds008 "  #入/退庫付款供應商   
   #200206-00019#1-(E) add
   LET l_sql = l_sql,"  FROM s_aapp131_tmp_g"
   
   #LET l_sql = l_sql,"  ORDER BY cond1,pmds007,pmds033,pmds031 "  #170324-00028#1 add   #200218-00040#8 mark
   LET l_sql = l_sql," ORDER BY cond1,pmds007,pmds008,pmds033,pmds031 "                  #200218-00040#8 add
   PREPARE s_aapp131_ins_apca_p FROM l_sql
   DECLARE s_aapp131_ins_apca_c CURSOR WITH HOLD FOR s_aapp131_ins_apca_p
   #計算迴圈筆數
   IF lc_param_apca.bgjob = 'N' THEN
      DISPLAY '' ,0 TO stagenow,stagecomplete
      #LET l_sql = "SELECT count(*) FROM (",l_sql,") tsed"  #161114-00009#1 mark
      #LET l_sql = "SELECT count(1) FROM (",l_sql,") tsed"   #161114-00009#1 add   #PGS(D)-00824 mark
      LET l_sql = "SELECT count(1) FROM (",l_sql,") t51 "   #161114-00009#1 add   #PGS(D)-00824
      PREPARE s_aapp131_cnt_apca_p FROM l_sql
      DECLARE s_aapp131_cnt_apca_c SCROLL CURSOR FOR s_aapp131_cnt_apca_p
      OPEN s_aapp131_cnt_apca_c
      FETCH s_aapp131_cnt_apca_c INTO l_cnt
      IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF
      CALL cl_progress_bar_no_window(l_cnt)
      CLOSE s_aapp131_cnt_apca_c
   END IF
   #計算迴圈筆數(E)
   #取得請購單號(S)
   #150812-00010#3 mark--s
   #LET l_sql = "SELECT pmdp003 ",
   #            "  FROM pmdp_t",
   #            " WHERE pmdpent = ",g_enterprise,
   #            "   AND pmdpdocno= ? AND pmdpseq = ?",
   #            " ORDER BY pmdpent,pmdpdocno,pmdpseq,pmdpseq1"
   #150812-00010#3 mark--e   
   #170420-00061#1---mark---start---  
   ##150812-00010#3--s
   #LET l_sql = "SELECT pmdl008 ",
   #            "  FROM pmdl_t ",
   #            " WHERE pmdlent = ",g_enterprise,
   #            "   AND pmdldocno = ? ",
   #            "   AND pmdl007 = '2' "   #請購單               
   ##150812-00010#3--e
   #DECLARE pmdp_t_c1 SCROLL CURSOR FROM l_sql
   #170420-00061#1---mark---end---
   #取得請購單號(E)
   #170420-00061#1---add---start---
   LET l_sql = "SELECT pmdp003,pmdp004",
               " FROM pmdp_t",
               " WHERE pmdpent = ",g_enterprise,
               "   AND pmdpdocno = ? AND pmdpseq = ?",
               "   AND pmdpseq1 = (SELECT MIN(pmdpseq1) FROM pmdp_t WHERE pmdpent = ",g_enterprise,
               "                   AND pmdpdocno = ? AND pmdpseq= ?)"
   PREPARE pmdp_t_c1 FROM l_sql
   #170420-00061#1---add---end---
   #170420-00061#1---add---start---
   LET l_sql = "SELECT pmda002,pmda007,pmdb046",
               " FROM pmda_t LEFT JOIN pmdb_t ON pmdaent = pmdbent AND pmdadocno = pmdbdocno",
               " WHERE pmdaent = ",g_enterprise,
               " AND pmdadocno = ? AND pmdbseq = ?"
   PREPARE pmda_t_p FROM l_sql
   #170420-00061#1---add---end---    
   
   #161114-00009#1 --s add
   #迴圈內SELECT外搬PREPARE
   LET l_sql = " SELECT pmaa080,pmaa047 ",
               "   FROM pmaa_t ",
               "  WHERE pmaaent = ",g_enterprise," AND pmaa001 = ? "
   PREPARE s_aapp131_get_pmaap FROM l_sql  

   LET l_sql = " SELECT ooib025,ooib005 ",
               "   FROM ooib_t ",
               "  WHERE ooibent = ",g_enterprise," AND ooib002 = ? " 
   PREPARE s_aapp131_get_ooibp FROM l_sql  

   LET l_sql = " SELECT COUNT(apcbdocno) ",
               "   FROM apcb_t ",
               "  WHERE apcbent = ",g_enterprise," AND apcbld = ? AND apcbdocno = ? "
   PREPARE s_aapp131_cnt_apcbp FROM l_sql   
   
   LET l_sql = " SELECT COUNT(xrcddocno)  ",
               "   FROM xrcd_t ",
               "  WHERE xrcdent = ",g_enterprise," AND xrcdld = ? AND xrcddocno = ? AND xrcd009 IS NULL  "
   PREPARE s_aapp131_cnt_xrcdp FROM l_sql    
   
   LET l_sql = " SELECT COUNT(xrcddocno) ",
               "   FROM xrcd_t ",
               "  WHERE xrcdent = ",g_enterprise," AND xrcdld = ? AND xrcddocno = ?  "
   PREPARE s_aapp131_cnt_xrcdp1 FROM l_sql     
   
   LET l_sql = " SELECT apcb001,apcb002,apcb049 ",
               "   FROM apcb_t WHERE apcbent = ",g_enterprise," AND apcbld  = ? ",
               "    AND apcbdocno = ? AND apcbseq = 1  "
   PREPARE s_aapp131_get_apcbp FROM l_sql   

   LET l_sql = " SELECT apbb051,apbb052 ",        
               "   FROM apcb_t,apbb_t ",
               "  WHERE apcbent = ",g_enterprise,"  AND apcbent = apbbent ",
               #"    AND apcb008 = apbbdocno AND apcbld  = ?  ",  #190531-00029#1 mark
               "    AND apcb049 = apbbdocno AND apcbld  = ?  ",   #190531-00029#1 add
               "    AND apcbdocno = ? AND apcbseq = 1 "
   PREPARE s_aapp131_get_apbbp FROM l_sql  
   #161114-00009#1 --e add    
    
   #170430-00006#2---add---start---
   LET g_round_type = cl_get_para(g_enterprise,'','E-COM-0006')
   LET l_str2 = g_round_type
   LET g_round_type = l_str2.trim()
   #170430-00006#2---add---end---
  #FOREACH s_aapp131_ins_apca_c INTO l_ar.*   #200206-00019#1 mark
   FOREACH s_aapp131_ins_apca_c INTO l_ar.*,l_pmds008   #200206-00019 add
      INITIALIZE l_apca.* TO NULL      
      LET l_apca.apcaent  = g_enterprise
      LET l_apca.apcald   = lc_param_apca.ld
      LET l_apca.apcacomp = l_apcacomp
      LET l_apca.apcadocdt= l_ar.pmdsdocdt
      LET l_apca.apcasite = lc_param_apca.site
      
      CASE lc_param_apca.type
           WHEN '1'
                  LET l_prog= "aapt320"
                  CASE
                      #150702-00001#1-----s
                      #WHEN l_ar.pmds000 MATCHES '[346]' OR l_ar.pmds000 MATCHES '1[2378]' 
                      #     OR l_ar.pmds000 = '20'  #入庫   #150629-00038#1 add 17 18 20
                      #     LET l_apca.apca001 = '01'
                      WHEN s_aap_pmds000_chk('2',l_ar.pmds000)
                         LET l_apca.apca001 = '01'
                      #150702-00001#1-----e
                      
                      #150702-00001#1-----s
                      #WHEN l_ar.pmds000 = '5' OR l_ar.pmds000 MATCHES '1[01]'
                      #   LET l_apca.apca001 = '02'
                      WHEN s_aap_pmds000_chk('5',l_ar.pmds000)
                         LET l_apca.apca001 = '02'
                      #150702-00001#1-----e
 
                      #150702-00001#1-----s
                      #WHEN l_ar.pmds000 = '7' OR l_ar.pmds000 MATCHES '1[459]'  #150629-00038#1 add 19 
                      #     LET l_apca.apca001 = '02'
                      WHEN s_aap_pmds000_chk('4',l_ar.pmds000)
                         LET l_apca.apca001 = '02'                           
                      #150702-00001#1-----e
                  END CASE
           WHEN '2'
                  #160705-00035#3 mark ------
                  #IF lc_param_apca.sel1 = '2' THEN     #發票  p_sel1
                  #   LET l_prog= "aapt300"
                  #   LET l_apca.apca001 = '17'
                  #ELSE                     #折讓單
                  #   LET l_prog= "aapt340"
                  #   LET l_apca.apca001 = '22'
                  #END IF
                  #160705-00035#3 mark end---
                  #160705-00035#3 add ------
                  CASE lc_param_apca.sel1
                     WHEN '2'  #2:進貨發票立帳
                        LET l_prog= "aapt300"
                        LET l_apca.apca001 = '17'
                     WHEN '5'  #5:發票扣抵單立帳
                        LET l_prog= "aapt340"
                        LET l_apca.apca001 = '22'
                     WHEN '7'  #7:預付發票立帳
                        LET l_prog= "aapt310"
                        LET l_apca.apca001 = '11'
                        LET g_type = '7'  #170706-00015#1 add
                     WHEN '8'  #8:雜項發票立帳
                        LET l_prog= "aapt301"
                        LET l_apca.apca001 = '19'
                     WHEN '9'  #9:雜項待抵立帳
                        LET l_prog= "aapt341"
                        LET l_apca.apca001 = '29'
                  END CASE
                  #160705-00035#3 add end---
           WHEN '3'
                  IF lc_param_apca.sel1 = '3' THEN     #入庫應付立帳 #p_sel1
                     LET l_prog= "aapt300"
                     LET l_apca.apca001 = '13'
                  ELSE                     #倉退待抵立帳
                     LET l_prog= "aapt340"
                     LET l_apca.apca001 = '22'
                  END IF                  
      END CASE
      LET g_prog1 = l_prog  #180704-00022#1 add      
      LET l_apca.apca003 = g_user                #帳務人員
      LET l_apca.apca004 = l_ar.pmds007          #帳款對象    
      #CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc   #付款對象 #170618-00212#1 mark
      #200206-00019-(S) mark
      ##170618-00212#1 add ------
      #SELECT pmac002 INTO l_apca.apca005
      #  FROM pmac_t
      #  LEFT OUTER JOIN pmaal_t ON pmaalent = pmacent AND pmaal001 = pmac002 AND pmaal002 = g_lang
      # WHERE pmacent = g_enterprise
      #   AND pmac001 = l_apca.apca004
      #   AND pmac003 = '1'
      #   AND pmac004 = 'Y'
      #   AND rownum = 1
      ##170618-00212#1 add end---
      #200206-00019#1-(E) mark      
      LET l_apca.apca005 = l_pmds008   #取來源入/退庫單，付款供應商 #200206-00019#1 add      
      
      IF cl_null(l_apca.apca005) THEN LET l_apca.apca005 = l_apca.apca004 END IF
      #供應商分類/企業關係人
      #161114-00009#1 --s add
      LET l_apca.apca006 = '' LET l_apca.apca046 = ''
      EXECUTE s_aapp131_get_pmaap USING l_apca.apca004 INTO l_apca.apca006,l_apca.apca046
      #161114-00009#1 --e add
      #161114-00009#1 --s mark
      #SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
      #  FROM pmaa_t
      # WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
      #161114-00009#1 --e mark                 
      #帳款資訊
      CALL s_aap_get_payment_term(l_apca.apcald,l_apca.apcacomp,l_apca.apca004,l_apca.apca001)
           RETURNING g_sub_success ,l_apca.apca015,l_desc,l_desc        ,l_apca.apca035,
                     l_apca.apca036,l_apca.apca058,l_desc,l_apca.apca011,l_apca.apca014
      LET l_apca.apca007 = l_ar.apca007
      
      IF NOT cl_null(l_apca.apca007 ) THEN
         CALL s_aap_get_apca007_default_acct(l_apca.apcald,l_apca.apca007,l_apca.apca001) RETURNING l_apca.apca036,l_apca.apca035
      END IF
      LET l_apca.apca008 = l_ar.pmds031   #付款條件                 
      IF NOT cl_null(l_apca.apca008) THEN   #161215-00061#1 add
         CALL s_fin_date_ap_payable(l_apca.apcacomp,l_apca.apca004,l_apca.apca008,l_apca.apcadocdt,l_apca.apcadocdt,l_apca.apcadocdt,'')
                          RETURNING g_sub_success,l_apca.apca009,l_apca.apca010
      END IF   #161215-00061#1 add
      IF cl_null(l_apca.apca009) THEN LET l_apca.apca009 = l_apca.apcadocdt END IF
      IF cl_null(l_apca.apca010) THEN LET l_apca.apca010 = l_apca.apcadocdt END IF
      LET l_apca.apca011 = l_ar.pmds033
      CALL s_tax_chk(l_apca.apcacomp,l_apca.apca011) RETURNING g_sub_success,l_desc,l_apca.apca013,l_apca.apca012,l_desc
      #170426-00060#1---s---
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca015',l_apca.apca015,l_apca.apcald) RETURNING l_apca.apca015 ##部門編號                              
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca021',l_apca.apca021,l_apca.apcald) RETURNING l_apca.apca021 #商業發票號碼(IV no.)
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca032',l_apca.apca032,l_apca.apcald) RETURNING l_apca.apca032 #發票類型
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca033',l_apca.apca033,l_apca.apcald) RETURNING l_apca.apca033 #專案編號
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca035',l_apca.apca035,l_apca.apcald) RETURNING l_apca.apca035 #應付(貸方)科目編號
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca040',l_apca.apca040,l_apca.apcald) RETURNING l_apca.apca040 #留置否
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca041',l_apca.apca041,l_apca.apcald) RETURNING l_apca.apca041 #留置理由碼      
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca047',l_apca.apca047,l_apca.apcald) RETURNING l_apca.apca047 #多角序號
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca048',l_apca.apca048,l_apca.apcald) RETURNING l_apca.apca048 #集團代付/代付單號      
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca049',l_apca.apca049,l_apca.apcald) RETURNING l_apca.apca049 #來源營運中心編號
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca053',l_apca.apca053,l_apca.apcald) RETURNING l_apca.apca053 #備註
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca054',l_apca.apca054,l_apca.apcald) RETURNING l_apca.apca054 #多帳期設定
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca055',l_apca.apca055,l_apca.apcald) RETURNING l_apca.apca055 #繳款優惠條件
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca057',l_apca.apca057,l_apca.apcald) RETURNING l_apca.apca057 #交易對象識別碼
      IF cl_null(l_apca.apca058) THEN
         CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca058',l_apca.apca058,l_apca.apcald) RETURNING l_apca.apca058 #稅別交易類型
      END IF
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca057',l_apca.apca057,l_apca.apcald) RETURNING l_apca.apca060 #交易對象識別碼
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca059',l_apca.apca059,l_apca.apcald) RETURNING l_apca.apca059 #交易對象識別碼      
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca062',l_apca.apca062,l_apca.apcald) RETURNING l_apca.apca062 #多角性質
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca063',l_apca.apca063,l_apca.apcald) RETURNING l_apca.apca062 ##整帳批序號

      #170426-00060#1---e---
      LET l_apca.apca017 = "0"   #產生方式(0:人員登錄/1:系統產生)
      
      #180802-00062#1 --s add 多角流程產生的單據產生方式為1.系統產生
      IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN
         LET l_apca.apca017 = "1"
      END IF
      #180802-00062#1 --e add
      
      LET l_apca.apca020 = "N"
      LET l_apca.apca025 = "0"
      LET l_apca.apca026 = "0"
      LET l_apca.apca027 = "0"
      LET l_apca.apca028 = "0"
      LET l_apca.apca029 = "0"
      #以部門去取aooi125設定的所屬責任中心,若抓不到值則帶業務部門
      IF NOT cl_null(l_apca.apca015) THEN
         CALL s_department_get_respon_center(l_apca.apca015,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apca.apca034,l_desc
        #IF NOT g_sub_success THEN LET l_apca.apca034 = l_apca.apca015 END IF    #150106-00011#3   抓不到給空白
      END IF
      CALL s_aooi200_fin_get_doc_default(l_apca.apcasite,'2',lc_param_apca.slip,'apca034',l_apca.apca034,l_apca.apcald) RETURNING l_apca.apca034 ##責任中心 #170426-00060#1      
     #LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,p_slip,'D-FIN-0030')      #欄位NO USE  #180313-00054#1 mark
      LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,lc_param_apca.slip,'D-FIN-0030')       #180313-00054#1 add
      LET l_apca.apca039 = "0"
      LET l_apca.apca040 = "N"
      LET l_apca.apca044 =  0
      LET l_apca.apca050 = "0"
      LET l_apca.apca052 = "0"          #列印次數
      IF l_sfin2002 MATCHES '[12]' THEN
         #多帳期/繳款優惠設定
         #201106-00048#1 mark(s)
#         #161114-00009#1 --s add
#         LET l_apca.apca054 = ''
#         LET l_apca.apca055 = ''
#         EXECUTE s_aapp131_get_ooibp USING l_apca.apca008 INTO l_apca.apca054,l_apca.apca055 
#         #161114-00009#1 --e add
         #201106-00048#1 mark(e)
         #201106-00048#1 add(s)
         IF cl_null(l_apca.apca054) THEN
            SELECT ooib025 INTO l_apca.apca054 FROM ooib_t WHERE ooibent = g_enterprise AND ooib002 = l_apca.apca008
         END IF
         IF cl_null(l_apca.apca055) THEN
            SELECT ooib005 INTO l_apca.apca055 FROM ooib_t WHERE ooibent = g_enterprise AND ooib002 = l_apca.apca008
         END IF
         #201106-00048#1 add(e)
         #161114-00009#1 --s mark
         #SELECT ooib025,ooib005 INTO l_apca.apca054,l_apca.apca055
         #  FROM ooib_t
         # WHERE ooibent = g_enterprise AND ooib002 = l_apca.apca008         
         #161114-00009#1 --e mark
      END IF
      LET l_apca.apca056 = "0"
      #LET l_apca.apca057 = l_apca.apca004 #交易識別碼=帳款對象     #160802-00007#2 mark
      #160802-00007#2-----s
      LET l_apca.apca057 = l_ar.pmds028
      IF cl_null(l_apca.apca057)THEN LET l_apca.apca057 = l_apca.apca004 END IF
      #160802-00007#2-----e      
      CASE lc_param_apca.type
           WHEN '1'
                   #IF l_sfin3012 = '1' THEN         #180914-00037#1 add #181015-00007#2 mark 暫估立帳皆為不開立發票
                   LET l_apca.apca060 = "1"          #發票開立方式
                   #181015-00007#2 mark---s   
                   ##180914-00037#1---add---start---
                   #ELSE
                   #   LET l_apca.apca060 = "2"          #發票開立方式
                   #END IF
                   ##180914-00037#1---add---end---
                   #181015-00007#2 mark---e  
           WHEN '2'
                   LET l_apca.apca060 = "2"          #發票開立方式
           WHEN '3'
                   LET l_apca.apca060 = "2"          #發票開立方式
      END CASE
      IF NOT cl_null(lc_param_apca.apca063) THEN LET l_apca.apca063 = lc_param_apca.apca063 END IF
      LET l_apca.apca100 = l_ar.pmds037 #幣別
      LET l_apca.apca120 = l_glaa016
      LET l_apca.apca130 = l_glaa020
      
      LET lc_param_rate.type = '1'
      LET lc_param_rate.apca004 = l_apca.apca004
      LET ls_js = util.JSON.stringify(lc_param_rate)
      CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
           RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
      LET l_apca.apca101 = l_ar.pmds038
      #apca101為分帳條件因此 暫不取位，帶產生完單身後 在update apca101的值
      #CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca120,l_apca.apca121,3) RETURNING g_sub_success,g_errno,l_apca.apca121 #160829-00004#5 mark
      #160829-00004#5--(s)
      IF l_glaa015 = 'Y' THEN          
         #來源幣別
         IF l_glaa017 = '1' THEN
            CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apca.apca121,3) RETURNING g_sub_success,g_errno,l_apca.apca121
         ELSE   #表示帳簿幣別 
            CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apca.apca121,3) RETURNING g_sub_success,g_errno,l_apca.apca121   #帳套使用幣別
         END IF
      END IF
      #160829-00004#5--(e)
      #CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca130,l_apca.apca131,3) RETURNING g_sub_success,g_errno,l_apca.apca131 #160829-00004#5 mark
      #160829-00004#5--(s)
      IF l_glaa019 = 'Y' THEN 
         #來源幣別
         IF l_glaa021 = '1' THEN 
            CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apca.apca131,3) RETURNING g_sub_success,g_errno,l_apca.apca131               
         ELSE   #表示帳簿幣別 
            CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apca.apca131,3) RETURNING g_sub_success,g_errno,l_apca.apca131    #帳套使用幣別
         END IF
      END IF
      #160829-00004#5--(e)
     
      
      
      LET l_apca.apca103 = "0"   LET l_apca.apca104 = "0"   LET l_apca.apca106 = "0"
      LET l_apca.apca107 = "0"   LET l_apca.apca108 = "0"   
      LET l_apca.apca113 = "0"   LET l_apca.apca114 = "0"   LET l_apca.apca116 = "0"
      LET l_apca.apca117 = "0"   LET l_apca.apca118 = "0"
      LET l_apca.apca123 = "0"   LET l_apca.apca124 = "0" 
      LET l_apca.apca133 = "0"   LET l_apca.apca134 = "0"
     
      LET l_apca.apcaownid = g_user
      LET l_apca.apcaowndp = g_dept
      LET l_apca.apcacrtid = g_user
      LET l_apca.apcacrtdp = g_dept 
      LET l_date = cl_get_current()
      LET l_apca.apcacrtdt = l_date
      LET l_apca.apcastus  = "N"
 
      #150126-00012#1--str--
      IF (g_prog NOT MATCHES 'axrp14[12]*') AND (g_prog NOT MATCHES 'aapp14[12]*') THEN  #180802-00062#1 add 
         CALL s_transaction_begin()      
      END IF #180802-00062#1 add
      CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',lc_param_apca.slip,l_apca.apcadocdt,l_prog) RETURNING g_sub_success,l_apca.apcadocno
      #避免單別取號產生不成功，只有單別，所以要比較長度OK才寫入
      IF l_ecom0005 <> LENGTH(l_apca.apcadocno) THEN
         #170405-00016#1--add--str--
         IF g_prog NOT MATCHES 'axrp141*' AND g_prog NOT MATCHES 'aapp141*' THEN          
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_ecom0005
            LET g_errparam.code   = 'aap-00187'
            LET g_errparam.popup  = TRUE
            CALL cl_err()
         ELSE
            CALL s_axrp133_success_tmp_ins('','',0,0,'apm-00459','N')
            EXIT FOREACH                       #180802-00062#1 add            
         END IF
         #170405-00016#1--add--end
         CALL s_transaction_end('N','0')
         CONTINUE FOREACH
      END IF      
      #IF lc_param_apca.bgjob = 'N' OR g_prog = 'axrp141' OR g_prog = 'aapp141' THEN   #20151120 add OR g_prog = 'axrp141' OR g_prog = 'aapp141' lujh #170301-00021#1 by 09263 --mark
      IF lc_param_apca.bgjob = 'N' OR g_prog MATCHES 'axrp141*' OR g_prog MATCHES 'aapp141*' THEN   #170301-00021#1 by 09263 --add
         CALL cl_progress_no_window_ing(l_str || l_apca.apcadocno)
      END IF
      #150126-00012#1--end-- 
     #INSERT INTO apca_t VALUES(l_apca.*) #161111-00048#2 mark
     #170510-00041#1---s---
     CALL s_aap_get_bgaf004(l_apca.apcald,l_apca.apcacomp,l_apca.apcadocno,l_apca.apcadocdt) 
        RETURNING l_apca.apca059,l_apca059_desc
     #170510-00041#1---e---
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apca.apca044) THEN LET l_apca.apca044 = 0 END IF   #留置原幣金額
      IF cl_null(l_apca.apca101) THEN LET l_apca.apca101 = 0 END IF   #原幣匯率
      IF cl_null(l_apca.apca121) THEN LET l_apca.apca121 = 0 END IF   #本位幣二匯率
      IF cl_null(l_apca.apca126) THEN LET l_apca.apca126 = 0 END IF   #本位幣二應稅折抵合計金額
      IF cl_null(l_apca.apca128) THEN LET l_apca.apca128 = 0 END IF   #本位幣二應付金額
      IF cl_null(l_apca.apca131) THEN LET l_apca.apca131 = 0 END IF   #本位幣三匯率
      IF cl_null(l_apca.apca136) THEN LET l_apca.apca136 = 0 END IF   #本位幣三應稅折抵合計金額
      IF cl_null(l_apca.apca138) THEN LET l_apca.apca138 = 0 END IF   #本位幣三應付金額
      #180130-00050#5---add by 10554---(E)

      #161111-00048#2 --s add
      INSERT INTO apca_t(apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
                         apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
                         apcapstid,apcapstdt,apcastus,apcald,apcacomp,
                         apcadocno,apcadocdt,apcasite,apca001,apca003,
                         apca004,apca005,apca006,apca007,apca008,
                         apca009,apca010,apca011,apca012,apca013,
                         apca014,apca015,apca016,apca017,apca018,
                         apca019,apca020,apca021,apca022,apca025,
                         apca026,apca027,apca028,apca029,apca030,
                         apca031,apca032,apca033,apca034,apca035,
                         apca036,apca037,apca038,apca039,apca040,
                         apca041,apca042,apca043,apca044,apca045,
                         apca046,apca047,apca048,apca049,apca050,
                         apca051,apca052,apca053,apca054,apca055,
                         apca056,apca057,apca058,apca059,apca060,
                         apca061,apca062,apca063,apca064,apca065,
                         apca066,apca100,apca101,apca103,apca104,
                         apca106,apca107,apca108,apca113,apca114,
                         apca116,apca117,apca118,apca120,apca121,
                         apca123,apca124,apca126,apca127,apca128,
                         apca130,apca131,apca133,apca134,apca136,
                         apca137,apca138,apcaud001,apcaud002,apcaud003,
                         apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
                         apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
                         apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
                         apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
                         apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
                         apcaud029,apcaud030,apca067,apca068,apca069,
                         apca070,apca071,apca072,apca073) 
      VALUES(l_apca.apcaent,l_apca.apcaownid,l_apca.apcaowndp,l_apca.apcacrtid,l_apca.apcacrtdp,
             l_apca.apcacrtdt,l_apca.apcamodid,l_apca.apcamoddt,l_apca.apcacnfid,l_apca.apcacnfdt,
             l_apca.apcapstid,l_apca.apcapstdt,l_apca.apcastus,l_apca.apcald,l_apca.apcacomp,
             l_apca.apcadocno,l_apca.apcadocdt,l_apca.apcasite,l_apca.apca001,l_apca.apca003,
             l_apca.apca004,l_apca.apca005,l_apca.apca006,l_apca.apca007,l_apca.apca008,
             l_apca.apca009,l_apca.apca010,l_apca.apca011,l_apca.apca012,l_apca.apca013,
             l_apca.apca014,l_apca.apca015,l_apca.apca016,l_apca.apca017,l_apca.apca018,
             l_apca.apca019,l_apca.apca020,l_apca.apca021,l_apca.apca022,l_apca.apca025,
             l_apca.apca026,l_apca.apca027,l_apca.apca028,l_apca.apca029,l_apca.apca030,
             l_apca.apca031,l_apca.apca032,l_apca.apca033,l_apca.apca034,l_apca.apca035,
             l_apca.apca036,l_apca.apca037,l_apca.apca038,l_apca.apca039,l_apca.apca040,
             l_apca.apca041,l_apca.apca042,l_apca.apca043,l_apca.apca044,l_apca.apca045,
             l_apca.apca046,l_apca.apca047,l_apca.apca048,l_apca.apca049,l_apca.apca050,
             l_apca.apca051,l_apca.apca052,l_apca.apca053,l_apca.apca054,l_apca.apca055,
             l_apca.apca056,l_apca.apca057,l_apca.apca058,l_apca.apca059,l_apca.apca060,
             l_apca.apca061,l_apca.apca062,l_apca.apca063,l_apca.apca064,l_apca.apca065,
             l_apca.apca066,l_apca.apca100,l_apca.apca101,l_apca.apca103,l_apca.apca104,
             l_apca.apca106,l_apca.apca107,l_apca.apca108,l_apca.apca113,l_apca.apca114,
             l_apca.apca116,l_apca.apca117,l_apca.apca118,l_apca.apca120,l_apca.apca121,
             l_apca.apca123,l_apca.apca124,l_apca.apca126,l_apca.apca127,l_apca.apca128,
             l_apca.apca130,l_apca.apca131,l_apca.apca133,l_apca.apca134,l_apca.apca136,
             l_apca.apca137,l_apca.apca138,l_apca.apcaud001,l_apca.apcaud002,l_apca.apcaud003,
             l_apca.apcaud004,l_apca.apcaud005,l_apca.apcaud006,l_apca.apcaud007,l_apca.apcaud008,
             l_apca.apcaud009,l_apca.apcaud010,l_apca.apcaud011,l_apca.apcaud012,l_apca.apcaud013,
             l_apca.apcaud014,l_apca.apcaud015,l_apca.apcaud016,l_apca.apcaud017,l_apca.apcaud018,
             l_apca.apcaud019,l_apca.apcaud020,l_apca.apcaud021,l_apca.apcaud022,l_apca.apcaud023,
             l_apca.apcaud024,l_apca.apcaud025,l_apca.apcaud026,l_apca.apcaud027,l_apca.apcaud028,
             l_apca.apcaud029,l_apca.apcaud030,l_apca.apca067,l_apca.apca068,l_apca.apca069,
             l_apca.apca070,l_apca.apca071,l_apca.apca072,l_apca.apca073)
                 
      #161111-00048#2 --e add      
      ##檢查是否適用預算科目 #150703-00021#24  ---s---
      CALL s_aooi200_fin_get_slip(l_apca.apcadocno) RETURNING g_sub_success,l_ap_slip
      CALL s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,l_ap_slip,'D-FIN-5002') RETURNING g_dfin5002
      #170510-00041#1---s--- mark        
      #IF g_dfin5002 = 'Y' THEN
      #     LET l_tran.site    = l_apca.apcacomp
      #     LET l_tran.dat     = l_apca.apcadocdt
      #     LET l_tran.bgae001 = l_apca.apca036
      #     LET ls_js = util.JSON.stringify(l_tran)                    
      #   CALL s_abg_bgae001_chk2(ls_js)RETURNING g_sub_success,g_errno
      #   IF NOT g_sub_success THEN
      #      INITIALIZE g_errparam TO NULL
      #      LET g_errparam.code = g_errno
      #      LET g_errparam.extend = l_apca.apcadocno
      #      LET g_errparam.popup = TRUE
      #      CALL cl_err()
      #      CALL s_transaction_end('N','0')
      #      CONTINUE FOREACH
      #   END IF                  
      #END IF  
      ##150703-00021#24  ---e---
      #170510-00041#1---e--- mark                   
      #160107-00001#1--(S)
      IF g_xcat005 = 'Y' THEN
         LET g_ld       = l_apca.apcald
         LET g_apcacomp = l_apca.apcacomp
         LET g_edate    = l_apca.apcadocdt
         LET g_apca100_std= l_apca.apca100
         LET g_apca101_std= l_apca.apca101
         LET g_curr[2].curr= l_apca.apca120
         LET g_curr[3].curr= l_apca.apca130
      END IF
      #160107-00001#1--(E)
      #170430-00006#2---add---
      #原幣
      SELECT ooaj003,ooaj004,ooaj005,ooaj006,ooaj007
        INTO g_ooaj003,g_ooaj004,g_ooaj005,g_ooaj006,g_ooaj007
        FROM ooaj_t
       WHERE ooajent = g_enterprise
         AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=l_apca.apcald)
         AND ooaj002 = l_apca.apca100
      #本幣
      SELECT ooaj003,ooaj004,ooaj005,ooaj006,ooaj007
        INTO g_ooaj003_g,g_ooaj004_g,g_ooaj005_g,g_ooaj006_g,g_ooaj007_g
        FROM ooaj_t
       WHERE ooajent = g_enterprise
         AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=l_apca.apcald)
         AND ooaj002 = l_glaa001 
      IF l_glaa015='Y' THEN   
         SELECT ooaj004 INTO g_ooaj004_g2 FROM ooaj_t
          WHERE ooajent = g_enterprise
            AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=l_apca.apcald)
            AND ooaj002 = g_curr[2].curr 
         IF cl_null(g_ooaj004_g2) THEN LET g_ooaj004_g2 = 0 END IF
      END IF
      IF l_glaa019='Y' THEN
         SELECT ooaj004 INTO g_ooaj004_g3 FROM ooaj_t
          WHERE ooajent = g_enterprise
            AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=l_apca.apcald)
            AND ooaj002 = g_curr[3].curr 
         IF cl_null(g_ooaj004_g3) THEN LET g_ooaj004_g3 = 0 END IF
      END IF
      #180705-00083#1 add -s
      #写入立账单身前获取税额科目
      LET l_xrcd009 = ''
      IF lc_param_apca.type = '1' THEN
         CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_08') RETURNING g_sub_success,l_xrcd009,g_errno
      ELSE
         CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
      END IF
      #180705-00083#1 add -e
      #170430-00006#2---add---
      #寫入立帳單身
      CASE lc_param_apca.type
           WHEN '1'
                CALL s_aapp131_ins_apcb1(l_apca.apcald,l_apca.apcadocno,l_ar.pmds000,l_ar.pmds037,l_ar.pmds038,
                                         l_ar.pmds007,l_ar.apca007,l_ar.cond1,l_sfin2002,l_ar.pmds031,l_xrcd009)  #180705-00083#1 add
#                                         l_ar.pmds007,l_ar.apca007,l_ar.cond1,l_sfin2002,l_ar.pmds031)  #180705-00083#1 mark
                     RETURNING g_sub_success
           WHEN '2'       
                LET g_apbb055ty2 = '' #170105-00033#2 add 紀錄第一筆來源資料的指定付款到期日
#                CALL s_aapp131_ins_apcb2(l_apca.apcald,l_apca.apcadocno,l_ar.cond1,l_sfin2002)  #180705-00083#1 mark
                CALL s_aapp131_ins_apcb2(l_apca.apcald,l_apca.apcadocno,l_ar.cond1,l_sfin2002,l_xrcd009)  #180705-00083#1 add
                     RETURNING g_sub_success
                     
           WHEN '3'       
#                CALL s_aapp131_ins_apcb3(l_apca.apcald,l_apca.apcadocno,l_ar.cond1,l_sfin2002,l_ar.pmds031)  #180705-00083#1 mark
                CALL s_aapp131_ins_apcb3(l_apca.apcald,l_apca.apcadocno,l_ar.cond1,l_sfin2002,l_ar.pmds031,l_xrcd009) #180705-00083#1 add
                     RETURNING g_sub_success                     
      END CASE
      #150703-00021#24  ---s---
      IF NOT g_sub_success THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = ''
          LET g_errparam.extend = l_apca.apcadocno
          LET g_errparam.popup = TRUE
          CALL cl_err()
          #180802-00062#1 --s add  
          IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN          
             CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'aap-00062','N')
             EXIT FOREACH        
          END IF
          #180802-00062#1 --e add          
          CALL s_transaction_end('N','0')
          CONTINUE FOREACH
      END IF                  
      #150703-00021#24  ---e---
      #150126-00012#1--str--    
      #沒有任何一筆單身,則rollback
      LET l_cnt = 0
      #161114-00009#1 --s add
      EXECUTE s_aapp131_cnt_apcbp USING l_apca.apcald,l_apca.apcadocno INTO l_cnt  
      IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF
      #161114-00009#1 --e add
      
      #161114-00009#1 --s mark
      #SELECT COUNT(*) INTO l_cnt        
      #  FROM apcb_t
      # WHERE apcbent = g_enterprise AND apcbld = l_apca.apcald AND apcbdocno = l_apca.apcadocno
      #161114-00009#1 --e mark
      
      IF l_cnt = 0 THEN
         #180802-00062#1 --s add  
         IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN          
            CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'aap-00422','N')
            EXIT FOREACH        
         END IF
         #180802-00062#1 --e add       
         CALL s_transaction_end('N','0')        
         CONTINUE FOREACH
      END IF
      #150126-00012#1--end--
      #200909-00012#1-(S) add
      #多角帳務，取得invoice號碼,寫入AP單據
      IF (g_prog MATCHES 'axrp141*') OR (g_prog MATCHES 'aapp141*') THEN
         CALL s_aapp131_get_invoice(g_prog,l_apca.apcald,l_apca.apcadocno)
      END IF
      #200909-00012#1-(E) add
      #檢查xrcd是否有預設會計科目
      LET l_cnt = 0
      #161114-00009#1 --s add
      EXECUTE s_aapp131_cnt_xrcdp USING l_apca.apcald,l_apca.apcadocno INTO l_cnt 
      IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF 
      #161114-00009#1 --e add
      
      #161114-00009#1 --s mark
      #SELECT count(*) INTO l_cnt        
      #  FROM xrcd_t
      # WHERE xrcdent = g_enterprise AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno AND xrcd009 IS NULL
      #161114-00009#1 --e mark
       
      IF l_cnt > 0 THEN
         IF lc_param_apca.type = '1' THEN
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_08') RETURNING g_sub_success,l_xrcd009,g_errno
         ELSE
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
         END IF
         UPDATE xrcd_t SET xrcd009 = l_xrcd009
          WHERE xrcdent = g_enterprise 
            AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
            AND xrcd009 IS NULL 
      END IF
      
      #160816-00022#2 add --s
      #不條件限定xrcd稅額科目是否為空,暫估單若有稅額時,稅額科目固定取aapi011暫估稅額科目
      LET l_cnt = 0
      #161114-00009#1 --s add
      EXECUTE s_aapp131_cnt_xrcdp1 USING l_apca.apcald,l_apca.apcadocno INTO l_cnt 
      IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF 
      #161114-00009#1 --e add  
      #161114-00009#1 --s mark
      #SELECT count(*) INTO l_cnt        
      #  FROM xrcd_t
      # WHERE xrcdent = g_enterprise AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
      #161114-00009#1 --e mark
      IF l_cnt > 0 THEN
         IF lc_param_apca.type = '1' THEN 
            LET l_xrcd009 = ''
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_08') RETURNING g_sub_success,l_xrcd009,g_errno
            UPDATE xrcd_t SET xrcd009 = l_xrcd009
             WHERE xrcdent = g_enterprise AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
         END IF
      END IF
      #160816-00022#2 add --e

      #回寫apca_t單頭
      CALL s_aap_clac_bill_master(l_apca.apcald,l_apca.apcadocno) RETURNING l_amount.*
      #本幣匯率在寫入立帳單身後才回寫單頭匯率，因為本幣匯率是單身彙總條件之一，如果先取位了立帳單身會抓不到資料
      #CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101 #160829-00004#5 mark
     #CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101  #160829-00004#5 #170430-00006#2 mark
      CALL s_num_round(g_round_type,l_apca.apca101,g_ooaj005) RETURNING l_apca.apca101    #170430-00006#2 add
      #161114-00009#1 --s add
      LET l_apca.apca016 = '' LET l_apca.apca018 = '' LET l_apcb049 = ''
      EXECUTE s_aapp131_get_apcbp USING l_apca.apcald,l_apca.apcadocno
         INTO l_apca.apca016,l_apca.apca018,l_apcb049
      #161114-00009#1 --e add
      #161114-00009#1 --s mark
      #SELECT apcb001,apcb002,apcb049 INTO l_apca.apca016,l_apca.apca018,l_apcb049
      #  FROM apcb_t
      # WHERE apcbent = g_enterprise
      #   AND apcbld  = l_apca.apcald AND apcbdocno = l_apca.apcadocno
      #   AND apcbseq = 1
      #161114-00009#1 --e mark
      #161014-00046#2 -s
      #若倉退單倉退方式選4:倉退折讓(純金額折讓)，則應改抓aapi011的倉退科目
      #IF l_prog = "aapt340" THEN #170301-00021#1 by 09263 --mark
      IF l_prog MATCHES "aapt340*" THEN #170301-00021#1 by 09263 --add
         LET l_pmds100 = ''
         SELECT pmds100 INTO l_pmds100
           FROM pmds_t
          WHERE pmdsent   = g_enterprise
            AND pmdsdocno = l_apca.apca018
         IF l_pmds100 = '4' THEN
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apca.apca036,g_errno
         END IF
      END IF
      #161014-00046#2 -e
      #由aapp132產生的立帳單，單頭的apca016/apca018應要為aapt110的資料
      IF lc_param_apca.type = '2' THEN
         #161012-00026#1 mark-----s
         #IF lc_param_apca.sel1 = '2' THEN    #發票
         #   LET l_apca.apca016 = '12'
         #ELSE                    #折讓單
         #   LET l_apca.apca016 = '22'
         #END IF
         #161012-00026#1 mark-----e
         #161012-00026#1-----s
         CASE
            WHEN lc_param_apca.sel1 = '2'
               LET l_apca.apca016 = '12'
            WHEN lc_param_apca.sel1 = '5'
               LET l_apca.apca016 = '22'
            WHEN lc_param_apca.sel1 = '7'   
               #LET l_apca.apca016 = '10'          #161012-00026#1 mark
               LET l_apca.apca016 = '12'           #161012-00026#1 add
            WHEN lc_param_apca.sel1 = '8'
               LET l_apca.apca016 = '19'
            WHEN lc_param_apca.sel1 = '9'
               LET l_apca.apca016 = '29'
         END CASE
         #161012-00026#1-----e
         LET l_apca.apca018 = l_apcb049
         
         #170320-00057#1--add--str--lujh
         LET l_cnt = 0
         SELECT COUNT(DISTINCT apcb049) INTO l_cnt FROM apcb_t 
          WHERE apcbent = g_enterprise
            AND apcbld = l_apca.apcald 
            AND apcbdocno = l_apca.apcadocno
            
         IF l_cnt > 1 THEN 
            LET l_apca.apca018 = 'MULTI'
         END IF
         #170320-00057#1--add--end--lujh
         #170620-00136#1---add---str--
         IF NOT cl_null(l_apca.apca018) AND l_apca.apca018 != 'MULTI' THEN
            SELECT apbb011 INTO l_date2
              FROM apbb_t
             WHERE apbbent = g_enterprise
               AND apbbdocno = l_apca.apca018

            LET l_date1 = l_apca.apcadocdt
            LET l_date3 = l_apca.apcadocdt
            #LET l_date4 = l_apca.apcadocdt #180925-00016#1 mark
            #180925-00016#1 add ------
            IF l_apca.apca016 = '12' THEN
               SELECT apcb002 INTO l_apca018
                 FROM apcb_t
                WHERE apcbent = g_enterprise
                  AND apcbld  = l_apca.apcald
                  AND apcbdocno = l_apca.apcadocno
                  AND apcbseq = 1
            ELSE
               LET l_apca018 = l_apca.apca018
            END IF
            #出入庫扣帳日
            SELECT pmds001 INTO l_date4
              FROM pmds_t
             WHERE pmdsent = g_enterprise AND pmdsdocno = l_apca018
            IF cl_null(l_date1) THEN LET l_date1 = l_apca.apcadocdt END IF
            IF cl_null(l_date2) THEN LET l_date2 = l_apca.apcadocdt END IF
            IF cl_null(l_date3) THEN LET l_date3 = l_apca.apcadocdt END IF
            IF cl_null(l_date4) THEN LET l_date4 = l_apca.apcadocdt END IF
            #180925-00016#1 add end---
            CALL s_fin_date_ap_payable(l_apca.apcacomp,l_apca.apca004,l_apca.apca008,l_date1,l_date2,l_date3,l_date4)
                 RETURNING g_sub_success,l_apca.apca009,l_apca.apca010
            IF cl_null(l_apca.apca009) THEN LET l_apca.apca009 = l_apca.apcadocdt END IF
            IF cl_null(l_apca.apca010) THEN LET l_apca.apca010 = l_apca.apcadocdt END IF
         END IF
         #170620-00136#1---add---end--
      END IF
      #150921-00148#2--(S)
      IF lc_param_apca.sel2 = '2' THEN #SCC：8527(2:入庫單)
         LET l_date1 = ''
         LET l_date2 = ''
         LET l_date3 = ''
         LET l_date4 = ''
         IF l_apca.apca016 = '12' THEN
            SELECT apcb002 INTO l_apca018
              FROM apcb_t
             WHERE apcbent = g_enterprise
               AND apcbld  = l_apca.apcald AND apcbdocno = l_apca.apcadocno
               AND apcbseq = 1
         ELSE
            LET l_apca018 = l_apca.apca018
         END IF
         #交易認定日
         SELECT pmds052 INTO l_date1
           FROM pmds_t
          WHERE pmdsent = g_enterprise AND pmdsdocno = l_apca018
         #發票日
         SELECT COUNT(UNIQUE isam011) INTO l_cnt
           FROM isam_t
          WHERE isament = g_enterprise
            AND isam050 = l_apca.apcadocno AND isam050 IS NOT NULL
         IF l_cnt = 1 THEN
          SELECT isam011 INTO l_date2
            FROM isam_t
           WHERE isament = g_enterprise
             AND isam050 = l_apca.apcadocno AND isam050 IS NOT NULL
         END IF
         #入帳日
         LET l_date3 = l_apca.apcadocdt
         #出入庫扣帳日
         SELECT pmds001 INTO l_date4
           FROM pmds_t
          WHERE pmdsent = g_enterprise AND pmdsdocno = l_apca018
         IF cl_null(l_date1) THEN LET l_date1 = l_apca.apcadocdt END IF
         IF cl_null(l_date2) THEN LET l_date2 = l_apca.apcadocdt END IF
         IF cl_null(l_date3) THEN LET l_date3 = l_apca.apcadocdt END IF
         IF cl_null(l_date4) THEN LET l_date4 = l_apca.apcadocdt END IF
         CALL s_fin_date_ap_payable(l_apca.apcacomp,l_apca.apca004,l_apca.apca008,l_date1,l_date2,l_date3,l_date4)
              RETURNING g_sub_success,l_apca.apca009,l_apca.apca010
         IF cl_null(l_apca.apca009) THEN LET l_apca.apca009 = l_apca.apcadocdt END IF
         IF cl_null(l_apca.apca010) THEN LET l_apca.apca010 = l_apca.apcadocdt END IF
      END IF
      #150921-00148#2--(E)
      #140806-00012#12 add apca101/#150921-00148#2 add apca009,apca010
      #161014-00046#2 add apca036
      UPDATE apca_t SET (apca103,apca104,apca106,apca107,apca108,
                         apca113,apca114,apca116,apca117,apca118,
                         apca123,apca124,apca126,apca127,apca128,
                         apca133,apca134,apca136,apca137,apca138,
                         apca016,apca018,apca101,apca009,apca010,
                         apca036
                         ) =
                        (l_amount.apcb103,l_amount.xrcd104,l_amount.apca106,l_amount.apca107,l_amount.apca108,
                         l_amount.apcb113,l_amount.xrcd114,l_amount.apca116,l_amount.apca117,l_amount.apca118,
                         l_amount.apcb123,l_amount.xrcd124,l_amount.apca126,l_amount.apca127,l_amount.apca128,
                         l_amount.apcb133,l_amount.xrcd134,l_amount.apca136,l_amount.apca137,l_amount.apca138,
                         l_apca.apca016  ,l_apca.apca018  ,l_apca.apca101  ,l_apca.apca009  ,l_apca.apca010,
                         l_apca.apca036
                         )
        WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
          AND apcadocno = l_apca.apcadocno 
      
      #立帳方式===========(S)
      IF lc_param_apca.type = '2' THEN #發票立帳以第一筆的項次 的收票單號採購人員為準
         LET l_apca.apca014 = '' 
         LET l_apca.apca015 = ''
         #161114-00009#1 --s mark
         #SELECT apbb051,apbb052 INTO l_apca.apca014,l_apca.apca015
         #  FROM apcb_t,apbb_t
         # WHERE apcbent = g_enterprise  AND apcbent = apbbent
         #   AND apcb008 = apbbdocno
         #   AND apcbld  = l_apca.apcald AND apcbdocno = l_apca.apcadocno
         #   AND apcbseq = 1
         #161114-00009#1 --e mark         
         
         #161114-00009#1 --s add
         EXECUTE s_aapp131_get_apbbp USING l_apca.apcald,l_apca.apcadocno
            INTO l_apca.apca014,l_apca.apca015     
         #161114-00009#1 --e add         
         
         #190531-00029#1 add(s)
		   IF NOT cl_null(l_apca.apca014) AND NOT cl_null(l_apca.apca015) THEN
            UPDATE apcb_t SET apcb051 = l_apca.apca014,apcb010 = l_apca.apca015
             WHERE apcbent = g_enterprise
               AND apcbld = l_apca.apcald
               AND apcbdocno = l_apca.apcadocno
            #200805-00007#1 add -s
               AND ((apcb001 IN ('11','21')
               AND (NOT EXISTS(SELECT 1
                                FROM imaa_t
                               WHERE imaaent = g_enterprise
                                 AND imaa001 = apcb004
                                 AND imaa004 = 'E')
                OR (EXISTS(SELECT 1
                             FROM imaa_t
                            WHERE imaaent = g_enterprise
                              AND imaa001 = apcb004
                              AND imaa004 = 'E')
               AND apcb010 IS NULL)))
                OR apcb001 NOT IN ('11','21'))
            #200805-00007#1 add -e            
         END IF
		   #190531-00029#1 add(e)
         
         #170105-00033#2 --s add
         #更新 票到期日(apca010)
         IF NOT cl_null(g_apbb055ty2) THEN
            #當對帳單有指定付款到期日時,寫入付款到期日apbb055
            UPDATE apca_t SET apca010 = g_apbb055ty2
             WHERE apcaent = g_enterprise AND apcald = l_apca.apcald AND apcadocno = l_apca.apcadocno
         END IF
         #170105-00033#2 --e add        
         
         IF NOT cl_null(l_apca.apca015) THEN #以部門去取aooi125設定的所屬責任中心,若抓不到值則帶業務部門
            CALL s_department_get_respon_center(l_apca.apca015,l_apca.apcadocdt)
                 RETURNING g_sub_success,g_errno,l_apca.apca034,l_desc
           #IF NOT g_sub_success THEN LET l_apca.apca034 = l_apca.apca015 END IF #抓不到給空白
         END IF
         IF NOT cl_null(l_apca.apca014) THEN
            UPDATE apca_t SET apca014 = l_apca.apca014,
                              apca015 = l_apca.apca015,
                              apca034 = l_apca.apca034
             WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
               AND apcadocno= l_apca.apcadocno 
         END IF
      END IF
      IF lc_param_apca.type = '3' THEN #150821-00003 --- s ---
         CALL l_array.clear()
         LET l_array[1].chr = l_apca.apcadocno
         LET l_array[2].chr = l_apca.apcald
         CALL s_aapp131_ins_isam_from_pmdw('',l_array)RETURNING g_sub_success   
      END IF                          #150821-00003 --- e ---
      #立帳方式===========(E)
      
      #沖銷參數===========(S)
      #沖銷參數三以單身項次1的付款條件為主
      IF l_sfin2002 = '3' THEN
         SELECT apcb030 INTO l_apca.apca008
           FROM apcb_t
          WHERE apcbent = g_enterprise
            AND apcbld  = l_apca.apcald AND apcbdocno = l_apca.apcadocno
            AND apcbseq = 1
         CALL s_fin_date_ap_payable(l_apca.apcacomp,l_apca.apca004,l_apca.apca008,l_apca.apcadocdt,l_apca.apcadocdt,l_apca.apcadocdt,'')
              RETURNING g_sub_success,l_apca.apca009,l_apca.apca010
         
         #171229-00043#1 --s add 沖銷參數三收付款條件為入庫出貨扣帳日選項且單身有入庫出貨等來源單據,重新推算應付款日與到期日
         LET l_apca009 = ''
         LET l_apca010 = ''
         CALL s_aapt300_upd_apca009('N',l_apca.apcadocno,l_apca.apcald,l_apca.apca008,l_apca.apcadocdt,l_apca.apcasite,l_apca.apca004)
              RETURNING g_sub_success,l_apca009,l_apca010
         IF g_sub_success THEN
            LET l_apca.apca009 = l_apca009
            LET l_apca.apca010 = l_apca010
         END IF               
         #171229-00043#1 --e add   
         
         UPDATE apca_t SET apca008 = l_apca.apca008,
                           apca009 = l_apca.apca009,
                           apca010 = l_apca.apca010
          WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
            AND apcadocno = l_apca.apcadocno 
      #171229-00043#1 --s add  沖銷參數一/二 收付款條件為入庫出貨扣帳日選項且單身有入庫出貨等來源單據,重新推算應付款日與到期日  
      ELSE
         LET l_apca009 = ''
         LET l_apca010 = ''
         CALL s_aapt300_upd_apca009('N',l_apca.apcadocno,l_apca.apcald,l_apca.apca008,l_apca.apcadocdt,l_apca.apcasite,l_apca.apca004)
              RETURNING g_sub_success,l_apca009,l_apca010
         IF g_sub_success THEN
            UPDATE apca_t SET apca009 = l_apca009,apca010 = l_apca010
             WHERE apcaent = g_enterprise AND apcald = l_apca.apcald 
               AND apcadocno = l_apca.apcadocno 
               
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_apca.apcadocno,"UPDATE apca009/apca010 wrong!" 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL cl_err() 
               LET r_success = FALSE
            END IF                
         END IF                
      #171229-00043#1 --e add
      END IF
      #沖銷參數===========(E)
      #產生多帳期
      CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno ) RETURNING g_sub_success,g_errno
      IF NOT g_sub_success THEN
         #IF g_prog <> 'axrp141' THEN #170301-00021#1 by 09263 --mark
         IF g_prog NOT MATCHES 'axrp141*' THEN #170301-00021#1 by 09263 --add
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = g_errno
            LET g_errparam.extend = l_apca.apcadocno
            LET g_errparam.popup = FALSE
            CALL cl_err()
         ELSE
            CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,g_errno,'N')
         END IF
      END IF
      CASE lc_param_apca.type
           WHEN '2'
                  #160721-00025#1 mark--s
                  #SELECT apcb008 INTO l_apcb008
                  #  FROM apbb_t
                  # WHERE apcbent = g_enterprise AND apcbld = l_apca.apcald
                  #   AND apcbdocno=l_apca.apcadocno AND apcbseq = 1
                  #
                  #SELECT apbb009 INTO l_apca065
                  #  FROM apbb_t
                  # WHERE apbbent = g_enterprise AND apbbdocno = l_apcb008
                  #160721-00025#1 mark--e
                  #170123-00045#5 --s mark
                  ##160721-00025#1 --s
                  #SELECT DISTINCT apcb027 INTO l_apca065 
                  #  FROM apcb_t
                  # WHERE apcbent = g_enterprise 
                  #   AND apcbld = l_apca.apcald
                  #   AND apcbdocno =l_apca.apcadocno         
                  #   AND ROWNUM = 1                    
                  ##160721-00025#1 --e
                  #170123-00045#5 --e mark
                  #170123-00045#5 --s add
                  LET l_apca065 = ''
                  LET l_sql = " SELECT DISTINCT apcb027 FROM apcb_t ",
                              "  WHERE apcbent = ",g_enterprise," AND apcbld = '",l_apca.apcald,"' AND apcbdocno = '",l_apca.apcadocno,"' "
                  PREPARE s_aapp131_apcb027p FROM l_sql
                  DECLARE s_aapp131_apcb027c SCROLL CURSOR FOR s_aapp131_apcb027p
                  OPEN s_aapp131_apcb027c
                  FETCH FIRST s_aapp131_apcb027c INTO l_apca065
                  CLOSE s_aapp131_apcb027c        
                  #170123-00045#5 --e add                                      
                   
                  SELECT COUNT(DISTINCT apcb028) INTO l_cnt 
                    FROM apcb_t
                   WHERE apcbent = g_enterprise AND apcbld = l_apca.apcald
                     AND apcbdocno=l_apca.apcadocno
                                     
                  IF l_cnt = 1 THEN
                     SELECT DISTINCT apcb028 INTO l_apca066 
                       FROM apcb_t
                      WHERE apcbent = g_enterprise AND apcbld = l_apca.apcald
                        AND apcbdocno=l_apca.apcadocno
                  ELSE
                     LET l_apca066 = 'MULTI'
                     #170619-00025#1 --s add 來源無發票者發票號碼為空
                     IF l_cnt = 0 OR cl_null(l_cnt) THEN
                        LET l_apca066 = ''
                     END IF
                     #170619-00025#1 --e add
                  END IF
                  UPDATE apca_t SET apca065 = l_apca065,apca066 = l_apca066
                   WHERE apcald = l_apca.apcald AND apcadocno=l_apca.apcadocno
                     AND apcaent = g_enterprise   #170210-00017#2 20170210 add by beckxie
                     
                  #160705-00035#3 -s
                  #先看看aapt110單身有沒有#27:其他待抵單，有的話要寫入直接沖帳
                  LET l_cnt_27 = 0
                  #SELECT COUNT(*) INTO l_cnt_27        #161114-00009#1 mark
                  SELECT COUNT(apbadocno) INTO l_cnt_27 #161114-00009#1 add
                    FROM apba_t
                   WHERE apbaent = g_enterprise
#                     AND apbadocno = l_apca.apca018    #200107-00014#1--mark
                     AND apbadocno IN (select apcb049 FROM apcb_t WHERE apcbent = g_enterprise AND apcbld =l_apca.apcald AND apcbdocno = l_apca.apcadocno)  #200107-00014#1--add
                     AND apba004 = '27'
                  IF cl_null(l_cnt_27) THEN LET l_cnt_27 = 0 END IF
                  #160705-00035#3 -e
                  
                  #170518-00041#1 --s add
                  #aapt110單身若有18:差異折讓 對應待抵單,則要寫入直接沖帳
                  LET l_cnt_18 = 0
                  SELECT COUNT(apbadocno) INTO l_cnt_18 
                    FROM apba_t
                   WHERE apbaent = g_enterprise
#                     AND apbadocno = l_apca.apca018   #200107-00014#1--mark
                     AND apbadocno  IN (SELECT apcb049 FROM apcb_t WHERE apcbent = g_enterprise AND apcbld =l_apca.apcald AND apcbdocno = l_apca.apcadocno)  #200107-00014#1--add
                     AND apba004 = '18'
                     AND apba005 IS NOT NULL
                  IF cl_null(l_cnt_18) THEN LET l_cnt_18 = 0 END IF
                  #170518-00041#1 --e add                  
                  
                  #寫入沖銷
                 #IF NOT cl_null(lc_param_apca.wc2) THEN #160705-00035#3 mark
                  #IF NOT cl_null(lc_param_apca.wc2) OR l_cnt_27 > 0 THEN #160705-00035#3 #170518-00041#1 mark
                  IF NOT cl_null(lc_param_apca.wc2) OR l_cnt_27 > 0 OR l_cnt_18 > 0 THEN  #170518-00041#1 add l_cnt_18 > 0
                     #0.27待抵單要先寫入
                     IF l_cnt_27 > 0 THEN
                        LET l_apcc109 = 0
                        SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                          FROM apcc_t
                         WHERE apccent = g_enterprise
                           AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                        IF l_apcc109 > 0 THEN
                           CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,'aapt110',l_sfin2002,'0')  #沖銷方式:0
                        END IF
                     END IF
                     
                     #170518-00041#1 --s add
                     #4.18待抵單先寫入
                     IF (l_cnt_18 > 0) AND (g_apba004_18 <> '1') THEN
                        LET l_apcc109 = 0
                        SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                          FROM apcc_t
                         WHERE apccent = g_enterprise
                           AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                        IF l_apcc109 > 0 THEN
                           CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,'aapt110',l_sfin2002,'4')  #沖銷方式:4
                        END IF
                     END IF      
                     #170518-00041#1 --e add                     
                     
                     #1.21/23/25待抵單的單身有包含本次產生的立帳單對應的採購單(apcb008)者,整張單號優先沖
                     LET l_apcc109 = 0
                     SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                       FROM apcc_t
                      WHERE apccent = g_enterprise
                        AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                     IF l_apcc109 > 0 THEN
                        CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,lc_param_apca.wc2,l_sfin2002,'1')  #沖銷方式:1
                     END IF
                     #2.21/23/25待抵單+同帳款對象+同付款對象
                     LET l_apcc109 = 0
                     SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                       FROM apcc_t
                      WHERE apccent = g_enterprise
                        AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                     IF l_apcc109 > 0 THEN
                        CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,lc_param_apca.wc2,l_sfin2002,'2')  #沖銷方式:2
                     END IF
                     #3.其他單+同帳款對象+同付款對象
                     LET l_apcc109 = 0
                     SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                       FROM apcc_t
                      WHERE apccent = g_enterprise
                        AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                     IF l_apcc109 > 0 THEN
                        CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,lc_param_apca.wc2,l_sfin2002,'3')  #沖銷方式:3
                     END IF                     
                     #141127 carol:不要沖到只對上帳款對象的
                     #順序依序為:1.21/23/25待抵單的單身有包含本次產生的立帳單對應的採購單(apcb008)者,整張單號優先沖
                     #          2.21/23/25待抵單+同帳款對象+同付款對象
                     #          3.其他單+同帳款對象+同付款對象
                     LET l_cnt = 0
                     #SELECT count(*) INTO l_cnt        #161114-00009#1 mark 
                     SELECT count(apcedocno) INTO l_cnt #161114-00009#1 add
                       FROM apce_t
                      WHERE apceent = g_enterprise AND apceld = l_apca.apcald
                        AND apcedocno=l_apca.apcadocno
                     IF l_cnt > 0 THEN
                        CALL s_aapp131_ins_apce_diff(l_apca.apcald,l_apca.apcadocno)
                     END IF                        
                     #回寫apca_t單頭
                     CALL s_aap_clac_bill_master(l_apca.apcald,l_apca.apcadocno) RETURNING l_amount.*
                     UPDATE apca_t SET (apca103,apca104,apca106,apca107,apca108,
                                        apca113,apca114,apca116,apca117,apca118,
                                        apca123,apca124,apca126,apca127,apca128,
                                        apca133,apca134,apca136,apca137,apca138
                                        ) =
                                       (l_amount.apcb103,l_amount.xrcd104,l_amount.apca106,l_amount.apca107,l_amount.apca108,
                                        l_amount.apcb113,l_amount.xrcd114,l_amount.apca116,l_amount.apca117,l_amount.apca118,
                                        l_amount.apcb123,l_amount.xrcd124,l_amount.apca126,l_amount.apca127,l_amount.apca128,
                                        l_amount.apcb133,l_amount.xrcd134,l_amount.apca136,l_amount.apca137,l_amount.apca138
                                        )
                       WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
                         AND apcadocno = l_apca.apcadocno 
                     #因待抵沖銷因此會再展算一次多帳期
                     CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno ) RETURNING g_sub_success,g_errno
                     
                  END IF
                  #170406-00053#1 --s mark
                  ##170328-00087#1 --s add
                  #IF lc_param_apca.sel1 = '5' THEN 
                  #   #銷退單有維護原始發票號碼時,發票日期應為原發票日期
                  #   LET l_isam008 = ''
                  #   LET l_isam011 = ''
                  #   SELECT DISTINCT isam008,isam011 INTO l_isam008,l_isam011 FROM apbb_t,isam_t 
                  #    WHERE isament = g_enterprise AND isament = apbbent AND isamdocno = apbbdocno  
                  #      AND apbb003 = '2' AND apbb050 = '1' AND isam036 = '11' AND apbbstus <> 'X' 
                  #      AND isam010 = (SELECT DISTINCT isam010 FROM isam_t WHERE isament = g_enterprise AND isam050 = l_apca.apcadocno)                   
                  #      
                  #   #銷退單有維護原始發票號碼時,應串原發票類型取出對應的折單類型
                  #   LET l_isac009 = ''
                  #   SELECT isac009 INTO l_isac009 FROM isac_t
                  #    WHERE isacent = g_enterprise
                  #      AND isac001 = (SELECT ooef019 FROM ooef_t  WHERE ooefent = g_enterprise  AND ooef001 = l_apca.apcacomp)
                  #      AND isac002 = l_isam008                     
                  #   
                  #   UPDATE isam_t SET isam011 = l_isam011,isam008 = l_isac009
                  #    WHERE isament = g_enterprise AND isam050 = l_apca.apcadocno  
                  #END IF
                  ##170328-00087#1 --e add                  
                  #170406-00053#1 --e mark
          WHEN '3'
                  #150904 by 03538--s
                  #入庫立帳有發票清單者,應回寫單頭發票號碼
                  SELECT DISTINCT isam009,isam010 INTO l_apca065,l_apca066
                    FROM isam_t
                   WHERE isament = g_enterprise AND isam050 = l_apca.apcadocno
                   
                  SELECT COUNT(DISTINCT isam010) INTO l_cnt 
                    FROM isam_t
                   WHERE isament = g_enterprise AND isam050 = l_apca.apcadocno
                  IF l_cnt > 0 THEN 
                     IF l_cnt > 1 THEN
                        LET l_apca066 = 'MULTI'
                     END IF
                     UPDATE apca_t SET apca065 = l_apca065,apca066 = l_apca066
                      WHERE apcald = l_apca.apcald AND apcadocno=l_apca.apcadocno
                        AND apcaent = g_enterprise   #170210-00017#2 20170210 add by beckxie
                  END IF                   
                  #150904 by 03538--e          
                  #寫入沖銷
                  IF NOT cl_null(lc_param_apca.wc2) THEN
                     #1.21/23/25待抵單的單身有包含本次產生的立帳單對應的採購單(apcb008)者,整張單號優先沖
                     LET l_apcc109 = 0
                     SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                       FROM apcc_t
                      WHERE apccent = g_enterprise
                        AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                     IF l_apcc109 > 0 THEN
                        CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,lc_param_apca.wc2,l_sfin2002,'1')  #沖銷方式:1
                     END IF
                     #2.21/23/25待抵單+同帳款對象+同付款對象
                     LET l_apcc109 = 0
                     SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                       FROM apcc_t
                      WHERE apccent = g_enterprise
                        AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                     IF l_apcc109 > 0 THEN
                        CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,lc_param_apca.wc2,l_sfin2002,'2')  #沖銷方式:2
                     END IF
                     #3.其他單+同帳款對象+同付款對象
                     LET l_apcc109 = 0
                     SELECT SUM(apcc108 - apcc109) INTO l_apcc109
                       FROM apcc_t
                      WHERE apccent = g_enterprise
                        AND apccld  = l_apca.apcald AND apccdocno = l_apca.apcadocno
                     IF l_apcc109 > 0 THEN
                        CALL s_aapp131_ins_apce(l_apca.apcald,l_apca.apcadocno,lc_param_apca.wc2,l_sfin2002,'3')  #沖銷方式:3
                     END IF                     
                     #141127 carol:不要沖到只對上帳款對象的
                     #順序依序為:1.21/23/25待抵單的單身有包含本次產生的立帳單對應的採購單(apcb008)者,整張單號優先沖
                     #          2.21/23/25待抵單+同帳款對象+同付款對象
                     #          3.其他單+同帳款對象+同付款對象
                     LET l_cnt = 0
                     #SELECT count(*) INTO l_cnt        #161114-00009#1 mark
                     SELECT count(apcedocno) INTO l_cnt #161114-00009#1 add
                       FROM apce_t
                      WHERE apceent = g_enterprise AND apceld = l_apca.apcald
                        AND apcedocno=l_apca.apcadocno
                     IF l_cnt > 0 THEN
                        CALL s_aapp131_ins_apce_diff(l_apca.apcald,l_apca.apcadocno)
                        
                        #171109-00014#2 add ------
                        LET l_sql = "SELECT apcbseq,apcb002,apcb008,apcb103",
                                    "  FROM apcb_t",
                                    " WHERE apcbent = ",g_enterprise,
                                    "   AND apcbld = '",l_apca.apcald,"'",
                                    "   AND apcbdocno = '",l_apca.apcadocno,"'",
                                    " ORDER BY apcbseq"
                        PREPARE s_aapp131_sel_apcb_pr1 FROM l_sql
                        DECLARE s_aapp131_sel_apcb_cs1 CURSOR FOR s_aapp131_sel_apcb_pr1
                        FOREACH s_aapp131_sel_apcb_cs1 INTO l_apcbseq,l_apcb002,l_apcb008,l_apcb103
                           
                           IF NOT cl_null(l_apcb008) THEN
                              LET lc_param_115.ld       = l_apca.apcald
                              LET lc_param_115.pmdt001  = l_apcb008   #訂單單號
                              LET lc_param_115.pmdtdocno= l_apcb002   #入庫單號
                              LET lc_param_115.apcbdocno= l_apca.apcadocno
                              LET lc_param_115.apcbseq  = l_apcbseq
                              LET lc_param_115.apcb103  = l_apcb103
                              LET lc_param_115.apca012  = l_apca.apca012
                              LET lc_param_115.apca101  = l_apca.apca101
                              LET ls_js = util.JSON.stringify(lc_param_115)
                              CALL s_aapp131_count_115(ls_js)
                                   RETURNING g_sub_success,l_flag2,l_apcb113,l_apcb114,l_apcb115
                              IF l_flag2 = 'Y' THEN
                                 UPDATE apcb_t SET (apcb113,apcb114,apcb115
                                                   ) = (
                                                   l_apcb113,l_apcb114,l_apcb115
                                                   )
                                 WHERE apcbent = g_enterprise
                                   AND apcbld = l_apca.apcald
                                   AND apcbdocno = l_apca.apcadocno
                                   AND apcbseq = l_apcbseq
                              END IF
                           END IF
                        END FOREACH
                        #171109-00014#2 add end---
                     END IF
                     
                     #回寫apca_t單頭
                     CALL s_aap_clac_bill_master(l_apca.apcald,l_apca.apcadocno) RETURNING l_amount.*
                     UPDATE apca_t SET (apca103,apca104,apca106,apca107,apca108,
                                        apca113,apca114,apca116,apca117,apca118,
                                        apca123,apca124,apca126,apca127,apca128,
                                        apca133,apca134,apca136,apca137,apca138
                                        ) =
                                       (l_amount.apcb103,l_amount.xrcd104,l_amount.apca106,l_amount.apca107,l_amount.apca108,
                                        l_amount.apcb113,l_amount.xrcd114,l_amount.apca116,l_amount.apca117,l_amount.apca118,
                                        l_amount.apcb123,l_amount.xrcd124,l_amount.apca126,l_amount.apca127,l_amount.apca128,
                                        l_amount.apcb133,l_amount.xrcd134,l_amount.apca136,l_amount.apca137,l_amount.apca138
                                        )
                       WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
                         AND apcadocno = l_apca.apcadocno 
                     #因待抵沖銷因此會再展算一次多帳期
                     CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno ) RETURNING g_sub_success,g_errno
                     
                  END IF
      END CASE
           
      #161012-00026#1-----s
      IF lc_param_apca.sel1 = '7' THEN
         #170110-00035#1 add ------
         #抓取訂金期別回寫至aapt310單頭
         SELECT DISTINCT apba020,apba005 INTO l_apca.apca064,l_apba005    #170420-00033#1 add apba005 lujh
           FROM apba_t
          WHERE apbaent = g_enterprise AND apbadocno = l_apca.apca018
            AND apba004 = '10' #採購單
            
         #170420-00033#1--add--str--lujh   
         SELECT pmdl046 INTO l_pmdl046  
           FROM pmdl_t
          WHERE pmdlent = g_enterprise
            AND pmdldocno = l_apba005   
         #170420-00033#1--add--str--lujh  
         IF cl_null(l_pmdl046) THEN LET l_pmdl046 = lc_param_apca.type END IF #170619-00037#1   add        
            
         UPDATE apca_t SET apca064 = l_apca.apca064,
                           apca060 = l_pmdl046          #170420-00033#1 add lujh
          WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
           AND apcadocno= l_apca.apcadocno
         #170110-00035#1 add end---
         CALL s_aapt310_apcb_upd_source(l_apca.apcald,l_apca.apcadocno,'+') RETURNING g_sub_success,g_errno
         IF NOT g_sub_success THEN
            LET r_success = FALSE
         END IF
      END IF
      #161012-00026#1-----e
      
      #回寫來源單據資料
      IF lc_param_apca.type MATCHES '[123]' THEN
         #pmdt單據數量
         CALL s_aapt300_pmdt_upd(l_apca.apcald,l_apca.apcadocno,'0','+') RETURNING g_sub_success,g_errno
          #180904-00066#1---add---str
         IF NOT g_sub_success THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = "axr-00165"
            LET g_errparam.extend = "upd pmdt_t"
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
         END IF 
         #180904-00066#1---add---end
      
      END IF
      #產生分錄#
      CALL s_aooi200_fin_get_slip(l_apca.apcadocno) RETURNING g_sub_success,l_ap_slip         
      CALL s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,l_ap_slip,'D-FIN-0030') RETURNING l_chr
      IF l_glaa121 = 'Y' AND l_chr = 'Y'THEN
         CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
              RETURNING g_sub_success
      END IF
      IF cl_null(r_strno)THEN LET r_strno = l_apca.apcadocno  END IF
      LET r_endno = l_apca.apcadocno 
      #151125-00006#2--str--   
      LET l_count = 0
      #SELECT COUNT(*) INTO l_count FROM apcb_t WHERE apcbent = g_enterprise        #161114-00009#1 mark
      SELECT COUNT(apcbdocno) INTO l_count FROM apcb_t WHERE apcbent = g_enterprise #161114-00009#1 add
         AND apcbdocno = l_apca.apcadocno
         AND apcbld = l_apca.apcald
      IF cl_null(l_count) THEN LET l_count = 0 END IF

      IF NOT cl_null(l_apca.apcald) AND NOT cl_null(l_apca.apcacomp) AND NOT cl_null(l_apca.apcadocno) AND l_count > 0 THEN
         #取得單別
         CALL s_aooi200_fin_get_slip(l_apca.apcadocno) RETURNING l_success,l_slip
         #取得單別設置的"是否直接審核"參數
         CALL s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,l_slip,'D-FIN-0031') RETURNING l_dfin0031      
         
         #IF l_dfin0031 = 'Y' THEN                       #170518-00041#1 mark
         IF l_dfin0031 = 'Y' OR g_apba004_18 = '1' THEN  #170518-00041#1 add 差異折讓產生的單據需執行單據確認
            CALL s_aapp131_immediately_conf(l_apca.apcald,l_apca.apcacomp,l_apca.apcadocno)
               RETURNING r_success
         #180802-00062#1 --s add 多角產生的帳款不論帳款單別是否自動確認,一律為確認狀態 
         ELSE
            IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN
               CALL s_aapp131_immediately_conf(l_apca.apcald,l_apca.apcacomp,l_apca.apcadocno)
                  RETURNING r_success
            END IF
         #180802-00062#1 --e add         
         END IF
      #180802-00062#1 --s add 多角產生的帳款不論帳款單別是否自動確認,一律為確認狀態,無法確認則報錯
      ELSE
         IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN
            IF l_count = 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aec-00020'
               LET g_errparam.extend = l_apca.apcadocno,'- apcb_t'
               LET g_errparam.popup = FALSE
               CALL cl_err()
            END IF
            LET r_success = FALSE #上方IF 條件不成立就要FALSE,因此錯誤擺這 (IF NOT cl_null(l_apca.apcald) AND NOT cl_null(l_apca.apcacomp) AND NOT cl_null(l_apca.apcadocno) AND l_count > 0 THEN) 
         END IF
      #180802-00062#1 --e add           
      END IF
      #151125-00006#2--end--
      #150126-00012#1--str--
      IF NOT r_success THEN 
         #180802-00062#1 --s add 多角產生的帳款如出錯則不繼續
         IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN
            LET r_success = FALSE
            LET r_strno = ''
            LET r_endno = ''
            EXIT FOREACH
         END IF
         #180802-00062#1 --e add      
         CALL s_transaction_end('N','0')           
      ELSE
         #180802-00062#1 --s add 多角產生的帳款如出錯則不繼續
         IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN
            CALL s_aapp131_immediately_gen(l_apca.apcald,l_apca.apcacomp,l_apca.apcadocno)
            CONTINUE FOREACH
         END IF
         #180802-00062#1 --e add        
         CALL s_transaction_end('Y','0')
      END IF
      #150126-00012#1--end--
      #151125-00006#2--str--      
      IF r_success THEN
          CALL s_aapp131_immediately_gen(l_apca.apcald,l_apca.apcacomp,l_apca.apcadocno)
      END IF
      #151125-00006#2--end--      
   END FOREACH
  
   #150126-00012#1--str--
   IF cl_null(r_strno) AND cl_null(r_endno) THEN   #沒有產生任何單號,視為失敗
      LET r_success = FALSE
   END IF
   CLOSE s_aapp131_pmdt_cl
   #150126-00012#1--end--
   
   RETURN r_success,r_strno,r_endno

END FUNCTION

################################################################################
# Descriptions...: 立帳單身(暫估立帳)
# Memo...........:
# Date & Author..: 14/10/06 By Belle
# Modify.........: #180705-00083#1 add 税额科目 by 08172
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcb1(p_ld,p_docno,p_pmds000,p_pmds037,p_pmds038,p_pmds007,p_apca007,p_cond1,p_sfin2002,p_pmds031,p_xrcd009)
DEFINE p_ld          LIKE apca_t.apcald         #帳套
DEFINE p_docno       LIKE apca_t.apcadocno      #單據編號
DEFINE p_pmds000     LIKE pmds_t.pmds000        #帳款性質
DEFINE p_pmds037     LIKE pmds_t.pmds037        #幣別
DEFINE p_pmds038     LIKE pmds_t.pmds038
DEFINE p_pmds007     LIKE pmds_t.pmds007        #採購供應商
DEFINE p_apca007     LIKE apca_t.apca007        #帳款類別
DEFINE p_cond1       LIKE type_t.chr500         #彙總條件值
DEFINE p_sfin2002    LIKE type_t.chr1           #沖銷參數
DEFINE p_pmds031     LIKE pmds_t.pmds031        #付款條件
DEFINE p_xrcd009     LIKE xrcd_t.xrcd009        #税额科目  #180705-00083#1 add
DEFINE r_success     LIKE type_t.num5

#DEFINE l_apca        RECORD LIKE apca_t.*       #立帳單頭 #161111-00048#2 mark
#DEFINE l_apcb        RECORD LIKE apcb_t.*       #立帳單身 #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE l_apcb RECORD  #應付憑單單身
       apcbent LIKE apcb_t.apcbent, #企業編號
       apcbld LIKE apcb_t.apcbld, #帳套
       apcblegl LIKE apcb_t.apcblegl, #核算組織
       apcborga LIKE apcb_t.apcborga, #帳務歸屬組織(來源組織)
       apcbsite LIKE apcb_t.apcbsite, #應付帳務組織
       apcbdocno LIKE apcb_t.apcbdocno, #單號
       apcbseq LIKE apcb_t.apcbseq, #項次
       apcb001 LIKE apcb_t.apcb001, #來源類型
       apcb002 LIKE apcb_t.apcb002, #來源業務單據號碼
       apcb003 LIKE apcb_t.apcb003, #來源業務單據項次
       apcb004 LIKE apcb_t.apcb004, #產品編號
       apcb005 LIKE apcb_t.apcb005, #品名規格
       apcb006 LIKE apcb_t.apcb006, #單位
       apcb007 LIKE apcb_t.apcb007, #計價數量
       apcb008 LIKE apcb_t.apcb008, #參考單據號碼
       apcb009 LIKE apcb_t.apcb009, #參考單據項次
       apcb010 LIKE apcb_t.apcb010, #業務部門
       apcb011 LIKE apcb_t.apcb011, #責任中心
       apcb012 LIKE apcb_t.apcb012, #產品類別
       apcb013 LIKE apcb_t.apcb013, #搭贈
       apcb014 LIKE apcb_t.apcb014, #理由碼
       apcb015 LIKE apcb_t.apcb015, #專案編號
       apcb016 LIKE apcb_t.apcb016, #WBS編號
       apcb017 LIKE apcb_t.apcb017, #預算細項
       apcb018 LIKE apcb_t.apcb018, #专柜编号
       apcb019 LIKE apcb_t.apcb019, #開票性質
       apcb020 LIKE apcb_t.apcb020, #稅別
       apcb021 LIKE apcb_t.apcb021, #費用會計科目
       apcb022 LIKE apcb_t.apcb022, #正負值
       apcb023 LIKE apcb_t.apcb023, #沖暫估單否
       apcb024 LIKE apcb_t.apcb024, #區域
       apcb025 LIKE apcb_t.apcb025, #傳票號碼
       apcb026 LIKE apcb_t.apcb026, #傳票項次
       apcb027 LIKE apcb_t.apcb027, #發票編號
       apcb028 LIKE apcb_t.apcb028, #發票號碼
       apcb029 LIKE apcb_t.apcb029, #應付帳款科目
       apcb030 LIKE apcb_t.apcb030, #付款條件
       apcb032 LIKE apcb_t.apcb032, #訂金序次
       apcb033 LIKE apcb_t.apcb033, #經營方式
       apcb034 LIKE apcb_t.apcb034, #通路
       apcb035 LIKE apcb_t.apcb035, #品牌
       apcb036 LIKE apcb_t.apcb036, #客群
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046, #自由核算項十
       apcb047 LIKE apcb_t.apcb047, #摘要
       apcb048 LIKE apcb_t.apcb048, #來源訂購單號
       apcb049 LIKE apcb_t.apcb049, #開票單號
       apcb050 LIKE apcb_t.apcb050, #開票項次
       apcb051 LIKE apcb_t.apcb051, #業務人員
       apcb100 LIKE apcb_t.apcb100, #交易原幣
       apcb101 LIKE apcb_t.apcb101, #交易原幣單價
       apcb102 LIKE apcb_t.apcb102, #原幣匯率
       apcb103 LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104 LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105 LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb106 LIKE apcb_t.apcb106, #交易幣標準成本金額
       apcb107 LIKE apcb_t.apcb107, #入庫單單價
       apcb108 LIKE apcb_t.apcb108, #交易原幣成本認列金額
       apcb111 LIKE apcb_t.apcb111, #本幣單價
       apcb113 LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114 LIKE apcb_t.apcb114, #本幣稅額
       apcb115 LIKE apcb_t.apcb115, #本幣含稅金額
       apcb116 LIKE apcb_t.apcb116, #本幣標準成本金額
       apcb117 LIKE apcb_t.apcb117, #NO USE
       apcb118 LIKE apcb_t.apcb118, #本幣成本認列金額
       apcb119 LIKE apcb_t.apcb119, #應開發票含稅金額
       apcb121 LIKE apcb_t.apcb121, #本位幣二匯率
       apcb123 LIKE apcb_t.apcb123, #本位幣二未稅金額
       apcb124 LIKE apcb_t.apcb124, #本位幣二稅額
       apcb125 LIKE apcb_t.apcb125, #本位幣二含稅金額
       apcb126 LIKE apcb_t.apcb126, #本幣二標準成本金額
       apcb127 LIKE apcb_t.apcb127, #NO USE
       apcb128 LIKE apcb_t.apcb128, #本位幣二成本認列金額
       apcb131 LIKE apcb_t.apcb131, #本位幣三匯率
       apcb133 LIKE apcb_t.apcb133, #本位幣三未稅金額
       apcb134 LIKE apcb_t.apcb134, #本位幣三稅額
       apcb135 LIKE apcb_t.apcb135, #本位幣三含稅金額
       apcb136 LIKE apcb_t.apcb136, #本幣三標準成本金額
       apcb137 LIKE apcb_t.apcb137, #NO USE
       apcb138 LIKE apcb_t.apcb138, #本位幣三成本認列金額
       apcbud001 LIKE apcb_t.apcbud001, #自定義欄位(文字)001
       apcbud002 LIKE apcb_t.apcbud002, #自定義欄位(文字)002
       apcbud003 LIKE apcb_t.apcbud003, #自定義欄位(文字)003
       apcbud004 LIKE apcb_t.apcbud004, #自定義欄位(文字)004
       apcbud005 LIKE apcb_t.apcbud005, #自定義欄位(文字)005
       apcbud006 LIKE apcb_t.apcbud006, #自定義欄位(文字)006
       apcbud007 LIKE apcb_t.apcbud007, #自定義欄位(文字)007
       apcbud008 LIKE apcb_t.apcbud008, #自定義欄位(文字)008
       apcbud009 LIKE apcb_t.apcbud009, #自定義欄位(文字)009
       apcbud010 LIKE apcb_t.apcbud010, #自定義欄位(文字)010
       apcbud011 LIKE apcb_t.apcbud011, #自定義欄位(數字)011
       apcbud012 LIKE apcb_t.apcbud012, #自定義欄位(數字)012
       apcbud013 LIKE apcb_t.apcbud013, #自定義欄位(數字)013
       apcbud014 LIKE apcb_t.apcbud014, #自定義欄位(數字)014
       apcbud015 LIKE apcb_t.apcbud015, #自定義欄位(數字)015
       apcbud016 LIKE apcb_t.apcbud016, #自定義欄位(數字)016
       apcbud017 LIKE apcb_t.apcbud017, #自定義欄位(數字)017
       apcbud018 LIKE apcb_t.apcbud018, #自定義欄位(數字)018
       apcbud019 LIKE apcb_t.apcbud019, #自定義欄位(數字)019
       apcbud020 LIKE apcb_t.apcbud020, #自定義欄位(數字)020
       apcbud021 LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
       apcbud022 LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
       apcbud023 LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
       apcbud024 LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
       apcbud025 LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
       apcbud026 LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
       apcbud027 LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
       apcbud028 LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
       apcbud029 LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
       apcbud030 LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
       apcb052 LIKE apcb_t.apcb052, #稅額
       apcb053 LIKE apcb_t.apcb053, #含稅金額
       apcb054 LIKE apcb_t.apcb054, #帳款對象
       apcb055 LIKE apcb_t.apcb055  #付款對象
END RECORD
#161111-00048#2 --e add
DEFINE l_pmdtsite    LIKE pmdt_t.pmdtsite  
DEFINE l_pmds000     LIKE pmds_t.pmds000        #入庫單性質
DEFINE l_pmdt001     LIKE pmdt_t.pmdt001        #採購單號
DEFINE l_pmdt006     LIKE pmdt_t.pmdt006        #產品編號
DEFINE l_pmdt023     LIKE pmdt_t.pmdt023        #單位
DEFINE l_pmdt036     LIKE pmdt_t.pmdt036        #原幣單價
DEFINE l_pmdt046     LIKE pmdt_t.pmdt046
DEFINE l_pmdt037     LIKE pmdt_t.pmdt037
DEFINE l_pmdt072     LIKE pmdt_t.pmdt072        #專案編號
DEFINE l_pmdt073     LIKE pmdt_t.pmdt073        #WBS
DEFINE l_sql         STRING
DEFINE l_str         LIKE type_t.chr500
DEFINE l_apcb105     LIKE apcb_t.apcb105        #本幣單價*數量金額
DEFINE l_tmp         RECORD
         pmdtsite    LIKE pmdt_t.pmdtsite,
         pmdtdocno   LIKE pmdt_t.pmdtdocno,
         pmdtseq     LIKE pmdt_t.pmdtseq,
         apcb007     LIKE apcb_t.apcb007,
         pmds031     LIKE pmds_t.pmds031
                     END RECORD
DEFINE l_flag        LIKE type_t.num5           #是否為入庫單全部數量立帳   #141204-00017#1                
DEFINE l_glaa001     LIKE glaa_t.glaa001        #140806-00012#12
DEFINE l_acctype     LIKE type_t.chr2           #150313-00003#2   
DEFINE l_ar          DYNAMIC ARRAY OF RECORD
                     chr  LIKE type_t.chr500
                 END RECORD                
DEFINE l_glaacomp    LIKE glaa_t.glaacomp
DEFINE l_sfin3012    LIKE type_t.chr1        #含稅立帳否
DEFINE l_oodb004     LIKE oodb_t.oodb004
DEFINE l_oodb005     LIKE oodb_t.oodb005
DEFINE l_oodb006     LIKE oodb_t.oodb006
DEFINE l_oodb011     LIKE oodb_t.oodb011
DEFINE l_pmds012     LIKE pmds_t.pmds012     #採購通路 #160120-00011#2
DEFINE l_pmds013     LIKE pmds_t.pmds013     #採購分類 #160120-00011#2
DEFINE l_pmds100     LIKE pmds_t.pmds100     #倉退方式   #190220-00035#1 add
DEFINE l_pmdt016     LIKE pmdt_t.pmdt016     #倉庫     #160120-00011#2
DEFINE l_apcb106     LIKE apcb_t.apcb106     #160107-00001#1
DEFINE l_apcb116     LIKE apcb_t.apcb116     #160107-00001#1
DEFINE l_apcb126     LIKE apcb_t.apcb126     #160107-00001#1
DEFINE l_apcb136     LIKE apcb_t.apcb136     #160107-00001#1
DEFINE l_ld_type     LIKE type_t.chr1
DEFINE l_pmdt051     LIKE pmdt_t.pmdt051     #161104-00049#6
DEFINE l_pmdt002     LIKE pmdt_t.pmdt002     #170510-00041#1
DEFINE l_bgbd039     LIKE bgbd_t.bgbd039     #170510-00041#1
#170526-00019#1--add--str--lujh     
DEFINE l_imaa004     LIKE imaa_t.imaa004     
DEFINE l_imag011     LIKE imag_t.imag011     
#170526-00019#1--add--end--lujh
#180704-00022#1 add ---s
DEFINE l_array       DYNAMIC ARRAY OF RECORD
       chr  LIKE type_t.chr1000
       END RECORD  
#180704-00022#1 add ---e
#180705-00083#1 add -s
DEFINE l_apcb2       RECORD #固定核算项
       apcb054       LIKE apcb_t.apcb054,
       apcb055       LIKE apcb_t.apcb055,
       apcb051       LIKE apcb_t.apcb051,
       apcb010       LIKE apcb_t.apcb010,
       apcb011       LIKE apcb_t.apcb011,
       apcb024       LIKE apcb_t.apcb024,
       apcb036       LIKE apcb_t.apcb036,
       apcb012       LIKE apcb_t.apcb012,
       apcb033       LIKE apcb_t.apcb033,
       apcb034       LIKE apcb_t.apcb034,
       apcb035       LIKE apcb_t.apcb035,
       apcb015       LIKE apcb_t.apcb015,
       apcb016       LIKE apcb_t.apcb016
                     END RECORD
DEFINE l_apcb3       RECORD #自由核算项
       apcb037       LIKE apcb_t.apcb037, 
       apcb038       LIKE apcb_t.apcb038,
       apcb039       LIKE apcb_t.apcb039, 
       apcb040       LIKE apcb_t.apcb040,
       apcb041       LIKE apcb_t.apcb041, 
       apcb042       LIKE apcb_t.apcb042,
       apcb043       LIKE apcb_t.apcb043, 
       apcb044       LIKE apcb_t.apcb044,
       apcb045       LIKE apcb_t.apcb045,     
       apcb046       LIKE apcb_t.apcb046            
                     END RECORD                     
#180705-00083#1 add -e
DEFINE l_pmdt005     LIKE pmdt_t.pmdt005   #190103-00077#1 add
DEFINE l_cnt         LIKE type_t.num10     #190813-00006#1 add  
DEFINE l_pmdt062     LIKE pmdt_t.pmdt062   #190815-00012#1 add 
DEFINE l_pmdu006     LIKE pmdu_t.pmdu006   #190815-00012#1 add
DEFINE l_imaf141     LIKE imaf_t.imaf141   #190812-00010#5 add 
DEFINE l_kind        STRING                #190812-00010#5 add 
#191010-00012#1---add---str
DEFINE l_pmds006     LIKE pmds_t.pmds006
DEFINE l_pmdl008     LIKE pmdl_t.pmdl008
#191010-00012#1---add---end  
DEFINE l_type        LIKE type_t.chr5      #190305-00001#2 add   #取得科目类型
DEFINE l_b_date      LIKE type_t.dat       #190325-00047#1 add
DEFINE l_apba010     LIKE apba_t.apba010   #190325-00047#1 add 
#200805-00007#1 add -s   
DEFINE l_apcb010     LIKE apcb_t.apcb010
DEFINE l_apcb021     LIKE apcb_t.apcb021
#200805-00007#1 add -e
#201127-00012#1 add ---(s)
DEFINE l_ls_js   STRING
DEFINE l_tran    RECORD
   docno        LIKE apcb_t.apcbdocno,
   ld           LIKE apcb_t.apcbld,
   docdt        LIKE apca_t.apcadocdt,
   comp         LIKE apca_t.apcacomp,
   seq          LIKE apcb_t.apcbseq,  
   bgbd007      LIKE bgbd_t.bgbd007,     
   bgbd037      LIKE bgbd_t.bgbd037,
   bgbd038      LIKE bgbd_t.bgbd038,
   bgbd040      LIKE bgbd_t.bgbd040,     
   bgbd007_t    LIKE bgbd_t.bgbd007,    #修改前的預算細項
   bgbd037_t    LIKE bgbd_t.bgbd037,    #修改前的單號
   bgbd038_t    LIKE bgbd_t.bgbd038,    #修改前的項次
   bgbd040_t    LIKE bgbd_t.bgbd040,    #修改前被占用的金額
   act          LIKE type_t.chr10     
END RECORD
#201127-00012#1 add ---(e)
DEFINE l_apcb007_sum  LIKE apcb_t.apcb007  #200911-00018#1 add
#200916-00030#1-(S) add
DEFINE l_minus_chk   LIKE type_t.num5
DEFINE l_pmdt024     LIKE pmdt_t.pmdt024
DEFINE l_pmds054     LIKE pmds_t.pmds054
#200916-00030#1-(E) add

   WHENEVER ERROR CONTINUE

   LET r_success = TRUE
   INITIALIZE l_apca.* TO NULL
   
   #SELECT * INTO l_apca.*   #161208-00026#22   mark
   #161208-00026#22   add---s
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073
     INTO l_apca.*
   #161208-00026#22   add---e
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_docno
   LET l_sql = " SELECT pmdtsite,pmdtdocno,pmdtseq,apcb007,pmds031 ",
               "   FROM s_aapp131_tmp_g ",
               "  WHERE pmds000 = '",p_pmds000,"' AND pmds037 = '",p_pmds037,"'",
               "    AND pmds007 = '",p_pmds007,"' AND cond1   = '",p_cond1,"'",
               "    AND pmds008 = '",l_apca.apca005,"'",         #200218-00040#8 add
               "    AND pmds038 =  ",p_pmds038,"  AND apca007 = '",p_apca007,"'",
               "    AND pmds033 = '",l_apca.apca011,"'"
               
   #若為沖銷參數1/2 彙總條件增加付款條件
   IF p_sfin2002 MATCHES '[12]' THEN   
      LET l_sql = l_sql," AND pmds031 = '",p_pmds031,"'"
   END IF
   #LET l_sql = l_sql," ORDER BY pmdtdocno,pmdtseq "   #150126-00012#1             #170324-00028#1 mark
   LET l_sql = l_sql," ORDER BY cond1,pmds008,pmds033,pmds031,pmdtdocno,pmdtseq "  #170324-00028#1 add
   PREPARE s_aapp131_ins_apcb1_p FROM l_sql
   DECLARE s_aapp131_ins_apcb1_c CURSOR FOR s_aapp131_ins_apcb1_p
   CALL s_ld_sel_glaa(p_ld,'glaa001|glaacomp') RETURNING g_sub_success,l_glaa001,l_glaacomp   #150615 add glaacomp
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012                #150615
   #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101 #160829-00004#5 mark
  #CALL s_curr_round_ld('1',p_ld,l_apca.apca100,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101  #160829-00004#5 #170430-00006#2 mark
   CALL s_num_round(g_round_type,l_apca.apca101,g_ooaj005) RETURNING l_apca.apca101  #170430-00006#2 add
   
   #本張立帳單單身來源的所有入庫單資訊必須先lock住,若有任何一筆入庫單lock失敗,則整張立帳單身停止動作
   #150126-00012#1--str--
   FOREACH s_aapp131_ins_apcb1_c INTO l_tmp.*
      OPEN s_aapp131_pmdt_cl USING g_enterprise,l_tmp.pmdtdocno,l_tmp.pmdtseq
      IF STATUS THEN
         LET r_success = FALSE
         RETURN r_success
      END IF      
   END FOREACH   
   #150126-00012#1--end--
   CALL s_fin_get_ld_type(p_ld) RETURNING l_ld_type
   
   #161114-00009#1 --s add
   #迴圈內SELECT外搬PREPARE
   LET l_sql = " SELECT pmds000,pmds012,pmds013,pmds100 ",   #190220-00035#1 add pmds100
               "   FROM pmds_t ",
               "  WHERE pmdsent = ",g_enterprise," AND pmdsdocno = ? "
   PREPARE s_aapp131_get_pmdsp FROM l_sql   
   
   LET l_sql = " SELECT pmdt001,pmdt006,pmdt016,pmdt023,pmdt036,pmdtsite, ", 
               "        pmdt037,pmdt046,pmdt072,pmdt073,pmdt002 ",     #170510-00041#1 add pmdt002
               " ,pmdt005,pmdt062 ",   #190103-00077#1 add        #190815-00012#1---add--->,pmdt062
               "   FROM pmdt_t ",
               "  WHERE pmdtent = ",g_enterprise," AND pmdtdocno = ? AND pmdtseq = ?  "  
   PREPARE s_aapp131_get_pmdtp FROM l_sql   
   
   LET l_sql = " SELECT imaa009 ",
               "   FROM imaa_t ",
               "  WHERE imaaent = ",g_enterprise," AND imaa001 = ? "
   PREPARE s_aapp131_imaa009 FROM l_sql
   
   LET l_sql = " SELECT MAX(apcbseq)+1 FROM apcb_t ",
               "  WHERE apcbent = ",g_enterprise," AND apcbld  = ? AND apcbdocno = ?  "
   PREPARE s_aapp131_getseqp FROM l_sql      
   #161114-00009#1 --e add   
   
   #190812-00010#5 add s---
   LET l_sql = " SELECT imaf141 FROM imaf_t ",
               "  WHERE imafent = ",g_enterprise," AND imaf001 = ?",
               "    AND imafsite = (SELECT glaacomp FROM glaa_t WHERE glaaent=",g_enterprise," AND glaald= ?) "
   PREPARE s_aapp131_imaf141_prep FROM l_sql 
   #190812-00010#5 add e---
   
   #200916-00030#1-(S) add
   #取得來源倉退單資訊 
   LET l_sql = " SELECT pmdt024, (SELECT DISTINCT pmds054 FROM pmds_t WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno)pmds054 ", 
               "   FROM pmdt_t ",
               "  WHERE pmdtent = ",g_enterprise," AND pmdtdocno = ? AND pmdtseq = ? "           
   PREPARE s_aapp131_pmdt024_prep FROM l_sql
   #200916-00030#1-(E) add
   
   FOREACH s_aapp131_ins_apcb1_c INTO l_tmp.*
      INITIALIZE l_apcb.* TO NULL
      
      #161114-00009#1 --s add
      LET l_pmds000 = '' LET l_pmds012 = '' LET l_pmds013 = ''
      LET l_pmds100 = ''   #190220-00035#1 add
      EXECUTE s_aapp131_get_pmdsp USING l_tmp.pmdtdocno INTO l_pmds000,l_pmds012,l_pmds013,l_pmds100   #190220-00035#1 add l_pmds100
      IF cl_null(l_pmds100) THEN LET l_pmds100 = ' ' END IF   #190227-00032#1 add
      #161114-00009#1 --e add      
      
      #161114-00009#1 --s mark
      #SELECT pmds000,pmds012,pmds013 
      #  INTO l_pmds000,l_pmds012,l_pmds013    #160120-00011#2 add pmds012,pmds013
      #  FROM pmds_t
      # WHERE pmdsent = g_enterprise   AND pmdsdocno = l_tmp.pmdtdocno
      #161114-00009#1 --e mark

      LET l_pmdt001 = '' LET l_pmdt006 = '' LET l_pmdt023 = '' LET l_pmdt036 = ''
      LET l_pmdtsite = ''LET l_pmdt037 = '' LET l_pmdt046 = '' LET l_pmdt016 = ''
      #161114-00009#1 --s add
      LET l_pmdt072 = '' LET l_pmdt073 = ''
      EXECUTE s_aapp131_get_pmdtp USING l_tmp.pmdtdocno,l_tmp.pmdtseq 
         INTO l_pmdt001,l_pmdt006,l_pmdt016,l_pmdt023,l_pmdt036,l_pmdtsite,
              l_pmdt037,l_pmdt046,l_pmdt072,l_pmdt073,l_pmdt002 #170510-00041#1 l_pmdt002
             ,l_pmdt005,l_pmdt062   #190103-00077#1 add     #190815-00012#1---add--->,l_pmdt062               
      #161114-00009#1 --e add
      #190815-00012#1---add--str
      IF l_pmdt062 = 'Y' THEN
         LET l_sql = " SELECT DISTINCT pmdu006  FROM pmdu_t  ",
                     "  WHERE pmduent = ",g_enterprise,
                     #"    AND pmdudocno = ",l_tmp.pmdtdocno,      #PGS(D)-01531 mark
                     "    AND pmdudocno = '",l_tmp.pmdtdocno,"'",  #PGS(D)-01531 add
                     "    AND pmduseq = ",l_tmp.pmdtseq 
         PREPARE s_aapp131_pmdu006_1 FROM l_sql
         DECLARE s_aapp131_pmdu006_c1 CURSOR FOR s_aapp131_pmdu006_1
      END IF
      #190815-00012#1---add--end
      #161114-00009#1 --s mark
      #SELECT pmdt001,pmdt006,pmdt016,pmdt023,pmdt036,pmdtsite,                #160120-00011#2 add pmdt016
      #       pmdt037,pmdt046,pmdt072,pmdt073
      #  INTO l_pmdt001,l_pmdt006,l_pmdt016,l_pmdt023,l_pmdt036,l_pmdtsite,
      #       l_pmdt037,l_pmdt046,l_pmdt072,l_pmdt073
      #  FROM pmdt_t
      # WHERE pmdtent = g_enterprise   AND pmdtdocno = l_tmp.pmdtdocno AND pmdtseq = l_tmp.pmdtseq   
      #161114-00009#1 --e mark
      
      LET l_apcb.apcbent = g_enterprise
      LET l_apcb.apcbld  = p_ld
      LET l_apcb.apcborga= l_tmp.pmdtsite
      LET l_apcb.apcbsite= l_apca.apcasite
      LET l_apcb.apcblegl= l_apca.apcacomp
      LET l_apcb.apcbdocno = p_docno

      EXECUTE s_aapp131_getseqp USING l_apcb.apcbld,l_apcb.apcbdocno INTO l_apcb.apcbseq #161114-00009#1 add
         
      #161114-00009#1 --s mark
      #SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq 
      #  FROM apcb_t
      # WHERE apcbent = g_enterprise AND apcbld  = l_apcb.apcbld
      #   AND apcbdocno  = l_apcb.apcbdocno
      #161114-00009#1 --e mark
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      CASE 
         #WHEN l_pmds000 MATCHES '[346]' OR l_pmds000 MATCHES '1[2378]'          #150702-00001#1 mark
         #     OR l_pmds000 = '20'         #入庫   #150629-00038#1 add 17 18 20   #150702-00001#1 mark
         WHEN s_aap_pmds000_chk('2',l_pmds000)   ##150702-00001#1 add
              LET l_apcb.apcb001 = "11"
              LET l_apcb.apcb022 = 1
         #WHEN l_pmds000 = '5' OR l_pmds000 MATCHES '1[01]' #驗退     #150702-00001#1 mark
         WHEN s_aap_pmds000_chk('5',l_pmds000)   ##150702-00001#1 add
              LET l_apcb.apcb001 = "20"
              LET l_apcb.apcb022 = -1
         #WHEN l_pmds000 = '7' OR l_pmds000 MATCHES '1[459]' #倉退   #150629-00038#1 add 19   #150702-00001#1 mark
         WHEN s_aap_pmds000_chk('4',l_pmds000)   ##150702-00001#1 add
              LET l_apcb.apcb001 = "21"
              LET l_apcb.apcb022 = -1
      END CASE
      LET l_apcb.apcb002 = l_tmp.pmdtdocno
      LET l_apcb.apcb003 = l_tmp.pmdtseq
      LET l_apcb.apcb004 = l_pmdt006   #產品編號
      LET l_apcb.apcb005 = s_aapt300_get_apcb005(l_apcb.apcb004,l_tmp.pmdtdocno,l_tmp.pmdtseq)
      LET l_apcb.apcb006 = l_pmdt023   #單位
      LET l_apcb.apcb007 = l_tmp.apcb007
      #重新取得可立帳數量,數量為0則不新增此單身(141204-00017#1)
      CALL s_aapt300_pmdt_get_apcb007(p_ld,l_apcb.apcb002,l_apcb.apcb003,l_apca.apca001) RETURNING l_apcb.apcb007,l_flag   
      #IF l_apcb.apcb007 <= 0 THEN CONTINUE FOREACH END IF   #200916-00030#1 mark
      #200916-00030#1-(S) add
      #檢查來源倉退單是否計價數量允許負數
      LET l_minus_chk = FALSE
      EXECUTE s_aapp131_pmdt024_prep USING l_tmp.pmdtdocno,l_tmp.pmdtseq INTO l_pmdt024,l_pmds054
      #考慮倉退單(4:採購折扣合約結算)且倉退數量為負數      
      IF l_pmds054 = '4' AND l_pmdt024 < 0 THEN      
         IF l_apcb.apcb007 <> 0 THEN  #有數量可以立暫估
            LET l_minus_chk = TRUE
         END IF
      END IF            
      IF NOT l_minus_chk THEN
         IF l_apcb.apcb007 <= 0 THEN CONTINUE FOREACH END IF
      END IF
      #200916-00030#1-(E) add      
      #190325-00047#1---s---add---
      #扣除已对账数量
      LET l_b_date = s_date_get_first_date(l_apca.apcadocdt) 

      LET l_apba010=0
      SELECT NVL(SUM (apba010),0) INTO l_apba010
        FROM apba_t,apbb_t   
       WHERE apbaent = apbbent  
         AND apbadocno = apbbdocno 
         AND apba005 = l_tmp.pmdtdocno    
         AND apba006 = l_tmp.pmdtseq    
         AND apbaent = g_enterprise      
         AND apbbdocdt BETWEEN l_b_date AND l_apca.apcadocdt
#         #201104-00003#1 add(s)
#         #扣除已对账未立账数量
#         AND NOT EXISTS (SELECT 1 FROM apca_t,apcb_t
#                          WHERE apcaent = apcbent
#                            AND apcbent = apbaent
#                            AND apcald = apcbld
#                            AND apcadocno = apcbdocno
#                            AND apcastus <> 'X'
#                            AND apcb002 = apba005
#                            AND apcb003 = apba006
#                            AND apcb049 = apbadocno)
#         #201104-00003#1 add(e)
         
      #LET l_apcb.apcb007=l_apcb.apcb007-l_apba010    #200911-00018#1 mark
      #200911-00018#1-(S) add      
      #取得對帳單已拋轉立帳單數量
      LET l_apcb007_sum = 0
      SELECT COALESCE(SUM(apcb007),0) INTO l_apcb007_sum
        FROM apcb_t
       WHERE apcbent = g_enterprise 
        AND apcb002 = l_tmp.pmdtdocno AND apcb003 = l_tmp.pmdtseq
        AND EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apcbent AND apcald = apcbld 
                      AND apcadocno = apcbdocno AND apcastus <> 'X' AND apca016 ='12'
                      AND apcadocdt BETWEEN l_b_date AND l_apca.apcadocdt)
      #DISPLAY '  l_apcb007_sum=',l_apcb007_sum    
      LET l_apcb.apcb007=l_apcb.apcb007-l_apba010 + l_apcb007_sum  #加回有對帳且又立帳數量
      #200911-00018#1-(E) add      

      #190325-00047#1---e---add---        
      LET l_apcb.apcb008 = l_pmdt001  #採購單號
      LET l_apcb.apcb009 = l_pmdt002 　#採購項次　#170510-00041#1
      CALL l_ar.clear()
      CALL s_aapp131_get_apcb010(l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003) RETURNING l_ar
      LET l_apcb.apcb010 = l_ar[1].chr
      IF cl_null(l_apcb.apcb010) THEN LET l_apcb.apcb010 = l_apca.apca015 END IF #180730-00034#1 add 來源單未取到資訊時,以單頭帶入
      LET l_apcb.apcb011 = l_ar[2].chr
      #200805-00007#1 add -s
      #入库和仓退时，费用料件理由码和部门取值
      IF l_apcb.apcb001 = '11' OR l_apcb.apcb001 = '21' THEN
         LET l_apcb010 = NULL
         CALL s_aapp320_get_apba021(l_apcb.apcb002,l_apcb.apcb003,l_apcb.apcb004) RETURNING l_apcb.apcb014,l_apcb010
         IF NOT cl_null(l_apcb010) THEN
            LET l_apcb.apcb010 = l_apcb010
         END IF
      END IF
      #200805-00007#1 add -e
      
      #161114-00009#1 --s add
      LET l_apcb.apcb012 = ''
      EXECUTE s_aapp131_imaa009 USING l_apcb.apcb004 INTO l_apcb.apcb012    
      #161114-00009#1 --e add
      
      #190812-00010#5 add s---#销售分群aimm214
      IF NOT cl_null(l_apcb.apcb004) THEN 
         LET l_imaf141 = NULL
         EXECUTE s_aapp131_imaf141_prep USING l_apcb.apcb004,l_apcb.apcbld INTO l_imaf141
      END IF            
      #190812-00010#5 add e---
      
      #161114-00009#1 --s mark
      #SELECT imaa009 INTO l_apcb.apcb012
      #  FROM imaa_t
      # WHERE imaaent = g_enterprise
      #   AND imaa001 = l_apcb.apcb004      
      #161114-00009#1 --e mark      
      
      LET l_apcb.apcb013 = 'N'
      LET l_apcb.apcb015 = l_pmdt072        #專案編號
      IF cl_null(l_apcb.apcb015) THEN LET l_apcb.apcb015 = l_apca.apca033 END IF
      LET l_apcb.apcb016 = l_pmdt073        #WBS
      LET l_apcb.apcb017 = l_apca.apca059   #預算編號
      
      #191226-00040#3---add---(S)
      CALL s_tax_chk(l_pmdtsite,l_apca.apca011) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
      #IF l_oodb011 = '2' THEN #191226-00040#7 mark
      IF l_oodb011 = '2' AND l_sfin3012 = '2' THEN #191226-00040#7 add
         LET l_apcb.apcb020 = l_pmdt046        #稅別
      ELSE
      #191226-00040#3---add---(E)
         LET l_apcb.apcb020 = l_apca.apca011   #稅別
      END IF #191226-00040#3 add
      #150310 sam:客户有委外入库的科目是没办法按成本分群抓;因此先按aapi011中抓，抓不到再根据成本分群
      #150313-00003#2 agli161 已增加委外入庫科目
      LET l_acctype = 1
      
      IF l_pmds000 MATCHES '1[12345]' OR l_pmds000 = '20' THEN   #抓加工科目   #150629-00038#1 add 17181920
         #LET l_acctype = 16      #16類為glcc001 = 1/抓glcc005   #190103-00077#1 mark
         #190103-00077#1-(S) add
         IF l_pmdt005 = '8' THEN    #委外代買
            LET l_acctype = 1       #1類為glcc001 = 1/抓glcc002
         ELSE         
            LET l_acctype = 16      #16類為glcc001 = 1/抓glcc005
         END IF
         #190103-00077#1-(E) add
      END IF
      IF cl_null(l_pmds013) THEN LET l_pmds013 = l_apca.apca058 END IF      #160120-00011#2
      #161104-00049#6 add ------
      #單身存貨科目取得規則：
      #1.若料件類別=E:費用/軟體，入庫單有理由碼(ACC:312)，則用入庫單理由碼+業務部門去agli180取
      #2.若1.取不到，擇用帳款類別+帳套去aapi011取存貨科目(SCC:8504)
      #3.若2.也取不到，則放單頭存貨科目
#      IF l_pmds100 <> '4' THEN   #190220-00035#1 add   #190731-00005#1 mark
      IF l_pmds100 <> '4' OR (l_pmds100 = '4' AND l_pmds000 = '14' ) THEN   #190731-00005#1 add
   #      IF l_apcb.apcb001 MATCHES '[12]1' THEN   #181203-00041#1---mark
         IF l_apcb.apcb001 MATCHES '[12]1' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN   #181203-00041#1---add         
            #抓取入庫單的理由碼
            SELECT pmdt051 INTO l_pmdt051
              FROM pmdt_t
             WHERE pmdtent = g_enterprise
               AND pmdtdocno = l_apcb.apcb002
               AND pmdtseq = l_apcb.apcb003
               AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                  AND imaa001 = pmdt006 and imaa004 ='E')
            
            IF NOT cl_null(l_pmdt051) THEN
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) ) THEN
               #190305-00001#2   add-E
                  #180910-00069#1 add begin---
                  IF cl_null(l_apca.apca015) AND not cl_null(l_apcb.apcb010) THEN
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apcb.apcb010,'312',l_pmdt051,
                                                              l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  ELSE 
                  #180910-00069#1 add end------
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'312',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  END IF  #180910-00069#1 add
               END IF   #190305-00001#2 add
            END IF
            
            #191010-00012#1---add---str
            #理由码抓取顺序是入库单/仓退单 > 收货单 >采购单 >请购单
            IF cl_null(l_pmdt051) THEN #理由码为空找上一个单据
               LET l_pmds006 = ''
               SELECT DISTINCT pmds006 INTO l_pmds006
                 FROM pmdt_t,pmds_t
                WHERE pmdtent = pmdsent
                  AND pmdtdocno = pmdsdocno
                  AND pmdtent = g_enterprise
                  AND pmdtdocno = l_apcb.apcb002
                  AND pmdtseq = l_apcb.apcb003
                  AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                     AND imaa001 = pmdt006 and imaa004 ='E')
               IF NOT cl_null(l_pmds006) THEN  #不为空说明他有收货单，在去找收货单的理由吗
                  #抓取收货單的理由碼
                  SELECT pmdt051 INTO l_pmdt051
                    FROM pmdt_t
                   WHERE pmdtent = g_enterprise
                     AND pmdtdocno = l_pmds006
                     AND pmdtseq = l_apcb.apcb003
                     AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdt006 and imaa004 ='E')   
               END IF
               IF cl_null(l_pmdt051) THEN #如果上面的IF还是空需要去找采购单的理由码
                   LET l_pmdt001 = ''
                   LET l_pmdt002 = ''
                   SELECT pmdt001,pmdt002 INTO l_pmdt001,l_pmdt002
                     FROM pmdt_t
                    WHERE pmdtent = g_enterprise
                      AND pmdtdocno = l_apcb.apcb002
                      AND pmdtseq = l_apcb.apcb003
                      AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdt006 AND imaa004 ='E')
                  SELECT pmdn049 INTO l_pmdt051
                    FROM pmdn_t
                   WHERE pmdnent = g_enterprise
                     AND pmdnseq = l_pmdt002
                     AND pmdndocno = l_pmdt001
                     AND pmdn001 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdn001 AND imaa004 ='E')   
                  IF cl_null(l_pmdt051) THEN #如果上面的IF还是空需要去找请购单的理由码
                     SELECT pmdl008 INTO l_pmdl008
                       FROM pmdl_t
                      WHERE pmdlent = g_enterprise
                        AND pmdldocno = l_pmdt001
                     IF NOT cl_null(l_pmdl008) THEN
                        SELECT pmdb031 INTO l_pmdt051
                          FROM pmdb_t
                         WHERE pmdbent = g_enterprise
                           AND pmdbdocno =  l_pmdl008
                           AND pmdbseq =  l_pmdt002 
                           AND pmdb004 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdb004 AND imaa004 ='E')                              
                     END IF
                     IF NOT cl_null(l_pmdt051) THEN
                        #190305-00001#2   add-S
                        IF l_apcb.apcb001 = '21' THEN
                           LET l_type = ''
                           IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                           IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                           CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                              RETURNING g_sub_success,l_apcb.apcb021
                        END IF
                        IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) ) THEN
                        #190305-00001#2   add-E
                           #请购单理由码
                           CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'265',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                           RETURNING g_sub_success,l_apcb.apcb021,g_errno
                        END IF   #190305-00001#2 add
                     END IF
                  ELSE
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) ) THEN
                     #190305-00001#2   add-E
                     #采购单理由码
                        CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'265',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                        RETURNING g_sub_success,l_apcb.apcb021,g_errno
                     END IF   #190305-00001#2 add
                  END IF
               ELSE
                  #190305-00001#2   add-S
                  IF l_apcb.apcb001 = '21' THEN
                     LET l_type = ''
                     IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                     IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                     CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                        RETURNING g_sub_success,l_apcb.apcb021
                  END IF
                  IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) ) THEN
                  #190305-00001#2   add-E
                     #收货单有理由码
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'269',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  END IF   #190305-00001#2 add
               END IF                 
            END IF
            #191010-00012#1---add---end
            
         END IF
      #190220-00035#1---add---str--
      #4:倉退折讓(純金額折讓),單身科目先抓agli161抓不到在直接取aapi011的"折讓科目"(因為會影響成本)
      ELSE
         #190812-00010#5 add s---#销售分群aimm214
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         #190812-00010#5 add e---           
         #190305-00001#2   add-S
         IF l_apcb.apcb001 = '21' THEN
            LET l_type = ''
            IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
            IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
            CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
         #190305-00001#2   add-E
            #190806-00046#1 add(s)
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF   #190305-00001#2 add
         IF cl_null(l_apcb.apcb021) THEN
         #190806-00046#1 add(e)
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
         END IF #190806-00046#1 add
      END IF  
      #190220-00035#1---add---end--
      
      #190813-00006#1---add----str
      #仓退单对应账款单单身科目抓取，单头科目维持原逻辑（单头科目从aapi011抓取）
      #纯金额折让  依apmt580单身料号性质判断是取agli161还是aapi011
      #料号性质=A或M   先取agli161，取不到再取aapi011折让科目（此时折让需纳入成本计算，折让科目维护的就是存货科目）
      #        ELSE 直接取aapi011折让科目（此时折让不需纳入成本计算，折让科目一般维护的就是费用科目）
      #非纯金额折让   先取agli161，取不到再取aapi011仓退科目（不看料号性质）（此种仓退需纳入成本计算，仓退科目维护的就是存货科目）
         
      IF l_pmds000 = '7' OR l_pmds000 = '14' OR l_pmds000 = '15' THEN
         LET l_apcb.apcb021 = ''
         IF l_pmds100 = '4' THEN # 纯金额折让
            LET l_cnt = 0
            #判断料件类别是否是A或M
            SELECT COUNT(*) INTO l_cnt
                 FROM pmdt_t
                WHERE pmdtent = g_enterprise
                  AND pmdtdocno = l_apcb.apcb002
                  AND pmdtseq = l_apcb.apcb003
                  AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別
                                     AND imaa001 = pmdt006 and (imaa004 ='A' OR imaa004 ='M'))
            IF cl_null(l_cnt) THEN
               LET l_cnt = 0
            END IF
            IF l_cnt > 0 THEN
                #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                
                  FOREACH s_aapp131_pmdu006_c1 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF
               #190815-00012#1---add---end
               #190812-00010#5 add s---#销售分群aimm214
               IF NOT cl_null(l_apcb.apcb004) THEN 
                  IF NOT cl_null(l_imaf141) THEN
                     LET l_kind = l_pmds013,"@",l_imaf141
                  ELSE 
                     LET l_kind = l_pmds013            
                  END IF  
               END IF            
               #190812-00010#5 add e---                  
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
                  #大于0说明料件类别 = A:组合/加工品 或 M:材料/零件/商品
                  CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                        RETURNING g_sub_success,l_apcb.apcb021
               END IF   #190305-00001#2 add
               IF cl_null(l_apcb.apcb021) THEN
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF 
            ELSE
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF   #190305-00001#2 add
            END IF
         ELSE    # 非纯金额折让
             
             #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                 
                  FOREACH s_aapp131_pmdu006_c1 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF
               #190815-00012#1---add---end
             #190812-00010#5 add s---#销售分群aimm214
             IF NOT cl_null(l_apcb.apcb004) THEN 
                IF NOT cl_null(l_imaf141) THEN
                   LET l_kind = l_pmds013,"@",l_imaf141
                ELSE 
                   LET l_kind = l_pmds013            
                END IF  
             END IF            
             #190812-00010#5 add e---                  
             #190305-00001#2   add-S
             IF l_apcb.apcb001 = '21' THEN
                LET l_type = ''
                IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                   RETURNING g_sub_success,l_apcb.apcb021
             END IF
             IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
             #190305-00001#2   add-E
                CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                        RETURNING g_sub_success,l_apcb.apcb021
             END IF   #190305-00001#2 add
               IF cl_null(l_apcb.apcb021) THEN
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_24') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF 
         END IF
      END IF
      #190813-00006#1---add----str
      #210204-00021#1---add----str
      #委外仓退也取agli161的加工费科目抓不到在直接取aapi011的"折讓科目"
      IF l_pmds100 = '4' AND l_pmds000 = '14' THEN
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         
         IF l_apcb.apcb001 = '21' THEN
            #委外加工费科目               
            CALL s_get_item_acc(l_apcb.apcbld,'16',l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) 
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF  
         IF cl_null(l_apcb.apcb021) THEN
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
         END IF 
      END IF
      #210204-00021#1---add----end
      IF cl_null(l_apcb.apcb021) THEN
      #161104-00049#6 add end---
     #CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,'','','','')    #160120-00011#2 mark
         #190815-00012#1---add---str
          #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
          IF l_pmdt062 = 'Y' THEN
            
             FOREACH s_aapp131_pmdu006_c1 INTO l_pmdu006
                LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                #190305-00001#2   add-S
                IF l_apcb.apcb001 = '21' THEN
                   LET l_type = ''
                   IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                   IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                   CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                      RETURNING g_sub_success,l_apcb.apcb021
                END IF
                IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                #190305-00001#2   add-E
                   CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                   RETURNING g_sub_success,l_apcb.apcb021  
                END IF   #190305-00001#2 add
                IF NOT cl_null(l_apcb.apcb021) THEN  
                   #如果apcb021有数据说明这个库位有对应得存货科目  
                   LET l_pmdt016 =  l_pmdu006
                   EXIT FOREACH                        
                END IF
             END FOREACH
          END IF
          #190815-00012#1---add---end
         #190812-00010#5 add s---#销售分群aimm214
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         #190812-00010#5 add e---             
         #190305-00001#2   add-S
         IF l_apcb.apcb001 = '21' THEN
            LET l_type = ''
            IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
            IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
            CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
         #190305-00001#2   add-E
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)   #160120-00011#2 #190812-00010#5 mod l_pmds013-->l_kind
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF   #190305-00001#2 add        
         #170526-00019#1--add--str--lujh
         SELECT imaa004 INTO l_imaa004
           FROM imaa_t
          WHERE imaaent = g_enterprise
            AND imaa001 = l_apcb.apcb004
         IF l_imaa004 = 'E' THEN 
            SELECT imag011 INTO l_imag011
              FROM imag_t
             WHERE imagent = g_enterprise
               AND imagsite = l_apca.apcacomp
               #AND imag011 = l_apcb.apcb004   #170822-00003#1 mark
               AND imag001 = l_apcb.apcb004    #170822-00003#1 add
            IF cl_null(l_imag011) THEN
               LET l_apcb.apcb021 = ''
            END IF
         END IF
         #170526-00019#1--add--end--lujh
      END IF #161104-00049#6
      IF cl_null(l_apcb.apcb021) THEN
         LET l_apcb.apcb021 = l_apca.apca036
      END IF  
      #200805-00007#1 add -s
      #费用料件理由码不为空时优先根据理由码取科目
      IF (l_apcb.apcb001 = '11' OR l_apcb.apcb001 = '21') AND NOT cl_null(l_apcb.apcb014) AND NOT cl_null(l_apcb010) THEN
         LET l_apcb021 = NULL
         CALL s_fin_dept_reasons_with_ld_get_account(l_apcb010,'3212',l_apcb.apcb014,l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb021,g_errno
         IF NOT cl_null(l_apcb021) THEN
            LET l_apcb.apcb021 = l_apcb021
         END IF
      END IF
      #200805-00007#1 add -e      
      LET l_apcb.apcb023 = 'N'
      LET l_apcb.apcb029 = l_apca.apca035
      IF p_sfin2002 MATCHES '[12]' THEN
         LET l_apcb.apcb030 = l_apca.apca008
      ELSE
         LET l_apcb.apcb030  = l_tmp.pmds031
      END IF
      LET l_apcb.apcb034 = l_pmds012            #160120-00011#2
      LET l_apcb.apcb051 = l_ar[3].chr
      IF cl_null(l_apcb.apcb051) THEN LET l_apcb.apcb051 = l_apca.apca014 END IF #180730-00034#1 add 來源單未取到資訊時,以單頭帶入
      LET l_apcb.apcb054 = l_apca.apca004       #帳款對象     #180621-00023#1 add
      LET l_apcb.apcb055 = l_apca.apca005       #付款對象     #180621-00023#1 add
      LET l_apcb.apcb100 = l_apca.apca100       #幣別
      LET l_apcb.apcb101 = l_pmdt036            #原幣單價
      #150615--(s)
      CALL s_tax_chk(l_pmdtsite,l_pmdt046) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
      IF l_sfin3012 = '1' THEN   #立帳不含稅
         #若來源單單價含稅則需要換算為不含稅的單價
         IF l_oodb005 = 'Y' THEN  
            LET l_apcb.apcb101 = l_apcb.apcb101 / (1 + l_pmdt037/100)
         END IF
      END IF      
      #150615--(e)
     #CALL s_curr_round_ld('1',p_ld,l_apcb.apcb100,l_apcb.apcb101,1) RETURNING g_sub_success,g_errno,l_apcb.apcb101 #140806-00012#12  #170430-00006#2 mark
      CALL s_num_round(g_round_type,l_apcb.apcb101,g_ooaj003) RETURNING l_apcb.apcb101  #170430-00006#2 add
      LET l_apcb.apcb102  = l_apca.apca101                   #本幣匯率
      LET l_apcb.apcb111  = l_apcb.apcb101 * l_apca.apca101  #本幣單價
     #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcb.apcb111,1) RETURNING g_sub_success,g_errno,l_apcb.apcb111      #140806-00012#12 #170430-00006#2 mark
      #CALL s_num_round(g_round_type,l_apcb.apcb111,g_ooaj003) RETURNING l_apcb.apcb111   #170430-00006#2 add  #190110-00037#1 mark
      CALL s_num_round(g_round_type,l_apcb.apcb111,g_ooaj003_g) RETURNING l_apcb.apcb111  #190110-00037#1 add      
      LET l_apcb105 = l_apcb.apcb007 * l_apcb.apcb101
      #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcb105,2) RETURNING g_sub_success,g_errno,l_apcb105                #140806-00012#12   #170320-00033#1 mark
     #CALL s_curr_round_ld('1',p_ld,l_apcb.apcb100,l_apcb105,2) RETURNING g_sub_success,g_errno,l_apcb105     #170320-00033#1    #170430-00006#2 mark 
      CALL s_num_round(g_round_type,l_apcb.apcb105,g_ooaj004) RETURNING l_apcb.apcb105  #170430-00006#2 add
      
     #CALL s_tax_ins(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,   #160519-00011#1 mark
      CALL s_tax_ins2(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,  #160519-00011#1 
                     l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apca.apca101,p_ld,l_apca.apca121,l_apca.apca131)
           RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                     l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                     l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                     l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      #全部數量立帳者,取得來源入庫單原幣金額立帳141204-00017#1-str--
      IF l_flag  AND l_ld_type = '1' THEN
         CALL s_aapp131_entire_amount('1',l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb002,
                                       l_apcb.apcb003,l_apcb.apcb049,l_apcb.apcb050,l_apcb.apcb103,l_apcb.apcb104,
                                       l_apcb.apcb105,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,l_apca.apca101) 
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115   
         #150925--s
         #取得全額之後,要再以全額重推本幣
         #含稅傳入含稅金額,未稅傳入未稅金額
         IF l_apca.apca013 = 'Y' THEN
            LET l_apcb105 = l_apcb.apcb105
         ELSE
            LET l_apcb105 = l_apcb.apcb103
         END IF
        #CALL s_tax_ins(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,   #160519-00011#1 mark
         CALL s_tax_ins2(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,  #160519-00011#1 
                        l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apca.apca101,p_ld,l_apca.apca121,l_apca.apca131)
              RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                        l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                        l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                        l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
         #150925--e             
      END IF       
      #141204-00017#1-end--
      
      LET l_apcb.apcb107 = 0  LET l_apcb.apcb108 = l_apcb.apcb103  
      LET l_apcb.apcb107 = l_pmdt036                                  #160816-00022#4 apcb107存入庫單單價
      LET l_apcb.apcb117 = 0  LET l_apcb.apcb118 = l_apcb.apcb113  LET l_apcb.apcb119 = 0
      LET l_apcb.apcb127 = 0  LET l_apcb.apcb128 = l_apcb.apcb123
      LET l_apcb.apcb137 = 0  LET l_apcb.apcb138 = l_apcb.apcb133      
     
     #CALL s_aapp131_get_apcb1x6(l_apcb.*) RETURNING l_apcb.apcb106,l_apcb.apcb116,l_apcb.apcb126,l_apcb.apcb136  #160120-00011#2 #170430-00006#2 mark
      CALL s_aapp131_get_apcb1x6(l_apcb.*,g_round_type,g_ooaj004,g_ooaj004_g,g_ooaj004_g2,g_ooaj004_g3)    #170430-00006#2 add
       RETURNING l_apcb.apcb106,l_apcb.apcb116,l_apcb.apcb126,l_apcb.apcb136                               #170430-00006#2 add
     #INSERT INTO apcb_t VALUES(l_apcb.*) #161111-00048#2 mark

      #180705-00083#1 add -s
      #业务人员，业务部门
      IF cl_null(l_apcb.apcb051) THEN
         LET l_apcb.apcb051 = l_apca.apca014
      END IF
      IF cl_null(l_apcb.apcb010) THEN
         LET l_apcb.apcb010 = l_apca.apca015
      END IF
      #固定核算项默认值
      INITIALIZE l_apcb2.* TO NULL
      LET l_apcb2.apcb054 = l_apcb.apcb054
      LET l_apcb2.apcb055 = l_apcb.apcb055
      LET l_apcb2.apcb051 = l_apcb.apcb051
      LET l_apcb2.apcb010 = l_apcb.apcb010
      LET l_apcb2.apcb011 = l_apcb.apcb011
      LET l_apcb2.apcb024 = l_apcb.apcb024
      LET l_apcb2.apcb036 = l_apcb.apcb036
      LET l_apcb2.apcb012 = l_apcb.apcb012
      LET l_apcb2.apcb033 = l_apcb.apcb033
      LET l_apcb2.apcb034 = l_apcb.apcb034
      LET l_apcb2.apcb035 = l_apcb.apcb035
      LET l_apcb2.apcb015 = l_apcb.apcb015
      LET l_apcb2.apcb016 = l_apcb.apcb016
      CALL s_aapp131_get_accitem(l_apcb.apcbld,l_apcb.apcb021,l_apcb.apcb029,p_xrcd009,l_apcb2.*)
         RETURNING l_apcb.apcb054,l_apcb.apcb055,l_apcb.apcb051,l_apcb.apcb010,l_apcb.apcb011,
                   l_apcb.apcb024,l_apcb.apcb036,l_apcb.apcb012,l_apcb.apcb033,l_apcb.apcb034,
                   l_apcb.apcb035,l_apcb.apcb015,l_apcb.apcb016
      #180705-00083#1 add -e
      #161102-00015#7 --s add
      IF cl_null(l_apcb.apcb010) THEN LET l_apcb.apcb010 = " " END IF  #業務部門
      IF cl_null(l_apcb.apcb011) THEN LET l_apcb.apcb011 = " " END IF  #責任中心
      IF cl_null(l_apcb.apcb012) THEN LET l_apcb.apcb012 = " " END IF  #產品類別
      IF cl_null(l_apcb.apcb015) THEN LET l_apcb.apcb015 = " " END IF  #專案編號
      IF cl_null(l_apcb.apcb016) THEN LET l_apcb.apcb016 = " " END IF  #WBS編號
      IF cl_null(l_apcb.apcb024) THEN LET l_apcb.apcb024 = " " END IF  #區域
      IF cl_null(l_apcb.apcb030) THEN LET l_apcb.apcb030 = " " END IF  #付款條件
      IF cl_null(l_apcb.apcb033) THEN LET l_apcb.apcb033 = " " END IF  #經營方式
      IF cl_null(l_apcb.apcb034) THEN LET l_apcb.apcb034 = " " END IF  #通路
      IF cl_null(l_apcb.apcb035) THEN LET l_apcb.apcb035 = " " END IF  #品牌
      IF cl_null(l_apcb.apcb036) THEN LET l_apcb.apcb036 = " " END IF  #客群
      IF cl_null(l_apcb.apcb037) THEN LET l_apcb.apcb037 = " " END IF  #自由核算項一
      IF cl_null(l_apcb.apcb038) THEN LET l_apcb.apcb038 = " " END IF  #自由核算項二
      IF cl_null(l_apcb.apcb039) THEN LET l_apcb.apcb039 = " " END IF  #自由核算項三
      IF cl_null(l_apcb.apcb040) THEN LET l_apcb.apcb040 = " " END IF  #自由核算項四
      IF cl_null(l_apcb.apcb041) THEN LET l_apcb.apcb041 = " " END IF  #自由核算項五
      IF cl_null(l_apcb.apcb042) THEN LET l_apcb.apcb042 = " " END IF  #自由核算項六
      IF cl_null(l_apcb.apcb043) THEN LET l_apcb.apcb043 = " " END IF  #自由核算項七
      IF cl_null(l_apcb.apcb044) THEN LET l_apcb.apcb044 = " " END IF  #自由核算項八
      IF cl_null(l_apcb.apcb045) THEN LET l_apcb.apcb045 = " " END IF  #自由核算項九
      IF cl_null(l_apcb.apcb046) THEN LET l_apcb.apcb046 = " " END IF  #自由核算項十
      IF cl_null(l_apcb.apcb051) THEN LET l_apcb.apcb051 = " " END IF  #業務人員
      IF cl_null(l_apcb.apcb054) THEN LET l_apcb.apcb054 = " " END IF  #帳款對象
      IF cl_null(l_apcb.apcb055) THEN LET l_apcb.apcb055 = " " END IF  #付款對象
      #161102-00015#7 --e add
     
     #170510-00041#1---s--- 取得科目所對應的預算係項
      LET l_apcb.apcb017 = ''      
      SELECT bgao004 INTO l_apcb.apcb017  FROM bgao_t
       WHERE bgaoent = g_enterprise
         AND  bgao001 = (SELECT DISTINCT bgaa008 FROM bgaa_t WHERE bgaaent = g_enterprise AND bgaa001 = l_apca.apca059 )       
         AND bgao002 = (SELECT glaa004 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = l_apcb.apcbld)
         AND bgao003 =l_apcb.apcb021              
      #170510-00041#1---e---  
     #170430-00006#2---mark---start---      
     ##161111-00048#2 --s add
     #INSERT INTO apcb_t(apcbent,apcbld,apcblegl,apcborga,apcbsite,
     #                   apcbdocno,apcbseq,apcb001,apcb002,apcb003,
     #                   apcb004,apcb005,apcb006,apcb007,apcb008,
     #                   apcb009,apcb010,apcb011,apcb012,apcb013,
     #                   apcb014,apcb015,apcb016,apcb017,apcb018,
     #                   apcb019,apcb020,apcb021,apcb022,apcb023,
     #                   apcb024,apcb025,apcb026,apcb027,apcb028,
     #                   apcb029,apcb030,apcb032,apcb033,apcb034,
     #                   apcb035,apcb036,apcb037,apcb038,apcb039,
     #                   apcb040,apcb041,apcb042,apcb043,apcb044,
     #                   apcb045,apcb046,apcb047,apcb048,apcb049,
     #                   apcb050,apcb051,apcb100,apcb101,apcb102,
     #                   apcb103,apcb104,apcb105,apcb106,apcb107,
     #                   apcb108,apcb111,apcb113,apcb114,apcb115,
     #                   apcb116,apcb117,apcb118,apcb119,apcb121,
     #                   apcb123,apcb124,apcb125,apcb126,apcb127,
     #                   apcb128,apcb131,apcb133,apcb134,apcb135,
     #                   apcb136,apcb137,apcb138,apcbud001,apcbud002,
     #                   apcbud003,apcbud004,apcbud005,apcbud006,apcbud007,
     #                   apcbud008,apcbud009,apcbud010,apcbud011,apcbud012,
     #                   apcbud013,apcbud014,apcbud015,apcbud016,apcbud017,
     #                   apcbud018,apcbud019,apcbud020,apcbud021,apcbud022,
     #                   apcbud023,apcbud024,apcbud025,apcbud026,apcbud027,
     #                   apcbud028,apcbud029,apcbud030,apcb052,apcb053,
     #                   apcb054,apcb055)
     #VALUES(l_apcb.apcbent,l_apcb.apcbld,l_apcb.apcblegl,l_apcb.apcborga,l_apcb.apcbsite,
     #       l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003,
     #       l_apcb.apcb004,l_apcb.apcb005,l_apcb.apcb006,l_apcb.apcb007,l_apcb.apcb008,
     #       l_apcb.apcb009,l_apcb.apcb010,l_apcb.apcb011,l_apcb.apcb012,l_apcb.apcb013,
     #       l_apcb.apcb014,l_apcb.apcb015,l_apcb.apcb016,l_apcb.apcb017,l_apcb.apcb018,
     #       l_apcb.apcb019,l_apcb.apcb020,l_apcb.apcb021,l_apcb.apcb022,l_apcb.apcb023,
     #       l_apcb.apcb024,l_apcb.apcb025,l_apcb.apcb026,l_apcb.apcb027,l_apcb.apcb028,
     #       l_apcb.apcb029,l_apcb.apcb030,l_apcb.apcb032,l_apcb.apcb033,l_apcb.apcb034,
     #       l_apcb.apcb035,l_apcb.apcb036,l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,
     #       l_apcb.apcb040,l_apcb.apcb041,l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,
     #       l_apcb.apcb045,l_apcb.apcb046,l_apcb.apcb047,l_apcb.apcb048,l_apcb.apcb049,
     #       l_apcb.apcb050,l_apcb.apcb051,l_apcb.apcb100,l_apcb.apcb101,l_apcb.apcb102,
     #       l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb106,l_apcb.apcb107,
     #       l_apcb.apcb108,l_apcb.apcb111,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
     #       l_apcb.apcb116,l_apcb.apcb117,l_apcb.apcb118,l_apcb.apcb119,l_apcb.apcb121,
     #       l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,l_apcb.apcb126,l_apcb.apcb127,
     #       l_apcb.apcb128,l_apcb.apcb131,l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135,
     #       l_apcb.apcb136,l_apcb.apcb137,l_apcb.apcb138,l_apcb.apcbud001,l_apcb.apcbud002,
     #       l_apcb.apcbud003,l_apcb.apcbud004,l_apcb.apcbud005,l_apcb.apcbud006,l_apcb.apcbud007,
     #       l_apcb.apcbud008,l_apcb.apcbud009,l_apcb.apcbud010,l_apcb.apcbud011,l_apcb.apcbud012,
     #       l_apcb.apcbud013,l_apcb.apcbud014,l_apcb.apcbud015,l_apcb.apcbud016,l_apcb.apcbud017,
     #       l_apcb.apcbud018,l_apcb.apcbud019,l_apcb.apcbud020,l_apcb.apcbud021,l_apcb.apcbud022,
     #       l_apcb.apcbud023,l_apcb.apcbud024,l_apcb.apcbud025,l_apcb.apcbud026,l_apcb.apcbud027,
     #       l_apcb.apcbud028,l_apcb.apcbud029,l_apcb.apcbud030,l_apcb.apcb052,l_apcb.apcb053,
     #       l_apcb.apcb054,l_apcb.apcb055
     #170430-00006#2---mark---end---
      #170430-00006#2---add---start---
      
      #180705-00083#1 mark -s
#      #180704-00022#1 add ---s 根據agli043設定預帶自由核算項值     
#      CALL l_array.clear()
#      LET l_array[1].chr = l_apcb.apcb037
#      LET l_array[2].chr = l_apcb.apcb038   
#      LET l_array[3].chr = l_apcb.apcb039
#      LET l_array[4].chr = l_apcb.apcb040
#      LET l_array[5].chr = l_apcb.apcb041
#      LET l_array[6].chr = l_apcb.apcb042
#      LET l_array[7].chr = l_apcb.apcb043
#      LET l_array[8].chr = l_apcb.apcb044
#      LET l_array[9].chr = l_apcb.apcb045
#      LET l_array[10].chr = l_apcb.apcb046      
#      CALL s_aapp131_upd_accitem_free(g_prog1,l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb021,l_apcb.apcb029,l_array)
#      RETURNING l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,l_apcb.apcb040,l_apcb.apcb041,
#                l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,l_apcb.apcb045,l_apcb.apcb046      
#      #180704-00022#1 add ---e
      #180705-00083#1 mark -e
      
      EXECUTE s_aapp131_ins_apcb_c USING
             l_apcb.apcbent,l_apcb.apcbld,l_apcb.apcblegl,l_apcb.apcborga,l_apcb.apcbsite,     
             l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003,
             l_apcb.apcb004,l_apcb.apcb005,l_apcb.apcb006,l_apcb.apcb007,l_apcb.apcb008,
             l_apcb.apcb009,l_apcb.apcb010,l_apcb.apcb011,l_apcb.apcb012,l_apcb.apcb013,
             l_apcb.apcb014,l_apcb.apcb015,l_apcb.apcb016,l_apcb.apcb017,l_apcb.apcb018,
             l_apcb.apcb019,l_apcb.apcb020,l_apcb.apcb021,l_apcb.apcb022,l_apcb.apcb023,
             l_apcb.apcb024,l_apcb.apcb025,l_apcb.apcb026,l_apcb.apcb027,l_apcb.apcb028,
             l_apcb.apcb029,l_apcb.apcb030,l_apcb.apcb032,l_apcb.apcb033,l_apcb.apcb034,
             l_apcb.apcb035,l_apcb.apcb036,l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,
             l_apcb.apcb040,l_apcb.apcb041,l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,
             l_apcb.apcb045,l_apcb.apcb046,l_apcb.apcb047,l_apcb.apcb048,l_apcb.apcb049,
             l_apcb.apcb050,l_apcb.apcb051,l_apcb.apcb100,l_apcb.apcb101,l_apcb.apcb102,
             l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb106,l_apcb.apcb107,
             l_apcb.apcb108,l_apcb.apcb111,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
             l_apcb.apcb116,l_apcb.apcb117,l_apcb.apcb118,l_apcb.apcb119,l_apcb.apcb121,
             l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,l_apcb.apcb126,l_apcb.apcb127,
             l_apcb.apcb128,l_apcb.apcb131,l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135,
             l_apcb.apcb136,l_apcb.apcb137,l_apcb.apcb138,l_apcb.apcbud001,l_apcb.apcbud002,
             l_apcb.apcbud003,l_apcb.apcbud004,l_apcb.apcbud005,l_apcb.apcbud006,l_apcb.apcbud007,
             l_apcb.apcbud008,l_apcb.apcbud009,l_apcb.apcbud010,l_apcb.apcbud011,l_apcb.apcbud012,
             l_apcb.apcbud013,l_apcb.apcbud014,l_apcb.apcbud015,l_apcb.apcbud016,l_apcb.apcbud017,
             l_apcb.apcbud018,l_apcb.apcbud019,l_apcb.apcbud020,l_apcb.apcbud021,l_apcb.apcbud022,
             l_apcb.apcbud023,l_apcb.apcbud024,l_apcb.apcbud025,l_apcb.apcbud026,l_apcb.apcbud027,
             l_apcb.apcbud028,l_apcb.apcbud029,l_apcb.apcbud030,l_apcb.apcb052,l_apcb.apcb053,
             l_apcb.apcb054,l_apcb.apcb055
      #170430-00006#2---add---start---
      #161111-00048#2 --e add
      #180705-00083#1 add -s
      #自由核算项默认值
      INITIALIZE l_apcb3.* TO NULL
      LET l_apcb3.apcb037= l_apcb.apcb037
      LET l_apcb3.apcb038= l_apcb.apcb038
      LET l_apcb3.apcb039= l_apcb.apcb039
      LET l_apcb3.apcb040= l_apcb.apcb040
      LET l_apcb3.apcb041= l_apcb.apcb041
      LET l_apcb3.apcb042= l_apcb.apcb042
      LET l_apcb3.apcb043= l_apcb.apcb043
      LET l_apcb3.apcb044= l_apcb.apcb044
      LET l_apcb3.apcb045= l_apcb.apcb045
      LET l_apcb3.apcb046= l_apcb.apcb046
      CALL s_aapp131_get_accitem_free(g_prog1,l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb021,l_apcb.apcb029,p_xrcd009,l_apcb3.*)
      #180705-00083#1 add -e
      ##50703-00021#24   增加預算控管---s---
      #IF g_dfin5002 = 'Y' THEN #200928-00025#1 mark     
      IF g_dfin5002 MATCHES '[YC]' THEN #200928-00025#1 add
         #181030-00022#5 ---s---      
         ##170510-00041#1 ---s---#將來源預算轉出   
         #LET l_bgbd039 = 0
         #SELECT bgbd039 INTO l_bgbd039 FROM bgbd_t WHERE bgbdent = g_enterprise 
         #   AND bgbd037 = l_apcb.apcb008 AND bgbd038 = l_apcb.apcb009
         #IF cl_null(l_bgbd039) THEN LET l_bgbd039 = 0 END IF
         #UPDATE bgbd_t SET bgbd040 = bgbd039
         # WHERE bgbdent = g_enterprise
         #   AND bgbd037 = l_apcb.apcb008
         #   AND bgbd038 = l_apcb.apcb009    
         ##170510-00041#1 ---e---#
         #181030-00022#5 ---e---   

         #201127-00012#1 add ---s                  
         IF NOT cl_null(l_apcb.apcb002) AND NOT cl_null(l_apcb.apcb003) THEN 
            LET l_tran.docno     = l_apca.apcadocno
            LET l_tran.ld        = l_apca.apcald
            LET l_tran.docdt     = l_apca.apcadocdt
            LET l_tran.comp      = l_apca.apcacomp
            LET l_tran.seq       = l_apcb.apcbseq
            LET l_tran.bgbd007   = l_apcb.apcb017
            LET l_tran.bgbd037   = l_apcb.apcb002
            LET l_tran.bgbd038   = l_apcb.apcb003
            LET l_tran.bgbd040   = l_apcb.apcb113
            LET l_tran.bgbd007_t = '' #修改前的預算細項
            LET l_tran.bgbd037_t = '' #修改前的單號
            LET l_tran.bgbd038_t = '' #修改前的項次
            LET l_tran.bgbd040_t = 0  #修改前被占用的金額
            LET l_tran.act       = 'A'                     
            #預算轉移
            LET l_ls_js = util.JSON.stringify(l_tran)                  
            CALL s_abg_tran(l_ls_js) RETURNING g_sub_success,g_errno 
         END IF
         #201127-00012#1 add ---e 
         
         #檢核是否存在該科目預算
         #CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','1') #200928-00025#1 mark
         CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','4')  #200928-00025#1 add
             RETURNING g_sub_success,g_errno
         #200928-00025#1 mark ---s         
         #IF NOT g_sub_success THEN
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = g_errno
         #   LET g_errparam.extend = ''
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #  #LET r_success = FALSE #171225-00022#1 add
         #  #CONTINUE FOREACH      #171225-00022#1 add
         #END IF 
         #200928-00025#1 mark ---e
         IF g_sub_success THEN #200928-00025#1 add           
            #檢核金額是否超過
            CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','2')
                RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               LET g_errparam.replace[1] = l_apcb.apcb017
               #200928-00025#1 add ---e                   
               CALL cl_err()               
               LET r_success = FALSE #171225-00022#1 add #200928-00025#1 remark
               CONTINUE FOREACH      #171225-00022#1 add #200928-00025#1 remark            
            END IF        
                        
            #新增一筆bgbd_t               
            CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'I','3')
               RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = g_errno
               LET g_errparam.popup  = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               #200928-00025#1 add ---e                
               CALL cl_err()
               LET r_success = FALSE #171225-00022#1 add  #200928-00025#1 remark          
               CONTINUE FOREACH      #171225-00022#1 add  #200928-00025#1 remark
            END IF
         #200928-00025#1 add ---s
         ELSE
            IF g_dfin5002 = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003               
               CALL cl_err()
               LET r_success = FALSE
               CONTINUE FOREACH               
            END IF
         END IF
         #200928-00025#1 add ---e
      END IF          
      ##50703-00021#24   增加預算控管---e---
           
   END FOREACH
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 立帳單身(發票立帳)
# Memo...........:
# Date & Author..: 14/10/11 By Belle
# Modify.........: #180705-00083#1 add 税额科目 by 08172
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcb2(p_ld,p_docno,p_cond1,p_sfin2002,p_xrcd009)
DEFINE p_ld          LIKE apca_t.apcald         #帳套
DEFINE p_docno       LIKE apca_t.apcadocno      #單據編號
DEFINE p_cond1       LIKE type_t.chr500         #彙總條件值
DEFINE p_sfin2002    LIKE type_t.chr1
DEFINE p_xrcd009     LIKE xrcd_t.xrcd009        #税额科目  #180705-00083#1 add
DEFINE r_success     LIKE type_t.num5
DEFINE l_sql         STRING
#161111-00048#2 --s mark
#DEFINE l_apca        RECORD LIKE apca_t.*
#DEFINE l_apcb        RECORD LIKE apcb_t.*
#DEFINE l_apbb        RECORD LIKE apbb_t.*       #發票單頭
#DEFINE l_apba        RECORD LIKE apba_t.*       #發票單身
#161111-00048#2 --e mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE l_apcb RECORD  #應付憑單單身
       apcbent LIKE apcb_t.apcbent, #企業編號
       apcbld LIKE apcb_t.apcbld, #帳套
       apcblegl LIKE apcb_t.apcblegl, #核算組織
       apcborga LIKE apcb_t.apcborga, #帳務歸屬組織(來源組織)
       apcbsite LIKE apcb_t.apcbsite, #應付帳務組織
       apcbdocno LIKE apcb_t.apcbdocno, #單號
       apcbseq LIKE apcb_t.apcbseq, #項次
       apcb001 LIKE apcb_t.apcb001, #來源類型
       apcb002 LIKE apcb_t.apcb002, #來源業務單據號碼
       apcb003 LIKE apcb_t.apcb003, #來源業務單據項次
       apcb004 LIKE apcb_t.apcb004, #產品編號
       apcb005 LIKE apcb_t.apcb005, #品名規格
       apcb006 LIKE apcb_t.apcb006, #單位
       apcb007 LIKE apcb_t.apcb007, #計價數量
       apcb008 LIKE apcb_t.apcb008, #參考單據號碼
       apcb009 LIKE apcb_t.apcb009, #參考單據項次
       apcb010 LIKE apcb_t.apcb010, #業務部門
       apcb011 LIKE apcb_t.apcb011, #責任中心
       apcb012 LIKE apcb_t.apcb012, #產品類別
       apcb013 LIKE apcb_t.apcb013, #搭贈
       apcb014 LIKE apcb_t.apcb014, #理由碼
       apcb015 LIKE apcb_t.apcb015, #專案編號
       apcb016 LIKE apcb_t.apcb016, #WBS編號
       apcb017 LIKE apcb_t.apcb017, #預算細項
       apcb018 LIKE apcb_t.apcb018, #专柜编号
       apcb019 LIKE apcb_t.apcb019, #開票性質
       apcb020 LIKE apcb_t.apcb020, #稅別
       apcb021 LIKE apcb_t.apcb021, #費用會計科目
       apcb022 LIKE apcb_t.apcb022, #正負值
       apcb023 LIKE apcb_t.apcb023, #沖暫估單否
       apcb024 LIKE apcb_t.apcb024, #區域
       apcb025 LIKE apcb_t.apcb025, #傳票號碼
       apcb026 LIKE apcb_t.apcb026, #傳票項次
       apcb027 LIKE apcb_t.apcb027, #發票編號
       apcb028 LIKE apcb_t.apcb028, #發票號碼
       apcb029 LIKE apcb_t.apcb029, #應付帳款科目
       apcb030 LIKE apcb_t.apcb030, #付款條件
       apcb032 LIKE apcb_t.apcb032, #訂金序次
       apcb033 LIKE apcb_t.apcb033, #經營方式
       apcb034 LIKE apcb_t.apcb034, #通路
       apcb035 LIKE apcb_t.apcb035, #品牌
       apcb036 LIKE apcb_t.apcb036, #客群
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046, #自由核算項十
       apcb047 LIKE apcb_t.apcb047, #摘要
       apcb048 LIKE apcb_t.apcb048, #來源訂購單號
       apcb049 LIKE apcb_t.apcb049, #開票單號
       apcb050 LIKE apcb_t.apcb050, #開票項次
       apcb051 LIKE apcb_t.apcb051, #業務人員
       apcb100 LIKE apcb_t.apcb100, #交易原幣
       apcb101 LIKE apcb_t.apcb101, #交易原幣單價
       apcb102 LIKE apcb_t.apcb102, #原幣匯率
       apcb103 LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104 LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105 LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb106 LIKE apcb_t.apcb106, #交易幣標準成本金額
       apcb107 LIKE apcb_t.apcb107, #入庫單單價
       apcb108 LIKE apcb_t.apcb108, #交易原幣成本認列金額
       apcb111 LIKE apcb_t.apcb111, #本幣單價
       apcb113 LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114 LIKE apcb_t.apcb114, #本幣稅額
       apcb115 LIKE apcb_t.apcb115, #本幣含稅金額
       apcb116 LIKE apcb_t.apcb116, #本幣標準成本金額
       apcb117 LIKE apcb_t.apcb117, #NO USE
       apcb118 LIKE apcb_t.apcb118, #本幣成本認列金額
       apcb119 LIKE apcb_t.apcb119, #應開發票含稅金額
       apcb121 LIKE apcb_t.apcb121, #本位幣二匯率
       apcb123 LIKE apcb_t.apcb123, #本位幣二未稅金額
       apcb124 LIKE apcb_t.apcb124, #本位幣二稅額
       apcb125 LIKE apcb_t.apcb125, #本位幣二含稅金額
       apcb126 LIKE apcb_t.apcb126, #本幣二標準成本金額
       apcb127 LIKE apcb_t.apcb127, #NO USE
       apcb128 LIKE apcb_t.apcb128, #本位幣二成本認列金額
       apcb131 LIKE apcb_t.apcb131, #本位幣三匯率
       apcb133 LIKE apcb_t.apcb133, #本位幣三未稅金額
       apcb134 LIKE apcb_t.apcb134, #本位幣三稅額
       apcb135 LIKE apcb_t.apcb135, #本位幣三含稅金額
       apcb136 LIKE apcb_t.apcb136, #本幣三標準成本金額
       apcb137 LIKE apcb_t.apcb137, #NO USE
       apcb138 LIKE apcb_t.apcb138, #本位幣三成本認列金額
       apcbud001 LIKE apcb_t.apcbud001, #自定義欄位(文字)001
       apcbud002 LIKE apcb_t.apcbud002, #自定義欄位(文字)002
       apcbud003 LIKE apcb_t.apcbud003, #自定義欄位(文字)003
       apcbud004 LIKE apcb_t.apcbud004, #自定義欄位(文字)004
       apcbud005 LIKE apcb_t.apcbud005, #自定義欄位(文字)005
       apcbud006 LIKE apcb_t.apcbud006, #自定義欄位(文字)006
       apcbud007 LIKE apcb_t.apcbud007, #自定義欄位(文字)007
       apcbud008 LIKE apcb_t.apcbud008, #自定義欄位(文字)008
       apcbud009 LIKE apcb_t.apcbud009, #自定義欄位(文字)009
       apcbud010 LIKE apcb_t.apcbud010, #自定義欄位(文字)010
       apcbud011 LIKE apcb_t.apcbud011, #自定義欄位(數字)011
       apcbud012 LIKE apcb_t.apcbud012, #自定義欄位(數字)012
       apcbud013 LIKE apcb_t.apcbud013, #自定義欄位(數字)013
       apcbud014 LIKE apcb_t.apcbud014, #自定義欄位(數字)014
       apcbud015 LIKE apcb_t.apcbud015, #自定義欄位(數字)015
       apcbud016 LIKE apcb_t.apcbud016, #自定義欄位(數字)016
       apcbud017 LIKE apcb_t.apcbud017, #自定義欄位(數字)017
       apcbud018 LIKE apcb_t.apcbud018, #自定義欄位(數字)018
       apcbud019 LIKE apcb_t.apcbud019, #自定義欄位(數字)019
       apcbud020 LIKE apcb_t.apcbud020, #自定義欄位(數字)020
       apcbud021 LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
       apcbud022 LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
       apcbud023 LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
       apcbud024 LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
       apcbud025 LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
       apcbud026 LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
       apcbud027 LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
       apcbud028 LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
       apcbud029 LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
       apcbud030 LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
       apcb052 LIKE apcb_t.apcb052, #稅額
       apcb053 LIKE apcb_t.apcb053, #含稅金額
       apcb054 LIKE apcb_t.apcb054, #帳款對象
       apcb055 LIKE apcb_t.apcb055  #付款對象
END RECORD
DEFINE l_apbb RECORD  #進項發票對帳主檔
       apbbent LIKE apbb_t.apbbent, #企業編號
       apbbownid LIKE apbb_t.apbbownid, #資料所有者
       apbbowndp LIKE apbb_t.apbbowndp, #資料所屬部門
       apbbcrtid LIKE apbb_t.apbbcrtid, #資料建立者
       apbbcrtdp LIKE apbb_t.apbbcrtdp, #資料建立部門
       apbbcrtdt LIKE apbb_t.apbbcrtdt, #資料創建日
       apbbmodid LIKE apbb_t.apbbmodid, #資料修改者
       apbbmoddt LIKE apbb_t.apbbmoddt, #最近修改日
       apbbcnfid LIKE apbb_t.apbbcnfid, #資料確認者
       apbbcnfdt LIKE apbb_t.apbbcnfdt, #資料確認日
       apbbstus LIKE apbb_t.apbbstus, #狀態碼
       apbbcomp LIKE apbb_t.apbbcomp, #法人
       apbbdocno LIKE apbb_t.apbbdocno, #對帳單號碼
       apbbseq LIKE apbb_t.apbbseq, #項次
       apbbdocdt LIKE apbb_t.apbbdocdt, #單據日期
       apbb001 LIKE apbb_t.apbb001, #發票來源
       apbb002 LIKE apbb_t.apbb002, #開發票人
       apbb004 LIKE apbb_t.apbb004, #帳務中心(業務組織)
       apbb006 LIKE apbb_t.apbb006, #業務部門(登入部門)
       apbb008 LIKE apbb_t.apbb008, #發票類型
       apbb009 LIKE apbb_t.apbb009, #銷方發票編號
       apbb010 LIKE apbb_t.apbb010, #發票號碼
       apbb011 LIKE apbb_t.apbb011, #發票日期
       apbb012 LIKE apbb_t.apbb012, #稅別
       apbb0121 LIKE apbb_t.apbb0121, #含稅否
       apbb013 LIKE apbb_t.apbb013, #稅率
       apbb014 LIKE apbb_t.apbb014, #幣別
       apbb015 LIKE apbb_t.apbb015, #匯率
       apbb016 LIKE apbb_t.apbb016, #購貨方名稱
       apbb017 LIKE apbb_t.apbb017, #購貨方統一編號
       apbb018 LIKE apbb_t.apbb018, #購貨方地址
       apbb019 LIKE apbb_t.apbb019, #購貨方電話
       apbb020 LIKE apbb_t.apbb020, #購貨方開戶銀行
       apbb021 LIKE apbb_t.apbb021, #購貨方帳戶編碼
       apbb022 LIKE apbb_t.apbb022, #銷方銀行帳戶編碼
       apbb023 LIKE apbb_t.apbb023, #發票原幣未稅金額
       apbb024 LIKE apbb_t.apbb024, #發票原幣稅額
       apbb025 LIKE apbb_t.apbb025, #發票原幣含稅金額
       apbb026 LIKE apbb_t.apbb026, #發票本幣未稅金額
       apbb027 LIKE apbb_t.apbb027, #發票本幣稅額
       apbb028 LIKE apbb_t.apbb028, #發票本幣含稅金額
       apbb029 LIKE apbb_t.apbb029, #銷貨方名稱
       apbb030 LIKE apbb_t.apbb030, #統一編號
       apbb031 LIKE apbb_t.apbb031, #銷貨方地址
       apbb032 LIKE apbb_t.apbb032, #銷貨方電話
       apbb033 LIKE apbb_t.apbb033, #銷貨方開戶銀行
       apbb034 LIKE apbb_t.apbb034, #銷貨方帳號
       apbb035 LIKE apbb_t.apbb035, #申報數量
       apbb036 LIKE apbb_t.apbb036, #異動狀態
       apbb037 LIKE apbb_t.apbb037, #可扣抵編號
       apbb038 LIKE apbb_t.apbb038, #作廢(登出)理由碼
       apbb039 LIKE apbb_t.apbb039, #作廢日期
       apbb040 LIKE apbb_t.apbb040, #作廢時間
       apbb041 LIKE apbb_t.apbb041, #作廢人員
       apbb042 LIKE apbb_t.apbb042, #專案作廢核准文號
       apbb043 LIKE apbb_t.apbb043, #通關方式註記
       apbb044 LIKE apbb_t.apbb044, #列印次數
       apbb045 LIKE apbb_t.apbb045, #支付工具卡號1
       apbb046 LIKE apbb_t.apbb046, #支付工具卡號2
       apbb047 LIKE apbb_t.apbb047, #支付工具卡號3
       apbb048 LIKE apbb_t.apbb048, #通關註記
       apbb049 LIKE apbb_t.apbb049, #備註說明
       apbb050 LIKE apbb_t.apbb050, #發票性質
       apbb051 LIKE apbb_t.apbb051, #採購人員
       apbb052 LIKE apbb_t.apbb052, #採購部門
       apbb053 LIKE apbb_t.apbb053, #登入日期
       apbb054 LIKE apbb_t.apbb054, #付款條件
       apbb107 LIKE apbb_t.apbb107, #發票原幣已折金額
       apbb108 LIKE apbb_t.apbb108, #發票原幣已折稅額
       apbb117 LIKE apbb_t.apbb117, #發票本幣已折金額
       apbb118 LIKE apbb_t.apbb118, #發票本幣已折稅額
       apbb200 LIKE apbb_t.apbb200, #電子發票否
       apbb201 LIKE apbb_t.apbb201, #愛心碼
       apbb202 LIKE apbb_t.apbb202, #載具類別號碼
       apbb203 LIKE apbb_t.apbb203, #載具顯碼 ID
       apbb204 LIKE apbb_t.apbb204, #載具隱碼 ID
       apbb205 LIKE apbb_t.apbb205, #電子發票匯出狀態
       apbb206 LIKE apbb_t.apbb206, #電子發票匯出序號
       apbb207 LIKE apbb_t.apbb207, #電子發票領取方式
       apbb208 LIKE apbb_t.apbb208, #申報年度
       apbb209 LIKE apbb_t.apbb209, #申報月份
       apbb210 LIKE apbb_t.apbb210, #申報據點
       apbbud001 LIKE apbb_t.apbbud001, #自定義欄位(文字)001
       apbbud002 LIKE apbb_t.apbbud002, #自定義欄位(文字)002
       apbbud003 LIKE apbb_t.apbbud003, #自定義欄位(文字)003
       apbbud004 LIKE apbb_t.apbbud004, #自定義欄位(文字)004
       apbbud005 LIKE apbb_t.apbbud005, #自定義欄位(文字)005
       apbbud006 LIKE apbb_t.apbbud006, #自定義欄位(文字)006
       apbbud007 LIKE apbb_t.apbbud007, #自定義欄位(文字)007
       apbbud008 LIKE apbb_t.apbbud008, #自定義欄位(文字)008
       apbbud009 LIKE apbb_t.apbbud009, #自定義欄位(文字)009
       apbbud010 LIKE apbb_t.apbbud010, #自定義欄位(文字)010
       apbbud011 LIKE apbb_t.apbbud011, #自定義欄位(數字)011
       apbbud012 LIKE apbb_t.apbbud012, #自定義欄位(數字)012
       apbbud013 LIKE apbb_t.apbbud013, #自定義欄位(數字)013
       apbbud014 LIKE apbb_t.apbbud014, #自定義欄位(數字)014
       apbbud015 LIKE apbb_t.apbbud015, #自定義欄位(數字)015
       apbbud016 LIKE apbb_t.apbbud016, #自定義欄位(數字)016
       apbbud017 LIKE apbb_t.apbbud017, #自定義欄位(數字)017
       apbbud018 LIKE apbb_t.apbbud018, #自定義欄位(數字)018
       apbbud019 LIKE apbb_t.apbbud019, #自定義欄位(數字)019
       apbbud020 LIKE apbb_t.apbbud020, #自定義欄位(數字)020
       apbbud021 LIKE apbb_t.apbbud021, #自定義欄位(日期時間)021
       apbbud022 LIKE apbb_t.apbbud022, #自定義欄位(日期時間)022
       apbbud023 LIKE apbb_t.apbbud023, #自定義欄位(日期時間)023
       apbbud024 LIKE apbb_t.apbbud024, #自定義欄位(日期時間)024
       apbbud025 LIKE apbb_t.apbbud025, #自定義欄位(日期時間)025
       apbbud026 LIKE apbb_t.apbbud026, #自定義欄位(日期時間)026
       apbbud027 LIKE apbb_t.apbbud027, #自定義欄位(日期時間)027
       apbbud028 LIKE apbb_t.apbbud028, #自定義欄位(日期時間)028
       apbbud029 LIKE apbb_t.apbbud029, #自定義欄位(日期時間)029
       apbbud030 LIKE apbb_t.apbbud030, #自定義欄位(日期時間)030
       apbb055 LIKE apbb_t.apbb055, #付款到期日
       apbb056 LIKE apbb_t.apbb056, #for流通
       apbb057 LIKE apbb_t.apbb057, #應付單號
       apbb058 LIKE apbb_t.apbb058, #經營方式
       apbb003 LIKE apbb_t.apbb003  #對帳來源
END RECORD
DEFINE l_apba RECORD  #進項發票明細檔
       apbaent LIKE apba_t.apbaent, #企業編號
       apbadocno LIKE apba_t.apbadocno, #檔案號碼
       apbaorga LIKE apba_t.apbaorga, #帳務歸屬組織
       apba001 LIKE apba_t.apba001, #發票類型
       apba002 LIKE apba_t.apba002, #發票編號
       apba003 LIKE apba_t.apba003, #發票號碼
       apbaseq LIKE apba_t.apbaseq, #項次
       apba004 LIKE apba_t.apba004, #來源作業
       apba005 LIKE apba_t.apba005, #業務單號碼
       apba006 LIKE apba_t.apba006, #業務單項次
       apba007 LIKE apba_t.apba007, #產品編號
       apba008 LIKE apba_t.apba008, #品名規格
       apba009 LIKE apba_t.apba009, #單位
       apba010 LIKE apba_t.apba010, #發票數量
       apba011 LIKE apba_t.apba011, #暫估帳款數量
       apba012 LIKE apba_t.apba012, #正負值
       apba013 LIKE apba_t.apba013, #參考單號
       apba014 LIKE apba_t.apba014, #單價
       apba015 LIKE apba_t.apba015, #稅別
       apba016 LIKE apba_t.apba016, #扣抵發票編號
       apba017 LIKE apba_t.apba017, #扣抵藍字發票號碼
       apba100 LIKE apba_t.apba100, #交易原幣
       apba103 LIKE apba_t.apba103, #原幣未稅金額
       apba104 LIKE apba_t.apba104, #原幣稅額
       apba105 LIKE apba_t.apba105, #原幣含稅總額
       apba111 LIKE apba_t.apba111, #發票匯率
       apba113 LIKE apba_t.apba113, #發票幣未稅金額
       apba114 LIKE apba_t.apba114, #發票幣稅額
       apba115 LIKE apba_t.apba115, #發票幣含稅總額
       apbaud001 LIKE apba_t.apbaud001, #自定義欄位(文字)001
       apbaud002 LIKE apba_t.apbaud002, #自定義欄位(文字)002
       apbaud003 LIKE apba_t.apbaud003, #自定義欄位(文字)003
       apbaud004 LIKE apba_t.apbaud004, #自定義欄位(文字)004
       apbaud005 LIKE apba_t.apbaud005, #自定義欄位(文字)005
       apbaud006 LIKE apba_t.apbaud006, #自定義欄位(文字)006
       apbaud007 LIKE apba_t.apbaud007, #自定義欄位(文字)007
       apbaud008 LIKE apba_t.apbaud008, #自定義欄位(文字)008
       apbaud009 LIKE apba_t.apbaud009, #自定義欄位(文字)009
       apbaud010 LIKE apba_t.apbaud010, #自定義欄位(文字)010
       apbaud011 LIKE apba_t.apbaud011, #自定義欄位(數字)011
       apbaud012 LIKE apba_t.apbaud012, #自定義欄位(數字)012
       apbaud013 LIKE apba_t.apbaud013, #自定義欄位(數字)013
       apbaud014 LIKE apba_t.apbaud014, #自定義欄位(數字)014
       apbaud015 LIKE apba_t.apbaud015, #自定義欄位(數字)015
       apbaud016 LIKE apba_t.apbaud016, #自定義欄位(數字)016
       apbaud017 LIKE apba_t.apbaud017, #自定義欄位(數字)017
       apbaud018 LIKE apba_t.apbaud018, #自定義欄位(數字)018
       apbaud019 LIKE apba_t.apbaud019, #自定義欄位(數字)019
       apbaud020 LIKE apba_t.apbaud020, #自定義欄位(數字)020
       apbaud021 LIKE apba_t.apbaud021, #自定義欄位(日期時間)021
       apbaud022 LIKE apba_t.apbaud022, #自定義欄位(日期時間)022
       apbaud023 LIKE apba_t.apbaud023, #自定義欄位(日期時間)023
       apbaud024 LIKE apba_t.apbaud024, #自定義欄位(日期時間)024
       apbaud025 LIKE apba_t.apbaud025, #自定義欄位(日期時間)025
       apbaud026 LIKE apba_t.apbaud026, #自定義欄位(日期時間)026
       apbaud027 LIKE apba_t.apbaud027, #自定義欄位(日期時間)027
       apbaud028 LIKE apba_t.apbaud028, #自定義欄位(日期時間)028
       apbaud029 LIKE apba_t.apbaud029, #自定義欄位(日期時間)029
       apbaud030 LIKE apba_t.apbaud030, #自定義欄位(日期時間)030
       apba018 LIKE apba_t.apba018,     #本次開票金額
       apba019 LIKE apba_t.apba019,     #預付已開發票
       apba020 LIKE apba_t.apba020      #期別
      ,apba022 LIKE apba_t.apba022,
       apba021 LIKE apba_t.apba021,     #理由碼                #181204-00009#1 add
       apba023 LIKE apba_t.apba023      
END RECORD
#161111-00048#2 --e add
DEFINE l_apcb105     LIKE apcb_t.apcb105        #本幣單價*數量金額
DEFINE l_cnt         LIKE type_t.num10
#DEFINE l_str         LIKE type_t.chr500    #170430-00006#2 mark
DEFINE l_ld_type     LIKE type_t.chr1
DEFINE l_tmp         RECORD
         pmdtsite    LIKE pmdt_t.pmdtsite,      #營運據點
         pmdtdocno   LIKE pmdt_t.pmdtdocno,     #收票單號
         pmdtseq     LIKE pmdt_t.pmdtseq,       #收票項次
         apcb007     LIKE apcb_t.apcb007        #可立帳數量
                 END RECORD
DEFINE l_flag        LIKE type_t.num5           #是否為入庫單全部數量立帳   #141204-00017#1            
DEFINE l_glaa001     LIKE glaa_t.glaa001        #140806-00012#12
DEFINE l_apcb007     LIKE apcb_t.apcb007
DEFINE l_apcb0071    LIKE apcb_t.apcb007        #170527-00015#1 add
DEFINE l_acctype     LIKE type_t.chr2           #150313-00003#2  
DEFINE l_pmds000     LIKE pmds_t.pmds000
DEFINE l_ar          DYNAMIC ARRAY OF RECORD
                     chr  LIKE type_t.chr500
                 END RECORD      
DEFINE l_oodb004     LIKE oodb_t.oodb004     #150930-00012#1
DEFINE l_oodb005     LIKE oodb_t.oodb005     #150930-00012#1
DEFINE l_oodb006     LIKE oodb_t.oodb006     #150930-00012#1
DEFINE l_oodb011     LIKE oodb_t.oodb011     #150930-00012#1 
DEFINE l_pmds012     LIKE pmds_t.pmds012     #採購通路 #160120-00011#2
DEFINE l_pmds013     LIKE pmds_t.pmds013     #採購分類 #160120-00011#2
DEFINE l_pmds100     LIKE pmds_t.pmds100     #倉退方式   #190220-00035#1 add
DEFINE l_pmdt016     LIKE pmdt_t.pmdt016     #倉庫     #160120-00011#2
DEFINE l_apcb106     LIKE apcb_t.apcb106     #160107-00001#1
DEFINE l_apcb116     LIKE apcb_t.apcb116     #160107-00001#1
DEFINE l_apcb126     LIKE apcb_t.apcb126     #160107-00001#1
DEFINE l_apcb136     LIKE apcb_t.apcb136     #160107-00001#1
DEFINE l_pmdt072     LIKE pmdt_t.pmdt072     #170306-00050#1 add
#170526-00019#1--remark--str--lujh
#170417-00017#1--add--str--lujh
#DEFINE l_pmdt051     LIKE pmdt_t.pmdt051     
DEFINE l_imaa004     LIKE imaa_t.imaa004     
DEFINE l_imag011     LIKE imag_t.imag011     
#170417-00017#1--add--end--lujh
#170526-00019#1--remark--end--lujh
DEFINE l_pmdt051     LIKE pmdt_t.pmdt051     #161104-00049#6
DEFINE l_bgbd039     LIKE bgbd_t.bgbd039     #170510-00041#1
DEFINE l_pmdtdocno_t LIKE pmdt_t.pmdtdocno   #170518-00041#1 add 備份舊單號
#180704-00022#1 add ---s
DEFINE l_array       DYNAMIC ARRAY OF RECORD
       chr  LIKE type_t.chr1000
       END RECORD  
#180704-00022#1 add ---e
#180705-00083#1 add -s
DEFINE l_apcb2       RECORD #固定核算项
       apcb054       LIKE apcb_t.apcb054,
       apcb055       LIKE apcb_t.apcb055,
       apcb051       LIKE apcb_t.apcb051,
       apcb010       LIKE apcb_t.apcb010,
       apcb011       LIKE apcb_t.apcb011,
       apcb024       LIKE apcb_t.apcb024,
       apcb036       LIKE apcb_t.apcb036,
       apcb012       LIKE apcb_t.apcb012,
       apcb033       LIKE apcb_t.apcb033,
       apcb034       LIKE apcb_t.apcb034,
       apcb035       LIKE apcb_t.apcb035,
       apcb015       LIKE apcb_t.apcb015,
       apcb016       LIKE apcb_t.apcb016
                     END RECORD
DEFINE l_apcb3       RECORD #自由核算项
       apcb037       LIKE apcb_t.apcb037, 
       apcb038       LIKE apcb_t.apcb038,
       apcb039       LIKE apcb_t.apcb039, 
       apcb040       LIKE apcb_t.apcb040,
       apcb041       LIKE apcb_t.apcb041, 
       apcb042       LIKE apcb_t.apcb042,
       apcb043       LIKE apcb_t.apcb043, 
       apcb044       LIKE apcb_t.apcb044,
       apcb045       LIKE apcb_t.apcb045,     
       apcb046       LIKE apcb_t.apcb046            
                     END RECORD 
#180705-00083#1 add -e
#180821-00038#11---add---(S)
DEFINE l_amount_e    LIKE apcb_t.apcb007
DEFINE l_success     LIKE type_t.num5 
DEFINE l_errno       LIKE gzze_t.gzze001
DEFINE ls_js         STRING
DEFINE l_apcb_o RECORD
       apcb103       LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104       LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105       LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb113       LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114       LIKE apcb_t.apcb114, #本幣稅額
       apcb115       LIKE apcb_t.apcb115, #本幣含稅金額 
       apcb020       LIKE apcb_t.apcb020, #稅別
       apca101       LIKE apca_t.apca101, #匯率
       apcb101       LIKE apcb_t.apcb101, #單價
       apcb007       LIKE apcb_t.apcb007  #數量  
   END RECORD
#180821-00038#11---add---(E)
DEFINE l_pmdt005     LIKE pmdt_t.pmdt005   #190103-00077#1 add
DEFINE l_cnt1        LIKE type_t.num5  #190319-00017#1----add-
DEFINE l_cnt2        LIKE type_t.num5  #190319-00017#1----add-
DEFINE l_apcadocdt   LIKE apca_t.apcadocdt     #190424-00024#1----add----str
#DEFINE l_sfin9025    LIKE type_t.chr1          #190423-00042#1 add #190423-00042#38 mark
DEFINE l_sfin9026    LIKE type_t.chr1      #190423-00042#38 add
DEFINE l_pmdt062     LIKE pmdt_t.pmdt062   #190815-00012#1 add
DEFINE l_pmdu006     LIKE pmdu_t.pmdu006   #190815-00012#1 add
DEFINE l_kind        STRING                #190812-00010#5 add 
DEFINE l_imaf141     LIKE imaf_t.imaf141   #190812-00010#5 add 
#191010-00012#1---add---str
DEFINE l_pmds006     LIKE pmds_t.pmds006
DEFINE l_pmdl008     LIKE pmdl_t.pmdl008
DEFINE l_pmdt001     LIKE pmdt_t.pmdt001
DEFINE l_pmdt002     LIKE pmdt_t.pmdt002
#191010-00012#1---add---end
DEFINE l_type        LIKE type_t.chr5     #190305-00001#2 add
DEFINE l_sfin3012    LIKE type_t.chr1     #含稅立帳否 #191226-00040#7 add
#201127-00012#1 add---(s)
DEFINE l_ls_js   STRING
DEFINE l_tran    RECORD
   docno        LIKE apcb_t.apcbdocno,
   ld           LIKE apcb_t.apcbld,
   docdt        LIKE apca_t.apcadocdt,
   comp         LIKE apca_t.apcacomp,
   seq          LIKE apcb_t.apcbseq,  
   bgbd007      LIKE bgbd_t.bgbd007,     
   bgbd037      LIKE bgbd_t.bgbd037,
   bgbd038      LIKE bgbd_t.bgbd038,
   bgbd040      LIKE bgbd_t.bgbd040,     
   bgbd007_t    LIKE bgbd_t.bgbd007,    #修改前的預算細項
   bgbd037_t    LIKE bgbd_t.bgbd037,    #修改前的單號
   bgbd038_t    LIKE bgbd_t.bgbd038,    #修改前的項次
   bgbd040_t    LIKE bgbd_t.bgbd040,    #修改前被占用的金額
   act          LIKE type_t.chr10     
END RECORD
#201127-00012#1 add---(e)
#200805-00007#1 add -s 
DEFINE l_apcb010     LIKE apcb_t.apcb010
DEFINE l_apcb021     LIKE apcb_t.apcb021
#200805-00007#1 add -e
#200916-00030#1-(S) add
DEFINE l_pmdt024     LIKE pmdt_t.pmdt024
DEFINE l_pmds054     LIKE pmds_t.pmds054
#200916-00030#1-(E) add

   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   
   LET l_flag = 0 
   
   #SELECT * INTO l_apca.*   #161208-00026#22   mark
   #161208-00026#22   add---s
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073
     INTO l_apca.*
   #161208-00026#22   add---e
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_docno
   
   #150930-00012#1-----s 
   #取單頭稅別含稅否
   CALL s_tax_chk(l_apca.apcacomp,l_apca.apca011) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
   #150930-00012#1-----e
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3012') RETURNING l_sfin3012  #191226-00040#7 add
   
   #190812-00010#5 add s---
   LET l_sql = " SELECT imaf141 FROM imaf_t ",
               "  WHERE imafent = ",g_enterprise," AND imaf001 = ?",
               "    AND imafsite = (SELECT glaacomp FROM glaa_t WHERE glaaent=",g_enterprise," AND glaald= ?) "
   PREPARE s_aapp131_imaf141_prep2 FROM l_sql 
   #190812-00010#5 add e---   

   LET l_sql = " SELECT pmdtsite,pmdtdocno,pmdtseq,apcb007",
               "   FROM s_aapp131_tmp_g ",
               "  WHERE pmds037 = '",l_apca.apca100,"' AND pmds038 =  ",l_apca.apca101,
               "    AND pmds007 = '",l_apca.apca004,"' AND cond1   = '",p_cond1,"'",
               "    AND pmds008 = '",l_apca.apca005,"'",         #200218-00040#8 add
               "    AND pmds033 = '",l_apca.apca011,"'",  #160705-00035#3 add ,
               "    AND pmds000 <> '27' "                 #160705-00035#3 #27:其他待抵單要寫入直接沖帳
              ,"    AND pmds031 = '",l_apca.apca008,"'"   #190221-00034#1 add #拆分付款條件不同要分開單據
   IF NOT cl_null(l_apca.apca007) THEN
      LET l_sql = l_sql ,"  AND apca007 = '",l_apca.apca007,"' "
   ELSE
      LET l_sql = l_sql ,"  AND apca007 IS NULL "
   END IF
   
   #170518-00041#1 --s add 以參數g_apba004_18決定是否排除來源18 差異折讓
   IF g_apba004_18 = '1' THEN
      LET l_sql = l_sql ,"  AND pmds000 = '18' "
   END IF
   #170518-00041#1 --e add
   
   #171214-00017#5 add ------
   #一次性交易要加上交易編號條件
   IF l_apca.apca057 <> l_apca.apca004 THEN
      LET l_sql = l_sql ,"  AND pmds028 = '",l_apca.apca057,"' "
   END IF
   #171214-00017#5 add end---
   
   #LET l_sql = l_sql," ORDER BY pmdtdocno,pmdtseq "   #150126-00012#1             #170324-00028#1 mark
   LET l_sql = l_sql," ORDER BY cond1,pmds008,pmds033,pmds031,pmdtdocno,pmdtseq "  #170324-00028#1 add
   PREPARE s_aapp131_ins_apcb2_p FROM l_sql
   DECLARE s_aapp131_ins_apcb2_c CURSOR FOR s_aapp131_ins_apcb2_p
   CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_glaa001
   #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101  #160829-00004#5 mark
   #CALL s_curr_round_ld('1',p_ld,l_apca.apca100,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101 #160829-00004#5  #170430-00006#2 mark
   CALL s_num_round(g_round_type,l_apca.apca101,g_ooaj005) RETURNING l_apca.apca101      #170430-00006#2 add
   CALL s_fin_get_ld_type(p_ld) RETURNING l_ld_type
   ##本張立帳單單身來源的所有入庫單資訊必須先lock住,若有任何一筆入庫單lock失敗,則整張立帳單身停止動作150126-00012#1--str--
   FOREACH s_aapp131_ins_apcb2_c INTO l_tmp.*
      OPEN s_aapp131_pmdt_cl USING g_enterprise,l_tmp.pmdtdocno,l_tmp.pmdtseq
      IF STATUS THEN
         LET r_success = FALSE
         RETURN r_success
      END IF 
        
   END FOREACH   
   #150126-00012#1--end--   
   #200916-00030#1-(S) add
   #取得來源倉退單資訊 
   LET l_sql = " SELECT pmdt024, (SELECT DISTINCT pmds054 FROM pmds_t WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno)pmds054 ", 
               "   FROM pmdt_t ",
               "  WHERE pmdtent = ",g_enterprise," AND pmdtdocno = ? AND pmdtseq = ? "               
               
   PREPARE s_aapp131_pmdt024_prep2 FROM l_sql
   #200916-00030#1-(E) add
   
   FOREACH s_aapp131_ins_apcb2_c INTO l_tmp.*

      INITIALIZE l_apcb.* TO NULL
      INITIALIZE l_apbb.* TO NULL
      INITIALIZE l_apba.* TO NULL
      
      IF g_price = 'Y' THEN  #190911-00021#1---add
         #190319-00017#1----add---str
         LET l_cnt1 = 0
         LET l_cnt2 = 0
         SELECT count(1) INTO l_cnt1
           FROM s_aapp131_tmp_g
          WHERE pmdsent = g_enterprise
            AND pmdtdocno = l_tmp.pmdtdocno
         
         SELECT count(1) INTO l_cnt2
           FROM apba_t
          WHERE apbaent = g_enterprise
            AND apbadocno = l_tmp.pmdtdocno
         
         IF l_cnt1 <> l_cnt2 THEN
            #如果不等说明对账的单身有没产生账款
            CONTINUE FOREACH    
         END IF
         #190319-00017#1----add---end  
      #190911-00021#1---add---str
      ELSE
         LET l_cnt1 = 0
         LET l_cnt2 = 0
         SELECT count(1) INTO l_cnt1
           FROM s_aapp131_tmp_g
          WHERE pmdsent = g_enterprise
            AND pmdtdocno = l_tmp.pmdtdocno
         
         SELECT count(1) INTO l_cnt2
           FROM apba_t
          WHERE apbaent = g_enterprise
            AND apbadocno = l_tmp.pmdtdocno
            AND apba014 <> 0
         
         IF l_cnt1 <> l_cnt2 THEN
            #如果不等说明对账的单身有没产生账款
            CONTINUE FOREACH    
         END IF
      END IF
      #190911-00021#1---add---end      
      
     #170430-00006#2---modify---start--- 
     ##SELECT * INTO l_apbb.*   #161208-00026#22   mark
     ##161208-00026#22   add---s
     #SELECT apbbent,apbbownid,apbbowndp,apbbcrtid,apbbcrtdp,
     #       apbbcrtdt,apbbmodid,apbbmoddt,apbbcnfid,apbbcnfdt,
     #       apbbstus,apbbcomp,apbbdocno,apbbseq,apbbdocdt,
     #       apbb001,apbb002,apbb004,apbb006,apbb008,
     #       apbb009,apbb010,apbb011,apbb012,apbb0121,
     #       apbb013,apbb014,apbb015,apbb016,apbb017,
     #       apbb018,apbb019,apbb020,apbb021,apbb022,
     #       apbb023,apbb024,apbb025,apbb026,apbb027,
     #       apbb028,apbb029,apbb030,apbb031,apbb032,
     #       apbb033,apbb034,apbb035,apbb036,apbb037,
     #       apbb038,apbb039,apbb040,apbb041,apbb042,
     #       apbb043,apbb044,apbb045,apbb046,apbb047,
     #       apbb048,apbb049,apbb050,apbb051,apbb052,
     #       apbb053,apbb054,apbb107,apbb108,apbb117,
     #       apbb118,apbb200,apbb201,apbb202,apbb203,
     #       apbb204,apbb205,apbb206,apbb207,apbb208,
     #       apbb209,apbb210,apbbud001,apbbud002,apbbud003,
     #       apbbud004,apbbud005,apbbud006,apbbud007,apbbud008,
     #       apbbud009,apbbud010,apbbud011,apbbud012,apbbud013,
     #       apbbud014,apbbud015,apbbud016,apbbud017,apbbud018,
     #       apbbud019,apbbud020,apbbud021,apbbud022,apbbud023,
     #       apbbud024,apbbud025,apbbud026,apbbud027,apbbud028,
     #       apbbud029,apbbud030,apbb055,apbb056,apbb057,
     #       apbb058,apbb003
     #  INTO l_apbb.*
     ##161208-00026#22   add---e
     #  FROM apbb_t
     # WHERE apbbent = g_enterprise AND apbbdocno = l_tmp.pmdtdocno
     ##SELECT * INTO l_apba.*   #161208-00026#22   mark
     ##161208-00026#22   add---s
     #SELECT apbaent,apbadocno,apbaorga,apba001,apba002,
     #       apba003,apbaseq,apba004,apba005,apba006,
     #       apba007,apba008,apba009,apba010,apba011,
     #       apba012,apba013,apba014,apba015,apba016,
     #       apba017,apba100,apba103,apba104,apba105,
     #       apba111,apba113,apba114,apba115,apbaud001,
     #       apbaud002,apbaud003,apbaud004,apbaud005,apbaud006,
     #       apbaud007,apbaud008,apbaud009,apbaud010,apbaud011,
     #       apbaud012,apbaud013,apbaud014,apbaud015,apbaud016,
     #       apbaud017,apbaud018,apbaud019,apbaud020,apbaud021,
     #       apbaud022,apbaud023,apbaud024,apbaud025,apbaud026,
     #       apbaud027,apbaud028,apbaud029,apbaud030,apba018,
     #       apba019,apba020
     #  INTO l_apba.*
     ##161208-00026#22   add---e
     #  FROM apba_t
     # WHERE apbaent = g_enterprise AND apbadocno = l_tmp.pmdtdocno AND apbaseq = l_tmp.pmdtseq
     
      #170518-00041#1 --s add 若為18差異折讓, 則用產生的那張折讓單取資料
      IF g_apba004_18 = '1' THEN
         LET l_pmdtdocno_t = l_tmp.pmdtdocno
         LET l_tmp.pmdtdocno = ''
         LET l_tmp.pmdtseq = ''
         SELECT apbbdocno,apbaseq 
           INTO l_tmp.pmdtdocno,l_tmp.pmdtseq 
           FROM apbb_t,apba_t       
          WHERE apbbent = g_enterprise AND apbbent = apbaent AND apbbdocno = apbadocno
            AND apbb003 = 'A' AND apba005 = l_pmdtdocno_t AND apba004 = '29'
            AND apbbstus != 'X'      
      END IF   
      #170518-00041#1 --e add      
     
      EXECUTE s_aapp131_apbb_c USING g_enterprise,l_tmp.pmdtdocno INTO l_apbb.*
      EXECUTE s_aapp131_apba_c USING g_enterprise,l_tmp.pmdtdocno,l_tmp.pmdtseq INTO l_apba.*
      
       #190424-00024#1----add----str
     #对账单如果有一个入库单有暂估单单身日期大于就不让他产生
      #查找这个入库单是否立暂估单
       LET l_cnt1 = 0
       SELECT COUNT(1) INTO l_cnt1
        FROM apca_t,apcb_t
       WHERE apcaent = apcbent 
         AND apcadocno = apcbdocno
         AND apcald = apcbld
         AND apcaent = g_enterprise
         AND apcb002 = l_apba.apba005
         AND apcastus <> 'X'
         AND apca001 IN ('01','02') 
      IF l_cnt1 > 0 THEN 
         #PGS(D)-13592 -S-
         #PGS(D)-13592 -E-      
         SELECT apcadocdt INTO l_apcadocdt
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent 
            AND apcadocno = apcbdocno
            AND apcald = apcbld
            AND apcaent = g_enterprise
            AND apcb002 = l_apba.apba005
            AND apcastus <> 'X'
            AND apca001 IN ('01','02')
         IF l_apcadocdt > l_apca.apcadocdt THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'aap-01148'         
            LET g_errparam.extend = l_apba.apba005
            LET g_errparam.replace[1] = l_apba.apba005
            LET g_errparam.replace[2] = l_apba.apba005
            LET g_errparam.popup = TRUE
            CALL cl_err()     
            LET r_success = FALSE         
            RETURN r_success  
         END IF
      END IF
      #190424-00024#1----add----str  
      
     #170430-00006#2---modify---end---
      LET l_pmds012 = ''      #160120-00011#2
      LET l_pmds013 = ''      #160120-00011#2
      LET l_pmds100 = ''      #190220-00035#1 add
      SELECT pmds000,pmds012,pmds013,pmds100   #190220-00035#1 add pmds100
        INTO l_pmds000,l_pmds012,l_pmds013,l_pmds100         #160120-00011#2 add pmds012/pmds013   #190220-00035#1 add l_pmds100
        FROM pmds_t
       WHERE pmdsent = g_enterprise   AND pmdsdocno = l_apba.apba005
       
      IF cl_null(l_pmds100) THEN LET l_pmds100 = ' ' END IF   #190227-00032#1 add       
      LET l_apcb.apcbent  = g_enterprise
      LET l_apcb.apcbld   = p_ld
      LET l_apcb.apcborga = l_apba.apbaorga
      LET l_apcb.apcbsite = l_apca.apcasite
      LET l_apcb.apcblegl = l_apca.apcacomp
      LET l_apcb.apcbdocno= p_docno
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq 
        FROM apcb_t
       WHERE apcbent = g_enterprise AND apcbld  = l_apcb.apcbld
         AND apcbdocno  = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = l_apba.apba004     
      LET l_apcb.apcb002 = l_apba.apba005
      LET l_apcb.apcb003 = l_apba.apba006
      
      #170518-00041#1 --s add
      #寫入項次期別, 因為差異折讓只會有一筆, 立帳時寫入差異折讓對應的A:差異待抵立帳單單號;項次1;類型29其他減項
      IF g_apba004_18 = '1' THEN
         LET l_apcb.apcb001 = '29'
         LET l_apcb.apcb002 = l_tmp.pmdtdocno
         LET l_apcb.apcb003 = l_tmp.pmdtseq      
      ELSE
         #aapt110如有差異折讓,則產生一筆 13:差異折讓在單身
         IF (l_apba.apba004 = '18') AND (g_apba004_18 = '2')  THEN
            LET l_apcb.apcb001 = '13'         
         END IF
      END IF    
      #170518-00041#1 --e add
      
      LET l_apcb.apcb004 = l_apba.apba007    #pmdt006
      #180920-00015#2---add---(S)
      IF l_apcb.apcb001 MATCHES '[12]9' THEN
         LET l_apcb.apcb005 = l_apba.apba008
         LET l_apcb.apcb014 = l_apba.apba021           #理由碼      #181204-00009#1 add
      ELSE
      #180920-00015#2---add---(E)
         LET l_apcb.apcb005 = s_aapt300_get_apcb005(l_apcb.apcb004,l_apcb.apcb002,l_apcb.apcb003)
      END IF #180920-00015#2 add
      
      #200612-00001#1 add ---s
      IF l_apcb.apcb001 MATCHES '[12]6' THEN
         LET l_apcb.apcb014 = l_apba.apba021
      END IF
      #200612-00001#1 add ---e
      
      LET l_apcb.apcb006 = l_apba.apba009
      LET l_apcb.apcb007 = l_tmp.apcb007     #預設值
      
      #190812-00010#5 add s---#销售分群aimm214
      IF NOT cl_null(l_apcb.apcb004) THEN 
         LET l_imaf141 = NULL
         EXECUTE s_aapp131_imaf141_prep2 USING l_apcb.apcb004,l_apcb.apcbld INTO l_imaf141
      END IF            
      #190812-00010#5 add e---
      
      #180821-00038#16---add---(S)
      CASE
         WHEN l_apba.apba004 = '11' OR l_apba.apba004 MATCHES '2[01]'
      #180821-00038#16---add---(E)
      #IF l_apba.apba004 = '11' OR l_apba.apba004 MATCHES '2[01]' THEN #180821-00038#16 mark
         #重新取得可立帳數量,數量為0則不新增此單身141204-00017#1--str--
         CALL s_aapt300_pmdt_get_apcb007(p_ld,l_apcb.apcb002,l_apcb.apcb003,l_apca.apca001) RETURNING l_apcb007,l_flag
         IF cl_null(l_apcb007) THEN LET l_apcb007 = 0 END IF
         #200916-00030#1-(S) add
         EXECUTE s_aapp131_pmdt024_prep2 USING l_apcb.apcb002,l_apcb.apcb003 INTO l_pmdt024,l_pmds054
         IF cl_null(l_pmdt024) THEN LET l_pmdt024 = 0 END IF         
         #考慮倉退單(4:採購折扣合約結算)且倉退數量為負數
         #因為從倉退一路到立帳，若為4:採購折扣合約結算，且倉退數量為負，不得修改
         IF l_pmds054 = '4' AND l_pmdt024 < 0 THEN
            IF l_apcb007 <> 0 THEN  #還有數量可拋
               LET l_apcb.apcb007 = l_pmdt024
            ELSE
               LET l_apcb.apcb007 = 0
            END IF
         ELSE    
            IF l_apcb007 > l_tmp.apcb007 THEN
               LET l_apcb.apcb007 = l_tmp.apcb007
            ELSE
               LET l_apcb.apcb007 = l_apcb007
            END IF
         END IF
         IF l_apcb007 = 0 THEN CONTINUE FOREACH END IF
         #200916-00030#1-(E) add
         #200916-00030#1-(S) mark
         #IF l_apcb007 <= 0 THEN CONTINUE FOREACH END IF
         #IF l_apcb007 > l_tmp.apcb007 THEN
         #   LET l_apcb.apcb007 = l_tmp.apcb007
         #ELSE
         #   LET l_apcb.apcb007 = l_apcb007
         #END IF
         #200916-00030#1-(E) mark
         #141204-00017#1--end--
      #END IF #180821-00038#16 mark
      #180821-00038#16---add---(S)雜項可沖暫估量 = aapt320立暫估量 - aapt3*已沖暫估量
         WHEN l_apba.apba004 MATCHES '[12]6' 
            CALL s_aapt300_estimate_get(p_ld,'','',l_apcb.apcb002,l_apcb.apcb003,'2') RETURNING l_apcb007
            IF cl_null(l_apcb007) THEN LET l_apcb007 = 0 END IF
            IF l_apcb007 <= 0 THEN CONTINUE FOREACH END IF
            IF l_apcb007 > l_tmp.apcb007 THEN
               LET l_apcb.apcb007 = l_tmp.apcb007
            ELSE
               LET l_apcb.apcb007 = l_apcb007
            END IF
      END CASE
      #180821-00038#16---add---(E)
      IF l_apcb.apcb007 = l_tmp.apcb007 THEN   #表示全部立帳
         LET l_flag = 1
      END IF
      LET l_pmdt016 = ''         #160120-00011#2     
     #SELECT pmdt001,pmdt002,pmdt016 INTO l_apcb.apcb008,l_apcb.apcb009,l_pmdt016                       #170306-00050#1 mark
      #180821-00038#16---add---(S)
      IF l_apba.apba004 MATCHES '[12]6' THEN
         LET l_apcb.apcb008 = l_apba.apbadocno
         LET l_apcb.apcb009 = l_apba.apbaseq
      ELSE
      #180821-00038#16---add---(E)
         #SELECT pmdt001,pmdt002,pmdt016,pmdt072 INTO l_apcb.apcb008,l_apcb.apcb009,l_pmdt016,l_pmdt072     #170306-00050#1 add   #190103-00077#1 mark
         SELECT pmdt001,pmdt002,pmdt016,pmdt072,pmdt005,pmdt062    #190103-00077#1 add    #190815-00012#1--add-->,pmdt062 
           INTO l_apcb.apcb008,l_apcb.apcb009,l_pmdt016,l_pmdt072,l_pmdt005,l_pmdt062     #170306-00050#1 add   #190103-00077#1 add    #190815-00012#1--add-->,l_pmdt062 
           FROM pmdt_t
          WHERE pmdtent = g_enterprise
            AND pmdtdocno=l_apba.apba005 AND pmdtseq = l_apba.apba006
            
         #190815-00012#1---add---str
         #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
         IF l_pmdt062 = 'Y' THEN
            LET l_sql = " SELECT DISTINCT pmdu006  FROM pmdu_t  ",
                        "  WHERE pmduent = ",g_enterprise,
                        #"    AND pmdudocno = ",l_apba.apba005,     #PGS(D)-01531 mark
                        "    AND pmdudocno = '",l_apba.apba005,"'", #PGS(D)-01531 add
                        "     AND pmduseq = ",l_apba.apba006 
            PREPARE s_aapp131_pmdu006_p2 FROM l_sql
            DECLARE s_aapp131_pmdu006_c2 CURSOR FOR s_aapp131_pmdu006_p2
                   
         END IF
         #190815-00012#1---add---end
      
         
      END IF #180821-00038#16 add
      CALL l_ar.clear()
      CALL s_aapp131_get_apcb010(l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003) RETURNING l_ar
      LET l_apcb.apcb010 = l_ar[1].chr
      IF cl_null(l_apcb.apcb010) THEN LET l_apcb.apcb010 = l_apca.apca015 END IF #180730-00034#1 add 來源單未取到資訊時,以單頭帶入
      LET l_apcb.apcb011 = l_ar[2].chr
      #200805-00007#1 add -s
      #入库和仓退时，费用料件理由码和部门取值
      IF l_apcb.apcb001 = '11' OR l_apcb.apcb001 = '21' THEN
         LET l_apcb010 = NULL
         CALL s_aapp320_get_apba021(l_apcb.apcb002,l_apcb.apcb003,l_apcb.apcb004) RETURNING l_apcb.apcb014,l_apcb010
         IF NOT cl_null(l_apcb010) THEN
            LET l_apcb.apcb010 = l_apcb010
         END IF
      END IF
      #200805-00007#1 add -e
      SELECT imaa009 INTO l_apcb.apcb012
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_apcb.apcb004
      LET l_apcb.apcb013 = 'N'
     #LET l_apcb.apcb015 = l_apca.apca033    #專案編號       #170306-00050#1 mark
      LET l_apcb.apcb015 = l_pmdt072         #專案編號       #170306-00050#1 add
      LET l_apcb.apcb017 = l_apca.apca059    #預算編號
      #191226-00040#3---add---(S)
      IF l_oodb011 = '2' THEN #依料件設置  #191226-00040#7 mark #200402-00022#8 remark
     #IF l_oodb011 = '2' AND l_sfin3012 = '2' THEN #191226-00040#7 add #200402-00022#8 mark     
         LET l_apcb.apcb020 = l_apba.apba015        #稅別 
      ELSE
      #191226-00040#3---add---(E)
         LET l_apcb.apcb020 = l_apbb.apbb012    #稅別 
      END IF #191226-00040#3 add
      #150310 sam:客户有委外入库的科目是没办法按成本分群抓;因此先按aapi011中抓，抓不到再根据成本分群
      LET l_acctype = 1

      IF l_pmds000 MATCHES '1[12345]' OR l_pmds000 = '20' THEN   #抓加工科目   #150629-00038#1 add 17181920
         #LET l_acctype = 16      #16類為glcc001 = 1/抓glcc005   #190103-00077#1 mark
         #190103-00077#1-(S) add
         IF l_pmdt005 = '8' THEN    #委外代買
            LET l_acctype = 1       #1類為glcc001 = 1/抓glcc002
         ELSE         
            LET l_acctype = 16      #16類為glcc001 = 1/抓glcc005
         END IF
         #190103-00077#1-(E) add
      END IF
      
      
      
      #170417-00017#1--add--str--lujh
      ##單身存貨科目取得規則：
      ##1.若料件類別=E:費用/軟體，入庫單有理由碼(ACC:312)，則用入庫單理由碼+業務部門去agli180取
      ##2.若取不到，則放單頭存貨科目
      ##抓取入庫單的理由碼
      #IF l_apcb.apcb001 MATCHES '[12]1' THEN
      #   SELECT pmdt051 INTO l_pmdt051
      #     FROM pmdt_t
      #    WHERE pmdtent = g_enterprise
      #      AND pmdtdocno = l_apcb.apcb002
      #      AND pmdtseq = l_apcb.apcb003
      #      AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
      #                         AND imaa001 = pmdt006 and imaa004 ='E')
      #   IF NOT cl_null(l_pmdt051) THEN
      #      CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'312',l_pmdt051,p_ld,'11',l_apca.apcadocdt)
      #           RETURNING g_sub_success,l_apcb.apcb021,g_errno
      #   END IF
      #END IF
      #
      #IF cl_null(l_apcb.apcb021) THEN 
      #170417-00017#1--add--str--lujh
      
      #161104-00049#6 add ------
      #單身存貨科目取得規則：
      #1.若料件類別=E:費用/軟體，入庫單有理由碼(ACC:312)，則用入庫單理由碼+業務部門去agli180取
      #2.若1.取不到，擇用帳款類別+帳套去aapi011取存貨科目(SCC:8504)
      #3.若2.也取不到，則放單頭存貨科目
#      IF l_pmds100 <> '4' THEN   #190220-00035#1 add  #190731-00005#1 mark
      IF l_pmds100 <> '4' OR (l_pmds100 = '4' AND l_pmds000 = '14' ) THEN   #190731-00005#1 add
   #     IF l_apcb.apcb001 MATCHES '[12]1' THEN   #170620-00129#1 mark　#170822-00026#1 remark   #181203-00041#1---mark
         IF l_apcb.apcb001 MATCHES '[12]1' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN   #181203-00041#1---add
         #IF l_apcb.apcb001 = '21' THEN            #170620-00129#1 add #170822-00026#1 mark        
            #抓取入庫單的理由碼
            SELECT pmdt051 INTO l_pmdt051
              FROM pmdt_t
             WHERE pmdtent = g_enterprise
               AND pmdtdocno = l_apcb.apcb002
               AND pmdtseq = l_apcb.apcb003
               AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                  AND imaa001 = pmdt006 and imaa004 ='E')
            
            
            IF NOT cl_null(l_pmdt051) THEN
               #180910-00069#1 add begin---
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
               #190305-00001#2   add-E
                  IF cl_null(l_apca.apca015) AND not cl_null(l_apcb.apcb010) THEN
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apcb.apcb010,'312',l_pmdt051,
                                                              l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  ELSE 
                  #180910-00069#1 add end------
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'312',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  END IF  #180910-00069#1 add
               END IF   #190305-00001#2 add
            END IF
            
            #191010-00012#1---add---str
            #理由码抓取顺序是入库单/仓退单 > 收货单 >采购单 >请购单
            IF cl_null(l_pmdt051) THEN #理由码为空找上一个单据
               LET l_pmds006 = ''
               SELECT DISTINCT pmds006 INTO l_pmds006
                 FROM pmdt_t,pmds_t
                WHERE pmdtent = pmdsent
                  AND pmdtdocno = pmdsdocno
                  AND pmdtent = g_enterprise
                  AND pmdtdocno = l_apcb.apcb002
                  AND pmdtseq = l_apcb.apcb003
                  AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                     AND imaa001 = pmdt006 and imaa004 ='E')
               IF NOT cl_null(l_pmds006) THEN  #不为空说明他有收货单，在去找收货单的理由吗
                  #抓取收货單的理由碼
                  SELECT pmdt051 INTO l_pmdt051
                    FROM pmdt_t
                   WHERE pmdtent = g_enterprise
                     AND pmdtdocno = l_pmds006
                     AND pmdtseq = l_apcb.apcb003
                     AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdt006 and imaa004 ='E')   
               END IF
               IF cl_null(l_pmdt051) THEN #如果上面的IF还是空需要去找采购单的理由码
                   LET l_pmdt001 = ''
                   LET l_pmdt002 = ''
                   SELECT pmdt001,pmdt002 INTO l_pmdt001,l_pmdt002
                     FROM pmdt_t
                    WHERE pmdtent = g_enterprise
                      AND pmdtdocno = l_apcb.apcb002
                      AND pmdtseq = l_apcb.apcb003
                      AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdt006 AND imaa004 ='E')
                  SELECT pmdn049 INTO l_pmdt051
                    FROM pmdn_t
                   WHERE pmdnent = g_enterprise
                     AND pmdnseq = l_pmdt002
                     AND pmdndocno = l_pmdt001
                     AND pmdn001 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdn001 AND imaa004 ='E')   
                  IF cl_null(l_pmdt051) THEN #如果上面的IF还是空需要去找请购单的理由码
                     SELECT pmdl008 INTO l_pmdl008
                       FROM pmdl_t
                      WHERE pmdlent = g_enterprise
                        AND pmdldocno = l_pmdt001
                     IF NOT cl_null(l_pmdl008) THEN
                        SELECT pmdb031 INTO l_pmdt051
                          FROM pmdb_t
                         WHERE pmdbent = g_enterprise
                           AND pmdbdocno =  l_pmdl008
                           AND pmdbseq =  l_pmdt002 
                           AND pmdb004 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdb004 AND imaa004 ='E')                              
                     END IF
                     IF NOT cl_null(l_pmdt051) THEN
                        #190305-00001#2   add-S
                        IF l_apcb.apcb001 = '21' THEN
                           LET l_type = ''
                           IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                           IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                           CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                              RETURNING g_sub_success,l_apcb.apcb021
                        END IF
                        IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
                        #190305-00001#2   add-E
                           #请购单理由码
                           CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'265',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                           RETURNING g_sub_success,l_apcb.apcb021,g_errno
                        END IF   #190305-00001#2 add
                     END IF
                  ELSE
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
                     #190305-00001#2   add-E
                        #采购单理由码
                        CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'265',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                        RETURNING g_sub_success,l_apcb.apcb021,g_errno
                     END IF   #190305-00001#2 add
                  END IF
               ELSE
                  #190305-00001#2   add-S
                  IF l_apcb.apcb001 = '21' THEN
                     LET l_type = ''
                     IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                     IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                     CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                        RETURNING g_sub_success,l_apcb.apcb021
                  END IF
                  IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
                  #190305-00001#2   add-E
                     #收货单有理由码
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'269',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  END IF   #190305-00001#2 add
               END IF                 
            END IF
            #191010-00012#1---add---end
            
            
        #END IF             #170620-00129#1 mark
            IF cl_null(l_apcb.apcb021) THEN
            #161104-00049#6 add end---
               #CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,'','','','')    #160120-00011#2 mark
               IF cl_null(l_pmds013) THEN LET l_pmds013 = l_apca.apca058 END IF      #160120-00011#2
               
               #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                  
                  FOREACH s_aapp131_pmdu006_c2 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF

               #190815-00012#1---add---end
               
               #190812-00010#5 add s---#销售分群aimm214
               IF NOT cl_null(l_apcb.apcb004) THEN 
                  IF NOT cl_null(l_imaf141) THEN
                     LET l_kind = l_pmds013,"@",l_imaf141
                  ELSE 
                     LET l_kind = l_pmds013            
                  END IF  
               END IF            
               #190812-00010#5 add e---                
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
                  CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)   #160120-00011#2  #190812-00010#5 mod l_pmds013-->l_kind 
                           RETURNING g_sub_success,l_apcb.apcb021
               END IF   #190305-00001#2 add         
               #170526-00019#1--add--str--lujh
               SELECT imaa004 INTO l_imaa004
                 FROM imaa_t
                WHERE imaaent = g_enterprise
                  AND imaa001 = l_apcb.apcb004
               IF l_imaa004 = 'E' THEN 
                  SELECT imag011 INTO l_imag011
                    FROM imag_t
                   WHERE imagent = g_enterprise
                     AND imagsite = l_apca.apcacomp
                     #AND imag011 = l_apcb.apcb004  #170822-00003#1 mark
                     AND imag001 = l_apcb.apcb004   #170822-00003#1 add
                  IF cl_null(l_imag011) THEN
                     LET l_apcb.apcb021 = ''
                  END IF
               END IF
               #170526-00019#1--add--end--lujh
            END IF  #161104-00049#6
            #170417-00017#1--add--str--lujh
            #   SELECT imaa004 INTO l_imaa004
            #     FROM imaa_t
            #    WHERE imaaent = g_enterprise
            #      AND imaa001 = l_apcb.apcb004
            #   IF l_imaa004 = 'E' THEN 
            #      SELECT imag011 INTO l_imag011
            #        FROM imag_t
            #       WHERE imagent = g_enterprise
            #         AND imagsite = l_apca.apcacomp
            #         AND imag011 = l_apcb.apcb004
            #      IF cl_null(l_imag011) THEN
            #         LET l_apcb.apcb021 = ''
            #      END IF
            #   END IF
            #END IF
            #170417-00017#1--add--end--lujh
            IF cl_null(l_apcb.apcb021) THEN
               LET l_apcb.apcb021 = l_apca.apca036    #費用會計科目
            END IF         
         END IF      #170620-00129#1 add  
      #190220-00035#1---add---str--
      ELSE
         #190812-00010#5 add s---#销售分群aimm214
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         #190812-00010#5 add e---       
         #4:倉退折讓(純金額折讓),單身科目先抓agli161抓不到在直接取aapi011的"折讓科目"(因為會影響成本)
         #190305-00001#2   add-S
         IF l_apcb.apcb001 = '21' THEN
            LET l_type = ''
            IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
            IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
            CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
         #190305-00001#2   add-E
            #190806-00046#1 add(s)
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF   #190305-00001#2 add
         IF cl_null(l_apcb.apcb021) THEN
         #190806-00046#1 add(e)         
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
         END IF #190806-00046#1 add
      END IF  
      #190220-00035#1---add---end--
      
       #190813-00006#1---add----str
      #仓退单对应账款单单身科目抓取，单头科目维持原逻辑（单头科目从aapi011抓取）
      #纯金额折让  依apmt580单身料号性质判断是取agli161还是aapi011
      #料号性质=A或M   先取agli161，取不到再取aapi011折让科目（此时折让需纳入成本计算，折让科目维护的就是存货科目）
      #        ELSE 直接取aapi011折让科目（此时折让不需纳入成本计算，折让科目一般维护的就是费用科目）
      #非纯金额折让   先取agli161，取不到再取aapi011仓退科目（不看料号性质）（此种仓退需纳入成本计算，仓退科目维护的就是存货科目）
         
      IF l_pmds000 = '7' OR l_pmds000 = '14' OR l_pmds000 = '15' THEN
         LET l_apcb.apcb021 = ''
         IF l_pmds100 = '4' THEN # 纯金额折让
            LET l_cnt = 0
            #判断料件类别是否是A或M
            SELECT COUNT(*) INTO l_cnt
                 FROM pmdt_t
                WHERE pmdtent = g_enterprise
                  AND pmdtdocno = l_apcb.apcb002
                  AND pmdtseq = l_apcb.apcb003
                  AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別
                                     AND imaa001 = pmdt006 and (imaa004 ='A' OR imaa004 ='M'))
            IF cl_null(l_cnt) THEN
               LET l_cnt = 0
            END IF
            IF l_cnt > 0 THEN
               #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                  
                  FOREACH s_aapp131_pmdu006_c2 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF

               #190815-00012#1---add---end
               #190812-00010#5 add s---#销售分群aimm214
               IF NOT cl_null(l_apcb.apcb004) THEN 
                  IF NOT cl_null(l_imaf141) THEN
                     LET l_kind = l_pmds013,"@",l_imaf141
                  ELSE 
                     LET l_kind = l_pmds013            
                  END IF  
               END IF            
               #190812-00010#5 add e---                  
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
               #大于0说明料件类别 = A:组合/加工品 或 M:材料/零件/商品
                  CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                        RETURNING g_sub_success,l_apcb.apcb021
               END IF   #190305-00001#2 add
               IF cl_null(l_apcb.apcb021) THEN
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF 
            ELSE
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF   #190305-00001#2 add
            END IF
         ELSE    # 非纯金额折让
             #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                  
                  FOREACH s_aapp131_pmdu006_c2 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF
               #190812-00010#5 add s---#销售分群aimm214
               IF NOT cl_null(l_apcb.apcb004) THEN 
                  IF NOT cl_null(l_imaf141) THEN
                     LET l_kind = l_pmds013,"@",l_imaf141
                  ELSE 
                     LET l_kind = l_pmds013            
                  END IF  
               END IF            
               #190812-00010#5 add e---  
               #190815-00012#1---add---end
             #190305-00001#2   add-S
             IF l_apcb.apcb001 = '21' THEN
                LET l_type = ''
                IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                   RETURNING g_sub_success,l_apcb.apcb021
             END IF
             IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
             #190305-00001#2   add-E
                CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                        RETURNING g_sub_success,l_apcb.apcb021
             END IF   #190305-00001#2 add
               IF cl_null(l_apcb.apcb021) THEN
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_24') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF 
         END IF
      END IF
      #190813-00006#1---add----str
        #210204-00021#1---add----str
      #委外仓退也取agli161的加工费科目抓不到在直接取aapi011的"折讓科目"
      IF l_pmds100 = '4' AND l_pmds000 = '14' THEN
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         
         IF l_apcb.apcb001 = '21' THEN
            #委外加工费科目               
            CALL s_get_item_acc(l_apcb.apcbld,'16',l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) 
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF  
         IF cl_null(l_apcb.apcb021) THEN
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
         END IF 
      END IF
      #210204-00021#1---add----end
      #181204-00009#1---add---start---
      #來源類型為19：其他加項或29：其他減項，要由aapt110單身理由碼去抓取預設的科目給到費用科目
      IF l_apcb.apcb001 MATCHES '[12]9' THEN
         IF cl_null(l_apcb.apcb010) THEN
            CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'3212',l_apcb.apcb014,  
                                                        l_apca.apcald,'11',l_apca.apcadocdt)
               RETURNING g_sub_success,l_apcb.apcb021,g_errno                     
         ELSE
            CALL s_fin_dept_reasons_with_ld_get_account(l_apcb.apcb010,'3212',l_apcb.apcb014,  
                                                        l_apca.apcald,'11',l_apca.apcadocdt)
               RETURNING g_sub_success,l_apcb.apcb021,g_errno                 
         END IF      
      END IF
      #181204-00009#1---add---end---
      IF cl_null(l_apcb.apcb021) THEN LET l_apcb.apcb021 = l_apca.apca036 END IF   #171225-00022#1  #費用會計科目  
#      #200107-00023#1--mark--str
#      #170930-00003#1 --s add
#      IF l_apcb.apcb001 = '13' THEN
#         LET l_apcb.apcb021 = l_apca.apca035   
#      END IF
#      #170930-00003#1 --e add
#      #200107-00023#1--mark--end  
      #200107-00023#1--add--end 
      IF l_apcb.apcb001 = '13' THEN 
         CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
      END IF
      #200107-00023#1--add--end
      #200805-00007#1 add -s
      #费用料件理由码不为空时优先根据理由码取科目
      IF (l_apcb.apcb001 = '11' OR l_apcb.apcb001 = '21') AND NOT cl_null(l_apcb.apcb014) AND NOT cl_null(l_apcb010) THEN
         LET l_apcb021 = NULL
         CALL s_fin_dept_reasons_with_ld_get_account(l_apcb010,'3212',l_apcb.apcb014,l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb021,g_errno
         IF NOT cl_null(l_apcb021) THEN
            LET l_apcb.apcb021 = l_apcb021
         END IF
      END IF
      #200805-00007#1 add -e    
      IF g_type = '7' THEN LET l_apcb.apcb021 = l_apca.apca036 END IF #170706-00015#1 add
      LET l_apcb.apcb022 = l_apba.apba012    #正負值
      #判別是否沖暫估
      LET l_apcb.apcb023 = 'N'
      IF l_apcb.apcb001 MATCHES '[12]6' THEN
         #批次作業, 發票單身(aist310/aapt110)有輸入來源別為16/26者，則處理自動沖其他暫估單
         LET l_apcb.apcb023 = 'Y'
      ELSE
         #可依據同幣別沖暫估
         #170527-00015#1---mark---str--
         #LET l_cnt = 0
         ##SELECT count(*) INTO l_cnt        #161114-00009#1 mark
         #SELECT count(apcadocno) INTO l_cnt #161114-00009#1 add
         #  FROM apca_t,apcb_t,apcc_t
         # WHERE apcaent = apcbent AND apcaent = apccent AND apcald = apcbld AND apcald = apccld
         #   AND apcadocno=apcbdocno AND apcadocno = apccdocno AND apcc108 - apcc109 <> 0
         #   AND apcastus = 'Y'      AND apca001 IN ('01','02')
         #   AND apcaent = g_enterprise   AND apcald = p_ld
         #   AND apcb002 = l_apba.apba005 AND apcb003 = l_apba.apba006
         #IF l_cnt > 0 THEN
         #   LET l_apcb.apcb023 = 'Y'
         #END IF
         #170527-00015#1---mark---end--
         #170527-00015#1---add---str--
         LET l_apcb007 = 0
         LET l_apcb0071 = 0
         SELECT apcb007 INTO l_apcb007   #aapt320立暫估數量
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcald = apcbld
            AND apcadocno = apcbdocno
            AND apcastus = 'Y'
            AND apca001 IN ('01','02')
            AND apcaent = g_enterprise AND apcald = p_ld
            AND apcb002 = l_apba.apba005 AND apcb003 = l_apba.apba006
            AND apcadocdt <= l_apca.apcadocdt   #170617-00182#1 add

         SELECT apcb007 INTO l_apcb0071   #aapt300沖暫估數量
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcald = apcbld
            AND apcadocno = apcbdocno
            AND apcastus <> 'X'
            AND apca001 NOT IN ('01','02')
            AND apcb023 = 'Y'
            AND apcaent = g_enterprise AND apcald = p_ld
            AND apcb002 = l_apba.apba005 AND apcb003 = l_apba.apba006
         IF cl_null(l_apcb007) THEN LET l_apcb007 = 0 END IF
         IF cl_null(l_apcb0071) THEN LET l_apcb0071 = 0 END IF
        #IF l_apcb007 - l_apcb0071 > 0 THEN   #200916-00030#1 mark
         IF l_apcb007 - l_apcb0071 <> 0 THEN  #200916-00030#1 add
            LET l_apcb.apcb023 = 'Y'
         END IF
        #170527-00015#1---add---end--
      END IF
      LET l_apcb.apcb027 = l_apbb.apbb009
      
      LET l_apcb.apcb028 = l_apba.apba017                                        #170619-00037#1  add
      IF cl_null(l_apba.apba017) THEN LET l_apcb.apcb028 = l_apbb.apbb010 END IF #170619-00037#1  add
      #LET l_apcb.apcb028 = l_apbb.apbb010                                       #170619-00037#1  mark 
      LET l_apcb.apcb029 = l_apca.apca035    #應付會計科目  
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb034 = l_pmds012            #160120-00011#2
      #Belle 14/11/20若為沖銷參數三時,無法知道 新增時的付款條件因此要以tmp的付款條件為主
      IF p_sfin2002 = '3' AND cl_null(l_apca.apca008) THEN
         SELECT pmds031 INTO l_apcb.apcb030
           FROM s_aapp131_tmp_g
          WHERE pmdtdocno = l_tmp.pmdtdocno AND pmdtseq = l_tmp.pmdtseq
      END IF
      #Belle 14/11/20
      
      LET l_apcb.apcb049 = l_apba.apbadocno
      LET l_apcb.apcb050 = l_apba.apbaseq
      LET l_apcb.apcb051 = l_ar[3].chr
      IF cl_null(l_apcb.apcb051) THEN LET l_apcb.apcb051 = l_apca.apca014 END IF #180730-00034#1 add 來源單未取到資訊時,以單頭帶入
      LET l_apcb.apcb100 = l_apca.apca100    #幣別
      LET l_apcb.apcb101 = l_apba.apba014    #單價
     #CALL s_curr_round_ld('1',p_ld,l_apcb.apcb100,l_apcb.apcb101,1) RETURNING g_sub_success,g_errno,l_apcb.apcb101 #140806-00012#12   #170430-00006#2 mark
      CALL s_num_round(g_round_type,l_apcb.apcb101,g_ooaj003) RETURNING l_apcb.apcb101         #170430-00006#2 add
      LET l_apcb.apcb102 = l_apca.apca101    #本幣匯率
      
      
      LET l_apcb105 = l_apcb.apcb007 * l_apcb.apcb101
      #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcb105,2) RETURNING g_sub_success,g_errno,l_apcb105    #140806-00012#12    #170320-00033 mark
     #CALL s_curr_round_ld('1',p_ld,l_apcb.apcb100,l_apcb105,2) RETURNING g_sub_success,g_errno,l_apcb105    #170320-00033    #170430-00006#2 mark
      CALL s_num_round(g_round_type,l_apcb105,g_ooaj004) RETURNING l_apcb105      #170430-00006#2 add
      
     #CALL s_tax_ins(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,    #160519-00011#1 mark
      CALL s_tax_ins2(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,   #160519-00011#1 
                     l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apca.apca101,p_ld,l_apca.apca121,l_apca.apca131)
           RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                     l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                     l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                     l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
                     

     #LET l_apcb.apcb111 = l_apcb.apcb101 * l_apca.apca101     #本幣單價  #170430-00006#2 mark

     #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcb.apcb111,1) RETURNING g_sub_success,g_errno,l_apcb.apcb111 #140806-00012#12 #170430-00006#2 mark
      LET l_apcb.apcb121 = l_apca.apca121
      LET l_apcb.apcb131 = l_apca.apca131
      #全部數量立帳者,取得來源對帳單原幣及本幣金額立帳#141204-00017#1-str--
      IF l_flag  AND l_ld_type = '1' THEN
         CALL s_aapp131_entire_amount('2',l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb002,
                                       l_apcb.apcb003,l_apcb.apcb049,l_apcb.apcb050,l_apcb.apcb103,l_apcb.apcb104,
                                       l_apcb.apcb105,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,l_apca.apca101) 
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115 
         #200210-00028#1--add---str
         #如果汇率是1，本币单价就需要推算，直接取原币单价
         IF l_apca.apca101 = 1 THEN
            LET l_apcb.apcb111 = l_apcb.apcb101           
         ELSE
         #200210-00028#1--add---end
            #150930-00012-----s      
            #對帳單拋帳款
            #aapp320差異處理的本幣單價換算:
            #產生到aapt300單身時,原本是取原幣單價*匯率,但因為已經作了調整差異處理,此時的本幣單價要由本幣金額反算出來
            #1.判斷是由aapt110產生的帳款(aapp132)
            #2.依稅別的含稅與否判斷:
            #  含稅時, 取本幣含稅金額/數量, 幣別取位
            #  不含稅時, 取本幣未稅金額/數量, 幣別取位
            IF l_oodb005 = 'Y' THEN
               LET l_apcb.apcb111 = l_apcb.apcb115 / l_apcb.apcb007
            ELSE
               LET l_apcb.apcb111 = l_apcb.apcb113 / l_apcb.apcb007
            END IF         
            #150930-00012-----e
         END IF #200210-00028#1--add
      ELSE      #170430-00006#2 add
         LET l_apcb.apcb111 = l_apcb.apcb101 * l_apca.apca101     #本幣單價      #170430-00006#2 add
      END IF
      #141204-00017#1-end--
      LET l_apcb.apcb107 = 0  LET l_apcb.apcb108 = l_apcb.apcb103  
      LET l_apcb.apcb117 = 0  LET l_apcb.apcb118 = l_apcb.apcb113  LET l_apcb.apcb119 = 0
      LET l_apcb.apcb127 = 0  LET l_apcb.apcb128 = l_apcb.apcb123
      LET l_apcb.apcb137 = 0  LET l_apcb.apcb138 = l_apcb.apcb133     
     #170430-00006#2---mark---start---
     #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcb.apcb111,1) RETURNING g_sub_success,g_errno,l_apcb.apcb111
     #CALL s_aapp131_get_apcb1x6(l_apcb.*) RETURNING l_apcb.apcb106,l_apcb.apcb116,l_apcb.apcb126,l_apcb.apcb136  #160120-00011#2 
     #170430-00006#2---mark---end--- 
     #170430-00006#2---add---start---     
     CALL s_num_round(g_round_type,l_apcb.apcb111,g_ooaj003_g) RETURNING l_apcb.apcb111      
     CALL s_aapp131_get_apcb1x6(l_apcb.*,g_round_type,g_ooaj004,g_ooaj004_g,g_ooaj004_g2,g_ooaj004_g3) 
      RETURNING l_apcb.apcb106,l_apcb.apcb116,l_apcb.apcb126,l_apcb.apcb136  
     #170430-00006#2---add---end---
     #INSERT INTO apcb_t VALUES(l_apcb.*) #161111-00048#2 mark
      
      #180323-00042#1 -s 180404 add by 08172
      #账款对象
      LET l_apcb.apcb054 = l_apca.apca004
      #付款对象
      LET l_apcb.apcb055 = l_apca.apca005
      #180323-00042#1 -e 180404 add by 08172
      
      #180705-00083#1 add -s
      IF cl_null(l_apcb.apcb051) THEN
         LET l_apcb.apcb051 = l_apca.apca014
      END IF
      IF cl_null(l_apcb.apcb010) THEN
         LET l_apcb.apcb010 = l_apca.apca015
      END IF
      #固定核算项默认值
      INITIALIZE l_apcb2.* TO NULL
      LET l_apcb2.apcb054 = l_apcb.apcb054
      LET l_apcb2.apcb055 = l_apcb.apcb055
      LET l_apcb2.apcb051 = l_apcb.apcb051
      LET l_apcb2.apcb010 = l_apcb.apcb010
      LET l_apcb2.apcb011 = l_apcb.apcb011
      LET l_apcb2.apcb024 = l_apcb.apcb024
      LET l_apcb2.apcb036 = l_apcb.apcb036
      LET l_apcb2.apcb012 = l_apcb.apcb012
      LET l_apcb2.apcb033 = l_apcb.apcb033
      LET l_apcb2.apcb034 = l_apcb.apcb034
      LET l_apcb2.apcb035 = l_apcb.apcb035
      LET l_apcb2.apcb015 = l_apcb.apcb015
      LET l_apcb2.apcb016 = l_apcb.apcb016
      CALL s_aapp131_get_accitem(l_apcb.apcbld,l_apcb.apcb021,l_apcb.apcb029,p_xrcd009,l_apcb2.*)
         RETURNING l_apcb.apcb054,l_apcb.apcb055,l_apcb.apcb051,l_apcb.apcb010,l_apcb.apcb011,
                   l_apcb.apcb024,l_apcb.apcb036,l_apcb.apcb012,l_apcb.apcb033,l_apcb.apcb034,
                   l_apcb.apcb035,l_apcb.apcb015,l_apcb.apcb016
     #180705-00083#1 add -e
     
     #190423-00042#1---s--- #依專案進行帳務管理否
     #190423-00042#38---mark---(S)
     #LET l_sfin9025 = ''
     #CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-9025') RETURNING l_sfin9025
     #IF cl_null(l_sfin9025) THEN LET l_sfin9025 = 'N' END IF
     #IF l_sfin9025 = 'Y' THEN
     #190423-00042#38---mark---(E)
     #190423-00042#38---add---(S)
     LET l_sfin9026 = ''
     CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-9026') RETURNING l_sfin9026
     IF cl_null(l_sfin9026) THEN LET l_sfin9026 = 'N' END IF
     IF l_sfin9026 = 'Y' THEN
     #190423-00042#38---add---(E)
        LET l_apcb.apcb015 = l_apba.apba022 
        LET l_apcb.apcb016 = l_apba.apba023 
     END IF        
     #190423-00042#1 ---e---         
      
      #161102-00015#7 --s add
      IF cl_null(l_apcb.apcb010) THEN LET l_apcb.apcb010 = " " END IF  #業務部門
      IF cl_null(l_apcb.apcb011) THEN LET l_apcb.apcb011 = " " END IF  #責任中心
      IF cl_null(l_apcb.apcb012) THEN LET l_apcb.apcb012 = " " END IF  #產品類別
      IF cl_null(l_apcb.apcb015) THEN LET l_apcb.apcb015 = " " END IF  #專案編號
      IF cl_null(l_apcb.apcb016) THEN LET l_apcb.apcb016 = " " END IF  #WBS編號
      IF cl_null(l_apcb.apcb024) THEN LET l_apcb.apcb024 = " " END IF  #區域
      IF cl_null(l_apcb.apcb030) THEN LET l_apcb.apcb030 = " " END IF  #付款條件
      IF cl_null(l_apcb.apcb033) THEN LET l_apcb.apcb033 = " " END IF  #經營方式
      IF cl_null(l_apcb.apcb034) THEN LET l_apcb.apcb034 = " " END IF  #通路
      IF cl_null(l_apcb.apcb035) THEN LET l_apcb.apcb035 = " " END IF  #品牌
      IF cl_null(l_apcb.apcb036) THEN LET l_apcb.apcb036 = " " END IF  #客群
      IF cl_null(l_apcb.apcb037) THEN LET l_apcb.apcb037 = " " END IF  #自由核算項一
      IF cl_null(l_apcb.apcb038) THEN LET l_apcb.apcb038 = " " END IF  #自由核算項二
      IF cl_null(l_apcb.apcb039) THEN LET l_apcb.apcb039 = " " END IF  #自由核算項三
      IF cl_null(l_apcb.apcb040) THEN LET l_apcb.apcb040 = " " END IF  #自由核算項四
      IF cl_null(l_apcb.apcb041) THEN LET l_apcb.apcb041 = " " END IF  #自由核算項五
      IF cl_null(l_apcb.apcb042) THEN LET l_apcb.apcb042 = " " END IF  #自由核算項六
      IF cl_null(l_apcb.apcb043) THEN LET l_apcb.apcb043 = " " END IF  #自由核算項七
      IF cl_null(l_apcb.apcb044) THEN LET l_apcb.apcb044 = " " END IF  #自由核算項八
      IF cl_null(l_apcb.apcb045) THEN LET l_apcb.apcb045 = " " END IF  #自由核算項九
      IF cl_null(l_apcb.apcb046) THEN LET l_apcb.apcb046 = " " END IF  #自由核算項十
      IF cl_null(l_apcb.apcb051) THEN LET l_apcb.apcb051 = " " END IF  #業務人員
      IF cl_null(l_apcb.apcb054) THEN LET l_apcb.apcb054 = " " END IF  #帳款對象
      IF cl_null(l_apcb.apcb055) THEN LET l_apcb.apcb055 = " " END IF  #付款對象
      #161102-00015#7 --e add     
      #170510-00041#1---s--- 取得科目所對應的預算係項
      LET l_apcb.apcb017 = ''      
      SELECT pmdt075 INTO l_apcb.apcb017 FROM pmdt_t WHERE pmdtent = g_enterprise 
         AND pmdtdocno = l_apcb.apcb002 AND pmdtseq = l_apcb.apcb003
      IF cl_null(l_apcb.apcb017) THEN      
         SELECT bgao004 INTO l_apcb.apcb017  FROM bgao_t
          WHERE bgaoent = g_enterprise
            AND bgao001 = (SELECT DISTINCT bgaa008 FROM bgaa_t WHERE bgaaent = g_enterprise AND bgaa001 = l_apca.apca059 )        
            AND bgao002 = (SELECT glaa004 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = l_apcb.apcbld)
            AND bgao003 =l_apcb.apcb021   
      END IF            
      #170510-00041#1---e--- 取得科目所對應的預算係項  
      IF l_apba.apba004 = '16' THEN LET l_apcb.apcb001 = '19' END IF  #180821-00038#11 add
      IF l_apba.apba004 = '26' THEN LET l_apcb.apcb001 = '29' END IF  #180821-00038#11 add
     #170430-00006#2---mark---start---      
     ##161111-00048#2 --s add
     #INSERT INTO apcb_t(apcbent,apcbld,apcblegl,apcborga,apcbsite,
     #                   apcbdocno,apcbseq,apcb001,apcb002,apcb003,
     #                   apcb004,apcb005,apcb006,apcb007,apcb008,
     #                   apcb009,apcb010,apcb011,apcb012,apcb013,
     #                   apcb014,apcb015,apcb016,apcb017,apcb018,
     #                   apcb019,apcb020,apcb021,apcb022,apcb023,
     #                   apcb024,apcb025,apcb026,apcb027,apcb028,
     #                   apcb029,apcb030,apcb032,apcb033,apcb034,
     #                   apcb035,apcb036,apcb037,apcb038,apcb039,
     #                   apcb040,apcb041,apcb042,apcb043,apcb044,
     #                   apcb045,apcb046,apcb047,apcb048,apcb049,
     #                   apcb050,apcb051,apcb100,apcb101,apcb102,
     #                   apcb103,apcb104,apcb105,apcb106,apcb107,
     #                   apcb108,apcb111,apcb113,apcb114,apcb115,
     #                   apcb116,apcb117,apcb118,apcb119,apcb121,
     #                   apcb123,apcb124,apcb125,apcb126,apcb127,
     #                   apcb128,apcb131,apcb133,apcb134,apcb135,
     #                   apcb136,apcb137,apcb138,apcbud001,apcbud002,
     #                   apcbud003,apcbud004,apcbud005,apcbud006,apcbud007,
     #                   apcbud008,apcbud009,apcbud010,apcbud011,apcbud012,
     #                   apcbud013,apcbud014,apcbud015,apcbud016,apcbud017,
     #                   apcbud018,apcbud019,apcbud020,apcbud021,apcbud022,
     #                   apcbud023,apcbud024,apcbud025,apcbud026,apcbud027,
     #                   apcbud028,apcbud029,apcbud030,apcb052,apcb053,
     #                   apcb054,apcb055)
     #VALUES(l_apcb.apcbent,l_apcb.apcbld,l_apcb.apcblegl,l_apcb.apcborga,l_apcb.apcbsite,
     #       l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003,
     #       l_apcb.apcb004,l_apcb.apcb005,l_apcb.apcb006,l_apcb.apcb007,l_apcb.apcb008,
     #       l_apcb.apcb009,l_apcb.apcb010,l_apcb.apcb011,l_apcb.apcb012,l_apcb.apcb013,
     #       l_apcb.apcb014,l_apcb.apcb015,l_apcb.apcb016,l_apcb.apcb017,l_apcb.apcb018,
     #       l_apcb.apcb019,l_apcb.apcb020,l_apcb.apcb021,l_apcb.apcb022,l_apcb.apcb023,
     #       l_apcb.apcb024,l_apcb.apcb025,l_apcb.apcb026,l_apcb.apcb027,l_apcb.apcb028,
     #       l_apcb.apcb029,l_apcb.apcb030,l_apcb.apcb032,l_apcb.apcb033,l_apcb.apcb034,
     #       l_apcb.apcb035,l_apcb.apcb036,l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,
     #       l_apcb.apcb040,l_apcb.apcb041,l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,
     #       l_apcb.apcb045,l_apcb.apcb046,l_apcb.apcb047,l_apcb.apcb048,l_apcb.apcb049,
     #       l_apcb.apcb050,l_apcb.apcb051,l_apcb.apcb100,l_apcb.apcb101,l_apcb.apcb102,
     #       l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb106,l_apcb.apcb107,
     #       l_apcb.apcb108,l_apcb.apcb111,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
     #       l_apcb.apcb116,l_apcb.apcb117,l_apcb.apcb118,l_apcb.apcb119,l_apcb.apcb121,
     #       l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,l_apcb.apcb126,l_apcb.apcb127,
     #       l_apcb.apcb128,l_apcb.apcb131,l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135,
     #       l_apcb.apcb136,l_apcb.apcb137,l_apcb.apcb138,l_apcb.apcbud001,l_apcb.apcbud002,
     #       l_apcb.apcbud003,l_apcb.apcbud004,l_apcb.apcbud005,l_apcb.apcbud006,l_apcb.apcbud007,
     #       l_apcb.apcbud008,l_apcb.apcbud009,l_apcb.apcbud010,l_apcb.apcbud011,l_apcb.apcbud012,
     #       l_apcb.apcbud013,l_apcb.apcbud014,l_apcb.apcbud015,l_apcb.apcbud016,l_apcb.apcbud017,
     #       l_apcb.apcbud018,l_apcb.apcbud019,l_apcb.apcbud020,l_apcb.apcbud021,l_apcb.apcbud022,
     #       l_apcb.apcbud023,l_apcb.apcbud024,l_apcb.apcbud025,l_apcb.apcbud026,l_apcb.apcbud027,
     #       l_apcb.apcbud028,l_apcb.apcbud029,l_apcb.apcbud030,l_apcb.apcb052,l_apcb.apcb053,
     #       l_apcb.apcb054,l_apcb.apcb055      
     #161111-00048#2 --e add
     #170430-00006#2---mark---end---
     #180705-00083#1 mark -s
#     #180704-00022#1 add ---s 根據agli043設定預帶自由核算項值     
#     CALL l_array.clear()
#     LET l_array[1].chr = l_apcb.apcb037
#     LET l_array[2].chr = l_apcb.apcb038   
#     LET l_array[3].chr = l_apcb.apcb039
#     LET l_array[4].chr = l_apcb.apcb040
#     LET l_array[5].chr = l_apcb.apcb041
#     LET l_array[6].chr = l_apcb.apcb042
#     LET l_array[7].chr = l_apcb.apcb043
#     LET l_array[8].chr = l_apcb.apcb044
#     LET l_array[9].chr = l_apcb.apcb045
#     LET l_array[10].chr = l_apcb.apcb046      
#     CALL s_aapp131_upd_accitem_free(g_prog1,l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb021,l_apcb.apcb029,l_array)
#     RETURNING l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,l_apcb.apcb040,l_apcb.apcb041,
#               l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,l_apcb.apcb045,l_apcb.apcb046      
#     #180704-00022#1 add ---e
     #180705-00083#1 mark -e
          
     
     #170430-00006#2---add--start---
     EXECUTE s_aapp131_ins_apcb_c USING
            l_apcb.apcbent,l_apcb.apcbld,l_apcb.apcblegl,l_apcb.apcborga,l_apcb.apcbsite,
            l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003,
            l_apcb.apcb004,l_apcb.apcb005,l_apcb.apcb006,l_apcb.apcb007,l_apcb.apcb008,
            l_apcb.apcb009,l_apcb.apcb010,l_apcb.apcb011,l_apcb.apcb012,l_apcb.apcb013,
            l_apcb.apcb014,l_apcb.apcb015,l_apcb.apcb016,l_apcb.apcb017,l_apcb.apcb018,
            l_apcb.apcb019,l_apcb.apcb020,l_apcb.apcb021,l_apcb.apcb022,l_apcb.apcb023,
            l_apcb.apcb024,l_apcb.apcb025,l_apcb.apcb026,l_apcb.apcb027,l_apcb.apcb028,
            l_apcb.apcb029,l_apcb.apcb030,l_apcb.apcb032,l_apcb.apcb033,l_apcb.apcb034,
            l_apcb.apcb035,l_apcb.apcb036,l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,
            l_apcb.apcb040,l_apcb.apcb041,l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,
            l_apcb.apcb045,l_apcb.apcb046,l_apcb.apcb047,l_apcb.apcb048,l_apcb.apcb049,
            l_apcb.apcb050,l_apcb.apcb051,l_apcb.apcb100,l_apcb.apcb101,l_apcb.apcb102,
            l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb106,l_apcb.apcb107,
            l_apcb.apcb108,l_apcb.apcb111,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
            l_apcb.apcb116,l_apcb.apcb117,l_apcb.apcb118,l_apcb.apcb119,l_apcb.apcb121,
            l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,l_apcb.apcb126,l_apcb.apcb127,
            l_apcb.apcb128,l_apcb.apcb131,l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135,
            l_apcb.apcb136,l_apcb.apcb137,l_apcb.apcb138,l_apcb.apcbud001,l_apcb.apcbud002,
            l_apcb.apcbud003,l_apcb.apcbud004,l_apcb.apcbud005,l_apcb.apcbud006,l_apcb.apcbud007,
            l_apcb.apcbud008,l_apcb.apcbud009,l_apcb.apcbud010,l_apcb.apcbud011,l_apcb.apcbud012,
            l_apcb.apcbud013,l_apcb.apcbud014,l_apcb.apcbud015,l_apcb.apcbud016,l_apcb.apcbud017,
            l_apcb.apcbud018,l_apcb.apcbud019,l_apcb.apcbud020,l_apcb.apcbud021,l_apcb.apcbud022,
            l_apcb.apcbud023,l_apcb.apcbud024,l_apcb.apcbud025,l_apcb.apcbud026,l_apcb.apcbud027,
            l_apcb.apcbud028,l_apcb.apcbud029,l_apcb.apcbud030,l_apcb.apcb052,l_apcb.apcb053,
            l_apcb.apcb054,l_apcb.apcb055
     #170430-00006#2---add---end--- 
      #180705-00083#1 add -s
      #自由核算项默认值
      INITIALIZE l_apcb3.* TO NULL
      LET l_apcb3.apcb037= l_apcb.apcb037
      LET l_apcb3.apcb038= l_apcb.apcb038
      LET l_apcb3.apcb039= l_apcb.apcb039
      LET l_apcb3.apcb040= l_apcb.apcb040
      LET l_apcb3.apcb041= l_apcb.apcb041
      LET l_apcb3.apcb042= l_apcb.apcb042
      LET l_apcb3.apcb043= l_apcb.apcb043
      LET l_apcb3.apcb044= l_apcb.apcb044
      LET l_apcb3.apcb045= l_apcb.apcb045
      LET l_apcb3.apcb046= l_apcb.apcb046
      CALL s_aapp131_get_accitem_free(g_prog1,l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb021,l_apcb.apcb029,p_xrcd009,l_apcb3.*)
      #180705-00083#1 add -e
      #170105-00033#2 --s add
      IF cl_null(g_apbb055ty2) THEN
         LET g_apbb055ty2 = l_apbb.apbb055
      END IF     
      #170105-00033#2 --e add
      #180730-00034#1 --s add 對帳單與帳款單日期相等時才應用直接給付款到期日的處理
      IF l_apbb.apbbdocdt <> l_apca.apcadocdt THEN
         LET g_apbb055ty2 = ''
      END IF       
      #180730-00034#1 --e add
      
       ##50703-00021#24   增加預算控管---s---
      #IF g_dfin5002 = 'Y' THEN #200928-00025#1 mark
      IF g_dfin5002 MATCHES '[YC]' THEN #200928-00025#1 add
         #181030-00022#5 ---s---      
         ##170510-00041#1 ---s---#將來源預算轉出                
         #LET l_bgbd039 = 0
         #SELECT bgbd039 INTO l_bgbd039 FROM bgbd_t WHERE bgbdent = g_enterprise 
         #   AND bgbd037 = l_apcb.apcb008 AND bgbd038 = l_apcb.apcb009
         #IF cl_null(l_bgbd039) THEN LET l_bgbd039 = 0 END IF
         #IF l_bgbd039 < l_apcb.apcb103 THEN LET l_bgbd039 = l_apcb.apcb103 END IF                
         #UPDATE bgbd_t SET bgbd040 = bgbd039
         # WHERE bgbdent = g_enterprise
         #   AND bgbd037 = l_apcb.apcb008
         #   AND bgbd038 = l_apcb.apcb009    
         ##170510-00041#1 ---e---#將來源預算轉出
         #181030-00022#5 ---e---  
         #201127-00012#1 add---(s)                  
         IF NOT cl_null(l_apcb.apcb002) AND NOT cl_null(l_apcb.apcb003) THEN 
            LET l_tran.docno     = l_apca.apcadocno
            LET l_tran.ld        = l_apca.apcald
            LET l_tran.docdt     = l_apca.apcadocdt
            LET l_tran.comp      = l_apca.apcacomp
            LET l_tran.seq       = l_apcb.apcbseq
            LET l_tran.bgbd007   = l_apcb.apcb017
            LET l_tran.bgbd037   = l_apcb.apcb002
            LET l_tran.bgbd038   = l_apcb.apcb003
            LET l_tran.bgbd040   = l_apcb.apcb113
            LET l_tran.bgbd007_t = '' #修改前的預算細項
            LET l_tran.bgbd037_t = '' #修改前的單號
            LET l_tran.bgbd038_t = '' #修改前的項次
            LET l_tran.bgbd040_t = 0  #修改前被占用的金額
            LET l_tran.act       = 'A'                     
            #預算轉移
            LET l_ls_js = util.JSON.stringify(l_tran)                  
            CALL s_abg_tran(l_ls_js) RETURNING g_sub_success,g_errno 
         END IF
         #201127-00012#1 add---(e)  
         #CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','1') #200928-00025#1 mark
         CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','4')  #200928-00025#1 add
             RETURNING g_sub_success,g_errno
         #200928-00025#1 mark ---s
         #IF NOT g_sub_success THEN
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = g_errno
         #   LET g_errparam.extend = ''
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #  #LET r_success = FALSE #171225-00022#1 add
         #  #CONTINUE FOREACH      #171225-00022#1 add
         #END IF
         #200928-00025#1 mark ---e                 
         IF g_sub_success THEN #200928-00025#1 add         
            CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','2')
                RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               LET g_errparam.replace[1] = l_apcb.apcb017
               #200928-00025#1 add ---e
               CALL cl_err()
               LET r_success = FALSE #171225-00022#1 add #200928-00025#1 remark
               CONTINUE FOREACH      #171225-00022#1 add #200928-00025#1 remark 
            END IF       
            #新增一筆bgbd_t               
            CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'I','3')
               RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = g_errno
               LET g_errparam.popup  = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               #200928-00025#1 add ---e               
               CALL cl_err()        
               LET r_success = FALSE   #171225-00022#1 add #200928-00025#1 remark
               CONTINUE FOREACH        #171225-00022#1 add #200928-00025#1 remark
            END IF
         #200928-00025#1 add ---s
         ELSE
            IF g_dfin5002 = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               #200928-00025#1 add ---e               
               CALL cl_err()
               LET r_success = FALSE
               CONTINUE FOREACH
            END IF
         END IF
         #200928-00025#1 add ---e            
      END IF          
      ##50703-00021#24   增加預算控管---e---
      #回寫isam_t立帳單號
     #CALL s_fin_get_ld_type(p_ld) RETURNING l_ld_type
      IF l_ld_type = '1' THEN
         UPDATE isam_t SET isam050 = p_docno
          WHERE isament = g_enterprise AND isamdocno = l_tmp.pmdtdocno
      END IF
    
      #170518-00041#1 --s add aapt341的單據單號(apcadocno)回寫aapt110藍字發票的18:差異折讓來源單號(apba005)
      IF g_apba004_18 = '1' THEN
         UPDATE apba_t SET apba005 = p_docno,apba006 = l_tmp.pmdtseq
          WHERE apbaent = g_enterprise AND apbadocno = l_pmdtdocno_t AND apba004 = '18'
      END IF    
      #170518-00041#1 --s add
#      #200107-00023#1--mark--str
#      #170930-00003#1 --s add
#      IF l_apcb.apcb001 = '13' THEN
#         UPDATE xrcd_t SET xrcd009 = l_apca.apca035
#          WHERE xrcdent = g_enterprise AND xrcdld = p_ld AND xrcddocno = p_docno AND xrcdseq = l_apcb.apcbseq
#      END IF      
#      #170930-00003#1 --e add
#      #200107-00023#1--mark--end
   END FOREACH
   #170503-00065#1---s---   
   UPDATE apca_t SET apca065 = l_apbb.apbb009,apca066= l_apbb.apbb010
    WHERE apcaent = g_enterprise
      AND apcald = p_ld AND apcadocno =  p_docno      
   #170503-00065#1---e---
   #180620-00006#1---add---(S) 
   IF g_sel2 = '7' AND g_sel1 <> '7' THEN
      UPDATE apca_t SET apca053 = l_apbb.apbb049
       WHERE apcaent = g_enterprise
         AND apcald = p_ld AND apcadocno =  p_docno 
   END IF
   #180620-00006#1---add---(E)
   LET l_cnt = 0
   #SELECT count(*) INTO l_cnt         #161114-00009#1 mark
   SELECT count(apcbdocno) INTO l_cnt  #161114-00009#1 add
     FROM apcb_t
    WHERE apcbent = g_enterprise 
      AND apcbld  = p_ld AND apcbdocno=p_docno AND apcb023 = 'Y'
   IF l_cnt > 0 THEN
      CALL s_aapp131_ins_apcf('0',p_ld,p_docno) RETURNING g_sub_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 立帳單身(入庫單立帳)
# Memo...........:
# Date & Author..: 
# Modify.........: #180705-00083#1 add 税额科目 by 08172
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcb3(p_ld,p_docno,p_cond1,p_sfin2002,p_pmds031,p_xrcd009)
DEFINE p_ld          LIKE apca_t.apcald         #帳套
DEFINE p_docno       LIKE apca_t.apcadocno      #單據編號
DEFINE p_cond1       LIKE type_t.chr500         #彙總條件值
DEFINE p_sfin2002    LIKE type_t.chr1
DEFINE p_pmds031     LIKE pmds_t.pmds031        #付款條件
DEFINE p_xrcd009     LIKE xrcd_t.xrcd009        #税额科目   #180705-00083#1 add
DEFINE r_success     LIKE type_t.num5
DEFINE l_sql         STRING
#DEFINE l_apca        RECORD LIKE apca_t.* #161111-00048#2 mark
#DEFINE l_apcb        RECORD LIKE apcb_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apca        RECORD  #應付憑單單頭
          apcaent       LIKE apca_t.apcaent,   #企業編號
          apcaownid     LIKE apca_t.apcaownid, #資料所有者
          apcaowndp     LIKE apca_t.apcaowndp, #資料所有部門
          apcacrtid     LIKE apca_t.apcacrtid, #資料建立者
          apcacrtdp     LIKE apca_t.apcacrtdp, #資料建立部門
          apcacrtdt     LIKE apca_t.apcacrtdt, #資料創建日
          apcamodid     LIKE apca_t.apcamodid, #資料修改者
          apcamoddt     LIKE apca_t.apcamoddt, #最近修改日
          apcacnfid     LIKE apca_t.apcacnfid, #資料確認者
          apcacnfdt     LIKE apca_t.apcacnfdt, #資料確認日
          apcapstid     LIKE apca_t.apcapstid, #資料過帳者
          apcapstdt     LIKE apca_t.apcapstdt, #資料過帳日
          apcastus      LIKE apca_t.apcastus,  #狀態碼
          apcald        LIKE apca_t.apcald,    #帳套
          apcacomp      LIKE apca_t.apcacomp,  #法人
          apcadocno     LIKE apca_t.apcadocno, #應付帳款單號碼
          apcadocdt     LIKE apca_t.apcadocdt, #帳款日期
          apcasite      LIKE apca_t.apcasite,  #帳務中心
          apca001       LIKE apca_t.apca001,   #帳款單性質
          apca003       LIKE apca_t.apca003,   #帳務人員
          apca004       LIKE apca_t.apca004,   #帳款對象編號
          apca005       LIKE apca_t.apca005,   #付款對象
          apca006       LIKE apca_t.apca006,   #供應商分類
          apca007       LIKE apca_t.apca007,   #帳款類別
          apca008       LIKE apca_t.apca008,   #付款條件編號
          apca009       LIKE apca_t.apca009,   #應付款日/應扣抵日
          apca010       LIKE apca_t.apca010,   #容許票據到期日
          apca011       LIKE apca_t.apca011,   #稅別
          apca012       LIKE apca_t.apca012,   #稅率
          apca013       LIKE apca_t.apca013,   #含稅否
          apca014       LIKE apca_t.apca014,   #人員編號
          apca015       LIKE apca_t.apca015,   #部門編號
          apca016       LIKE apca_t.apca016,   #來源作業類型
          apca017       LIKE apca_t.apca017,   #產生方式
          apca018       LIKE apca_t.apca018,   #來源參考單號
          apca019       LIKE apca_t.apca019,   #系統產生對應單號(待抵帳款-預付)
          apca020       LIKE apca_t.apca020,   #信用狀付款否
          apca021       LIKE apca_t.apca021,   #商業發票號碼(IV no.)
          apca022       LIKE apca_t.apca022,   #進口報單號碼
          apca025       LIKE apca_t.apca025,   #差異處理(發票與帳款差異)
          apca026       LIKE apca_t.apca026,   #原幣未稅差異
          apca027       LIKE apca_t.apca027,   #原幣稅額差異
          apca028       LIKE apca_t.apca028,   #本幣未稅差異
          apca029       LIKE apca_t.apca029,   #本幣幣稅額差異
          apca030       LIKE apca_t.apca030,   #差異科目
          apca031       LIKE apca_t.apca031,   #產生之差異折讓單號
          apca032       LIKE apca_t.apca032,   #發票類型
          apca033       LIKE apca_t.apca033,   #專案編號
          apca034       LIKE apca_t.apca034,   #責任中心
          apca035       LIKE apca_t.apca035,   #應付(貸方)科目編號
          apca036       LIKE apca_t.apca036,   #費用(借方)科目編號
          apca037       LIKE apca_t.apca037,   #產生傳票否
          apca038       LIKE apca_t.apca038,   #拋轉傳票號碼
          apca039       LIKE apca_t.apca039,   #會計檢核附件份數
          apca040       LIKE apca_t.apca040,   #留置否
          apca041       LIKE apca_t.apca041,   #留置理由碼
          apca042       LIKE apca_t.apca042,   #留置設定日期
          apca043       LIKE apca_t.apca043,   #留置解除日期
          apca044       LIKE apca_t.apca044,   #留置原幣金額
          apca045       LIKE apca_t.apca045,   #留置說明
          apca046       LIKE apca_t.apca046,   #關係人否
          apca047       LIKE apca_t.apca047,   #多角序號
          apca048       LIKE apca_t.apca048,   #集團代付/代付單號
          apca049       LIKE apca_t.apca049,   #來源營運中心編號
          apca050       LIKE apca_t.apca050,   #交易原始單據份數
          apca051       LIKE apca_t.apca051,   #作廢理由碼
          apca052       LIKE apca_t.apca052,   #列印次數
          apca053       LIKE apca_t.apca053,   #備註
          apca054       LIKE apca_t.apca054,   #多帳期設定
          apca055       LIKE apca_t.apca055,   #繳款優惠條件
          apca056       LIKE apca_t.apca056,   #會計檢核附件狀態
          apca057       LIKE apca_t.apca057,   #交易對象識別碼
          apca058       LIKE apca_t.apca058,   #稅別交易類型
          apca059       LIKE apca_t.apca059,   #預算編號
          apca060       LIKE apca_t.apca060,   #發票開立方式
          apca061       LIKE apca_t.apca061,   #預開發票基準日
          apca062       LIKE apca_t.apca062,   #多角性質
          apca063       LIKE apca_t.apca063,   #整帳批序號
          apca064       LIKE apca_t.apca064,   #訂金序次
          apca065       LIKE apca_t.apca065,   #發票編號
          apca066       LIKE apca_t.apca066,   #發票號碼
          apca100       LIKE apca_t.apca100,   #交易原幣別
          apca101       LIKE apca_t.apca101,   #原幣匯率
          apca103       LIKE apca_t.apca103,   #原幣未稅金額
          apca104       LIKE apca_t.apca104,   #原幣稅額
          apca106       LIKE apca_t.apca106,   #原幣應稅折抵合計金額
          apca107       LIKE apca_t.apca107,   #原幣直接沖帳(調整)合計金額
          apca108       LIKE apca_t.apca108,   #原幣應付金額
          apca113       LIKE apca_t.apca113,   #本幣未稅金額
          apca114       LIKE apca_t.apca114,   #本幣稅額
          apca116       LIKE apca_t.apca116,   #本幣應稅折抵合計金額
          apca117       LIKE apca_t.apca117,   #NO USE
          apca118       LIKE apca_t.apca118,   #本幣應付金額
          apca120       LIKE apca_t.apca120,   #本位幣二幣別
          apca121       LIKE apca_t.apca121,   #本位幣二匯率
          apca123       LIKE apca_t.apca123,   #本位幣二未稅金額
          apca124       LIKE apca_t.apca124,   #本位幣二稅額
          apca126       LIKE apca_t.apca126,   #本位幣二應稅折抵合計金額
          apca127       LIKE apca_t.apca127,   #NO USE
          apca128       LIKE apca_t.apca128,   #本位幣二應付金額
          apca130       LIKE apca_t.apca130,   #本位幣三幣別
          apca131       LIKE apca_t.apca131,   #本位幣三匯率
          apca133       LIKE apca_t.apca133,   #本位幣三未稅金額
          apca134       LIKE apca_t.apca134,   #本位幣三稅額
          apca136       LIKE apca_t.apca136,   #本位幣三應稅折抵合計金額
          apca137       LIKE apca_t.apca137,   #NO USE
          apca138       LIKE apca_t.apca138,   #本位幣三應付金額
          apcaud001     LIKE apca_t.apcaud001, #自定義欄位(文字)001
          apcaud002     LIKE apca_t.apcaud002, #自定義欄位(文字)002
          apcaud003     LIKE apca_t.apcaud003, #自定義欄位(文字)003
          apcaud004     LIKE apca_t.apcaud004, #自定義欄位(文字)004
          apcaud005     LIKE apca_t.apcaud005, #自定義欄位(文字)005
          apcaud006     LIKE apca_t.apcaud006, #自定義欄位(文字)006
          apcaud007     LIKE apca_t.apcaud007, #自定義欄位(文字)007
          apcaud008     LIKE apca_t.apcaud008, #自定義欄位(文字)008
          apcaud009     LIKE apca_t.apcaud009, #自定義欄位(文字)009
          apcaud010     LIKE apca_t.apcaud010, #自定義欄位(文字)010
          apcaud011     LIKE apca_t.apcaud011, #自定義欄位(數字)011
          apcaud012     LIKE apca_t.apcaud012, #自定義欄位(數字)012
          apcaud013     LIKE apca_t.apcaud013, #自定義欄位(數字)013
          apcaud014     LIKE apca_t.apcaud014, #自定義欄位(數字)014
          apcaud015     LIKE apca_t.apcaud015, #自定義欄位(數字)015
          apcaud016     LIKE apca_t.apcaud016, #自定義欄位(數字)016
          apcaud017     LIKE apca_t.apcaud017, #自定義欄位(數字)017
          apcaud018     LIKE apca_t.apcaud018, #自定義欄位(數字)018
          apcaud019     LIKE apca_t.apcaud019, #自定義欄位(數字)019
          apcaud020     LIKE apca_t.apcaud020, #自定義欄位(數字)020
          apcaud021     LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
          apcaud022     LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
          apcaud023     LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
          apcaud024     LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
          apcaud025     LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
          apcaud026     LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
          apcaud027     LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
          apcaud028     LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
          apcaud029     LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
          apcaud030     LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
          apca067       LIKE apca_t.apca067,   #管理品類
          apca068       LIKE apca_t.apca068,   #經營方式
          apca069       LIKE apca_t.apca069,   #no use
          apca070       LIKE apca_t.apca070,   #no use
          apca071       LIKE apca_t.apca071,   #no use
          apca072       LIKE apca_t.apca072,   #no use
          apca073       LIKE apca_t.apca073    #L/C No.
                     END RECORD
DEFINE l_apcb        RECORD  #應付憑單單身
          apcbent       LIKE apcb_t.apcbent,   #企業編號
          apcbld        LIKE apcb_t.apcbld,    #帳套
          apcblegl      LIKE apcb_t.apcblegl,  #核算組織
          apcborga      LIKE apcb_t.apcborga,  #帳務歸屬組織(來源組織)
          apcbsite      LIKE apcb_t.apcbsite,  #應付帳務組織
          apcbdocno     LIKE apcb_t.apcbdocno, #單號
          apcbseq       LIKE apcb_t.apcbseq,   #項次
          apcb001       LIKE apcb_t.apcb001,   #來源類型
          apcb002       LIKE apcb_t.apcb002,   #來源業務單據號碼
          apcb003       LIKE apcb_t.apcb003,   #來源業務單據項次
          apcb004       LIKE apcb_t.apcb004,   #產品編號
          apcb005       LIKE apcb_t.apcb005,   #品名規格
          apcb006       LIKE apcb_t.apcb006,   #單位
          apcb007       LIKE apcb_t.apcb007,   #計價數量
          apcb008       LIKE apcb_t.apcb008,   #參考單據號碼
          apcb009       LIKE apcb_t.apcb009,   #參考單據項次
          apcb010       LIKE apcb_t.apcb010,   #業務部門
          apcb011       LIKE apcb_t.apcb011,   #責任中心
          apcb012       LIKE apcb_t.apcb012,   #產品類別
          apcb013       LIKE apcb_t.apcb013,   #搭贈
          apcb014       LIKE apcb_t.apcb014,   #理由碼
          apcb015       LIKE apcb_t.apcb015,   #專案編號
          apcb016       LIKE apcb_t.apcb016,   #WBS編號
          apcb017       LIKE apcb_t.apcb017,   #預算細項
          apcb018       LIKE apcb_t.apcb018,   #专柜编号
          apcb019       LIKE apcb_t.apcb019,   #開票性質
          apcb020       LIKE apcb_t.apcb020,   #稅別
          apcb021       LIKE apcb_t.apcb021,   #費用會計科目
          apcb022       LIKE apcb_t.apcb022,   #正負值
          apcb023       LIKE apcb_t.apcb023,   #沖暫估單否
          apcb024       LIKE apcb_t.apcb024,   #區域
          apcb025       LIKE apcb_t.apcb025,   #傳票號碼
          apcb026       LIKE apcb_t.apcb026,   #傳票項次
          apcb027       LIKE apcb_t.apcb027,   #發票編號
          apcb028       LIKE apcb_t.apcb028,   #發票號碼
          apcb029       LIKE apcb_t.apcb029,   #應付帳款科目
          apcb030       LIKE apcb_t.apcb030,   #付款條件
          apcb032       LIKE apcb_t.apcb032,   #訂金序次
          apcb033       LIKE apcb_t.apcb033,   #經營方式
          apcb034       LIKE apcb_t.apcb034,   #通路
          apcb035       LIKE apcb_t.apcb035,   #品牌
          apcb036       LIKE apcb_t.apcb036,   #客群
          apcb037       LIKE apcb_t.apcb037,   #自由核算項一
          apcb038       LIKE apcb_t.apcb038,   #自由核算項二
          apcb039       LIKE apcb_t.apcb039,   #自由核算項三
          apcb040       LIKE apcb_t.apcb040,   #自由核算項四
          apcb041       LIKE apcb_t.apcb041,   #自由核算項五
          apcb042       LIKE apcb_t.apcb042,   #自由核算項六
          apcb043       LIKE apcb_t.apcb043,   #自由核算項七
          apcb044       LIKE apcb_t.apcb044,   #自由核算項八
          apcb045       LIKE apcb_t.apcb045,   #自由核算項九
          apcb046       LIKE apcb_t.apcb046,   #自由核算項十
          apcb047       LIKE apcb_t.apcb047,   #摘要
          apcb048       LIKE apcb_t.apcb048,   #來源訂購單號
          apcb049       LIKE apcb_t.apcb049,   #開票單號
          apcb050       LIKE apcb_t.apcb050,   #開票項次
          apcb051       LIKE apcb_t.apcb051,   #業務人員
          apcb100       LIKE apcb_t.apcb100,   #交易原幣
          apcb101       LIKE apcb_t.apcb101,   #交易原幣單價
          apcb102       LIKE apcb_t.apcb102,   #原幣匯率
          apcb103       LIKE apcb_t.apcb103,   #交易原幣未稅金額
          apcb104       LIKE apcb_t.apcb104,   #交易原幣稅額
          apcb105       LIKE apcb_t.apcb105,   #交易原幣含稅金額
          apcb106       LIKE apcb_t.apcb106,   #交易幣標準成本金額
          apcb107       LIKE apcb_t.apcb107,   #入庫單單價
          apcb108       LIKE apcb_t.apcb108,   #交易原幣成本認列金額
          apcb111       LIKE apcb_t.apcb111,   #本幣單價
          apcb113       LIKE apcb_t.apcb113,   #本幣未稅金額
          apcb114       LIKE apcb_t.apcb114,   #本幣稅額
          apcb115       LIKE apcb_t.apcb115,   #本幣含稅金額
          apcb116       LIKE apcb_t.apcb116,   #本幣標準成本金額
          apcb117       LIKE apcb_t.apcb117,   #NO USE
          apcb118       LIKE apcb_t.apcb118,   #本幣成本認列金額
          apcb119       LIKE apcb_t.apcb119,   #應開發票含稅金額
          apcb121       LIKE apcb_t.apcb121,   #本位幣二匯率
          apcb123       LIKE apcb_t.apcb123,   #本位幣二未稅金額
          apcb124       LIKE apcb_t.apcb124,   #本位幣二稅額
          apcb125       LIKE apcb_t.apcb125,   #本位幣二含稅金額
          apcb126       LIKE apcb_t.apcb126,   #本幣二標準成本金額
          apcb127       LIKE apcb_t.apcb127,   #NO USE
          apcb128       LIKE apcb_t.apcb128,   #本位幣二成本認列金額
          apcb131       LIKE apcb_t.apcb131,   #本位幣三匯率
          apcb133       LIKE apcb_t.apcb133,   #本位幣三未稅金額
          apcb134       LIKE apcb_t.apcb134,   #本位幣三稅額
          apcb135       LIKE apcb_t.apcb135,   #本位幣三含稅金額
          apcb136       LIKE apcb_t.apcb136,   #本幣三標準成本金額
          apcb137       LIKE apcb_t.apcb137,   #NO USE
          apcb138       LIKE apcb_t.apcb138,   #本位幣三成本認列金額
          apcbud001     LIKE apcb_t.apcbud001, #自定義欄位(文字)001
          apcbud002     LIKE apcb_t.apcbud002, #自定義欄位(文字)002
          apcbud003     LIKE apcb_t.apcbud003, #自定義欄位(文字)003
          apcbud004     LIKE apcb_t.apcbud004, #自定義欄位(文字)004
          apcbud005     LIKE apcb_t.apcbud005, #自定義欄位(文字)005
          apcbud006     LIKE apcb_t.apcbud006, #自定義欄位(文字)006
          apcbud007     LIKE apcb_t.apcbud007, #自定義欄位(文字)007
          apcbud008     LIKE apcb_t.apcbud008, #自定義欄位(文字)008
          apcbud009     LIKE apcb_t.apcbud009, #自定義欄位(文字)009
          apcbud010     LIKE apcb_t.apcbud010, #自定義欄位(文字)010
          apcbud011     LIKE apcb_t.apcbud011, #自定義欄位(數字)011
          apcbud012     LIKE apcb_t.apcbud012, #自定義欄位(數字)012
          apcbud013     LIKE apcb_t.apcbud013, #自定義欄位(數字)013
          apcbud014     LIKE apcb_t.apcbud014, #自定義欄位(數字)014
          apcbud015     LIKE apcb_t.apcbud015, #自定義欄位(數字)015
          apcbud016     LIKE apcb_t.apcbud016, #自定義欄位(數字)016
          apcbud017     LIKE apcb_t.apcbud017, #自定義欄位(數字)017
          apcbud018     LIKE apcb_t.apcbud018, #自定義欄位(數字)018
          apcbud019     LIKE apcb_t.apcbud019, #自定義欄位(數字)019
          apcbud020     LIKE apcb_t.apcbud020, #自定義欄位(數字)020
          apcbud021     LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
          apcbud022     LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
          apcbud023     LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
          apcbud024     LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
          apcbud025     LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
          apcbud026     LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
          apcbud027     LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
          apcbud028     LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
          apcbud029     LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
          apcbud030     LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
          apcb052       LIKE apcb_t.apcb052,   #稅額
          apcb053       LIKE apcb_t.apcb053,   #含稅金額
          apcb054       LIKE apcb_t.apcb054,   #帳款對象
          apcb055       LIKE apcb_t.apcb055    #付款對象
                     END RECORD
#161111-00048#2 --e add
DEFINE l_apcb105     LIKE apcb_t.apcb105       #剩餘可立帳金額
DEFINE l_apcb105_u   LIKE apcb_t.apcb105       #已立帳金額
DEFINE l_cnt         LIKE type_t.num10
DEFINE l_str         LIKE type_t.chr500
DEFINE l_ld_type     LIKE type_t.chr1
DEFINE l_tmp         RECORD
          pmdtsite      LIKE pmdt_t.pmdtsite,  #營運據點
          pmdtdocno     LIKE pmdt_t.pmdtdocno, #收票單號
          pmdtseq       LIKE pmdt_t.pmdtseq,   #收票項次
          apcb007       LIKE apcb_t.apcb007,   #可立帳數量
          pmds031       LIKE pmds_t.pmds031    #付款條件
                     END RECORD
DEFINE l_pmds000     LIKE pmds_t.pmds000       #入庫單性質
DEFINE l_pmdt001     LIKE pmdt_t.pmdt001       #採購單號
DEFINE l_pmdt006     LIKE pmdt_t.pmdt006       #產品編號
DEFINE l_pmdt023     LIKE pmdt_t.pmdt023       #單位
DEFINE l_pmdt036     LIKE pmdt_t.pmdt036       #原幣單價
DEFINE l_pmdt038     LIKE pmdt_t.pmdt038       #未稅金額
DEFINE l_pmdt039     LIKE pmdt_t.pmdt039       #含稅金額
DEFINE l_pmdt049     LIKE pmdt_t.pmdt049       #150904 by 03538
DEFINE l_pmdt050     LIKE pmdt_t.pmdt050       #150904 by 03538
DEFINE l_pmdt072     LIKE pmdt_t.pmdt072       #專案編號
DEFINE l_pmdt073     LIKE pmdt_t.pmdt073       #WBS
DEFINE l_flag        LIKE type_t.num5          #是否為入庫單全部數量立帳   #141204-00017#1
DEFINE l_glaa001     LIKE glaa_t.glaa001       #140806-00012#12
DEFINE l_acctype     LIKE type_t.chr2          #150313-00003#2
DEFINE l_ar          DYNAMIC ARRAY OF RECORD
          chr           LIKE type_t.chr500
                     END RECORD
DEFINE l_pmds012     LIKE pmds_t.pmds012       #採購通路 #160120-00011#2
DEFINE l_pmds013     LIKE pmds_t.pmds013       #採購分類 #160120-00011#2
DEFINE l_pmds100     LIKE pmds_t.pmds100       #倉退方式   #190220-00035#1 add
DEFINE l_pmdt016     LIKE pmdt_t.pmdt016       #倉庫     #160120-00011#2
DEFINE l_apcb106     LIKE apcb_t.apcb106       #160107-00001#1
DEFINE l_apcb116     LIKE apcb_t.apcb116       #160107-00001#1
DEFINE l_apcb126     LIKE apcb_t.apcb126       #160107-00001#1
DEFINE l_apcb136     LIKE apcb_t.apcb136       #160107-00001#1
DEFINE l_pmdt051     LIKE pmdt_t.pmdt051       #161104-00049#6
DEFINE l_pmdt002     LIKE pmdt_t.pmdt002       #170510-00041#1
DEFINE l_pmdt046     LIKE pmdt_t.pmdt046       #191226-00040#3 add
DEFINE l_bgbd039     LIKE bgbd_t.bgbd039       #170510-00041#1
DEFINE l_apcb007     LIKE apcb_t.apcb007       #170527-00015#1 add
DEFINE l_apcb0071    LIKE apcb_t.apcb007       #170527-00015#1 add
#170526-00019#1--add--str--lujh
DEFINE l_imaa004     LIKE imaa_t.imaa004
DEFINE l_imag011     LIKE imag_t.imag011
#170526-00019#1--add--end--lujh
#180704-00022#1 add ---s
DEFINE l_array       DYNAMIC ARRAY OF RECORD
       chr  LIKE type_t.chr1000
       END RECORD  
#180704-00022#1 add ---e
#180705-00083#1 add -s
DEFINE l_apcb2       RECORD #固定核算项
       apcb054       LIKE apcb_t.apcb054,
       apcb055       LIKE apcb_t.apcb055,
       apcb051       LIKE apcb_t.apcb051,
       apcb010       LIKE apcb_t.apcb010,
       apcb011       LIKE apcb_t.apcb011,
       apcb024       LIKE apcb_t.apcb024,
       apcb036       LIKE apcb_t.apcb036,
       apcb012       LIKE apcb_t.apcb012,
       apcb033       LIKE apcb_t.apcb033,
       apcb034       LIKE apcb_t.apcb034,
       apcb035       LIKE apcb_t.apcb035,
       apcb015       LIKE apcb_t.apcb015,
       apcb016       LIKE apcb_t.apcb016
                     END RECORD
DEFINE l_apcb3       RECORD #自由核算项
       apcb037       LIKE apcb_t.apcb037, 
       apcb038       LIKE apcb_t.apcb038,
       apcb039       LIKE apcb_t.apcb039, 
       apcb040       LIKE apcb_t.apcb040,
       apcb041       LIKE apcb_t.apcb041, 
       apcb042       LIKE apcb_t.apcb042,
       apcb043       LIKE apcb_t.apcb043, 
       apcb044       LIKE apcb_t.apcb044,
       apcb045       LIKE apcb_t.apcb045,     
       apcb046       LIKE apcb_t.apcb046            
                     END RECORD 
#180705-00083#1 add -e
DEFINE l_pmdt005     LIKE pmdt_t.pmdt005   #190103-00077#1 add
DEFINE l_pmdt062     LIKE pmdt_t.pmdt062   #190815-00012#1 add
DEFINE l_pmdu006     LIKE pmdu_t.pmdu006   #190815-00012#1 add
DEFINE l_imaf141     LIKE imaf_t.imaf141   #190812-00010#5 add 
DEFINE l_kind        STRING                #190812-00010#5 add
#191010-00012#1---add---str
DEFINE l_pmds006     LIKE pmds_t.pmds006
DEFINE l_pmdl008     LIKE pmdl_t.pmdl008
DEFINE l_pmdt001t    LIKE pmdt_t.pmdt001
DEFINE l_pmdt002t    LIKE pmdt_t.pmdt002
#191010-00012#1---add---end
DEFINE l_type        LIKE type_t.chr5     #190305-00001#2 add
#191226-00040#3---add---(S) 
DEFINE l_oodb004     LIKE oodb_t.oodb004    
DEFINE l_oodb005     LIKE oodb_t.oodb005    
DEFINE l_oodb006     LIKE oodb_t.oodb006    
DEFINE l_oodb011     LIKE oodb_t.oodb011   
#191226-00040#3---add---(E) 
DEFINE l_sfin3012    LIKE type_t.chr1     #含稅立帳否 #191226-00040#7 add
#201127-00012#1 add---(s)
DEFINE l_ls_js   STRING
DEFINE l_tran    RECORD
   docno        LIKE apcb_t.apcbdocno,
   ld           LIKE apcb_t.apcbld,
   docdt        LIKE apca_t.apcadocdt,
   comp         LIKE apca_t.apcacomp,
   seq          LIKE apcb_t.apcbseq,  
   bgbd007      LIKE bgbd_t.bgbd007,     
   bgbd037      LIKE bgbd_t.bgbd037,
   bgbd038      LIKE bgbd_t.bgbd038,
   bgbd040      LIKE bgbd_t.bgbd040,     
   bgbd007_t    LIKE bgbd_t.bgbd007,    #修改前的預算細項
   bgbd037_t    LIKE bgbd_t.bgbd037,    #修改前的單號
   bgbd038_t    LIKE bgbd_t.bgbd038,    #修改前的項次
   bgbd040_t    LIKE bgbd_t.bgbd040,    #修改前被占用的金額
   act          LIKE type_t.chr10     
END RECORD
#201127-00012#1 add---(e)
#200805-00007#1 add -s  
DEFINE l_apcb010     LIKE apcb_t.apcb010
DEFINE l_apcb021     LIKE apcb_t.apcb021
#200805-00007#1 add -e
#200916-00030#1-(S) add
DEFINE l_minus_chk   LIKE type_t.num5
DEFINE l_pmdt024     LIKE pmdt_t.pmdt024
DEFINE l_pmds054     LIKE pmds_t.pmds054
#200916-00030#1-(E) add

   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   
   #SELECT * INTO l_apca.*   #161208-00026#22   mark
   #161208-00026#22   add---s
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073
     INTO l_apca.*
   #161208-00026#22   add---e
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_docno
   
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3012') RETURNING l_sfin3012  #191226-00040#7 add
   #190812-00010#5 add s---
   LET l_sql = " SELECT imaf141 FROM imaf_t ",
               "  WHERE imafent = ",g_enterprise," AND imaf001 = ?",
               "    AND imafsite = (SELECT glaacomp FROM glaa_t WHERE glaaent=",g_enterprise," AND glaald= ?) "
   PREPARE s_aapp131_imaf141_prep3 FROM l_sql 
   #190812-00010#5 add e---  
   
   LET l_sql = " SELECT pmdtsite,pmdtdocno,pmdtseq,apcb007,pmds031 ",
               "   FROM s_aapp131_tmp_g ",
               "  WHERE pmds037 = '",l_apca.apca100,"' AND pmds038 =  ",l_apca.apca101,
               "    AND pmds007 = '",l_apca.apca004,"' AND cond1   = '",p_cond1,"'",
               "    AND pmds008 = '",l_apca.apca005,"'",         #200218-00040#8 add
               "    AND pmds033 = '",l_apca.apca011,"'"
   IF NOT cl_null(l_apca.apca007) THEN
      LET l_sql = l_sql ,"  AND apca007 = '",l_apca.apca007,"' "
   ELSE
      LET l_sql = l_sql ,"  AND apca007 IS NULL "
   END IF
   #若為沖銷參數1/2 彙總條件增加付款條件
   IF p_sfin2002 MATCHES '[12]' THEN
      LET l_sql = l_sql," AND pmds031 = '",p_pmds031,"'"
   END IF
   
   #171214-00017#6 add ------
   #一次性交易要加上交易編號條件
   IF l_apca.apca057 <> l_apca.apca004 THEN
      LET l_sql = l_sql ,"  AND pmds028 = '",l_apca.apca057,"' "
   END IF
   #171214-00017#6 add end---
   
   #LET l_sql = l_sql," ORDER BY pmdtdocno,pmdtseq "                               #170324-00028#1 mark
   LET l_sql = l_sql," ORDER BY cond1,pmds008,pmds033,pmds031,pmdtdocno,pmdtseq "  #170324-00028#1 add
   PREPARE s_aapp131_ins_apcb3_p FROM l_sql
   DECLARE s_aapp131_ins_apcb3_c CURSOR FOR s_aapp131_ins_apcb3_p
   CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_glaa001
   #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101  #160829-00004#5 mark
  #CALL s_curr_round_ld('1',p_ld,l_apca.apca100,l_apca.apca101,3) RETURNING g_sub_success,g_errno,l_apca.apca101 #160829-00004#5  #170430-00006#2 mark
   CALL s_num_round(g_round_type,l_apca.apca101,g_ooaj005) RETURNING l_apca.apca101  #170430-00006#2 add
   CALL s_fin_get_ld_type(p_ld) RETURNING l_ld_type
   #本張立帳單單身來源的所有入庫單資訊必須先lock住,若有任何一筆入庫單lock失敗,則整張立帳單身停止動作#150126-00012#1--str--
   FOREACH s_aapp131_ins_apcb3_c INTO l_tmp.*
      OPEN s_aapp131_pmdt_cl USING g_enterprise,l_tmp.pmdtdocno,l_tmp.pmdtseq
      IF STATUS THEN
         LET r_success = FALSE
         RETURN r_success
      END IF          
   END FOREACH   
   #150126-00012#1--end--
   #191226-00040#3---add---(S) 
   #取來源暫估單稅別含稅否
   LET l_oodb004 = '' LET l_oodb005 = '' LET l_oodb006 = '' LET l_oodb011 = ''
   CALL s_tax_chk(l_apca.apcacomp,l_apca.apca011) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
   #191226-00040#3---add---(E)
   #200916-00030#1-(S) add
   #取得來源倉退單資訊 
   LET l_sql = " SELECT pmdt024, (SELECT DISTINCT pmds054 FROM pmds_t WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno)pmds054 ", 
               "   FROM pmdt_t ",
               "  WHERE pmdtent = ",g_enterprise," AND pmdtdocno = ? AND pmdtseq = ? "           
   PREPARE s_aapp131_pmdt024_prep3 FROM l_sql   
   #200916-00030#1-(E) add
   
   FOREACH s_aapp131_ins_apcb3_c INTO l_tmp.*
      INITIALIZE l_apcb.* TO NULL

      LET l_pmds000 = ''
      LET l_pmds012 = ''      #160120-00011#2
      LET l_pmds013 = ''      #160120-00011#2
      LET l_pmds100 = ''      #190220-00035#1 add
      SELECT pmds000,pmds012,pmds013,pmds100   #190220-00035#1 add pmds100
        INTO l_pmds000,l_pmds012,l_pmds013,l_pmds100   #160120-00011#2 add pmds012/pmds013   #190220-00035#1 add l_pmds100
        FROM pmds_t
       WHERE pmdsent = g_enterprise   AND pmdsdocno = l_tmp.pmdtdocno
       
      IF cl_null(l_pmds100) THEN LET l_pmds100 = ' ' END IF   #190227-00032#1 add 
      LET l_pmdt001 = '' LET l_pmdt006 = '' LET l_pmdt023 = '' LET l_pmdt036 = ''
      LET l_pmdt038 = 0  LET l_pmdt039 = 0  LET l_pmdt016 = '' 
      LET l_pmdt002 = '' #170510-00041#1 add 
      SELECT pmdt001,pmdt006,pmdt016,pmdt023,pmdt036,pmdt038,     #160120-00011#2 add pmdt016
             pmdt039,pmdt072,pmdt073,pmdt049,pmdt050,   #150904 by 03538
             pmdt002                                    #170510-00041#1
            #pmdt039,pmdt072,pmdt073                   #150904 by 03538 mark
            ,pmdt005   #190103-00077#1 add 
            ,pmdt062   #190815-00012#1 add       
            ,pmdt046   #191226-00040#3 add            
        INTO l_pmdt001,l_pmdt006,l_pmdt016,l_pmdt023,l_pmdt036,l_pmdt038,  #160120-00011#2 add pmdt016
             l_pmdt039,l_pmdt072,l_pmdt073,l_pmdt049,l_pmdt050,  #150904 by 03538
             l_pmdt002                                           #170510-00041#1 add             
            #l_pmdt039,l_pmdt072,l_pmdt073                      #150904 by 03538 mark
            ,l_pmdt005   #190103-00077#1 add  
            ,l_pmdt062   #190815-00012#1 add     
            ,l_pmdt046   #191226-00040#3 add            
        FROM pmdt_t
       WHERE pmdtent = g_enterprise   AND pmdtdocno = l_tmp.pmdtdocno AND pmdtseq = l_tmp.pmdtseq  

       #190815-00012#1--add---str
       IF l_pmdt062 = 'Y' THEN
          #启用多库储，取[多库储批明细]页签的第一笔库位
         
         LET l_sql = " SELECT DISTINCT pmdu006  FROM pmdu_t  ",
                     "  WHERE pmduent = ",g_enterprise,
                     #"    AND pmdudocno = ",l_tmp.pmdtdocno,     #PGS(D)-01531 mark
                     "    AND pmdudocno = '",l_tmp.pmdtdocno,"'", #PGS(D)-01531 add
                     "     AND pmduseq = ",l_tmp.pmdtseq 
         PREPARE s_aapp131_pmdu006_p3 FROM l_sql
         DECLARE s_aapp131_pmdu006_c3 CURSOR FOR s_aapp131_pmdu006_p3             
       END IF
       #190815-00012#1--add---end
      
      LET l_apcb.apcbent  = g_enterprise
      LET l_apcb.apcbld   = p_ld
      LET l_apcb.apcborga = l_tmp.pmdtsite
      LET l_apcb.apcbsite = l_apca.apcasite
      LET l_apcb.apcblegl = l_apca.apcacomp
      LET l_apcb.apcbdocno= p_docno
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq 
        FROM apcb_t
       WHERE apcbent = g_enterprise AND apcbld  = l_apcb.apcbld
         AND apcbdocno  = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      
      CASE 
              #入庫
        #WHEN l_pmds000 MATCHES '[346]' OR l_pmds000 MATCHES '1[2378]' OR l_pmds000 = '20'   #albireo 150630 add 17,18,20   #150702-00001#1 mark
         WHEN s_aap_pmds000_chk('2',l_pmds000)                         #150702-00001#1
              LET l_apcb.apcb001 = "11"
              LET l_apcb.apcb022 = 1
              #倉退
        #WHEN l_pmds000 MATCHES '[57]'  OR l_pmds000 MATCHES '1[01459]'   #albireo 150630 add 19   #150702-00001#1 mark
         WHEN s_aap_pmds000_chk('4',l_pmds000)                         #150702-00001#1
              LET l_apcb.apcb001 = "21"
              LET l_apcb.apcb022 = -1
      END CASE      
      LET l_apcb.apcb002 = l_tmp.pmdtdocno
      LET l_apcb.apcb003 = l_tmp.pmdtseq
      
      #191120-00019#1----add---(s)
      #如果單身入庫單+項次存在未確認暫估單就不能產生到账款單
      IF NOT cl_null(l_apcb.apcb002) AND NOT cl_null(l_apcb.apcb003)  THEN
         LET l_cnt = '0'
         SELECT COUNT(1) INTO l_cnt
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent
            AND apcadocno = apcbdocno
            AND apcald = apcbld
            AND apcb002 = l_apcb.apcb002
            AND apcb003 = l_apcb.apcb003
            AND apcbent = g_enterprise
            AND apca001 IN ('01','02','03','04')
            AND apcastus = 'N'
         IF l_cnt > 0 THEN
             LET g_errparam.code = 'aap-01179'
            LET g_errparam.extend = ''
            LET g_errparam.replace[1] = l_apcb.apcb002
            LET g_errparam.replace[2] = l_apcb.apcb003
            LET g_errparam.popup = TRUE
            CALL cl_err()           
            CONTINUE FOREACH             
         END IF
      END IF
      #191120-00019#1----add---(e)

      LET l_apcb.apcb004 = l_pmdt006
      LET l_apcb.apcb005 = s_aapt300_get_apcb005(l_apcb.apcb004,l_tmp.pmdtdocno,l_tmp.pmdtseq)
      LET l_apcb.apcb006 = l_pmdt023         #單位
      LET l_apcb.apcb007 = l_tmp.apcb007
      #重新取得可立帳數量,數量為0則不新增此單身#141204-00017#1--str--
      CALL s_aapt300_pmdt_get_apcb007(p_ld,l_apcb.apcb002,l_apcb.apcb003,l_apca.apca001) RETURNING l_apcb.apcb007,l_flag
     #IF l_apcb.apcb007 <= 0 THEN CONTINUE FOREACH END IF     #200916-00030#1 mark
      #200916-00030#1-(S) add
      #檢查來源倉退單是否計價數量允許負數
      LET l_minus_chk = FALSE
      EXECUTE s_aapp131_pmdt024_prep3 USING l_apcb.apcb002,l_apcb.apcb003 INTO l_pmdt024,l_pmds054
      #考慮倉退單(4:採購折扣合約結算)且倉退數量為負數      
      IF l_pmds054 = '4' AND l_pmdt024 < 0 THEN      
         IF l_apcb.apcb007<> 0 THEN  #有數量可以立暫估
            LET l_minus_chk = TRUE
         END IF
      END IF            
      IF NOT l_minus_chk THEN
         IF l_apcb.apcb007 <= 0 THEN CONTINUE FOREACH END IF
      END IF      
      #200916-00030#1-(E) add      
      #141204-00017#1--end--           
      LET l_apcb.apcb008 = l_pmdt001         #採購單號
      LET l_apcb.apcb009 = l_pmdt002         #採購單項次 #170510-00041#1
      CALL l_ar.clear()
      CALL s_aapp131_get_apcb010(l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003) RETURNING l_ar
      LET l_apcb.apcb010 = l_ar[1].chr
      IF cl_null(l_apcb.apcb010) THEN LET l_apcb.apcb010 = l_apca.apca015 END IF #180730-00034#1 add 來源單未取到資訊時,以單頭帶入
      LET l_apcb.apcb011 = l_ar[2].chr
      #200805-00007#1 add -s
      #入库和仓退时，费用料件理由码和部门取值
      IF l_apcb.apcb001 = '11' OR l_apcb.apcb001 = '21' THEN
         LET l_apcb010 = NULL
         CALL s_aapp320_get_apba021(l_apcb.apcb002,l_apcb.apcb003,l_apcb.apcb004) RETURNING l_apcb.apcb014,l_apcb010
         IF NOT cl_null(l_apcb010) THEN
            LET l_apcb.apcb010 = l_apcb010
         END IF
      END IF
      #200805-00007#1 add -e
      SELECT imaa009 INTO l_apcb.apcb012
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_apcb.apcb004
      LET l_apcb.apcb013 = 'N'
      LET l_apcb.apcb015 = l_pmdt072         #專案編號
      IF cl_null(l_apcb.apcb015) THEN LET l_apcb.apcb015 = l_apca.apca033 END IF
      LET l_apcb.apcb016 = l_pmdt073         #WBS
      LET l_apcb.apcb017 = l_apca.apca059    #預算編號
      #191226-00040#3---add---(S)
      IF l_oodb011 = '2' THEN #依料件設置           #191226-00040#7 mark #200402-00022#8 remark
      #IF l_oodb011 = '2' AND l_sfin3012 = '2' THEN #191226-00040#7 add #200402-00022#8 mark
         LET l_apcb.apcb020 = l_pmdt046         #稅別 
      ELSE
      #191226-00040#3---add---(E)
         LET l_apcb.apcb020 = l_apca.apca011    #稅別 
      END IF #191226-00040#3 add
      #150310 sam:客户有委外入库的科目是没办法按成本分群抓;因此先按aapi011中抓，抓不到再根据成本分群
      LET l_acctype = 1

      #190812-00010#5 add s---#销售分群aimm214
      IF NOT cl_null(l_apcb.apcb004) THEN 
         LET l_imaf141 = NULL
         EXECUTE s_aapp131_imaf141_prep3 USING l_apcb.apcb004,l_apcb.apcbld INTO l_imaf141
      END IF            
      #190812-00010#5 add e---
      
      IF l_pmds000 MATCHES '1[12345]' OR l_pmds000 = '20' THEN   #抓加工科目   #150629-00038#1 add 17181920
         #LET l_acctype = 16      #16類為glcc001 = 1/抓glcc005   #190103-00077#1 mark
         #190103-00077#1-(S) add
         IF l_pmdt005 = '8' THEN    #委外代買
            LET l_acctype = 1       #1類為glcc001 = 1/抓glcc002
         ELSE         
            LET l_acctype = 16      #16類為glcc001 = 1/抓glcc005
         END IF
         #190103-00077#1-(E) add
      END IF
      IF cl_null(l_pmds013) THEN LET l_pmds013 = l_apca.apca058 END IF      #160120-00011#2
      #161104-00049#6 add ------
      #單身存貨科目取得規則：
      #1.若料件類別=E:費用/軟體，入庫單有理由碼(ACC:312)，則用入庫單理由碼+業務部門去agli180取
      #2.若1.取不到，擇用帳款類別+帳套去aapi011取存貨科目(SCC:8504)
      #3.若2.也取不到，則放單頭存貨科目
#      IF l_pmds100 <> '4' THEN   #190220-00035#1 add #190731-00005#1 mark
      IF l_pmds100 <> '4' OR (l_pmds100 = '4' AND l_pmds000 = '14' ) THEN   #190731-00005#1 add
   #      IF l_apcb.apcb001 MATCHES '[12]1' THEN #181203-00041#1---mark
         IF l_apcb.apcb001 MATCHES '[12]1' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN   #181203-00041#1---add
            #抓取入庫單的理由碼
            SELECT pmdt051 INTO l_pmdt051
              FROM pmdt_t
             WHERE pmdtent = g_enterprise
               AND pmdtdocno = l_apcb.apcb002
               AND pmdtseq = l_apcb.apcb003
               AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                  AND imaa001 = pmdt006 and imaa004 ='E')
            
            
            
            IF NOT cl_null(l_pmdt051) THEN
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
               #190305-00001#2   add-E
                  #180910-00069#1 add begin---
                  IF cl_null(l_apca.apca015) AND not cl_null(l_apcb.apcb010) THEN
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apcb.apcb010,'312',l_pmdt051,
                                                              l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  ELSE 
                  #180910-00069#1 add end------
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'312',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  END IF  #180910-00069#1 add
               END IF   #190305-00001#2 add
            END IF
            
            #191010-00012#1---add---str
            #理由码抓取顺序是入库单/仓退单 > 收货单 >采购单 >请购单
            IF cl_null(l_pmdt051) THEN #理由码为空找上一个单据
               LET l_pmds006 = ''
               SELECT DISTINCT pmds006 INTO l_pmds006
                 FROM pmdt_t,pmds_t
                WHERE pmdtent = pmdsent
                  AND pmdtdocno = pmdsdocno
                  AND pmdtent = g_enterprise
                  AND pmdtdocno = l_apcb.apcb002
                  AND pmdtseq = l_apcb.apcb003
                  AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                     AND imaa001 = pmdt006 and imaa004 ='E')
               IF NOT cl_null(l_pmds006) THEN  #不为空说明他有收货单，在去找收货单的理由吗
                  #抓取收货單的理由碼
                  SELECT pmdt051 INTO l_pmdt051
                    FROM pmdt_t
                   WHERE pmdtent = g_enterprise
                     AND pmdtdocno = l_pmds006
                     AND pmdtseq = l_apcb.apcb003
                     AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdt006 and imaa004 ='E')   
               END IF
               IF cl_null(l_pmdt051) THEN #如果上面的IF还是空需要去找采购单的理由码
                   SELECT pmdt001,pmdt002 INTO l_pmdt001t,l_pmdt002t
                     FROM pmdt_t
                    WHERE pmdtent = g_enterprise
                      AND pmdtdocno = l_apcb.apcb002
                      AND pmdtseq = l_apcb.apcb003
                      AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdt006 AND imaa004 ='E')
                  SELECT pmdn049 INTO l_pmdt051
                    FROM pmdn_t
                   WHERE pmdnent = g_enterprise
                     AND pmdnseq = l_pmdt002t
                     AND pmdndocno = l_pmdt001t
                     AND pmdn001 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdn001 AND imaa004 ='E')   
                  IF cl_null(l_pmdt051) THEN #如果上面的IF还是空需要去找请购单的理由码
                     SELECT pmdl008 INTO l_pmdl008
                       FROM pmdl_t
                      WHERE pmdlent = g_enterprise
                        AND pmdldocno = l_pmdt001t
                     IF NOT cl_null(l_pmdl008) THEN
                        SELECT pmdb031 INTO l_pmdt051
                          FROM pmdb_t
                         WHERE pmdbent = g_enterprise
                           AND pmdbdocno =  l_pmdl008
                           AND pmdbseq =  l_pmdt002t 
                           AND pmdb004 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別=E:費用/軟體
                                        AND imaa001 = pmdb004 AND imaa004 ='E')                              
                     END IF
                     IF NOT cl_null(l_pmdt051) THEN
                        #190305-00001#2   add-S
                        IF l_apcb.apcb001 = '21' THEN
                           LET l_type = ''
                           IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                           IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                           CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                              RETURNING g_sub_success,l_apcb.apcb021
                        END IF
                        IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
                        #190305-00001#2   add-E
                           #请购单理由码
                           CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'265',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                           RETURNING g_sub_success,l_apcb.apcb021,g_errno
                        END IF   #190305-00001#2 add
                     END IF
                  ELSE
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
                     #190305-00001#2   add-E
                        #采购单理由码
                        CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'265',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                        RETURNING g_sub_success,l_apcb.apcb021,g_errno
                     END IF   #190305-00001#2 add
                  END IF
               ELSE
                  #190305-00001#2   add-S
                  IF l_apcb.apcb001 = '21' THEN
                     LET l_type = ''
                     IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                     IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                     CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                        RETURNING g_sub_success,l_apcb.apcb021
                  END IF
                  IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 = '11' OR ( (l_apcb.apcb001 = '19' OR l_apcb.apcb001 = '29') AND NOT cl_null(l_apcb.apcb004) )  THEN
                  #190305-00001#2   add-E
                     #收货单有理由码
                     CALL s_fin_dept_reasons_with_ld_get_account(l_apca.apca015,'269',l_pmdt051,
                                                                 l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb.apcb021,g_errno
                  END IF   #190305-00001#2 add
               END IF                 
            END IF
            #191010-00012#1---add---end
            
         END IF
      #190220-00035#1---add---str--
      #4:倉退折讓(純金額折讓),單身科目先抓agli161抓不到在直接取aapi011的"折讓科目"(因為會影響成本)
      ELSE
         #190812-00010#5 add s---#销售分群aimm214
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         #190812-00010#5 add e---           
         #190305-00001#2   add-S
         IF l_apcb.apcb001 = '21' THEN
            LET l_type = ''
            IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
            IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
            CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
         #190305-00001#2   add-E
            #190806-00046#1 add(s)
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) #190812-00010#5 mod l_pmds013-->l_kind
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF   #190305-00001#2 add
         IF cl_null(l_apcb.apcb021) THEN
         #190806-00046#1 add(e)
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
         END IF #190806-00046#1 add
      END IF  
      #190220-00035#1---add---end--
      
     #190813-00006#1---add----str
      #仓退单对应账款单单身科目抓取，单头科目维持原逻辑（单头科目从aapi011抓取）
      #纯金额折让  依apmt580单身料号性质判断是取agli161还是aapi011
      #料号性质=A或M   先取agli161，取不到再取aapi011折让科目（此时折让需纳入成本计算，折让科目维护的就是存货科目）
      #        ELSE 直接取aapi011折让科目（此时折让不需纳入成本计算，折让科目一般维护的就是费用科目）
      #非纯金额折让   先取agli161，取不到再取aapi011仓退科目（不看料号性质）（此种仓退需纳入成本计算，仓退科目维护的就是存货科目）
         
      IF l_pmds000 = '7' OR l_pmds000 = '14' OR l_pmds000 = '15' THEN
         LET l_apcb.apcb021 = ''
         IF l_pmds100 = '4' THEN # 纯金额折让
            LET l_cnt = 0
            #判断料件类别是否是A或M
            SELECT COUNT(*) INTO l_cnt
                 FROM pmdt_t
                WHERE pmdtent = g_enterprise
                  AND pmdtdocno = l_apcb.apcb002
                  AND pmdtseq = l_apcb.apcb003
                  AND pmdt006 IN (SELECT imaa001 FROM imaa_t WHERE imaaent = g_enterprise #取aimm212的料件類別
                                     AND imaa001 = pmdt006 and (imaa004 ='A' OR imaa004 ='M'))
            IF cl_null(l_cnt) THEN
               LET l_cnt = 0
            END IF
            IF l_cnt > 0 THEN
                #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                  
                  FOREACH s_aapp131_pmdu006_c3 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF

               #190815-00012#1---add---end
               #190812-00010#5 add s---#销售分群aimm214
               IF NOT cl_null(l_apcb.apcb004) THEN 
                  IF NOT cl_null(l_imaf141) THEN
                     LET l_kind = l_pmds013,"@",l_imaf141
                  ELSE 
                     LET l_kind = l_pmds013            
                  END IF  
               END IF            
               #190812-00010#5 add e---                
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
                  #大于0说明料件类别 = A:组合/加工品 或 M:材料/零件/商品
                  CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)  #190812-00010#5 mod l_pmds013-->l_kind
                        RETURNING g_sub_success,l_apcb.apcb021
               END IF   #190305-00001#2 add
               IF cl_null(l_apcb.apcb021) THEN
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF 
            ELSE
               #190305-00001#2   add-S
               IF l_apcb.apcb001 = '21' THEN
                  LET l_type = ''
                  IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                  IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                  CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                     RETURNING g_sub_success,l_apcb.apcb021
               END IF
               IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
               #190305-00001#2   add-E
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF   #190305-00001#2 add
            END IF
         ELSE    # 非纯金额折让
               #190815-00012#1---add---str
               #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
               IF l_pmdt062 = 'Y' THEN
                  
                  FOREACH s_aapp131_pmdu006_c3 INTO l_pmdu006
                     LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                     #190305-00001#2   add-S
                     IF l_apcb.apcb001 = '21' THEN
                        LET l_type = ''
                        IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                        IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                        CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                           RETURNING g_sub_success,l_apcb.apcb021
                     END IF
                     IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                     #190305-00001#2   add-E
                        CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                        RETURNING g_sub_success,l_apcb.apcb021  
                     END IF   #190305-00001#2 add
                     IF NOT cl_null(l_apcb.apcb021) THEN  
                        #如果apcb021有数据说明这个库位有对应得存货科目  
                        LET l_pmdt016 =  l_pmdu006
                        EXIT FOREACH                        
                     END IF
                  END FOREACH
               END IF
               #190812-00010#5 add s---#销售分群aimm214
               IF NOT cl_null(l_apcb.apcb004) THEN 
                  IF NOT cl_null(l_imaf141) THEN
                     LET l_kind = l_pmds013,"@",l_imaf141
                  ELSE 
                     LET l_kind = l_pmds013            
                  END IF  
               END IF            
               #190812-00010#5 add e---    
               #190815-00012#1---add---end
             #190305-00001#2   add-S
             IF l_apcb.apcb001 = '21' THEN
                LET l_type = ''
                IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                   RETURNING g_sub_success,l_apcb.apcb021
             END IF
             IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
             #190305-00001#2   add-E
                CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)  #190812-00010#5 mod l_pmds013-->l_kind
                        RETURNING g_sub_success,l_apcb.apcb021
             END IF   #190305-00001#2 add
               IF cl_null(l_apcb.apcb021) THEN
                  CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_24') RETURNING g_sub_success,l_apcb.apcb021,g_errno
               END IF 
         END IF
      END IF
      #190813-00006#1---add----str
      #210204-00021#1---add----str
      #委外仓退也取agli161的加工费科目抓不到在直接取aapi011的"折讓科目"
      IF l_pmds100 = '4' AND l_pmds000 = '14' THEN
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         
         IF l_apcb.apcb001 = '21' THEN
            #委外加工费科目               
            CALL s_get_item_acc(l_apcb.apcbld,'16',l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016) 
                     RETURNING g_sub_success,l_apcb.apcb021
         END IF  
         IF cl_null(l_apcb.apcb021) THEN
            CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_23') RETURNING g_sub_success,l_apcb.apcb021,g_errno
         END IF 
      END IF
      #210204-00021#1---add----end
      IF cl_null(l_apcb.apcb021) THEN
      #161104-00049#6 add end---
        #CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,'','','','')    #160120-00011#2 mark
          #190815-00012#1---add---str
          #启用多库储，循环多库储明细的库位。如果有一个库位设置科目。则就用这个库位的科目。如果都没有，则用*
          IF l_pmdt062 = 'Y' THEN
             
             FOREACH s_aapp131_pmdu006_c3 INTO l_pmdu006
                LET l_pmdt016 =  l_pmdu006  #先把l_pmdu006得值给pmdt016 #190819-00035#1---add
                #190305-00001#2   add-S
                IF l_apcb.apcb001 = '21' THEN
                   LET l_type = ''
                   IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
                   IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
                   CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
                      RETURNING g_sub_success,l_apcb.apcb021
                END IF
                IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
                #190305-00001#2   add-E
                   CALL s_aapp131_item_acc_fetch(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_pmds013,l_pmds012,l_apca.apcacomp,l_pmdu006)
                   RETURNING g_sub_success,l_apcb.apcb021  
                END IF   #190305-00001#2 add
                IF NOT cl_null(l_apcb.apcb021) THEN  
                   #如果apcb021有数据说明这个库位有对应得存货科目  
                   LET l_pmdt016 =  l_pmdu006
                   EXIT FOREACH                        
                END IF
             END FOREACH
          END IF

          #190815-00012#1---add---end
         #190812-00010#5 add s---#销售分群aimm214
         IF NOT cl_null(l_apcb.apcb004) THEN 
            IF NOT cl_null(l_imaf141) THEN
               LET l_kind = l_pmds013,"@",l_imaf141
            ELSE 
               LET l_kind = l_pmds013            
            END IF  
         END IF            
         #190812-00010#5 add e---             
         #190305-00001#2   add-S
         IF l_apcb.apcb001 = '21' THEN
            LET l_type = ''
            IF l_pmds100 = '1' THEN LET l_type = '31' END IF   #仓退退回->取存货类仓退科目
            IF l_pmds100 = '4' THEN LET l_type = '32' END IF   #仓退折让(纯金额折让)->取存货类进货金额折让科目 
            CALL s_get_item_acc(l_apcb.apcbld,l_type,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)
               RETURNING g_sub_success,l_apcb.apcb021
         END IF
         IF (cl_null(l_apcb.apcb021) AND l_apcb.apcb001 = '21') OR l_apcb.apcb001 <> '21' THEN
         #190305-00001#2   add-E
            CALL s_get_item_acc(l_apcb.apcbld,l_acctype,l_apcb.apcb004,l_kind,l_pmds012,l_apca.apcacomp,l_pmdt016)   #160120-00011#2 #190812-00010#5 mod l_pmds013-->l_kind 
                 RETURNING g_sub_success,l_apcb.apcb021
         END IF   #190305-00001#2 add     
         #170526-00019#1--add--str--lujh
         SELECT imaa004 INTO l_imaa004
           FROM imaa_t
          WHERE imaaent = g_enterprise
            AND imaa001 = l_apcb.apcb004
         IF l_imaa004 = 'E' THEN 
            SELECT imag011 INTO l_imag011
              FROM imag_t
             WHERE imagent = g_enterprise
               AND imagsite = l_apca.apcacomp
               AND imag001 = l_apcb.apcb004 #190104-00036#1 add               
              #AND imag011 = l_apcb.apcb004 #190104-00036#1 mark
            IF cl_null(l_imag011) THEN
               LET l_apcb.apcb021 = ''
            END IF
         END IF
         #170526-00019#1--add--end--lujh
      END IF  #161104-00049#6
      IF cl_null(l_apcb.apcb021) THEN   
         LET l_apcb.apcb021 = l_apca.apca036    #會計科目--費用會計科目
      END IF
      #200805-00007#1 add -s
      #费用料件理由码不为空时优先根据理由码取科目
      IF (l_apcb.apcb001 = '11' OR l_apcb.apcb001 = '21') AND NOT cl_null(l_apcb.apcb014) AND NOT cl_null(l_apcb010) THEN
         LET l_apcb021 = NULL
         CALL s_fin_dept_reasons_with_ld_get_account(l_apcb010,'3212',l_apcb.apcb014,l_apca.apcald,'11',l_apca.apcadocdt)
                     RETURNING g_sub_success,l_apcb021,g_errno
         IF NOT cl_null(l_apcb021) THEN
            LET l_apcb.apcb021 = l_apcb021
         END IF
      END IF
      #200805-00007#1 add -e  
      #判別是否沖暫估
      LET l_apcb.apcb023 = 'N'
      IF l_apcb.apcb001 = '16' OR l_apcb.apcb001 = '26' THEN
         #批次作業, 發票單身(aist310/aapt110)有輸入來源別為16/26者，則處理自動沖其他暫估單
         LET l_apcb.apcb023 = 'Y'
      ELSE
         #可依據同幣別沖暫估
         #170527-00015#1---mark---str--
         #LET l_cnt = 0
         ##SELECT count(*) INTO l_cnt        #161114-00009#1 mark
         #SELECT count(apcadocno) INTO l_cnt #161114-00009#1 add
         #  FROM apca_t,apcb_t,apcc_t
         # WHERE apcaent = apcbent AND apcaent = apccent AND apcald = apcbld AND apcald = apccld
         #   AND apcadocno=apcbdocno AND apcadocno = apccdocno AND apcc108 - apcc109 <> 0
         #   AND apcastus = 'Y'      AND apca001 IN ('01','02')
         #   AND apcaent = g_enterprise   AND apcald = p_ld
         #   AND apcb002 = l_tmp.pmdtdocno AND apcb003 = l_tmp.pmdtseq
         #IF l_cnt > 0 THEN
         #   LET l_apcb.apcb023 = 'Y'
         #END IF
         #170527-00015#1---mark---end--
         #170527-00015#1---add---str--
         LET l_apcb007 = 0
         LET l_apcb0071 = 0
         SELECT apcb007 INTO l_apcb007   #aapt320立暫估數量
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcald = apcbld
            AND apcadocno = apcbdocno
            AND apcastus = 'Y'
            AND apca001 IN ('01','02')
            AND apcaent = g_enterprise AND apcald = p_ld
            AND apcb002 = l_tmp.pmdtdocno AND apcb003 = l_tmp.pmdtseq
            AND apcadocdt <= l_apca.apcadocdt   #170617-00182#1 add

         SELECT apcb007 INTO l_apcb0071   #aapt300沖暫估數量
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcald = apcbld
            AND apcadocno = apcbdocno
            AND apcastus <> 'X'
            AND apca001 NOT IN ('01','02')
            AND apcb023 = 'Y'
            AND apcaent = g_enterprise AND apcald = p_ld
            AND apcb002 = l_tmp.pmdtdocno AND apcb003 = l_tmp.pmdtseq
         IF cl_null(l_apcb007) THEN LET l_apcb007 = 0 END IF
         IF cl_null(l_apcb0071) THEN LET l_apcb0071 = 0 END IF
        #IF l_apcb007 - l_apcb0071 > 0 THEN   #200916-00030#1 mark
         IF l_apcb007 - l_apcb0071 <> 0 THEN   #200916-00030#1 add
            LET l_apcb.apcb023 = 'Y'
         END IF
         #170527-00015#1---add---end--
      END IF
      LET l_apcb.apcb029 = l_apca.apca035 
      
      IF p_sfin2002 MATCHES '[12]' THEN   
         LET l_apcb.apcb030 = l_apca.apca008
      ELSE
         LET l_apcb.apcb030  = l_tmp.pmds031
      END IF      
      LET l_apcb.apcb034 = l_pmds012            #160120-00011#2
      LET l_apcb.apcb051 = l_ar[3].chr
      IF cl_null(l_apcb.apcb051) THEN LET l_apcb.apcb051 = l_apca.apca014 END IF #180730-00034#1 add 來源單未取到資訊時,以單頭帶入
      LET l_apcb.apcb054 = l_apca.apca004    #帳款對象   #180726-00061#1 add  
      LET l_apcb.apcb055 = l_apca.apca005    #付款對象   #180726-00061#1 add
      LET l_apcb.apcb100 = l_apca.apca100    #幣別
      LET l_apcb.apcb101 = l_pmdt036         #原幣單價
     #CALL s_curr_round_ld('1',p_ld,l_apcb.apcb100,l_apcb.apcb101,1) RETURNING g_sub_success,g_errno,l_apcb.apcb101 #140806-00012#12    #170430-00006#2 mark
      CALL s_num_round(g_round_type,l_apcb.apcb101,g_ooaj003) RETURNING l_apcb.apcb101  #170430-00006#2 add
      LET l_apcb.apcb102 = l_apca.apca101    #本幣匯率
      
      #直接用入庫/倉退單金額扣除已立帳之金額,推算剩餘入庫/倉退單可立帳金額---str---#
      IF l_apca.apca013 = 'Y' THEN   #含稅
         SELECT SUM(apcb105) INTO l_apcb105_u
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcadocno = apcbdocno
            AND apcastus <> 'X'
            AND apcbent = g_enterprise   AND apcbld = l_apcb.apcbld
            AND apcb002 = l_apcb.apcb002 AND apcb003 = l_apcb.apcb003
            AND NOT EXISTS ( SELECT 1 FROM apca_t 
                              WHERE apcaent= apcbent
                                AND apcadocno = apcbdocno AND apcald = apcbld
                                AND SUBSTR(apca001,1,1) = '0')
         IF cl_null(l_apcb105_u) THEN LET l_apcb105_u = 0 END IF
         #可立帳金額 = 入庫/倉退單含稅金額 - 已立帳含稅金額
         LET l_apcb105 = l_pmdt039 - l_apcb105_u
      ELSE
         SELECT SUM(apcb103) INTO l_apcb105_u
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcadocno = apcbdocno
            AND apcastus <> 'X'
            AND apcbent = g_enterprise   AND apcbld = l_apcb.apcbld
            AND apcb002 = l_apcb.apcb002 AND apcb003 = l_apcb.apcb003
            AND NOT EXISTS ( SELECT 1 FROM apca_t 
                              WHERE apcaent= apcbent
                                AND apcadocno = apcbdocno AND apcald = apcbld
                                AND SUBSTR(apca001,1,1) = '0')
         IF cl_null(l_apcb105_u) THEN LET l_apcb105_u = 0 END IF
         #可立帳金額 = 入庫/倉退單未稅金額 - 已立帳未稅金額
         LET l_apcb105 = l_pmdt038 - l_apcb105_u
      END IF
      #可立帳金額小於0,直接給予金額0
      IF l_apcb105 < 0 THEN LET l_apcb105 = 0 END IF
      #----------------------------------------------------------------end---#
     #CALL s_tax_ins(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,    #160519-00011#1  mark
      CALL s_tax_ins2(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,   #160519-00011#1  
                     l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apca.apca101,p_ld,l_apca.apca121,l_apca.apca131)
           RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                     l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                     l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                     l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      LET l_apcb.apcb111 = l_apcb.apcb101 * l_apca.apca101     #本幣單價
     #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcb.apcb111,1) RETURNING g_sub_success,g_errno,l_apcb.apcb111  #140806-00012#12  #170430-00006#2 mark
      CALL s_num_round(g_round_type,l_apcb.apcb111,g_ooaj003_g) RETURNING l_apcb.apcb111  #170430-00006#2 add
      LET l_apcb.apcb121 = l_apca.apca121
      LET l_apcb.apcb131 = l_apca.apca131
      #141204-00017#1-str--
      IF l_flag  AND l_ld_type = '1' THEN  #150305apo
         #全部數量立帳者,取得來源入庫單原幣金額立帳
         CALL s_aapp131_entire_amount('3',l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb002,
                                       l_apcb.apcb003,l_apcb.apcb049,l_apcb.apcb050,l_apcb.apcb103,l_apcb.apcb104,
                                       l_apcb.apcb105,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,l_apca.apca101) 
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115
        #200204-00010#1-(S) mark          
        # #150925--s
        # #取得全額之後,要再以全額重推本幣
        # #含稅傳入含稅金額,未稅傳入未稅金額
        # IF l_apca.apca013 = 'Y' THEN
        #    LET l_apcb105 = l_apcb.apcb105
        # ELSE
        #    LET l_apcb105 = l_apcb.apcb103
        # END IF
        ##CALL s_tax_ins(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,   #160519-00011#1 mark
        # CALL s_tax_ins2(p_docno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb105,  #160519-00011#1 
        #                l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apca.apca101,p_ld,l_apca.apca121,l_apca.apca131)
        #      RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
        #                l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
        #                l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
        #                l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
        # #150925--e
        #200204-00010#1-(E) mark         
      END IF  #150305apo          
      #141204-00017#1-end--
      
      LET l_apcb.apcb107 = 0  LET l_apcb.apcb108 = l_apcb.apcb103
      LET l_apcb.apcb117 = 0  LET l_apcb.apcb118 = l_apcb.apcb113  LET l_apcb.apcb119 = 0
      LET l_apcb.apcb127 = 0  LET l_apcb.apcb128 = l_apcb.apcb123
      LET l_apcb.apcb137 = 0  LET l_apcb.apcb138 = l_apcb.apcb133
      
      #150904 by 03538--s
      #折讓情形單身須給發票號碼
      IF s_aap_pmds000_chk('3',l_pmds000) THEN
         LET l_apcb.apcb027 = l_pmdt049
         LET l_apcb.apcb028 = l_pmdt050
      END IF
      #150904 by 03538--e
     #CALL s_aapp131_get_apcb1x6(l_apcb.*) RETURNING l_apcb.apcb106,l_apcb.apcb116,l_apcb.apcb126,l_apcb.apcb136  #160120-00011#2 #170430-00006#2 mark
      CALL s_aapp131_get_apcb1x6(l_apcb.*,g_round_type,g_ooaj004,g_ooaj004_g,g_ooaj004_g2,g_ooaj004_g3)   #170430-00006#2 add
       RETURNING l_apcb.apcb106,l_apcb.apcb116,l_apcb.apcb126,l_apcb.apcb136                              #170430-00006#2 add
      
      #180705-00083#1 add -s
      IF cl_null(l_apcb.apcb051) THEN
         LET l_apcb.apcb051 = l_apca.apca014
      END IF
      IF cl_null(l_apcb.apcb010) THEN
         LET l_apcb.apcb010 = l_apca.apca015
      END IF
      #固定核算项默认值
      INITIALIZE l_apcb2.* TO NULL
      LET l_apcb2.apcb054 = l_apcb.apcb054
      LET l_apcb2.apcb055 = l_apcb.apcb055
      LET l_apcb2.apcb051 = l_apcb.apcb051
      LET l_apcb2.apcb010 = l_apcb.apcb010
      LET l_apcb2.apcb011 = l_apcb.apcb011
      LET l_apcb2.apcb024 = l_apcb.apcb024
      LET l_apcb2.apcb036 = l_apcb.apcb036
      LET l_apcb2.apcb012 = l_apcb.apcb012
      LET l_apcb2.apcb033 = l_apcb.apcb033
      LET l_apcb2.apcb034 = l_apcb.apcb034
      LET l_apcb2.apcb035 = l_apcb.apcb035
      LET l_apcb2.apcb015 = l_apcb.apcb015
      LET l_apcb2.apcb016 = l_apcb.apcb016
      CALL s_aapp131_get_accitem(l_apcb.apcbld,l_apcb.apcb021,l_apcb.apcb029,p_xrcd009,l_apcb2.*)
         RETURNING l_apcb.apcb054,l_apcb.apcb055,l_apcb.apcb051,l_apcb.apcb010,l_apcb.apcb011,
                   l_apcb.apcb024,l_apcb.apcb036,l_apcb.apcb012,l_apcb.apcb033,l_apcb.apcb034,
                   l_apcb.apcb035,l_apcb.apcb015,l_apcb.apcb016
      #180705-00083#1 add -e
      
      #161102-00015#7 --s add
      IF cl_null(l_apcb.apcb010) THEN LET l_apcb.apcb010 = " " END IF  #業務部門
      IF cl_null(l_apcb.apcb011) THEN LET l_apcb.apcb011 = " " END IF  #責任中心
      IF cl_null(l_apcb.apcb012) THEN LET l_apcb.apcb012 = " " END IF  #產品類別
      IF cl_null(l_apcb.apcb015) THEN LET l_apcb.apcb015 = " " END IF  #專案編號
      IF cl_null(l_apcb.apcb016) THEN LET l_apcb.apcb016 = " " END IF  #WBS編號
      IF cl_null(l_apcb.apcb024) THEN LET l_apcb.apcb024 = " " END IF  #區域
      IF cl_null(l_apcb.apcb030) THEN LET l_apcb.apcb030 = " " END IF  #付款條件
      IF cl_null(l_apcb.apcb033) THEN LET l_apcb.apcb033 = " " END IF  #經營方式
      IF cl_null(l_apcb.apcb034) THEN LET l_apcb.apcb034 = " " END IF  #通路
      IF cl_null(l_apcb.apcb035) THEN LET l_apcb.apcb035 = " " END IF  #品牌
      IF cl_null(l_apcb.apcb036) THEN LET l_apcb.apcb036 = " " END IF  #客群
      IF cl_null(l_apcb.apcb037) THEN LET l_apcb.apcb037 = " " END IF  #自由核算項一
      IF cl_null(l_apcb.apcb038) THEN LET l_apcb.apcb038 = " " END IF  #自由核算項二
      IF cl_null(l_apcb.apcb039) THEN LET l_apcb.apcb039 = " " END IF  #自由核算項三
      IF cl_null(l_apcb.apcb040) THEN LET l_apcb.apcb040 = " " END IF  #自由核算項四
      IF cl_null(l_apcb.apcb041) THEN LET l_apcb.apcb041 = " " END IF  #自由核算項五
      IF cl_null(l_apcb.apcb042) THEN LET l_apcb.apcb042 = " " END IF  #自由核算項六
      IF cl_null(l_apcb.apcb043) THEN LET l_apcb.apcb043 = " " END IF  #自由核算項七
      IF cl_null(l_apcb.apcb044) THEN LET l_apcb.apcb044 = " " END IF  #自由核算項八
      IF cl_null(l_apcb.apcb045) THEN LET l_apcb.apcb045 = " " END IF  #自由核算項九
      IF cl_null(l_apcb.apcb046) THEN LET l_apcb.apcb046 = " " END IF  #自由核算項十
      IF cl_null(l_apcb.apcb051) THEN LET l_apcb.apcb051 = " " END IF  #業務人員
      IF cl_null(l_apcb.apcb054) THEN LET l_apcb.apcb054 = " " END IF  #帳款對象
      IF cl_null(l_apcb.apcb055) THEN LET l_apcb.apcb055 = " " END IF  #付款對象
      #161102-00015#7 --e add      
      #170510-00041#1---s--- 取得科目所對應的預算係項
      LET l_apcb.apcb017 = ''      
      SELECT pmdt075 INTO l_apcb.apcb017 FROM pmdt_t WHERE pmdtent = g_enterprise 
         AND pmdtdocno = l_apcb.apcb002 AND pmdtseq = l_apcb.apcb003
      IF cl_null(l_apcb.apcb017) THEN      
         SELECT bgao004 INTO l_apcb.apcb017  FROM bgao_t
          WHERE bgaoent = g_enterprise
            AND bgao001 = (SELECT DISTINCT bgaa008 FROM bgaa_t WHERE bgaaent = g_enterprise AND bgaa001 = l_apca.apca059 )        
            AND bgao002 = (SELECT glaa004 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = l_apcb.apcbld)
            AND bgao003 =l_apcb.apcb021   
      END IF            
      #170510-00041#1---e--- 取得科目所對應的預算係項      
     #170430-00006#2---mark---start---
     #INSERT INTO apcb_t VALUES(l_apcb.*) #161111-00048#2 mark
     ##161111-00048#2 --s add
     #INSERT INTO apcb_t(apcbent,apcbld,apcblegl,apcborga,apcbsite,
     #                   apcbdocno,apcbseq,apcb001,apcb002,apcb003,
     #                   apcb004,apcb005,apcb006,apcb007,apcb008,
     #                   apcb009,apcb010,apcb011,apcb012,apcb013,
     #                   apcb014,apcb015,apcb016,apcb017,apcb018,
     #                   apcb019,apcb020,apcb021,apcb022,apcb023,
     #                   apcb024,apcb025,apcb026,apcb027,apcb028,
     #                   apcb029,apcb030,apcb032,apcb033,apcb034,
     #                   apcb035,apcb036,apcb037,apcb038,apcb039,
     #                   apcb040,apcb041,apcb042,apcb043,apcb044,
     #                   apcb045,apcb046,apcb047,apcb048,apcb049,
     #                   apcb050,apcb051,apcb100,apcb101,apcb102,
     #                   apcb103,apcb104,apcb105,apcb106,apcb107,
     #                   apcb108,apcb111,apcb113,apcb114,apcb115,
     #                   apcb116,apcb117,apcb118,apcb119,apcb121,
     #                   apcb123,apcb124,apcb125,apcb126,apcb127,
     #                   apcb128,apcb131,apcb133,apcb134,apcb135,
     #                   apcb136,apcb137,apcb138,apcbud001,apcbud002,
     #                   apcbud003,apcbud004,apcbud005,apcbud006,apcbud007,
     #                   apcbud008,apcbud009,apcbud010,apcbud011,apcbud012,
     #                   apcbud013,apcbud014,apcbud015,apcbud016,apcbud017,
     #                   apcbud018,apcbud019,apcbud020,apcbud021,apcbud022,
     #                   apcbud023,apcbud024,apcbud025,apcbud026,apcbud027,
     #                   apcbud028,apcbud029,apcbud030,apcb052,apcb053,
     #                   apcb054,apcb055)
     #VALUES(l_apcb.apcbent,l_apcb.apcbld,l_apcb.apcblegl,l_apcb.apcborga,l_apcb.apcbsite,
     #       l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003,
     #       l_apcb.apcb004,l_apcb.apcb005,l_apcb.apcb006,l_apcb.apcb007,l_apcb.apcb008,
     #       l_apcb.apcb009,l_apcb.apcb010,l_apcb.apcb011,l_apcb.apcb012,l_apcb.apcb013,
     #       l_apcb.apcb014,l_apcb.apcb015,l_apcb.apcb016,l_apcb.apcb017,l_apcb.apcb018,
     #       l_apcb.apcb019,l_apcb.apcb020,l_apcb.apcb021,l_apcb.apcb022,l_apcb.apcb023,
     #       l_apcb.apcb024,l_apcb.apcb025,l_apcb.apcb026,l_apcb.apcb027,l_apcb.apcb028,
     #       l_apcb.apcb029,l_apcb.apcb030,l_apcb.apcb032,l_apcb.apcb033,l_apcb.apcb034,
     #       l_apcb.apcb035,l_apcb.apcb036,l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,
     #       l_apcb.apcb040,l_apcb.apcb041,l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,
     #       l_apcb.apcb045,l_apcb.apcb046,l_apcb.apcb047,l_apcb.apcb048,l_apcb.apcb049,
     #       l_apcb.apcb050,l_apcb.apcb051,l_apcb.apcb100,l_apcb.apcb101,l_apcb.apcb102,
     #       l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb106,l_apcb.apcb107,
     #       l_apcb.apcb108,l_apcb.apcb111,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
     #       l_apcb.apcb116,l_apcb.apcb117,l_apcb.apcb118,l_apcb.apcb119,l_apcb.apcb121,
     #       l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,l_apcb.apcb126,l_apcb.apcb127,
     #       l_apcb.apcb128,l_apcb.apcb131,l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135,
     #       l_apcb.apcb136,l_apcb.apcb137,l_apcb.apcb138,l_apcb.apcbud001,l_apcb.apcbud002,
     #       l_apcb.apcbud003,l_apcb.apcbud004,l_apcb.apcbud005,l_apcb.apcbud006,l_apcb.apcbud007,
     #       l_apcb.apcbud008,l_apcb.apcbud009,l_apcb.apcbud010,l_apcb.apcbud011,l_apcb.apcbud012,
     #       l_apcb.apcbud013,l_apcb.apcbud014,l_apcb.apcbud015,l_apcb.apcbud016,l_apcb.apcbud017,
     #       l_apcb.apcbud018,l_apcb.apcbud019,l_apcb.apcbud020,l_apcb.apcbud021,l_apcb.apcbud022,
     #       l_apcb.apcbud023,l_apcb.apcbud024,l_apcb.apcbud025,l_apcb.apcbud026,l_apcb.apcbud027,
     #       l_apcb.apcbud028,l_apcb.apcbud029,l_apcb.apcbud030,l_apcb.apcb052,l_apcb.apcb053,
     #       l_apcb.apcb054,l_apcb.apcb055
     #161111-00048#2 --e add
     #170430-00006#2---mark---end---
     #180705-00083#1 mark -s
#     #180704-00022#1 add ---s 根據agli043設定預帶自由核算項值     
#     CALL l_array.clear()
#     LET l_array[1].chr = l_apcb.apcb037
#     LET l_array[2].chr = l_apcb.apcb038   
#     LET l_array[3].chr = l_apcb.apcb039
#     LET l_array[4].chr = l_apcb.apcb040
#     LET l_array[5].chr = l_apcb.apcb041
#     LET l_array[6].chr = l_apcb.apcb042
#     LET l_array[7].chr = l_apcb.apcb043
#     LET l_array[8].chr = l_apcb.apcb044
#     LET l_array[9].chr = l_apcb.apcb045
#     LET l_array[10].chr = l_apcb.apcb046      
#     CALL s_aapp131_upd_accitem_free(g_prog1,l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb021,l_apcb.apcb029,l_array)
#     RETURNING l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,l_apcb.apcb040,l_apcb.apcb041,
#               l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,l_apcb.apcb045,l_apcb.apcb046      
#     #180704-00022#1 add ---e   
     #180705-00083#1 mark -e     
     #170430-00006#2---add---start---
     EXECUTE s_aapp131_ins_apcb_c USING
             l_apcb.apcbent,l_apcb.apcbld,l_apcb.apcblegl,l_apcb.apcborga,l_apcb.apcbsite,
             l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb001,l_apcb.apcb002,l_apcb.apcb003,
             l_apcb.apcb004,l_apcb.apcb005,l_apcb.apcb006,l_apcb.apcb007,l_apcb.apcb008,
             l_apcb.apcb009,l_apcb.apcb010,l_apcb.apcb011,l_apcb.apcb012,l_apcb.apcb013,
             l_apcb.apcb014,l_apcb.apcb015,l_apcb.apcb016,l_apcb.apcb017,l_apcb.apcb018,
             l_apcb.apcb019,l_apcb.apcb020,l_apcb.apcb021,l_apcb.apcb022,l_apcb.apcb023,
             l_apcb.apcb024,l_apcb.apcb025,l_apcb.apcb026,l_apcb.apcb027,l_apcb.apcb028,
             l_apcb.apcb029,l_apcb.apcb030,l_apcb.apcb032,l_apcb.apcb033,l_apcb.apcb034,
             l_apcb.apcb035,l_apcb.apcb036,l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,
             l_apcb.apcb040,l_apcb.apcb041,l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,
             l_apcb.apcb045,l_apcb.apcb046,l_apcb.apcb047,l_apcb.apcb048,l_apcb.apcb049,
             l_apcb.apcb050,l_apcb.apcb051,l_apcb.apcb100,l_apcb.apcb101,l_apcb.apcb102,
             l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,l_apcb.apcb106,l_apcb.apcb107,
             l_apcb.apcb108,l_apcb.apcb111,l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
             l_apcb.apcb116,l_apcb.apcb117,l_apcb.apcb118,l_apcb.apcb119,l_apcb.apcb121,
             l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,l_apcb.apcb126,l_apcb.apcb127,
             l_apcb.apcb128,l_apcb.apcb131,l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135,
             l_apcb.apcb136,l_apcb.apcb137,l_apcb.apcb138,l_apcb.apcbud001,l_apcb.apcbud002,
             l_apcb.apcbud003,l_apcb.apcbud004,l_apcb.apcbud005,l_apcb.apcbud006,l_apcb.apcbud007,
             l_apcb.apcbud008,l_apcb.apcbud009,l_apcb.apcbud010,l_apcb.apcbud011,l_apcb.apcbud012,
             l_apcb.apcbud013,l_apcb.apcbud014,l_apcb.apcbud015,l_apcb.apcbud016,l_apcb.apcbud017,
             l_apcb.apcbud018,l_apcb.apcbud019,l_apcb.apcbud020,l_apcb.apcbud021,l_apcb.apcbud022,
             l_apcb.apcbud023,l_apcb.apcbud024,l_apcb.apcbud025,l_apcb.apcbud026,l_apcb.apcbud027,
             l_apcb.apcbud028,l_apcb.apcbud029,l_apcb.apcbud030,l_apcb.apcb052,l_apcb.apcb053,
             l_apcb.apcb054,l_apcb.apcb055
     #170430-00006#2---add---start---
      #180705-00083#1 add -s
      #自由核算项默认值
      INITIALIZE l_apcb3.* TO NULL
      LET l_apcb3.apcb037= l_apcb.apcb037
      LET l_apcb3.apcb038= l_apcb.apcb038
      LET l_apcb3.apcb039= l_apcb.apcb039
      LET l_apcb3.apcb040= l_apcb.apcb040
      LET l_apcb3.apcb041= l_apcb.apcb041
      LET l_apcb3.apcb042= l_apcb.apcb042
      LET l_apcb3.apcb043= l_apcb.apcb043
      LET l_apcb3.apcb044= l_apcb.apcb044
      LET l_apcb3.apcb045= l_apcb.apcb045
      LET l_apcb3.apcb046= l_apcb.apcb046
      CALL s_aapp131_get_accitem_free(g_prog1,l_apcb.apcbld,l_apcb.apcbdocno,l_apcb.apcbseq,l_apcb.apcb021,l_apcb.apcb029,p_xrcd009,l_apcb3.*)
      #180705-00083#1 add -e
      ##50703-00021#24   增加預算控管---s---
      #IF g_dfin5002 = 'Y' THEN #200928-00025#1 mark
      IF g_dfin5002 MATCHES '[YC]' THEN #200928-00025#1 add
         #181030-00022#5 ---s---      
         ##170510-00041#1 ---s---#將來源預算轉出 
         #LET l_bgbd039 = 0
         #SELECT bgbd039 INTO l_bgbd039 FROM bgbd_t WHERE bgbdent = g_enterprise 
         #   AND bgbd037 = l_apcb.apcb008 AND bgbd038 = l_apcb.apcb009
         #IF cl_null(l_bgbd039) THEN LET l_bgbd039 = 0 END IF
         #IF l_bgbd039 < l_apcb.apcb103 THEN LET l_bgbd039 = l_apcb.apcb103 END IF         
         #UPDATE bgbd_t SET bgbd040 = bgbd040 + l_bgbd039
         # WHERE bgbdent = g_enterprise
         #   AND bgbd037 = l_apcb.apcb008 #參考 採購單
         #   AND bgbd038 = l_apcb.apcb009    
         ##170510-00041#1 ---e---#將來源預算轉出
         #181030-00022#5---e---  
         #201127-00012#1 add---(s)                  
         IF NOT cl_null(l_apcb.apcb002) AND NOT cl_null(l_apcb.apcb003) THEN 
            LET l_tran.docno     = l_apca.apcadocno
            LET l_tran.ld        = l_apca.apcald
            LET l_tran.docdt     = l_apca.apcadocdt
            LET l_tran.comp      = l_apca.apcacomp
            LET l_tran.seq       = l_apcb.apcbseq
            LET l_tran.bgbd007   = l_apcb.apcb017
            LET l_tran.bgbd037   = l_apcb.apcb002
            LET l_tran.bgbd038   = l_apcb.apcb003
            LET l_tran.bgbd040   = l_apcb.apcb113   #201201 add by DSC.JoyHsiao
            LET l_tran.bgbd007_t = '' #修改前的預算細項
            LET l_tran.bgbd037_t = '' #修改前的單號
            LET l_tran.bgbd038_t = '' #修改前的項次
            LET l_tran.bgbd040_t = 0  #修改前被占用的金額
            LET l_tran.act       = 'A'                     
            #預算轉移
            LET l_ls_js = util.JSON.stringify(l_tran)                  
            CALL s_abg_tran(l_ls_js) RETURNING g_sub_success,g_errno 
         END IF
         #201127-00012#1 add---(e)     
         #檢核是否存在該科目預算
         #CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','1') #200928-00025#1 mark
         CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','4')  #200928-00025#1 add
             RETURNING g_sub_success,g_errno
         #200928-00025#1 mark ---s
         #IF NOT g_sub_success THEN
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = g_errno
         #   LET g_errparam.extend = ''
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #   LET r_success = FALSE
         #   CONTINUE FOREACH 
         #END IF          
         #200928-00025#1 mark ---e
         IF g_sub_success THEN #200928-00025#1 add
            CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'','2')
                RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               LET g_errparam.replace[1] = l_apcb.apcb017
               #200928-00025#1 add ---e              
               CALL cl_err()
               LET r_success = FALSE
               CONTINUE FOREACH      
            END IF                            
            #新增一筆bgbd_t               
            CALL s_aapt300_bgbd_upd(l_apcb.apcbdocno,l_apcb.apcbld,l_apcb.apcbseq,'I','3')
               RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = g_errno
               LET g_errparam.popup  = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               #200928-00025#1 add ---e               
               CALL cl_err()     
               LET r_success = FALSE            
               CONTINUE FOREACH
            END IF
         #200928-00025#1 add ---s
         ELSE
            IF g_dfin5002 = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               #200928-00025#1 add ---s
               LET g_errparam.columns[1] = cl_getmsg("adb-00472",g_lang)   #單號
               LET g_errparam.values[1] = l_apcb.apcb002
               LET g_errparam.columns[2] = cl_getmsg("lib-00153",g_lang)   #項次
               LET g_errparam.values[2] = l_apcb.apcb003
               #200928-00025#1 add ---e               
               CALL cl_err()
               LET r_success = FALSE            
               CONTINUE FOREACH
            END IF
         END IF
         #200928-00025#1 add ---e            
      END IF          
      ##50703-00021#24   增加預算控管---e---
   END FOREACH
   
   LET l_cnt = 0
   #SELECT count(*) INTO l_cnt         #161114-00009#1 mark
   SELECT count(apcbdocno) INTO l_cnt  #161114-00009#1 add
     FROM apcb_t
    WHERE apcbent = g_enterprise 
      AND apcbld  = p_ld AND apcbdocno=p_docno AND apcb023 = 'Y'
   IF l_cnt > 0 THEN
      CALL s_aapp131_ins_apcf('0',p_ld,p_docno) RETURNING g_sub_success
   END IF
   
      
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 自動產生沖暫估
# Memo...........:
# Date & Author..: 15/04/01 By Belle
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcf(p_type,p_ld,p_apcadocno)
DEFINE p_type        LIKE type_t.chr1        #執行類型(0:全部 1:非雜項 2:雜項)
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_apcb001     LIKE apcb_t.apcb001     #來源作業
DEFINE p_apcadocno   LIKE apca_t.apcadocno   #立帳單據
DEFINE r_success     LIKE type_t.num5
#161111-00048#2 --s mark
#DEFINE l_apca        RECORD LIKE apca_t.*
#DEFINE l_apcb        RECORD LIKE apcb_t.*
#DEFINE l_apcc        RECORD LIKE apcc_t.*
#DEFINE l_apcf        RECORD LIKE apcf_t.*
#161111-00048#2 --e mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE l_apcb RECORD  #應付憑單單身
       apcbent LIKE apcb_t.apcbent, #企業編號
       apcbld LIKE apcb_t.apcbld, #帳套
       apcblegl LIKE apcb_t.apcblegl, #核算組織
       apcborga LIKE apcb_t.apcborga, #帳務歸屬組織(來源組織)
       apcbsite LIKE apcb_t.apcbsite, #應付帳務組織
       apcbdocno LIKE apcb_t.apcbdocno, #單號
       apcbseq LIKE apcb_t.apcbseq, #項次
       apcb001 LIKE apcb_t.apcb001, #來源類型
       apcb002 LIKE apcb_t.apcb002, #來源業務單據號碼
       apcb003 LIKE apcb_t.apcb003, #來源業務單據項次
       apcb004 LIKE apcb_t.apcb004, #產品編號
       apcb005 LIKE apcb_t.apcb005, #品名規格
       apcb006 LIKE apcb_t.apcb006, #單位
       apcb007 LIKE apcb_t.apcb007, #計價數量
       apcb008 LIKE apcb_t.apcb008, #參考單據號碼
       apcb009 LIKE apcb_t.apcb009, #參考單據項次
       apcb010 LIKE apcb_t.apcb010, #業務部門
       apcb011 LIKE apcb_t.apcb011, #責任中心
       apcb012 LIKE apcb_t.apcb012, #產品類別
       apcb013 LIKE apcb_t.apcb013, #搭贈
       apcb014 LIKE apcb_t.apcb014, #理由碼
       apcb015 LIKE apcb_t.apcb015, #專案編號
       apcb016 LIKE apcb_t.apcb016, #WBS編號
       apcb017 LIKE apcb_t.apcb017, #預算細項
       apcb018 LIKE apcb_t.apcb018, #专柜编号
       apcb019 LIKE apcb_t.apcb019, #開票性質
       apcb020 LIKE apcb_t.apcb020, #稅別
       apcb021 LIKE apcb_t.apcb021, #費用會計科目
       apcb022 LIKE apcb_t.apcb022, #正負值
       apcb023 LIKE apcb_t.apcb023, #沖暫估單否
       apcb024 LIKE apcb_t.apcb024, #區域
       apcb025 LIKE apcb_t.apcb025, #傳票號碼
       apcb026 LIKE apcb_t.apcb026, #傳票項次
       apcb027 LIKE apcb_t.apcb027, #發票編號
       apcb028 LIKE apcb_t.apcb028, #發票號碼
       apcb029 LIKE apcb_t.apcb029, #應付帳款科目
       apcb030 LIKE apcb_t.apcb030, #付款條件
       apcb032 LIKE apcb_t.apcb032, #訂金序次
       apcb033 LIKE apcb_t.apcb033, #經營方式
       apcb034 LIKE apcb_t.apcb034, #通路
       apcb035 LIKE apcb_t.apcb035, #品牌
       apcb036 LIKE apcb_t.apcb036, #客群
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046, #自由核算項十
       apcb047 LIKE apcb_t.apcb047, #摘要
       apcb048 LIKE apcb_t.apcb048, #來源訂購單號
       apcb049 LIKE apcb_t.apcb049, #開票單號
       apcb050 LIKE apcb_t.apcb050, #開票項次
       apcb051 LIKE apcb_t.apcb051, #業務人員
       apcb100 LIKE apcb_t.apcb100, #交易原幣
       apcb101 LIKE apcb_t.apcb101, #交易原幣單價
       apcb102 LIKE apcb_t.apcb102, #原幣匯率
       apcb103 LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104 LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105 LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb106 LIKE apcb_t.apcb106, #交易幣標準成本金額
       apcb107 LIKE apcb_t.apcb107, #入庫單單價
       apcb108 LIKE apcb_t.apcb108, #交易原幣成本認列金額
       apcb111 LIKE apcb_t.apcb111, #本幣單價
       apcb113 LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114 LIKE apcb_t.apcb114, #本幣稅額
       apcb115 LIKE apcb_t.apcb115, #本幣含稅金額
       apcb116 LIKE apcb_t.apcb116, #本幣標準成本金額
       apcb117 LIKE apcb_t.apcb117, #NO USE
       apcb118 LIKE apcb_t.apcb118, #本幣成本認列金額
       apcb119 LIKE apcb_t.apcb119, #應開發票含稅金額
       apcb121 LIKE apcb_t.apcb121, #本位幣二匯率
       apcb123 LIKE apcb_t.apcb123, #本位幣二未稅金額
       apcb124 LIKE apcb_t.apcb124, #本位幣二稅額
       apcb125 LIKE apcb_t.apcb125, #本位幣二含稅金額
       apcb126 LIKE apcb_t.apcb126, #本幣二標準成本金額
       apcb127 LIKE apcb_t.apcb127, #NO USE
       apcb128 LIKE apcb_t.apcb128, #本位幣二成本認列金額
       apcb131 LIKE apcb_t.apcb131, #本位幣三匯率
       apcb133 LIKE apcb_t.apcb133, #本位幣三未稅金額
       apcb134 LIKE apcb_t.apcb134, #本位幣三稅額
       apcb135 LIKE apcb_t.apcb135, #本位幣三含稅金額
       apcb136 LIKE apcb_t.apcb136, #本幣三標準成本金額
       apcb137 LIKE apcb_t.apcb137, #NO USE
       apcb138 LIKE apcb_t.apcb138, #本位幣三成本認列金額
       apcbud001 LIKE apcb_t.apcbud001, #自定義欄位(文字)001
       apcbud002 LIKE apcb_t.apcbud002, #自定義欄位(文字)002
       apcbud003 LIKE apcb_t.apcbud003, #自定義欄位(文字)003
       apcbud004 LIKE apcb_t.apcbud004, #自定義欄位(文字)004
       apcbud005 LIKE apcb_t.apcbud005, #自定義欄位(文字)005
       apcbud006 LIKE apcb_t.apcbud006, #自定義欄位(文字)006
       apcbud007 LIKE apcb_t.apcbud007, #自定義欄位(文字)007
       apcbud008 LIKE apcb_t.apcbud008, #自定義欄位(文字)008
       apcbud009 LIKE apcb_t.apcbud009, #自定義欄位(文字)009
       apcbud010 LIKE apcb_t.apcbud010, #自定義欄位(文字)010
       apcbud011 LIKE apcb_t.apcbud011, #自定義欄位(數字)011
       apcbud012 LIKE apcb_t.apcbud012, #自定義欄位(數字)012
       apcbud013 LIKE apcb_t.apcbud013, #自定義欄位(數字)013
       apcbud014 LIKE apcb_t.apcbud014, #自定義欄位(數字)014
       apcbud015 LIKE apcb_t.apcbud015, #自定義欄位(數字)015
       apcbud016 LIKE apcb_t.apcbud016, #自定義欄位(數字)016
       apcbud017 LIKE apcb_t.apcbud017, #自定義欄位(數字)017
       apcbud018 LIKE apcb_t.apcbud018, #自定義欄位(數字)018
       apcbud019 LIKE apcb_t.apcbud019, #自定義欄位(數字)019
       apcbud020 LIKE apcb_t.apcbud020, #自定義欄位(數字)020
       apcbud021 LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
       apcbud022 LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
       apcbud023 LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
       apcbud024 LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
       apcbud025 LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
       apcbud026 LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
       apcbud027 LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
       apcbud028 LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
       apcbud029 LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
       apcbud030 LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
       apcb052 LIKE apcb_t.apcb052, #稅額
       apcb053 LIKE apcb_t.apcb053, #含稅金額
       apcb054 LIKE apcb_t.apcb054, #帳款對象
       apcb055 LIKE apcb_t.apcb055  #付款對象
END RECORD
DEFINE l_apcc RECORD  #應付多帳期檔
       apccent LIKE apcc_t.apccent, #企業編號
       apccld LIKE apcc_t.apccld, #帳套
       apcccomp LIKE apcc_t.apcccomp, #法人
       apcclegl LIKE apcc_t.apcclegl, #核算組織
       apccsite LIKE apcc_t.apccsite, #帳務中心
       apccdocno LIKE apcc_t.apccdocno, #應付帳款單號碼
       apccseq LIKE apcc_t.apccseq, #項次
       apcc001 LIKE apcc_t.apcc001, #分期帳款序
       apcc002 LIKE apcc_t.apcc002, #應付款別性質
       apcc003 LIKE apcc_t.apcc003, #應付款日
       apcc004 LIKE apcc_t.apcc004, #容許票據到期日
       apcc005 LIKE apcc_t.apcc005, #帳款起算日
       apcc006 LIKE apcc_t.apcc006, #正負值
       apcc007 LIKE apcc_t.apcc007, #原幣已請款金額
       apcc008 LIKE apcc_t.apcc008, #發票編號
       apcc009 LIKE apcc_t.apcc009, #發票號碼
       apcc010 LIKE apcc_t.apcc010, #發票日期
       apcc011 LIKE apcc_t.apcc011, #交易單據日期
       apcc012 LIKE apcc_t.apcc012, #立帳日期
       apcc013 LIKE apcc_t.apcc013, #交易認定日期
       apcc014 LIKE apcc_t.apcc014, #出入庫扣帳日期
       apcc100 LIKE apcc_t.apcc100, #交易原幣別
       apcc101 LIKE apcc_t.apcc101, #原幣匯率
       apcc102 LIKE apcc_t.apcc102, #原幣重估後匯率
       apcc103 LIKE apcc_t.apcc103, #NO USE
       apcc104 LIKE apcc_t.apcc104, #NO USE
       apcc105 LIKE apcc_t.apcc105, #NO USE
       apcc106 LIKE apcc_t.apcc106, #NO USE
       apcc107 LIKE apcc_t.apcc107, #NO USE
       apcc108 LIKE apcc_t.apcc108, #原幣應付金額
       apcc109 LIKE apcc_t.apcc109, #原幣付款沖帳金額
       apcc113 LIKE apcc_t.apcc113, #重評價調整數
       apcc114 LIKE apcc_t.apcc114, #NO USE
       apcc115 LIKE apcc_t.apcc115, #NO USE
       apcc116 LIKE apcc_t.apcc116, #NO USE
       apcc117 LIKE apcc_t.apcc117, #NO USE
       apcc118 LIKE apcc_t.apcc118, #本幣應付金額
       apcc119 LIKE apcc_t.apcc119, #本幣付款沖帳金額
       apcc120 LIKE apcc_t.apcc120, #本位幣二幣別
       apcc121 LIKE apcc_t.apcc121, #本位幣二匯率
       apcc122 LIKE apcc_t.apcc122, #本位幣二重估後匯率
       apcc123 LIKE apcc_t.apcc123, #重評價調整數
       apcc124 LIKE apcc_t.apcc124, #NO USE
       apcc125 LIKE apcc_t.apcc125, #NO USE
       apcc126 LIKE apcc_t.apcc126, #NO USE
       apcc127 LIKE apcc_t.apcc127, #NO USE
       apcc128 LIKE apcc_t.apcc128, #本位幣二應付金額
       apcc129 LIKE apcc_t.apcc129, #本位幣二付款沖帳金額
       apcc130 LIKE apcc_t.apcc130, #本位幣三幣別
       apcc131 LIKE apcc_t.apcc131, #本位幣三匯率
       apcc132 LIKE apcc_t.apcc132, #本位幣三重估後匯率
       apcc133 LIKE apcc_t.apcc133, #重評價調整數
       apcc134 LIKE apcc_t.apcc134, #NO USE
       apcc135 LIKE apcc_t.apcc135, #NO USE
       apcc136 LIKE apcc_t.apcc136, #NO USE
       apcc137 LIKE apcc_t.apcc137, #NO USE
       apcc138 LIKE apcc_t.apcc138, #本位幣三應付金額
       apcc139 LIKE apcc_t.apcc139, #本位幣三付款沖帳金額
       apccud001 LIKE apcc_t.apccud001, #自定義欄位(文字)001
       apccud002 LIKE apcc_t.apccud002, #自定義欄位(文字)002
       apccud003 LIKE apcc_t.apccud003, #自定義欄位(文字)003
       apccud004 LIKE apcc_t.apccud004, #自定義欄位(文字)004
       apccud005 LIKE apcc_t.apccud005, #自定義欄位(文字)005
       apccud006 LIKE apcc_t.apccud006, #自定義欄位(文字)006
       apccud007 LIKE apcc_t.apccud007, #自定義欄位(文字)007
       apccud008 LIKE apcc_t.apccud008, #自定義欄位(文字)008
       apccud009 LIKE apcc_t.apccud009, #自定義欄位(文字)009
       apccud010 LIKE apcc_t.apccud010, #自定義欄位(文字)010
       apccud011 LIKE apcc_t.apccud011, #自定義欄位(數字)011
       apccud012 LIKE apcc_t.apccud012, #自定義欄位(數字)012
       apccud013 LIKE apcc_t.apccud013, #自定義欄位(數字)013
       apccud014 LIKE apcc_t.apccud014, #自定義欄位(數字)014
       apccud015 LIKE apcc_t.apccud015, #自定義欄位(數字)015
       apccud016 LIKE apcc_t.apccud016, #自定義欄位(數字)016
       apccud017 LIKE apcc_t.apccud017, #自定義欄位(數字)017
       apccud018 LIKE apcc_t.apccud018, #自定義欄位(數字)018
       apccud019 LIKE apcc_t.apccud019, #自定義欄位(數字)019
       apccud020 LIKE apcc_t.apccud020, #自定義欄位(數字)020
       apccud021 LIKE apcc_t.apccud021, #自定義欄位(日期時間)021
       apccud022 LIKE apcc_t.apccud022, #自定義欄位(日期時間)022
       apccud023 LIKE apcc_t.apccud023, #自定義欄位(日期時間)023
       apccud024 LIKE apcc_t.apccud024, #自定義欄位(日期時間)024
       apccud025 LIKE apcc_t.apccud025, #自定義欄位(日期時間)025
       apccud026 LIKE apcc_t.apccud026, #自定義欄位(日期時間)026
       apccud027 LIKE apcc_t.apccud027, #自定義欄位(日期時間)027
       apccud028 LIKE apcc_t.apccud028, #自定義欄位(日期時間)028
       apccud029 LIKE apcc_t.apccud029, #自定義欄位(日期時間)029
       apccud030 LIKE apcc_t.apccud030, #自定義欄位(日期時間)030
       apcc015 LIKE apcc_t.apcc015, #付款條件
       apcc016 LIKE apcc_t.apcc016, #帳款類型
       apcc017 LIKE apcc_t.apcc017, #採購單號  #190423-00042#17 add ,
       apcc018 LIKE apcc_t.apcc018, #專案編號  #190423-00042#17 add
       apcc019 LIKE apcc_t.apcc019  #WBS編號  #190423-00042#17 add
END RECORD
DEFINE l_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
#161111-00048#2 --e add
DEFINE l_apcadocdt   LIKE apca_t.apcadocdt   #單據日
DEFINE l_apca004     LIKE apca_t.apca004     #帳款對象
DEFINE l_apca005     LIKE apca_t.apca005     #付款對象
DEFINE l_apca100     LIKE apca_t.apca100     #幣別
DEFINE l_apcb001     LIKE apcb_t.apcb001     #單據性質
DEFINE l_apcb002     LIKE apcb_t.apcb002     #入庫單號
DEFINE l_apcb003     LIKE apcb_t.apcb003     #入庫單項次
DEFINE l_type        LIKE type_t.chr1        #1:非雜項/2:雜項
#DEFINE l_type_diff   LIKE type_t.chr1        #1:依據每筆計算價差匯差/2:彙總每筆價差匯差  #180314-00018#1增加说明 3.依据来源组织计算价差汇差 #180821-00038#16 mark
DEFINE l_flag        LIKE type_t.chr1        #是否
DEFINE l_sql         STRING
DEFINE l_i,l_cnt     LIKE type_t.num5
DEFINE l_apcf_tmp    DYNAMIC ARRAY OF type_apcf_tmp
DEFINE l_apcf_tmp_s  DYNAMIC ARRAY OF type_apcf_tmp
DEFINE l_apcborga    LIKE apcb_t.apcborga             #150417-00007#87
DEFINE l_sfin2002    LIKE type_t.chr1       #170915-00038#8 add
DEFINE l_apcacomp    LIKE apca_t.apcacomp   #170915-00038#8 add            

   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   LET l_apca004 = NULL      LET l_apca100 = NULL
   LET l_apca005 = NULL      LET l_apcadocdt = NULL

   CALL l_apcf_tmp_s.clear()
#180821-00038#16---mark---(S)
#   LET l_type_diff = 2
#   #180314-00018 add--s
#   SELECT COUNT(UNIQUE apcborga) INTO l_cnt FROM apcb_t
#    WHERE apcbent=g_enterprise
#      AND apcbld=p_ld
#      AND apcbdocno=p_apcadocno
#   IF l_cnt > 1 THEN
#      LET l_type_diff = 3
#   END IF
#   #180314-00018 add--e
#  #180403-00026#1 --s add l_type_diff = 4 有來源與雜項匯差彙總
#  SELECT COUNT(UNIQUE apcb001) INTO l_cnt FROM apcb_t
#   WHERE apcbent = g_enterprise
#     AND apcbld = p_ld
#     AND apcbdocno = p_apcadocno
#     AND apcb023 = 'Y'
#  IF l_cnt > 1 THEN
#     LET l_type_diff = 4
#  END IF   
#  #180403-00026#1 --e add   
#180821-00038#16---mark---(E)
   
   #SELECT apca004,apca005,apca100,apcadocdt                    #170915-00038#8 mark
   SELECT apca004,apca005,apca100,apcadocdt,apcacomp            #170915-00038#8 add apcacomp
     #INTO l_apca004,l_apca005,l_apca100,l_apcadocdt            #170915-00038#8 mark
     INTO l_apca004,l_apca005,l_apca100,l_apcadocdt,l_apcacomp  #170915-00038#8 add l_apcacomp
     FROM apca_t
    WHERE apcaent = g_enterprise 
      AND apcald = p_ld AND apcadocno = p_apcadocno
   CALL cl_get_para(g_enterprise,l_apcacomp,'S-FIN-2002') RETURNING l_sfin2002 #170915-00038#8 add
   
   #SELECT count(*) INTO l_cnt        #161114-00009#1 mark
   SELECT count(apcfdocno) INTO l_cnt #161114-00009#1 add
     FROM apcf_t
    WHERE apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apcf008 = 'DIFF'
   IF l_cnt > 0 THEN
      DELETE FROM apcf_t
       WHERE apcfent = g_enterprise
         AND apcfld  = p_ld AND apcfdocno = p_apcadocno AND apcf008 = 'DIFF'
   END IF
   
   #180314-00018 add--s
   LET l_sql = "SELECT UNIQUE apcborga FROM apcb_t ",
               " WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
               "   AND apcbdocno = ? "
   PREPARE s_aapp130_ins_apcf_p11 FROM l_sql
   DECLARE s_aapp130_ins_apcf_c11 CURSOR FOR s_aapp130_ins_apcf_p11
   #180314-00018 add--e
   
   IF p_type MATCHES '[01]' THEN
      LET l_type = 1
      #LET l_sql = "SELECT apca_t.*,apcc_t.* ", #170502-00061#1 mark 星號改寫欄位代號
      #170502-00061#1 --s add
      LET l_sql = "SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp, ",  #apca---s
                  "       apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt, ",
                  "       apcapstid,apcapstdt,apcastus,apcald,apcacomp, ",
                  "       apcadocno,apcadocdt,apcasite,apca001,apca003, ",
                  "       apca004,apca005,apca006,apca007,apca008, ",
                  "       apca009,apca010,apca011,apca012,apca013, ",
                  "       apca014,apca015,apca016,apca017,apca018, ",
                  "       apca019,apca020,apca021,apca022,apca025, ",
                  "       apca026,apca027,apca028,apca029,apca030, ",
                  "       apca031,apca032,apca033,apca034,apca035, ",
                  "       apca036,apca037,apca038,apca039,apca040, ",
                  "       apca041,apca042,apca043,apca044,apca045, ",
                  "       apca046,apca047,apca048,apca049,apca050, ",
                  "       apca051,apca052,apca053,apca054,apca055, ",
                  "       apca056,apca057,apca058,apca059,apca060, ",
                  "       apca061,apca062,apca063,apca064,apca065, ",
                  "       apca066,apca100,apca101,apca103,apca104, ",
                  "       apca106,apca107,apca108,apca113,apca114, ",
                  "       apca116,apca117,apca118,apca120,apca121, ",
                  "       apca123,apca124,apca126,apca127,apca128, ",
                  "       apca130,apca131,apca133,apca134,apca136, ",
                  "       apca137,apca138,apcaud001,apcaud002,apcaud003, ",
                  "       apcaud004,apcaud005,apcaud006,apcaud007,apcaud008, ",
                  "       apcaud009,apcaud010,apcaud011,apcaud012,apcaud013, ",
                  "       apcaud014,apcaud015,apcaud016,apcaud017,apcaud018, ",
                  "       apcaud019,apcaud020,apcaud021,apcaud022,apcaud023, ",
                  "       apcaud024,apcaud025,apcaud026,apcaud027,apcaud028, ",
                  "       apcaud029,apcaud030,apca067,apca068,apca069, ",
                  "       apca070,apca071,apca072,apca073, ",                 #apca---e
                  "       apccent,apccld,apcccomp,apcclegl,apccsite, ",       #apcc---s
                  "       apccdocno,apccseq,apcc001,apcc002,apcc003, ",
                  "       apcc004,apcc005,apcc006,apcc007,apcc008, ",
                  "       apcc009,apcc010,apcc011,apcc012,apcc013, ",
                  "       apcc014,apcc100,apcc101,apcc102,apcc103, ",
                  "       apcc104,apcc105,apcc106,apcc107,apcc108, ",
                  "       apcc109,apcc113,apcc114,apcc115,apcc116, ",
                  "       apcc117,apcc118,apcc119,apcc120,apcc121, ",
                  "       apcc122,apcc123,apcc124,apcc125,apcc126, ",
                  "       apcc127,apcc128,apcc129,apcc130,apcc131, ",
                  "       apcc132,apcc133,apcc134,apcc135,apcc136, ",
                  "       apcc137,apcc138,apcc139,apccud001,apccud002, ",
                  "       apccud003,apccud004,apccud005,apccud006,apccud007, ",
                  "       apccud008,apccud009,apccud010,apccud011,apccud012, ",
                  "       apccud013,apccud014,apccud015,apccud016,apccud017, ",
                  "       apccud018,apccud019,apccud020,apccud021,apccud022, ",
                  "       apccud023,apccud024,apccud025,apccud026,apccud027, ",
                  "       apccud028,apccud029,apccud030,apcc015,apcc016, ",
                  #"       apcc017 ",                                          #apcc---e  #190423-00042#17 mark
                  "       apcc017,apcc018,apcc019 ", #190423-00042#17 add
      #170502-00061#1 --e add       
                "    FROM apca_t,apcc_t",
                "   WHERE apcaent = apccent AND apcald = apccld ",
                #"     AND apcadocno = apccdocno AND apcc108 - apcc109 <> 0 ",   #170527-00015#1 mark
                "     AND apcadocno = apccdocno ",                               #170527-00015#1 add
                "     AND apcaent = ",g_enterprise," AND apcald = '",p_ld,"'",
                "     AND apcadocno IN (SELECT DISTINCT apcadocno ",
                "                         FROM apca_t,apcb_t a1,apcb_t a2" ,     #apca_t/a1.apcb_t(暫估的TABLE)/a2.apcb_t(是此次立帳單的TABLE)
                "                        WHERE apcaent = a1.apcbent     AND apcald = a1.apcbld",
                "                          AND apcaent = a2.apcbent     AND apcald = a2.apcbld",
                "                          AND apcadocno = a1.apcbdocno AND apca001 IN ('01','02') AND apcastus = 'Y'" ,
                "                          AND apcaent = ",g_enterprise," AND apcald = '",p_ld,"'",
#                "                          AND apcadocdt <='",l_apcadocdt,"' " ,  #200708-00003#1 mark
                "                          AND apcadocdt <= ? " ,  #200708-00003#1 add
                "                          AND a1.apcbent = a2.apcbent ",        #"AND a1.apcb001 = a2.apcb001" ,>>t210跟t320的apcb001不同
                "                          AND a1.apcb002 = a2.apcb002 AND a1.apcb003 = a2.apcb003" ,
                "                          AND a2.apcbdocno = '",p_apcadocno,"') ",
                #"   ORDER BY apcadocdt "           #170915-00038#8 mark
                "   ORDER BY apcadocdt,apccseq "    #170915-00038#8 add
      PREPARE s_aapp130_ins_apcf_p1 FROM l_sql
      DECLARE s_aapp130_ins_apcf_c1 CURSOR FOR s_aapp130_ins_apcf_p1
#      FOREACH s_aapp130_ins_apcf_c1 INTO l_apca.*,l_apcc.*    #取得t320的暫估資料  #200708-00003#1 mark
      FOREACH s_aapp130_ins_apcf_c1 USING l_apcadocdt INTO l_apca.*,l_apcc.*    #取得t320的暫估資料  #200708-00003#1 add
         FOREACH s_aapp130_ins_apcf_c11 USING l_apca.apcadocno INTO l_apcborga  #180314-00018 add
            CALL l_apcf_tmp.clear()
            #190402-00043#2---add---(S) 和雜項一致
            IF cl_null(l_apcc.apcc118) THEN LET l_apcc.apcc118 = 0 END IF
            IF cl_null(l_apcc.apcc113) THEN LET l_apcc.apcc113 = 0 END IF
            LET l_apcc.apcc118 = l_apcc.apcc118 + l_apcc.apcc113
            #190402-00043#2---add---(E)
            #CALL s_aapp131_get_apcf(p_ld,p_apcadocno,l_type,l_apcborga,l_apca.*,l_apcc.*) RETURNING l_flag,l_apcf.*,l_apcf_tmp  #180314-00018 add l_apcborga #180821-00038#16 mark
            CALL s_aapp131_get_apcf2(p_ld,p_apcadocno,l_type,l_apcborga,l_apca.*,l_apcc.*) RETURNING l_flag,l_apcf.*,l_apcf_tmp  #180821-00038#16 add
            CASE l_flag
                 WHEN '1'  CONTINUE FOREACH  #目前的t320已沖完
                 WHEN '2'  EXIT FOREACH      #t300立帳單已沖完
                 OTHERWISE 
                          #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
                           #161111-00048#2 --s add
                           #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
                           IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
                           IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
                           IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
                           IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
                           IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
                           IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
                           IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
                           IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
                           IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
                           IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
                           IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
                           IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
                           IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
                           IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
                           IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
                           IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
                           IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
                           IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
                           IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
                           IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
                           IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
                           IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
                           IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
                           IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
                           #180130-00050#5---add by 10554---(E) 
                           INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                              apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                              apcf009,apcf010,apcf020,apcf021,apcf022,
                                              apcf023,apcf024,apcf025,apcf026,apcf027,
                                              apcf028,apcf029,apcf030,apcf031,apcf032,
                                              apcf033,apcf034,apcf035,apcf036,apcf037,
                                              apcf038,apcf039,apcf040,apcf041,apcf042,
                                              apcf043,apcf044,apcf045,apcf046,apcf047,
                                              apcf048,apcf049,apcf101,apcf102,apcf103,
                                              apcf104,apcf105,apcf106,apcf111,apcf113,
                                              apcf114,apcf115,apcf116,apcf117,apcf122,
                                              apcf123,apcf124,apcf125,apcf126,apcf127,
                                              apcf132,apcf133,apcf134,apcf135,apcf136,
                                              apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                              apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                              apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                              apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                              apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                              apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                              apcfud030)
                           VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                                  l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                                  l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                                  l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                                  l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                                  l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                                  l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                                  l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                                  l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                                  l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                                  l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                                  l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                                  l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                                  l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                                  l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                                  l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                                  l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                                  l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                                  l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                                  l_apcf.apcfud030)
                           #161111-00048#2 --e add
                           #180821-00038#16---mark---(S)
                           #IF l_type_diff = '1' THEN    
                           #   #依據每一筆寫入價差匯差
                           #   #CALL s_aapp131_ins_apcf_diff('1',p_ld,p_apcadocno,l_apcf_tmp)  #180821-00038#16 mark
                           #ELSE
                           #   #每次FOREACH清空都會重展一次l_apcf_tmp的動態陣列，因此用l_apcf_tmp_s當作最後的集合
                           #   FOR l_i = 1 TO l_apcf_tmp.getLength()
                           #       CALL l_apcf_tmp_s.appendElement()
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apca001 = l_apcf_tmp[l_i].apca001
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcborga= l_apcf_tmp[l_i].apcborga     #150417-00007#87
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcfseq = l_apcf_tmp[l_i].apcfseq
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf103 = l_apcf_tmp[l_i].apcf103
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf104 = l_apcf_tmp[l_i].apcf104
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf105 = l_apcf_tmp[l_i].apcf105
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf106 = l_apcf_tmp[l_i].apcf106
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf107 = l_apcf_tmp[l_i].apcf107
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf113 = l_apcf_tmp[l_i].apcf113
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf114 = l_apcf_tmp[l_i].apcf114
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf115 = l_apcf_tmp[l_i].apcf115
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf116 = l_apcf_tmp[l_i].apcf116
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf117 = l_apcf_tmp[l_i].apcf117
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf123 = l_apcf_tmp[l_i].apcf123
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf124 = l_apcf_tmp[l_i].apcf124
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf125 = l_apcf_tmp[l_i].apcf125
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf133 = l_apcf_tmp[l_i].apcf133
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf134 = l_apcf_tmp[l_i].apcf134
                           #       LET l_apcf_tmp_s[l_apcf_tmp_s.getLength()].apcf135 = l_apcf_tmp[l_i].apcf135
                           #   END FOR
                           #END IF
                           #180821-00038#16---mark---(E)
            END CASE
         END FOREACH  #180314-00018 add  
      END FOREACH
#180821-00038#16---mark---(S)
#      IF l_type_diff = '2' THEN
#         CALL s_aapp131_ins_apcf_diff('1',p_ld,p_apcadocno,l_apcf_tmp_s) 
#      END IF
#      #150417-00007#87
#      IF l_type_diff = '3' THEN
#         LET l_sql = " SELECT DISTINCT apcborga FROM apcb_t",
#                     "  WHERE apcbent = ",g_enterprise,
#                     "    AND apcbld = '",p_ld,"' AND apcbdocno = '",p_apcadocno,"' AND apcb023 = 'Y' "
#         PREPARE s_aapp130_ins_apcf_p2 FROM l_sql
#         DECLARE s_aapp130_ins_apcf_c2 CURSOR FOR s_aapp130_ins_apcf_p2
#         FOREACH s_aapp130_ins_apcf_c2 INTO l_apcborga
#            CALL l_apcf_tmp.clear()
#            LET l_apcf_tmp[1].apcf103 = 0
#            LET l_apcf_tmp[1].apcf104 = 0
#            LET l_apcf_tmp[1].apcf105 = 0
#            LET l_apcf_tmp[1].apcf106 = 0
#            LET l_apcf_tmp[1].apcf107 = 0
#            LET l_apcf_tmp[1].apcf113 = 0
#            LET l_apcf_tmp[1].apcf114 = 0
#            LET l_apcf_tmp[1].apcf115 = 0
#            LET l_apcf_tmp[1].apcf116 = 0
#            LET l_apcf_tmp[1].apcf117 = 0
#            LET l_apcf_tmp[1].apcf123 = 0
#            LET l_apcf_tmp[1].apcf124 = 0
#            LET l_apcf_tmp[1].apcf125 = 0
#            LET l_apcf_tmp[1].apcf133 = 0
#            LET l_apcf_tmp[1].apcf134 = 0
#            LET l_apcf_tmp[1].apcf135 = 0
#            FOR l_i = 1 TO l_apcf_tmp_s.getLength()
#               IF l_apcf_tmp_s[l_i].apcborga <> l_apcborga THEN CONTINUE FOR END IF
#               LET l_apcf_tmp[1].apca001 = l_apcf_tmp_s[l_i].apca001
#               LET l_apcf_tmp[1].apcborga= l_apcf_tmp_s[l_i].apcborga
#               LET l_apcf_tmp[1].apcfseq = l_apcf_tmp_s[l_i].apcfseq
#               LET l_apcf_tmp[1].apcf103 = l_apcf_tmp[1].apcf103 + l_apcf_tmp_s[l_i].apcf103
#               LET l_apcf_tmp[1].apcf104 = l_apcf_tmp[1].apcf104 + l_apcf_tmp_s[l_i].apcf104
#               LET l_apcf_tmp[1].apcf105 = l_apcf_tmp[1].apcf105 + l_apcf_tmp_s[l_i].apcf105
#               LET l_apcf_tmp[1].apcf106 = l_apcf_tmp[1].apcf106 + l_apcf_tmp_s[l_i].apcf106
#               LET l_apcf_tmp[1].apcf107 = l_apcf_tmp[1].apcf107 + l_apcf_tmp_s[l_i].apcf107
#               LET l_apcf_tmp[1].apcf113 = l_apcf_tmp[1].apcf113 + l_apcf_tmp_s[l_i].apcf113
#               LET l_apcf_tmp[1].apcf114 = l_apcf_tmp[1].apcf114 + l_apcf_tmp_s[l_i].apcf114
#               LET l_apcf_tmp[1].apcf115 = l_apcf_tmp[1].apcf115 + l_apcf_tmp_s[l_i].apcf115
#               LET l_apcf_tmp[1].apcf116 = l_apcf_tmp[1].apcf116 + l_apcf_tmp_s[l_i].apcf116
#               LET l_apcf_tmp[1].apcf117 = l_apcf_tmp[1].apcf117 + l_apcf_tmp_s[l_i].apcf117
#               LET l_apcf_tmp[1].apcf123 = l_apcf_tmp[1].apcf123 + l_apcf_tmp_s[l_i].apcf123
#               LET l_apcf_tmp[1].apcf124 = l_apcf_tmp[1].apcf124 + l_apcf_tmp_s[l_i].apcf124
#               LET l_apcf_tmp[1].apcf125 = l_apcf_tmp[1].apcf125 + l_apcf_tmp_s[l_i].apcf125
#               LET l_apcf_tmp[1].apcf133 = l_apcf_tmp[1].apcf133 + l_apcf_tmp_s[l_i].apcf133
#               LET l_apcf_tmp[1].apcf134 = l_apcf_tmp[1].apcf134 + l_apcf_tmp_s[l_i].apcf134
#               LET l_apcf_tmp[1].apcf135 = l_apcf_tmp[1].apcf135 + l_apcf_tmp_s[l_i].apcf135
#            END FOR
#            IF l_apcf_tmp.getLength() > 0 THEN
#               CALL s_aapp131_ins_apcf_diff('1',p_ld,p_apcadocno,l_apcf_tmp) 
#            END IF
#         END FOREACH
#      END IF
#      #150417-00007#87      
#180821-00038#16---mark---(E)      
   END IF
   
   CALL l_apcf_tmp.clear() #180821-00038#16 add #清空l_apcf_tmp不然到下一段會重複產生價差匯差
   
   IF p_type MATCHES '[02]' THEN
      LET l_type = 2
      #LET l_sql = "SELECT apca_t.*,apcc_t.* ", #170502-00061#1 mark 星號改寫欄位代號
      #170502-00061#1 --s add
      LET l_sql = "SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp, ",  #apca---s
                  "       apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt, ",
                  "       apcapstid,apcapstdt,apcastus,apcald,apcacomp, ",
                  "       apcadocno,apcadocdt,apcasite,apca001,apca003, ",
                  "       apca004,apca005,apca006,apca007,apca008, ",
                  "       apca009,apca010,apca011,apca012,apca013, ",
                  "       apca014,apca015,apca016,apca017,apca018, ",
                  "       apca019,apca020,apca021,apca022,apca025, ",
                  "       apca026,apca027,apca028,apca029,apca030, ",
                  "       apca031,apca032,apca033,apca034,apca035, ",
                  "       apca036,apca037,apca038,apca039,apca040, ",
                  "       apca041,apca042,apca043,apca044,apca045, ",
                  "       apca046,apca047,apca048,apca049,apca050, ",
                  "       apca051,apca052,apca053,apca054,apca055, ",
                  "       apca056,apca057,apca058,apca059,apca060, ",
                  "       apca061,apca062,apca063,apca064,apca065, ",
                  "       apca066,apca100,apca101,apca103,apca104, ",
                  "       apca106,apca107,apca108,apca113,apca114, ",
                  "       apca116,apca117,apca118,apca120,apca121, ",
                  "       apca123,apca124,apca126,apca127,apca128, ",
                  "       apca130,apca131,apca133,apca134,apca136, ",
                  "       apca137,apca138,apcaud001,apcaud002,apcaud003, ",
                  "       apcaud004,apcaud005,apcaud006,apcaud007,apcaud008, ",
                  "       apcaud009,apcaud010,apcaud011,apcaud012,apcaud013, ",
                  "       apcaud014,apcaud015,apcaud016,apcaud017,apcaud018, ",
                  "       apcaud019,apcaud020,apcaud021,apcaud022,apcaud023, ",
                  "       apcaud024,apcaud025,apcaud026,apcaud027,apcaud028, ",
                  "       apcaud029,apcaud030,apca067,apca068,apca069, ",
                  "       apca070,apca071,apca072,apca073, ",                 #apca---e
                  "       apccent,apccld,apcccomp,apcclegl,apccsite, ",       #apcc---s
                  "       apccdocno,apccseq,apcc001,apcc002,apcc003, ",
                  "       apcc004,apcc005,apcc006,apcc007,apcc008, ",
                  "       apcc009,apcc010,apcc011,apcc012,apcc013, ",
                  "       apcc014,apcc100,apcc101,apcc102,apcc103, ",
                  "       apcc104,apcc105,apcc106,apcc107,apcc108, ",
                  "       apcc109,apcc113,apcc114,apcc115,apcc116, ",
                  "       apcc117,apcc118,apcc119,apcc120,apcc121, ",
                  "       apcc122,apcc123,apcc124,apcc125,apcc126, ",
                  "       apcc127,apcc128,apcc129,apcc130,apcc131, ",
                  "       apcc132,apcc133,apcc134,apcc135,apcc136, ",
                  "       apcc137,apcc138,apcc139,apccud001,apccud002, ",
                  "       apccud003,apccud004,apccud005,apccud006,apccud007, ",
                  "       apccud008,apccud009,apccud010,apccud011,apccud012, ",
                  "       apccud013,apccud014,apccud015,apccud016,apccud017, ",
                  "       apccud018,apccud019,apccud020,apccud021,apccud022, ",
                  "       apccud023,apccud024,apccud025,apccud026,apccud027, ",
                  "       apccud028,apccud029,apccud030,apcc015,apcc016, ",
                  #"       apcc017 ",                                          #apcc---e #190423-00042#17 mark
                  "       apcc017,apcc018,apcc019 ", #190423-00042#17 add
      #170502-00061#1 --e add       
                "    FROM apca_t,apcc_t",
                "   WHERE apcaent = apccent AND apcald = apccld ",
                #"     AND apcadocno = apccdocno AND apcc108 - apcc109 <> 0 ",   #170527-00015#1 mark
                "     AND apcadocno = apccdocno ",                               #170527-00015#1 add
                "     AND apcastus = 'Y' AND apca001 IN ('03','04')  ",
                "     AND apcaent = ",g_enterprise," AND apcald = '",p_ld,"'",
                "     AND apca004 ='",l_apca004,"'   AND apca005= '",l_apca005,"'",
                "     AND apca100 = '",l_apca100,"'",    #雜項沖暫估不區分幣別 #170915-00038#8 remark 雜項沖暫估要區分幣別
#                "     AND apcadocdt <='",l_apcadocdt,"' "  #200708-00003#1 mark 
                "     AND apcadocdt <= ? "  #200708-00003#1 add
                #"   ORDER BY apcadocdt,apcadocno "         #170915-00038#8 mark
                 
       #170915-00038#8 --s add 雜項沖暫估來源為aapt301/341 單身, 因此限定單號存在單身來源單號中          
       IF l_sfin2002 = '3' THEN
          LET l_sql = l_sql,"  AND apcadocno IN (SELECT DISTINCT apcb002 FROM apcb_t  ",
                            "                     WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"' ",
                            "                       AND apcbdocno = '",p_apcadocno,"' AND apcb023 = 'Y'  ",   
                            "                       AND apcb003 = apccseq )  "  
       ELSE
          LET l_sql = l_sql,"  AND apcadocno IN ( SELECT DISTINCT apcb002 FROM apcb_t  ",
                            "                      WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"' ",
                            "                        AND apcbdocno = '",p_apcadocno,"' AND apcb023 = 'Y')  " 
       END IF       
       #170915-00038#8 --e add
       #LET l_sql = l_sql,"   ORDER BY apcadocdt,apcadocno,apccseq "  #170915-00038#8 add  #190423-00042#17 mark
       LET l_sql = l_sql,"   ORDER BY apcadocdt,apcadocno,apccseq,apcc001 " #190423-00042#17 add
       PREPARE s_aapp131_ins_apcf_p2 FROM l_sql
       DECLARE s_aapp131_ins_apcf_c2 CURSOR FOR s_aapp131_ins_apcf_p2
#       FOREACH s_aapp131_ins_apcf_c2 INTO l_apca.*,l_apcc.*    #取得t320的暫估資料  #200708-00003#1 mark
       FOREACH s_aapp131_ins_apcf_c2 USING l_apcadocdt INTO l_apca.*,l_apcc.*    #取得t320的暫估資料  #200708-00003#1 add
          FOREACH s_aapp130_ins_apcf_c11 USING l_apca.apcadocno INTO l_apcborga  #180314-00018 add
             #170413-00040#1---add---str--
             IF cl_null(l_apcc.apcc118) THEN LET l_apcc.apcc118 = 0 END IF
             IF cl_null(l_apcc.apcc113) THEN LET l_apcc.apcc113 = 0 END IF
             LET l_apcc.apcc118 = l_apcc.apcc118 + l_apcc.apcc113
             #170413-00040#1---add---end--
             #CALL s_aapp131_get_apcf(p_ld,p_apcadocno,l_type,l_apcborga,l_apca.*,l_apcc.*) RETURNING l_flag,l_apcf.*,l_apcf_tmp  #180314-00018 add l_apcborga  #180821-00038#16 mark
             CALL s_aapp131_get_apcf2(p_ld,p_apcadocno,l_type,l_apcborga,l_apca.*,l_apcc.*) RETURNING l_flag,l_apcf.*,l_apcf_tmp  #180821-00038#16 add
             CASE l_flag
                  WHEN '1'  CONTINUE FOREACH  #目前的t320已沖完
                  WHEN '2'  EXIT FOREACH      #t300立帳單已沖完
                  OTHERWISE 
                           #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
                           #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
                           IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
                           IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
                           IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
                           IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
                           IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
                           IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
                           IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
                           IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
                           IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
                           IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
                           IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
                           IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
                           IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
                           IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
                           IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
                           IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
                           IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
                           IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
                           IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
                           IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
                           IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
                           IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
                           IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
                           IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
                           #180130-00050#5---add by 10554---(E) 
                            #161111-00048#2 --s add
                            INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                               apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                               apcf009,apcf010,apcf020,apcf021,apcf022,
                                               apcf023,apcf024,apcf025,apcf026,apcf027,
                                               apcf028,apcf029,apcf030,apcf031,apcf032,
                                               apcf033,apcf034,apcf035,apcf036,apcf037,
                                               apcf038,apcf039,apcf040,apcf041,apcf042,
                                               apcf043,apcf044,apcf045,apcf046,apcf047,
                                               apcf048,apcf049,apcf101,apcf102,apcf103,
                                               apcf104,apcf105,apcf106,apcf111,apcf113,
                                               apcf114,apcf115,apcf116,apcf117,apcf122,
                                               apcf123,apcf124,apcf125,apcf126,apcf127,
                                               apcf132,apcf133,apcf134,apcf135,apcf136,
                                               apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                               apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                               apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                               apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                               apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                               apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                               apcfud030)
                            VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                                   l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                                   l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                                   l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                                   l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                                   l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                                   l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                                   l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                                   l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                                   l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                                   l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                                   l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                                   l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                                   l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                                   l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                                   l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                                   l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                                   l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                                   l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                                   l_apcf.apcfud030)
                            #161111-00048#2 --e add
             END CASE
          END FOREACH #180314-00018 add
       END FOREACH
#180821-00038#16---mark---S
#       IF l_type_diff <> '4' THEN #180403-00026#1 add 
#          #雜項一定要整張單沖暫估，不然會抓不準
#          #CALL s_aapp131_ins_apcf_diff('2',p_ld,p_apcadocno,'')         #181219-00056#1 mark
#          CALL l_apcf_tmp.clear()                                        #181219-00056#1 add
#          CALL s_aapp131_ins_apcf_diff('2',p_ld,p_apcadocno,l_apcf_tmp)  #181219-00056#1 add
#       END IF #180403-00026#1 add
#180821-00038#16---mark---E
   END IF   
   CALL s_aapp131_ins_apcf_diff2(p_ld,p_apcadocno)  #180821-00038#16 add 非雜項&雜項產apcf的DIFF資料
#180821-00038#16---mark---S
#   #180403-00026#1 --s add
#   IF l_type_diff = '4' THEN    
#      #依據每一筆寫入價差匯差
#      CALL s_aapp131_ins_apcf_diff('4',p_ld,p_apcadocno,l_apcf_tmp_s)
#   END IF
#   #180403-00026#1 --e add    
#180821-00038#16---mark---E 
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 取得可沖暫估資料
# Memo...........:
# Date & Author..: 15/04/01 By Belle
# Modify.........: #180314-00018 传参增加p_apcborga
################################################################################
PUBLIC FUNCTION s_aapp131_get_apcf(p_ld,p_apcadocno,p_type,p_apcborga,p_apca,p_apcc)
DEFINE p_ld          LIKE apca_t.apcald
DEFINE p_apcadocno   LIKE apca_t.apcadocno   #立帳單據
DEFINE p_type        LIKE type_t.chr1        #1:非雜項/2:雜項
DEFINE p_apcborga    LIKE apcb_t.apcborga    #组织 180314-00018 add
#DEFINE p_apca        RECORD LIKE apca_t.*    #t320暫估單據 #161111-00048#2 mark
#DEFINE p_apcc        RECORD LIKE apcc_t.*    #t320暫估單據 #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE p_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE p_apcc RECORD  #應付多帳期檔
       apccent LIKE apcc_t.apccent, #企業編號
       apccld LIKE apcc_t.apccld, #帳套
       apcccomp LIKE apcc_t.apcccomp, #法人
       apcclegl LIKE apcc_t.apcclegl, #核算組織
       apccsite LIKE apcc_t.apccsite, #帳務中心
       apccdocno LIKE apcc_t.apccdocno, #應付帳款單號碼
       apccseq LIKE apcc_t.apccseq, #項次
       apcc001 LIKE apcc_t.apcc001, #分期帳款序
       apcc002 LIKE apcc_t.apcc002, #應付款別性質
       apcc003 LIKE apcc_t.apcc003, #應付款日
       apcc004 LIKE apcc_t.apcc004, #容許票據到期日
       apcc005 LIKE apcc_t.apcc005, #帳款起算日
       apcc006 LIKE apcc_t.apcc006, #正負值
       apcc007 LIKE apcc_t.apcc007, #原幣已請款金額
       apcc008 LIKE apcc_t.apcc008, #發票編號
       apcc009 LIKE apcc_t.apcc009, #發票號碼
       apcc010 LIKE apcc_t.apcc010, #發票日期
       apcc011 LIKE apcc_t.apcc011, #交易單據日期
       apcc012 LIKE apcc_t.apcc012, #立帳日期
       apcc013 LIKE apcc_t.apcc013, #交易認定日期
       apcc014 LIKE apcc_t.apcc014, #出入庫扣帳日期
       apcc100 LIKE apcc_t.apcc100, #交易原幣別
       apcc101 LIKE apcc_t.apcc101, #原幣匯率
       apcc102 LIKE apcc_t.apcc102, #原幣重估後匯率
       apcc103 LIKE apcc_t.apcc103, #NO USE
       apcc104 LIKE apcc_t.apcc104, #NO USE
       apcc105 LIKE apcc_t.apcc105, #NO USE
       apcc106 LIKE apcc_t.apcc106, #NO USE
       apcc107 LIKE apcc_t.apcc107, #NO USE
       apcc108 LIKE apcc_t.apcc108, #原幣應付金額
       apcc109 LIKE apcc_t.apcc109, #原幣付款沖帳金額
       apcc113 LIKE apcc_t.apcc113, #重評價調整數
       apcc114 LIKE apcc_t.apcc114, #NO USE
       apcc115 LIKE apcc_t.apcc115, #NO USE
       apcc116 LIKE apcc_t.apcc116, #NO USE
       apcc117 LIKE apcc_t.apcc117, #NO USE
       apcc118 LIKE apcc_t.apcc118, #本幣應付金額
       apcc119 LIKE apcc_t.apcc119, #本幣付款沖帳金額
       apcc120 LIKE apcc_t.apcc120, #本位幣二幣別
       apcc121 LIKE apcc_t.apcc121, #本位幣二匯率
       apcc122 LIKE apcc_t.apcc122, #本位幣二重估後匯率
       apcc123 LIKE apcc_t.apcc123, #重評價調整數
       apcc124 LIKE apcc_t.apcc124, #NO USE
       apcc125 LIKE apcc_t.apcc125, #NO USE
       apcc126 LIKE apcc_t.apcc126, #NO USE
       apcc127 LIKE apcc_t.apcc127, #NO USE
       apcc128 LIKE apcc_t.apcc128, #本位幣二應付金額
       apcc129 LIKE apcc_t.apcc129, #本位幣二付款沖帳金額
       apcc130 LIKE apcc_t.apcc130, #本位幣三幣別
       apcc131 LIKE apcc_t.apcc131, #本位幣三匯率
       apcc132 LIKE apcc_t.apcc132, #本位幣三重估後匯率
       apcc133 LIKE apcc_t.apcc133, #重評價調整數
       apcc134 LIKE apcc_t.apcc134, #NO USE
       apcc135 LIKE apcc_t.apcc135, #NO USE
       apcc136 LIKE apcc_t.apcc136, #NO USE
       apcc137 LIKE apcc_t.apcc137, #NO USE
       apcc138 LIKE apcc_t.apcc138, #本位幣三應付金額
       apcc139 LIKE apcc_t.apcc139, #本位幣三付款沖帳金額
       apccud001 LIKE apcc_t.apccud001, #自定義欄位(文字)001
       apccud002 LIKE apcc_t.apccud002, #自定義欄位(文字)002
       apccud003 LIKE apcc_t.apccud003, #自定義欄位(文字)003
       apccud004 LIKE apcc_t.apccud004, #自定義欄位(文字)004
       apccud005 LIKE apcc_t.apccud005, #自定義欄位(文字)005
       apccud006 LIKE apcc_t.apccud006, #自定義欄位(文字)006
       apccud007 LIKE apcc_t.apccud007, #自定義欄位(文字)007
       apccud008 LIKE apcc_t.apccud008, #自定義欄位(文字)008
       apccud009 LIKE apcc_t.apccud009, #自定義欄位(文字)009
       apccud010 LIKE apcc_t.apccud010, #自定義欄位(文字)010
       apccud011 LIKE apcc_t.apccud011, #自定義欄位(數字)011
       apccud012 LIKE apcc_t.apccud012, #自定義欄位(數字)012
       apccud013 LIKE apcc_t.apccud013, #自定義欄位(數字)013
       apccud014 LIKE apcc_t.apccud014, #自定義欄位(數字)014
       apccud015 LIKE apcc_t.apccud015, #自定義欄位(數字)015
       apccud016 LIKE apcc_t.apccud016, #自定義欄位(數字)016
       apccud017 LIKE apcc_t.apccud017, #自定義欄位(數字)017
       apccud018 LIKE apcc_t.apccud018, #自定義欄位(數字)018
       apccud019 LIKE apcc_t.apccud019, #自定義欄位(數字)019
       apccud020 LIKE apcc_t.apccud020, #自定義欄位(數字)020
       apccud021 LIKE apcc_t.apccud021, #自定義欄位(日期時間)021
       apccud022 LIKE apcc_t.apccud022, #自定義欄位(日期時間)022
       apccud023 LIKE apcc_t.apccud023, #自定義欄位(日期時間)023
       apccud024 LIKE apcc_t.apccud024, #自定義欄位(日期時間)024
       apccud025 LIKE apcc_t.apccud025, #自定義欄位(日期時間)025
       apccud026 LIKE apcc_t.apccud026, #自定義欄位(日期時間)026
       apccud027 LIKE apcc_t.apccud027, #自定義欄位(日期時間)027
       apccud028 LIKE apcc_t.apccud028, #自定義欄位(日期時間)028
       apccud029 LIKE apcc_t.apccud029, #自定義欄位(日期時間)029
       apccud030 LIKE apcc_t.apccud030, #自定義欄位(日期時間)030
       apcc015 LIKE apcc_t.apcc015, #付款條件
       apcc016 LIKE apcc_t.apcc016, #帳款類型
       apcc017 LIKE apcc_t.apcc017  #採購單號
END RECORD
#161111-00048#2 --e ass
DEFINE r_flag        LIKE type_t.chr1        #
#DEFINE r_apcf        RECORD LIKE apcf_t.*    #回傳的apcf暫估資料 #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE r_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
#161111-00048#2 --e add

DEFINE l_sfin2011    LIKE type_t.chr1        #迴轉否
DEFINE l_sfin3011    LIKE type_t.chr1        #迴轉否   #150812-00010#3
DEFINE l_sfin3012    LIKE type_t.chr1        #含稅立帳否
DEFINE l_glaacomp    LIKE glaa_t.glaacomp    #所屬法人
DEFINE l_glaa001     LIKE glaa_t.glaa001
DEFINE l_glaa004     LIKE glaa_t.glaa004     #會計科目參照表
DEFINE l_glaa015     LIKE glaa_t.glaa015     #本位幣二啟用
DEFINE l_glaa016     LIKE glaa_t.glaa016     #本位幣二
DEFINE l_glaa017     LIKE glaa_t.glaa017     #本位幣二換算基準
DEFINE l_glaa019     LIKE glaa_t.glaa019     #本位幣三啟用
DEFINE l_glaa020     LIKE glaa_t.glaa020     #本位幣三
DEFINE l_glaa021     LIKE glaa_t.glaa021     #本位幣三換算基準
DEFINE l_glaa025     LIKE glaa_t.glaa025     #本位幣一換算基準
DEFINE l_glac007     LIKE glac_t.glac007     #科目性質

DEFINE l_apca007     LIKE apca_t.apca007
DEFINE l_apca035     LIKE apca_t.apca035
DEFINE l_apca036     LIKE apca_t.apca036
DEFINE l_apca100     LIKE apca_t.apca100     #交易幣幣別
DEFINE l_apca101     LIKE apca_t.apca101     #本幣匯率
DEFINE l_apca121     LIKE apca_t.apca121
DEFINE l_apca131     LIKE apca_t.apca131
DEFINE l_apcb101     LIKE apcb_t.apcb101     #t320暫估單價
DEFINE l_apcc108     LIKE apcc_t.apcc108     #計算用
#180412-00061#1 add--s for 小数误差调整
DEFINE l_apcf105_sum LIKE apcf_t.apcf105     #t300中本暂估单已计算到的被冲的原币总金额
DEFINE l_apcf105_b   LIKE apcf_t.apcf105     #t300中本暂估单非本t300单的被冲的原币总金额
DEFINE l_apcc118     LIKE apcc_t.apcc118     #用于赋值
DEFINE l_apcf115_sum LIKE apcf_t.apcf115     #用于赋值
DEFINE l_apcf115_b   LIKE apcf_t.apcf115     #用于赋值
#180412-00061#1 add--e for 小数误差调整
DEFINE l_apcf103     LIKE apcf_t.apcf103     #計算用
DEFINE l_apcf105     LIKE apcf_t.apcf105     #計算用
DEFINE l_apcb103     LIKE apcb_t.apcb105     #計算用
DEFINE l_apcb105     LIKE apcb_t.apcb105     #計算用
DEFINE l_apcf007     LIKE apcf_t.apcf007     #320可沖帳數量
DEFINE l_apcf0071    LIKE apcf_t.apcf007     #320已沖帳數量
DEFINE l_apcf1       RECORD                  #t320已沖帳
         apcf103     LIKE apcf_t.apcf103,    #原幣未稅金額
         apcf104     LIKE apcf_t.apcf104,    #原幣稅額
         apcf105     LIKE apcf_t.apcf105,    #原幣含稅金額
         apcf113     LIKE apcf_t.apcf113,    #本幣未稅金額
         apcf114     LIKE apcf_t.apcf114,    #本幣稅額
         apcf115     LIKE apcf_t.apcf115,    #本幣含稅金額
         apcf123     LIKE apcf_t.apcf123,    #本幣二未稅金額
         apcf124     LIKE apcf_t.apcf124,    #本幣二稅額
         apcf125     LIKE apcf_t.apcf125,    #本幣二含稅金額
         apcf133     LIKE apcf_t.apcf133,    #本幣三未稅金額
         apcf134     LIKE apcf_t.apcf134,    #本幣三稅額
         apcf135     LIKE apcf_t.apcf135     #本幣三含稅金額
                 END RECORD
DEFINE l_apcf2       RECORD                  #t320立帳數量
         apcf103     LIKE apcf_t.apcf103,
         apcf104     LIKE apcf_t.apcf104,
         apcf105     LIKE apcf_t.apcf105,
         apcf113     LIKE apcf_t.apcf113,
         apcf114     LIKE apcf_t.apcf114,
         apcf115     LIKE apcf_t.apcf115,
         apcf123     LIKE apcf_t.apcf123,
         apcf124     LIKE apcf_t.apcf124,
         apcf125     LIKE apcf_t.apcf125,
         apcf133     LIKE apcf_t.apcf133,
         apcf134     LIKE apcf_t.apcf134,
         apcf135     LIKE apcf_t.apcf135              
                 END RECORD
DEFINE l_apcb002     LIKE apcb_t.apcb002     #t300此次要沖帳-入庫單號
DEFINE l_apcb003     LIKE apcb_t.apcb003     #t300此次要沖帳-入庫單項次
DEFINE l_apcb007     LIKE apcb_t.apcb007     #t300此次要沖帳-入庫單數量
DEFINE l_apcb0071    LIKE apcb_t.apcb007     #
DEFINE l_apcb1       RECORD                  #t300此次要沖帳
         apcb101     LIKE apcb_t.apcb101,
         apcb103     LIKE apcb_t.apcb103,
         apcb104     LIKE apcb_t.apcb104,
         apcb105     LIKE apcb_t.apcb105,
         apcb113     LIKE apcb_t.apcb113,
         apcb114     LIKE apcb_t.apcb114,
         apcb115     LIKE apcb_t.apcb115,
         apcb123     LIKE apcb_t.apcb123,
         apcb124     LIKE apcb_t.apcb124,
         apcb125     LIKE apcb_t.apcb125,
         apcb133     LIKE apcb_t.apcb133,
         apcb134     LIKE apcb_t.apcb134,
         apcb135     LIKE apcb_t.apcb135,
         apcborga    LIKE apcb_t.apcborga,         #來源組織
         apcb010     LIKE apcb_t.apcb010,          #業務部門
         apcb011     LIKE apcb_t.apcb011,          #責任中心
         apcb024     LIKE apcb_t.apcb024,          #區域
         apcb036     LIKE apcb_t.apcb036,          #客群
         apcb004     LIKE apcb_t.apcb004,          #產品類別
         apcb051     LIKE apcb_t.apcb051,          #業務人員
         apcb015     LIKE apcb_t.apcb015,          #專案編號
         apcb016     LIKE apcb_t.apcb016,          #WBS
         apcb033     LIKE apcb_t.apcb033,          #經營方式
         apcb034     LIKE apcb_t.apcb034,          #渠道
         apcb035     LIKE apcb_t.apcb035,          #品牌
         apcb037     LIKE apcb_t.apcb037,          #自由核算項1
         apcb038     LIKE apcb_t.apcb038,          #自由核算項2
         apcb039     LIKE apcb_t.apcb039,          #自由核算項3
         apcb040     LIKE apcb_t.apcb040,          #自由核算項4
         apcb041     LIKE apcb_t.apcb041,          #自由核算項5
         apcb042     LIKE apcb_t.apcb042,          #自由核算項6
         apcb043     LIKE apcb_t.apcb043,          #自由核算項7
         apcb044     LIKE apcb_t.apcb044,          #自由核算項8
         apcb045     LIKE apcb_t.apcb045,          #自由核算項9
         apcb046     LIKE apcb_t.apcb046,          #自由核算項10
         apcb047     LIKE apcb_t.apcb047,          #摘要
         apcb021     LIKE apcb_t.apcb021,          #費用會計科目
         apcb020     LIKE apcb_t.apcb020           #税别   #160524-00004#1
         ,apcb012     LIKE apcb_t.apcb012          #产品类别   #181113-00009#1 add
                 END RECORD
#151012-00014#2-----s
DEFINE lc_param      RECORD
         type        LIKE type_t.chr1,     #類型
         apca004     LIKE apca_t.apca004   #交易對象
                 END RECORD
DEFINE l_desc        LIKE type_t.chr500   #接沒有用到的參數用
DEFINE ls_js         STRING
#151012-00014#2-----e
DEFINE l_apcf_tmp    DYNAMIC ARRAY OF type_apcf_tmp 
DEFINE l_i,l_cnt     LIKE type_t.num5
DEFINE l_rate        LIKE apcf_t.apcf102
DEFINE l_sql         STRING
DEFINE l_apcadocdt1  LIKE apca_t.apcadocdt   #立帳單據-立帳日期
DEFINE l_apcadocdt2  LIKE apca_t.apcadocdt   #暫估單據-立帳日期
DEFINE l_oodb004     LIKE oodb_t.oodb004
DEFINE l_oodb005     LIKE oodb_t.oodb005
DEFINE l_oodb006     LIKE oodb_t.oodb006
DEFINE l_oodb011     LIKE oodb_t.oodb011
DEFINE l_apca012     LIKE apca_t.apca012
DEFINE l_apca011     LIKE apca_t.apca011
DEFINE l_apcacomp    LIKE apca_t.apcacomp
#160816-00022#4 add --s
DEFINE l_pmdt036     LIKE pmdt_t.pmdt036 
DEFINE l_no_use      LIKE apcf_t.apcf116 
DEFINE l_t320_apcb020 LIKE apcb_t.apcb020
DEFINE l_t320_apca100 LIKE apca_t.apca100
DEFINE l_t320_apca101 LIKE apca_t.apca101
DEFINE l_tax_apcf103  LIKE apcb_t.apcb103
DEFINE l_diff_apcf106 LIKE apcf_t.apcf106
#160816-00022#4 add --e
#170328-00023#1 --s add
DEFINE l_t320_apca012 LIKE apca_t.apca012    
DEFINE l_apcc102      LIKE apcc_t.apcc102
#170328-00023#1 --e add
DEFINE l_apcc101      LIKE apcc_t.apcc101  #180412-00061#1 add for 未考虑重评价调整
#170317-00029#3 --s add
DEFINE l_apch         RECORD                 #沖暫估明細檔
         apchent      LIKE apch_t.apchent,   #企業編號
         apchcomp     LIKE apch_t.apchcomp,  #法人
         apchsite     LIKE apch_t.apchsite,  #帳務組織
         apchdocno    LIKE apch_t.apchdocno, #單據號碼
         apchseq      LIKE apch_t.apchseq,   #項次
         apch001      LIKE apch_t.apch001,   #暫估單號
         apch002      LIKE apch_t.apch002,   #暫估項次
         apch003      LIKE apch_t.apch003,   #入庫單號
         apch004      LIKE apch_t.apch004,   #入庫單項次
         apch005      LIKE apch_t.apch005,   #產品編號
         apch006      LIKE apch_t.apch006,   #沖暫估數量
         apch007      LIKE apch_t.apch007,   #原幣未稅單價
         apch008      LIKE apch_t.apch008,   #本幣未稅單價
         apch009      LIKE apch_t.apch009,   #DIFF 原幣價差金額
         apch010      LIKE apch_t.apch010,   #DIFF 本幣價差金額
         apch011      LIKE apch_t.apch011,   #DIFF 本幣匯差金額
         apch012      LIKE apch_t.apch012,   #DIFF 原幣價差單價
         apch013      LIKE apch_t.apch013,   #DIFF 本幣價差單價
         apch014      LIKE apch_t.apch014,   #DIFF 本幣匯差單價
         apchud001    LIKE apch_t.apchud001, #自定義欄位(文字)001
         apchud002    LIKE apch_t.apchud002, #自定義欄位(文字)002
         apchud003    LIKE apch_t.apchud003, #自定義欄位(文字)003
         apchud004    LIKE apch_t.apchud004, #自定義欄位(文字)004
         apchud005    LIKE apch_t.apchud005, #自定義欄位(文字)005
         apchud006    LIKE apch_t.apchud006, #自定義欄位(文字)006
         apchud007    LIKE apch_t.apchud007, #自定義欄位(文字)007
         apchud008    LIKE apch_t.apchud008, #自定義欄位(文字)008
         apchud009    LIKE apch_t.apchud009, #自定義欄位(文字)009
         apchud010    LIKE apch_t.apchud010, #自定義欄位(文字)010
         apchud011    LIKE apch_t.apchud011, #自定義欄位(數字)011
         apchud012    LIKE apch_t.apchud012, #自定義欄位(數字)012
         apchud013    LIKE apch_t.apchud013, #自定義欄位(數字)013
         apchud014    LIKE apch_t.apchud014, #自定義欄位(數字)014
         apchud015    LIKE apch_t.apchud015, #自定義欄位(數字)015
         apchud016    LIKE apch_t.apchud016, #自定義欄位(數字)016
         apchud017    LIKE apch_t.apchud017, #自定義欄位(數字)017
         apchud018    LIKE apch_t.apchud018, #自定義欄位(數字)018
         apchud019    LIKE apch_t.apchud019, #自定義欄位(數字)019
         apchud020    LIKE apch_t.apchud020, #自定義欄位(數字)020
         apchud021    LIKE apch_t.apchud021, #自定義欄位(日期時間)021
         apchud022    LIKE apch_t.apchud022, #自定義欄位(日期時間)022
         apchud023    LIKE apch_t.apchud023, #自定義欄位(日期時間)023
         apchud024    LIKE apch_t.apchud024, #自定義欄位(日期時間)024
         apchud025    LIKE apch_t.apchud025, #自定義欄位(日期時間)025
         apchud026    LIKE apch_t.apchud026, #自定義欄位(日期時間)026
         apchud027    LIKE apch_t.apchud027, #自定義欄位(日期時間)027
         apchud028    LIKE apch_t.apchud028, #自定義欄位(日期時間)028
         apchud029    LIKE apch_t.apchud029, #自定義欄位(日期時間)029
         apchud030    LIKE apch_t.apchud030  #自定義欄位(日期時間)030
                      END RECORD
#170317-00029#3 --e add
#170710-00040#1---add---str--
DEFINE l_apcf3       RECORD                  #t300已沖帳
         apcf007     LIKE apcf_t.apcf007,    #170930-00022#1 add
         apcf103     LIKE apcf_t.apcf103,    #原幣未稅金額
         apcf104     LIKE apcf_t.apcf104,    #原幣稅額
         apcf105     LIKE apcf_t.apcf105,    #原幣含稅金額
         apcf113     LIKE apcf_t.apcf113,    #本幣未稅金額
         apcf114     LIKE apcf_t.apcf114,    #本幣稅額
         apcf115     LIKE apcf_t.apcf115,    #本幣含稅金額
         apcf123     LIKE apcf_t.apcf123,    #本幣二未稅金額
         apcf124     LIKE apcf_t.apcf124,    #本幣二稅額
         apcf125     LIKE apcf_t.apcf125,    #本幣二含稅金額
         apcf133     LIKE apcf_t.apcf133,    #本幣三未稅金額
         apcf134     LIKE apcf_t.apcf134,    #本幣三稅額
         apcf135     LIKE apcf_t.apcf135,    #本幣三含稅金額 #170930-00022#1 add,
         apcf009     LIKE apcf_t.apcf009     #170930-00022#1 add
                 END RECORD
DEFINE l_tax_apcf1031  LIKE apcb_t.apcb103
DEFINE l_tax_apcf1131  LIKE apcb_t.apcb113   #170727-00043#1 add
DEFINE l_apcf_diff     LIKE apcf_t.apcf103
DEFINE l_apcf_diff2    LIKE apcf_t.apcf105
#170710-00040#1---add---end--
DEFINE l_sfin3034      LIKE type_t.chr1      #170821-00012#1 add 暫估期初迴轉,沖暫估時認列差異否
#170915-00038#8 --s add
DEFINE l_sfin2002      LIKE type_t.chr1      
DEFINE l_apcb103_do    LIKE apcb_t.apcb103
DEFINE l_apcb105_do    LIKE apcb_t.apcb105
DEFINE l_seqcnt        LIKE type_t.num5
#170915-00038#8 --e add
#170930-00022#1 add(s)
DEFINE g_sum           LIKE type_t.num20_6  #t300整張單原幣總合
DEFINE g_sum1          LIKE type_t.num20_6  #t300整張單本幣總合
DEFINE l_sum1          LIKE type_t.num20_6  #t320整張單本幣總和
DEFINE l_diff          LIKE type_t.num20_6  #原幣相同時的t300-t320本幣差異
#170930-00022#1 add(e)
#171204-00022#1 --begin
DEFINE l_aapt320_apcb002 LIKE apcb_t.apcb002
DEFINE l_aapt320_apcb003 LIKE apcb_t.apcb003
#171204-00022#1 --end
DEFINE l_sum2          LIKE type_t.num20_6     #181008-00031#1---add
DEFINE l_cnt1          LIKE type_t.num5        #181008-00031#1---add
DEFINE l_apcb002t      LIKE apcb_t.apcb002     #181008-00031#1---add
DEFINE l_apcb003t      LIKE apcb_t.apcb003     #181008-00031#1---add

   #l_apca/l_apcb(現在立帳的立帳單--aapt300)
   #p_apca/p_apcb(抓出來沖的暫估單--aapt320)
   
   WHENEVER ERROR CONTINUE
   
   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa001|glaa004|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa025')
        RETURNING g_sub_success,l_glaacomp,l_glaa001,l_glaa004,
                  l_glaa015,l_glaa016,l_glaa017,l_glaa019,l_glaa020,
                  l_glaa021,l_glaa025
   
  #CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2011') RETURNING l_sfin2011   #150812-00010#3 mak
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3011') RETURNING l_sfin3011   #150812-00010#3   
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3034') RETURNING l_sfin3034   #170821-00012#1 add
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2002') RETURNING l_sfin2002   #170915-00038#8 add
  #IF l_sfin2011 = 'N' THEN LET l_sfin3012 = '1' END IF  #1.立帳不含稅   #150812-00010#3 mark
  #IF l_sfin3011 = 'N' THEN LET l_sfin3012 = '1' END IF  #160621-00026#1 mark  拿掉S-FIN-3003迴轉否影響是否含稅立帳判斷  #1.立帳不含稅   #150812-00010#3     
   
   SELECT apca007,apca035,apca036,apca101,apca100,
          apca121,apca131,apca012,apca011,apcacomp
     INTO l_apca007,l_apca035,l_apca036,l_apca101,l_apca100,
          l_apca121,l_apca131,l_apca012,l_apca011,l_apcacomp
     FROM apca_t
    WHERE apcaent = g_enterprise
      AND apcald = p_ld AND apcadocno= p_apcadocno 
   
   INITIALIZE r_apcf.* TO NULL
   CALL l_apcf_tmp.clear()
   #170930-00022#1 add(s)
   LET g_sum   = 0 
   LET g_sum1  = 0 
   LET l_sum1  = 0 
   LET l_diff  = 0 
   #t320本幣加總
   LET l_sum1 = p_apcc.apcc118 + p_apcc.apcc113
   #170930-00022#1 add(e)
   #170527-00015#1---mark---str--
   ##檢查t320是否被沖完暫估---(S)---
   #LET l_apcf105 = NULL    #有效的apcf單據金額
   #LET l_apcc108 = NULL    #可沖的apcc108的金額
   #SELECT SUM(apcf105) INTO l_apcf105
   #  FROM apca_t,apcf_t
   # WHERE apcaent = apcfent AND apcadocno = apcfdocno 
   #   AND apcastus NOT IN ('X','Y')
   #   AND apcaent = g_enterprise
   #   AND apcald  = p_ld AND apcf008 = p_apca.apcadocno
   #   AND apcf009 = p_apcc.apccseq AND apcf010 = p_apcc.apcc001
   #
   #SELECT SUM(apcc108-apcc109) INTO l_apcc108
   #  FROM apcc_t
   # WHERE apccent = g_enterprise
   #   AND apccld  = p_ld AND apccdocno = p_apca.apcadocno
   #   AND apccseq = p_apcc.apccseq AND apcc001 = p_apcc.apcc001
   #
   #IF cl_null(l_apcf105) THEN LET l_apcf105 = 0 END IF
   #IF cl_null(l_apcc108) THEN LET l_apcc108 = 0 END IF
   #IF l_apcc108 - l_apcf105 = 0 THEN   #表示這一張暫估單已經沖完了/要抓下一筆t320繼續沖
   #   LET r_flag = 1                   #CONTINUE FOREACH
   #
   #   #161102-00015#7 --s add
   #   IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
   #   IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
   #   IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
   #   IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
   #   IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
   #   IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
   #   IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
   #   IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
   #   IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
   #   IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
   #   IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
   #   IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
   #   IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
   #   IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
   #   IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
   #   IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
   #   IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
   #   IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
   #   IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
   #   IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
   #   IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
   #   IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
   #   IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十      
   #   #161102-00015#7 --e add
   #   RETURN r_flag,r_apcf.*,l_apcf_tmp
   #END IF
   ##檢查t320是否被沖完暫估---(E)---
   #170527-00015#1---mark---end--
   
   #180412-00061#1 add--s for 小数误差调整
   #为了判断是不是最后一次冲的处理，防止有重评价的情况导致的小数误差
   LET l_apcc108 = 0      #暂估单的原币总金额(以整张暂估单的概念算)
   LET l_apcf105_b = 0    #该暂估单除本张立账单的其他已冲原币总金额(以整张暂估单的概念算)
   LET l_apcf105_sum = 0  #本张t300中此暂估单已计算到的被冲的原币总金额(以整张暂估单的概念算)
   LET l_apcc118 = 0
   LET l_apcf115_b = 0  
   LET l_apcf115_sum = 0
   #获取此暂估单的原币总金额
   SELECT SUM(apcc108),SUM(apcc118+apcc113) INTO l_apcc108,l_apcc118
     FROM apcc_t
    WHERE apccent = g_enterprise
      AND apccld  = p_ld AND apccdocno = p_apca.apcadocno
   IF cl_null(l_apcc108) THEN LET l_apcc108 = 0 END IF
   IF cl_null(l_apcc118) THEN LET l_apcc118 = 0 END IF
   
   #获取该暂估单除本张立账单的其他已冲原币总金额
   SELECT SUM(apcf105),SUM(apcf115) INTO l_apcf105_b,l_apcf115_b
     FROM apca_t,apcf_t
    WHERE apcaent = apcfent AND apcadocno = apcfdocno 
      AND apcastus NOT IN ('X')
      AND apcaent = g_enterprise
      AND apcald  = p_ld AND apcf008 = p_apca.apcadocno
      AND apcfdocno != p_apcadocno
   IF cl_null(l_apcf105_b) THEN LET l_apcf105_b = 0 END IF
   IF cl_null(l_apcf115_b) THEN LET l_apcf115_b = 0 END IF
   #180412-00061#1 add--e for 小数误差调整
   
   #檢查t300是否沖完暫估---(S)---(若立帳單沖完以後 就表示不用沖暫估了)
   LET l_apcb103 = NULL
   LET l_apcb105 = NULL
   LET l_apcf103 = NULL
   LET l_apcf105 = NULL
   IF p_type = '1' THEN
      #非雜項看t320的 apcb立了幾個沖暫估
      LET l_cnt = 0
      #161114-00009#1 --s add
      #迴圈內SELECT外搬PREPARE
      LET l_sql = " SELECT SUM(apcb007) ",
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno  ",
                  "    AND apcastus NOT IN ('X','Y')  ",
                  "    AND apcaent = ",g_enterprise," ",
                  "    AND apcald  = ? AND apcbdocno <> ? ",
                  "    AND apcb002 = ? AND apcb003 = ? ",
                  "    AND apcb023 = 'Y'  "
      PREPARE s_aapp131_apcb0071p FROM l_sql   
      #161114-00009#1 --e add      
      
      #取t320的資料      
      LET l_sql = "SELECT apcb002,apcb003,apcb007 ",
                "    FROM apca_t,apcb_t",
                "   WHERE apcaent = apcbent AND apcadocno = apcbdocno ",
                "     AND apca001 IN ('01','02') ",
                "     AND apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                "     AND apcbdocno = '",p_apca.apcadocno,"' ",
                "     AND apcb001 IN ('11','20','21') ",
                "     AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL "
      PREPARE s_aapp131_get_apcf_p FROM l_sql
      DECLARE s_aapp131_get_apcf_c CURSOR FOR s_aapp131_get_apcf_p
      FOREACH s_aapp131_get_apcf_c INTO l_apcb002,l_apcb003,l_apcb007
         #計算已沖 暫估數量(不含本張單沖銷的數量)   
         #161114-00009#1 --s add
         LET l_apcb0071 = 0
         EXECUTE s_aapp131_apcb0071p USING p_ld,p_apcadocno,l_apcb002,l_apcb003 INTO l_apcb0071 
         #161114-00009#1 --e add
         
         #161114-00009#1 --s mark     
         #SELECT SUM(apcb007) INTO l_apcb0071
         #  FROM apca_t,apcb_t
         # WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno
         #   AND apcastus NOT IN ('X','Y') 
         #   AND apcaent = g_enterprise
         #   AND apcald  = p_ld AND apcbdocno <> p_apcadocno 
         #   AND apcb002 = l_apcb002 AND apcb003 = l_apcb003
         #   AND apcb023 = 'Y'
         #161114-00009#1 --e mark 
         IF cl_null(l_apcb007)  THEN LET l_apcb007 = 0 END IF
         IF cl_null(l_apcb0071) THEN LET l_apcb0071= 0 END IF
         IF l_apcb007 - l_apcb0071 <> 0 THEN
            LET l_cnt = 1
            EXIT FOREACH
         END IF
      END FOREACH
      IF l_cnt = 0 THEN          #表示這一張暫估單已經沖完了/要抓下一筆t320繼續沖
         LET r_flag = 1          #CONTINUE FOREACH
         #161102-00015#7 --s add
         IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
         IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
         IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
         IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
         IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
         IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
         IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
         IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
         IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
         IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
         IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
         IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
         IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
         IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
         IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
         IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
         IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
         IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
         IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
         IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
         IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
         IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
         IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十      
         #161102-00015#7 --e add         
         RETURN r_flag,r_apcf.*,l_apcf_tmp
      END IF
   ELSE
      #170915-00038#8 --s mark
      ##t300無可符合的條件的可沖暫估
      #LET l_apcb105 = 0
      #IF p_apca.apca001 = '03' THEN
      #   SELECT SUM(apcb103),SUM(apcb105) INTO l_apcb103,l_apcb105
      #      FROM apcb_t
      #     WHERE apcbent = g_enterprise
      #       AND apcbld = p_ld AND apcbdocno = p_apcadocno
      #       AND apcb001 IN ('19','16')  
      #       AND apcb023 = 'Y'
      #    SELECT SUM(apcf103),SUM(apcf105) INTO l_apcf103,l_apcf105
      #      FROM apca_t,apcf_t
      #     WHERE apcaent = apcfent AND apcald = apcfld
      #       AND apcadocno = apcf008
      #       AND apca001 = '03'
      #       AND apcfent = g_enterprise
      #       AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      #ELSE
      #   SELECT SUM(apcb103),SUM(apcb105) INTO l_apcb103,l_apcb105
      #      FROM apcb_t
      #     WHERE apcbent = g_enterprise
      #       AND apcbld = p_ld AND apcbdocno = p_apcadocno
      #       AND apcb001 IN ('29','26') 
      #       AND apcb023 = 'Y'
      #    SELECT SUM(apcf103),SUM(apcf105) INTO l_apcf103,l_apcf105
      #      FROM apca_t,apcf_t
      #     WHERE apcaent = apcfent AND apcald = apcfld
      #     AND apcadocno = apcf008
      #       AND apca001 ='04'
      #       AND apcfent = g_enterprise
      #       AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      #END IF
      #
      ##161102-00015#7 --s add
      #IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
      #IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
      #IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
      #IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
      #IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
      #IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
      #IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
      #IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
      #IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
      #IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
      #IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
      #IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
      #IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
      #IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
      #IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
      #IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
      #IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
      #IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
      #IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
      #IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
      #IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
      #IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
      #IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十      
      ##161102-00015#7 --e add   
      #
      #IF cl_null(l_apcb103) THEN LET l_apcb103 = 0 END IF
      #IF cl_null(l_apcb105) THEN LET l_apcb105 = 0 END IF
      #IF cl_null(l_apcf103) THEN LET l_apcf103 = 0 END IF
      #IF cl_null(l_apcf105) THEN LET l_apcf105 = 0 END IF
      #IF l_apcb105 = 0 THEN
      #   LET r_flag = 1                      #CONT FOREACH
      #   RETURN r_flag,r_apcf.*,l_apcf_tmp         
      #END IF
      #IF l_sfin3012 = '1' THEN      #立帳未稅
      #   IF l_apcb103 - l_apcf103 = 0 THEN
      #      LET r_flag = 1                   #CONT FOREACH
      #      RETURN r_flag,r_apcf.*,l_apcf_tmp
      #   END IF
      #ELSE
      #   IF l_apcb105 - l_apcf105 = 0 THEN
      #      LET r_flag = 1                   #CONT FOREACH
      #      RETURN r_flag,r_apcf.*,l_apcf_tmp
      #   END IF
      #END IF
      #170915-00038#8 --e mark
      
      #170915-00038#8 --s add
      #取t320的資料        
      LET l_sql = "SELECT SUM(apcb103),SUM(apcb105) ",
                "    FROM apca_t,apcb_t",
                "   WHERE apcaent = apcbent AND apcadocno = apcbdocno AND apcald = apcbld ",
                "     AND apca001 = '",p_apca.apca001,"' ",
                "     AND apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                "     AND apcbdocno = ? AND apcbseq = ? ",
                "     AND apcb001 IN ('19','29') "
      PREPARE s_aapp131_get_apcf105 FROM l_sql      
            
      #計算已沖金額(不含本張單沖銷的金額) aapt301/341中已沖金額
      LET l_sql = " SELECT SUM(apcb103),SUM(apcb105) ",
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno  ",
                  "    AND apcaent = ",g_enterprise," ",
                  "    AND apcald  = '",p_ld,"' AND apcbdocno <> '",p_apcadocno,"' ",
                  "    AND apcb002 = ? AND apcb003 = ? ",
                  "    AND apcastus <> 'X' AND apcb023 = 'Y'  "
      PREPARE s_aapp131_apcb105p FROM l_sql               

      #計算雜項是否有可暫估金額
      LET l_cnt = 0        
      LET l_sql = "SELECT apcb002,apcb003 ",
                "    FROM apca_t,apcb_t",
                "   WHERE apcaent = apcbent AND apcadocno = apcbdocno AND apcald = apcbld ",
                "     AND apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                "     AND apcbdocno = '",p_apcadocno,"' ",
                "     AND apcb002 = '",p_apca.apcadocno,"' ",
                "     AND apcb001 IN ('19','29') AND apcb023 = 'Y' ",
                "     AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL "
      PREPARE s_aapp131_get_apcf_p1 FROM l_sql
      DECLARE s_aapp131_get_apcf_c1 CURSOR FOR s_aapp131_get_apcf_p1
      FOREACH s_aapp131_get_apcf_c1 INTO l_apcb002,l_apcb003      
         
         #取t320的資料
         LET l_apcf103 = 0          
         LET l_apcf105 = 0       
         EXECUTE s_aapp131_get_apcf105 USING l_apcb002,l_apcb003 INTO l_apcf103,l_apcf105
         IF cl_null(l_apcf103) THEN LET l_apcf103 = 0 END IF         
         IF cl_null(l_apcf105) THEN LET l_apcf105 = 0 END IF       
      
         #計算已沖金額(不含本張單沖銷的金額) aapt301/341中已沖金額
         LET l_apcb103 = 0   
         LET l_apcb105 = 0           
         EXECUTE s_aapp131_apcb105p USING l_apcb002,l_apcb003 INTO l_apcb103,l_apcb105
         IF cl_null(l_apcb103) THEN LET l_apcb103 = 0 END IF         
         IF cl_null(l_apcb105) THEN LET l_apcb105 = 0 END IF
         
         IF l_sfin3012 = '1' THEN      #立帳未稅
            IF l_apcf103 - l_apcb103 > 0 THEN
               LET l_cnt = 1
               EXIT FOREACH
            END IF
         ELSE
            IF l_apcf105 - l_apcb105 > 0 THEN
               LET l_cnt = 1
               EXIT FOREACH
            END IF
         END IF         
      END FOREACH      
      
      IF l_cnt = 0 THEN          #表示這一張暫估單已經沖完了/要抓下一筆t320繼續沖
         LET r_flag = 1          #CONTINUE FOREACH
         IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
         IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
         IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
         IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
         IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
         IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
         IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
         IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
         IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
         IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
         IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
         IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
         IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
         IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
         IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
         IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
         IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
         IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
         IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
         IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
         IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
         IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
         IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十               
         RETURN r_flag,r_apcf.*,l_apcf_tmp
      END IF       
      #170915-00038#8 --e add      
      
   END IF
   #檢查t300是否沖完暫估---(E)---
   #沖帳情況：1整張單沖銷部分 2.全部沖完
   #170413-00069#1--mark--str--lujh
   #LET r_apcf.apcf029 = p_apca.apca004      #交易客商
   #LET r_apcf.apcf030 = p_apca.apca005      #帳款客商
   #170413-00069#1--mark--end--lujh
   
   #170413-00069#1--add--str--lujh
   LET r_apcf.apcf029 = p_apca.apca005       #交易客商
   LET r_apcf.apcf030 = p_apca.apca004       #帳款客商
   #170413-00069#1--add--end--lujh
   
   LET r_apcf.apcf101 = ''                   #NO USE
   LET r_apcf.apcf102 = p_apca.apca101       #本幣一匯率
   LET r_apcf.apcf111 = ''                   #NO USE
   LET r_apcf.apcf122 = p_apca.apca121       #本幣二匯率
   LET r_apcf.apcf132 = p_apca.apca131       #本幣三匯率
   
   #170317-00029#1 --s add 原取暫估單的立帳匯率,改取重評後匯率apcc102
   LET l_apcc102 = ''
   SELECT apcc101,apcc102 INTO l_apcc101,l_apcc102 FROM apcc_t  #180412-00061#1 add apcc101 for 未考虑重评价调整
    WHERE apccent = g_enterprise AND apccld  = p_ld AND apccdocno = p_apca.apcadocno
      AND apccseq = p_apcc.apccseq AND apcc001 = p_apcc.apcc001        
   LET r_apcf.apcf102 = l_apcc102   
   #170317-00029#1 --e add  
   
   {p_type1:入庫單/倉退單--S--}
   
   IF p_type = '1' THEN
      LET l_cnt = 0
      LET l_sum2 = 0 #181008-00031#1#记录同一个单号里这个入库单同一个项次 每次得数据
      #161114-00009#1 --s add
      #迴圈內SELECT外搬PREPARE
      LET l_sql = " SELECT SUM(apcb007), ",
                  "        SUM(apcb103),SUM(apcb104),SUM(apcb105),SUM(apcb113),SUM(apcb114),SUM(apcb115), ",
                  "        SUM(apcb123),SUM(apcb124),SUM(apcb125),SUM(apcb133),SUM(apcb134),SUM(apcb135) ",
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
                  #"    AND apcastus NOT IN ('X','Y')  ",   #170710-00040#1 mark
                  "    AND apcastus NOT IN ('X')  ",        #170710-00040#1 add
                  "    AND apcaent = ",g_enterprise," AND apcald  = ? AND apcbdocno <> ?  ",
                  "    AND apcb002 = ? AND apcb003 = ? AND apcb023 = 'Y' "
      PREPARE s_aapp131_get_apcf1p FROM l_sql     

      #170727-00043#1---mark---str--
      ##170710-00040#1---add---str--
      #LET l_sql = "SELECT SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115), ",
      #            "       SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135) ",
      #            "  FROM apcf_t,apca_t ",
      #            " WHERE apcaent = apcfent ",
      #            "   AND apcald = apcfld ",
      #            "   AND apcadocno = apcfdocno ",
      #            "   AND apcaent = ",g_enterprise,
      #            "   AND apcald = '",p_ld,"'",
      #            "   AND apcadocno <> '",p_apcadocno,"' ",
      #            "   AND apcf008 = '",p_apca.apcadocno,"'",
      #            "   AND apcf009 = '",p_apcc.apccseq,"'",
      #            "   AND apcf010 = '",p_apcc.apcc001,"'",
      #            "   AND apcastus NOT IN ('X') "
      #PREPARE s_aapp131_get_apcf2p FROM l_sql
      ##170710-00040#1---add---end--
      #170727-00043#1---mark---end--

      LET l_sql = " SELECT apcb007,apcb101,apcb103,apcb104,apcb105,apcb113, ",
                  "        apcb114,apcb115,apcb123,apcb124,apcb125,apcb133, ",
                  "        apcb134,apcb135,apcb020,apca100,apca101,apcb107  ",                    
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
                  "    AND apcbent = ",g_enterprise,"   ",
                  "    AND apcbld = ? AND apcbdocno = ? ",
                  "    AND apcb002= ? AND apcb003 = ?   "
      PREPARE s_aapp131_get_apcf320p FROM l_sql 
      #170930-00022#1 add(s)
      #抓再t300有沖過的單(以整張單的角度去抓數字)
      LET l_sql = "  SELECT SUM(apcf007), ",
                  "         SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),", 
                  "         SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135),",
                  "         apcf009 ",
                  "    FROM apcf_t",
                  "   WHERE apcfent = ",g_enterprise," AND apcfld  = ? AND apcfdocno <> ?  ",
                  "     AND apcf008 = ? ",
                 #"   GROUP BY apcf009",   #190104-00006#1 mark
                  #180226-00057#1 add(s)                  
                  "     AND apcfdocno NOT IN (SELECT apcadocno FROM apca_t WHERE apcaent= ",g_enterprise,
                  "     AND apcald= ? ",
                  "     AND apcastus<>'X')"
                  #180226-00057#1 add(e) 
                 ,"   GROUP BY apcf009"    #190104-00006#1 add
      PREPARE s_aapp131_get_apcf3p FROM l_sql
      #EXECUTE s_aapp131_get_apcf3p USING p_ld,p_apcadocno,p_apca.apcadocno INTO l_apcf3.*  #180226-00057#1 mark
      EXECUTE s_aapp131_get_apcf3p USING p_ld,p_apcadocno,p_apca.apcadocno,p_ld INTO l_apcf3.*   #180226-00057#1 add
      IF cl_null(l_apcf3.apcf103) THEN LET l_apcf3.apcf103 = 0 END IF
      IF cl_null(l_apcf3.apcf104) THEN LET l_apcf3.apcf104 = 0 END IF
      IF cl_null(l_apcf3.apcf105) THEN LET l_apcf3.apcf105 = 0 END IF
      IF cl_null(l_apcf3.apcf113) THEN LET l_apcf3.apcf113 = 0 END IF
      IF cl_null(l_apcf3.apcf114) THEN LET l_apcf3.apcf114 = 0 END IF
      IF cl_null(l_apcf3.apcf115) THEN LET l_apcf3.apcf115 = 0 END IF
      IF cl_null(l_apcf3.apcf123) THEN LET l_apcf3.apcf123 = 0 END IF
      IF cl_null(l_apcf3.apcf124) THEN LET l_apcf3.apcf124 = 0 END IF
      IF cl_null(l_apcf3.apcf125) THEN LET l_apcf3.apcf125 = 0 END IF
      IF cl_null(l_apcf3.apcf133) THEN LET l_apcf3.apcf133 = 0 END IF
      IF cl_null(l_apcf3.apcf134) THEN LET l_apcf3.apcf134 = 0 END IF
      IF cl_null(l_apcf3.apcf135) THEN LET l_apcf3.apcf135 = 0 END IF
      #170930-00022#1 add(e)
      #161114-00009#1 --e add
      LET l_sql = "SELECT apcb002,apcb003,apcb007,",
                  "       apcb101,",
                  "       apcb103,apcb104,apcb105,apcb113,apcb114,apcb115,",
                  "       apcb123,apcb124,apcb125,apcb133,apcb134,apcb135,",
                  "       apcborga,",
                  "       apcb010,apcb011,apcb024,apcb036,apcb004,",
                  "       apcb051,apcb015,apcb016,apcb033,apcb034,",
                  "       apcb035,apcb037,apcb038,apcb039,apcb040,",
                  "       apcb041,apcb042,apcb043,apcb044,apcb045,",
                  "       apcb046,apcb047,apcb021,apcb020,apcb012 ",          #181113-00009#1---add--->   ,apcb012    
                  "  FROM apcb_t",
                  " WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                  "   AND apcbdocno = '",p_apcadocno,"' ",
                  "   AND apcborga = '",p_apcborga,"' ",   #180314-00018 add 
                  "   AND apcb001 IN ('1','2','11','20','21') ",
                  "   AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL ",
                  "   AND apcb023 = 'Y' "
                  
      #170915-00038#8 --s add 因多賬期參數3時,暫估單展到項次,因此不能做匯總產生應以單筆項次去計算
      IF l_sfin2002 = '3' THEN
#         LET l_sql = l_sql, "  AND apcb003 = '",p_apcc.apccseq,"' "   #171204-00022#1 ---mark 
 
         #171204-00022#1 --begin   
         #如果参数冲到明细的话，aapt320暂估单的单身和多账期是一一对应的
         #所以要先根据传参进来的暂估单p_apcc.*找到对应那一笔的暂估单单身中的入库单+项次
         #然后下面才可以根据这个入库单+项次去aapt300账款单身找出哪些账款单身是关联冲这个暂估单多账期的
         #step1:抓出暂估apcc对应的暂估单单身入库单+项次
                  SELECT DISTINCT apcb002,apcb003 INTO l_aapt320_apcb002,l_aapt320_apcb003
                    FROM apcb_t
                   WHERE apcbent   = g_enterprise
                     AND apcbld    = p_ld
                     AND apcbdocno = p_apcc.apccdocno
                     AND apcbseq   = p_apcc.apccseq
                     
         #step2:关联到主sql中，找到对应的入库单+项次，应该只有一笔才对
                  LET l_sql = l_sql,"  AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' "
         #         LET l_sql = l_sql, "  AND apcb003 = '",p_apcc.apccseq,"' "  
         #171204-00022#1 --end  
         
      END IF    
      #170915-00038#8 --e add 
      #181008-00031#1---add---str
      LET l_sql = l_sql,"  ORDER BY apcb002,apcb003 "
      #181008-00031#1---add---end      
      PREPARE s_aapp131_get_t300apcb_p FROM l_sql
      DECLARE s_aapp131_get_t300apcb_c CURSOR FOR s_aapp131_get_t300apcb_p
      FOREACH s_aapp131_get_t300apcb_c INTO l_apcb002,l_apcb003,l_apcb007,l_apcb1.*  #t300中本次冲暂估的明细信息
         LET l_apcf007 = 0 
         LET l_apcf0071= 0
         #t300計算已沖暫估數量(不含本張單沖銷的)l_apcf0071
         #161114-00009#1 --s add
         INITIALIZE l_apcf1.* TO NULL
         LET l_apcf0071 = ''
         EXECUTE s_aapp131_get_apcf1p USING p_ld,p_apcadocno,l_apcb002,l_apcb003
            INTO l_apcf0071,l_apcf1.*             
         #161114-00009#1 --e add
         #161114-00009#1 --s mark
         #SELECT SUM(apcb007),
         #       SUM(apcb103),SUM(apcb104),SUM(apcb105),SUM(apcb113),SUM(apcb114),SUM(apcb115),
         #       SUM(apcb123),SUM(apcb124),SUM(apcb125),SUM(apcb133),SUM(apcb134),SUM(apcb135)
         #  INTO l_apcf0071,l_apcf1.*
         #  FROM apca_t,apcb_t
         # WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno
         #   AND apcastus NOT IN ('X','Y') 
         #   AND apcaent = g_enterprise
         #   AND apcald  = p_ld AND apcbdocno <> p_apcadocno 
         #   AND apcb002 = l_apcb002 AND apcb003 = l_apcb003
         #   AND apcb023 = 'Y'
         #161114-00009#1 --e mark
         
         #EXECUTE s_aapp131_get_apcf2p INTO l_apcf3.*   #170710-00040#1 add   #170727-00043#1 mark
            
         #160816-00022#4 add --s
         LET l_t320_apcb020 = ''
         LET l_t320_apca100 = ''
         LET l_t320_apca101 = ''
         LET l_pmdt036 = 0        #入庫單單價
         #160816-00022#4 add --e
            
         #t320立暫估數量l_apcf007
         #161114-00009#1 --s add
         LET l_apcf007 = ''
         LET l_apcb101 = ''
         INITIALIZE l_apcf2.* TO NULL
         EXECUTE s_aapp131_get_apcf320p USING p_ld,p_apca.apcadocno,l_apcb002,l_apcb003
            INTO l_apcf007,l_apcb101,l_apcf2.*,  #t320立暫估數量，交易原币单价，t320冲暂估单身的明细金额（满足与冲暂估单上相同来源业务单据号码的）
                 l_t320_apcb020,l_t320_apca100,l_t320_apca101,l_pmdt036
         #161114-00009#1 --e add 
   
         #161114-00009#1 --s mark
         #SELECT apcb007,apcb101,
         #       apcb103,apcb104,apcb105,apcb113,apcb114,apcb115,
         #       apcb123,apcb124,apcb125,apcb133,apcb134,apcb135,
         #       apcb020,apca100,apca101,apcb107                          #160816-00022#4 add
         #  INTO l_apcf007,l_apcb101,l_apcf2.*,
         #       l_t320_apcb020,l_t320_apca100,l_t320_apca101,l_pmdt036   #160816-00022#4 add
         #  FROM apca_t,apcb_t
         # WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno
         #   AND apcbent = g_enterprise
         #   AND apcbld = p_ld AND apcbdocno = p_apca.apcadocno
         #   AND apcb002= l_apcb002 AND apcb003 = l_apcb003
         #161114-00009#1 --e mark    
         
         #170710-00040#1---add---str--
         #入庫數量
         IF cl_null(l_pmdt036) THEN LET l_pmdt036 = 0 END IF
         IF p_apca.apca001 MATCHES '0[12]' AND l_pmdt036 = 0 THEN
            SELECT pmdt036 INTO l_pmdt036 FROM pmdt_t
             WHERE pmdtent = g_enterprise
               AND pmdtdocno = l_apcb002
               AND pmdtseq = l_apcb003

            IF cl_null(l_pmdt036) THEN LET l_pmdt036 = 0 END IF
         END IF
         #170710-00040#1---add---end--

         IF cl_null(l_apcb007) THEN LET l_apcb007 = 0 END IF
         IF cl_null(l_apcf007) THEN LET l_apcf007 = 0 END IF
         IF cl_null(l_apcf0071)THEN LET l_apcf0071= 0 END IF
         IF cl_null(l_apcf1.apcf103) THEN LET l_apcf1.apcf103 = 0 END IF      IF cl_null(l_apcf1.apcf113) THEN LET l_apcf1.apcf113 = 0 END IF
         IF cl_null(l_apcf1.apcf104) THEN LET l_apcf1.apcf104 = 0 END IF      IF cl_null(l_apcf1.apcf114) THEN LET l_apcf1.apcf114 = 0 END IF
         IF cl_null(l_apcf1.apcf105) THEN LET l_apcf1.apcf105 = 0 END IF      IF cl_null(l_apcf1.apcf115) THEN LET l_apcf1.apcf115 = 0 END IF
         IF cl_null(l_apcf2.apcf103) THEN LET l_apcf2.apcf103 = 0 END IF      IF cl_null(l_apcf2.apcf113) THEN LET l_apcf2.apcf113 = 0 END IF
         IF cl_null(l_apcf2.apcf104) THEN LET l_apcf2.apcf104 = 0 END IF      IF cl_null(l_apcf2.apcf114) THEN LET l_apcf2.apcf114 = 0 END IF
         IF cl_null(l_apcf2.apcf105) THEN LET l_apcf2.apcf105 = 0 END IF      IF cl_null(l_apcf2.apcf115) THEN LET l_apcf2.apcf115 = 0 END IF
         IF l_apcf007 = l_apcf0071 THEN CONTINUE FOREACH END IF              #立暂估数量与已冲暂估数量相等，即代表已冲完，没必要再冲暂估
         IF l_apcf007 = 0 THEN CONTINUE FOREACH END IF   #170725-00022#1 add #立暂估数量为0没必要冲暂估
         IF cl_null(r_apcf.apcforga)THEN LET r_apcf.apcforga= l_apcb1.apcborga END IF      #來源組織
         IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = l_apcb1.apcb010 END IF       #業務部門
         IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = l_apcb1.apcb011 END IF       #責任中心
         IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = l_apcb1.apcb024 END IF       #區域
         IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = l_apcb1.apcb036 END IF       #客群
#         IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = l_apcb1.apcb004 END IF       #產品類別   #181113-00009#1---mark
         IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = l_apcb1.apcb012 END IF       #產品類別   #181113-00009#1---add
         IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = l_apcb1.apcb051 END IF       #業務人員
         IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = l_apcb1.apcb015 END IF       #專案編號
         IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = l_apcb1.apcb016 END IF       #WBS
         IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = l_apcb1.apcb033 END IF       #經營方式
         IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = l_apcb1.apcb034 END IF       #渠道
         IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = l_apcb1.apcb035 END IF       #品牌
         IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = l_apcb1.apcb037 END IF       #自由核算項1
         IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = l_apcb1.apcb038 END IF       #自由核算項2
         IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = l_apcb1.apcb039 END IF       #自由核算項3
         IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = l_apcb1.apcb040 END IF       #自由核算項4
         IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = l_apcb1.apcb041 END IF       #自由核算項5
         IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = l_apcb1.apcb042 END IF       #自由核算項6
         IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = l_apcb1.apcb043 END IF       #自由核算項7
         IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = l_apcb1.apcb044 END IF       #自由核算項8
         IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = l_apcb1.apcb045 END IF       #自由核算項9
         IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = l_apcb1.apcb046 END IF       #自由核算項10
         IF cl_null(r_apcf.apcf049) THEN LET r_apcf.apcf049 = l_apcb1.apcb047 END IF       #摘要
         IF cl_null(r_apcf.apcf022) THEN LET r_apcf.apcf022 = l_apcb1.apcb021 END IF       #費用會計科目

         #160816-00022#4 add --s
         #沖暫估訊息金額為: aapt300數量 * aapt320單價, 依aapt320 含稅否, 若Y 則表示含稅金額, 用aapt320的稅別推出未稅及稅額
         LET l_oodb004 = ''
         LET l_oodb005 = ''
         LET l_oodb006 = ''
         LET l_oodb011 = ''
         CALL s_tax_chk(l_apcacomp,l_apcb1.apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011

         CASE
             WHEN l_sfin3012 ='1'    #1:非雜項/1:立帳不含稅
                  LET l_cnt = l_cnt +1 
                  #立帳不含稅(參數為 立帳不含稅 且 含稅稅別,則用入庫單單價與t300帳款單稅率 推出 未稅單價)         
                  IF l_sfin3012 = '1' THEN   
                     #若來源單單價含稅則需要換算為不含稅的單價
                     IF l_oodb005 = 'Y' THEN  
                        LET l_apcb101 = l_pmdt036 / (1 + l_oodb006/100)
                     END IF
                  END IF
                  
                  #(t320立暫估數-t300不含本張沖暫估數) > t300這次要沖的暫估數
                  IF (l_apcf007 - l_apcf0071) >  l_apcb007 THEN
                     LET l_apcf007 = l_apcb007  #計算匯差價差要以沖暫估數量
                     LET l_tax_apcf103 = 0
                     LET l_tax_apcf103 = l_apcb101 * l_apcb007 #計稅基礎 (t320交易原幣單價 * t300沖暫估數量)
                     
                     #181008-00031#1---add---str
                     #判断这个入库单同一个项次是否是分多笔录入
                     LET l_cnt1 = 0
                     
                     SELECT count(1) INTO l_cnt1 FROM apcb_t
                      WHERE apcbent = g_enterprise
                        AND apcbld = p_ld
                        AND apcbdocno = p_apcadocno
                        AND apcb002 = l_apcb002
                        AND apcb003 = l_apcb003
                     
                     IF l_cnt1 > 1 THEN #l_cnt 大于 1 说明同一个单号里这个入库单同一个项次 他分两笔立账了
                        IF (not cl_null(l_apcb002t) AND NOT cl_null(l_apcb003t) ) AND (l_apcb002t = l_apcb002 AND l_apcb003t = l_apcb003) THEN
                           #因为同一个项次得入库单分多个项次立账导致这边得金额会比暂估单得大
                           IF (p_apcc.apcc108 - l_sum2) < l_tax_apcf103 THEN
                              LET l_tax_apcf103 = p_apcc.apcc108 - l_sum2
                           END IF
                        ELSE
                           LET l_sum2 = 0  #假如A入库单循环后循环到B入库单，需要将l_sum2重新合计
                        END IF
                        LET l_sum2 = l_tax_apcf103 + l_sum2
                        LET l_apcb002t = l_apcb002              #记录本次循环单号，让下一次循环比较
                        LET l_apcb003t = l_apcb003              #记录本次循环单号项次，让下一次循环比较 
                     END IF 
                     #181008-00031#1---add---end
                     #                        #181008-00031#1---mark--str
#                        #180711-00016#1----add-----str
#                        #因为同一个项次得入库单分两个项次立账导致这边得金额会比暂估单得大
#                        IF (p_apcc.apcc108 - g_sum) < l_tax_apcf103 THEN
#                          
#                           LET l_tax_apcf103 = p_apcc.apcc108 - g_sum
#                        END IF
#                        #180711-00016#1----add-----end
#                         #181008-00031#1---mark--end
                     
                     CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_tax_apcf103,2) RETURNING g_sub_success,g_errno,l_tax_apcf103 
                     LET l_apcf_tmp[l_cnt].apcf103 = l_tax_apcf103
                     LET l_apcf_tmp[l_cnt].apcf104 = 0
                     LET l_apcf_tmp[l_cnt].apcf105 = l_tax_apcf103
                     LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  #180412-00061#1 add for 小数误差调整
                     #本幣要等於原幣*原立暫估匯率
                     #LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * p_apca.apca101 #170317-00029#1 mark
                     LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102       #170317-00029#1 add
                     LET l_apcf_tmp[l_cnt].apcf114 = 0
                     #LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf103 * p_apca.apca101 #170317-00029#1 mark
                     LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102       #170317-00029#1 add
                     LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  #180412-00061#1 add for 小数误差调整
                  ELSE
                     LET l_apcf007 = l_apcf007 - l_apcf0071   #暂估单上剩余待冲暂估数
                     #170710-00040#1---mark---str--
                     #LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_apcf1.apcf103   #(立暫估數-沖暫估數)
                     #LET l_apcf_tmp[l_cnt].apcf104 = 0
                     #LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf103 - l_apcf1.apcf103
                     ##LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf113 - l_apcf1.apcf113     #170317-00029#3 mark
                     #LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102  #170317-00029#3 add
                     #LET l_apcf_tmp[l_cnt].apcf114 = 0
                     ##LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf113 - l_apcf1.apcf113     #170317-00029#3 mark
                     #LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf105 * l_apcc102  #170317-00029#3 add
                     #170710-00040#1---mark---end--
                     #170710-00040#1---add---str--
                     #代表這個入庫單+項次是最後一次沖
                     IF l_apcf0071 > 0 THEN  #t300不含本張沖暫估數
                        #有分次沖,所以要沖剩餘可沖金額,且因為aapt300單身入庫單+項次的單價不一定與aapt320入庫單+項次的單價一樣,所以已沖暫估數要另外計算                        
                        LET l_tax_apcf1031 = l_apcb101 * l_apcf0071 #計稅基礎 (t320交易原幣單價 * t300已沖暫估數量)
                        CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_tax_apcf1031,2) RETURNING g_sub_success,g_errno,l_tax_apcf1031
                        LET l_tax_apcf1131 = l_tax_apcf1031 * l_apcc102   #170727-00043#1 add
                        LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_tax_apcf1031    #(立暫估數-已沖暫估數)
                        #再檢查有沒有超沖
                        #IF (l_apcf3.apcf103 + l_apcf_tmp[l_cnt].apcf103) != l_apcf2.apcf103 THEN               #170727-00043#1 mark                        
                        #   LET l_apcf_diff = l_apcf2.apcf103 - (l_apcf3.apcf103 + l_apcf_tmp[l_cnt].apcf103)   #170727-00043#1 mark
                        IF (l_tax_apcf1031 + l_apcf_tmp[l_cnt].apcf103) != l_apcf2.apcf103 THEN                 #170727-00043#1 add   
                           LET l_apcf_diff = l_apcf2.apcf103 - (l_tax_apcf1031 + l_apcf_tmp[l_cnt].apcf103)     #170727-00043#1 add
                           LET l_apcf_tmp[l_cnt].apcf103 = l_apcf_tmp[l_cnt].apcf103 + l_apcf_diff
                        END IF
                        LET l_apcf_tmp[l_cnt].apcf104 = 0
                        LET l_apcf_tmp[l_cnt].apcf105 = l_apcf_tmp[l_cnt].apcf103
                        LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  #180412-00061#1 add for 小数误差调整
                        
                        LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102 
                        #IF (l_apcf3.apcf113 + l_apcf_tmp[l_cnt].apcf113) != l_apcf2.apcf113 THEN                #170727-00043#1 mark                        
                        #   LET l_apcf_diff2 = l_apcf2.apcf113 - (l_apcf3.apcf113 + l_apcf_tmp[l_cnt].apcf113)   #170727-00043#1 mark
                        IF (l_tax_apcf1131 + l_apcf_tmp[l_cnt].apcf113) != l_apcf2.apcf113 THEN                  #170727-00043#1 add   
                           LET l_apcf_diff2 = l_apcf2.apcf113 - ( l_tax_apcf1131 + l_apcf_tmp[l_cnt].apcf113)    #170727-00043#1 add
                           LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf113 + l_apcf_diff2
                        END IF
                        LET l_apcf_tmp[l_cnt].apcf114 = 0
                        LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf113
                        LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  #180412-00061#1 add for 小数误差调整
                        
                     ELSE
                        #表示第一次沖,也是最後一次沖
                        LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103   
                        LET l_apcf_tmp[l_cnt].apcf104 = 0
                        LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf103
                       #LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  #180412-00061#1 add for 小数误差调整   #190104-00006#1 mark
                        
                        #180412-00061#1 add--s  for 小数误差调整
                        #     最后一次冲的话，考虑下重评价的情况，可能有小数误差（apcc与apcb不一一对应的情况下）
                        #     因此这边再拿原币总金额判断下，若平了，本币金额也直接平
                        #为节省效能，在前面先获取以下资料
                        #           暂估单的原币总金额l_apcc108
                        #           暂估单除本张立账单的其他已冲原币总金额l_apcf105_b
                        #其他立账单冲暂估的原币总金额+本立账单冲暂估的原币总金额 = 立暂估的原币总金额 ，即冲完
                        IF l_apcf105_b + l_apcf105_sum = l_apcc108 THEN
                           LET l_apcf_tmp[l_cnt].apcf113 = l_apcc118 - l_apcf115_b - l_apcf115_sum
                           LET l_apcf_tmp[l_cnt].apcf114 = 0
                           LET l_apcf_tmp[l_cnt].apcf115 = l_apcc118 - l_apcf115_b - l_apcf115_sum
                        ELSE
                        #180412-00061#1 add--e  for 小数误差调整
                           IF l_apcc101 = l_apcc102 THEN  #180412-00061#1 add for 未考虑重评价调整
                              LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf113
                              LET l_apcf_tmp[l_cnt].apcf114 = 0
                              LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf113
                           #180412-00061#1 add--s for 未考虑重评价调整
                           ELSE
                              LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf103*l_apcc102
                              LET l_apcf_tmp[l_cnt].apcf114 = 0
                              LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf103*l_apcc102
                           END IF
                           #180412-00061#1 add--e for 未考虑重评价调整
                          #LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  ##180412-00061#1 add for 小数误差调整   #190104-00006#1 mark
                        END IF #180412-00061#1 add  for 小数误差调整
                        
                        LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  #180412-00061#1 add for 小数误差调整    #190104-00006#1 add
                        LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  ##180412-00061#1 add for 小数误差调整   #190104-00006#1 add
                        
                     END IF
                     #170710-00040#1---add---end--
                  END IF
                  
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115 
                  #170930-00022#1 add(s)
                  #t300原幣加總
                  LET g_sum = l_apcf_tmp[l_cnt].apcf103 + g_sum
                  #t300本幣加總
                  LET g_sum1 = l_apcf_tmp[l_cnt].apcf113 + g_sum1
                  #如果t300與t320本幣相同，且原幣有差異，就將差異的本幣金額攤到最後一筆上
                  IF g_sum = p_apcc.apcc108 OR (g_sum + l_apcf3.apcf103 = p_apcc.apcc108)THEN
                     LET l_diff = (g_sum1 + l_apcf3.apcf113) - l_sum1
                     LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf113 - l_diff
                     LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf113
                  END IF
                  #170930-00022#1 add(e)
             WHEN l_sfin3012 ='2'    #1:非雜項/2:立帳含稅
                  LET l_cnt = l_cnt +1 
                  
                  LET l_tax_apcf103 = 0
                  LET l_tax_apcf103  = l_apcb101 * l_apcb007 #計稅基礎 (t320交易原幣單價 * t300沖暫估數量)
                  CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_tax_apcf103,2) RETURNING g_sub_success,g_errno,l_tax_apcf103 
         
                  #(t320立暫估數-t300不含本張沖暫估數) > t300這次要沖的暫估數
                  IF (l_apcf007 - l_apcf0071) >  l_apcb007 THEN
                     LET l_apcf007 = l_apcb007  #計算匯差價差要以沖暫估數量
                     #l_glaacomp營運據點/p_oodb002稅別/p_money計稅基礎/p_num數量/p_curr幣別/p_rate匯率
                     #CALL s_tax_count(l_glaacomp,l_t320_apcb020,l_tax_apcf103,l_apcf007,l_t320_apca100,l_t320_apca101) #170317-00029#1 mark
                     CALL s_tax_count(l_glaacomp,l_t320_apcb020,l_tax_apcf103,l_apcf007,l_t320_apca100,l_apcc102)       #170317-00029#1 add
                          RETURNING l_apcf_tmp[l_cnt].apcf103,l_apcf_tmp[l_cnt].apcf104,l_apcf_tmp[l_cnt].apcf105,
                                    l_apcf_tmp[l_cnt].apcf113,l_apcf_tmp[l_cnt].apcf114,l_apcf_tmp[l_cnt].apcf115
                  ELSE
                     LET l_apcf007 = l_apcf007 - l_apcf0071
                     LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_apcf1.apcf103   #(立暫估數-沖暫估數)
                     LET l_apcf_tmp[l_cnt].apcf104 = l_apcf2.apcf104 - l_apcf1.apcf104
                     LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf105 - l_apcf1.apcf105
                     #170317-00029#3 --s mark
                     #LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf113 - l_apcf1.apcf113
                     #LET l_apcf_tmp[l_cnt].apcf114 = l_apcf2.apcf114 - l_apcf1.apcf114
                     #LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf115 - l_apcf1.apcf115
                     #170317-00029#3 --e mark
                     #170317-00029#3 --s add
                     LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102
                     LET l_apcf_tmp[l_cnt].apcf114 = l_apcf_tmp[l_cnt].apcf104 * l_apcc102
                     LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf105 * l_apcc102
                     CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
                     CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf114,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf114
                     CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115                      
                     #170317-00029#3 --e add                   
                  END IF
                  #170930-00022#1 add(s)
                  #t300原幣加總
                  LET g_sum = l_apcf_tmp[l_cnt].apcf105 + g_sum
                  #t300本幣加總
                  LET g_sum1 = l_apcf_tmp[l_cnt].apcf115 + g_sum1
                  #如果t300與t320本幣相同，且原幣有差異，就將差異的本幣金額攤到最後一筆上
                  IF g_sum = p_apcc.apcc108 OR (g_sum + l_apcf3.apcf105 = p_apcc.apcc108) THEN
                     LET l_diff = (g_sum1 + l_apcf3.apcf115) - l_sum1
                     LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf115 - l_diff
                  END IF
                  #170930-00022#1 add(e)
                  #180718-00030#1 --s mark 避免推算後產生的尾差,比照s_tax_ins推算基準計算未稅
                  #LET l_apcf_tmp[l_cnt].apcf104 = l_apcf_tmp[l_cnt].apcf105 - l_apcf_tmp[l_cnt].apcf103
                  #LET l_apcf_tmp[l_cnt].apcf114 = l_apcf_tmp[l_cnt].apcf115 - l_apcf_tmp[l_cnt].apcf113
                  #LET l_apcf_tmp[l_cnt].apcf124 = l_apcf_tmp[l_cnt].apcf125 - l_apcf_tmp[l_cnt].apcf123
                  #LET l_apcf_tmp[l_cnt].apcf134 = l_apcf_tmp[l_cnt].apcf135 - l_apcf_tmp[l_cnt].apcf133
                  #180718-00030#1 --e mark
                  #180718-00030#1 --s add
                  LET l_apcf_tmp[l_cnt].apcf103 = l_apcf_tmp[l_cnt].apcf105 - l_apcf_tmp[l_cnt].apcf104
                  LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf115 - l_apcf_tmp[l_cnt].apcf114
                  LET l_apcf_tmp[l_cnt].apcf123 = l_apcf_tmp[l_cnt].apcf125 - l_apcf_tmp[l_cnt].apcf124
                  LET l_apcf_tmp[l_cnt].apcf133 = l_apcf_tmp[l_cnt].apcf135 - l_apcf_tmp[l_cnt].apcf134                    
                  #180718-00030#1 --e add
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115     
         END CASE
         #160816-00022#4 add --e
         
         #160816-00022#4 mark --s
         #CASE
         #    WHEN l_sfin3012 ='1'    #1:非雜項/1:立帳不含稅
         #         LET l_cnt = l_cnt +1 
         #         #(t320立暫估數-t300不含本張沖暫估數) > t300這次要沖的暫估數
         #         IF (l_apcf007 - l_apcf0071) >  l_apcb007 THEN
         #            LET l_apcf007 = l_apcb007  #計算匯差價差要以沖暫估數量
         #            LET l_apcf_tmp[l_cnt].apcf103 = l_apcb1.apcb103
         #            LET l_apcf_tmp[l_cnt].apcf104 = 0
         #            LET l_apcf_tmp[l_cnt].apcf105 = l_apcb1.apcb103
         #            #本幣要等於原幣*原立暫估匯率
         #            LET l_apcf_tmp[l_cnt].apcf113 = l_apcb1.apcb103 * p_apca.apca101
         #            LET l_apcf_tmp[l_cnt].apcf114 = 0
         #            LET l_apcf_tmp[l_cnt].apcf115 = l_apcb1.apcb103 * p_apca.apca101
         #         ELSE
         #            LET l_apcf007 = l_apcf007 - l_apcf0071
         #            LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_apcf1.apcf103   #(立暫估數-沖暫估數)
         #            LET l_apcf_tmp[l_cnt].apcf104 = 0
         #            LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf103 - l_apcf1.apcf103
         #            LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf113 - l_apcf1.apcf113
         #            LET l_apcf_tmp[l_cnt].apcf114 = 0
         #            LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf113 - l_apcf1.apcf113
         #         END IF
         #         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
         #         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115
         #    WHEN l_sfin3012 ='2'    #1:非雜項/2:立帳含稅
         #         LET l_cnt = l_cnt +1 
         #         IF (l_apcf007 - l_apcf0071) >  l_apcb007 THEN
         #            LET l_apcf007 = l_apcb007  #計算匯差價差要以沖暫估數量
         #            #l_glaacomp營運據點/p_oodb002稅別/p_money計稅基礎/p_num數量/p_curr幣別/p_rate匯率
         #            CALL s_tax_count(l_glaacomp,p_apca.apca011,l_apcb1.apcb105,l_apcf007,p_apca.apca100,p_apca.apca101)
         #                 RETURNING l_apcf_tmp[l_cnt].apcf103,l_apcf_tmp[l_cnt].apcf104,l_apcf_tmp[l_cnt].apcf105,
         #                           l_apcf_tmp[l_cnt].apcf113,l_apcf_tmp[l_cnt].apcf114,l_apcf_tmp[l_cnt].apcf115
         #         ELSE
         #            LET l_apcf007 = l_apcf007 - l_apcf0071
         #            LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_apcf1.apcf103   #(立暫估數-沖暫估數)
         #            LET l_apcf_tmp[l_cnt].apcf104 = l_apcf2.apcf104 - l_apcf1.apcf104
         #            LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf105 - l_apcf1.apcf105
         #            LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf113 - l_apcf1.apcf113
         #            LET l_apcf_tmp[l_cnt].apcf114 = l_apcf2.apcf114 - l_apcf1.apcf114
         #            LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf115 - l_apcf1.apcf115
         #         END IF
         #         #160621-00026#1--s
         #         LET l_apcf_tmp[l_cnt].apcf104 = l_apcf_tmp[l_cnt].apcf105 - l_apcf_tmp[l_cnt].apcf103
         #         LET l_apcf_tmp[l_cnt].apcf114 = l_apcf_tmp[l_cnt].apcf115 - l_apcf_tmp[l_cnt].apcf113
         #         LET l_apcf_tmp[l_cnt].apcf124 = l_apcf_tmp[l_cnt].apcf125 - l_apcf_tmp[l_cnt].apcf123
         #         LET l_apcf_tmp[l_cnt].apcf134 = l_apcf_tmp[l_cnt].apcf135 - l_apcf_tmp[l_cnt].apcf133
         #         #160621-00026#1--e                   
         #END CASE      
         #160816-00022#4 mark --e         
         LET r_apcf.apcf007 = l_apcf007     #180227-00030#1 add 沖暫估數
         
         LET l_apcf_tmp[l_cnt].apca001 = p_apca.apca001
         LET l_apcf_tmp[l_cnt].apcborga= l_apcb1.apcborga    #150417-00007#87
         #計算價差匯差
         IF l_apca100 = p_apca.apca100 THEN     #相同幣別沖暫估者，則以原暫估單匯率 
            #LET l_rate = p_apca.apca101 #170317-00029#1 mark
            LET l_rate = l_apcc102       #170317-00029#1 add
         ELSE
            #151012-00014#2-----s
            #151015 kris:不同幣別沖暫估,直接取現在立帳的單頭匯率來換算本幣,不重取匯率
            LET l_rate = l_apca101      
            #--(MARK)-s
            #CALL s_aooi160_get_exrate('2',p_ld,p_apca.apcadocdt,l_apca100,l_glaa001,0,l_glaa025)
            #     RETURNING l_rate
            #--(MARK)-e
            #151012-00014#2-----e
         END IF
         #计算公式可以是：立账的rmb单价＊立暂估时点的rmb的汇率－立暂估的ntd的单价＊立暂估时的ntd的汇率
         #151123--(S)
         
         #160816-00022#4 add --s
         LET l_oodb004 = ''
         LET l_oodb005 = ''
         LET l_oodb006 = ''
         LET l_oodb011 = ''
         #160816-00022#4 add --e
         CALL s_tax_chk(l_apcacomp,l_apcb1.apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011  #160524-00004#1
         
         #160816-00022#4 mark --s
         #IF l_sfin3012 = '1' THEN   #立帳不含稅
         #   #若來源單單價含稅則需要換算為不含稅的單價
         #   IF l_oodb005 = 'Y' THEN  
         #      LET l_apcb1.apcb101 = l_apcb1.apcb101 / (1 + l_oodb006/100)       #160524-00004#1 修改为l_oodb006
         #      CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcb1.apcb101,1) RETURNING g_sub_success,g_errno,l_apcb1.apcb101 #140806-00012#12
         #   END IF
         #END IF      
         #160816-00022#4 mark --e
         #151123--(E)
         
         #LET l_apcf_tmp[l_cnt].apcf116 = (l_apcb1.apcb101 * l_rate - l_apcb101 * p_apca.apca101) * l_apcf007 #160816-00022#4 mark 原用暫估單單價,改用入庫單單價做計算
         #LET l_apcf_tmp[l_cnt].apcf116 = (l_apcb1.apcb101 * l_rate - l_pmdt036 * p_apca.apca101) * l_apcf007  #160816-00022#4 add #170317-00029#1 mark
         
         #170317-00029#3 --s mark 改用先計算原幣價差後 推算本幣
         #LET l_apcf_tmp[l_cnt].apcf116 = (l_apcb1.apcb101 * l_rate - l_pmdt036 * l_apcc102) * l_apcf007                            #170317-00029#1 add
         #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf116,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf116    
         #
         ##160816-00022#4 add --s
         ##如入庫單單價與立帳單單價不同,計算diff時應扣除稅額
         #CALL s_curr_round_ld('1',p_ld,l_apca100,l_pmdt036,1) RETURNING g_sub_success,g_errno,l_pmdt036
         #IF l_pmdt036 <> l_apcb1.apcb101 THEN
         #   #CALL s_tax_count(l_glaacomp,l_apcb1.apcb020,l_apcf_tmp[l_cnt].apcf116,l_apcf007,l_glaa001,p_apca.apca101) #170317-00029#1 mark
         #   CALL s_tax_count(l_glaacomp,l_apcb1.apcb020,l_apcf_tmp[l_cnt].apcf116,l_apcf007,l_glaa001,l_apcc102)       #170317-00029#1 add
         #        RETURNING l_no_use,l_no_use,l_no_use,l_apcf_tmp[l_cnt].apcf116,l_no_use,l_no_use 
         #                 #原幣未稅金額,原幣稅額,原幣含稅金額,本幣未稅金額,本幣稅額,本幣含稅金額
         #END IF
         ##160816-00022#4 add --e
         #
         ##LET l_apcf_tmp[l_cnt].apcf106 = l_apcf_tmp[l_cnt].apcf116 / p_apca.apca101 #170317-00029#1 mark
         #LET l_apcf_tmp[l_cnt].apcf106 = l_apcf_tmp[l_cnt].apcf116 / l_apca100       #170317-00029#1 add 原幣改用t300匯率回推
         #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf106,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf106
         #170317-00029#3 --e mark
         
         #170317-00029#3 --s add
         #計算入庫未稅單價
         LET l_oodb004 = ''
         LET l_oodb005 = ''
         LET l_oodb006 = ''
         LET l_oodb011 = ''
         CALL s_tax_chk(l_apcacomp,l_t320_apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011         
         IF l_oodb005 = 'Y' THEN
            LET l_pmdt036 = l_pmdt036 / (1 + l_oodb006/100)    
            CALL s_curr_round_ld('1',p_ld,l_t320_apcb020,l_pmdt036,1) RETURNING g_sub_success,g_errno,l_pmdt036
         END IF
         
         #計算沖帳未稅單價
         LET l_oodb004 = ''
         LET l_oodb005 = ''
         LET l_oodb006 = ''
         LET l_oodb011 = ''
         CALL s_tax_chk(l_apcacomp,l_apcb1.apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011         
         IF l_oodb005 = 'Y' THEN
            LET l_apcb1.apcb101  = l_apcb1.apcb101  / (1 + l_oodb006/100)    
            CALL s_curr_round_ld('1',p_ld,l_apcb1.apcb020,l_apcb1.apcb101 ,1) RETURNING g_sub_success,g_errno,l_apcb1.apcb101 
         END IF    

         #原幣價差-> (t300未稅單價-t320未稅單價)*t300匯率*沖銷數量
         LET l_apcf_tmp[l_cnt].apcf106 = (l_apcb1.apcb101-l_pmdt036) * l_apca101 * l_apcf007
         CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf_tmp[l_cnt].apcf106,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf106 
         
         #本幣價差
         LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf106 * l_apca101
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf116,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf116          
         #170317-00029#3 --e add
         
         #160816-00022#4 add --s
         #先計算差異金額,比對交易幣別=本幣幣別 OR 匯率相等,表示沒有匯差,則差異應列入價差
         #差異金額: 該項次原幣未稅金額-立暫估時原幣未稅金額-原幣價差
         LET l_diff_apcf106 = 0
         LET l_diff_apcf106 = l_apcb1.apcb103 - l_apcf_tmp[l_cnt].apcf103 - l_apcf_tmp[l_cnt].apcf106 
         IF l_diff_apcf106 <> 0 THEN
            #IF l_apca100 = p_apca.apca100 OR l_apca101 = p_apca.apca101 THEN #170317-00029#1 mark
            IF l_apca100 = p_apca.apca100 OR l_apca101 = l_apcc102 THEN       #170317-00029#1 add
               LET l_apcf_tmp[l_cnt].apcf106 = l_apcf_tmp[l_cnt].apcf106 + l_diff_apcf106
               #LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf106 * p_apca.apca101 #170317-00029#1 mark
               #LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf106 * l_apcc102       #170317-00029#1 add
               LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf106 * l_apca101       #170317-00029#1 add 用t300匯率計算
               
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf116,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf116   
            END IF  
         END IF
         #160816-00022#4 add --e
         DISPLAY "價差處理"
         #雜項沖暫估整筆處理
         #匯差金额的计算公式：立账的rmb单价＊立账时点的rmb的汇率－立账的rmb的单价＊立暂估时点的rmb的汇率 並扣除價差
         #160816-00022#4 mark --s
         #IF l_sfin3012 ='1' THEN 
         #   LET l_apcf_tmp[l_cnt].apcf107 = ((l_apcb1.apcb103/l_apcb007)*l_apcf007) - l_apcf_tmp[l_cnt].apcf103 -l_apcf_tmp[l_cnt].apcf106
         #   LET l_apcf_tmp[l_cnt].apcf117 = ((l_apcb1.apcb113/l_apcb007)*l_apcf007) - l_apcf_tmp[l_cnt].apcf113 -l_apcf_tmp[l_cnt].apcf116
         #160816-00022#4 mark --e  
         
         #160816-00022#4 add --s
         #匯差計算方式:該項次本幣未稅金額-立暫估時本幣未稅金額-本幣價差
         LET l_apcf_tmp[l_cnt].apcf107 = 0 #匯差不處理原幣部分,先給0
         LET l_apcf_tmp[l_cnt].apcf117 = l_apcb1.apcb113 - l_apcf_tmp[l_cnt].apcf113 -l_apcf_tmp[l_cnt].apcf116

         #160816-00022#4 add --e
         
         #160816-00022#4 mark --s
         #改用未稅金額計算，取消使用參數判斷
         #ELSE
         #   LET l_apcf_tmp[l_cnt].apcf107 = ((l_apcb1.apcb105/l_apcb007)*l_apcf007) - l_apcf_tmp[l_cnt].apcf105 -l_apcf_tmp[l_cnt].apcf106
         #   LET l_apcf_tmp[l_cnt].apcf117 = ((l_apcb1.apcb115/l_apcb007)*l_apcf007) - l_apcf_tmp[l_cnt].apcf115 -l_apcf_tmp[l_cnt].apcf116
         #END IF
         #160816-00022#4 mark --e
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf107,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf107
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf117,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf117    
         
         #170317-00029#3 --s add 
         #寫入apch_t 沖暫估明細檔------------------------------------------s
         IF l_apcf_tmp[l_cnt].apcf106 <> 0 OR l_apcf_tmp[l_cnt].apcf116 <> 0 OR l_apcf_tmp[l_cnt].apcf117 <> 0 THEN
            INITIALIZE l_apch.* TO NULL      
            LET l_apch.apchent  = g_enterprise    #企業編號
            LET l_apch.apchcomp = l_apcacomp      #法人
            
            #帳務組織
            SELECT DISTINCT apcasite INTO l_apch.apchsite FROM apca_t  
             WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apcadocno
                         
            LET l_apch.apchdocno = p_apcadocno    #單據號碼
            
            #項次
            #170405-00030#1 --s mark
            #SELECT DISTINCT apcbseq INTO l_apch.apchseq FROM apcb_t  
            # WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = p_apcadocno 
            #   AND apcb002 = l_apcb002 AND apcb003 = l_apcb003
            #170405-00030#1 --e mark
            #170405-00030#1 --s add
            #項次
            SELECT DISTINCT apcbseq INTO l_apch.apchseq FROM apcb_t  
             WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = p_apcadocno
               AND apcb002 = l_apcb002 AND apcb003 = l_apcb003             
            #170405-00030#1 --e add
            
            LET l_apch.apch001 = p_apca.apcadocno #暫估單號
            
            #暫估項次
            SELECT apcbseq INTO l_apch.apch002 FROM apcb_t  
             WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno 
               AND apcb002 = l_apcb002 AND apcb003 = l_apcb003
             
            LET l_apch.apch003 = l_apcb002        #入庫單號
            LET l_apch.apch004 = l_apcb003        #入庫單項次
            LET l_apch.apch005 = l_apcb1.apcb004  #產品編號
            LET l_apch.apch006 = l_apcb007        #沖暫估數量
            
            #取來源暫估單稅別含稅否
            LET l_oodb004 = '' LET l_oodb005 = '' LET l_oodb006 = '' LET l_oodb011 = ''
            CALL s_tax_chk(l_apch.apchcomp,l_t320_apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
            #若來源單單價含稅則需要換算為不含稅的單價
            IF l_oodb005 = 'Y' THEN  
               #apch007 =原幣未稅金額/原幣數量 ; apch008 =本幣未稅金額/本幣數量 
               SELECT (apcb103/apcb007),(apcb113/apcb007) INTO l_apch.apch007,l_apch.apch008 FROM apcb_t  
                WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno AND apcb002 = l_apcb002 AND apcb003 = l_apcb003         
               CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_apch.apch007,1) RETURNING g_sub_success,g_errno,l_apch.apch007
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch.apch008,1) RETURNING g_sub_success,g_errno,l_apch.apch008
            ELSE                 
               #apch007 =原幣未稅單價 ; apch008 =本幣未稅單價 
               SELECT apcb101,apcb111 INTO l_apch.apch007,l_apch.apch008 FROM apcb_t  
                WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno AND apcb002 = l_apcb002 AND apcb003 = l_apcb003         
            END IF         
            LET l_apch.apch009 = l_apcf_tmp[l_cnt].apcf106  #DIFF 原幣價差金額
            LET l_apch.apch010 = l_apcf_tmp[l_cnt].apcf116  #DIFF 本幣價差金額
            LET l_apch.apch011 = l_apcf_tmp[l_cnt].apcf117  #DIFF 本幣匯差金額
            LET l_apch.apch012 = l_apch.apch009 / l_apcf007 #DIFF 原幣價差單價
            CALL s_curr_round_ld('1',p_ld,l_apca100,l_apch.apch012,1) RETURNING g_sub_success,g_errno,l_apch.apch012
            LET l_apch.apch013 = l_apch.apch010 / l_apcf007 #DIFF 本幣價差單價
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch.apch013,1) RETURNING g_sub_success,g_errno,l_apch.apch013
            LET l_apch.apch014 = l_apch.apch011 / l_apcf007 #DIFF 本幣匯差單價        
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch.apch014,1) RETURNING g_sub_success,g_errno,l_apch.apch014
            #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
            IF cl_null(l_apch.apch007) THEN LET l_apch.apch007 = 0 END IF   #原幣未稅單價
            IF cl_null(l_apch.apch008) THEN LET l_apch.apch008 = 0 END IF   #本幣未稅單價
            IF cl_null(l_apch.apch009) THEN LET l_apch.apch009 = 0 END IF   #DIFF 原幣價差金額
            IF cl_null(l_apch.apch010) THEN LET l_apch.apch010 = 0 END IF   #DIFF 本幣價差金額
            IF cl_null(l_apch.apch011) THEN LET l_apch.apch011 = 0 END IF   #DIFF 本幣匯差金額
            IF cl_null(l_apch.apch012) THEN LET l_apch.apch012 = 0 END IF   #DIFF 原幣價差單價
            IF cl_null(l_apch.apch013) THEN LET l_apch.apch013 = 0 END IF   #DIFF 本幣價差單價
            IF cl_null(l_apch.apch014) THEN LET l_apch.apch014 = 0 END IF   #DIFF 本幣匯差單價
            #180130-00050#5---add by 10554---(E) 

            INSERT INTO apch_t(apchent,apchcomp,apchsite,apchdocno,apchseq,
                               apch001,apch002,apch003,apch004,apch005,
                               apch006,apch007,apch008,apch009,apch010,
                               apch011,apch012,apch013,apch014)
                        VALUES(l_apch.apchent,l_apch.apchcomp,l_apch.apchsite,l_apch.apchdocno,l_apch.apchseq,
                               l_apch.apch001,l_apch.apch002,l_apch.apch003,l_apch.apch004,l_apch.apch005,
                               l_apch.apch006,l_apch.apch007,l_apch.apch008,l_apch.apch009,l_apch.apch010,
                               l_apch.apch011,l_apch.apch012,l_apch.apch013,l_apch.apch014)         
         END IF 
         #寫入apch_t 沖暫估明細檔------------------------------------------e
         #170317-00029#3 --e add
                 
      END FOREACH
      LET r_apcf.apcf103 = 0     LET r_apcf.apcf113 = 0      
      LET r_apcf.apcf104 = 0     LET r_apcf.apcf114 = 0
      LET r_apcf.apcf105 = 0     LET r_apcf.apcf115 = 0
      FOR l_i = 1 TO l_apcf_tmp.getLength()
         LET r_apcf.apcf103 = r_apcf.apcf103 + l_apcf_tmp[l_i].apcf103
         LET r_apcf.apcf104 = r_apcf.apcf104 + l_apcf_tmp[l_i].apcf104
         LET r_apcf.apcf105 = r_apcf.apcf105 + l_apcf_tmp[l_i].apcf105
         LET r_apcf.apcf113 = r_apcf.apcf113 + l_apcf_tmp[l_i].apcf113
         LET r_apcf.apcf114 = r_apcf.apcf114 + l_apcf_tmp[l_i].apcf114
         LET r_apcf.apcf115 = r_apcf.apcf115 + l_apcf_tmp[l_i].apcf115
      END FOR
      
   {p_type1:入庫單/倉退單--E--}
   ELSE
   {p_type2:雜項--S--}
   
      #170915-00038#8 --s mark
      ##t320已沖的金額
      #SELECT SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),
      #       SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135)
      #  INTO l_apcf1.*
      #  FROM apca_t,apcf_t
      # WHERE apcaent = apcfent      AND apcald = apcfld
      #   AND apcadocno=apcfdocno    AND apcastus <> 'X'
      #   AND apcfent = g_enterprise AND apcfld = p_ld
      #   AND apcf008 = p_apca.apcadocno 
      #   AND apcf009 = p_apcc.apccseq
      #   AND apcf010 = p_apcc.apcc001
      #170915-00038#8 --e mark
      
      #170317-00029#1 --s mark 有來源單類型也是改取apcc102匯率,因此提到最上面去做
      ##170328-00023#1 --s add 原取暫估單的立帳匯率,改取重評後匯率apcc102
      #LET l_apcc102 = ''
      #SELECT apcc102 INTO l_apcc102 FROM apcc_t
      # WHERE apccent = g_enterprise AND apccld  = p_ld AND apccdocno = p_apca.apcadocno
      #   AND apccseq = p_apcc.apccseq AND apcc001 = p_apcc.apcc001        
      #LET r_apcf.apcf102 = l_apcc102   
      ##170328-00023#1 --e add 
      #170317-00029#1 --e mark      
      
      #170915-00038#8 --s mark
      #t300目前
      #IF p_apca.apca001 = '03' THEN
      #   SELECT SUM(apcb103),SUM(apcb104),SUM(apcb105),SUM(apcb113),SUM(apcb114),SUM(apcb115),
      #          SUM(apcb123),SUM(apcb124),SUM(apcb125),SUM(apcb133),SUM(apcb134),SUM(apcb135)
      #     INTO l_apcb1.apcb103,l_apcb1.apcb104,l_apcb1.apcb105,
      #          l_apcb1.apcb113,l_apcb1.apcb114,l_apcb1.apcb115,
      #          l_apcb1.apcb123,l_apcb1.apcb124,l_apcb1.apcb125,
      #          l_apcb1.apcb133,l_apcb1.apcb134,l_apcb1.apcb135
      #     FROM apcb_t
      #    WHERE apcbent = g_enterprise 
      #      AND apcbld  = p_ld AND apcbdocno = p_apcadocno 
      #      AND apcb001 IN ('19','16') 
      #      AND apcb023 = 'Y'
      #   SELECT SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),
      #          SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135)
      #     INTO l_apcf2.apcf103,l_apcf2.apcf104,l_apcf2.apcf105,l_apcf2.apcf113,l_apcf2.apcf114,l_apcf2.apcf115,
      #          l_apcf2.apcf123,l_apcf2.apcf124,l_apcf2.apcf125,l_apcf2.apcf133,l_apcf2.apcf134,l_apcf2.apcf135
      #     FROM apcf_t,apca_t
      #    WHERE apcaent = apcfent AND apcald = apcfld 
      #      AND apcadocno = apcf008 AND apca001 = '03'
      #      AND apcfent = g_enterprise
      #      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      #ELSE
      #   SELECT SUM(apcb103),SUM(apcb104),SUM(apcb105),SUM(apcb113),SUM(apcb114),SUM(apcb115),
      #          SUM(apcb123),SUM(apcb124),SUM(apcb125),SUM(apcb133),SUM(apcb134),SUM(apcb135)
      #     INTO l_apcb1.apcb103,l_apcb1.apcb104,l_apcb1.apcb105,
      #          l_apcb1.apcb113,l_apcb1.apcb114,l_apcb1.apcb115,
      #          l_apcb1.apcb123,l_apcb1.apcb124,l_apcb1.apcb125,
      #          l_apcb1.apcb133,l_apcb1.apcb134,l_apcb1.apcb135
      #     FROM apcb_t
      #    WHERE apcbent = g_enterprise 
      #      AND apcbld  = p_ld AND apcbdocno = p_apcadocno 
      #      AND apcb001 IN ('29','26')
      #      AND apcb023 = 'Y'
      #   SELECT SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),
      #          SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135)
      #     INTO l_apcf2.apcf103,l_apcf2.apcf104,l_apcf2.apcf105,l_apcf2.apcf113,l_apcf2.apcf114,l_apcf2.apcf115,
      #          l_apcf2.apcf123,l_apcf2.apcf124,l_apcf2.apcf125,l_apcf2.apcf133,l_apcf2.apcf134,l_apcf2.apcf135
      #     FROM apcf_t,apca_t
      #    WHERE apcaent = apcfent AND apcald = apcfld 
      #      AND apcadocno = apcf008 AND apca001 = '04'
      #      AND apcfent = g_enterprise
      #      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      #END IF
      #IF cl_null(l_apcf1.apcf103) THEN LET l_apcf1.apcf103 = 0 END IF      IF cl_null(l_apcf1.apcf104) THEN LET l_apcf1.apcf104 = 0 END IF         IF cl_null(l_apcf1.apcf105) THEN LET l_apcf1.apcf105 = 0 END IF
      #IF cl_null(l_apcf1.apcf113) THEN LET l_apcf1.apcf113 = 0 END IF      IF cl_null(l_apcf1.apcf114) THEN LET l_apcf1.apcf114 = 0 END IF         IF cl_null(l_apcf1.apcf115) THEN LET l_apcf1.apcf115 = 0 END IF
      #IF cl_null(l_apcf1.apcf123) THEN LET l_apcf1.apcf123 = 0 END IF      IF cl_null(l_apcf1.apcf124) THEN LET l_apcf1.apcf124 = 0 END IF         IF cl_null(l_apcf1.apcf125) THEN LET l_apcf1.apcf125 = 0 END IF
      #IF cl_null(l_apcf1.apcf133) THEN LET l_apcf1.apcf133 = 0 END IF      IF cl_null(l_apcf1.apcf134) THEN LET l_apcf1.apcf134 = 0 END IF         IF cl_null(l_apcf1.apcf135) THEN LET l_apcf1.apcf135 = 0 END IF
      #IF cl_null(l_apcf2.apcf103) THEN LET l_apcf2.apcf103 = 0 END IF      IF cl_null(l_apcf2.apcf113) THEN LET l_apcf2.apcf113 = 0 END IF
      #IF cl_null(l_apcf2.apcf104) THEN LET l_apcf2.apcf104 = 0 END IF      IF cl_null(l_apcf2.apcf114) THEN LET l_apcf2.apcf114 = 0 END IF
      #IF cl_null(l_apcf2.apcf105) THEN LET l_apcf2.apcf105 = 0 END IF      IF cl_null(l_apcf2.apcf115) THEN LET l_apcf2.apcf115 = 0 END IF
      #LET l_apcb1.apcb103 = l_apcb1.apcb103 - l_apcf2.apcf103
      #LET l_apcb1.apcb104 = l_apcb1.apcb104 - l_apcf2.apcf104
      #LET l_apcb1.apcb105 = l_apcb1.apcb105 - l_apcf2.apcf105
      #LET l_apcb1.apcb113 = l_apcb1.apcb113 - l_apcf2.apcf113
      #LET l_apcb1.apcb114 = l_apcb1.apcb114 - l_apcf2.apcf114
      #LET l_apcb1.apcb115 = l_apcb1.apcb115 - l_apcf2.apcf114
      #
      #CASE
      #    WHEN l_sfin3012 ='1'    #2:雜項  /1:立帳未稅
      #         IF ((p_apcc.apcc108 - l_apcf1.apcf103) >  l_apcb1.apcb103 AND l_apca100 =  p_apca.apca100) OR
      #            ((p_apcc.apcc118 - l_apcf1.apcf113) >  l_apcb1.apcb113 AND l_apca100 <> p_apca.apca100) THEN
      #            IF l_apca100 = p_apca.apca100 THEN        #同幣別沖暫估
      #               LET r_apcf.apcf103 = l_apcb1.apcb103
      #               LET r_apcf.apcf104 = 0
      #               LET r_apcf.apcf105 = l_apcb1.apcb103
      #               #LET r_apcf.apcf113 = l_apcb1.apcb103 * p_apca.apca101 #170328-00023#1 mark
      #               LET r_apcf.apcf113 = l_apcb1.apcb103 * l_apcc102       #170328-00023#1 add
      #               LET r_apcf.apcf114 = 0
      #               #LET r_apcf.apcf115 = l_apcb1.apcb103 * p_apca.apca101 #170328-00023#1 mark
      #               LET r_apcf.apcf115 = l_apcb1.apcb103 * l_apcc102       #170328-00023#1 add
      #               CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf113,2) RETURNING g_sub_success,g_errno,r_apcf.apcf113
      #               CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf115,2) RETURNING g_sub_success,g_errno,r_apcf.apcf115
      #            ELSE                                      #不同幣別沖暫估
      #               LET r_apcf.apcf113 = l_apcb1.apcb113
      #               LET r_apcf.apcf114 = 0
      #               LET r_apcf.apcf115 = l_apcb1.apcb113
      #               LET r_apcf.apcf104 = 0
      #               #170328-00023#1 --s mark
      #               #CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf113/p_apca.apca101,2) RETURNING g_sub_success,g_errno,r_apcf.apcf103
      #               #CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf115/p_apca.apca101,2) RETURNING g_sub_success,g_errno,r_apcf.apcf105
      #               #170328-00023#1 --e mark
      #               #170328-00023#1 --s add
      #               CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf113/l_apcc102,2) RETURNING g_sub_success,g_errno,r_apcf.apcf103
      #               CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf115/l_apcc102,2) RETURNING g_sub_success,g_errno,r_apcf.apcf105                     
      #               #170328-00023#1 --e add
      #            END IF
      #         ELSE
      #            LET r_apcf.apcf103 = p_apcc.apcc108 - l_apcf1.apcf103
      #            LET r_apcf.apcf104 = 0
      #            LET r_apcf.apcf105 = p_apcc.apcc108 - l_apcf1.apcf103
      #            LET r_apcf.apcf113 = p_apcc.apcc118 - l_apcf1.apcf113
      #            LET r_apcf.apcf114 = 0
      #            LET r_apcf.apcf115 = p_apcc.apcc118 - l_apcf1.apcf113
      #         END IF
      #         
      #    WHEN l_sfin3012 ='2'    #2:雜項  /2:立帳含稅
      #         IF (p_apcc.apcc108 - l_apcf1.apcf105) >  l_apcb1.apcb105 THEN
      #            #l_glaacomp營運據點/p_oodb002稅別/p_money計稅基礎/p_num數量/p_curr幣別/p_rate匯率
      #            #CALL s_tax_count(l_glaacomp,p_apca.apca011,l_apcb1.apcb105,1,p_apca.apca100,p_apca.apca101) #170328-00023#1 mark
      #            CALL s_tax_count(l_glaacomp,p_apca.apca011,l_apcb1.apcb105,1,p_apca.apca100,l_apcc102)       #170328-00023#1 add
      #                 RETURNING r_apcf.apcf103,r_apcf.apcf104,r_apcf.apcf105,
      #                           r_apcf.apcf113,r_apcf.apcf114,r_apcf.apcf115
      #         ELSE
      #            #170328-00023#1 --s add      
      #            IF p_apcc.apcc108 - l_apcf1.apcf105 = 0 THEN          #表示這一張暫估單已經沖完了/要抓下一筆t320繼續沖
      #               LET r_flag = 1          #CONTINUE FOREACH        
      #               RETURN r_flag,r_apcf.*,l_apcf_tmp
      #            END IF
      #            #170328-00023#1 --e add                 
      #         
      #            #170328-00023#1 --s mark  kris:可沖餘額一律放含稅金額,取原暫估單的稅率反推, 不call s_tax_count計算 
      #            #CALL s_tax_count(l_glaacomp,p_apca.apca011,(p_apcc.apcc108 - l_apcf1.apcf103),1,p_apca.apca100,p_apca.apca101) 
      #            #     RETURNING r_apcf.apcf103,r_apcf.apcf104,r_apcf.apcf105,
      #            #               r_apcf.apcf113,r_apcf.apcf114,r_apcf.apcf115
      #            #LET r_apcf.apcf115 = p_apcc.apcc118 - l_apcf1.apcf113
      #            #170328-00023#1 --e mark
      #            
      #            #170328-00023#1 --s add  
      #            LET l_t320_apca012 = ''
      #            LET l_t320_apca100 = ''
      #            SELECT apca012,apca100 INTO l_t320_apca012,l_t320_apca100 FROM apca_t WHERE apcaent = g_enterprise  AND apcald = p_ld AND apcadocno = p_apca.apcadocno
      #            IF l_t320_apca012 > 0 THEN
      #               LET r_apcf.apcf105 = p_apcc.apcc108 - l_apcf1.apcf105
      #               LET r_apcf.apcf103 = r_apcf.apcf105 / (1 + l_t320_apca012/100)
      #               CALL s_curr_round_ld('1',p_ld,l_t320_apca100,r_apcf.apcf103,2) RETURNING g_sub_success,g_errno,r_apcf.apcf103
      #               LET r_apcf.apcf113 = r_apcf.apcf103 * l_apcc102
      #               LET r_apcf.apcf115 = r_apcf.apcf105 * l_apcc102                     
      #            ELSE
      #               LET r_apcf.apcf103 = p_apcc.apcc108 - l_apcf1.apcf105
      #               LET r_apcf.apcf105 = p_apcc.apcc108 - l_apcf1.apcf105
      #               LET r_apcf.apcf113 = r_apcf.apcf103 * l_apcc102
      #               LET r_apcf.apcf115 = r_apcf.apcf105 * l_apcc102
      #            END IF
      #            CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf113,2) RETURNING g_sub_success,g_errno,r_apcf.apcf113
      #            CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apcf.apcf115,2) RETURNING g_sub_success,g_errno,r_apcf.apcf115  
      #            #170328-00023#1 --e add  
      #            
      #         END IF
      #         #160621-00026#1--s
      #         LET r_apcf.apcf104 = r_apcf.apcf105 - r_apcf.apcf103
      #         LET r_apcf.apcf114 = r_apcf.apcf115 - r_apcf.apcf113
      #         LET r_apcf.apcf124 = r_apcf.apcf125 - r_apcf.apcf123
      #         LET r_apcf.apcf134 = r_apcf.apcf135 - r_apcf.apcf133
      #         #160621-00026#1--e                  
      #END CASE
      # 
      ##取得核算項資料--(S)--
      #LET l_sql = "SELECT apcborga,",
      #            "       apcb010,apcb011,apcb024,apcb036,apcb004,",
      #            "       apcb051,apcb015,apcb016,apcb033,apcb034,",
      #            "       apcb035,apcb037,apcb038,apcb039,apcb040,",
      #            "       apcb041,apcb042,apcb043,apcb044,apcb045,",
      #            "       apcb046,apcb047,apcb021 ",
      #            "  FROM apcb_t",
      #            " WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
      #            "   AND apcbdocno = '",p_apcadocno,"' ",
      #            "   AND apcb001 IN ('19','29','16','26') ", 
      #            "   AND apcb023 = 'Y' "
      #PREPARE s_aapp131_get_t300apcb_p1 FROM l_sql
      #DECLARE s_aapp131_get_t300apcb_c1 CURSOR FOR s_aapp131_get_t300apcb_p1
      #FOREACH s_aapp131_get_t300apcb_c1 INTO l_apcb1.apcborga,
      #        l_apcb1.apcb010,l_apcb1.apcb011,l_apcb1.apcb024,l_apcb1.apcb036,l_apcb1.apcb004,
      #        l_apcb1.apcb051,l_apcb1.apcb015,l_apcb1.apcb016,l_apcb1.apcb033,l_apcb1.apcb034,
      #        l_apcb1.apcb035,l_apcb1.apcb037,l_apcb1.apcb038,l_apcb1.apcb039,l_apcb1.apcb040,
      #        l_apcb1.apcb041,l_apcb1.apcb042,l_apcb1.apcb043,l_apcb1.apcb044,l_apcb1.apcb045,
      #        l_apcb1.apcb046,l_apcb1.apcb047,l_apcb1.apcb021
      #
      #   IF cl_null(r_apcf.apcforga)THEN LET r_apcf.apcforga= l_apcb1.apcborga END IF      #來源組織
      #   IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = l_apcb1.apcb010 END IF       #業務部門
      #   IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = l_apcb1.apcb011 END IF       #責任中心
      #   IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = l_apcb1.apcb024 END IF       #區域
      #   IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = l_apcb1.apcb036 END IF       #客群
      #   IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = l_apcb1.apcb004 END IF       #產品類別
      #   IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = l_apcb1.apcb051 END IF       #業務人員
      #   IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = l_apcb1.apcb015 END IF       #專案編號
      #   IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = l_apcb1.apcb016 END IF       #WBS
      #   IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = l_apcb1.apcb033 END IF       #經營方式
      #   IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = l_apcb1.apcb034 END IF       #渠道
      #   IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = l_apcb1.apcb035 END IF       #品牌
      #   IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = l_apcb1.apcb037 END IF       #自由核算項1
      #   IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = l_apcb1.apcb038 END IF       #自由核算項2
      #   IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = l_apcb1.apcb039 END IF       #自由核算項3
      #   IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = l_apcb1.apcb040 END IF       #自由核算項4
      #   IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = l_apcb1.apcb041 END IF       #自由核算項5
      #   IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = l_apcb1.apcb042 END IF       #自由核算項6
      #   IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = l_apcb1.apcb043 END IF       #自由核算項7
      #   IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = l_apcb1.apcb044 END IF       #自由核算項8
      #   IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = l_apcb1.apcb045 END IF       #自由核算項9
      #   IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = l_apcb1.apcb046 END IF       #自由核算項10
      #   IF cl_null(r_apcf.apcf049) THEN LET r_apcf.apcf049 = l_apcb1.apcb047 END IF       #摘要
      #   IF cl_null(r_apcf.apcf022) THEN LET r_apcf.apcf022 = l_apcb1.apcb021 END IF       #費用會計科目
      #END FOREACH
      ##取得核算項資料--(E)--
      #170915-00038#8 --e mark
      
      #170915-00038#8 --s add    
      LET l_cnt = 0
      #計算雜項是否有可暫估金額      
      LET l_sql = "SELECT apcb002,apcb003,",
                  "       apcb101,",
                  "       apcb103,apcb104,apcb105,apcb113,apcb114,apcb115,",
                  "       apcb123,apcb124,apcb125,apcb133,apcb134,apcb135,",
                  "       apcborga,",
                  "       apcb010,apcb011,apcb024,apcb036,apcb004,",
                  "       apcb051,apcb015,apcb016,apcb033,apcb034,",
                  "       apcb035,apcb037,apcb038,apcb039,apcb040,",
                  "       apcb041,apcb042,apcb043,apcb044,apcb045,",
                  "       apcb046,apcb047,apcb021,apcb020,apcb012  ",          #181113-00009#1---add--->   ,apcb012   
                  "  FROM apca_t,apcb_t",
                  " WHERE apcaent = apcbent AND apcadocno = apcbdocno AND apcald = apcbld ",
                  "   AND apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                  "   AND apcbdocno = '",p_apcadocno,"' ",
                  "   AND apcb002 = '",p_apca.apcadocno,"' ",
                  "   AND apcb001 IN ('19','29') AND apcb023 = 'Y' ",
                  "   AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL "
                  
      IF l_sfin2002 = '3' THEN
         LET l_sql = l_sql," AND apcb003 = '",p_apcc.apccseq,"'"
      END IF  

      PREPARE s_aapp131_get_t301apcb_p FROM l_sql
      DECLARE s_aapp131_get_t301apcb_c CURSOR FOR s_aapp131_get_t301apcb_p
      FOREACH s_aapp131_get_t301apcb_c INTO l_apcb002,l_apcb003,l_apcb1.*  
 
         #取t320的資料 
         LET l_apcf103 = 0 
         LET l_apcf105 = 0       
         EXECUTE s_aapp131_get_apcf105 USING l_apcb002,l_apcb003 INTO l_apcf103,l_apcf105
         IF cl_null(l_apcf103) THEN LET l_apcf103 = 0 END IF         
         IF cl_null(l_apcf105) THEN LET l_apcf105 = 0 END IF       
      
         #計算已沖金額(不含本張單沖銷的金額) aapt301/341中已沖金額
         LET l_apcb103 = 0
         LET l_apcb105 = 0           
         EXECUTE s_aapp131_apcb105p USING l_apcb002,l_apcb003 INTO l_apcb103,l_apcb105 
         IF cl_null(l_apcb103) THEN LET l_apcb103 = 0 END IF
         IF cl_null(l_apcb105) THEN LET l_apcb105 = 0 END IF
         
         #可沖餘額
         LET l_apcb103_do = l_apcf103 - l_apcb103
         LET l_apcb105_do = l_apcf105 - l_apcb105
         IF cl_null(l_apcb105_do) THEN CONTINUE FOREACH END IF
         
         #170930-00022#1 add(s)
         #抓再t300有沖過的單(以整張單的角度去抓數字)
         LET l_sql = "  SELECT SUM(apcf007), ",
                     "         SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),", 
                     "         SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135),",
                     "         apcf009 ",
                     "    FROM apcf_t",
                     "   WHERE apcfent = ",g_enterprise," AND apcfld  = ? AND apcfdocno <> ?  ",
                     "     AND apcf008 = ? ",
                    #"   GROUP BY apcf009",   #190104-00006#1 mark
                     #180228-00001#1 add(s)                  
                     "     AND apcfdocno NOT IN (SELECT apcadocno FROM apca_t WHERE apcaent= ",g_enterprise,
                     "     AND apcald= ? ",
                     "     AND apcastus<>'X')"
                     #180228-00001#1 add(e)
                    ,"   GROUP BY apcf009"    #190104-00006#1 add
         PREPARE s_aapp131_get_apcf4p FROM l_sql
         #EXECUTE s_aapp131_get_apcf4p USING p_ld,p_apcadocno,p_apca.apcadocno INTO l_apcf3.*  #180228-00001#1 mark
         EXECUTE s_aapp131_get_apcf4p USING p_ld,p_apcadocno,p_apca.apcadocno,p_ld INTO l_apcf3.*  #180228-00001#1 add 
         IF cl_null(l_apcf3.apcf103) THEN LET l_apcf3.apcf103 = 0 END IF
         IF cl_null(l_apcf3.apcf104) THEN LET l_apcf3.apcf104 = 0 END IF
         IF cl_null(l_apcf3.apcf105) THEN LET l_apcf3.apcf105 = 0 END IF
         IF cl_null(l_apcf3.apcf113) THEN LET l_apcf3.apcf113 = 0 END IF
         IF cl_null(l_apcf3.apcf114) THEN LET l_apcf3.apcf114 = 0 END IF
         IF cl_null(l_apcf3.apcf115) THEN LET l_apcf3.apcf115 = 0 END IF
         IF cl_null(l_apcf3.apcf123) THEN LET l_apcf3.apcf123 = 0 END IF
         IF cl_null(l_apcf3.apcf124) THEN LET l_apcf3.apcf124 = 0 END IF
         IF cl_null(l_apcf3.apcf125) THEN LET l_apcf3.apcf125 = 0 END IF
         IF cl_null(l_apcf3.apcf133) THEN LET l_apcf3.apcf133 = 0 END IF
         IF cl_null(l_apcf3.apcf134) THEN LET l_apcf3.apcf134 = 0 END IF
         IF cl_null(l_apcf3.apcf135) THEN LET l_apcf3.apcf135 = 0 END IF
         #170930-00022#1 add(e)
         
         #核算項填入
         IF cl_null(r_apcf.apcforga)THEN LET r_apcf.apcforga= l_apcb1.apcborga END IF      #來源組織
         IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = l_apcb1.apcb010 END IF       #業務部門
         IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = l_apcb1.apcb011 END IF       #責任中心
         IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = l_apcb1.apcb024 END IF       #區域
         IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = l_apcb1.apcb036 END IF       #客群
#         IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = l_apcb1.apcb004 END IF       #產品類別   #181113-00009#1---mark
         IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = l_apcb1.apcb012 END IF       #產品類別   #181113-00009#1---add
         IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = l_apcb1.apcb051 END IF       #業務人員
         IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = l_apcb1.apcb015 END IF       #專案編號
         IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = l_apcb1.apcb016 END IF       #WBS
         IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = l_apcb1.apcb033 END IF       #經營方式
         IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = l_apcb1.apcb034 END IF       #渠道
         IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = l_apcb1.apcb035 END IF       #品牌
         IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = l_apcb1.apcb037 END IF       #自由核算項1
         IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = l_apcb1.apcb038 END IF       #自由核算項2
         IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = l_apcb1.apcb039 END IF       #自由核算項3
         IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = l_apcb1.apcb040 END IF       #自由核算項4
         IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = l_apcb1.apcb041 END IF       #自由核算項5
         IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = l_apcb1.apcb042 END IF       #自由核算項6
         IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = l_apcb1.apcb043 END IF       #自由核算項7
         IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = l_apcb1.apcb044 END IF       #自由核算項8
         IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = l_apcb1.apcb045 END IF       #自由核算項9
         IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = l_apcb1.apcb046 END IF       #自由核算項10
         IF cl_null(r_apcf.apcf049) THEN LET r_apcf.apcf049 = l_apcb1.apcb047 END IF       #摘要
         IF cl_null(r_apcf.apcf022) THEN LET r_apcf.apcf022 = l_apcb1.apcb021 END IF       #費用會計科目         
 
         CASE
            WHEN l_sfin3012 ='1'    #1:非雜項/1:立帳不含稅
               LET l_cnt = l_cnt +1 
               #t300這次要沖的暫估未稅額 <= (t320立暫估數-t300不含本張沖暫估未稅額)
               IF l_apcb1.apcb103 <= l_apcb103_do THEN
                  LET l_apcf_tmp[l_cnt].apcf103 = l_apcb1.apcb103
                  LET l_apcf_tmp[l_cnt].apcf104 = 0
                  LET l_apcf_tmp[l_cnt].apcf105 = l_apcb1.apcb103
               ELSE
                  #超沖則用剩餘可沖金額去寫入
                  LET l_apcf_tmp[l_cnt].apcf103 = l_apcb103_do
                  LET l_apcf_tmp[l_cnt].apcf104 = 0
                  LET l_apcf_tmp[l_cnt].apcf105 = l_apcb103_do
               END IF 
               #本幣要等於原幣*原立暫估重評匯率
               LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102    
               LET l_apcf_tmp[l_cnt].apcf114 = 0
               LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102     
               #170930-00022#1 add(s)
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf114,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf114
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115
               #t301原幣加總
               LET g_sum = l_apcf_tmp[l_cnt].apcf103 + g_sum
               #t301本幣加總
               LET g_sum1 = l_apcf_tmp[l_cnt].apcf113 + g_sum1
               #如果t301與t320本幣相同，且原幣有差異，就將差異的本幣金額攤到最後一筆上
               IF g_sum = p_apcc.apcc108  OR (g_sum + l_apcf3.apcf103 = p_apcc.apcc108) THEN
                  LET l_diff = (g_sum1 + l_apcf3.apcf113) - l_sum1
                  LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf113 - l_diff
                  LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf113
               END IF
               #170930-00022#1 add(e)
            WHEN l_sfin3012 ='2'    #1:非雜項/2:立帳含稅
               LET l_cnt = l_cnt +1 
               #t300這次要沖的暫估數 <= (t320立暫估數-t300不含本張沖暫估數)
               IF l_apcb1.apcb105 <= l_apcb105_do THEN
                  LET l_apcf_tmp[l_cnt].apcf103 = l_apcb1.apcb103
                  LET l_apcf_tmp[l_cnt].apcf104 = l_apcb1.apcb104
                  LET l_apcf_tmp[l_cnt].apcf105 = l_apcb1.apcb105   
               ELSE
                  #超沖則用剩餘可沖金額去寫入
                  LET l_apcf_tmp[l_cnt].apcf103 = l_apcb103_do
                  LET l_apcf_tmp[l_cnt].apcf104 = l_apcb105_do - l_apcb103_do
                  LET l_apcf_tmp[l_cnt].apcf105 = l_apcb105_do
               END IF 
               #本幣要等於原幣*原立暫估重評匯率
               LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102    
               LET l_apcf_tmp[l_cnt].apcf114 = l_apcf_tmp[l_cnt].apcf104 * l_apcc102    
               LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf105 * l_apcc102      
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf114,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf114
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115
               #170930-00022#1 add(s)
               #t301原幣加總
               LET g_sum = l_apcf_tmp[l_cnt].apcf105 + g_sum
               #t301本幣加總
               LET g_sum1 = l_apcf_tmp[l_cnt].apcf115 + g_sum1
               #如果t301與t320本幣相同，且原幣有差異，就將差異的本幣金額攤到最後一筆上
               IF g_sum = p_apcc.apcc108 OR (g_sum + l_apcf3.apcf105 = p_apcc.apcc108) THEN
                  LET l_diff = (g_sum1 + l_apcf3.apcf115) - l_sum1
                  LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf115 - l_diff
               END IF
               #170930-00022#1 add(e)
               #180718-00030#1 --s mark 避免推算後產生的尾差,比照s_tax_ins推算基準計算未稅
               #LET l_apcf_tmp[l_cnt].apcf104 = l_apcf_tmp[l_cnt].apcf105 - l_apcf_tmp[l_cnt].apcf103
               #LET l_apcf_tmp[l_cnt].apcf114 = l_apcf_tmp[l_cnt].apcf115 - l_apcf_tmp[l_cnt].apcf113
               #LET l_apcf_tmp[l_cnt].apcf124 = l_apcf_tmp[l_cnt].apcf125 - l_apcf_tmp[l_cnt].apcf123
               #LET l_apcf_tmp[l_cnt].apcf134 = l_apcf_tmp[l_cnt].apcf135 - l_apcf_tmp[l_cnt].apcf133
               #180718-00030#1 --e mark
               #180718-00030#1 --s add
               LET l_apcf_tmp[l_cnt].apcf103 = l_apcf_tmp[l_cnt].apcf105 - l_apcf_tmp[l_cnt].apcf104
               LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf115 - l_apcf_tmp[l_cnt].apcf114
               LET l_apcf_tmp[l_cnt].apcf123 = l_apcf_tmp[l_cnt].apcf125 - l_apcf_tmp[l_cnt].apcf124
               LET l_apcf_tmp[l_cnt].apcf133 = l_apcf_tmp[l_cnt].apcf135 - l_apcf_tmp[l_cnt].apcf134                   
               #180718-00030#1 --e add               
         END CASE
         
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf114,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf114
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115
      END FOREACH    
      LET r_apcf.apcf007 = 1     #180227-00030#1 add 雜項用金額看,數量給1
      LET r_apcf.apcf103 = 0     LET r_apcf.apcf113 = 0      
      LET r_apcf.apcf104 = 0     LET r_apcf.apcf114 = 0
      LET r_apcf.apcf105 = 0     LET r_apcf.apcf115 = 0
      FOR l_i = 1 TO l_apcf_tmp.getLength()
         LET r_apcf.apcf103 = r_apcf.apcf103 + l_apcf_tmp[l_i].apcf103
         LET r_apcf.apcf104 = r_apcf.apcf104 + l_apcf_tmp[l_i].apcf104
         LET r_apcf.apcf105 = r_apcf.apcf105 + l_apcf_tmp[l_i].apcf105
         LET r_apcf.apcf113 = r_apcf.apcf113 + l_apcf_tmp[l_i].apcf113
         LET r_apcf.apcf114 = r_apcf.apcf114 + l_apcf_tmp[l_i].apcf114
         LET r_apcf.apcf115 = r_apcf.apcf115 + l_apcf_tmp[l_i].apcf115
      END FOR      
      #170915-00038#8 --e add       
      
   END IF
   {p_type2:雜項--E--}
   
   LET r_apcf.apcfent = g_enterprise
   LET r_apcf.apcfld  = p_ld
   LET r_apcf.apcfdocno=p_apcadocno
   SELECT MAX(apcfseq) + 1 INTO r_apcf.apcfseq
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcadocno  
   IF cl_null(r_apcf.apcfseq) THEN LET r_apcf.apcfseq = 1 END IF
   LET r_apcf.apcfseq2 = 0
   LET r_apcf.apcf001 = 'aapt300'
   LET r_apcf.apcf002 = '01'                 #固定值
   LET r_apcf.apcf008 = p_apca.apcadocno
   LET r_apcf.apcf009 = p_apcc.apccseq
   LET r_apcf.apcf010 = p_apcc.apcc001       #期別:暫估原則上只有一期
   LET r_apcf.apcf020 = p_apca.apca011       #稅別   
  
   CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_11') RETURNING g_sub_success,r_apcf.apcf024,g_errno #160816-00022#4 add 
   CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_12') RETURNING g_sub_success,r_apcf.apcf025,g_errno #160816-00022#4 add
  
   IF l_sfin3011 = 'N' THEN      #不迴轉(Y代表回转。N不回转:抓apcf)
      LET r_apcf.apcf021 = p_apca.apca035   #180511-00073#1 mark   #180516-00002#1 remark
      #180511-00073#1---add---str--
      IF l_sfin2002 = '3' THEN
         SELECT apcb029 INTO r_apcf.apcf021
           FROM apcb_t
          WHERE apcbent = g_enterprise
            AND apcbld = p_ld
            AND apcbdocno = p_apca.apcadocno
            AND apcbseq = p_apcc.apccseq
      END IF
      #180511-00073#1---add---end--
      LET r_apcf.apcf022 = p_apca.apca036
      CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_08') RETURNING g_sub_success,r_apcf.apcf023,g_errno
   ELSE
      #151029 Sam:冲暂估明细里面的科目应该根据对应的暂估立账单上的账款科目带过来
      #LET r_apcf.apcf021 = l_apca035          #151029 mark
      LET r_apcf.apcf021 = p_apca.apca035      #151029 add
      SELECT glac007 INTO l_glac007       #取得科目性質
        #FROM glac_t,glaa_t #170615-00061#1 mark glaa_t 無條件串到,移除避免影響效能
        FROM glac_t         #170615-00061#1 add 
       WHERE glacent = g_enterprise AND glac001 = l_glaa004 AND glac002 = l_apca036
      IF cl_null(l_glac007) THEN LET l_glac007 = 0 END IF  
      SELECT apcadocdt INTO l_apcadocdt1  #立帳單的立帳日期
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apcadocno
       SELECT apcadocdt INTO l_apcadocdt2 #暫估單的立帳日期
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apca.apcadocno
      #當期沖暫估的科目及資產類科目
      IF l_glac007 NOT MATCHES '[45]' OR (YEAR(l_apcadocdt1) = YEAR(l_apcadocdt2) AND MONTH(l_apcadocdt1) = MONTH(l_apcadocdt2)) THEN
         LET r_apcf.apcf022 = p_apca.apca036
      ELSE
         LET r_apcf.apcf022 = l_apca036
      END IF
      #CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_04')  RETURNING g_sub_success,r_apcf.apcf023,g_errno  #160816-00022#4 mark
      #科目應該使用暫估稅額科目
      CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_08') RETURNING g_sub_success,r_apcf.apcf023,g_errno    #160816-00022#4 add
      
      #160816-00022#4 --s add      
      #若aoos020暫估回轉=Y and立暫估年月<>沖暫估年月,則沖暫估訊息apcf科目給null
      IF l_sfin3011 = 'Y' AND (NOT(YEAR(l_apcadocdt1) = YEAR(l_apcadocdt2) AND MONTH(l_apcadocdt1) = MONTH(l_apcadocdt2))) THEN 
         LET r_apcf.apcf021  = ''
         LET r_apcf.apcf022  = ''
         LET r_apcf.apcf023  = ''
         LET r_apcf.apcf024  = ''
         LET r_apcf.apcf025  = ''
      END IF
      #160816-00022#4 --e add
      
   END IF
   #CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_11') RETURNING g_sub_success,r_apcf.apcf024,g_errno #160816-00022#4 mark
   #CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_12') RETURNING g_sub_success,r_apcf.apcf025,g_errno #160816-00022#4 mark
   
   #161102-00015#7 --s add
   IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
   IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
   IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
   IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
   IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
   IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
   IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
   IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
   IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
   IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
   IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
   IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
   IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
   IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
   IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
   IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
   IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
   IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
   IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
   IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
   IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
   IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
   IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十      
   #161102-00015#7 --e add   
   
   RETURN r_flag,r_apcf.*,l_apcf_tmp
END FUNCTION

################################################################################
# Descriptions...: 寫入暫估差異
# Memo...........: 類型1須配合s_aapp131_ins_apcf元件
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcf_diff(p_type,p_ld,p_apcadocno,p_apcf_tmp)
DEFINE p_type        LIKE type_t.chr1
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_apcadocno   LIKE apca_t.apcadocno   #立帳單據
DEFINE p_apcf_tmp    DYNAMIC ARRAY OF type_apcf_tmp 
#DEFINE l_apcf        RECORD LIKE apcf_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
#161111-00048#2 --e add
DEFINE l_sql         STRING
DEFINE l_apca007     LIKE apca_t.apca007
DEFINE l_apca101     LIKE apca_t.apca101
DEFINE l_apca100     LIKE apca_t.apca100
DEFINE l_glaacomp    LIKE glaa_t.glaacomp
DEFINE l_glaa001     LIKE glaa_t.glaa001
DEFINE l_apcf106     LIKE apcf_t.apcf106
DEFINE l_apcf116     LIKE apcf_t.apcf116
DEFINE l_i,l_cnt     LIKE type_t.num5
DEFINE l_apcb113     LIKE apcb_t.apcb105
DEFINE l_apcb123     LIKE apcb_t.apcb105
DEFINE l_apcb133     LIKE apcb_t.apcb105
DEFINE l_apcf101     LIKE apcf_t.apcf101
DEFINE l_apcf111     LIKE apcf_t.apcf111
DEFINE l_apcf113     LIKE apcf_t.apcf113
DEFINE l_apcf123     LIKE apcf_t.apcf123
DEFINE l_apcf133     LIKE apcf_t.apcf133
DEFINE l_apcf1131    LIKE apcf_t.apcf113
DEFINE l_apcf1231    LIKE apcf_t.apcf123
DEFINE l_apcf1331    LIKE apcf_t.apcf133
DEFINE l_sfin2011    LIKE type_t.chr1   
DEFINE l_sfin3011    LIKE type_t.chr1        #迴轉否   #150812-00010#3
DEFINE l_sfin3012    LIKE type_t.chr1
DEFINE l_apcborga    LIKE apcb_t.apcborga             #150417-00007#87
DEFINE l_apcadocdt    LIKE apca_t.apcadocdt           #160816-00022#4 add
DEFINE l_apcf021_null LIKE type_t.chr1                #160816-00022#4 add 清空科目否
DEFINE l_sfin3034     LIKE type_t.chr1                #170821-00012#1 add 暫估期初迴轉,沖暫估時認列差異否
DEFINE l_apca015     LIKE apca_t.apca015              #170618-00029#1   By 10044 add
DEFINE l_glad007     LIKE glad_t.glad007              #170618-00029#1   By 10044 add
#180403-00026#1 --s add
DEFINE l_amt_apcf113 LIKE apcf_t.apcf113 
DEFINE l_amt_apcf114 LIKE apcf_t.apcf114 
DEFINE l_amt_apcf115 LIKE apcf_t.apcf115 
DEFINE l_amt_apcf123 LIKE apcf_t.apcf123 
DEFINE l_amt_apcf124 LIKE apcf_t.apcf124 
DEFINE l_amt_apcf125 LIKE apcf_t.apcf125 
DEFINE l_amt_apcf133 LIKE apcf_t.apcf133 
DEFINE l_amt_apcf134 LIKE apcf_t.apcf134 
DEFINE l_amt_apcf135 LIKE apcf_t.apcf135 
#180403-00026#1 --e add

   WHENEVER ERROR CONTINUE
   
   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa001')
        RETURNING  g_sub_success,l_glaacomp,l_glaa001
   
  #CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2011') RETURNING l_sfin2011   #150812-00010#3 mark
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3011') RETURNING l_sfin3011   #150812-00010#3   
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3034') RETURNING l_sfin3034   #170821-00012#1 add
  #IF l_sfin2011 = 'N' THEN LET l_sfin3012 = '1' END IF  #1.立帳不含稅   #150812-00010#3 mark
  #IF l_sfin3011 = 'N' THEN LET l_sfin3012 = '1' END IF  #1.立帳不含稅   #160621-00026#1 mark  拿掉S-FIN-3003迴轉否影響是否含稅立帳判斷   #150812-00010#3   
   
   LET l_apcadocdt = '' #160816-00022#4 add
   
   #SELECT apca007,apca101,apca100,apcadocdt            #160816-00022#4 add apcadocdt       #170618-00029#1   By 10044 mark
   SELECT apca007,apca101,apca100,apcadocdt,apca015      #170618-00029#1   By 10044 add
     #INTO l_apca007,l_apca101,l_apca100,l_apcadocdt    #160816-00022#4 add l_apcadocdt     #170618-00029#1   By 10044 mark
     INTO l_apca007,l_apca101,l_apca100,l_apcadocdt,l_apca015   #170618-00029#1   By 10044 add
     FROM apca_t
    WHERE apcaent = g_enterprise
      AND apcald  = p_ld AND apcadocno = p_apcadocno
   
   #SELECT count(*) INTO l_cnt         #161114-00009#1 mark
   SELECT count(apcfdocno) INTO l_cnt  #161114-00009#1 add
     FROM apcf_t,apca_t
    WHERE apcaent = apcfent AND apcald = apcfld AND apcadocno = apcf008
      AND apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apca001 IN ('01','02','03','04')
   IF l_cnt = 0 THEN #若無0*單據不沖暫估
      RETURN
   END IF

   #160816-00022#4 --s add
   #若期初回轉否=Y,沖暫估訊息中非diff單據,有沖非本月份的,則將科目清空
   LET l_apcf021_null = 'N'
   #IF l_sfin3011 = 'Y' THEN                         #170821-00012#1 mark
   IF (l_sfin3011 = 'Y') AND (l_sfin3034 = 'N') THEN #170821-00012#1 add
      LET l_cnt = 0
      #SELECT COUNT(*) INTO l_cnt        #161114-00009#1 mark
      SELECT COUNT(apcfdocno) INTO l_cnt #161114-00009#1 add
        FROM apcf_t,apca_t
       WHERE apcaent = apcfent AND apcald = apcfld AND apcadocno = apcf008
         AND apcfent = g_enterprise AND apcfld = p_ld 
         AND apcfdocno = p_apcadocno AND apcf008 <> 'DIFF' 
         AND apca001 IN ('01','02','03','04')
         AND (to_char(apcadocdt,'yyyy') = to_char(l_apcadocdt,'yyyy') AND to_char(apcadocdt,'mm') = to_char(l_apcadocdt,'mm'))
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt = 0 THEN   #表示有沖非本月份的
         LET l_apcf021_null = 'Y'
      END IF
   END IF
   #160816-00022#4 --e add

   INITIALIZE l_apcf.* TO NULL
   LET l_apcf.apcfent = g_enterprise
   LET l_apcf.apcfld  = p_ld
   LET l_apcf.apcforga=l_glaacomp
   LET l_apcf.apcfdocno=p_apcadocno
   LET l_apcf.apcfseq2 = 0 
   LET l_apcf.apcf001 = 'aapt300'
   LET l_apcf.apcf002 = '01'              #固定值
   LET l_apcf.apcf007 = 1
   LET l_apcf.apcf008 = 'DIFF'
   LET l_apcf.apcf009 = 0
   LET l_apcf.apcf010 = 0
   LET l_apcf.apcf020 = ''
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf023 = ''
   LET l_apcf.apcf024 = ''
   LET l_apcf.apcf025 = ''
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf101 = 0
   LET l_apcf.apcf104 = 0
   LET l_apcf.apcf106 = 0
   LET l_apcf.apcf111 = 0
   LET l_apcf.apcf114 = 0
   LET l_apcf.apcf116 = 0
   LET l_apcf.apcf117 = 0
   
   CASE p_type
      WHEN '1'
            #產生價差數據---(S)---
            LET l_apcf101 = 0
            LET l_apcf111 = 0
            CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf021,g_errno
            LET l_apcf.apcf102 = l_apca101
            SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
              FROM apcf_t
             WHERE apcfent = g_enterprise AND apcfld = p_ld
              AND apcfdocno=p_apcadocno  
            IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
            FOR l_i = 1 TO p_apcf_tmp.getLength()
               LET l_apcf.apcforga= p_apcf_tmp[l_i].apcborga  #150417-00007#87
               LET l_apcf101 = p_apcf_tmp[l_i].apcf106
               LET l_apcf111 = p_apcf_tmp[l_i].apcf116
               IF cl_null(l_apcf101) THEN LET l_apcf101 = 0 END IF
               IF cl_null(l_apcf111) THEN LET l_apcf111 = 0 END IF
               IF p_apcf_tmp[l_i].apca001 MATCHES '0[24]' THEN
                  LET l_apcf101 = l_apcf101 * -1
                  LET l_apcf111 = l_apcf111 * -1
               END IF
               LET l_apcf.apcf101 = l_apcf.apcf101 + l_apcf101
               LET l_apcf.apcf111 = l_apcf.apcf111 + l_apcf111
            END FOR
            LET l_apcf.apcf103 = l_apcf.apcf007 * l_apcf.apcf101
            #161216-00021#1---add---str--
            LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111           
            #170317-00029#3 --s mark 價差匯率使用t300匯率
            #LET l_apcf.apcf102 = l_apcf.apcf113/l_apcf.apcf103 
            #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf102,3) RETURNING g_sub_success,g_errno,l_apcf.apcf102 
            #170317-00029#3 --e mark
            #161216-00021#1---add---end--
            #CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf.apcf103,1) RETURNING g_sub_success,g_errno,l_apcf.apcf103 #160816-00022#4 mark 原傳入按單價取位有誤，改為按金額
            CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf.apcf103,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103  #160816-00022#4 add
            LET l_apcf.apcf105 = l_apcf.apcf103
            #LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111   #161216-00021#1 mark
            #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,1) RETURNING g_sub_success,g_errno,l_apcf.apcf113 #160816-00022#4 mark 原傳入按單價取位有誤，改為按金額
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113  #160816-00022#4 add
            LET l_apcf.apcf115 = l_apcf.apcf113
            #170317-00029#3 --s mark 價差匯率使用t300匯率
            #160816-00022#4 --s add
            #本幣未稅金額除以原幣未稅金額,推算出匯率
            #LET l_apcf.apcf102 = l_apcf.apcf113 / l_apcf.apcf103 #
            #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf102,3) RETURNING g_sub_success,g_errno,l_apcf.apcf102
            #160816-00022#4 --e add
            #170317-00029#3 --e mark
            
            #160816-00022#4 --s add
            IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
               LET l_apcf.apcf021 = ''
            END IF
            #160816-00022#4 --e add
            
            #170618-00029#1   By 10044 add----s
            #判斷是否啟用"部門"核算項
            LET l_glad007=''
            SELECT glad007 INTO l_glad007
              FROM glad_t
             WHERE gladent = g_enterprise
               AND gladld  = p_ld
               AND glad001 = l_apcf.apcf021 
            
            IF l_glad007='Y' THEN
               LET l_apcf.apcf026 = l_apca015
            ELSE
               LET l_apcf.apcf026 = ''
            END IF
            #170618-00029#1   By 10044 add----e
            
            LET l_apcf.apcf002 = 'D1'  #170317-00029#3 add 價差類型D1
            
            IF NOT (l_apcf.apcf103 = 0 AND l_apcf.apcf113 = 0) THEN
               #161102-00015#7 --s add
               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十      
               #161102-00015#7 --e add           
            
              #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 
               #161111-00048#2 --s add
               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                      l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
               #161111-00048#2 --e add
            END IF
            #產生價差數據---(E)---
            #產生匯差數據---(S)---
            #LET l_apcf.apcf102 = 1         #160816-00022#4 mark
            LET l_apcf.apcf101 = 0          #180227-00030#1 add 匯差單價0
            LET l_apcf.apcf102 = l_apca101  #160816-00022#4 add  改放t300匯率  #170720-00015#1---mark  #170725-00041#1---open
#            LET l_apcf.apcf102 = 1          #170720-00015#1---add  #170725-00041#1---mark
            LET l_apcf.apcf103 = 0
            LET l_apcf.apcf105 = 0
            LET l_apcf.apcf106 = 0
            LET l_apcf.apcf111 = 0
            LET l_apcf.apcf113 = 0
            LET l_apcf.apcf115 = 0
            LET l_apcf.apcf116 = 0
            CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf021,g_errno
            SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
              FROM apcf_t
             WHERE apcfent = g_enterprise AND apcfld = p_ld
               AND apcfdocno=p_apcadocno  
            IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
            FOR l_i = 1 TO p_apcf_tmp.getLength()
               LET l_apcf.apcforga= p_apcf_tmp[l_i].apcborga  #150417-00007#87
               IF NOT cl_null(p_apcf_tmp[l_i].apcf117) AND p_apcf_tmp[l_i].apcf117 <> 0 THEN
                  IF p_apcf_tmp[l_i].apca001 MATCHES '0[24]' THEN
                     LET p_apcf_tmp[l_i].apcf117 = p_apcf_tmp[l_i].apcf117 * -1
                     LET p_apcf_tmp[l_i].apcf107 = p_apcf_tmp[l_i].apcf107 * -1
                  END IF
                  LET l_apcf.apcf111 = l_apcf.apcf111 + p_apcf_tmp[l_i].apcf117
                  #160816-00022#4 mark --s
                  #匯差僅本幣金額,原幣金額給0
                  #LET l_apcf.apcf103 = l_apcf.apcf103 + p_apcf_tmp[l_i].apcf107
                  #LET l_apcf.apcf105 = l_apcf.apcf103
                  #160816-00022#4 mark --e
                  #160816-00022#4 add --s
                  LET l_apcf.apcf103 = 0
                  LET l_apcf.apcf105 = 0
                  #160816-00022#4 add --e
                END IF
            END FOR
            LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111
            #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf103,1) RETURNING g_sub_success,g_errno,l_apcf.apcf103 #160816-00022#4 mark 原傳入按單價取位有誤，改為按金額
            #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,1) RETURNING g_sub_success,g_errno,l_apcf.apcf113 #160816-00022#4 mark 原傳入按單價取位有誤，改為按金額
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf103,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103  #160816-00022#4 add 
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113  #160816-00022#4 add           
            LET l_apcf.apcf115 = l_apcf.apcf113
            #160816-00022#4 --s add
            IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
               LET l_apcf.apcf021 = ''
            END IF
            #160816-00022#4 --e add
            IF l_apcf.apcf111 <> 0 THEN
               #160816-00022#4 mark --s
               ##160603-00009#1--S
               #LET l_apcf.apcf103 = l_apcf.apcf113               
               #LET l_apcf.apcf105 = l_apcf.apcf115               
               ##160603-00009#1--E
               #160816-00022#4 mark --e
               
               #160816-00022#4 add --s
               #匯差僅本幣金額,原幣金額給0
               LET l_apcf.apcf103 = 0
               LET l_apcf.apcf105 = 0
               #160816-00022#4 add --e
               #170618-00029#1   By 10044 add----s
               #判斷是否啟用"部門"核算項
               LET l_glad007=''
               SELECT glad007 INTO l_glad007
                 FROM glad_t
                WHERE gladent = g_enterprise
                  AND gladld  = p_ld
                  AND glad001 = l_apcf.apcf021 
               
               IF l_glad007='Y' THEN
                  LET l_apcf.apcf026 = l_apca015
               ELSE
                  LET l_apcf.apcf026 = ''
               END IF
               #170618-00029#1   By 10044 add----e
               #161102-00015#7 --s add
               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十      
               #161102-00015#7 --e add           
               
               LET l_apcf.apcf002 = 'D2'  #170317-00029#3 add 匯差類型D2
               
              #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
               
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 
               #161111-00048#2 --s add
               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                      l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
               #161111-00048#2 --e add
            END IF
            #產生匯差數據---(E)---
      WHEN '2'
            #產生雜項沖暫估150203---(S)
            LET l_cnt = 0 
            #SELECT count(*) INTO l_cnt        #161114-00009#1 mark
            SELECT count(apcbdocno) INTO l_cnt #161114-00009#1 add
              FROM apcb_t
             WHERE apcbent = g_enterprise
               AND apcbld = p_ld AND apcbdocno = p_apcadocno
               AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
            IF l_cnt = 0 THEN RETURN END IF
            SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
              FROM apcf_t
             WHERE apcfent = g_enterprise AND apcfld = p_ld
               AND apcfdocno=p_apcadocno  
            IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
            #CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf021,g_errno #180306-00040#1 mark
            CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf021,g_errno  #180306-00040#1 add 
            LET l_apcf.apcf102 = l_apca101
            #IF l_sfin3012 = '1' THEN #180306-00040#1 mark 皆以未稅計算
               #那就是apcf113/apcf115和aapt320的金额比对     
               SELECT SUM(apcf113),SUM(apcf123),SUM(apcf133) 
                 INTO l_apcf113,l_apcf123,l_apcf133
                 FROM apcf_t,apca_t
                WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
                  AND apcfent = g_enterprise
                  AND apcfld  = p_ld AND apcfdocno=p_apcadocno
                  AND apca001 = '03'
                  
               SELECT SUM(apcf113)*-1,SUM(apcf123)*-1,SUM(apcf133) *-1
                 INTO l_apcf1131,l_apcf1231,l_apcf1331
                 FROM apcf_t,apca_t
                WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
                  AND apcfent = g_enterprise
                  AND apcfld  = p_ld AND apcfdocno=p_apcadocno
                  AND apca001 = '04'
                     
               SELECT SUM(apcb113*apcb022),SUM(apcb123*apcb022),SUM(apcb133*apcb022)
                 INTO l_apcb113,l_apcb123,l_apcb133
                 FROM apcb_t
                WHERE apcbent = g_enterprise
                  AND apcbld  = p_ld AND apcbdocno=p_apcadocno
                  AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
            #180306-00040#1 --s add
            #ELSE
            #   #那就是apcf113/apcf115和aapt320的金额比对     
            #   SELECT SUM(apcf115),SUM(apcf125),SUM(apcf135) 
            #     INTO l_apcf113,l_apcf123,l_apcf133
            #     FROM apcf_t,apca_t
            #    WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
            #      AND apcfent = g_enterprise
            #      AND apcfld  = p_ld AND apcfdocno=p_apcadocno
            #      AND apca001 = '03'
            #   
            #   SELECT SUM(apcf115)*-1,SUM(apcf125)*-1,SUM(apcf135) *-1
            #     INTO l_apcf1131,l_apcf1231,l_apcf1331
            #     FROM apcf_t,apca_t
            #    WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
            #      AND apcfent = g_enterprise
            #      AND apcfld  = p_ld AND apcfdocno=p_apcadocno
            #      AND apca001 = '04'
            #      
            #   SELECT SUM(apcb115*apcb022),SUM(apcb125*apcb022),SUM(apcb135*apcb022)
            #     INTO l_apcb113,l_apcb123,l_apcb133
            #     FROM apcb_t
            #    WHERE apcbent = g_enterprise
            #      AND apcbld  = p_ld AND apcbdocno=p_apcadocno
            #      AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
            #END IF
            #180306-00040#1 --e add
            IF cl_null(l_apcf113)  THEN LET l_apcf113 = 0 END IF
            IF cl_null(l_apcf123)  THEN LET l_apcf123 = 0 END IF
            IF cl_null(l_apcf133)  THEN LET l_apcf133 = 0 END IF
            IF cl_null(l_apcf1131) THEN LET l_apcf1131= 0 END IF
            IF cl_null(l_apcf1231) THEN LET l_apcf1231= 0 END IF
            IF cl_null(l_apcf1331) THEN LET l_apcf1331= 0 END IF
            IF cl_null(l_apcb113)  THEN LET l_apcb113 = 0 END IF
            IF cl_null(l_apcb123)  THEN LET l_apcb123 = 0 END IF
            IF cl_null(l_apcb133)  THEN LET l_apcb133 = 0 END IF
            LET l_apcf113 = l_apcf113 + l_apcf1131
            LET l_apcf123 = l_apcf123 + l_apcf1231
            LET l_apcf133 = l_apcf133 + l_apcf1331
                              
            LET l_apcf.apcf113 = l_apcb113 - l_apcf113
            LET l_apcf.apcf114 = 0
            LET l_apcf.apcf115 = l_apcf.apcf113          #含稅未稅相同
            LET l_apcf.apcf123 = l_apcb123 - l_apcf123
            LET l_apcf.apcf124 = 0
            LET l_apcf.apcf125 = l_apcf.apcf113
            LET l_apcf.apcf133 = l_apcb133 - l_apcf133
            LET l_apcf.apcf134 = 0
            LET l_apcf.apcf135 = l_apcf.apcf133
            #LET l_apcf.apcf103 = l_apcf.apcf113 #180306-00040#1 mark
            LET l_apcf.apcf103 = 0               #180306-00040#1 add 匯差原幣為0
            LET l_apcf.apcf104 = 0
            #LET l_apcf.apcf105 = l_apcf.apcf115 #180306-00040#1 mark
            LET l_apcf.apcf105 = 0               #180306-00040#1 add 匯差原幣為0
            #160816-00022#4 --s add
            IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
               LET l_apcf.apcf021 = ''
            END IF
            #160816-00022#4 --e add
            #170618-00029#1   By 10044 add----s
            #判斷是否啟用"部門"核算項
            LET l_glad007=''
            SELECT glad007 INTO l_glad007
              FROM glad_t
             WHERE gladent = g_enterprise
               AND gladld  = p_ld
               AND glad001 = l_apcf.apcf021 
            
            IF l_glad007='Y' THEN
               LET l_apcf.apcf026 = l_apca015
            ELSE
               LET l_apcf.apcf026 = ''
            END IF
            #170618-00029#1   By 10044 add----e
            IF NOT l_apcf.apcf115 = 0  THEN
               
               #161102-00015#7 --s add
               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十      
               #161102-00015#7 --e add    
               LET l_apcf.apcf002 = 'D2'  #170317-00029#3 add 匯差類型D2               
              #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 
               #161111-00048#2 --s add
               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                      l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
               #161111-00048#2 --e add
            END IF
            #產生雜項沖暫估150203---(E)
      WHEN '3'
         #產生雜項沖暫估150203---(S)
         LET l_cnt = 0 
         #SELECT count(*) INTO l_cnt         #161114-00009#1 mark
         SELECT count(apcbdocno) INTO l_cnt  #161114-00009#1 add
           FROM apcb_t
          WHERE apcbent = g_enterprise
            AND apcbld = p_ld AND apcbdocno = p_apcadocno
            AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
         IF l_cnt = 0 THEN RETURN END IF
         #CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf021,g_errno #180306-00040#1 mark
         CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf021,g_errno  #180306-00040#1 add
         LET l_apcf.apcf102 = l_apca101
         
         #161114-00009#1 --s add
         #迴圈內SELECT外搬PREPARE
         LET l_sql = " SELECT MAX(apcfseq)+1 ",
                     "   FROM apcf_t WHERE apcfent = ",g_enterprise," AND apcfld = ? AND apcfdocno = ? "
         PREPARE s_aapp131_apcfseqp FROM l_sql     

         LET l_sql = " SELECT SUM(apcf113),SUM(apcf123),SUM(apcf133) ",
                     "   FROM apcf_t,apca_t ",
                     "  WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 ",
                     "    AND apcfent = ",g_enterprise," ",
                     "    AND apcfld  = ? AND apcfdocno = ? ",
                     "    AND apca001 = '03' AND apcforga = ? "
         PREPARE s_aapp131_apcf113p FROM l_sql  
         
         LET l_sql = " SELECT SUM(apcf113)*-1,SUM(apcf123)*-1,SUM(apcf133) *-1 ",
                     "   FROM apcf_t,apca_t ",
                     "  WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008  ",
                     "    AND apcfent = ",g_enterprise," ",
                     "    AND apcfld  = ? AND apcfdocno = ? ",
                     "    AND apca001 = '04' AND apcforga = ? "
         PREPARE s_aapp131_apcf1131p FROM l_sql    

         LET l_sql = " SELECT SUM(apcb113*apcb022),SUM(apcb123*apcb022),SUM(apcb133*apcb022) ",
                     "   FROM apcb_t ",
                     "  WHERE apcbent = ",g_enterprise,"  ",
                     "    AND apcbld  = ? AND apcbdocno = ? ",
                     "    AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26') ",
                     "    AND apcborga = ? "
         PREPARE s_aapp131_apcb113p FROM l_sql
         
         #180306-00040#1 --s mark
         #LET l_sql = " SELECT SUM(apcf115),SUM(apcf125),SUM(apcf135) ",
         #            "   FROM apcf_t,apca_t ",
         #            "  WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008  ",
         #            "    AND apcfent = ",g_enterprise," ",
         #            "    AND apcfld  = ? AND apcfdocno=? ",
         #            "    AND apca001 = '03' AND apcforga =? "
         #PREPARE s_aapp131_apcf113p1 FROM l_sql
         #      
         #LET l_sql = " SELECT SUM(apcf115)*-1,SUM(apcf125)*-1,SUM(apcf135) *-1 ",
         #            "   FROM apcf_t,apca_t ",
         #            "  WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008  ",
         #            "    AND apcfent = ",g_enterprise," ",
         #            "    AND apcfld = ? AND apcfdocno = ? ",
         #            "    AND apca001 = '04' AND apcforga = ? "
         #PREPARE s_aapp131_apcf1131p1 FROM l_sql      
         #
         #LET l_sql = " SELECT SUM(apcb115*apcb022),SUM(apcb125*apcb022),SUM(apcb135*apcb022) ",
         #            "   FROM apcb_t ",
         #            "  WHERE apcbent = ",g_enterprise," ",
         #            "    AND apcbld  = ? AND apcbdocno = ? ",
         #            "    AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26') ",
         #            "    AND apcforga = ? "
         #PREPARE s_aapp131_apcb113p1 FROM l_sql
         #180306-00040#1 --e mark
         #161114-00009#1 --e add
         
         LET l_sql = " SELECT DISTINCT apcborga FROM apcb_t",
                     "  WHERE apcbent = ",g_enterprise,
                     "    AND apcbld = '",p_ld,"' AND apcbdocno = '",p_apcadocno,"' AND apcb023 = 'Y' "
         PREPARE s_aapp130_ins_apcf_diff_p1 FROM l_sql
         DECLARE s_aapp130_ins_apcf_diff_c1 CURSOR FOR s_aapp130_ins_apcf_diff_p1
         FOREACH s_aapp130_ins_apcf_diff_c1 INTO l_apcborga
            
            EXECUTE s_aapp131_apcfseqp USING p_ld,p_apcadocno INTO l_apcf.apcfseq  #161114-00009#1 add

            #161114-00009#1 --s mark
            #SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
            #  FROM apcf_t
            # WHERE apcfent = g_enterprise AND apcfld = p_ld
            #   AND apcfdocno=p_apcadocno  
            #161114-00009#1 --e mark
            IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
            #IF l_sfin3012 = '1' THEN #180306-00040#1 mark
               #那就是apcf113/apcf115和aapt320的金额比对     
               #161114-00009#1 --s add
               LET l_apcf113 = 0
               LET l_apcf123 = 0
               LET l_apcf133 = 0
               EXECUTE s_aapp131_apcf113p USING p_ld,p_apcadocno,l_apcborga 
                  INTO l_apcf113,l_apcf123,l_apcf133  
   
               LET l_apcf1131 = 0
               LET l_apcf1231 = 0
               LET l_apcf1331 = 0
               EXECUTE s_aapp131_apcf1131p USING p_ld,p_apcadocno,l_apcborga 
                  INTO l_apcf1131,l_apcf1231,l_apcf1331
                    
               LET l_apcb113 = 0
               LET l_apcb123 = 0
               LET l_apcb133 = 0
               EXECUTE s_aapp131_apcb113p USING p_ld,p_apcadocno,l_apcborga 
                  INTO l_apcb113,l_apcb123,l_apcb133
               #161114-00009#1 --e add   
               
               #161114-00009#1 --s mark
               #SELECT SUM(apcf113),SUM(apcf123),SUM(apcf133) 
               #  INTO l_apcf113,l_apcf123,l_apcf133
               #  FROM apcf_t,apca_t
               # WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
               #   AND apcfent = g_enterprise
               #   AND apcfld  = p_ld AND apcfdocno=p_apcadocno
               #   AND apca001 = '03' AND apcforga =l_apcborga
               #   
               #SELECT SUM(apcf113)*-1,SUM(apcf123)*-1,SUM(apcf133) *-1
               #  INTO l_apcf1131,l_apcf1231,l_apcf1331
               #  FROM apcf_t,apca_t
               # WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
               #   AND apcfent = g_enterprise
               #   AND apcfld  = p_ld AND apcfdocno=p_apcadocno
               #   AND apca001 = '04' AND apcforga =l_apcborga
               #      
               #SELECT SUM(apcb113*apcb022),SUM(apcb123*apcb022),SUM(apcb133*apcb022)
               #  INTO l_apcb113,l_apcb123,l_apcb133
               #  FROM apcb_t
               # WHERE apcbent = g_enterprise
               #   AND apcbld  = p_ld AND apcbdocno=p_apcadocno
               #   AND apcb023 = 'Y'  AND apcb001 IN ('19','29','16','26')
               #   AND apcborga =l_apcborga               
               #161114-00009#1 --e mark
            #180306-00040#1 --s mark 皆以未稅計算
            #ELSE
            #   #那就是apcf113/apcf115和aapt320的金额比对  
            #   #161114-00009#1 --s add
            #   LET l_apcf113 = 0
            #   LET l_apcf123 = 0
            #   LET l_apcf133 = 0
            #   EXECUTE s_aapp131_apcf113p1 USING p_ld,p_apcadocno,l_apcborga 
            #      INTO l_apcf113,l_apcf123,l_apcf133  
            #
            #   LET l_apcf1131 = 0
            #   LET l_apcf1231 = 0
            #   LET l_apcf1331 = 0
            #   EXECUTE s_aapp131_apcf1131p1 USING p_ld,p_apcadocno,l_apcborga 
            #      INTO l_apcf1131,l_apcf1231,l_apcf1331
            #        
            #   LET l_apcb113 = 0
            #   LET l_apcb123 = 0
            #   LET l_apcb133 = 0
            #   EXECUTE s_aapp131_apcb113p1 USING p_ld,p_apcadocno,l_apcborga 
            #      INTO l_apcb113,l_apcb123,l_apcb133
            #   #161114-00009#1 --e add 
            #180306-00040#1 --e mark
               #161114-00009#1 --s mark
               #SELECT SUM(apcf115),SUM(apcf125),SUM(apcf135) 
               #  INTO l_apcf113,l_apcf123,l_apcf133
               #  FROM apcf_t,apca_t
               # WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
               #   AND apcfent = g_enterprise
               #   AND apcfld  = p_ld AND apcfdocno=p_apcadocno
               #   AND apca001 = '03' AND apcforga =l_apcborga
               #
               #SELECT SUM(apcf115)*-1,SUM(apcf125)*-1,SUM(apcf135) *-1
               #  INTO l_apcf1131,l_apcf1231,l_apcf1331
               #  FROM apcf_t,apca_t
               # WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
               #   AND apcfent = g_enterprise
               #   AND apcfld  = p_ld AND apcfdocno=p_apcadocno
               #   AND apca001 = '04' AND apcforga =l_apcborga
               #   
               #SELECT SUM(apcb115*apcb022),SUM(apcb125*apcb022),SUM(apcb135*apcb022)
               #  INTO l_apcb113,l_apcb123,l_apcb133
               #  FROM apcb_t
               # WHERE apcbent = g_enterprise
               #   AND apcbld  = p_ld AND apcbdocno=p_apcadocno
               #   AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
               #   AND apcforga =l_apcborga
               #161114-00009#1 --e mark
            #END IF #180306-00040#1 mark
            IF cl_null(l_apcf113)  THEN LET l_apcf113 = 0 END IF
            IF cl_null(l_apcf123)  THEN LET l_apcf123 = 0 END IF
            IF cl_null(l_apcf133)  THEN LET l_apcf133 = 0 END IF
            IF cl_null(l_apcf1131) THEN LET l_apcf1131= 0 END IF
            IF cl_null(l_apcf1231) THEN LET l_apcf1231= 0 END IF
            IF cl_null(l_apcf1331) THEN LET l_apcf1331= 0 END IF
            IF cl_null(l_apcb113)  THEN LET l_apcb113 = 0 END IF
            IF cl_null(l_apcb123)  THEN LET l_apcb123 = 0 END IF
            IF cl_null(l_apcb133)  THEN LET l_apcb133 = 0 END IF
            LET l_apcf113 = l_apcf113 + l_apcf1131
            LET l_apcf123 = l_apcf123 + l_apcf1231
            LET l_apcf133 = l_apcf133 + l_apcf1331
                              
            LET l_apcf.apcf113 = l_apcb113 - l_apcf113
            LET l_apcf.apcf114 = 0
            LET l_apcf.apcf115 = l_apcf.apcf113          #含稅未稅相同
            LET l_apcf.apcf123 = l_apcb123 - l_apcf123
            LET l_apcf.apcf124 = 0
            LET l_apcf.apcf125 = l_apcf.apcf113
            LET l_apcf.apcf133 = l_apcb133 - l_apcf133
            LET l_apcf.apcf134 = 0
            LET l_apcf.apcf135 = l_apcf.apcf133
            #LET l_apcf.apcf103 = l_apcf.apcf113 #180306-00040#1 mark
            LET l_apcf.apcf103 = 0               #180306-00040#1 add 匯差原幣為0
            LET l_apcf.apcf104 = 0
            #LET l_apcf.apcf105 = l_apcf.apcf115 #180306-00040#1 mark
            LET l_apcf.apcf105 = 0               #180306-00040#1 add 匯差原幣為0
            #160816-00022#4 --s add
            IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
               LET l_apcf.apcf021 = ''
            END IF
            #160816-00022#4 --e add
            #170618-00029#1   By 10044 add----s
            #判斷是否啟用"部門"核算項
            LET l_glad007=''
            SELECT glad007 INTO l_glad007
              FROM glad_t
             WHERE gladent = g_enterprise
               AND gladld  = p_ld
               AND glad001 = l_apcf.apcf021 
            
            IF l_glad007='Y' THEN
               LET l_apcf.apcf026 = l_apca015
            ELSE
               LET l_apcf.apcf026 = ''
            END IF
            #170618-00029#1   By 10044 add----e
            IF NOT l_apcf.apcf115 = 0  THEN
               #161102-00015#7 --s add
               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十      
               #161102-00015#7 --e add          
               LET l_apcf.apcf002 = 'D2'  #170317-00029#3 add 匯差類型D2
              #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
               #161111-00048#2 --s add
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 
               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                      l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
               #161111-00048#2 --e add
            END IF
            END FOREACH
            #產生雜項沖暫估150203---(E)
            
      #180403-00026#1 --s add
      WHEN '4'
             LET l_amt_apcf113 = 0
             LET l_amt_apcf114 = 0
             LET l_amt_apcf115 = 0
             LET l_amt_apcf123 = 0
             LET l_amt_apcf124 = 0
             LET l_amt_apcf125 = 0
             LET l_amt_apcf133 = 0
             LET l_amt_apcf134 = 0
             LET l_amt_apcf135 = 0
            #產生價差數據 --s
            LET l_apcf101 = 0
            LET l_apcf111 = 0
            CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf021,g_errno
            LET l_apcf.apcf102 = l_apca101
            SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
              FROM apcf_t
             WHERE apcfent = g_enterprise AND apcfld = p_ld
              AND apcfdocno=p_apcadocno  
            IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
            FOR l_i = 1 TO p_apcf_tmp.getLength()
               LET l_apcf.apcforga= p_apcf_tmp[l_i].apcborga
               LET l_apcf101 = p_apcf_tmp[l_i].apcf106
               LET l_apcf111 = p_apcf_tmp[l_i].apcf116
               IF cl_null(l_apcf101) THEN LET l_apcf101 = 0 END IF
               IF cl_null(l_apcf111) THEN LET l_apcf111 = 0 END IF
               IF p_apcf_tmp[l_i].apca001 MATCHES '0[24]' THEN
                  LET l_apcf101 = l_apcf101 * -1
                  LET l_apcf111 = l_apcf111 * -1
               END IF
               LET l_apcf.apcf101 = l_apcf.apcf101 + l_apcf101
               LET l_apcf.apcf111 = l_apcf.apcf111 + l_apcf111
            END FOR
            LET l_apcf.apcf103 = l_apcf.apcf007 * l_apcf.apcf101
            LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111           
            CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf.apcf103,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103  
            LET l_apcf.apcf105 = l_apcf.apcf103
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113 
            LET l_apcf.apcf115 = l_apcf.apcf113

            IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
               LET l_apcf.apcf021 = ''
            END IF

            #判斷是否啟用"部門"核算項
            LET l_glad007=''
            SELECT glad007 INTO l_glad007
              FROM glad_t
             WHERE gladent = g_enterprise
               AND gladld  = p_ld
               AND glad001 = l_apcf.apcf021 
            
            IF l_glad007='Y' THEN
               LET l_apcf.apcf026 = l_apca015
            ELSE
               LET l_apcf.apcf026 = ''
            END IF

            LET l_apcf.apcf002 = 'D1' 
            
            IF NOT (l_apcf.apcf103 = 0 AND l_apcf.apcf113 = 0) THEN
               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十      
               
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 
               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                      l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
            END IF
            #產生價差數據 --e
            
            ###匯差合併顯示: #######################################            
            #產生匯差數據 --s
            LET l_apcf.apcf101 = 0      
            LET l_apcf.apcf102 = l_apca101 
            LET l_apcf.apcf103 = 0
            LET l_apcf.apcf104 = 0
            LET l_apcf.apcf105 = 0
            LET l_apcf.apcf106 = 0
            LET l_apcf.apcf111 = 0
            LET l_apcf.apcf113 = 0
            LET l_apcf.apcf115 = 0
            LET l_apcf.apcf116 = 0
            CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf021,g_errno
            SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
              FROM apcf_t
             WHERE apcfent = g_enterprise AND apcfld = p_ld
               AND apcfdocno=p_apcadocno  
            IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
            FOR l_i = 1 TO p_apcf_tmp.getLength()
               LET l_apcf.apcforga= p_apcf_tmp[l_i].apcborga
               IF NOT cl_null(p_apcf_tmp[l_i].apcf117) AND p_apcf_tmp[l_i].apcf117 <> 0 THEN
                  IF p_apcf_tmp[l_i].apca001 MATCHES '0[24]' THEN
                     LET p_apcf_tmp[l_i].apcf117 = p_apcf_tmp[l_i].apcf117 * -1
                     LET p_apcf_tmp[l_i].apcf107 = p_apcf_tmp[l_i].apcf107 * -1
                  END IF
                  LET l_apcf.apcf111 = l_apcf.apcf111 + p_apcf_tmp[l_i].apcf117
                END IF
            END FOR
            LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113 
            LET l_apcf.apcf115 = l_apcf.apcf113

            IF l_apcf.apcf111 <> 0 THEN
               #匯差僅本幣金額,原幣金額給0
               LET l_amt_apcf113 = l_apcf.apcf113
               LET l_amt_apcf114 = 0
               LET l_amt_apcf115 = l_apcf.apcf115          #含稅未稅相同
               LET l_amt_apcf123 = 0
               LET l_amt_apcf124 = 0
               LET l_amt_apcf125 = 0
               LET l_amt_apcf133 = 0
               LET l_amt_apcf134 = 0
               LET l_amt_apcf135 = 0   
#181128-00084#1 --begin
               LET l_glad007=''
               SELECT glad007 INTO l_glad007
                 FROM glad_t
                WHERE gladent = g_enterprise
                  AND gladld  = p_ld
                  AND glad001 = l_apcf.apcf021 
               
               IF l_glad007='Y' THEN
                  LET l_apcf.apcf026 = l_apca015
               ELSE
                  LET l_apcf.apcf026 = ''
               END IF

               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十                
               
               LET l_apcf.apcf002 = 'D2'  #170317-00029#3 add 匯差類型D2               
               
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 

               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                      l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
#181128-00084#1 --end
            END IF
            #產生匯差數據 --e

            #產生雜項沖暫估 --s
            LET l_cnt = 0 
            SELECT count(apcbdocno) INTO l_cnt 
              FROM apcb_t
             WHERE apcbent = g_enterprise
               AND apcbld = p_ld AND apcbdocno = p_apcadocno
               AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
            IF (l_cnt = 0) AND (l_amt_apcf115 = 0) THEN RETURN END IF #皆無匯差金額

            LET l_apcf.apcf102 = l_apca101
               #那就是apcf113/apcf115和aapt320的金额比对     
               SELECT SUM(apcf113),SUM(apcf123),SUM(apcf133) 
                 INTO l_apcf113,l_apcf123,l_apcf133
                 FROM apcf_t,apca_t
                WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
                  AND apcfent = g_enterprise
                  AND apcfld  = p_ld AND apcfdocno=p_apcadocno
                  AND apca001 = '03'
                  
               SELECT SUM(apcf113)*-1,SUM(apcf123)*-1,SUM(apcf133) *-1
                 INTO l_apcf1131,l_apcf1231,l_apcf1331
                 FROM apcf_t,apca_t
                WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
                  AND apcfent = g_enterprise
                  AND apcfld  = p_ld AND apcfdocno=p_apcadocno
                  AND apca001 = '04'
                     
               SELECT SUM(apcb113*apcb022),SUM(apcb123*apcb022),SUM(apcb133*apcb022)
                 INTO l_apcb113,l_apcb123,l_apcb133
                 FROM apcb_t
                WHERE apcbent = g_enterprise
                  AND apcbld  = p_ld AND apcbdocno=p_apcadocno
                  AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
            IF cl_null(l_apcf113)  THEN LET l_apcf113 = 0 END IF
            IF cl_null(l_apcf123)  THEN LET l_apcf123 = 0 END IF
            IF cl_null(l_apcf133)  THEN LET l_apcf133 = 0 END IF
            IF cl_null(l_apcf1131) THEN LET l_apcf1131= 0 END IF
            IF cl_null(l_apcf1231) THEN LET l_apcf1231= 0 END IF
            IF cl_null(l_apcf1331) THEN LET l_apcf1331= 0 END IF
            IF cl_null(l_apcb113)  THEN LET l_apcb113 = 0 END IF
            IF cl_null(l_apcb123)  THEN LET l_apcb123 = 0 END IF
            IF cl_null(l_apcb133)  THEN LET l_apcb133 = 0 END IF
            LET l_apcf113 = l_apcf113 + l_apcf1131
            LET l_apcf123 = l_apcf123 + l_apcf1231
            LET l_apcf133 = l_apcf133 + l_apcf1331
                              
            LET l_apcf.apcf113 = l_apcb113 - l_apcf113
            LET l_apcf.apcf114 = 0
            LET l_apcf.apcf115 = l_apcf.apcf113          #含稅未稅相同
            LET l_apcf.apcf123 = l_apcb123 - l_apcf123
            LET l_apcf.apcf124 = 0
            LET l_apcf.apcf125 = l_apcf.apcf113
            LET l_apcf.apcf133 = l_apcb133 - l_apcf133
            LET l_apcf.apcf134 = 0
            LET l_apcf.apcf135 = l_apcf.apcf133
            IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
               LET l_apcf.apcf021 = ''
            END IF
            #判斷是否啟用"部門"核算項
            LET l_glad007=''
            SELECT glad007 INTO l_glad007
              FROM glad_t
             WHERE gladent = g_enterprise
               AND gladld  = p_ld
               AND glad001 = l_apcf.apcf021 
            
            IF l_glad007='Y' THEN
               LET l_apcf.apcf026 = l_apca015
            ELSE
               LET l_apcf.apcf026 = ''
            END IF
            IF NOT l_apcf.apcf115 = 0  THEN
               #合併有來源單之匯差金額
               LET l_amt_apcf113 = l_amt_apcf113 + l_apcf.apcf113
               LET l_amt_apcf114 = l_amt_apcf114 + l_apcf.apcf114
               LET l_amt_apcf115 = l_amt_apcf115 + l_apcf.apcf115
               LET l_amt_apcf123 = l_amt_apcf123 + l_apcf.apcf123
               LET l_amt_apcf124 = l_amt_apcf124 + l_apcf.apcf124
               LET l_amt_apcf125 = l_amt_apcf125 + l_apcf.apcf125
               LET l_amt_apcf133 = l_amt_apcf133 + l_apcf.apcf133
               LET l_amt_apcf134 = l_amt_apcf134 + l_apcf.apcf134
               LET l_amt_apcf135 = l_amt_apcf135 + l_apcf.apcf135
            
               IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
               IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
               IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
               IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
               IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
               IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
               IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
               IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
               IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
               IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
               IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
               IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
               IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
               IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
               IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
               IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
               IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
               IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
               IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
               IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
               IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
               IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
               IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十      
               LET l_apcf.apcf002 = 'D2' 
               
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
               IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
               IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
               IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
               IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
               IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
               IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
               IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
               IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
               IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
               IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
               IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
               IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
               IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
               IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
               IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
               IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
               IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
               IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
               IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
               IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
               IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
               IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
               #180130-00050#5---add by 10554---(E) 
               INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                                  apcfseq2,apcf001,apcf002,apcf007,apcf008,
                                  apcf009,apcf010,apcf020,apcf021,apcf022,
                                  apcf023,apcf024,apcf025,apcf026,apcf027,
                                  apcf028,apcf029,apcf030,apcf031,apcf032,
                                  apcf033,apcf034,apcf035,apcf036,apcf037,
                                  apcf038,apcf039,apcf040,apcf041,apcf042,
                                  apcf043,apcf044,apcf045,apcf046,apcf047,
                                  apcf048,apcf049,apcf101,apcf102,apcf103,
                                  apcf104,apcf105,apcf106,apcf111,apcf113,
                                  apcf114,apcf115,apcf116,apcf117,apcf122,
                                  apcf123,apcf124,apcf125,apcf126,apcf127,
                                  apcf132,apcf133,apcf134,apcf135,apcf136,
                                  apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                                  apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                                  apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                                  apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                                  apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                                  apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                                  apcfud030)
               VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                      l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                      l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                      l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                      l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                      l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                      l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                      l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                      l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                      l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_amt_apcf113,
                      l_amt_apcf114,l_amt_apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                      l_amt_apcf123,l_amt_apcf124,l_amt_apcf125,l_apcf.apcf126,l_apcf.apcf127,
                      l_apcf.apcf132,l_amt_apcf133,l_amt_apcf134,l_amt_apcf135,l_apcf.apcf136,
                      l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                      l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                      l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                      l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                      l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                      l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                      l_apcf.apcfud030)
            END IF
            #產生雜項沖暫估 --e         
      #180403-00026#1 --e add
   END CASE   

END FUNCTION

################################################################################
# Descriptions...: 刪除apcf
# Memo...........:
# Usage..........: 
# Date & Author..: 15/02/03 By Belle
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_del_apcf(p_ld,p_docno)
DEFINE p_ld          LIKE apcb_t.apcbld
DEFINE p_docno       LIKE apcb_t.apcbdocno
DEFINE l_cnt         LIKE type_t.num5

   WHENEVER ERROR CONTINUE
   
   #暫估
   #SELECT count(*) INTO l_cnt        #161114-00009#1 mark
   SELECT count(apcfdocno) INTO l_cnt #161114-00009#1 add
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno = p_docno
   IF l_cnt > 0 THEN   
      #170317-00029#3 --s add
      SELECT COUNT(apchdocno) INTO l_cnt 
        FROM apch_t
       WHERE apchent = g_enterprise AND apchdocno = p_docno      
      IF l_cnt > 0 THEN
         DELETE FROM apch_t
          WHERE apchent = g_enterprise AND apchdocno = p_docno         
      END IF
      #170317-00029#3 --e add   
   
      DELETE FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
         AND apcfdocno = p_docno
   END IF
   
END FUNCTION
################################################################################
# Descriptions...: 待抵沖銷
# Memo...........:
# Usage..........: CALL s_aapp131_ins_apce(p_ld,p_docno,p_wc,p_sfin2002,p_type)
# Input parameter: p_ld           帳別
#                : p_docno        立帳單據
#                : p_wc           條件範圍
#                : p_sfin2002     沖銷參數(S-FIN-2002)
#                : p_type         1.訂單待抵優先 2.帳款對象+付款對象 3.帳款對象
# Date & Author..: 14/11/24 By apo
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apce(p_ld,p_docno,p_wc,p_sfin2002,p_type)
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_docno       LIKE apcb_t.apcbdocno   #立帳單據
DEFINE p_apca004     LIKE apca_t.apca004     #交易對象
DEFINE p_apca005     LIKE apca_t.apca004     #付款對象
DEFINE p_wc          STRING
DEFINE p_sfin2002    LIKE type_t.chr1        #沖銷參數(S-FIN-2002)
DEFINE p_type        LIKE type_t.chr1        #1.訂單待抵優先 2.帳款對象+付款對象 3.帳款對象
DEFINE l_apcacomp    LIKE apca_t.apcacomp
DEFINE l_apcadocdt   LIKE apca_t.apcadocdt
DEFINE l_apca0041    LIKE apca_t.apca004
DEFINE l_apca0051    LIKE apca_t.apca005
DEFINE l_apca1001    LIKE apca_t.apca100
DEFINE l_apcc109sum  LIKE apcc_t.apcc109     #立帳付款金額(合計
DEFINE l_apce109sum  LIKE apce_t.apce109     #沖帳金額    (合計
DEFINE l_apce109     LIKE apce_t.apce109     #可沖帳金額
DEFINE l_glaa017     LIKE glaa_t.glaa017     #本位幣二 換算基準
DEFINE l_glaa021     LIKE glaa_t.glaa021     #本位幣三 換算基準
DEFINE l_apca001     LIKE apca_t.apca001
DEFINE l_apca014     LIKE apca_t.apca014
DEFINE l_apca015     LIKE apca_t.apca015
DEFINE l_apca033     LIKE apca_t.apca033
DEFINE l_apca034     LIKE apca_t.apca034
DEFINE l_apca035     LIKE apca_t.apca035
DEFINE l_apca059     LIKE apca_t.apca059
DEFINE l_apcccomp    LIKE apcc_t.apcccomp
DEFINE l_apccsite    LIKE apcc_t.apccsite
DEFINE l_apccdocno   LIKE apcc_t.apccdocno
DEFINE l_apccseq     LIKE apcc_t.apccseq
DEFINE l_apcc001     LIKE apcc_t.apcc001
DEFINE l_apcc100     LIKE apcc_t.apcc100
DEFINE l_apcc121     LIKE apcc_t.apcc121
DEFINE l_apcc131     LIKE apcc_t.apcc131
DEFINE l_apcc101     LIKE apcc_t.apcc101
DEFINE l_apcc102     LIKE apcc_t.apcc102
DEFINE l_apcc108     LIKE apcc_t.apcc108
DEFINE l_apcc118     LIKE apcc_t.apcc118
DEFINE l_apcc128     LIKE apcc_t.apcc128
DEFINE l_apcc138     LIKE apcc_t.apcc138
DEFINE l_apcc109     LIKE apcc_t.apcc109
DEFINE l_apcc119     LIKE apcc_t.apcc119
DEFINE l_apcc129     LIKE apcc_t.apcc129
DEFINE l_apcc139     LIKE apcc_t.apcc139
#DEFINE l_apce        RECORD LIKE apce_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apce RECORD  #應付沖帳明細
       apceent LIKE apce_t.apceent, #企業編號
       apcecomp LIKE apce_t.apcecomp, #法人
       apcelegl LIKE apce_t.apcelegl, #核算組織
       apcesite LIKE apce_t.apcesite, #帳務組織
       apceld LIKE apce_t.apceld, #帳套
       apceorga LIKE apce_t.apceorga, #帳務歸屬組織
       apcedocno LIKE apce_t.apcedocno, #沖銷單單號
       apceseq LIKE apce_t.apceseq, #項次
       apce001 LIKE apce_t.apce001, #來源作業
       apce002 LIKE apce_t.apce002, #沖銷類型
       apce003 LIKE apce_t.apce003, #沖銷帳款單單號
       apce004 LIKE apce_t.apce004, #沖銷帳款單項次
       apce005 LIKE apce_t.apce005, #分期帳款序
       apce006 LIKE apce_t.apce006, #no use
       apce007 LIKE apce_t.apce007, #no use
       apce008 LIKE apce_t.apce008, #票據號碼/ 現金銀存帳戶
       apce009 LIKE apce_t.apce009, #no use
       apce010 LIKE apce_t.apce010, #摘要說明
       apce011 LIKE apce_t.apce011, #理由碼
       apce012 LIKE apce_t.apce012, #銀存存提碼
       apce013 LIKE apce_t.apce013, #現金異動碼
       apce014 LIKE apce_t.apce014, #no use
       apce015 LIKE apce_t.apce015, #沖銷加減項
       apce016 LIKE apce_t.apce016, #沖銷科目
       apce017 LIKE apce_t.apce017, #業務人員
       apce018 LIKE apce_t.apce018, #業務部門
       apce019 LIKE apce_t.apce019, #責任中心
       apce020 LIKE apce_t.apce020, #產品類別
       apce021 LIKE apce_t.apce021, #no use
       apce022 LIKE apce_t.apce022, #專案編號
       apce023 LIKE apce_t.apce023, #WBS編號
       apce024 LIKE apce_t.apce024, #第二參考單號
       apce025 LIKE apce_t.apce025, #第二參考單號項次
       apce026 LIKE apce_t.apce026, #no use
       apce027 LIKE apce_t.apce027, #應稅折抵否
       apce028 LIKE apce_t.apce028, #產生方式
       apce029 LIKE apce_t.apce029, #傳票號碼
       apce030 LIKE apce_t.apce030, #傳票項次
       apce031 LIKE apce_t.apce031, #付款(票)到期日
       apce032 LIKE apce_t.apce032, #應付款日
       apce033 LIKE apce_t.apce033, #no use
       apce034 LIKE apce_t.apce034, #no use
       apce035 LIKE apce_t.apce035, #區域
       apce036 LIKE apce_t.apce036, #客戶分類
       apce037 LIKE apce_t.apce037, #no use
       apce038 LIKE apce_t.apce038, #帳款對象
       apce039 LIKE apce_t.apce039, #no use
       apce040 LIKE apce_t.apce040, #no use
       apce041 LIKE apce_t.apce041, #no use
       apce042 LIKE apce_t.apce042, #no use
       apce043 LIKE apce_t.apce043, #no use
       apce044 LIKE apce_t.apce044, #經營方式
       apce045 LIKE apce_t.apce045, #通路
       apce046 LIKE apce_t.apce046, #品牌
       apce047 LIKE apce_t.apce047, #發票編號
       apce048 LIKE apce_t.apce048, #發票號碼
       apce049 LIKE apce_t.apce049, #付款申請單號碼
       apce050 LIKE apce_t.apce050, #付款申請單項次
       apce051 LIKE apce_t.apce051, #自由核算項一
       apce052 LIKE apce_t.apce052, #自由核算項二
       apce053 LIKE apce_t.apce053, #自由核算項三
       apce054 LIKE apce_t.apce054, #自由核算項四
       apce055 LIKE apce_t.apce055, #自由核算項五
       apce056 LIKE apce_t.apce056, #自由核算項六
       apce057 LIKE apce_t.apce057, #自由核算項七
       apce058 LIKE apce_t.apce058, #自由核算項八
       apce059 LIKE apce_t.apce059, #自由核算項九
       apce060 LIKE apce_t.apce060, #自由核算項十
       apce100 LIKE apce_t.apce100, #幣別
       apce101 LIKE apce_t.apce101, #匯率
       apce104 LIKE apce_t.apce104, #原幣應稅折抵稅額
       apce109 LIKE apce_t.apce109, #原幣沖帳金額
       apce114 LIKE apce_t.apce114, #本幣應稅折抵稅額
       apce119 LIKE apce_t.apce119, #本幣沖帳金額
       apce120 LIKE apce_t.apce120, #本位幣二幣別
       apce124 LIKE apce_t.apce124, #本位幣二應稅折抵稅額
       apce121 LIKE apce_t.apce121, #本位幣二匯率
       apce129 LIKE apce_t.apce129, #本位幣二沖帳金額
       apce130 LIKE apce_t.apce130, #本位幣三幣別
       apce131 LIKE apce_t.apce131, #本位幣三匯率
       apce134 LIKE apce_t.apce134, #本位幣三應稅折抵稅額
       apce139 LIKE apce_t.apce139, #本位幣三沖帳金額
       apceud001 LIKE apce_t.apceud001, #自定義欄位(文字)001
       apceud002 LIKE apce_t.apceud002, #自定義欄位(文字)002
       apceud003 LIKE apce_t.apceud003, #自定義欄位(文字)003
       apceud004 LIKE apce_t.apceud004, #自定義欄位(文字)004
       apceud005 LIKE apce_t.apceud005, #自定義欄位(文字)005
       apceud006 LIKE apce_t.apceud006, #自定義欄位(文字)006
       apceud007 LIKE apce_t.apceud007, #自定義欄位(文字)007
       apceud008 LIKE apce_t.apceud008, #自定義欄位(文字)008
       apceud009 LIKE apce_t.apceud009, #自定義欄位(文字)009
       apceud010 LIKE apce_t.apceud010, #自定義欄位(文字)010
       apceud011 LIKE apce_t.apceud011, #自定義欄位(數字)011
       apceud012 LIKE apce_t.apceud012, #自定義欄位(數字)012
       apceud013 LIKE apce_t.apceud013, #自定義欄位(數字)013
       apceud014 LIKE apce_t.apceud014, #自定義欄位(數字)014
       apceud015 LIKE apce_t.apceud015, #自定義欄位(數字)015
       apceud016 LIKE apce_t.apceud016, #自定義欄位(數字)016
       apceud017 LIKE apce_t.apceud017, #自定義欄位(數字)017
       apceud018 LIKE apce_t.apceud018, #自定義欄位(數字)018
       apceud019 LIKE apce_t.apceud019, #自定義欄位(數字)019
       apceud020 LIKE apce_t.apceud020, #自定義欄位(數字)020
       apceud021 LIKE apce_t.apceud021, #自定義欄位(日期時間)021
       apceud022 LIKE apce_t.apceud022, #自定義欄位(日期時間)022
       apceud023 LIKE apce_t.apceud023, #自定義欄位(日期時間)023
       apceud024 LIKE apce_t.apceud024, #自定義欄位(日期時間)024
       apceud025 LIKE apce_t.apceud025, #自定義欄位(日期時間)025
       apceud026 LIKE apce_t.apceud026, #自定義欄位(日期時間)026
       apceud027 LIKE apce_t.apceud027, #自定義欄位(日期時間)027
       apceud028 LIKE apce_t.apceud028, #自定義欄位(日期時間)028
       apceud029 LIKE apce_t.apceud029, #自定義欄位(日期時間)029
       apceud030 LIKE apce_t.apceud030, #自定義欄位(日期時間)030
       apce103 LIKE apce_t.apce103, #原幣未稅沖銷額
       apce113 LIKE apce_t.apce113, #本位未稅沖銷額
       apce123 LIKE apce_t.apce123, #本位幣二未稅沖銷額
       apce133 LIKE apce_t.apce133, #本位幣三未稅沖銷額
       apce061 LIKE apce_t.apce061  #付款對象
END RECORD
#161111-00048#2 --e add
DEFINE l_sql         STRING
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_apcbseq     LIKE apcb_t.apcbseq
DEFINE l_apcb008     LIKE apcb_t.apcb008
DEFINE l_str         STRING
DEFINE l_glaa001     LIKE glaa_t.glaa001  #140806-00012#12
DEFINE l_glaa016     LIKE glaa_t.glaa016  #140806-00012#12
DEFINE l_glaa020     LIKE glaa_t.glaa020  #140806-00012#12
#150316apo--(s)
DEFINE  l_apcc_left  RECORD
                     apce109    LIKE type_t.num20_6,
                     apce119    LIKE type_t.num20_6,
                     apce129    LIKE type_t.num20_6,
                     apce139    LIKE type_t.num20_6
                     END RECORD
#150316apo--(e)
DEFINE l_sfin3020    LIKE type_t.chr1     #151130-00015#4
DEFINE l_glaacomp    LIKE glaa_t.glaacomp #151130-00015#4
DEFINE l_apca018     LIKE apca_t.apca018  #151130-00015#4
#160705-00035#3-s
DEFINE l_apba103     LIKE apba_t.apba103
DEFINE l_apba113     LIKE apba_t.apba113
#160705-00035#3-e
#160825-00031#1 Add  ---(S)---
DEFINE r_apce_w      RECORD
       apce103       LIKE apce_t.apce103,
       apce104       LIKE apce_t.apce104,
       apce109       LIKE apce_t.apce109,
       apce113       LIKE apce_t.apce113,
       apce114       LIKE apce_t.apce114,
       apce119       LIKE apce_t.apce119,
       apce123       LIKE apce_t.apce123,
       apce124       LIKE apce_t.apce124,
       apce129       LIKE apce_t.apce129,
       apce133       LIKE apce_t.apce133,
       apce134       LIKE apce_t.apce134,
       apce139       LIKE apce_t.apce139
       END RECORD
#DEFINE l_apca011     LIKE apca_t.apca011  #160705-00035#5 mark
DEFINE l_apca012     LIKE apca_t.apca012   #160705-00035#5
#170728-00027#1-----s
DEFINE l_apba105     LIKE apba_t.apba105
DEFINE l_apba115     LIKE apba_t.apba115
DEFINE l_apba104     LIKE apba_t.apba104
DEFINE l_apba114     LIKE apba_t.apba114
#170728-00027#1-----e
DEFINE l_glaa015     LIKE glaa_t.glaa015   #170925-00034#1 add
DEFINE l_glaa019     LIKE glaa_t.glaa019   #170925-00034#1 add
#160825-00031#1 Add  ---(S)---
#180327-00063#1 add(s)
DEFINE l_apca011          LIKE apca_t.apca011 #預付的稅別
DEFINE l_apca011_t300     LIKE apca_t.apca011 #立帳的稅別
DEFINE l_apca012_t300     LIKE apca_t.apca012 #立帳的稅率
DEFINE l_oodb005          LIKE oodb_t.oodb005
DEFINE l_oodb006          LIKE oodb_t.oodb006
DEFINE l_oodb011          LIKE oodb_t.oodb011
DEFINE l_oodbl004         LIKE oodbl_t.oodbl004
DEFINE l_success          LIKE type_t.num5
#180327-00063#1 add(e)
DEFINE l_apca103          LIKE apca_t.apca103   #180608-00035#1 add
#180718-00024#1 --s add
DEFINE l_amt              RECORD
         apcc10x          LIKE type_t.num20_6,
         apcc11x          LIKE type_t.num20_6,
         apcc12x          LIKE type_t.num20_6,
         apcc13x          LIKE type_t.num20_6
                          END RECORD
DEFINE l_apca011_1        LIKE apca_t.apca011                          
#180718-00024#1 --e add
DEFINE l_dfin3008         LIKE type_t.chr1     #180726-00023#1 add
DEFINE l_slip             LIKE ooba_t.ooba002  #180726-00023#1 add
DEFINE l_apcc113_sum      LIKE apcc_t.apcc113  #190605-00072#1 add
DEFINE l_apcc118_sum      LIKE apcc_t.apcc118  #190605-00072#1 add
DEFINE l_apca101         LIKE apca_t.apca101   #190515-00012#1 add 預付單匯率
#200205-00019#1 add(s)
DEFINE l_apce103   LIKE apce_t.apce103
DEFINE l_apce104   LIKE apce_t.apce104
DEFINE l_apce109_1 LIKE apce_t.apce109
DEFINE l_apce113   LIKE apce_t.apce113
DEFINE l_apce114   LIKE apce_t.apce114
DEFINE l_apce119_1 LIKE apce_t.apce119
DEFINE l_apcc108_1 LIKE apcc_t.apcc108
DEFINE l_apcc118_1 LIKE apcc_t.apcc118
DEFINE l_apcb103   LIKE apcb_t.apcb103
DEFINE l_apcb104   LIKE apcb_t.apcb104
DEFINE l_apcb113   LIKE apcb_t.apcb113
DEFINE l_apcb114   LIKE apcb_t.apcb114
#200205-00019#1 add(e)
DEFINE l_apbb003   LIKE apbb_t.apbb003  #200812-00034#1 add

   WHENEVER ERROR CONTINUE
   
   IF cl_null(p_wc) THEN RETURN END IF
   #21:訂金待抵       #對應41:應付款單
   #22:倉退待抵       #對應41:應付款單
   #23:預付待抵       #對應41:應付款單
   #24:沖銷溢付待抵   #對應41:應付款單
   #25:押金待底       #對應42:應付待抵款單
   #29:其他待抵       #對應41:應付款單
   #151130-00015#4--(S)
   SELECT glaacomp INTO l_glaacomp
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_ld
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3020') RETURNING l_sfin3020 
   IF cl_null(l_sfin3020) THEN
      LET l_sfin3020 = 'N'
   END IF
   #200904-00065#1 add -s
   IF g_prog MATCHES 'axrp141*' OR g_prog MATCHES 'aapp141*' THEN
      LET l_sfin3020 = 'Y'
   END IF
   #200904-00065#1 add -e
   #151130-00015#4--(E)
   
   #180726-00023#1 --s add
   LET l_slip = ''
   LET l_dfin3008 = ''
   CALL s_aooi200_fin_get_slip(p_docno) RETURNING g_sub_success,l_slip
   CALL s_fin_get_doc_para(p_ld,l_glaacomp,l_slip,'D-FIN-3008') RETURNING l_dfin3008  
   #180726-00023#1 --e add

   #160705-00035#3-s
   #屬於0類則表示aapt110的待底要先沖
   IF p_type = '0' THEN
#      #200107-00014#1---mark---str
#      LET l_sql = " SELECT DISTINCT apba005 FROM apba_t",
#                  "   LEFT JOIN apca_t ON apbaent=apcaent AND apbadocno=apca018",
#                  "  WHERE apcaent = '",g_enterprise,"' ",
#                  "    AND apcald = '",p_ld,"' ",
#                  "    AND apcadocno = '",p_docno,"' ",
#                  "    AND apba004 = '27'",
#                  "  ORDER BY apba005"
#      #200107-00014#1---mark---end
      #200107-00014#1---add---str
      LET l_sql = " SELECT DISTINCT apba005 FROM apba_t",
                  "  WHERE apbaent = '",g_enterprise,"' ",
                  "    AND apbadocno IN (select apcb049 FROM apcb_t WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"' AND apcbdocno = '",p_docno,"') ",
                  "    AND apba004 = '27'",
                  "  ORDER BY apba005"
      #200107-00014#1---add---end
      PREPARE s_aapp130_sel_apba_p FROM l_sql
      DECLARE s_aapp130_sel_apba_c CURSOR FOR s_aapp130_sel_apba_p
      FOREACH s_aapp130_sel_apba_c INTO l_apcb008
      IF cl_null(l_str)THEN
         LET l_str = l_apcb008 CLIPPED
      ELSE
         LET l_str = l_str CLIPPED,",",l_apcb008 CLIPPED
      END IF
      END FOREACH
      CALL s_fin_get_wc_str(l_str) RETURNING l_str
   END IF
   #160705-00035#3-e
   
   #190416-00030#4 ---s---   
   IF p_type = '5' THEN
      LET l_sql = " SELECT DISTINCT fada047 FROM fada_t",
                  "   LEFT JOIN apcb_t ON apcbent=fadaent AND apcb002=fadadocno ",
                  "  WHERE fadaent = '",g_enterprise,"' ",
                  "    AND apcbdocno = '",p_docno,"'    "              
      PREPARE s_aapp130_sel_fada_p FROM l_sql
      DECLARE s_aapp130_sel_fada_c CURSOR FOR s_aapp130_sel_fada_p
      FOREACH s_aapp130_sel_fada_c INTO l_apcb008
      IF cl_null(l_str)THEN
         LET l_str = l_apcb008 CLIPPED
      ELSE
         LET l_str = l_str CLIPPED,",",l_apcb008 CLIPPED
      END IF
      END FOREACH
      CALL s_fin_get_wc_str(l_str) RETURNING l_str
   END IF             
   #190416-00030#4 ---e---
   
   #170518-00041#1 --s add
   #類型屬於4類則表示先沖aapt110的差異折讓
   IF p_type = '4' THEN
      #210409-00032#1 mark(s)
#      LET l_sql = " SELECT DISTINCT apba005 FROM apba_t",
#                  "   LEFT JOIN apca_t ON apbaent=apcaent AND apbadocno=apca018",
#                  "  WHERE apcaent = ",g_enterprise," ",
#                  "    AND apcald = '",p_ld,"' ",
#                  "    AND apcadocno = '",p_docno,"' ",
#                  "    AND apba004 = '18'",
#                  "  ORDER BY apba005"
      #210409-00032#1 mark(e)
      #210409-00032#1 add(s)
      LET l_sql = " SELECT DISTINCT apba005 FROM apba_t",
                  "  WHERE apbaent = ",g_enterprise,
                  "    AND apbadocno IN (SELECT apcb049 FROM apcb_t WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"' AND apcbdocno = '",p_docno,"') ",
                  "    AND apba004 = '18'",
                  "  ORDER BY apba005 "
      #210409-00032#1 add(e)
      PREPARE s_aapp130_sel_apba28_p FROM l_sql
      DECLARE s_aapp130_sel_apba28_c CURSOR FOR s_aapp130_sel_apba28_p
      FOREACH s_aapp130_sel_apba28_c INTO l_apcb008
      IF cl_null(l_str)THEN
         LET l_str = l_apcb008 CLIPPED
      ELSE
         LET l_str = l_str CLIPPED,",",l_apcb008 CLIPPED
      END IF
      END FOREACH
      CALL s_fin_get_wc_str(l_str) RETURNING l_str
   END IF
   #170518-00041#1 --e add   
   
   #屬於1/2類訂單待抵優先,卻未勾選21:訂金待抵者/23:預付待抵/25:押金待底,則不進入此類處理
   IF p_type = '1' OR p_type = '2' THEN
      IF s_chr_get_index_of(p_wc,'21',1) = 0 AND s_chr_get_index_of(p_wc,'23',1) = 0 AND s_chr_get_index_of(p_wc,'25',1) = 0THEN
         RETURN
      END IF
      IF p_type = '1' THEN
         #1類須撈取本張立帳單關聯的採購單號(apcb008)串sql條件
         LET l_sql = " SELECT DISTINCT apcbseq,apcb008 FROM apca_t,apcb_t ",
                     "  WHERE apcaent = apcbent " ,
                     "    AND apcald = apcbld ",
                     "    AND apcadocno = apcbdocno ",
                     "    AND apcaent = '",g_enterprise,"' ",
                     "    AND apcald = '",p_ld,"' ",
                     "    AND apcadocno = '",p_docno,"' ",
                     "  ORDER BY apcbseq "
         PREPARE s_aapp130_sel_apcb_p FROM l_sql
         DECLARE s_aapp130_sel_apcb_c CURSOR FOR s_aapp130_sel_apcb_p
         FOREACH s_aapp130_sel_apcb_c INTO l_apcbseq,l_apcb008
            IF cl_null(l_str)THEN
               LET l_str = l_apcb008 CLIPPED
            ELSE
               LET l_str = l_str CLIPPED,",",l_apcb008 CLIPPED
            END IF
         END FOREACH
         CALL s_fin_get_wc_str(l_str) RETURNING l_str
      END IF
   END IF
   
   #140806-00012#12 add glaa001|glaa016|glaa020
   CALL s_ld_sel_glaa(p_ld,'glaa017|glaa021|glaa001|glaa016|glaa020|glaa015|glaa019')   #170925-00034#1 add glaa015|glaa019
       RETURNING  g_sub_success,l_glaa017,l_glaa021,l_glaa001,l_glaa016,l_glaa020,l_glaa015,l_glaa019   #170925-00034#1 add l_glaa015,l_glaa019
   
   #此次單據
   SELECT apca004,apca005,apca100,apcacomp,apcadocdt
     INTO l_apca0041,l_apca0051,l_apca1001,l_apcacomp,l_apcadocdt
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld
      AND apcadocno = p_docno
   
   #待抵範圍
   LET l_sql = " SELECT apca001,apca014,apca015,apca033,apca034, ",
               "        apca035,apca059,",
               "        apcccomp,apccsite,apccdocno,apccseq,",
               "        apcc001,apcc100,apcc121,apcc131,",  
               "        apcc101,apcc102,",
               #"        apcc108,apcc118,apcc128,apcc138  ,",            #170322-00115#1 mark
               "        apcc108,(apcc118+apcc113),apcc128,apcc138  ,",   #170322-00115#1 add
               "        apcc109,apcc119,apcc129,apcc139  ,",
               "        apca018 ",                             #151130-00015#4
               "   FROM apca_t,apcc_t ",
               "  WHERE apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno  ",
               "    AND apcaent = ",g_enterprise,"  AND apcald ='",p_ld,"'",
               "    AND apcc108-apcc109 <> 0        AND apca100='",l_apca1001,"'",
#               "    AND apcadocdt <= '",l_apcadocdt,"'", #180525-00014#1  #200708-00003#1 mark
               "    AND apcadocdt <= ? ", #180525-00014#1  #200708-00003#1 add
               "    AND apcastus = 'Y'"
   CASE p_type
      #160705-00035#3-s
      WHEN '0'   #aapt110的27:其他待抵單
         LET l_sql = l_sql," AND apcadocno IN ",l_str
      #160705-00035#3-e
      #170518-00041#1 --s add 18:差異折讓
      WHEN '4'   
         LET l_sql = l_sql," AND apcadocno IN ",l_str
      #170518-00041#1 --e add
      WHEN '1'   #1.21:訂單待抵/23:預付待抵/25:押金待抵優先+同採購單
         LET l_sql = l_sql," AND apca001 IN (",p_wc,") AND apca001 IN ('21','23','25')",
                           " AND apcadocno IN ( SELECT apcbdocno FROM apcb_t ",
                           "                     WHERE apcbent = apcaent AND apcbld = apcald ",
                           "                       AND apcb002 IN ",l_str,") "
      WHEN '2'   #2.21:訂單待抵/23:預付待抵/25:押金待抵優先+帳款對象+付款對象
         LET l_sql = l_sql," AND apca004 ='",l_apca0041,"' AND apca005='",l_apca0051,"'",
                           " AND apca001 IN (",p_wc,") AND apca001 IN ('21','23','25') "
      WHEN '3'   #3.帳款對象+付款對象
         LET l_sql = l_sql," AND apca004 ='",l_apca0041,"' AND apca005='",l_apca0051,"'",
                           " AND apca001 IN (",p_wc,") "
      #190416-00030#4 ---s---
      WHEN '5'
         LET l_sql = l_sql," AND apcadocno IN ",l_str
      #190416-00030#4 ---e---      
   END CASE
   LET l_sql = l_sql,"  ORDER BY apcc004,apcadocno,apcc001,apccseq"
   PREPARE s_aapp130_ins_apce_p FROM l_sql
   DECLARE s_aapp130_ins_apce_c CURSOR FOR s_aapp130_ins_apce_p
#   FOREACH s_aapp130_ins_apce_c INTO l_apca001,l_apca014,l_apca015,l_apca033,l_apca034,  #200708-00003#1 mark
   FOREACH s_aapp130_ins_apce_c USING l_apcadocdt INTO l_apca001,l_apca014,l_apca015,l_apca033,l_apca034,  #200708-00003#1 add
                                     l_apca035,l_apca059,
                                     l_apcccomp,l_apccsite,l_apccdocno,l_apccseq,
                                     l_apcc001,l_apcc100,l_apcc121,l_apcc131,
                                     l_apcc101,l_apcc102,
                                     l_apcc108,l_apcc118,l_apcc128,l_apcc138,
                                     l_apcc109,l_apcc119,l_apcc129,l_apcc139,
                                     l_apca018          #151130-00015#4
      
      #未付款的单据审核后生成的待抵单，在没有付款前不允许在进行冲抵。
      SELECT COUNT(apcadocno) INTO l_cnt
        FROM apca_t,apcc_t
       WHERE apcaent = apccent 
         AND apcald = apccld AND apcadocno = apccdocno
         #AND apcastus = 'Y'  AND apcc108 - apcc109 > 0   #170627-00020#1 mark
         AND apcastus = 'Y'                               #170627-00020#1 add
         #AND ((apcc108 - apcc109 > 0 AND apca001 NOT IN ('11','14')) OR (apcc109 = 0  AND apca001 IN ('11','14')))   #170627-00020#1 add                           #180809-00005#2 mark
         AND ((apcc108 - apcc109 > 0 AND apca001 NOT IN ('11','14'))                                                                                                #180809-00005#2 add
             OR ((SELECT SUM(x.apcc109) FROM apcc_t x WHERE x.apccent = apcaent AND x.apccld = apcald AND x.apccdocno = apcadocno) = 0 AND apca001 IN ('11','14'))) #180809-00005#2 add          
         AND apcaent = g_enterprise
         AND apcald  = p_ld  AND apca019 = l_apccdocno
      IF l_cnt > 0 THEN
         CONTINUE FOREACH
      END IF
      #200812-00034#1 add(s)
      LET l_apbb003 = ''
      SELECT apbb003 INTO l_apbb003 FROM apbb_t,apba_t
       WHERE apbbent = apbaent AND apbaent = g_enterprise
         AND apbbdocno = apbadocno
         AND apbbcomp = l_apcccomp
         AND apbbstus = 'Y'
         AND apba005 = l_apccdocno
      IF NOT cl_null(l_apbb003) AND l_apbb003 <> '8' THEN
      #200812-00034#1 add(e)
      #151130-00015#4--(S)
      IF l_apca001 = '21' AND l_sfin3020 = 'Y' AND NOT cl_null(l_apca018) THEN
         #SELECT COUNT(*) INTO l_cnt        #161114-00009#1 mark
         SELECT COUNT(apcbdocno) INTO l_cnt #161114-00009#1 add
           FROM apcb_t,pmdt_t
          WHERE apcbent = g_enterprise 
            AND apcbld  = p_ld AND apcbdocno = p_docno
            AND apcbent = pmdtent AND apcb001 = '11'  
            AND apcb002 = pmdtdocno AND apcb003 = pmdtseq
            AND pmdt001 IN (SELECT DISTINCT apcb002 FROM apcb_t WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = l_apca018 AND apcb001 = '10')
         IF l_cnt = 0 THEN CONTINUE FOREACH END IF
      END IF
      #151130-00015#4--(E)
      END IF  #200812-00034#1 add
      
      #160705-00035#3-s
      #IF p_type = '0' THEN                #170518-00041#1 mark
      IF p_type = '0' OR p_type = '4' THEN #170518-00041#1 add p_type = '4'
         #直接撈aapt110的錢進來沖即可
         
        #SELECT apba103,apba113 INTO l_apba103,l_apba113  #160705-00035#5 mark
         #170728-00027#1 mark-----s
         #SELECT apba105,apba115 INTO l_apba103,l_apba113  #160705-00035#5
         #170728-00027#1 mark-----e
         #170728-00027#1-----s
         LET l_apba105 = NULL LET l_apba115 = NULL
         LET l_apba103 = NULL LET l_apba113 = NULL
         LET l_apba104 = NULL LET l_apba114 = NULL
         
         IF p_type = '0' THEN  #170518-00041#1 add
         
         #171216-00003#1---mark---str--
         #SELECT apba105,apba115,
         #       apba103,apba113,
         #       apba104,apba114
         #171216-00003#1---mark---end--
         #171216-00003#1---add---str--
         SELECT SUM(apba105),SUM(apba115),
                SUM(apba103),SUM(apba113),
                SUM(apba104),SUM(apba114)
         #171216-00003#1---add---end--
           INTO l_apba105,l_apba115,
                l_apba103,l_apba113,
                l_apba104,l_apba114
         #170728-00027#1-----e
           FROM apba_t
#         #200107-00014#1--mark--str
#           LEFT JOIN apca_t ON apbaent=apcaent AND apbadocno=apca018
#          WHERE apcaent = g_enterprise
#            AND apcald = p_ld
#            AND apcadocno = p_docno
#         #200107-00014#1--mark--end
         #200107-00014#1--add--str
          WHERE apbaent = g_enterprise
            AND apbadocno IN (SELECT apcb049 FROM apcb_t WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = p_docno)
         #200107-00014#1--add--end
            AND apba005 = l_apccdocno
            AND apba006 = l_apccseq
            AND apba020 = l_apcc001
            
         #170518-00041#1 --s add 
         ELSE   
            #171216-00003#1---mark---str--
            #SELECT apba105,apba115,
            #       apba103,apba113,
            #       apba104,apba114
            #171216-00003#1---mark---end--
            #171216-00003#1---add---str--
            SELECT SUM(apba105),SUM(apba115),
                   SUM(apba103),SUM(apba113),
                   SUM(apba104),SUM(apba114)
            #171216-00003#1---add---end--
              INTO l_apba105,l_apba115,
                   l_apba103,l_apba113,
                   l_apba104,l_apba114
              FROM apba_t
#            #200107-00014#1--mark--str
#              LEFT JOIN apca_t ON apbaent=apcaent AND apbadocno=apca018
#             WHERE apcaent = g_enterprise
#               AND apcald = p_ld
#               AND apcadocno = p_docno
#            #200107-00014#1--mark--end
            #200107-00014#1--add--str
             WHERE apbaent = g_enterprise
               AND apbadocno IN (SELECT apcb049 FROM apcb_t WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = p_docno)
            #200107-00014#1--add--end
               AND apba005 = l_apccdocno
               AND apba006 = l_apccseq       
         END IF  
         #170518-00041#1 --e add          
            
         IF cl_null(l_apba103) THEN LET l_apba103 = 0 END IF
         IF cl_null(l_apba113) THEN LET l_apba113 = 0 END IF
         #170728-00027#1-----s
         IF cl_null(l_apba104) THEN LET l_apba104 = 0 END IF
         IF cl_null(l_apba114) THEN LET l_apba114 = 0 END IF
         IF cl_null(l_apba105) THEN LET l_apba105 = 0 END IF
         IF cl_null(l_apba115) THEN LET l_apba115 = 0 END IF         
         #170728-00027#1-----e
         IF l_apba103 = 0 THEN CONTINUE FOREACH END IF
      ELSE
      #160705-00035#3-e
         #-150316apo--(s)
         #取得待抵單號+項次+帳期剩餘可沖銷金額
         CALL s_aapt420_apcc_used_num('41',p_ld,p_ld,l_apccdocno,l_apccseq,l_apcc001,p_docno,' ','1')
              RETURNING g_sub_success,g_errno,l_apcc_left.apce109,l_apcc_left.apce119,l_apcc_left.apce129,l_apcc_left.apce139      
         IF l_apcc_left.apce109 = 0 THEN CONTINUE FOREACH END IF
         #-150316apo--(e)
         #判斷是否已存在於同一張應付單據中的直接沖帳檔,若已存在則跳過此筆
         LET l_cnt = 0 
         #SELECT COUNT(*) INTO l_cnt FROM apce_t        #161114-00009#1 mark
         SELECT COUNT(apcedocno) INTO l_cnt FROM apce_t #161114-00009#1 add
          WHERE apceent = g_enterprise
            AND apceld = p_ld
            AND apcedocno = p_docno     #本張應付單據
            AND apce003 = l_apccdocno   #沖銷帳款單號
            AND apce004 = l_apccseq     #沖銷帳款項次
         IF l_cnt > 0 THEN
            CONTINUE FOREACH
         END IF
      END IF #160705-00035#3
      
      #防止本次立帳單被超沖check-s
      #立帳單未付金額
      SELECT SUM(apcc108 - apcc109) INTO l_apcc109sum
        FROM apcc_t
       WHERE apccent = g_enterprise
         AND apccld  = p_ld AND apccdocno = p_docno
      #目前直接沖帳金額
      SELECT SUM(apce109) INTO l_apce109sum
        FROM apca_t,apce_t   #150316apo add apca_t
       WHERE apceent = g_enterprise
         AND apceld  = p_ld AND apcedocno = p_docno
         #--150316apo--(s)
         AND apcaent = apceent
         AND apcald  = apceld
         AND apcadocno = apcedocno
         AND apcastus NOT IN ('X')
         #--150316apo--(e)
         AND apce001 <> 'aapt430'  #150212
      IF cl_null(l_apcc109sum) THEN LET l_apcc109sum = 0 END IF
      IF cl_null(l_apce109sum) THEN LET l_apce109sum = 0 END IF
      IF l_apcc109sum <= l_apce109sum THEN
         EXIT FOREACH
      END IF
      #尚可沖帳金額
      LET l_apce109 = l_apcc109sum - l_apce109sum
      #-150316apo--(s)
      IF l_apce109 > l_apcc_left.apce109 THEN
         LET l_apce109 = l_apcc_left.apce109
      END IF
      #-150316apo--(e)
      #防止本次立帳單被超沖check-e
      
      INITIALIZE l_apce.* TO NULL
      LET l_apce.apceent = g_enterprise
      LET l_apce.apcecomp= l_apcccomp
      LET l_apce.apcelegl= ''
      LET l_apce.apcesite= l_apccsite
      LET l_apce.apceld  = p_ld
      LET l_apce.apcedocno=p_docno
      SELECT MAX(apceseq)+1 INTO l_apce.apceseq
        FROM apce_t
       WHERE apceent = g_enterprise AND apceld = p_ld
         AND apcedocno = p_docno
      IF cl_null(l_apce.apceseq) THEN LET l_apce.apceseq = 1 END IF
      LET l_apce.apce001 = 'aapt300'
      IF p_type = '5' THEN LET l_apce.apce001 = 'aapt301' END IF #190416-00030#4 add
      IF p_sfin2002 MATCHES '[12]' THEN 
         LET l_apce.apceorga= l_apcccomp
         LET l_apce.apce018 = l_apca015
         LET l_apce.apce019 = l_apca034
         LET l_apce.apce021 = l_apca059
         LET l_apce.apce022 = l_apca033
      ELSE
         SELECT apcborga,apcb002,apcb003,apcb010,apcb011,
                apcb012 ,apcb017,apcb015,apcb016
           INTO l_apce.apceorga,l_apce.apce024,l_apce.apce025,l_apce.apce018,l_apce.apce019,
                l_apce.apce020 ,l_apce.apce021,l_apce.apce022,l_apce.apce023
           FROM apcb_t
          WHERE apcbent  = g_enterprise     AND apcbld = p_ld
            AND apcbdocno= l_apccdocno AND apcbseq= l_apccseq
      END IF
      IF l_apca001 = '25' THEN
         LET l_apce.apce002 = '42'
      ELSE
         LET l_apce.apce002 = '41'
      END IF
      LET l_apce.apce003 = l_apccdocno
      LET l_apce.apce004 = l_apccseq
      LET l_apce.apce005 = l_apcc001
      
      LET l_apce.apce007 = 0
      LET l_apce.apce009 = 'N'
      LET l_apce.apce015 = s_fin_get_scc_value('8506',l_apce.apce002,'3')
      LET l_apce.apce016 = l_apca035
      LET l_apce.apce017 = l_apca014
      #應稅折抵否
      LET l_apce.apce027 = s_aapp131_get_apce027(l_apce.apce003)  #150316apo 
      LET l_apce.apce028 = 'N'
      LET l_apce.apce038 = l_apca0041   #150415apo
      
      LET l_apce.apce100 = l_apcc100
      LET l_apce.apce101 = l_apcc102
      LET l_apce.apce104 = 0
      LET l_apce.apce114 = 0
      LET l_apce.apce121 = l_apcc121
      LET l_apce.apce124 = 0
      LET l_apce.apce131 = l_apcc131
      LET l_apce.apce134 = 0
      LET l_apce.apce139 = 0  #180109-00036#1 add
      LET l_apce.apce123 = 0  #180109-00036#1 add
      LET l_apce.apce133 = 0  #180109-00036#1 add
      LET l_apce.apce129 = 0  #180109-00036#1 add

      IF cl_null(l_apba103) THEN LET l_apba103 = 0 END IF #170327-00070#1 add

      #IF (l_apcc108 - l_apcc109) > l_apce109 THEN                   #161202-00051#1 mark
      IF (l_apcc108 - l_apcc109) > l_apce109 AND l_apba103 = 0 THEN  #161202-00051#1 add 增加AND l_apba103 = 0條件,判斷是不是aapt110待抵來的
         LET l_apce.apce109 = l_apce109
         LET l_apce.apce119 = l_apce109 * l_apcc101
         IF l_glaa017 = '1' THEN
            LET l_apce.apce129 = l_apce.apce109 * l_apcc121
         ELSE
            LET l_apce.apce129 = l_apce.apce119 * l_apcc121
         END IF
         IF l_glaa021 = '1' THEN
            LET l_apce.apce139 = l_apce.apce109 * l_apcc131
         ELSE
            LET l_apce.apce139 = l_apce.apce119 * l_apcc131
         END IF
      ELSE
         #160705-00035#3-s
         #如果是aapt110，只有部份沖，就寫入部份沖的錢
         IF p_type = '0' AND (l_apcc108 - l_apcc109) > l_apba103 THEN
            #170728-00027#1 mark-----s
            #LET l_apce.apce109 = l_apba103
            #LET l_apce.apce119 = l_apba113
            #170728-00027#1 mark-----e
            #170728-00027#1-----s
            LET l_apce.apce109 = l_apba105
            LET l_apce.apce119 = l_apba115
            LET l_apce.apce103 = l_apba103
            LET l_apce.apce113 = l_apba113
            LET l_apce.apce104 = l_apba104
            LET l_apce.apce114 = l_apba114            
            #170728-00027#1-----e
            LET l_apce.apce129 = l_apba103 * l_apcc121
            LET l_apce.apce139 = l_apba103 * l_apcc131
         ELSE
         #160705-00035#3-e
            LET l_apce.apce109 = l_apcc108 - l_apcc109
            LET l_apce.apce119 = l_apcc118 - l_apcc119
            LET l_apce.apce129 = l_apcc128 - l_apcc129
            LET l_apce.apce139 = l_apcc138 - l_apcc139
         END IF  #160705-00035#3
      END IF
      #160705-00035#3 mark ------
      #CALL s_curr_round_ld('1',p_ld,l_apce.apce100,l_apce.apce109,1) RETURNING g_sub_success,g_errno,l_apce.apce109 #140806-00012#12
      #CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce.apce119,1) RETURNING g_sub_success,g_errno,l_apce.apce119 #140806-00012#12
      #CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apce.apce129,1) RETURNING g_sub_success,g_errno,l_apce.apce129 #140806-00012#12
      #CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apce.apce139,1) RETURNING g_sub_success,g_errno,l_apce.apce139 #140806-00012#12
      #160705-00035#3 mark end---
      #160705-00035#3 -s
      CALL s_curr_round_ld('1',p_ld,l_apce.apce100,l_apce.apce109,2) RETURNING g_sub_success,g_errno,l_apce.apce109
      #160825-00031#1 Add  ---(S)---
     #LET l_apca011 = 0 #160705-00035#5 mark
      LET l_apca012 = 0 #160705-00035#5
     #SELECT apca011 INTO l_apca011 FROM apca_t WHERE apcaent = g_enterprise #160705-00035#5 mark
      SELECT apca012 INTO l_apca012 FROM apca_t WHERE apcaent = g_enterprise #160705-00035#5
         AND apcadocno = l_apce.apce003
         AND apcald    = p_ld
     #IF cl_null(l_apca011) THEN LET l_apca011 = 0 END IF #160705-00035#5 mark
      IF cl_null(l_apca012) THEN LET l_apca012 = 0 END IF #160705-00035#5
      
      #180726-00023#1 --s add 從下方ELSE段中提出來處理
      IF l_apce.apce002 = '41' THEN #只有在產生預付待底單時才進這段邏輯
           SELECT apca011,apca012 INTO l_apca011_t300,l_apca012_t300 FROM apca_t
               WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
                 AND apcadocno = l_apce.apcedocno
           IF (l_apca001 = '21') OR (l_apca001 = '23') OR (l_apca001 = '25') THEN 
              #先抓出原本預付單的稅別及稅率
              LET l_apca011 = ''
              LET l_apca103 = ''                                                             
              SELECT apca011,apca012,apca103 INTO l_apca011,l_apca012,l_apca103 FROM apca_t
               WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
                 AND apcadocno IN (SELECT apca019 FROM apca_t WHERE apcaent = g_enterprise 
                                      AND apcald=l_apce.apceld  AND apcadocno=l_apce.apce003)
                                      
              #參考订金冲销不限制税种相同条件參數D-FIN-3008                        
              IF (l_dfin3008 = 'N') AND (l_apca011_t300 <> l_apca011) THEN
                 CONTINUE FOREACH
              END IF
           #200407-00022#1---add---str
           ELSE
               #先抓出自己的稅別及稅率
              LET l_apca011 = ''
              LET l_apca103 = ''                                                             
              SELECT apca011,apca012,apca103 INTO l_apca011,l_apca012,l_apca103 FROM apca_t
               WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
                 AND apcadocno = l_apce.apce003
           #200407-00022#1---add---end              
           END IF      
      END IF 
      #180726-00023#1 --e add  
      
      #170728-00027#1-----s
      IF p_type = '0' AND (l_apcc108 - l_apcc109) > l_apba103 THEN    

      ELSE
      #170728-00027#1-----e
        #180327-00063#1 add(s)
        IF l_apce.apce002='41' THEN #只有在產生預付待底單時才進這段邏輯
           IF p_type <> '4' THEN #200205-00019#1 add 只有對帳單有差異折讓的時候 p_type = '4'
              #180726-00023#1 --s mark 移到IF判斷式外去取稅別
              ##180510-00069#1 add ---s 
              #SELECT apca011,apca012 INTO l_apca011_t300,l_apca012_t300 FROM apca_t
              #    WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
              #      AND apcadocno = l_apce.apcedocno
              ##180510-00069#1 add ---e
              #IF (l_apca001 = '21') OR (l_apca001 = '23') OR (l_apca001 = '25') THEN 
              #   #先抓出原本預付單的稅別及稅率
              #   LET l_apca011 = ''
              #   LET l_apca103 = ''                                                             #180611-00034#1 add
              #   #SELECT apca011,apca012 INTO l_apca011,l_apca012 FROM apca_t                   #180611-00034#1 mark
              #   SELECT apca011,apca012,apca103 INTO l_apca011,l_apca012,l_apca103 FROM apca_t  #180611-00034#1 add l_apca103
              #    WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
              #      AND apcadocno IN (SELECT apca019 FROM apca_t WHERE apcaent = g_enterprise 
              #                           AND apcald=l_apce.apceld  AND apcadocno=l_apce.apce003)
              #   
              #   #180510-00069#1 mark ---s
              #   #SELECT apca011,apca012 INTO l_apca011_t300,l_apca012_t300 FROM apca_t
              #   # WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
              #   #   AND apcadocno = l_apce.apcedocno
              #   #180510-00069#1 mark ---e 
              #END IF
              #180726-00023#1 --e mark
              
              #180601-00030#1 --s add s_aapt300_not_washed_amt搬上來
              #先算出可使用的待抵單金額
              CALL s_aapt300_not_washed_amt(l_apce.apceld,l_apce.apcedocno,l_apce.apceseq,l_apce.apce003,l_apce.apce004,l_apce.apce005)
                   RETURNING r_apce_w.*
              
              #180718-00024#1 --s add 剩餘可沖的立帳金額, 而非直接以全額寫入(會造成超沖)    
              CALL s_aapt420_get_contra_amount(l_apce.apceld,l_apce.apcedocno,l_apce.apceseq)RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x 
              
              IF r_apce_w.apce119 > l_amt.apcc11x THEN
              #210218-00022#1---mark--str
              #待抵单的本币金额大于 剩餘可沖的立帳金額 进到IF里
              #然后还需要判断一下原币的金额
              #待抵单的原币金额小于 剩餘可沖的立帳金額，则直接冲账的金额需要用待抵单的金额，不需要把剩餘可沖的立帳金額给直接冲账
#                 IF l_amt.apcc10x != r_apce_w.apce109 THEN  
              #210218-00022#1---mark---end
                 IF l_amt.apcc10x < r_apce_w.apce109 THEN  #210218-00022#1---add 
                    LET r_apce_w.apce109 = l_amt.apcc10x 
                    LET r_apce_w.apce119  =  r_apce_w.apce109 *l_apce.apce101
                    CALL s_curr_round_ld('1',l_apce.apceld,l_apce.apce100,r_apce_w.apce109,2) RETURNING g_sub_success,g_errno,r_apce_w.apce109 
                    CALL s_curr_round_ld('1',l_apce.apceld,l_glaa001,r_apce_w.apce119,2) RETURNING g_sub_success,g_errno,r_apce_w.apce119 
                    #立帳單的稅別
                    SELECT apca011 INTO l_apca011_1 FROM apca_t
                     WHERE apcaent = g_enterprise
                       AND apcald = l_apce.apceld
                       AND apcadocno = p_docno
                    #180911-00006#2---add---(S)若是待抵單就用原待抵單的稅別
                    IF (l_apca001 = '21') OR (l_apca001 = '23') OR (l_apca001 = '25') THEN
                       LET l_apca011_1 = l_apca011
                    END IF   
                    #180911-00006#2---add---(E)
                    CALL s_tax_chk(l_apce.apcecomp,l_apca011_1) RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                    #190430-00020#1---s--- mark                  
                    #IF l_oodb005 = 'Y' THEN
                    #   CALL s_tax_chk(l_apce.apcecomp,l_apca011) RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                    #   LET r_apce_w.apce103 = l_amt.apcc10x / (1 + l_oodb006/100)                
                    #   CALL s_curr_round_ld('1',p_ld,l_apce.apce100,r_apce_w.apce103,2) RETURNING g_sub_success,g_errno,r_apce_w.apce103
                    #   LET r_apce_w.apce113 = r_apce_w.apce103 * l_apce.apce101
                    #   CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apce_w.apce113,2) RETURNING g_sub_success,g_errno,r_apce_w.apce113 
                    #ELSE
                    #   LET r_apce_w.apce103 = l_amt.apcc10x 
                    #   LET r_apce_w.apce113 = r_apce_w.apce103 * l_apce.apce101
                    #   CALL s_curr_round_ld('1',p_ld,l_glaa001,r_apce_w.apce113,2) RETURNING g_sub_success,g_errno,r_apce_w.apce113                
                    #END IF    
                    #190430-00020#1---e---
                    LET r_apce_w.apce103 = l_amt.apcc10x / (1 + l_oodb006/100)                                                        #190430-00020#1 add
                    CALL s_curr_round_ld('1',p_ld,l_apce.apce100,r_apce_w.apce103,2) RETURNING g_sub_success,g_errno,r_apce_w.apce103 #190430-00020#1 add
                 END IF                 
              END IF     
              #180718-00024#1 --e add           
              
              #IF (l_apca011 <> l_apca011_t300) AND (l_apca011 IS NOT NULL)  THEN                                 #180611-00034#1 mark
              #IF (l_apca103 <> r_apce_w.apce103) OR ((l_apca012_t300 = 0) AND (l_apca012 <> l_apca012_t300)) THEN #180611-00034#1 add 非全額沖銷 或 (對帳單稅率是0%且來源單稅率不為0%) 則需要重新推算金額  #190515-00012#1 mark
              #190515-00012#1---add---(S)
              LET l_apca101 = 0
              SELECT apca101
                INTO l_apca101  
                FROM apca_t
               WHERE apcaent = g_enterprise AND apcald = l_apce.apceld 
                 AND apcadocno IN (SELECT apca019 FROM apca_t WHERE apcaent = g_enterprise 
                                      AND apcald = l_apce.apceld AND apcadocno = l_apce.apce003)
              #200407-00022#1--add---str
              IF cl_null(l_apca103) THEN
                  LET l_apca103 = 0
              END IF
              #200407-00022#1--add---end
              IF (l_apca103 <> r_apce_w.apce103) OR ((l_apca012_t300 = 0) AND (l_apca012 <> l_apca012_t300))
                 OR (l_apca101 <> l_apce.apce101) #預付單匯率<>待抵單重評匯率時要重推金額
                 THEN 
              #190515-00012#1---add---(E)         
              #180601-00030#1 --e add
                 #在直接沖帳時都要用預付單的稅別及稅率去做沖帳
                 #但只有立帳單是0%的時候才會用立帳單的0%去計算
                 IF l_apca012_t300 = 0 THEN  #180510-00069#1 mark   #200407-00022#1--add
#                 IF l_apca012_t300 = 0 OR (l_apca001 = '24') THEN #180510-00069#1 add  #200407-00022#1--mark
                    LET l_apca011 = l_apca011_t300
                    LET l_apca012 = l_apca012_t300
                 END IF
                 #180601-00030#1 --s mark
                 ##先算出可使用的待抵單金額
                 #CALL s_aapt300_not_washed_amt(l_apce.apceld,l_apce.apcedocno,l_apce.apceseq,l_apce.apce003,l_apce.apce004,l_apce.apce005)
                 #     RETURNING r_apce_w.*
                 #180601-00030#1 --e mark
                 
#                 #200407-00022#1--mark--str
#                 #200107-00014#1---add---str
#                 IF cl_null(l_apca011) THEN
#                  LET l_apca011 = l_apca011_t300
#                 END IF
#                 #200107-00014#1---add---end
#                 #200407-00022#1--mark--end
                
                #210218-00022#1---add----str
                 #判断一下如果剩餘可沖的立帳金額 = 可使用的待抵單金額--如果剩餘可沖的立帳金額大于可使用的待抵單金額直接取 可使用的待抵單金額
                 IF l_amt.apcc10x >= r_apce_w.apce109 THEN
                    LET l_apce.apce103  = r_apce_w.apce103
                    LET l_apce.apce104  = r_apce_w.apce104
                    LET l_apce.apce109  = r_apce_w.apce109
                    LET l_apce.apce113  = r_apce_w.apce113
                    LET l_apce.apce114  = r_apce_w.apce114
                    LET l_apce.apce119  = r_apce_w.apce119 
                    LET l_apce.apce123  = r_apce_w.apce123 
                    LET l_apce.apce124  = r_apce_w.apce124 
                    LET l_apce.apce129  = r_apce_w.apce129 
                    LET l_apce.apce133  = r_apce_w.apce133 
                    LET l_apce.apce134  = r_apce_w.apce134 
                    LET l_apce.apce139  = r_apce_w.apce139                    
                 ELSE
                 #210218-00022#1---add----end 
                
                    #再根據稅別-含稅否算出稅額 
                    CALL s_tax_chk(l_apce.apcecomp,l_apca011) 
                        RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                    IF l_oodb005 = 'Y' THEN
                       LET r_apce_w.apce109 = r_apce_w.apce103 * (1 + l_oodb006/100) #180517-00028#1 add
                       CALL s_tax_ins(l_apce.apce003,l_apce.apce004,0,l_apce.apcecomp,
                                      r_apce_w.apce109,l_apca011,
                                      1,l_apce.apce100,l_apce.apce101,l_apce.apceld,l_apce.apce121,l_apce.apce131)
                         RETURNING l_apce.apce103,l_apce.apce104,l_apce.apce109,
                                   l_apce.apce113,l_apce.apce114,l_apce.apce119,
                                   l_apce.apce123,l_apce.apce124,l_apce.apce129,
                                   l_apce.apce133,l_apce.apce134,l_apce.apce139 
                    ELSE
                       CALL s_tax_ins(l_apce.apce003,l_apce.apce004,0,l_apce.apcecomp,
                                      r_apce_w.apce103,l_apca011,
                                      1,l_apce.apce100,l_apce.apce101,l_apce.apceld,l_apce.apce121,l_apce.apce131)
                        RETURNING l_apce.apce103,l_apce.apce104,l_apce.apce109,
                                  l_apce.apce113,l_apce.apce114,l_apce.apce119,
                                  l_apce.apce123,l_apce.apce124,l_apce.apce129,
                                  l_apce.apce133,l_apce.apce134,l_apce.apce139  
                    END IF
                 END IF  #210218-00022#1---add-对应IF l_amt.apcc10x = r_apce_w.apce109 THEN
              #180601-00030#1 --s add
              ELSE
                
                 #180611-00034#1 --s add
                 #全額沖銷直接以預付單金額寫入
                 SELECT apca103,apca104,apca108,
                        apca113,apca114,apca118,
                        apca123,apca124,apca128,
                        apca133,apca134,apca138
                   INTO r_apce_w.apce103,r_apce_w.apce104,r_apce_w.apce109,
                        r_apce_w.apce113,r_apce_w.apce114,r_apce_w.apce119,
                        r_apce_w.apce123,r_apce_w.apce124,r_apce_w.apce129,
                        r_apce_w.apce133,r_apce_w.apce134,r_apce_w.apce139  
                   FROM apca_t
                  WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
                    AND apcadocno IN (SELECT apca019 FROM apca_t WHERE apcaent = g_enterprise 
                                         AND apcald = l_apce.apceld AND apcadocno = l_apce.apce003)   
                 #180611-00034#1 --e add
               
                 
                 LET l_apce.apce103   = r_apce_w.apce103
                 LET l_apce.apce104   = r_apce_w.apce104
                 LET l_apce.apce109   = r_apce_w.apce109
                 LET l_apce.apce113   = r_apce_w.apce113
                 LET l_apce.apce114   = r_apce_w.apce114
                 LET l_apce.apce119   = r_apce_w.apce119 
           
                 #190605-00072#1---add----str 
                 #apce113取待底单上得金额, apce119 取apce113 + apce114 ,其他得都是取原预付单上得金额
                 LET l_apcc113_sum = 0
                 LET l_apcc118_sum = 0
                 SELECT SUM(apcc113),SUM(apcc118) INTO l_apcc113_sum,l_apcc118_sum
                  FROM apcc_t
                 WHERE apccent = g_enterprise
                   AND apccld = l_apce.apceld
                   AND apccdocno = l_apce.apce003
                 IF cl_null(l_apcc113_sum) THEN
                   LET l_apcc113_sum = 0 
                 END IF
                 IF cl_null(l_apcc118_sum) THEN
                   LET l_apcc118_sum = 0 
                 END IF
                 LET l_apce.apce113 = l_apcc113_sum + l_apcc118_sum #待底单重评价后得得金额
                 LET l_apce.apce119 = l_apce.apce113 + l_apce.apce114
                 
                 #190605-00072#1---add----end
           
              END IF 
              #180601-00030#1 --e add
           #200205-00019#1 add(s)
           #只有對帳單有差異折讓的時候 p_type = '4' 才走這段
           ELSE
              SELECT apca011,apca012,apca103,apca101 INTO l_apca011,l_apca012,l_apca103,l_apca101 FROM apca_t
               WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
                 AND apcadocno  =  l_apce.apce003
 
              CALL s_aapt300_not_washed_amt(l_apce.apceld,l_apce.apcedocno,l_apce.apceseq,l_apce.apce003,l_apce.apce004,l_apce.apce005)
                      RETURNING r_apce_w.*
                 
              #剩餘可沖的立帳金額, 而非直接以全額寫入(會造成超沖)    
              CALL s_aapt420_get_contra_amount(l_apce.apceld,l_apce.apcedocno,l_apce.apceseq)RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x 
              
              IF r_apce_w.apce119 > l_amt.apcc11x THEN
              #210218-00022#1---mark--str
              #待抵单的本币金额大于 剩餘可沖的立帳金額 进到IF里
              #然后还需要判断一下原币的金额
              #待抵单的原币金额小于 剩餘可沖的立帳金額，则直接冲账的金额需要用待抵单的金额，不需要把剩餘可沖的立帳金額给直接冲账
#                 IF l_amt.apcc10x != r_apce_w.apce109 THEN
              #210218-00022#1---mark---end
                 IF l_amt.apcc10x < r_apce_w.apce109 THEN  #210218-00022#1---add 
                    LET r_apce_w.apce109 = l_amt.apcc10x 
                    LET r_apce_w.apce119  =  r_apce_w.apce109 *l_apce.apce101
                    CALL s_curr_round_ld('1',l_apce.apceld,l_apce.apce100,r_apce_w.apce109,2) RETURNING g_sub_success,g_errno,r_apce_w.apce109 
                    CALL s_curr_round_ld('1',l_apce.apceld,l_glaa001,r_apce_w.apce119,2) RETURNING g_sub_success,g_errno,r_apce_w.apce119 
                    #立帳單的稅別
                    SELECT apca011 INTO l_apca011_1 FROM apca_t
                     WHERE apcaent = g_enterprise
                       AND apcald = l_apce.apceld
                       AND apcadocno = p_docno
                    IF (l_apca001 = '21') OR (l_apca001 = '23') OR (l_apca001 = '25') THEN
                       LET l_apca011_1 = l_apca011
                    END IF   
                    CALL s_tax_chk(l_apce.apcecomp,l_apca011_1) RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                    LET r_apce_w.apce103 = l_amt.apcc10x / (1 + l_oodb006/100)                                                        
                    CALL s_curr_round_ld('1',p_ld,l_apce.apce100,r_apce_w.apce103,2) RETURNING g_sub_success,g_errno,r_apce_w.apce103 
                 END IF                 
              END IF     
                            
              IF (l_apca103 <> r_apce_w.apce103) OR ((l_apca012_t300 = 0) AND (l_apca012 <> l_apca012_t300))
                 OR (l_apca101 <> l_apce.apce101) #預付單匯率<>待抵單重評匯率時要重推金額
                 THEN 
              
                 #在直接沖帳時都要用預付單的稅別及稅率去做沖帳
                 #但只有立帳單是0%的時候才會用立帳單的0%去計算
                 IF l_apca012_t300 = 0 OR (l_apca001 = '24') THEN
                    LET l_apca011 = l_apca011_t300
                    LET l_apca012 = l_apca012_t300
                 END IF
                 
                 IF cl_null(l_apca011) THEN
                  LET l_apca011 = l_apca011_t300
                 END IF
                 
                 #再根據稅別-含稅否算出稅額 
                 CALL s_tax_chk(l_apce.apcecomp,l_apca011) 
                     RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                 #因為多帳期的金額一定是直接沖帳的含稅金額，所以未稅跟稅額要用反推的
                 LET l_apce.apce104 = l_apce.apce109 * l_oodb006/(l_oodb006+100)
                 CALL s_curr_round_ld('1',l_apce.apceld,l_apce.apce100,l_apce.apce104,2) RETURNING g_sub_success,g_errno,l_apce.apce104 
                 LET l_apce.apce103 = l_apce.apce109 - l_apce.apce104
                 LET l_apce.apce114 = l_apce.apce119 * l_oodb006/(l_oodb006+100)
                 CALL s_curr_round_ld('1',l_apce.apceld,l_glaa001,l_apce.apce114,2) RETURNING g_sub_success,g_errno,l_apce.apce114    
                 LET l_apce.apce113 = l_apce.apce119 - l_apce.apce114
                 #先抓出目前寫到apce的金額
                 SELECT SUM(apce103),SUM(apce104),SUM(apce109),SUM(apce113),SUM(apce114),SUM(apce119) 
                   INTO l_apce103,l_apce104,l_apce109_1,l_apce113,l_apce114,l_apce119_1
                   FROM apce_t
                  WHERE apceent = g_enterprise
                    AND apcedocno = l_apce.apcedocno
                    AND apce003 = l_apce.apce003
                    AND apceld = l_apce.apceld
                 IF cl_null(l_apce103)   THEN LET l_apce103   = 0 END IF
                 IF cl_null(l_apce104)   THEN LET l_apce104   = 0 END IF
                 IF cl_null(l_apce109_1) THEN LET l_apce109_1 = 0 END IF
                 IF cl_null(l_apce113)   THEN LET l_apce113   = 0 END IF
                 IF cl_null(l_apce114)   THEN LET l_apce114   = 0 END IF
                 IF cl_null(l_apce119_1) THEN LET l_apce119_1 = 0 END IF
                 #再去抓aapt341的apcc
                 SELECT SUM(apcc108),SUM(apcc113+apcc118) INTO l_apcc108_1,l_apcc118_1
                   FROM apcc_t
                  WHERE apccent = g_enterprise
                    AND apccdocno = l_apce.apce003
                    AND apccld = l_apce.apceld
                 IF cl_null(l_apcc108_1)   THEN LET l_apcc108_1   = 0 END IF
                 IF cl_null(l_apcc118_1)   THEN LET l_apcc118_1   = 0 END IF
                 IF (l_apce109_1+l_apce.apce109 = l_apcc108_1) AND (l_apce119_1+l_apce.apce119 = l_apcc118_1) THEN
                    SELECT SUM(apcb103),SUM(apcb104),SUM(apcb113),SUM(apcb114) INTO l_apcb103,l_apcb104,l_apcb113,l_apcb114
                      FROM apcb_t
                     WHERE apcbent = g_enterprise
                       AND apcbdocno = l_apce.apce003
                       AND apcbld = l_apce.apceld
                    IF cl_null(l_apcb103)   THEN LET l_apcb103   = 0 END IF
                    IF cl_null(l_apcb104)   THEN LET l_apcb104   = 0 END IF
                    IF cl_null(l_apcb113)   THEN LET l_apcb113   = 0 END IF
                    IF cl_null(l_apcb114)   THEN LET l_apcb114   = 0 END IF   
                    LET l_apce.apce103 = l_apcb103 - l_apce103
                    LET l_apce.apce104 = l_apcb104 - l_apce104
                    LET l_apce.apce113 = l_apcb113 - l_apce113
                    LET l_apce.apce114 = l_apcb114 - l_apce114
                 END IF
              ELSE
                 #全額沖銷直接以預付單金額寫入
                 SELECT apca103,apca104,apca108,
                        apca113,apca114,apca118,
                        apca123,apca124,apca128,
                        apca133,apca134,apca138
                   INTO r_apce_w.apce103,r_apce_w.apce104,r_apce_w.apce109,
                        r_apce_w.apce113,r_apce_w.apce114,r_apce_w.apce119,
                        r_apce_w.apce123,r_apce_w.apce124,r_apce_w.apce129,
                        r_apce_w.apce133,r_apce_w.apce134,r_apce_w.apce139  
                   FROM apca_t
                  WHERE apcaent = g_enterprise AND apcald = l_apce.apceld
                    AND apcadocno IN (SELECT apca019 FROM apca_t WHERE apcaent = g_enterprise 
                                         AND apcald = l_apce.apceld AND apcadocno = l_apce.apce003)   
                                  
                 LET l_apce.apce103   = r_apce_w.apce103
                 LET l_apce.apce104   = r_apce_w.apce104
                 LET l_apce.apce109   = r_apce_w.apce109
                 LET l_apce.apce113   = r_apce_w.apce113
                 LET l_apce.apce114   = r_apce_w.apce114
                 LET l_apce.apce119   = r_apce_w.apce119 
				 
                 #apce113取待底单上得金额, apce119 取apce113 + apce114 ,其他得都是取原单上得金额
                 LET l_apcc113_sum = 0
                 LET l_apcc118_sum = 0
                 SELECT SUM(apcc113),SUM(apcc118) INTO l_apcc113_sum,l_apcc118_sum
                  FROM apcc_t
                 WHERE apccent = g_enterprise
                   AND apccld = l_apce.apceld
                   AND apccdocno = l_apce.apce003
                 IF cl_null(l_apcc113_sum) THEN
                   LET l_apcc113_sum = 0 
                 END IF
                 IF cl_null(l_apcc118_sum) THEN
                   LET l_apcc118_sum = 0 
                 END IF
                 LET l_apce.apce119 = l_apce.apce113 + l_apce.apce114 + l_apcc113_sum #因本幣要加上重評後金額
              END IF 
           END IF 
           #200205-00019#1 add(e)   
        END IF
        #180327-00063#1 add(e)
        #190515-00012#1---mark---(S) 以上面的計算為主
        ##LET l_apce.apce103 = l_apce.apce109 /  (1 + l_apca011 / 100) #160705-00035#5 mark
        # LET l_apce.apce103 = l_apce.apce109 /  (1 + l_apca012 / 100) #160705-00035#5
        # CALL s_curr_round_ld('1',p_ld,l_apce.apce100,l_apce.apce103,2) RETURNING g_sub_success,g_errno,l_apce.apce103
        # LET l_apce.apce104 = l_apce.apce109 - l_apce.apce103
        # #160825-00031#1 Add  ---(E)---
        # CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce.apce119,2) RETURNING g_sub_success,g_errno,l_apce.apce119
        # #160825-00031#1 Add  ---(S)---
        ##LET l_apce.apce113 = l_apce.apce119 /  (1 + l_apca011 / 100) #160705-00035#5 mark
        # LET l_apce.apce113 = l_apce.apce119 /  (1 + l_apca012 / 100) #160705-00035#5
        # CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce.apce113,2) RETURNING g_sub_success,g_errno,l_apce.apce113
        # LET l_apce.apce114 = l_apce.apce119 - l_apce.apce113
        ##160825-00031#1 Add  ---(E)---
        #IF l_glaa015 = 'Y' THEN #180109-00036#1 add
        #   CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apce.apce129,2) RETURNING g_sub_success,g_errno,l_apce.apce129
        #END IF                  #180109-00036#1 add     
        #190515-00012#1---mark---(E)  
      #170728-00027#1-----s
      END IF
      #170728-00027#1-----e
      
      #160825-00031#1 Add  ---(S)---
     #LET l_apce.apce123 = l_apce.apce129 /  (1 + l_apca011 / 100) #160705-00035#5 mark
      IF l_glaa015 = 'Y' THEN #180109-00036#1 add
         LET l_apce.apce123 = l_apce.apce129 /  (1 + l_apca012 / 100) #160705-00035#5
         CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apce.apce123,2) RETURNING g_sub_success,g_errno,l_apce.apce123
         LET l_apce.apce124 = l_apce.apce129 - l_apce.apce123
      END IF                  #180109-00036#1 add
      #160825-00031#1 Add  ---(E)---
      IF l_glaa019 = 'Y' THEN #180109-00036#1 add
         CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apce.apce139,2) RETURNING g_sub_success,g_errno,l_apce.apce139
         #160825-00031#1 Add  ---(S)---
        #LET l_apce.apce133 = l_apce.apce139 /  (1 + l_apca011 / 100) #160705-00035#5 mark
         LET l_apce.apce133 = l_apce.apce139 /  (1 + l_apca012 / 100) #160705-00035#5
         CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apce.apce133,2) RETURNING g_sub_success,g_errno,l_apce.apce133
         LET l_apce.apce134 = l_apce.apce139 - l_apce.apce133
      END IF                  #180109-00036#1 add
      #160825-00031#1 Add  ---(E)---
      #160705-00035#3 -e
      
      #170925-00034#1---add---str--
      IF p_type <> '4' THEN #200205-00019#1 add
         IF l_apce.apce027 = 'N' THEN
            LET l_apce.apce103=l_apce.apce109
            LET l_apce.apce104=0
            LET l_apce.apce113=l_apce.apce119
            LET l_apce.apce114=0
            IF l_glaa015='Y' THEN
               LET l_apce.apce123=l_apce.apce129
               LET l_apce.apce124=0
            END IF
            IF l_glaa019='Y' THEN
               LET l_apce.apce133=l_apce.apce139
               LET l_apce.apce134=0
            END IF
         END IF
      END IF #200205-00019#1 add
      #170925-00034#1---add---end--
      #161102-00015#7 --s add
      IF cl_null(l_apce.apce017) THEN LET l_apce.apce017 = " " END IF  #業務人員
      IF cl_null(l_apce.apce018) THEN LET l_apce.apce018 = " " END IF  #業務部門
      IF cl_null(l_apce.apce019) THEN LET l_apce.apce019 = " " END IF  #責任中心
      IF cl_null(l_apce.apce020) THEN LET l_apce.apce020 = " " END IF  #產品類別
      IF cl_null(l_apce.apce022) THEN LET l_apce.apce022 = " " END IF  #專案編號
      IF cl_null(l_apce.apce023) THEN LET l_apce.apce023 = " " END IF  #WBS編號
      IF cl_null(l_apce.apce035) THEN LET l_apce.apce035 = " " END IF  #區域
      IF cl_null(l_apce.apce036) THEN LET l_apce.apce036 = " " END IF  #客戶分類
      IF cl_null(l_apce.apce038) THEN LET l_apce.apce038 = " " END IF  #帳款對象
      IF cl_null(l_apce.apce044) THEN LET l_apce.apce044 = " " END IF  #經營方式
      IF cl_null(l_apce.apce045) THEN LET l_apce.apce045 = " " END IF  #通路
      IF cl_null(l_apce.apce046) THEN LET l_apce.apce046 = " " END IF  #品牌
      IF cl_null(l_apce.apce051) THEN LET l_apce.apce051 = " " END IF  #自由核算項一
      IF cl_null(l_apce.apce052) THEN LET l_apce.apce052 = " " END IF  #自由核算項二
      IF cl_null(l_apce.apce053) THEN LET l_apce.apce053 = " " END IF  #自由核算項三
      IF cl_null(l_apce.apce054) THEN LET l_apce.apce054 = " " END IF  #自由核算項四
      IF cl_null(l_apce.apce055) THEN LET l_apce.apce055 = " " END IF  #自由核算項五
      IF cl_null(l_apce.apce056) THEN LET l_apce.apce056 = " " END IF  #自由核算項六
      IF cl_null(l_apce.apce057) THEN LET l_apce.apce057 = " " END IF  #自由核算項七
      IF cl_null(l_apce.apce058) THEN LET l_apce.apce058 = " " END IF  #自由核算項八
      IF cl_null(l_apce.apce059) THEN LET l_apce.apce059 = " " END IF  #自由核算項九
      IF cl_null(l_apce.apce060) THEN LET l_apce.apce060 = " " END IF  #自由核算項十
      IF cl_null(l_apce.apce061) THEN LET l_apce.apce061 = " " END IF  #付款對象
      #161102-00015#7 --e add
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apce.apce101) THEN LET l_apce.apce101 = 0 END IF   #匯率
      IF cl_null(l_apce.apce104) THEN LET l_apce.apce104 = 0 END IF   #原幣應稅折抵稅額
      IF cl_null(l_apce.apce109) THEN LET l_apce.apce109 = 0 END IF   #原幣沖帳金額
      IF cl_null(l_apce.apce114) THEN LET l_apce.apce114 = 0 END IF   #本幣應稅折抵稅額
      IF cl_null(l_apce.apce119) THEN LET l_apce.apce119 = 0 END IF   #本幣沖帳金額
      IF cl_null(l_apce.apce124) THEN LET l_apce.apce124 = 0 END IF   #本位幣二應稅折抵稅額
      IF cl_null(l_apce.apce121) THEN LET l_apce.apce121 = 0 END IF   #本位幣二匯率
      IF cl_null(l_apce.apce129) THEN LET l_apce.apce129 = 0 END IF   #本位幣二沖帳金額
      IF cl_null(l_apce.apce131) THEN LET l_apce.apce131 = 0 END IF   #本位幣三匯率
      IF cl_null(l_apce.apce134) THEN LET l_apce.apce134 = 0 END IF   #本位幣三應稅折抵稅額
      IF cl_null(l_apce.apce139) THEN LET l_apce.apce139 = 0 END IF   #本位幣三沖帳金額
      IF cl_null(l_apce.apce103) THEN LET l_apce.apce103 = 0 END IF   #原幣未稅沖銷額
      IF cl_null(l_apce.apce113) THEN LET l_apce.apce113 = 0 END IF   #本幣未稅沖銷額
      IF cl_null(l_apce.apce123) THEN LET l_apce.apce123 = 0 END IF   #本位幣二未稅沖銷額
      IF cl_null(l_apce.apce133) THEN LET l_apce.apce133 = 0 END IF   #本位幣三未稅沖銷額
      
      IF l_apce.apce109 <= 0 THEN CONTINUE FOREACH END IF      #180911-00042#1 add
      #180130-00050#5---add by 10554---(E) 
     #INSERT INTO apce_t VALUES(l_apce.*) #161111-00048#2 mark
      #161111-00048#2 --s add
      INSERT INTO apce_t(apceent,apcecomp,apcelegl,apcesite,apceld,
                         apceorga,apcedocno,apceseq,apce001,apce002,
                         apce003,apce004,apce005,apce006,apce007,
                         apce008,apce009,apce010,apce011,apce012,
                         apce013,apce014,apce015,apce016,apce017,
                         apce018,apce019,apce020,apce021,apce022,
                         apce023,apce024,apce025,apce026,apce027,
                         apce028,apce029,apce030,apce031,apce032,
                         apce033,apce034,apce035,apce036,apce037,
                         apce038,apce039,apce040,apce041,apce042,
                         apce043,apce044,apce045,apce046,apce047,
                         apce048,apce049,apce050,apce051,apce052,
                         apce053,apce054,apce055,apce056,apce057,
                         apce058,apce059,apce060,apce100,apce101,
                         apce104,apce109,apce114,apce119,apce120,
                         apce124,apce121,apce129,apce130,apce131,
                         apce134,apce139,apceud001,apceud002,apceud003,
                         apceud004,apceud005,apceud006,apceud007,apceud008,
                         apceud009,apceud010,apceud011,apceud012,apceud013,
                         apceud014,apceud015,apceud016,apceud017,apceud018,
                         apceud019,apceud020,apceud021,apceud022,apceud023,
                         apceud024,apceud025,apceud026,apceud027,apceud028,
                         apceud029,apceud030,apce103,apce113,apce123,
                         apce133,apce061)
      VALUES(l_apce.apceent,l_apce.apcecomp,l_apce.apcelegl,l_apce.apcesite,l_apce.apceld,
             l_apce.apceorga,l_apce.apcedocno,l_apce.apceseq,l_apce.apce001,l_apce.apce002,
             l_apce.apce003,l_apce.apce004,l_apce.apce005,l_apce.apce006,l_apce.apce007,
             l_apce.apce008,l_apce.apce009,l_apce.apce010,l_apce.apce011,l_apce.apce012,
             l_apce.apce013,l_apce.apce014,l_apce.apce015,l_apce.apce016,l_apce.apce017,
             l_apce.apce018,l_apce.apce019,l_apce.apce020,l_apce.apce021,l_apce.apce022,
             l_apce.apce023,l_apce.apce024,l_apce.apce025,l_apce.apce026,l_apce.apce027,
             l_apce.apce028,l_apce.apce029,l_apce.apce030,l_apce.apce031,l_apce.apce032,
             l_apce.apce033,l_apce.apce034,l_apce.apce035,l_apce.apce036,l_apce.apce037,
             l_apce.apce038,l_apce.apce039,l_apce.apce040,l_apce.apce041,l_apce.apce042,
             l_apce.apce043,l_apce.apce044,l_apce.apce045,l_apce.apce046,l_apce.apce047,
             l_apce.apce048,l_apce.apce049,l_apce.apce050,l_apce.apce051,l_apce.apce052,
             l_apce.apce053,l_apce.apce054,l_apce.apce055,l_apce.apce056,l_apce.apce057,
             l_apce.apce058,l_apce.apce059,l_apce.apce060,l_apce.apce100,l_apce.apce101,
             l_apce.apce104,l_apce.apce109,l_apce.apce114,l_apce.apce119,l_apce.apce120,
             l_apce.apce124,l_apce.apce121,l_apce.apce129,l_apce.apce130,l_apce.apce131,
             l_apce.apce134,l_apce.apce139,l_apce.apceud001,l_apce.apceud002,l_apce.apceud003,
             l_apce.apceud004,l_apce.apceud005,l_apce.apceud006,l_apce.apceud007,l_apce.apceud008,
             l_apce.apceud009,l_apce.apceud010,l_apce.apceud011,l_apce.apceud012,l_apce.apceud013,
             l_apce.apceud014,l_apce.apceud015,l_apce.apceud016,l_apce.apceud017,l_apce.apceud018,
             l_apce.apceud019,l_apce.apceud020,l_apce.apceud021,l_apce.apceud022,l_apce.apceud023,
             l_apce.apceud024,l_apce.apceud025,l_apce.apceud026,l_apce.apceud027,l_apce.apceud028,
             l_apce.apceud029,l_apce.apceud030,l_apce.apce103,l_apce.apce113,l_apce.apce123,
             l_apce.apce133,l_apce.apce061)
      #161111-00048#2 --e add
   END FOREACH
END FUNCTION
################################################################################
# Descriptions...: 將立帳與沖帳差異金額寫入apde差異檔案
# Memo...........:
# Usage..........: 
# Date & Author..: 14/11/24 By apo
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apce_diff(p_ld,p_docno)
DEFINE p_ld             LIKE apca_t.apcald                #帳別
DEFINE p_docno          LIKE apca_t.apcadocno             #立帳單據
#DEFINE l_apca           RECORD LIKE apca_t.*              #立帳單頭資訊 #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
#161111-00048#2 --e add
DEFINE l_apca_amt       RECORD                            #應付立帳金額
                        apcc10x    LIKE type_t.num20_6,
                        apcc11x    LIKE type_t.num20_6
                        END RECORD
DEFINE l_apce_amt       RECORD                            #直接沖帳金額
                        apce10x    LIKE type_t.num20_6,
                        apce11x    LIKE type_t.num20_6
                        END RECORD
DEFINE l_glaa001        LIKE glaa_t.glaa001
DEFINE l_apca044        LIKE apca_t.apca044
#DEFINE l_apde           RECORD LIKE apde_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apde RECORD  #付款及差異處理明細檔
       apdeent LIKE apde_t.apdeent, #企業編號
       apdecomp LIKE apde_t.apdecomp, #法人
       apdeld LIKE apde_t.apdeld, #帳套
       apdedocno LIKE apde_t.apdedocno, #沖銷單單號
       apdeseq LIKE apde_t.apdeseq, #項次
       apdesite LIKE apde_t.apdesite, #帳務中心
       apdeorga LIKE apde_t.apdeorga, #帳務歸屬組織
       apde001 LIKE apde_t.apde001, #來源作業
       apde002 LIKE apde_t.apde002, #沖銷帳款類型
       apde003 LIKE apde_t.apde003, #已付款單號
       apde004 LIKE apde_t.apde004, #沖銷單項次
       apde006 LIKE apde_t.apde006, #款別編號
       apde008 LIKE apde_t.apde008, #帳戶/票券號碼
       apde009 LIKE apde_t.apde009, #已轉資料
       apde010 LIKE apde_t.apde010, #摘要說明
       apde011 LIKE apde_t.apde011, #銀行存提碼
       apde012 LIKE apde_t.apde012, #現金變動碼
       apde013 LIKE apde_t.apde013, #轉入客商碼
       apde014 LIKE apde_t.apde014, #轉入帳款單編號
       apde015 LIKE apde_t.apde015, #沖銷加減項
       apde016 LIKE apde_t.apde016, #沖銷會科
       apde017 LIKE apde_t.apde017, #業務人員
       apde018 LIKE apde_t.apde018, #業務部門
       apde019 LIKE apde_t.apde019, #責任中心
       apde020 LIKE apde_t.apde020, #產品類別
       apde021 LIKE apde_t.apde021, #票據類型
       apde022 LIKE apde_t.apde022, #專案編號
       apde023 LIKE apde_t.apde023, #WBS編號
       apde024 LIKE apde_t.apde024, #票據號碼
       apde028 LIKE apde_t.apde028, #產生方式
       apde029 LIKE apde_t.apde029, #傳票號碼
       apde030 LIKE apde_t.apde030, #傳票項次
       apde032 LIKE apde_t.apde032, #付款日
       apde035 LIKE apde_t.apde035, #區域
       apde036 LIKE apde_t.apde036, #客群
       apde038 LIKE apde_t.apde038, #對象
       apde039 LIKE apde_t.apde039, #受款銀行
       apde040 LIKE apde_t.apde040, #受款帳號
       apde041 LIKE apde_t.apde041, #受款人全名
       apde042 LIKE apde_t.apde042, #經營方式
       apde043 LIKE apde_t.apde043, #通路
       apde044 LIKE apde_t.apde044, #品牌
       apde045 LIKE apde_t.apde045, #摘要
       apde046 LIKE apde_t.apde046, #付款申請單
       apde047 LIKE apde_t.apde047, #付款申請單項次
       apde051 LIKE apde_t.apde051, #自由核算項一
       apde052 LIKE apde_t.apde052, #自由核算項二
       apde053 LIKE apde_t.apde053, #自由核算項三
       apde054 LIKE apde_t.apde054, #自由核算項四
       apde055 LIKE apde_t.apde055, #自由核算項五
       apde056 LIKE apde_t.apde056, #自由核算項六
       apde057 LIKE apde_t.apde057, #自由核算項七
       apde058 LIKE apde_t.apde058, #自由核算項八
       apde059 LIKE apde_t.apde059, #自由核算項九
       apde060 LIKE apde_t.apde060, #自由核算項十
       apde100 LIKE apde_t.apde100, #幣別
       apde101 LIKE apde_t.apde101, #匯率
       apde104 LIKE apde_t.apde104, #原幣應稅折抵稅額
       apde109 LIKE apde_t.apde109, #原幣沖帳金額
       apde119 LIKE apde_t.apde119, #本幣沖帳金額
       apde120 LIKE apde_t.apde120, #本位幣二幣別
       apde121 LIKE apde_t.apde121, #本位幣二匯率
       apde129 LIKE apde_t.apde129, #本位幣二沖帳金額
       apde130 LIKE apde_t.apde130, #本位幣三幣別
       apde131 LIKE apde_t.apde131, #本位幣三匯率
       apde139 LIKE apde_t.apde139, #本位幣三沖帳金額
       apdeud001 LIKE apde_t.apdeud001, #自定義欄位(文字)001
       apdeud002 LIKE apde_t.apdeud002, #自定義欄位(文字)002
       apdeud003 LIKE apde_t.apdeud003, #自定義欄位(文字)003
       apdeud004 LIKE apde_t.apdeud004, #自定義欄位(文字)004
       apdeud005 LIKE apde_t.apdeud005, #自定義欄位(文字)005
       apdeud006 LIKE apde_t.apdeud006, #自定義欄位(文字)006
       apdeud007 LIKE apde_t.apdeud007, #自定義欄位(文字)007
       apdeud008 LIKE apde_t.apdeud008, #自定義欄位(文字)008
       apdeud009 LIKE apde_t.apdeud009, #自定義欄位(文字)009
       apdeud010 LIKE apde_t.apdeud010, #自定義欄位(文字)010
       apdeud011 LIKE apde_t.apdeud011, #自定義欄位(數字)011
       apdeud012 LIKE apde_t.apdeud012, #自定義欄位(數字)012
       apdeud013 LIKE apde_t.apdeud013, #自定義欄位(數字)013
       apdeud014 LIKE apde_t.apdeud014, #自定義欄位(數字)014
       apdeud015 LIKE apde_t.apdeud015, #自定義欄位(數字)015
       apdeud016 LIKE apde_t.apdeud016, #自定義欄位(數字)016
       apdeud017 LIKE apde_t.apdeud017, #自定義欄位(數字)017
       apdeud018 LIKE apde_t.apdeud018, #自定義欄位(數字)018
       apdeud019 LIKE apde_t.apdeud019, #自定義欄位(數字)019
       apdeud020 LIKE apde_t.apdeud020, #自定義欄位(數字)020
       apdeud021 LIKE apde_t.apdeud021, #自定義欄位(日期時間)021
       apdeud022 LIKE apde_t.apdeud022, #自定義欄位(日期時間)022
       apdeud023 LIKE apde_t.apdeud023, #自定義欄位(日期時間)023
       apdeud024 LIKE apde_t.apdeud024, #自定義欄位(日期時間)024
       apdeud025 LIKE apde_t.apdeud025, #自定義欄位(日期時間)025
       apdeud026 LIKE apde_t.apdeud026, #自定義欄位(日期時間)026
       apdeud027 LIKE apde_t.apdeud027, #自定義欄位(日期時間)027
       apdeud028 LIKE apde_t.apdeud028, #自定義欄位(日期時間)028
       apdeud029 LIKE apde_t.apdeud029, #自定義欄位(日期時間)029
       apdeud030 LIKE apde_t.apdeud030, #自定義欄位(日期時間)030
       apde061 LIKE apde_t.apde061  #應付來源
END RECORD
#161111-00048#2 --e add
#170519-00002#1 --s add
DEFINE l_apcc108    LIKE apcc_t.apcc108
DEFINE l_sql        STRING
DEFINE l_apce003    LIKE apce_t.apce003
DEFINE l_apce004    LIKE apce_t.apce004
DEFINE l_apce005    LIKE apce_t.apce005
DEFINE l_apce109    LIKE apce_t.apce109
DEFINE l_count      LIKE type_t.num10
#170519-00002#1 --e add

CALL s_aapp131_ins_apce_diff_part(p_ld,p_docno) #170720-00015#1--add
# #170720-00015#1--mark---str
#   #取得單頭資訊
#   #SELECT * INTO l_apca.* FROM apca_t   #161208-00026#22   mark
#   #161208-00026#22   add---s
#   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
#          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
#          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
#          apcadocno,apcadocdt,apcasite,apca001,apca003,
#          apca004,apca005,apca006,apca007,apca008,
#          apca009,apca010,apca011,apca012,apca013,
#          apca014,apca015,apca016,apca017,apca018,
#          apca019,apca020,apca021,apca022,apca025,
#          apca026,apca027,apca028,apca029,apca030,
#          apca031,apca032,apca033,apca034,apca035,
#          apca036,apca037,apca038,apca039,apca040,
#          apca041,apca042,apca043,apca044,apca045,
#          apca046,apca047,apca048,apca049,apca050,
#          apca051,apca052,apca053,apca054,apca055,
#          apca056,apca057,apca058,apca059,apca060,
#          apca061,apca062,apca063,apca064,apca065,
#          apca066,apca100,apca101,apca103,apca104,
#          apca106,apca107,apca108,apca113,apca114,
#          apca116,apca117,apca118,apca120,apca121,
#          apca123,apca124,apca126,apca127,apca128,
#          apca130,apca131,apca133,apca134,apca136,
#          apca137,apca138,apcaud001,apcaud002,apcaud003,
#          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
#          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
#          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
#          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
#          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
#          apcaud029,apcaud030,apca067,apca068,apca069,
#          apca070,apca071,apca072,apca073
#     INTO l_apca.*
#     FROM apca_t
#   #161208-00026#22   add---e
#    WHERE apcaent = g_enterprise
#       AND apcald = p_ld AND apcadocno = p_docno
#   CALL s_ld_sel_glaa(l_apca.apcald,'glaa001') RETURNING g_sub_success,l_glaa001
#
#   #取得應付帳款立帳金額
#   LET l_apca_amt.apcc10x = l_apca.apca103 + l_apca.apca104
#   LET l_apca_amt.apcc11x = l_apca.apca113 + l_apca.apca114
#
#   #取得直接沖帳單身金額合計
#   SELECT SUM(apce109),SUM(apce119) INTO l_apce_amt.apce10x,l_apce_amt.apce11x FROM apca_t,apce_t   #150316apo add apca_t
#    WHERE apceent = g_enterprise
#      AND apceld = l_apca.apcald
#      AND apcedocno = l_apca.apcadocno   
#      #--150316apo--(s)
#      AND apcaent = apceent     
#      AND apcald  = apceld     
#      AND apcadocno = apcedocno  
#      AND apcastus NOT IN ('X')         
#      #--150316apo--(e)      
#      AND apce001 <> 'aapt430'  #150212      
#   IF cl_null(l_apce_amt.apce10x) THEN LET l_apce_amt.apce10x = 0 END IF
#   IF cl_null(l_apce_amt.apce11x) THEN LET l_apce_amt.apce11x = 0 END IF
#   
#   #原幣差異金額 = 原幣立帳金額-直接沖帳金額
#   LET l_apde.apde109 = l_apca_amt.apcc10x - l_apce_amt.apce10x
#   #本幣差異金額 = 本幣立帳金額-直接沖帳金額
#   LET l_apde.apde119 = l_apca_amt.apcc11x - l_apce_amt.apce11x
#
#   #170519-00002#1 --s mark
#   ##161202-00051#1 --s add
#   ##原幣未沖完(部分沖),計算匯差差異
#   #IF l_apde.apde109 <> 0 THEN
#   #170519-00002#1 --e mark
#   #170519-00002#1 --s add
#   LET l_count = 0 
#   LET l_apce003 = ''   LET l_apce004 = ''    
#   LET l_apce005 = ''   LET l_apce109 = 0
#   LET l_sql = "SELECT apce003,apce004,apce005,apce109 FROM apce_t ",
#               " WHERE apceent = ",g_enterprise," ",
#               "   AND apcedocno = '",p_docno,"' ",
#               "   AND apceld = '",p_ld,"' "
#   PREPARE sel_apcep1 FROM l_sql
#   DECLARE sel_apcec1 CURSOR FOR sel_apcep1
#   FOREACH sel_apcec1 INTO l_apce003,l_apce004,l_apce005,l_apce109
#      IF sqlca.sqlcode THEN EXIT FOREACH END IF
#      IF cl_null(l_apce109) THEN LET l_apce109 = 0 END IF
#      LET l_apcc108 = NULL
#      SELECT apcc108 INTO l_apcc108 FROM apcc_t
#       WHERE apccent = g_enterprise
#         AND apccdocno = l_apce003
#         AND apccld    = p_ld
#         AND apccseq   = l_apce004
#         AND apcc001   = l_apce005
#      IF cl_null(l_apcc108)THEN LET l_apcc108 = 0 END IF
#
#      IF l_apcc108 <> l_apce109 THEN
#         LET l_count = 1 
#         EXIT FOREACH
#      END IF
#   END FOREACH
#
#   IF l_count = 1 THEN
#   #170519-00002#1 --e add    
#      CALL s_aapp131_ins_apce_diff_part(p_ld,p_docno)
#   END IF
#   #161202-00051#1 --e add      
#   
#   #原幣已沖完,本幣卻有差異者,以匯差差異處理
#   IF l_apde.apde109 = 0 AND l_apde.apde119 <> 0 THEN
#      LET l_apde.apdeent  =l_apca.apcaent
#      LET l_apde.apdeld =l_apca.apcald
#      LET l_apde.apdecomp =l_apca.apcacomp
#      LET l_apde.apdeorga =l_apca.apcacomp
#      LET l_apde.apdesite =l_apca.apcasite
#      LET l_apde.apdedocno =l_apca.apcadocno
#      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
#       WHERE apdeent   = l_apde.apdeent
#         AND apdeld    = l_apde.apdeld
#         AND apdedocno = l_apde.apdedocno
#      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
#      LET l_apde.apdeseq = l_apde.apdeseq + 1
#      LET l_apde.apde001 = 'aapt300'
#      LET l_apde.apde009 = 'N'
#      LET l_apde.apde028 = '0'
#      
#      LET l_apde.apde006 = '10'     #預設現金可改     #161026-00048#1
#      IF l_apde.apde119 < 0 THEN     #立帳 < 沖帳
#         LET l_apde.apde002 = '11'   #屬於匯兌損失
#         #161026-00048#1-----s
#         LET l_apde.apde016 = s_aapt420_bring_acc_code2(l_apde.apdeld,l_apde.apdesite,l_apde.apde038,l_apde.apde002,l_apde.apde006,l_apde.apde008)
#         #161026-00048#1-----e
#      ELSE                           #立帳 > 沖帳
#         LET l_apde.apde002 = '12'   #屬於匯兌收益
#         #161026-00048#1-----s
#         LET l_apde.apde016 = s_aapt420_bring_acc_code2(l_apde.apdeld,l_apde.apdesite,l_apde.apde038,l_apde.apde002,l_apde.apde006,l_apde.apde008)
#         #161026-00048#1-----e
#      END IF
#      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
#      #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
#      LET l_apde.apde119 = s_math_abs(l_apde.apde119)
#   
#      #LET l_apde.apde006 = '10'     #預設現金可改     #161026-00048#1 mark
#
#   
#      #銀行存提碼
#      LET l_apde.apde011 = ''
#      #現金變動碼
#      LET l_apde.apde012 = ''
#   
#      LET l_apde.apde013 = ''
#      LET l_apde.apde014 = ''
#      #LET l_apde.apde016 = ''    #161026-00048#1 mark
#   
#      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
#   
#      LET l_apde.apde032 = l_apca.apcadocdt
#      
#      #LET l_apde.apde100 = l_glaa001   #170322-00115#1 add  #170324-00130#1 mark
#      #170324-00130#1 --s add 以原幣幣別寫入直接付款
#      LET l_apde.apde100 = l_apca.apca100                    
#      LET l_apde.apde109 = 0
#      #170324-00130#1 --e add
#   
#      INSERT INTO apde_t(apdeent,
#                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
#                         apde001,apde009,apde028,apde002,apde015,
#                         apde003,apde004,apdeorga,apde006,apde011,
#                         apde012,apde013,apde014,apde016,apde017,
#                         apde018,apde021,apde032,apde100,apde101,
#                         apde109,apde119)
#             VALUES(l_apde.apdeent,
#                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
#                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
#                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
#                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
#                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
#                    l_apde.apde109,l_apde.apde119)
#      IF SQLCA.SQLCODE THEN END IF 
#   END IF
##170720-00015#1--mark---end
END FUNCTION

################################################################################
# Descriptions...: 全部入庫單數量一次立帳時,金額從來源單據取得
# Memo...........:
# Usage..........: CALL s_aapp131_entire_amount(p_type,p_apcb)
#                  RETURNING r_apcb
# Input parameter: p_type         1:aapp131/2:aapp132/3:aapp133
#                : p_apcb         apcb資訊
# Return code....: r_apcb         來源單據資訊
# Date & Author..: 15/01/29 By apo(#141204-00017#1)
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_entire_amount(p_type,p_apcb)
DEFINE p_type           LIKE type_t.chr1      #類型(1:p131/2:p132/3:p133)
DEFINE p_apcb           RECORD
       apcbld              LIKE apcb_t.apcbld,
       apcbdocno           LIKE apcb_t.apcbdocno,
       apcbseq             LIKE apcb_t.apcbseq,
       apcb002             LIKE apcb_t.apcb002,
       apcb003             LIKE apcb_t.apcb003,
       apcb049             LIKE apcb_t.apcb049,
       apcb050             LIKE apcb_t.apcb050,
       apcb103             LIKE apcb_t.apcb103,
       apcb104             LIKE apcb_t.apcb104,
       apcb105             LIKE apcb_t.apcb105,
       apcb113             LIKE apcb_t.apcb113,
       apcb114             LIKE apcb_t.apcb114,
       apcb115             LIKE apcb_t.apcb115,
       apcb102             LIKE apcb_t.apcb102     #匯率       
                        END RECORD             
DEFINE r_apcb           RECORD
       apcb103             LIKE apcb_t.apcb103,
       apcb104             LIKE apcb_t.apcb104,
       apcb105             LIKE apcb_t.apcb105,
       apcb113             LIKE apcb_t.apcb113,
       apcb114             LIKE apcb_t.apcb114,
       apcb115             LIKE apcb_t.apcb115
                        END RECORD
DEFINE l_glaacomp       LIKE glaa_t.glaacomp    #150210apo 
DEFINE l_sfin3012       LIKE type_t.chr1        #150210apo
DEFINE l_apca100        LIKE apca_t.apca100     
DEFINE l_glaa001        LIKE glaa_t.glaa001
DEFINE l_ooaj004        LIKE ooaj_t.ooaj004     #170430-00006#2
DEFINE l_ooaj004_g      LIKE ooaj_t.ooaj004     #170430-00006#2
DEFINE l_str            STRING                  #170430-00006#2

   #150210apo--(s)
  #CALL s_ld_sel_glaa(p_apcb.apcbld,'glaacomp|glaa001') RETURNING  g_sub_success,l_glaacomp,l_glaa001  #170430-00006#2 mark
  #CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012                         #170430-00006#2 mark
  #170430-00006#2---add---start---  
  SELECT ooaj004 INTO l_ooaj004 FROM ooaj_t
   WHERE ooajent = g_enterprise 
     AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_apcb.apcbld)
     AND ooaj002 = (SELECT apca100 FROM apca_t WHERE apcaent = g_enterprise AND apcald = p_apcb.apcbld AND apcadocno = p_apcb.apcbdocno)
  SELECT ooaj004 INTO l_ooaj004_g FROM ooaj_t
   WHERE ooajent = g_enterprise 
     AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_apcb.apcbld)
     AND ooaj002 = (SELECT glaa001 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_apcb.apcbld)
  IF cl_null(g_round_type) THEN
     LET g_round_type = cl_get_para(g_enterprise,'','E-COM-0006')
     LET l_str = g_round_type
     LET g_round_type = l_str.trim()
  END IF
  #170430-00006#2---add---end---
   #150210apo--(e)
    
   CASE p_type
      #aapp131
      WHEN '1'
           #來源入庫單
           #150215改以pmdt取資料
           SELECT pmdt038,pmdt047,pmdt039 INTO r_apcb.apcb103,r_apcb.apcb104,r_apcb.apcb105
             FROM pmdt_t
            WHERE pmdtent = g_enterprise
              AND pmdtdocno = p_apcb.apcb002
              AND pmdtseq = p_apcb.apcb003
           IF cl_null(r_apcb.apcb103) THEN LET r_apcb.apcb103 = 0 END IF
           IF cl_null(r_apcb.apcb104) THEN LET r_apcb.apcb104 = 0 END IF
           IF cl_null(r_apcb.apcb105) THEN LET r_apcb.apcb105 = 0 END IF
           SELECT glaacomp INTO l_glaacomp FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_apcb.apcbld  #170430-00006#2 add
           CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012      #170430-00006#2 add
           #150210apo--(s)
           IF l_sfin3012 = '1' THEN  #應付暫估立帳選項(1:不含稅)
                 LET r_apcb.apcb105 = r_apcb.apcb103
                 LET r_apcb.apcb104 = 0
           END IF
           #150210apo--(e)                 
           #匯率       #1502113--Belle add
           IF p_apcb.apcb102 = 1 THEN
              LET r_apcb.apcb113 = r_apcb.apcb103
              LET r_apcb.apcb114 = r_apcb.apcb104
              LET r_apcb.apcb115 = r_apcb.apcb105    
              UPDATE xrcd_t
                 SET (xrcd113,xrcd114,xrcd115) = (r_apcb.apcb113,r_apcb.apcb114,r_apcb.apcb115)
               WHERE xrcdent   = g_enterprise
                 AND xrcdld    = p_apcb.apcbld
                 AND xrcddocno = p_apcb.apcbdocno
                 AND xrcdseq   = p_apcb.apcbseq           
           ELSE
              #入庫單本幣匯率一定為1,故不取用
              LET r_apcb.apcb113 = p_apcb.apcb113
              LET r_apcb.apcb114 = p_apcb.apcb114
              LET r_apcb.apcb115 = p_apcb.apcb115                
           END IF
          
           UPDATE xrcd_t
              SET (xrcd103,xrcd104,xrcd105) = (r_apcb.apcb103,r_apcb.apcb104,r_apcb.apcb105)
            WHERE xrcdent   = g_enterprise
              AND xrcdld    = p_apcb.apcbld
              AND xrcddocno = p_apcb.apcbdocno
              AND xrcdseq   = p_apcb.apcbseq              
      #aapp132              
      WHEN '2'
           #來源對帳單
           SELECT apba103,apba104,apba105,apba113,apba114,apba115 INTO r_apcb.*
             FROM apba_t
            WHERE apbaent = g_enterprise
              AND apbadocno = p_apcb.apcb049
              AND apbaseq = p_apcb.apcb050
           IF cl_null(r_apcb.apcb103) THEN LET r_apcb.apcb103 = 0 END IF
           IF cl_null(r_apcb.apcb104) THEN LET r_apcb.apcb104 = 0 END IF
           IF cl_null(r_apcb.apcb105) THEN LET r_apcb.apcb105 = 0 END IF 
           IF cl_null(r_apcb.apcb113) THEN LET r_apcb.apcb113 = 0 END IF
           IF cl_null(r_apcb.apcb114) THEN LET r_apcb.apcb114 = 0 END IF
           IF cl_null(r_apcb.apcb115) THEN LET r_apcb.apcb115 = 0 END IF           
           UPDATE xrcd_t
              SET (xrcd103,xrcd104,xrcd105,xrcd113,xrcd114,xrcd115)
                = (r_apcb.apcb103,r_apcb.apcb104,r_apcb.apcb105,r_apcb.apcb113,r_apcb.apcb114,r_apcb.apcb115)
            WHERE xrcdent   = g_enterprise
              AND xrcdld    = p_apcb.apcbld
              AND xrcddocno = p_apcb.apcbdocno
              AND xrcdseq   = p_apcb.apcbseq
       
      #aapp133
      WHEN '3'
           #來源入庫單
           SELECT pmdt038,pmdt047,pmdt039 INTO r_apcb.apcb103,r_apcb.apcb104,r_apcb.apcb105
             FROM pmdt_t
            WHERE pmdtent = g_enterprise
              AND pmdtdocno = p_apcb.apcb002
              AND pmdtseq = p_apcb.apcb003
           IF cl_null(r_apcb.apcb103) THEN LET r_apcb.apcb103 = 0 END IF
           IF cl_null(r_apcb.apcb104) THEN LET r_apcb.apcb104 = 0 END IF
           IF cl_null(r_apcb.apcb105) THEN LET r_apcb.apcb105 = 0 END IF            
           #匯率       #1502113--Belle add
           IF p_apcb.apcb102 = 1 THEN
              LET r_apcb.apcb113 = r_apcb.apcb103
              LET r_apcb.apcb114 = r_apcb.apcb104
              LET r_apcb.apcb115 = r_apcb.apcb105    
              UPDATE xrcd_t
                 SET (xrcd113,xrcd114,xrcd115) = (r_apcb.apcb113,r_apcb.apcb114,r_apcb.apcb115)
               WHERE xrcdent   = g_enterprise
                 AND xrcdld    = p_apcb.apcbld
                 AND xrcddocno = p_apcb.apcbdocno
                 AND xrcdseq   = p_apcb.apcbseq           
           ELSE           
              #入庫單本幣匯率一定為1,故不取用
              LET r_apcb.apcb113 = p_apcb.apcb113
              LET r_apcb.apcb114 = p_apcb.apcb114
              LET r_apcb.apcb115 = p_apcb.apcb115
           END IF
           UPDATE xrcd_t
              SET (xrcd103,xrcd104,xrcd105) = (r_apcb.apcb103,r_apcb.apcb104,r_apcb.apcb105)
            WHERE xrcdent   = g_enterprise
              AND xrcdld    = p_apcb.apcbld            
              AND xrcddocno = p_apcb.apcbdocno
              AND xrcdseq   = p_apcb.apcbseq           
   END CASE
  #170430-00006#231---mark---start---
  #SELECT apca100 INTO l_apca100
  #  FROM apca_t
  # WHERE apcaent = g_enterprise
  #   AND apcald = p_apcb.apcbld AND apcadocno = p_apcb.apcbdocno
  #
  #CALL s_curr_round_ld('1',p_apcb.apcbld,l_apca100,r_apcb.apcb103,2) RETURNING g_sub_success,g_errno,r_apcb.apcb103
  #CALL s_curr_round_ld('1',p_apcb.apcbld,l_apca100,r_apcb.apcb104,2) RETURNING g_sub_success,g_errno,r_apcb.apcb104
  #CALL s_curr_round_ld('1',p_apcb.apcbld,l_apca100,r_apcb.apcb105,2) RETURNING g_sub_success,g_errno,r_apcb.apcb105
  #CALL s_curr_round_ld('1',p_apcb.apcbld,l_glaa001,r_apcb.apcb113,2) RETURNING g_sub_success,g_errno,r_apcb.apcb113
  #CALL s_curr_round_ld('1',p_apcb.apcbld,l_glaa001,r_apcb.apcb114,2) RETURNING g_sub_success,g_errno,r_apcb.apcb114
  #CALL s_curr_round_ld('1',p_apcb.apcbld,l_glaa001,r_apcb.apcb115,2) RETURNING g_sub_success,g_errno,r_apcb.apcb115
  #170430-00006#2---mark---end---
  #170430-00006#231---add--start---
  CALL s_num_round(g_round_type,r_apcb.apcb103,l_ooaj004)   RETURNING r_apcb.apcb103 
  CALL s_num_round(g_round_type,r_apcb.apcb104,l_ooaj004)   RETURNING r_apcb.apcb104 
  CALL s_num_round(g_round_type,r_apcb.apcb105,l_ooaj004)   RETURNING r_apcb.apcb105 
  CALL s_num_round(g_round_type,r_apcb.apcb113,l_ooaj004_g) RETURNING r_apcb.apcb113 
  CALL s_num_round(g_round_type,r_apcb.apcb114,l_ooaj004_g) RETURNING r_apcb.apcb114 
  CALL s_num_round(g_round_type,r_apcb.apcb115,l_ooaj004_g) RETURNING r_apcb.apcb115 
  #170430-00006#2---add---end---
   RETURN r_apcb.*
END FUNCTION
################################################################################
# Descriptions...: 取得應稅折抵否
# Memo...........:
# Usage..........: CALL s_aapp131_get_apce027(p_apca019)
#                  RETURNING r_apce027
# Input parameter: p_apca019      待抵單號
# Return code....: r_apce027      應稅折抵否
# Date & Author..: 14/10/26 By apo(#150316apo)
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_get_apce027(p_apca019)
DEFINE p_apca019     LIKE apca_t.apca019
DEFINE r_apce027     LIKE apce_t.apce027
DEFINE l_apca060     LIKE apca_t.apca060
DEFINE l_apca104     LIKE apca_t.apca104   #170922-00011#1 add
DEFINE l_apca001     LIKE apca_t.apca001   #170925-00034#1 add

   #170922-00011#1---mark---str--
   #SELECT apca060 INTO l_apca060 FROM apca_t
   # WHERE apcaent = g_enterprise
   #   AND apca019 = p_apca019
   #
   #IF l_apca060 = '2' THEN   #開立增值稅發票
   #   LET r_apce027 = 'Y'
   #ELSE
   #   LET r_apce027 = 'N'
   #END IF
   #170922-00011#1---mark---end--

   #170922-00011#1---add---str--
   LET l_apca104 = 0
   SELECT apca001,apca104 INTO l_apca001,l_apca104 FROM apca_t   #170925-00034#1 add apca001
    WHERE apcaent = g_enterprise
      AND apca019 = p_apca019

   IF cl_null(l_apca104) THEN LET l_apca104 = 0 END IF
   IF l_apca104 = 0 THEN   #來源單據單頭稅額=0 則應稅扣抵=N
      LET r_apce027 = 'N'
   ELSE
      LET r_apce027 = 'Y'
   END IF
   #170922-00011#1---add---end--
   #170925-00034#1---add---str--
   IF l_apca001 = '22' OR l_apca001 = '29' THEN
      LET r_apce027 = 'N'
   END IF
   #170925-00034#1---add---end--
   RETURN r_apce027
END FUNCTION

################################################################################
# Descriptions...: 取得前端來源資料設定(人員/部門)
# Memo...........:
# Date & Author..: 15/03/21 By Belle
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_get_apcb010(p_apcb001,p_docno,p_seq)
DEFINE p_apcb001   LIKE apcb_t.apcb001
DEFINE p_docno     LIKE apcb_t.apcbdocno
DEFINE p_seq       LIKE apcb_t.apcbseq
DEFINE r_ar        DYNAMIC ARRAY OF RECORD
              chr  LIKE type_t.chr500
               END RECORD
DEFINE l_pmdt      RECORD
         pmdtdocno LIKE pmdt_t.pmdtdocno
               END RECORD
DEFINE l_pmds      RECORD
         pmds002   LIKE pmds_t.pmds002,
         pmds003   LIKE pmds_t.pmds003
               END RECORD
DEFINE l_pmdl      RECORD
         pmdl002   LIKE pmdl_t.pmdl002,
         pmdl003   LIKE pmdl_t.pmdl003
               END RECORD
DEFINE l_pmdn      RECORD
         pmdndocno LIKE pmdn_t.pmdndocno,
         pmdnseq   LIKE pmdn_t.pmdnseq
               END RECORD
DEFINE l_pmdadocno LIKE pmda_t.pmdadocno
DEFINE l_pmda002   LIKE pmda_t.pmda002
DEFINE l_pmda007   LIKE pmda_t.pmda007
DEFINE l_pmdb046     LIKE pmdb_t.pmdb046     #170420-00061#1 add
DEFINE l_pmdbseq     LIKE pmdb_t.pmdbseq     #170420-00061#1 add

   CALL r_ar.clear()
   IF p_apcb001 MATCHES '1[012]' OR p_apcb001 MATCHES '2[012]' THEN #10:採購/11:入庫/12:進項發票/20:倉退/21:驗退/22:紅字發票        
      #入庫單資訊
      LET l_pmdt.pmdtdocno = p_docno
      IF p_apcb001 MATCHES '[12]2' THEN
         SELECT apba005 INTO l_pmdt.pmdtdocno
           FROM apba_t
          WHERE apbaent = g_enterprise
            AND apbadocno = p_docno AND apbaseq = p_seq
      END IF
      SELECT pmds002,pmds003           #入庫人員，入庫部門
        INTO l_pmds.pmds002,l_pmds.pmds003
        FROM pmds_t
       WHERE pmdsent = g_enterprise AND pmdsdocno = l_pmdt.pmdtdocno
      
      SELECT pmdt001,pmdt002           #採購單號，採購項次
        INTO l_pmdn.pmdndocno,l_pmdn.pmdnseq
        FROM pmdt_t
       WHERE pmdtent = g_enterprise
         AND pmdtdocno = p_docno AND pmdtseq = p_seq
      #採購單
      IF NOT cl_null(l_pmdn.pmdndocno) AND NOT cl_null(l_pmdn.pmdnseq) THEN
         SELECT pmdl002,pmdl003        #採購部門，採購人員
           INTO l_pmdl.pmdl002,l_pmdl.pmdl003
           FROM pmdl_t
          WHERE pmdlent = g_enterprise AND pmdldocno = l_pmdn.pmdndocno

        #OPEN pmdp_t_c1 USING l_pmdn.pmdndocno,l_pmdn.pmdnseq   #150812-00010#3 mark
        #OPEN pmdp_t_c1 USING l_pmdn.pmdndocno                  #150812-00010#3  #170420-00061#1 mark
        #FETCH FIRST pmdp_t_c1 INTO l_pmdadocno                                  #170420-00061#1 mark
         EXECUTE pmdp_t_c1 USING l_pmdn.pmdndocno,l_pmdn.pmdnseq,l_pmdn.pmdndocno,l_pmdn.pmdnseq     #170420-00061#1 add 
            INTO l_pmdadocno,l_pmdbseq                                           #170420-00061#1 add      
      END IF
      #請購單
      IF NOT cl_null(l_pmdadocno) THEN
         #170420-00061#1---mark---start---
         #SELECT pmda002,pmda007
         #  INTO l_pmda002,l_pmda007
         #  FROM pmda_t
         # WHERE pmdaent = g_enterprise AND pmdadocno = l_pmdadocno
         #170420-00061#1---mark---end---
          EXECUTE pmda_t_p USING l_pmdadocno,l_pmdbseq INTO l_pmda002,l_pmda007,l_pmdb046   #170420-00061#1 add
      END IF
      CASE
          #170420-00061#1---add---start---
          WHEN NOT cl_null(l_pmda002) AND NOT cl_null(l_pmdb046)
               LET r_ar[1].chr = l_pmdb046
               LET r_ar[3].chr = l_pmda002
          #170420-00061#1---add---end---      
          WHEN NOT cl_null(l_pmda002) AND NOT cl_null(l_pmda007)
               LET r_ar[1].chr = l_pmda007
               LET r_ar[3].chr = l_pmda002
          WHEN NOT cl_null(l_pmdl.pmdl002) AND NOT cl_null(l_pmdl.pmdl003) 
               LET r_ar[1].chr = l_pmdl.pmdl003
               LET r_ar[3].chr = l_pmdl.pmdl002
          WHEN NOT cl_null(l_pmds.pmds002) AND NOT cl_null(l_pmds.pmds003) 
               LET r_ar[1].chr = l_pmds.pmds003
               LET r_ar[3].chr = l_pmds.pmds002
      END CASE
   END IF
   RETURN r_ar
END FUNCTION

################################################################################
# Descriptions...: 寫入沖暫估apcf
# Memo...........:
# Date & Author..: 14/10/10 By Belle
# Modify.........: #141218-00011#5 150112 By albireo
#                :                 增加aapt301,aapt341呼叫時的處理及沖暫估來源篩選條件增加
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcf_bak(p_ld,p_apcb001,p_apcbdocno,p_apcbseq,p_pmdtdocno,p_pmdtseq,p_apcb007,p_apcb105,p_sfin2002)
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_apcb001     LIKE apcb_t.apcb001     #來源作業
DEFINE p_apcbdocno   LIKE apcb_t.apcbdocno   #立帳單據
DEFINE p_apcbseq     LIKE apcb_t.apcbseq     #立帳項次 #NO USE
DEFINE p_pmdtdocno   LIKE apcb_t.apcb002     #來源單據
DEFINE p_pmdtseq     LIKE apcb_t.apcb003     #來源項次
DEFINE p_apcb007     LIKE apcb_t.apcb007     #計價數量
DEFINE p_apcb105     LIKE apcb_t.apcb105     #
DEFINE p_sfin2002    LIKE type_t.chr1
#161111-00048#2 --s mark
#DEFINE l_apca        RECORD LIKE apca_t.*
#DEFINE l_apcb        RECORD LIKE apcb_t.*
#DEFINE l_apcf        RECORD LIKE apcf_t.*
#161111-00048#2 --e mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE l_apcb RECORD  #應付憑單單身
       apcbent LIKE apcb_t.apcbent, #企業編號
       apcbld LIKE apcb_t.apcbld, #帳套
       apcblegl LIKE apcb_t.apcblegl, #核算組織
       apcborga LIKE apcb_t.apcborga, #帳務歸屬組織(來源組織)
       apcbsite LIKE apcb_t.apcbsite, #應付帳務組織
       apcbdocno LIKE apcb_t.apcbdocno, #單號
       apcbseq LIKE apcb_t.apcbseq, #項次
       apcb001 LIKE apcb_t.apcb001, #來源類型
       apcb002 LIKE apcb_t.apcb002, #來源業務單據號碼
       apcb003 LIKE apcb_t.apcb003, #來源業務單據項次
       apcb004 LIKE apcb_t.apcb004, #產品編號
       apcb005 LIKE apcb_t.apcb005, #品名規格
       apcb006 LIKE apcb_t.apcb006, #單位
       apcb007 LIKE apcb_t.apcb007, #計價數量
       apcb008 LIKE apcb_t.apcb008, #參考單據號碼
       apcb009 LIKE apcb_t.apcb009, #參考單據項次
       apcb010 LIKE apcb_t.apcb010, #業務部門
       apcb011 LIKE apcb_t.apcb011, #責任中心
       apcb012 LIKE apcb_t.apcb012, #產品類別
       apcb013 LIKE apcb_t.apcb013, #搭贈
       apcb014 LIKE apcb_t.apcb014, #理由碼
       apcb015 LIKE apcb_t.apcb015, #專案編號
       apcb016 LIKE apcb_t.apcb016, #WBS編號
       apcb017 LIKE apcb_t.apcb017, #預算細項
       apcb018 LIKE apcb_t.apcb018, #专柜编号
       apcb019 LIKE apcb_t.apcb019, #開票性質
       apcb020 LIKE apcb_t.apcb020, #稅別
       apcb021 LIKE apcb_t.apcb021, #費用會計科目
       apcb022 LIKE apcb_t.apcb022, #正負值
       apcb023 LIKE apcb_t.apcb023, #沖暫估單否
       apcb024 LIKE apcb_t.apcb024, #區域
       apcb025 LIKE apcb_t.apcb025, #傳票號碼
       apcb026 LIKE apcb_t.apcb026, #傳票項次
       apcb027 LIKE apcb_t.apcb027, #發票編號
       apcb028 LIKE apcb_t.apcb028, #發票號碼
       apcb029 LIKE apcb_t.apcb029, #應付帳款科目
       apcb030 LIKE apcb_t.apcb030, #付款條件
       apcb032 LIKE apcb_t.apcb032, #訂金序次
       apcb033 LIKE apcb_t.apcb033, #經營方式
       apcb034 LIKE apcb_t.apcb034, #通路
       apcb035 LIKE apcb_t.apcb035, #品牌
       apcb036 LIKE apcb_t.apcb036, #客群
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046, #自由核算項十
       apcb047 LIKE apcb_t.apcb047, #摘要
       apcb048 LIKE apcb_t.apcb048, #來源訂購單號
       apcb049 LIKE apcb_t.apcb049, #開票單號
       apcb050 LIKE apcb_t.apcb050, #開票項次
       apcb051 LIKE apcb_t.apcb051, #業務人員
       apcb100 LIKE apcb_t.apcb100, #交易原幣
       apcb101 LIKE apcb_t.apcb101, #交易原幣單價
       apcb102 LIKE apcb_t.apcb102, #原幣匯率
       apcb103 LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104 LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105 LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb106 LIKE apcb_t.apcb106, #交易幣標準成本金額
       apcb107 LIKE apcb_t.apcb107, #入庫單單價
       apcb108 LIKE apcb_t.apcb108, #交易原幣成本認列金額
       apcb111 LIKE apcb_t.apcb111, #本幣單價
       apcb113 LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114 LIKE apcb_t.apcb114, #本幣稅額
       apcb115 LIKE apcb_t.apcb115, #本幣含稅金額
       apcb116 LIKE apcb_t.apcb116, #本幣標準成本金額
       apcb117 LIKE apcb_t.apcb117, #NO USE
       apcb118 LIKE apcb_t.apcb118, #本幣成本認列金額
       apcb119 LIKE apcb_t.apcb119, #應開發票含稅金額
       apcb121 LIKE apcb_t.apcb121, #本位幣二匯率
       apcb123 LIKE apcb_t.apcb123, #本位幣二未稅金額
       apcb124 LIKE apcb_t.apcb124, #本位幣二稅額
       apcb125 LIKE apcb_t.apcb125, #本位幣二含稅金額
       apcb126 LIKE apcb_t.apcb126, #本幣二標準成本金額
       apcb127 LIKE apcb_t.apcb127, #NO USE
       apcb128 LIKE apcb_t.apcb128, #本位幣二成本認列金額
       apcb131 LIKE apcb_t.apcb131, #本位幣三匯率
       apcb133 LIKE apcb_t.apcb133, #本位幣三未稅金額
       apcb134 LIKE apcb_t.apcb134, #本位幣三稅額
       apcb135 LIKE apcb_t.apcb135, #本位幣三含稅金額
       apcb136 LIKE apcb_t.apcb136, #本幣三標準成本金額
       apcb137 LIKE apcb_t.apcb137, #NO USE
       apcb138 LIKE apcb_t.apcb138, #本位幣三成本認列金額
       apcbud001 LIKE apcb_t.apcbud001, #自定義欄位(文字)001
       apcbud002 LIKE apcb_t.apcbud002, #自定義欄位(文字)002
       apcbud003 LIKE apcb_t.apcbud003, #自定義欄位(文字)003
       apcbud004 LIKE apcb_t.apcbud004, #自定義欄位(文字)004
       apcbud005 LIKE apcb_t.apcbud005, #自定義欄位(文字)005
       apcbud006 LIKE apcb_t.apcbud006, #自定義欄位(文字)006
       apcbud007 LIKE apcb_t.apcbud007, #自定義欄位(文字)007
       apcbud008 LIKE apcb_t.apcbud008, #自定義欄位(文字)008
       apcbud009 LIKE apcb_t.apcbud009, #自定義欄位(文字)009
       apcbud010 LIKE apcb_t.apcbud010, #自定義欄位(文字)010
       apcbud011 LIKE apcb_t.apcbud011, #自定義欄位(數字)011
       apcbud012 LIKE apcb_t.apcbud012, #自定義欄位(數字)012
       apcbud013 LIKE apcb_t.apcbud013, #自定義欄位(數字)013
       apcbud014 LIKE apcb_t.apcbud014, #自定義欄位(數字)014
       apcbud015 LIKE apcb_t.apcbud015, #自定義欄位(數字)015
       apcbud016 LIKE apcb_t.apcbud016, #自定義欄位(數字)016
       apcbud017 LIKE apcb_t.apcbud017, #自定義欄位(數字)017
       apcbud018 LIKE apcb_t.apcbud018, #自定義欄位(數字)018
       apcbud019 LIKE apcb_t.apcbud019, #自定義欄位(數字)019
       apcbud020 LIKE apcb_t.apcbud020, #自定義欄位(數字)020
       apcbud021 LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
       apcbud022 LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
       apcbud023 LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
       apcbud024 LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
       apcbud025 LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
       apcbud026 LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
       apcbud027 LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
       apcbud028 LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
       apcbud029 LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
       apcbud030 LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
       apcb052 LIKE apcb_t.apcb052, #稅額
       apcb053 LIKE apcb_t.apcb053, #含稅金額
       apcb054 LIKE apcb_t.apcb054, #帳款對象
       apcb055 LIKE apcb_t.apcb055  #付款對象
END RECORD
DEFINE l_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
#161111-00048#2 --e add
DEFINE l_apca004     LIKE apca_t.apca004     #帳款對象
DEFINE l_apca005     LIKE apca_t.apca005     #付款對象
DEFINE l_apca100     LIKE apca_t.apca100     #幣別           #141218-00011#5 150112 By albireo add
DEFINE l_apcadocdt   LIKE apca_t.apcadocdt   #單據日 暫估     #141218-00011#5 150112 By albireo add
DEFINE l_sql         STRING
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_flag        LIKE type_t.chr1

   
   WHENEVER ERROR CONTINUE
   
   #判斷單據是否立過暫估單據/FOR aapt3*修改狀態使用
   LET l_cnt = 0
   #SELECT count(*) INTO l_cnt         #161114-00009#1 mark
   SELECT count(apcfdocno) INTO l_cnt  #161114-00009#1 add
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcbdocno  AND apcfseq2= p_apcbseq
   IF l_cnt > 0 THEN
      DELETE FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
         AND apcfdocno=p_apcbdocno  AND apcfseq2= p_apcbseq
   END IF
   
   LET l_apca004 = NULL      LET l_apca100 = NULL
   LET l_apca005 = NULL      LET l_apcadocdt = NULL
   SELECT apca004,apca005,apca100,apcadocdt    #141218-00011#5 150112 By albireo add apca100,apcadocdt
     INTO l_apca004,l_apca005,l_apca100,l_apcadocdt
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld
      AND apcadocno = p_apcbdocno
      
   #141218-00011#5 150112 By albireo add----------------------------------s
   #aapt301  ,aapt341的19  26處理比照16 26類
   #IF g_prog = 'aapt301' OR g_prog = 'aapt341' THEN #170301-00021#1 by 09263 --mark
   IF g_prog MATCHES 'aapt301*' OR g_prog MATCHES 'aapt341*' THEN #170301-00021#1 by 09263 --add
      CASE 
         WHEN p_apcb001 = '19'
            LET p_apcb001 = '16'
         WHEN p_apcb001 = '29'
            LET p_apcb001 = '26'
      END CASE
   END IF
   #141218-00011#5 150112 By albireo add----------------------------------e
      
   ######################################################################
   #150112  抓取暫估單範圍:
   # 同帳款對象 AND 同幣別 AND 暫估日期<=立帳日期
   ######################################################################  
   
   #取得原來立的暫估單
   IF p_apcb001 MATCHES '[12]6' THEN   #雜項暫估單
      #Belle150203--add
      LET p_apcbdocno = p_apcbdocno
      LET p_apcbseq = 0
      #Belle150203--add
      LET l_sql = "SELECT apca_t.*,apcb_t.* ",
                  "  FROM apca_t,apcb_t,apcc_t",
                  " WHERE apcaent = apcbent AND apcaent = apccent AND apcald = apcbld AND apcald = apccld ",
                  "   AND apcadocno = apcbdocno AND apcadocno = apccdocno AND apcc108 - apcc109 <> 0 ",
                  "   AND apca001 IN('03','04')  AND apcastus = 'Y' ",
                  "   AND apcb002 IS NULL AND apcb003 IS NULL ",
                  "   AND apcaent = ",g_enterprise," AND apcald = '",p_ld,"'",
                  "   AND apca004 ='",l_apca004,"'   AND apca005= '",l_apca005,"'",
                  "   AND apca100 = '",l_apca100,"'  AND apcadocdt <='",l_apcadocdt,"' "   ##141218-00011#5 150112 By albireo add
     #Belle150203--mark
     #IF p_apcb001 = '16' THEN
     #   LET l_sql = l_sql ,"   AND apcb001 = '19' "
     #ELSE
     #   LET l_sql = l_sql ,"   AND apcb001 = '29' "
     #END IF
     #Belle150203--mark
      LET l_sql = l_sql," ORDER BY apcadocdt "       #141218-00011#5 150112 By albireo add
   ELSE   
      LET l_sql = "SELECT apca_t.*,apcb_t.* ",
                "  FROM apca_t,apcb_t,apcc_t",
                " WHERE apcaent = apcbent AND apcaent = apccent AND apcald = apcbld AND apcald = apccld ",
                "   AND apcadocno=apcbdocno AND apcadocno = apccdocno AND apcc108 - apcc109 <> 0 ",
                "   AND apcastus = 'Y'      AND apca001 IN ('01','02') ", 
                "   AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL ",
                "   AND apcaent = ",g_enterprise," AND apcald = '",p_ld,"'",
                "   AND apcb002 ='",p_pmdtdocno,"' AND apcb003=  ",p_pmdtseq     
   END IF
   
   PREPARE s_aapp130_ins_apcf_p3 FROM l_sql
   DECLARE s_aapp130_ins_apcf_c3 CURSOR FOR s_aapp130_ins_apcf_p3                  
   FOREACH s_aapp130_ins_apcf_c3 INTO l_apca.*,l_apcb.*
      
   #  CALL s_aapp131_get_apcf(p_ld,p_apcb001,p_apcbdocno,p_apcbseq,p_apcb007,p_apcb105,p_sfin2002,l_apca.*,l_apcb.*) RETURNING l_apcf.*,l_flag
      CASE l_flag
           WHEN '1'  EXIT FOREACH
           WHEN '2'  CONTINUE FOREACH
      END CASE
      
     #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
      IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
      IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
      IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
      IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
      IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
      IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
      IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
      IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
      IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
      IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
      IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
      IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
      IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
      IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
      IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
      IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
      IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
      IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
      IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
      IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
      IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
      IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
      IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
      #180130-00050#5---add by 10554---(E) 
      #161111-00048#2 --s add
      INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                         apcfseq2,apcf001,apcf002,apcf007,apcf008,
                         apcf009,apcf010,apcf020,apcf021,apcf022,
                         apcf023,apcf024,apcf025,apcf026,apcf027,
                         apcf028,apcf029,apcf030,apcf031,apcf032,
                         apcf033,apcf034,apcf035,apcf036,apcf037,
                         apcf038,apcf039,apcf040,apcf041,apcf042,
                         apcf043,apcf044,apcf045,apcf046,apcf047,
                         apcf048,apcf049,apcf101,apcf102,apcf103,
                         apcf104,apcf105,apcf106,apcf111,apcf113,
                         apcf114,apcf115,apcf116,apcf117,apcf122,
                         apcf123,apcf124,apcf125,apcf126,apcf127,
                         apcf132,apcf133,apcf134,apcf135,apcf136,
                         apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                         apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                         apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                         apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                         apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                         apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                         apcfud030)
      VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
             l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
             l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
             l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
             l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
             l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
             l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
             l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
             l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
             l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
             l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
             l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
             l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
             l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
             l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
             l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
             l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
             l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
             l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
             l_apcf.apcfud030)
      #161111-00048#2 --e add
   END FOREACH
END FUNCTION

################################################################################
# Descriptions...: 取得apcf計算方式
# Date & Author..: 14/10/23 By Belle
# Modify.........: 備份原來沖暫估寫法
################################################################################
PUBLIC FUNCTION s_aapp131_get_apcf_bak(p_ld,p_apcb001,p_apcbdocno,p_apcbseq,p_apcb007,p_apcb105,p_sfin2002,p_apca,p_apcb)
DEFINE p_ld          LIKE apcb_t.apcbld
DEFINE p_apcb001     LIKE apcb_t.apcb001     #來源作業
DEFINE p_apcbdocno   LIKE apcb_t.apcbdocno   #立帳單據
DEFINE p_apcbseq     LIKE apcb_t.apcbseq     #立帳項次
DEFINE p_apcb007     LIKE apcb_t.apcb007     #計價數量
DEFINE p_apcb105     LIKE apcb_t.apcb105     

DEFINE p_sfin2002    LIKE type_t.chr1
#DEFINE p_apca        RECORD LIKE apca_t.* #161111-00048#2 mark
#DEFINE p_apcb        RECORD LIKE apcb_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE p_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE p_apcb RECORD  #應付憑單單身
       apcbent LIKE apcb_t.apcbent, #企業編號
       apcbld LIKE apcb_t.apcbld, #帳套
       apcblegl LIKE apcb_t.apcblegl, #核算組織
       apcborga LIKE apcb_t.apcborga, #帳務歸屬組織(來源組織)
       apcbsite LIKE apcb_t.apcbsite, #應付帳務組織
       apcbdocno LIKE apcb_t.apcbdocno, #單號
       apcbseq LIKE apcb_t.apcbseq, #項次
       apcb001 LIKE apcb_t.apcb001, #來源類型
       apcb002 LIKE apcb_t.apcb002, #來源業務單據號碼
       apcb003 LIKE apcb_t.apcb003, #來源業務單據項次
       apcb004 LIKE apcb_t.apcb004, #產品編號
       apcb005 LIKE apcb_t.apcb005, #品名規格
       apcb006 LIKE apcb_t.apcb006, #單位
       apcb007 LIKE apcb_t.apcb007, #計價數量
       apcb008 LIKE apcb_t.apcb008, #參考單據號碼
       apcb009 LIKE apcb_t.apcb009, #參考單據項次
       apcb010 LIKE apcb_t.apcb010, #業務部門
       apcb011 LIKE apcb_t.apcb011, #責任中心
       apcb012 LIKE apcb_t.apcb012, #產品類別
       apcb013 LIKE apcb_t.apcb013, #搭贈
       apcb014 LIKE apcb_t.apcb014, #理由碼
       apcb015 LIKE apcb_t.apcb015, #專案編號
       apcb016 LIKE apcb_t.apcb016, #WBS編號
       apcb017 LIKE apcb_t.apcb017, #預算細項
       apcb018 LIKE apcb_t.apcb018, #专柜编号
       apcb019 LIKE apcb_t.apcb019, #開票性質
       apcb020 LIKE apcb_t.apcb020, #稅別
       apcb021 LIKE apcb_t.apcb021, #費用會計科目
       apcb022 LIKE apcb_t.apcb022, #正負值
       apcb023 LIKE apcb_t.apcb023, #沖暫估單否
       apcb024 LIKE apcb_t.apcb024, #區域
       apcb025 LIKE apcb_t.apcb025, #傳票號碼
       apcb026 LIKE apcb_t.apcb026, #傳票項次
       apcb027 LIKE apcb_t.apcb027, #發票編號
       apcb028 LIKE apcb_t.apcb028, #發票號碼
       apcb029 LIKE apcb_t.apcb029, #應付帳款科目
       apcb030 LIKE apcb_t.apcb030, #付款條件
       apcb032 LIKE apcb_t.apcb032, #訂金序次
       apcb033 LIKE apcb_t.apcb033, #經營方式
       apcb034 LIKE apcb_t.apcb034, #通路
       apcb035 LIKE apcb_t.apcb035, #品牌
       apcb036 LIKE apcb_t.apcb036, #客群
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046, #自由核算項十
       apcb047 LIKE apcb_t.apcb047, #摘要
       apcb048 LIKE apcb_t.apcb048, #來源訂購單號
       apcb049 LIKE apcb_t.apcb049, #開票單號
       apcb050 LIKE apcb_t.apcb050, #開票項次
       apcb051 LIKE apcb_t.apcb051, #業務人員
       apcb100 LIKE apcb_t.apcb100, #交易原幣
       apcb101 LIKE apcb_t.apcb101, #交易原幣單價
       apcb102 LIKE apcb_t.apcb102, #原幣匯率
       apcb103 LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104 LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105 LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb106 LIKE apcb_t.apcb106, #交易幣標準成本金額
       apcb107 LIKE apcb_t.apcb107, #入庫單單價
       apcb108 LIKE apcb_t.apcb108, #交易原幣成本認列金額
       apcb111 LIKE apcb_t.apcb111, #本幣單價
       apcb113 LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114 LIKE apcb_t.apcb114, #本幣稅額
       apcb115 LIKE apcb_t.apcb115, #本幣含稅金額
       apcb116 LIKE apcb_t.apcb116, #本幣標準成本金額
       apcb117 LIKE apcb_t.apcb117, #NO USE
       apcb118 LIKE apcb_t.apcb118, #本幣成本認列金額
       apcb119 LIKE apcb_t.apcb119, #應開發票含稅金額
       apcb121 LIKE apcb_t.apcb121, #本位幣二匯率
       apcb123 LIKE apcb_t.apcb123, #本位幣二未稅金額
       apcb124 LIKE apcb_t.apcb124, #本位幣二稅額
       apcb125 LIKE apcb_t.apcb125, #本位幣二含稅金額
       apcb126 LIKE apcb_t.apcb126, #本幣二標準成本金額
       apcb127 LIKE apcb_t.apcb127, #NO USE
       apcb128 LIKE apcb_t.apcb128, #本位幣二成本認列金額
       apcb131 LIKE apcb_t.apcb131, #本位幣三匯率
       apcb133 LIKE apcb_t.apcb133, #本位幣三未稅金額
       apcb134 LIKE apcb_t.apcb134, #本位幣三稅額
       apcb135 LIKE apcb_t.apcb135, #本位幣三含稅金額
       apcb136 LIKE apcb_t.apcb136, #本幣三標準成本金額
       apcb137 LIKE apcb_t.apcb137, #NO USE
       apcb138 LIKE apcb_t.apcb138, #本位幣三成本認列金額
       apcbud001 LIKE apcb_t.apcbud001, #自定義欄位(文字)001
       apcbud002 LIKE apcb_t.apcbud002, #自定義欄位(文字)002
       apcbud003 LIKE apcb_t.apcbud003, #自定義欄位(文字)003
       apcbud004 LIKE apcb_t.apcbud004, #自定義欄位(文字)004
       apcbud005 LIKE apcb_t.apcbud005, #自定義欄位(文字)005
       apcbud006 LIKE apcb_t.apcbud006, #自定義欄位(文字)006
       apcbud007 LIKE apcb_t.apcbud007, #自定義欄位(文字)007
       apcbud008 LIKE apcb_t.apcbud008, #自定義欄位(文字)008
       apcbud009 LIKE apcb_t.apcbud009, #自定義欄位(文字)009
       apcbud010 LIKE apcb_t.apcbud010, #自定義欄位(文字)010
       apcbud011 LIKE apcb_t.apcbud011, #自定義欄位(數字)011
       apcbud012 LIKE apcb_t.apcbud012, #自定義欄位(數字)012
       apcbud013 LIKE apcb_t.apcbud013, #自定義欄位(數字)013
       apcbud014 LIKE apcb_t.apcbud014, #自定義欄位(數字)014
       apcbud015 LIKE apcb_t.apcbud015, #自定義欄位(數字)015
       apcbud016 LIKE apcb_t.apcbud016, #自定義欄位(數字)016
       apcbud017 LIKE apcb_t.apcbud017, #自定義欄位(數字)017
       apcbud018 LIKE apcb_t.apcbud018, #自定義欄位(數字)018
       apcbud019 LIKE apcb_t.apcbud019, #自定義欄位(數字)019
       apcbud020 LIKE apcb_t.apcbud020, #自定義欄位(數字)020
       apcbud021 LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
       apcbud022 LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
       apcbud023 LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
       apcbud024 LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
       apcbud025 LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
       apcbud026 LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
       apcbud027 LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
       apcbud028 LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
       apcbud029 LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
       apcbud030 LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
       apcb052 LIKE apcb_t.apcb052, #稅額
       apcb053 LIKE apcb_t.apcb053, #含稅金額
       apcb054 LIKE apcb_t.apcb054, #帳款對象
       apcb055 LIKE apcb_t.apcb055  #付款對象
END RECORD
#161111-00048#2 --e add
DEFINE r_flag        LIKE type_t.chr1

DEFINE l_apca007     LIKE apca_t.apca007
DEFINE l_apca100     LIKE apca_t.apca100     #交易幣幣別
DEFINE l_apca101     LIKE apca_t.apca101     #本幣匯率
DEFINE l_apca121     LIKE apca_t.apca121
DEFINE l_apca131     LIKE apca_t.apca131

DEFINE l_apcb101     LIKE apcb_t.apcb101     #原幣單價
DEFINE l_apcb021     LIKE apcb_t.apcb021
DEFINE l_apcb029     LIKE apcb_t.apcb029

DEFINE l_apcb103     LIKE apcb_t.apcb105
DEFINE l_apcb105     LIKE apcb_t.apcb105
DEFINE l_apcb113     LIKE apcb_t.apcb115
DEFINE l_apcb115     LIKE apcb_t.apcb115

DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
#DEFINE l_apcf        RECORD LIKE apcf_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
#161111-00048#2 --e add

DEFINE l_glaacomp    LIKE glaa_t.glaacomp    #所屬法人
DEFINE l_glaa001     LIKE glaa_t.glaa001
DEFINE l_glaa004     LIKE glaa_t.glaa004     #會計科目參照表
DEFINE l_glaa015     LIKE glaa_t.glaa015     #本位幣二啟用
DEFINE l_glaa016     LIKE glaa_t.glaa016     #本位幣二
DEFINE l_glaa017     LIKE glaa_t.glaa017     #本位幣二換算基準
DEFINE l_glaa019     LIKE glaa_t.glaa019     #本位幣三啟用
DEFINE l_glaa020     LIKE glaa_t.glaa020     #本位幣三
DEFINE l_glaa021     LIKE glaa_t.glaa021     #本位幣三換算基準
DEFINE l_glaa025     LIKE glaa_t.glaa025     #本位幣一換算基準
DEFINE l_glac007     LIKE glac_t.glac007     #科目性質
DEFINE l_apcadocdt1  LIKE apca_t.apcadocdt   #立帳單據-立帳日期
DEFINE l_apcadocdt2  LIKE apca_t.apcadocdt   #暫估單據-立帳日期

###取得apcf_t資料---(S)---
DEFINE l_apcf007     LIKE apcf_t.apcf007     #沖銷數量
DEFINE l_apcf103     LIKE apcf_t.apcf103     #剩餘可立帳-原幣未稅金額
DEFINE l_apcf104     LIKE apcf_t.apcf104     #剩餘可立帳-原幣稅額
DEFINE l_apcf105     LIKE apcf_t.apcf105     #剩餘可立帳-原幣含稅金額
DEFINE l_apcf113     LIKE apcf_t.apcf113     #剩餘可立帳-本幣未稅金額
DEFINE l_apcf114     LIKE apcf_t.apcf114     #剩餘可立帳-本幣稅額
DEFINE l_apcf115     LIKE apcf_t.apcf115     #剩餘可立帳-本幣含稅金額
DEFINE l_apcf123     LIKE apcf_t.apcf123     #剩餘可立帳-本幣二未稅金額
DEFINE l_apcf124     LIKE apcf_t.apcf124     #剩餘可立帳-本幣二稅額
DEFINE l_apcf125     LIKE apcf_t.apcf125     #剩餘可立帳-本幣二含稅金額
DEFINE l_apcf133     LIKE apcf_t.apcf133     #剩餘可立帳-本幣三未稅金額
DEFINE l_apcf134     LIKE apcf_t.apcf134     #剩餘可立帳-本幣三稅額
DEFINE l_apcf135     LIKE apcf_t.apcf135     #剩餘可立帳-本幣三含稅金額
DEFINE l_apcf0071    LIKE apcf_t.apcf007
DEFINE l_apcf1031    LIKE apcf_t.apcf103     #已經立帳-原幣未稅金額
DEFINE l_apcf1041    LIKE apcf_t.apcf104     #已經立帳-原幣稅額
DEFINE l_apcf1051    LIKE apcf_t.apcf105     #已經立帳-原幣含稅金額
DEFINE l_apcf1131    LIKE apcf_t.apcf113     #已經立帳-本幣未稅金額
DEFINE l_apcf1141    LIKE apcf_t.apcf114     #已經立帳-本幣稅額
DEFINE l_apcf1151    LIKE apcf_t.apcf115     #已經立帳-本幣含稅金額
DEFINE l_apcf1231    LIKE apcf_t.apcf123     #已經立帳-本幣二未稅金額
DEFINE l_apcf1241    LIKE apcf_t.apcf124     #已經立帳-本幣二稅額
DEFINE l_apcf1251    LIKE apcf_t.apcf125     #已經立帳-本幣二含稅金額
DEFINE l_apcf1331    LIKE apcf_t.apcf133     #已經立帳-本幣三未稅金額
DEFINE l_apcf1341    LIKE apcf_t.apcf134     #已經立帳-本幣三稅額
DEFINE l_apcf1351    LIKE apcf_t.apcf135     #已經立帳-本幣三含稅金額
###取得apcf_t資料---(E)---
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_rate1       LIKE apcf_t.apcf102
DEFINE l_sfin2011    LIKE type_t.chr1        #迴轉否
DEFINE l_sfin3012    LIKE type_t.chr1        #含稅立帳否
DEFINE l_str         LIKE type_t.chr1        #說明欄位
DEFINE l_oodb005     LIKE oodb_t.oodb005
DEFINE l_oodb006     LIKE oodb_t.oodb006
DEFINE l_oodb011     LIKE oodb_t.oodb011
#albireo 150121-----s
DEFINE l_apcf105alb  LIKE apcf_t.apcf105
DEFINE l_apcf115alb  LIKE apcf_t.apcf115
#albireo 150121-----e
#151012-00014#2-----s
DEFINE lc_param      RECORD
         type        LIKE type_t.chr1,    #類型
         apca004     LIKE apca_t.apca004  #交易對象
                 END RECORD
DEFINE l_desc        LIKE type_t.chr500   #接沒有用到的參數用
DEFINE ls_js         STRING
#151012-00014#2-----e



   WHENEVER ERROR CONTINUE
   
   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa001|glaa004|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa025')
        RETURNING g_sub_success,l_glaacomp,l_glaa001,l_glaa004,
                  l_glaa015,l_glaa016,l_glaa017,l_glaa019,l_glaa020,   #140806-00012#12 add glaa020
                  l_glaa021,l_glaa025
   
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2011') RETURNING l_sfin2011
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012
   IF l_sfin2011 = 'N' THEN LET l_sfin3012 = '1' END IF  #1.立帳不含稅
   
   #l_apca/l_apcb(現在立帳的立帳單--aapt300)
   #p_apca/p_apcb(抓出來沖的暫估單--aapt320)
   
   #此次立帳單---(S)---
   SELECT apca007,apca101,apca100,apca121,apca131
     INTO l_apca007,l_apca101,l_apca100,l_apca121,l_apca131
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld
      AND apcadocno= p_apcbdocno 
   CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_04')  RETURNING g_sub_success,l_xrcd009,g_errno
   
   IF p_apcbseq = 0 THEN         #整張單沖暫估
      SELECT apcb021,apcb029,apcb101
        INTO l_apcb021,l_apcb029,l_apcb101
        FROM apcb_t
       WHERE apcbent = g_enterprise AND apcbld = p_ld
         AND apcbdocno= p_apcbdocno AND apcbseq= 1
      
      SELECT SUM(apcb103),SUM(apcb105),SUM(apcb113),SUM(apcb115)
        INTO l_apcb103,l_apcb105,l_apcb113,l_apcb115
        FROM apcb_t
       WHERE apcbent = g_enterprise AND apcbld = p_ld
         AND apcbdocno= p_apcbdocno AND apcb023='Y'        
              
      #帳款單:單身金額扣除已沖暫估金額才是未沖暫估金額
      LET l_apcf105alb = NULL
      LET l_apcf115alb = NULL
    
      IF l_sfin3012 = '1' THEN
         LET l_apcb115 = l_apcb113
         LET l_apcb105 = l_apcb103
         SELECT SUM(apcf103),SUM(apcf113) INTO l_apcf105alb,l_apcf115alb
           FROM apcf_t
          WHERE apcfent = g_enterprise
            AND apcfld  = p_ld
            AND apcfdocno = p_apcbdocno
         SELECT SUM(apca103),SUM(apca113),
                SUM(apca123),SUM(apca133)
           INTO p_apcb.apcb105,p_apcb.apcb115,p_apcb.apcb125,p_apcb.apcb135
           FROM apca_t
          WHERE apcaent = g_enterprise AND apcald = p_ld
            AND apcadocno=p_apca.apcadocno
      ELSE
         SELECT SUM(apcf105),SUM(apcf115) INTO l_apcf105alb,l_apcf115alb
           FROM apcf_t
          WHERE apcfent = g_enterprise
            AND apcfld  = p_ld
            AND apcfdocno = p_apcbdocno
        
         SELECT SUM(apcc108-apcc109),SUM(apcc118+apcc113-apcc119),
                SUM(apcc128+apcc123-apcc129),SUM(apcc138+apcc133-apcc139)
           INTO p_apcb.apcb105,p_apcb.apcb115,p_apcb.apcb125,p_apcb.apcb135
           FROM apcc_t
          WHERE apccent = g_enterprise AND apccld = p_ld
            AND apccdocno=p_apca.apcadocno
      END IF
     #LET p_apcb.apcbseq = 0     
      LET p_apcb.apcb103 = p_apcb.apcb105
      LET p_apcb.apcb104 = 0
      LET p_apcb.apcb113 = p_apcb.apcb115
      LET p_apcb.apcb114 = 0
      LET p_apcb.apcb123 = p_apcb.apcb125
      LET p_apcb.apcb124 = 0
      LET p_apcb.apcb133 = p_apcb.apcb135
      LET p_apcb.apcb134 = 0
   ELSE
      SELECT apcb021,apcb029,apcb101,
             apcb103,apcb105,apcb113,apcb115
        INTO l_apcb021,l_apcb029,l_apcb101,
             l_apcb103,l_apcb105,l_apcb113,l_apcb115
        FROM apcb_t
       WHERE apcbent = g_enterprise AND apcbld = p_ld
         AND apcbdocno= p_apcbdocno AND apcbseq= p_apcbseq
  
      #albireo 150121-----s
      #帳款單:單身金額扣除已沖暫估金額才是未沖暫估金額
      LET l_apcf105alb = NULL
      LET l_apcf115alb = NULL
      SELECT SUM(apcf105),SUM(apcf115) INTO l_apcf105alb,l_apcf115alb
        FROM apcf_t
       WHERE apcfent = g_enterprise
         AND apcfld  = p_ld
         AND apcfdocno = p_apcbdocno
         AND apcfseq2  = p_apcbseq
   END IF
   IF cl_null(l_apcb105) THEN LET l_apcb105 = 0 END IF
   IF cl_null(l_apcb115) THEN LET l_apcb115 = 0 END IF
   IF cl_null(l_apcf105alb)THEN LET l_apcf105alb = 0 END IF
   IF cl_null(l_apcf115alb)THEN LET l_apcf115alb = 0 END IF

   LET l_apcb105 = l_apcb105 - l_apcf105alb
   LET l_apcb115 = l_apcb115 - l_apcf115alb

   IF l_apcb105 = 0  OR l_apcb115 = 0 THEN
      LET r_flag = '1'       #EXIT
      RETURN l_apcf.*,r_flag
   END IF
   #albireo 150121-----e
   #此次立帳單---(E)---
   
   INITIALIZE l_apcf.* TO NULL
   IF p_apcb001 MATCHES '[12]6' THEN      #雜項暫估單(用金額判斷是否已經沖完)
      IF l_apcb105 = 0 THEN               #表示該張單子已沖完暫估
         LET r_flag = '1'                 #EXIT
         RETURN l_apcf.*,r_flag
      END IF
      #改抓cb的原幣金額/本幣金額 如果不同幣抓本幣(同幣別抓原幣
      #取到cb單號，用cb單號+項次 去扣到cf的已沖>>這樣就得到未沖金額
      
      SELECT SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),
             SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135),
             SUM(apcf007)
        INTO l_apcf1031,l_apcf1041,l_apcf1051,l_apcf1131,l_apcf1141,l_apcf1151,
             l_apcf1231,l_apcf1241,l_apcf1251,l_apcf1331,l_apcf1341,l_apcf1351,
             l_apcf0071
        FROM apca_t,apcf_t
       WHERE apcaent = apcfent      AND apcald = apcfld
         AND apcadocno=apcfdocno    AND apcastus <> 'X'
         AND apcfent = g_enterprise AND apcfld = p_ld
         AND apcf008 = p_apcb.apcbdocno 
        #AND apcf009 = p_apcb.apcbseq 
      IF cl_null(l_apcf1031) THEN LET l_apcf1031 = 0 END IF         IF cl_null(l_apcf1041) THEN LET l_apcf1041 = 0 END IF         IF cl_null(l_apcf1051) THEN LET l_apcf1051 = 0 END IF
      IF cl_null(l_apcf1131) THEN LET l_apcf1131 = 0 END IF         IF cl_null(l_apcf1141) THEN LET l_apcf1141 = 0 END IF         IF cl_null(l_apcf1151) THEN LET l_apcf1151 = 0 END IF
      IF cl_null(l_apcf1231) THEN LET l_apcf1231 = 0 END IF         IF cl_null(l_apcf1241) THEN LET l_apcf1241 = 0 END IF         IF cl_null(l_apcf1251) THEN LET l_apcf1251 = 0 END IF
      IF cl_null(l_apcf1331) THEN LET l_apcf1331 = 0 END IF         IF cl_null(l_apcf1341) THEN LET l_apcf1341 = 0 END IF         IF cl_null(l_apcf1351) THEN LET l_apcf1351 = 0 END IF
      
      #此次要沖暫估(t300)的金額=已沖暫估(t320)金額 表示已沖完了
      IF (l_apca100 = p_apca.apca100 AND p_apcb.apcb105 = l_apcf1051 ) OR (l_apca100 <> p_apca.apca100 AND p_apcb.apcb115 = l_apcf1151 ) THEN   
         LET r_flag = '2'                    #COUNTINE
         RETURN l_apcf.*,r_flag
      END IF
      
      #立暫估單-已沖暫估金額=剩餘可沖暫估金額
      LET l_apcf105 = p_apcb.apcb105 - l_apcf1051  LET l_apcf103 = l_apcf105  
      LET l_apcf115 = p_apcb.apcb115 - l_apcf1151  LET l_apcf113 = l_apcf115  
      LET l_apcf125 = p_apcb.apcb125 - l_apcf1251  LET l_apcf123 = l_apcf125  
      LET l_apcf135 = p_apcb.apcb135 - l_apcf1351  LET l_apcf133 = p_apcb.apcb133 - l_apcf1331  
      IF cl_null(l_apcf103) THEN LET l_apcf103 = 0 END IF   IF cl_null(l_apcf104) THEN LET l_apcf104 = 0 END IF   IF cl_null(l_apcf105) THEN LET l_apcf105 = 0 END IF
      IF cl_null(l_apcf113) THEN LET l_apcf113 = 0 END IF   IF cl_null(l_apcf114) THEN LET l_apcf114 = 0 END IF   IF cl_null(l_apcf115) THEN LET l_apcf115 = 0 END IF
      IF cl_null(l_apcf123) THEN LET l_apcf123 = 0 END IF   IF cl_null(l_apcf124) THEN LET l_apcf124 = 0 END IF   IF cl_null(l_apcf125) THEN LET l_apcf125 = 0 END IF
      IF cl_null(l_apcf133) THEN LET l_apcf133 = 0 END IF   IF cl_null(l_apcf134) THEN LET l_apcf134 = 0 END IF   IF cl_null(l_apcf135) THEN LET l_apcf135 = 0 END IF
   ELSE
      #取得已冲暂估数量&其他未確認單, 有沖暫估記錄者
      IF p_apcb.apcb007 = 0 THEN 
         LET r_flag = '2'           #COUNTINE
         RETURN l_apcf.*,r_flag
      END IF
      SELECT SUM(apcf007) INTO l_apcf007
        FROM apcf_t,apca_t
       WHERE apcfent = apcaent      AND apcfld = apcald
         AND apcfdocno=apcadocno    AND apcastus <> 'X'
         AND apcfent = g_enterprise AND apcfld = p_ld
         AND apcf008 = p_apcb.apcbdocno
         AND apcf009 = p_apcb.apcbseq
      IF cl_null(l_apcf007) THEN LET l_apcf007 = 0 END IF
      IF l_apcf007 = p_apcb.apcb007 THEN     #(用數量判斷是否已經沖完)
         LET r_flag = '1'           #EXIT
         RETURN l_apcf.*,r_flag
      END IF
   END IF
   
   
   CALL s_tax_chk(l_glaacomp,p_apcb.apcb020) RETURNING g_sub_success,l_str,l_oodb005,l_oodb006,l_oodb011
   
   LET l_apcf.apcfent = g_enterprise
   LET l_apcf.apcfld  = p_ld
   LET l_apcf.apcfdocno=p_apcbdocno
   #Belle 150331--mod
   SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcbdocno  
   IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
   #LET l_apcf.apcfseq = p_apcbseq
   #Belle 150331--mod
   LET l_apcf.apcfseq2 = p_apcbseq
  #SELECT MAX(apcfseq2) + 1 INTO l_apcf.apcfseq2
  #  FROM apcf_t
  # WHERE apcfent = g_enterprise AND apcfld = p_ld
  #   AND apcfdocno=p_apcbdocno  AND apcfseq = p_apcbseq   #albireo 150121
  #IF cl_null(l_apcf.apcfseq2) THEN LET l_apcf.apcfseq2 = 1 END IF
   LET l_apcf.apcf001 = 'aapt300'
   LET l_apcf.apcf002 = '01'                 #固定值
   IF NOT p_apcb001 MATCHES '[12]6' THEN     #12/16類的由價格回推
      IF p_apcb007 > p_apcb.apcb007 THEN     #沖銷數量(此次立帳大於暫估數量)
         LET l_apcf.apcf007 = p_apcb.apcb007 #依暫估數量
      ELSE
         LET l_apcf.apcf007 = p_apcb007      #依立帳數量
      END IF
   END IF
   LET l_apcf.apcf008 = p_apcb.apcbdocno
   LET l_apcf.apcf009 = p_apcb.apcbseq
   LET l_apcf.apcf010 = 0                    #期別:暫估原則上只有一期
   
   LET l_apcf.apcf020 = p_apcb.apcb020
   
   IF l_sfin2011 = 'N' THEN #不迴轉(Y代表回转。N不回转:抓apcf)
      LET l_apcf.apcf021 = p_apcb.apcb029 #应收暂估会科
      SELECT glac007 INTO l_glac007       #取得科目性質
        #FROM glac_t,glaa_t #170615-00061#1 mark glaa_t 無條件串到,移除避免影響效能
        FROM glac_t         #170615-00061#1 add         
       WHERE glacent = g_enterprise AND glac001 = l_glaa004 AND glac002 = p_apcb.apcb021
      SELECT apcadocdt INTO l_apcadocdt1  #立帳單的立帳日期
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apcbdocno
       SELECT apcadocdt INTO l_apcadocdt2 #暫估單的立帳日期
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apcb.apcbdocno
      #當期沖暫估的科目及資產類科目
      IF l_glac007 NOT MATCHES '[45]' OR (YEAR(l_apcadocdt1) = YEAR(l_apcadocdt2) AND MONTH(l_apcadocdt1) = MONTH(l_apcadocdt2)) THEN
         LET l_apcf.apcf022 = p_apcb.apcb021
      ELSE
         SELECT apcb021 INTO l_apcf.apcf022
           FROM apcb_t
          WHERE apcbent = g_enterprise AND apcbld = p_ld
            AND apcbdocno=p_apcbdocno  AND apcbseq= p_apcbseq
      END IF
      CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_08') RETURNING g_sub_success,l_apcf.apcf023,g_errno
   ELSE
      LET l_apcf.apcf021 = l_apcb029
      LET l_apcf.apcf022 = l_apcb021
      LET l_apcf.apcf023 = l_xrcd009
   END IF
   CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf024,g_errno
   CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf025,g_errno
   
   LET l_apcf.apcforga= p_apcb.apcborga    #來源組織
   LET l_apcf.apcf026 = p_apcb.apcb010     #業務部門
   LET l_apcf.apcf027 = p_apcb.apcb011     #責任中心
   LET l_apcf.apcf028 = p_apcb.apcb024     #區域
   #170413-00069#1--mark--str--lujh
   #LET l_apcf.apcf029 = p_apca.apca004    #交易客商
   #LET l_apcf.apcf030 = p_apca.apca005    #帳款客商
   #170413-00069#1--mark--end--lujh
   #170413-00069#1--add--str--lujh
   LET l_apcf.apcf029 = p_apca.apca005     #交易客商
   LET l_apcf.apcf030 = p_apca.apca004     #帳款客商
   #170413-00069#1--add--end--lujh
   
   LET l_apcf.apcf031 = p_apcb.apcb036     #客群
   LET l_apcf.apcf032 = p_apcb.apcb004     #產品類別
   LET l_apcf.apcf033 = p_apcb.apcb051     #業務人員
   LET l_apcf.apcf034 = p_apcb.apcb015     #專案編號
   LET l_apcf.apcf035 = p_apcb.apcb016     #WBS
   LET l_apcf.apcf036 = p_apcb.apcb033     #經營方式
   LET l_apcf.apcf037 = p_apcb.apcb034     #渠道
   LET l_apcf.apcf038 = p_apcb.apcb035     #品牌
   LET l_apcf.apcf039 = p_apcb.apcb037     #自由核算項1
   LET l_apcf.apcf040 = p_apcb.apcb038     #自由核算項2
   LET l_apcf.apcf041 = p_apcb.apcb039     #自由核算項3
   LET l_apcf.apcf042 = p_apcb.apcb040     #自由核算項4
   LET l_apcf.apcf043 = p_apcb.apcb041     #自由核算項5
   LET l_apcf.apcf044 = p_apcb.apcb042     #自由核算項6
   LET l_apcf.apcf045 = p_apcb.apcb043     #自由核算項7
   LET l_apcf.apcf046 = p_apcb.apcb044     #自由核算項8
   LET l_apcf.apcf047 = p_apcb.apcb045     #自由核算項9
   LET l_apcf.apcf048 = p_apcb.apcb046     #自由核算項10
   LET l_apcf.apcf049 = p_apcb.apcb047     #摘要
   
   LET l_apcf.apcf101 = p_apcb.apcb101
   LET l_apcf.apcf102 = p_apca.apca101    #本幣一匯率
   LET l_apcf.apcf111 = p_apcb.apcb111    #單價
   LET l_apcf.apcf122 = p_apcb.apcb121    #本幣二匯率
   LET l_apcf.apcf132 = p_apcb.apcb131    #本幣三匯率
   
   #沖帳情況：1.整張暫估單全部沖完       >>直接賦值
   #         2.整張暫估單沖銷剩餘部分
   #         3.整張暫估單沖銷部分
   
   IF p_apcb001 MATCHES '[12]6' THEN
      LET l_apcf.apcf007 = 1
      IF l_sfin3012 = '1' THEN
         CASE
             WHEN (l_apca100 =  p_apca.apca100 AND p_apcb.apcb103 <= l_apcb103 AND l_apcf1031 = 0) 
               OR (l_apca100 <> p_apca.apca100 AND p_apcb.apcb113 <= l_apcb113 AND l_apcf1131 = 0)
               
                  LET l_apcf.apcf103 = p_apcb.apcb103
                  LET l_apcf.apcf104 = 0
                  LET l_apcf.apcf105 = p_apcb.apcb103
                  LET l_apcf.apcf113 = p_apcb.apcb113
                  LET l_apcf.apcf114 = 0
                  LET l_apcf.apcf115 = p_apcb.apcb113
                  LET l_apcf.apcf123 = p_apcb.apcb123
                  LET l_apcf.apcf124 = 0
                  LET l_apcf.apcf125 = p_apcb.apcb123
                  LET l_apcf.apcf133 = p_apcb.apcb133
                  LET l_apcf.apcf134 = 0
                  LET l_apcf.apcf135 = p_apcb.apcb133
                  
                  LET l_apcb103 = l_apcb103 - p_apcb.apcb103
                  LET l_apcb113 = l_apcb113 - p_apcb.apcb113
             
             WHEN (l_apca100 =  p_apca.apca100 AND l_apcb103 <= l_apcf105) 
               OR (l_apca100 <> p_apca.apca100 AND l_apcb113 <= l_apcf115)
                  
                  #立帳單據單身含稅金額 - 已沖含稅暫估金額
                  LET l_apcf.apcf113 = l_apcb113
                  LET l_apcf.apcf115 = l_apcb113
                  LET l_apcf.apcf125 = l_apcf.apcf113 * l_apca121
                  CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apcf.apcf123,2) RETURNING g_sub_success,g_errno,l_apcf.apcf123
                  LET l_apcf.apcf124 = 0
                  LET l_apcf.apcf123 = l_apcf.apcf123
                  LET l_apcf.apcf135 = l_apcf.apcf113 * l_apca121
                  CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf135,2) RETURNING g_sub_success,g_errno,l_apcf.apcf135
                  LET l_apcf.apcf134 = 0
                  LET l_apcf.apcf133 = l_apcf.apcf133
                  IF l_apca100 = p_apca.apca100 THEN
                     LET l_apcf.apcf105 = l_apcb103
                     LET l_apcf.apcf103 = l_apcb103
                     LET l_apcf.apcf104 = 0
                  ELSE
                     CALL s_curr_round_ld('1',l_apcf.apcfld,l_glaa001,l_apcf.apcf113/l_apca101,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103
                     LET l_apcf.apcf104 = 0
                     LET l_apcf.apcf103 = l_apcf.apcf103
                  END IF
                  
             WHEN (l_apca100 =  p_apca.apca100 AND l_apcb103 > l_apcf103) 
               OR (l_apca100 <> p_apca.apca100 AND l_apcb113 > l_apcf113)  
   
                  LET l_apcf.apcf105 = l_apcf103
                  LET l_apcf.apcf113 = l_apcf113
                  LET l_apcf.apcf114 = 0
                  LET l_apcf.apcf115 = l_apcf113
                  LET l_apcf.apcf123 = l_apcf123
                  LET l_apcf.apcf124 = 0
                  LET l_apcf.apcf125 = l_apcf123
                  LET l_apcf.apcf133 = l_apcf133
                  LET l_apcf.apcf134 = 0
                  LET l_apcf.apcf135 = l_apcf133
         END CASE
      ELSE
         CASE 
         #l_apcf105剩餘可沖數量
         #l_apcb115目前可立帳數量
             WHEN (l_apca100 =  p_apca.apca100 AND p_apcb.apcb105 <= l_apcb105 AND l_apcf1051 = 0) 
               OR (l_apca100 <> p_apca.apca100 AND p_apcb.apcb115 <= l_apcb115 AND l_apcf1151 = 0)
               
                 #LET l_apcf.apcf007 = p_apcb.apcb007
                  LET l_apcf.apcf103 = p_apcb.apcb103
                  LET l_apcf.apcf104 = p_apcb.apcb104
                  LET l_apcf.apcf105 = p_apcb.apcb105
                  LET l_apcf.apcf113 = p_apcb.apcb113
                  LET l_apcf.apcf114 = p_apcb.apcb114
                  LET l_apcf.apcf115 = p_apcb.apcb115
                  LET l_apcf.apcf123 = p_apcb.apcb123
                  LET l_apcf.apcf124 = p_apcb.apcb124
                  LET l_apcf.apcf125 = p_apcb.apcb125
                  LET l_apcf.apcf133 = p_apcb.apcb133
                  LET l_apcf.apcf134 = p_apcb.apcb134
                  LET l_apcf.apcf135 = p_apcb.apcb135
                  
                  LET l_apcb105 = l_apcb105 - p_apcb.apcb105
                  LET l_apcb115 = l_apcb115 - p_apcb.apcb115
             
             WHEN (l_apca100 =  p_apca.apca100 AND l_apcb105 <= l_apcf105) 
               OR (l_apca100 <> p_apca.apca100 AND l_apcb115 <= l_apcf115)
                  
                  #立帳單據單身含稅金額 - 已沖含稅暫估金額
                  LET l_apcf.apcf115 = l_apcb115
                  LET l_apcf.apcf125 = l_apcf.apcf115 * l_apca121
                  CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apcf.apcf125,2) RETURNING g_sub_success,g_errno,l_apcf.apcf125 #140806-00012#12
                  LET l_apcf.apcf124 = l_apcf.apcf114 * l_apca121
                  CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apcf.apcf124,2) RETURNING g_sub_success,g_errno,l_apcf.apcf124 #140806-00012#12
                  LET l_apcf.apcf123 = l_apcf.apcf125 - l_apcf.apcf124
                  LET l_apcf.apcf135 = l_apcf.apcf115 * l_apca121
                  CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf135,2) RETURNING g_sub_success,g_errno,l_apcf.apcf135 #140806-00012#12
                  LET l_apcf.apcf134 = l_apcf.apcf114 * l_apca121
                  CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf134,2) RETURNING g_sub_success,g_errno,l_apcf.apcf134 #140806-00012#12
                  LET l_apcf.apcf133 = l_apcf.apcf135 - l_apcf.apcf134
                  IF l_apca100 = p_apca.apca100 THEN
                     LET l_apcf.apcf105 = l_apcb105
                     LET l_apcf.apcf103 = l_apcb105
                     LET l_apcf.apcf104 = 0
                  ELSE
                     CALL s_curr_round_ld('1',l_apcf.apcfld,l_glaa001,l_apcf.apcf113/l_apca101,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103
                     CALL s_curr_round_ld('1',l_apcf.apcfld,l_glaa001,l_apcf.apcf114/l_apca101,2) RETURNING g_sub_success,g_errno,l_apcf.apcf104
                     CALL s_curr_round_ld('1',l_apcf.apcfld,l_glaa001,l_apcf.apcf115/l_apca101,2) RETURNING g_sub_success,g_errno,l_apcf.apcf105
                  END IF
                  
             WHEN (l_apca100 =  p_apca.apca100 AND l_apcb105 > l_apcf105) 
               OR (l_apca100 <> p_apca.apca100 AND l_apcb115 > l_apcf115)  
   
                  LET l_apcf.apcf105 = l_apcf105
                  LET l_apcf.apcf113 = l_apcf113
                  LET l_apcf.apcf114 = l_apcf114
                  LET l_apcf.apcf115 = l_apcf115
                  LET l_apcf.apcf123 = l_apcf123
                  LET l_apcf.apcf124 = l_apcf124
                  LET l_apcf.apcf125 = l_apcf125
                  LET l_apcf.apcf133 = l_apcf133
                  LET l_apcf.apcf134 = l_apcf134
                  LET l_apcf.apcf135 = l_apcf135
   
         END CASE
      END IF
      LET l_apcf.apcf101 = l_apcf.apcf105/l_apcf.apcf007
      LET l_apcf.apcf104 = 0
      LET l_apcf.apcf103 = l_apcf.apcf105
      LET l_apcf.apcf114 = 0
      LET l_apcf.apcf113 = l_apcf.apcf115
   ELSE
      CASE 
          WHEN (p_apcb007 = p_apcb.apcb007 AND l_apcf007 = 0)
               LET l_apcf.apcf103 = p_apcb.apcb103         LET l_apcf.apcf104 = p_apcb.apcb104         LET l_apcf.apcf105 = p_apcb.apcb105
               LET l_apcf.apcf113 = p_apcb.apcb113         LET l_apcf.apcf114 = p_apcb.apcb114         LET l_apcf.apcf115 = p_apcb.apcb115
               LET l_apcf.apcf123 = p_apcb.apcb123         LET l_apcf.apcf124 = p_apcb.apcb124         LET l_apcf.apcf125 = p_apcb.apcb125
               LET l_apcf.apcf133 = p_apcb.apcb133         LET l_apcf.apcf134 = p_apcb.apcb134         LET l_apcf.apcf135 = p_apcb.apcb135
          #情況二:(此次沖銷數量 + 已沖銷暫估數) = 原暫估單數量
          WHEN (p_apcb007 + l_apcf007 = p_apcb.apcb007) AND l_apcf007 <> 0
               SELECT SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),
                      SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135)
                 INTO l_apcf103,l_apcf104,l_apcf105,l_apcf113,l_apcf114,l_apcf115,
                      l_apcf123,l_apcf124,l_apcf125,l_apcf133,l_apcf134,l_apcf135
                 FROM apcf_t
                WHERE apcfld = p_ld AND apcfent = g_enterprise
                  AND apcf008= p_apcb.apcbdocno 
                  AND apcf009= p_apcb.apcbseq
       
               IF cl_null(l_apcf103) THEN LET l_apcf103 = 0 END IF         IF cl_null(l_apcf104) THEN LET l_apcf104 = 0 END IF         IF cl_null(l_apcf105) THEN LET l_apcf105 = 0 END IF
               IF cl_null(l_apcf113) THEN LET l_apcf113 = 0 END IF         IF cl_null(l_apcf114) THEN LET l_apcf114 = 0 END IF         IF cl_null(l_apcf115) THEN LET l_apcf115 = 0 END IF
               IF cl_null(l_apcf123) THEN LET l_apcf123 = 0 END IF         IF cl_null(l_apcf124) THEN LET l_apcf124 = 0 END IF         IF cl_null(l_apcf125) THEN LET l_apcf125 = 0 END IF
               IF cl_null(l_apcf133) THEN LET l_apcf133 = 0 END IF         IF cl_null(l_apcf134) THEN LET l_apcf134 = 0 END IF         IF cl_null(l_apcf135) THEN LET l_apcf135 = 0 END IF
               
               LET l_apcf.apcf103 = p_apcb.apcb103 - l_apcf103
               LET l_apcf.apcf104 = p_apcb.apcb104 - l_apcf104
               LET l_apcf.apcf105 = p_apcb.apcb105 - l_apcf105
               LET l_apcf.apcf113 = p_apcb.apcb113 - l_apcf113
               LET l_apcf.apcf114 = p_apcb.apcb114 - l_apcf114
               LET l_apcf.apcf115 = p_apcb.apcb115 - l_apcf115
               LET l_apcf.apcf123 = p_apcb.apcb123 - l_apcf123
               LET l_apcf.apcf124 = p_apcb.apcb124 - l_apcf124
               LET l_apcf.apcf125 = p_apcb.apcb125 - l_apcf125
               LET l_apcf.apcf133 = p_apcb.apcb133 - l_apcf133
               LET l_apcf.apcf134 = p_apcb.apcb134 - l_apcf134
               LET l_apcf.apcf135 = p_apcb.apcb135 - l_apcf135
          OTHERWISE
               LET l_apcf.apcf103 = (p_apcb.apcb103 / p_apcb.apcb007) * l_apcf.apcf007    #(未稅/數量)*此次立帳
               LET l_apcf.apcf105 = (p_apcb.apcb105 / p_apcb.apcb007) * l_apcf.apcf007    #(含稅/數量)*此次立帳
               LET l_apcf.apcf113 = (p_apcb.apcb113 / p_apcb.apcb007) * l_apcf.apcf007    #
               LET l_apcf.apcf115 = (p_apcb.apcb115 / p_apcb.apcb007) * l_apcf.apcf007
               CALL s_curr_round_ld('1',p_ld,p_apca.apca100,l_apcf.apcf103,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103 #140806-00012#12
               CALL s_curr_round_ld('1',p_ld,p_apca.apca100,l_apcf.apcf105,2) RETURNING g_sub_success,g_errno,l_apcf.apcf105 #140806-00012#12
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113      #140806-00012#12
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf115,2) RETURNING g_sub_success,g_errno,l_apcf.apcf115      #140806-00012#12
               IF p_apcb.apcb104 = 0 THEN
                  LET l_apcf.apcf104 = 0
               ELSE
                  LET l_apcf.apcf104 = (p_apcb.apcb104 / p_apcb.apcb007) * l_apcf.apcf007
                  CALL s_curr_round_ld('1',p_ld,p_apca.apca100,l_apcf.apcf104,2) RETURNING g_sub_success,g_errno,l_apcf.apcf104 #140806-00012#12
               END IF
               IF p_apcb.apcb114 = 0 THEN
                  LET l_apcf.apcf114 = 0
               ELSE
                  LET l_apcf.apcf114 = (p_apcb.apcb114 / p_apcb.apcb007) * l_apcf.apcf007
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf114,2) RETURNING g_sub_success,g_errno,l_apcf.apcf114      #140806-00012#12
               END IF
      END CASE
   END IF   
   #相同幣別沖暫估者，則以原暫估單匯率 
   IF l_apca100 = p_apca.apca100 THEN
      LET l_rate1 = p_apca.apca101
   ELSE
       #151012-00014#2-----s
       #改依aoos020(S-FIN-3009)設定,帶入日/月平均匯率預設值
       #--(MARK)-s
#       CALL s_aooi160_get_exrate('2',p_ld,p_apca.apcadocdt,l_apca100,l_glaa001,0,l_glaa025)
#            RETURNING l_rate
       #--(MARK)-e
       LET lc_param.type = '1'
       LET lc_param.apca004 = p_apca.apca004
       LET ls_js = util.JSON.stringify(lc_param)
       CALL s_fin_get_curr_rate(l_glaacomp,p_ld,p_apca.apcadocdt,l_apca100,ls_js)
            RETURNING l_rate1,l_desc,l_desc
       #151012-00014#2-----e
   END IF
   IF NOT p_apcb001 MATCHES '[12]6' THEN 
      #计算公式可以是：立账的rmb单价＊立暂估时点的rmb的汇率－立暂估的ntd的单价＊立暂估时的ntd的汇率
      LET l_apcf.apcf116 = (l_apcb101 * l_rate1 - l_apcf.apcf101 * l_apcf.apcf102) * l_apcf.apcf007
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf116,2) RETURNING g_sub_success,g_errno,l_apcf.apcf116    
      
      LET l_apcf.apcf106 = l_apcf.apcf116 / l_apcf.apcf102
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf106,2) RETURNING g_sub_success,g_errno,l_apcf.apcf106    
      
      #雜項沖暫估整筆處理
      #匯差金额的计算公式：立账的rmb单价＊立账时点的rmb的汇率－立账的rmb的单价＊立暂估时点的rmb的汇率
      LET l_apcf.apcf117 = ((l_apcb113/p_apcb007)*l_apcf.apcf007) - l_apcf.apcf113 -l_apcf.apcf116
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf117,2) RETURNING g_sub_success,g_errno,l_apcf.apcf117    
   END IF
   
   LET l_apcf.apcf126 = 0
   LET l_apcf.apcf127 = 0
   LET l_apcf.apcf126 = 0
   LET l_apcf.apcf137 = 0
   
   IF l_glaa015 = 'Y' THEN
      IF l_glaa017 = '1' THEN
         LET l_apcf.apcf126 = l_apcf.apcf106 * l_apcf.apcf122
         LET l_apcf.apcf127 = l_apcf.apcf117 * l_apcf.apcf122
      ELSE
         LET l_apcf.apcf126 = l_apcf.apcf116 * l_apcf.apcf122
         LET l_apcf.apcf127 = l_apcf.apcf117 * l_apcf.apcf122
      END IF
      CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apcf.apcf126,2) RETURNING g_sub_success,g_errno,l_apcf.apcf126
      CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apcf.apcf127,2) RETURNING g_sub_success,g_errno,l_apcf.apcf127
   END IF
   IF l_glaa019 = 'Y' THEN
      IF l_glaa021 = '1' THEN
         LET l_apcf.apcf136 = l_apcf.apcf106 * l_apcf.apcf132
         LET l_apcf.apcf137 = l_apcf.apcf117 * l_apcf.apcf132
      ELSE
         LET l_apcf.apcf136 = l_apcf.apcf116 * l_apcf.apcf132
         LET l_apcf.apcf137 = l_apcf.apcf117 * l_apcf.apcf132
      END IF
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf136,2) RETURNING g_sub_success,g_errno,l_apcf.apcf136
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apcf.apcf137,2) RETURNING g_sub_success,g_errno,l_apcf.apcf137
   END IF
   
   LET r_flag = '0'
   RETURN l_apcf.*,r_flag
END FUNCTION

################################################################################
# Descriptions...: 寫入apcf差異檔案
# Memo...........:
# Usage..........: 
# Date & Author..: 14/10/21 By Belle
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcf_diff_bak(p_ld,p_apcadocno)
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_apcadocno   LIKE apca_t.apcadocno   #立帳單據
#DEFINE l_apcf        RECORD LIKE apcf_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
#161111-00048#2 --e add
DEFINE l_sql         STRING
DEFINE l_apca007     LIKE apca_t.apca007
DEFINE l_apca101     LIKE apca_t.apca101
DEFINE l_apca100     LIKE apca_t.apca100     #140806-00012#12
DEFINE l_glaacomp    LIKE glaa_t.glaacomp
DEFINE l_glaa001     LIKE glaa_t.glaa001     #140806-00012#12
DEFINE l_apcf106     LIKE apcf_t.apcf106
DEFINE l_apcf116     LIKE apcf_t.apcf116
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_apcb113     LIKE apcb_t.apcb105
DEFINE l_apcb123     LIKE apcb_t.apcb105
DEFINE l_apcb133     LIKE apcb_t.apcb105
DEFINE l_apcf113     LIKE apcb_t.apcb105
DEFINE l_apcf123     LIKE apcb_t.apcb105
DEFINE l_apcf133     LIKE apcb_t.apcb105
DEFINE l_apcf1131    LIKE apcb_t.apcb105
DEFINE l_apcf1231    LIKE apcb_t.apcb105
DEFINE l_apcf1331    LIKE apcb_t.apcb105

   WHENEVER ERROR CONTINUE
   
   #140806-00012#12 add glaa001
   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa001')
        RETURNING  g_sub_success,l_glaacomp,l_glaa001
        
   #SELECT count(*) INTO l_cnt        #161114-00009#1 mark
   SELECT count(apcfdocno) INTO l_cnt #161114-00009#1 add
     FROM apcf_t
    WHERE apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apcf008 = 'DIFF'
   IF l_cnt > 0 THEN
      DELETE FROM apcf_t
       WHERE apcfent = g_enterprise
         AND apcfld  = p_ld AND apcfdocno = p_apcadocno AND apcf008 = 'DIFF'
   END IF
   
   #140806-00012#12 add apca100
   SELECT apca007,apca101,apca100
     INTO l_apca007,l_apca101,l_apca100
     FROM apca_t
    WHERE apcaent = g_enterprise
      AND apcald  = p_ld AND apcadocno = p_apcadocno
   
   #SELECT count(*) INTO l_cnt        #161114-00009#1 mark
   SELECT count(apcfdocno) INTO l_cnt #161114-00009#1 add
     FROM apcf_t,apca_t
    WHERE apcaent = apcfent AND apcald = apcfld AND apcadocno = apcf008
      AND apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apca001 IN ('01','02','03','04')
   IF l_cnt = 0 THEN #若無0*單據不沖暫估
      RETURN
   END IF
   #產生價差數據---(S)---
   INITIALIZE l_apcf.* TO NULL
   LET l_apcf.apcfent = g_enterprise
   LET l_apcf.apcfld  = p_ld
   LET l_apcf.apcforga=l_glaacomp
   LET l_apcf.apcfdocno=p_apcadocno
   #Belle 150331--mod
   SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
       FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
        AND apcfdocno=p_apcadocno  
   IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
   #LET l_apcf.apcfseq = 0
   #Belle 150331--mod
   SELECT MAX(apcfseq2) + 1 INTO l_apcf.apcfseq2
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcadocno 
   IF cl_null(l_apcf.apcfseq2) THEN LET l_apcf.apcfseq2 = 1 END IF
   LET l_apcf.apcf001 = 'aapt300'
   LET l_apcf.apcf002 = '01'              #固定值
   LET l_apcf.apcf007 = 1
   LET l_apcf.apcf008 = 'DIFF'
   LET l_apcf.apcf009 = 0
   LET l_apcf.apcf010 = 0
   LET l_apcf.apcf020 = ''
   CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf025,g_errno
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf023 = ''
   LET l_apcf.apcf024 = ''
   LET l_apcf.apcf025 = ''
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf102 = l_apca101
   LET l_apcf.apcf104 = 0
   LET l_apcf.apcf106 = 0
   LET l_apcf.apcf114 = 0
   LET l_apcf.apcf116 = 0
   LET l_apcf.apcf117 = 0
   
   #入庫暫估--(S)--
   SELECT SUM(apcf106),SUM(apcf116) INTO l_apcf.apcf101,l_apcf.apcf111
     FROM apcf_t,apca_t
    WHERE apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apcf008 <> 'DIFF'
      AND apcaent = apcfent AND apcadocno = apcf008 AND apcald = apcfld AND apca001 IN ('01','03')

   IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF
   IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF
   #入庫暫估--(E)--
   #倉退暫估--(S)--
   SELECT SUM(apcf106),SUM(apcf116) INTO l_apcf106,l_apcf116
     FROM apcf_t,apca_t
    WHERE apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apcf008 <> 'DIFF'
      AND apcaent = apcfent AND apcadocno = apcf008 AND apcald = apcfld AND apca001 IN ('02','04')

   IF cl_null(l_apcf106) THEN LET l_apcf106 = 0 END IF
   IF cl_null(l_apcf116) THEN LET l_apcf116 = 0 END IF
   #倉退暫估--(E)--
   LET l_apcf.apcf103 = l_apcf.apcf007 * (l_apcf.apcf101 - l_apcf106)
   CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf.apcf103,1) RETURNING g_sub_success,g_errno,l_apcf.apcf103 #140806-00012#12
   LET l_apcf.apcf105 = l_apcf.apcf103
   LET l_apcf.apcf113 = l_apcf.apcf007 * (l_apcf.apcf111 - l_apcf116)
   CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,1) RETURNING g_sub_success,g_errno,l_apcf.apcf113 #140806-00012#12
   LET l_apcf.apcf115 = l_apcf.apcf113
  
   IF NOT (l_apcf.apcf103 = 0 AND l_apcf.apcf113 = 0) THEN
     #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
      IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
      IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
      IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
      IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
      IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
      IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
      IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
      IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
      IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
      IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
      IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
      IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
      IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
      IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
      IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
      IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
      IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
      IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
      IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
      IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
      IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
      IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
      IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
      #180130-00050#5---add by 10554---(E) 
      #161111-00048#2 --s add
      INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                         apcfseq2,apcf001,apcf002,apcf007,apcf008,
                         apcf009,apcf010,apcf020,apcf021,apcf022,
                         apcf023,apcf024,apcf025,apcf026,apcf027,
                         apcf028,apcf029,apcf030,apcf031,apcf032,
                         apcf033,apcf034,apcf035,apcf036,apcf037,
                         apcf038,apcf039,apcf040,apcf041,apcf042,
                         apcf043,apcf044,apcf045,apcf046,apcf047,
                         apcf048,apcf049,apcf101,apcf102,apcf103,
                         apcf104,apcf105,apcf106,apcf111,apcf113,
                         apcf114,apcf115,apcf116,apcf117,apcf122,
                         apcf123,apcf124,apcf125,apcf126,apcf127,
                         apcf132,apcf133,apcf134,apcf135,apcf136,
                         apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                         apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                         apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                         apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                         apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                         apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                         apcfud030)
      VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
             l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
             l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
             l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
             l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
             l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
             l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
             l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
             l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
             l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
             l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
             l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
             l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
             l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
             l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
             l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
             l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
             l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
             l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
             l_apcf.apcfud030)
      #161111-00048#2 --e add
   END IF
   #產生價差數據---(E)---
   
   #產生匯差數據---(S)---
   INITIALIZE l_apcf.* TO NULL
   LET l_apcf.apcfent = g_enterprise
   LET l_apcf.apcfld  = p_ld
   LET l_apcf.apcforga=l_glaacomp
   LET l_apcf.apcfdocno=p_apcadocno
   #Belle 150331--mod
   SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
       FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
        AND apcfdocno=p_apcadocno  
   IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
   #LET l_apcf.apcfseq = 0
   #Belle 150331--mod
   SELECT MAX(apcfseq2) + 1 INTO l_apcf.apcfseq2
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcadocno
      
   IF cl_null(l_apcf.apcfseq2) THEN LET l_apcf.apcfseq2 = 1 END IF
   LET l_apcf.apcf001 = 'aapt300'
   LET l_apcf.apcf002 = '01'              #固定值
   LET l_apcf.apcf007 = 1
   LET l_apcf.apcf008 = 'DIFF'
   LET l_apcf.apcf009 = 0
   LET l_apcf.apcf010 = 0
   LET l_apcf.apcf020 = ''
   CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf025,g_errno
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf023 = ''
   LET l_apcf.apcf024 = ''
   LET l_apcf.apcf025 = ''
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf101 = 0
   LET l_apcf.apcf102 = 1
   LET l_apcf.apcf103 = 0
   LET l_apcf.apcf104 = 0
   LET l_apcf.apcf105 = 0
   LET l_apcf.apcf106 = 0
   LET l_apcf.apcf114 = 0
   LET l_apcf.apcf116 = 0
   LET l_apcf.apcf117 = 0

   SELECT SUM(apcf117) INTO l_apcf.apcf111
     FROM apcf_t
    WHERE apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apcf008 <> 'DIFF'
   LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111
   CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,1) RETURNING g_sub_success,g_errno,l_apcf.apcf113 #140806-00012#12
   LET l_apcf.apcf115 = l_apcf.apcf113
    
   IF l_apcf.apcf111 <> 0 THEN
     #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
      IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
      IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
      IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
      IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
      IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
      IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
      IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
      IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
      IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
      IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
      IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
      IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
      IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
      IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
      IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
      IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
      IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
      IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
      IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
      IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
      IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
      IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
      IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
      #180130-00050#5---add by 10554---(E) 
      #161111-00048#2 --s add
      INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                         apcfseq2,apcf001,apcf002,apcf007,apcf008,
                         apcf009,apcf010,apcf020,apcf021,apcf022,
                         apcf023,apcf024,apcf025,apcf026,apcf027,
                         apcf028,apcf029,apcf030,apcf031,apcf032,
                         apcf033,apcf034,apcf035,apcf036,apcf037,
                         apcf038,apcf039,apcf040,apcf041,apcf042,
                         apcf043,apcf044,apcf045,apcf046,apcf047,
                         apcf048,apcf049,apcf101,apcf102,apcf103,
                         apcf104,apcf105,apcf106,apcf111,apcf113,
                         apcf114,apcf115,apcf116,apcf117,apcf122,
                         apcf123,apcf124,apcf125,apcf126,apcf127,
                         apcf132,apcf133,apcf134,apcf135,apcf136,
                         apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                         apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                         apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                         apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                         apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                         apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                         apcfud030)
      VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
             l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
             l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
             l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
             l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
             l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
             l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
             l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
             l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
             l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
             l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
             l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
             l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
             l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
             l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
             l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
             l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
             l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
             l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
             l_apcf.apcfud030)
      #161111-00048#2 --e add
   END IF
   #產生匯差數據---(E)---
   
   #產生雜項沖暫估150203---(S)
   LET l_cnt = 0 
   #SELECT count(*) INTO l_cnt         #161114-00009#1 mark
   SELECT count(apcbdocno) INTO l_cnt  #161114-00009#1 add
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld = p_ld AND apcbdocno = p_apcadocno
      AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
   IF l_cnt = 0 THEN
      RETURN
   END IF
   INITIALIZE l_apcf.* TO NULL
   LET l_apcf.apcfent = g_enterprise
   LET l_apcf.apcfld  = p_ld
   LET l_apcf.apcforga=l_glaacomp
   LET l_apcf.apcfdocno=p_apcadocno
   #Belle 150331--mod
   SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
       FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
        AND apcfdocno=p_apcadocno  
   IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
   #LET l_apcf.apcfseq = 0
   #Belle 150331--mod
   SELECT MAX(apcfseq2) + 1 INTO l_apcf.apcfseq2
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcadocno 
   IF cl_null(l_apcf.apcfseq2) THEN LET l_apcf.apcfseq2 = 1 END IF
   LET l_apcf.apcf001 = 'aapt300'
   LET l_apcf.apcf002 = '01'              #固定值
   LET l_apcf.apcf007 = 1
   LET l_apcf.apcf008 = 'DIFF'
   LET l_apcf.apcf009 = 0
   LET l_apcf.apcf010 = 0
   LET l_apcf.apcf020 = ''
   CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf025,g_errno
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf023 = ''
   LET l_apcf.apcf024 = ''
   LET l_apcf.apcf025 = ''
   LET l_apcf.apcf022 = ''
   LET l_apcf.apcf102 = l_apca101
   LET l_apcf.apcf104 = 0
   LET l_apcf.apcf106 = 0
   LET l_apcf.apcf114 = 0
   LET l_apcf.apcf116 = 0
   LET l_apcf.apcf117 = 0
   
   ##那就是apcf113/apcf115和aapt320的金额比对
  #SELECT SUM(apcf113),SUM(apcf123),SUM(apcf133) 
  #  INTO l_apcf113,l_apcf123,l_apcf133
  #  FROM apcf_t,apca_t
  # WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
  #   AND apcfent = g_enterprise
  #   AND apcfld  = p_ld AND apcfdocno=p_apcadocno
  #   AND apca001 IN ('03','04')
      
   SELECT SUM(apcf113),SUM(apcf123),SUM(apcf133) 
     INTO l_apcf113,l_apcf123,l_apcf133
     FROM apcf_t,apca_t
    WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
      AND apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno=p_apcadocno
      AND apca001 = '03'
   
   SELECT SUM(apcf113)*-1,SUM(apcf123)*-1,SUM(apcf133) *-1
     INTO l_apcf1131,l_apcf1231,l_apcf1331
     FROM apcf_t,apca_t
    WHERE apcfent = apcaent AND apcfld = apcald AND apcadocno = apcf008 
      AND apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno=p_apcadocno
      AND apca001 = '04'
      
   SELECT SUM(apcb113*apcb022),SUM(apcb123*apcb022),SUM(apcb133*apcb022)
     INTO l_apcb113,l_apcb123,l_apcb133
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld  = p_ld AND apcbdocno=p_apcadocno
      AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
   
  #SELECT SUM(apcb115),SUM(apcb125),SUM(apcb135)
  #  INTO l_apcb113,l_apcb123,l_apcb133
  #  FROM apcb_t
  # WHERE apcbent = g_enterprise
  #   AND apcbld  = p_ld AND apcbdocno=p_apcadocno
  #   AND apcb023 = 'Y' AND apcb001 IN ('19','29','16','26')
      
   IF cl_null(l_apcf113)  THEN LET l_apcf113 = 0 END IF
   IF cl_null(l_apcf123)  THEN LET l_apcf123 = 0 END IF
   IF cl_null(l_apcf133)  THEN LET l_apcf133 = 0 END IF
   IF cl_null(l_apcf1131) THEN LET l_apcf1131= 0 END IF
   IF cl_null(l_apcf1231) THEN LET l_apcf1231= 0 END IF
   IF cl_null(l_apcf1331) THEN LET l_apcf1331= 0 END IF
   IF cl_null(l_apcb113)  THEN LET l_apcb113 = 0 END IF
   IF cl_null(l_apcb123)  THEN LET l_apcb123 = 0 END IF
   IF cl_null(l_apcb133)  THEN LET l_apcb133 = 0 END IF
   LET l_apcf113 = l_apcf113 + l_apcf1131
   LET l_apcf123 = l_apcf123 + l_apcf1231
   LET l_apcf133 = l_apcf133 + l_apcf1331
   
   LET l_apcf.apcf103 = 0
   LET l_apcf.apcf104 = 0
   LET l_apcf.apcf105 = 0
   LET l_apcf.apcf113 = l_apcb113 - l_apcf113
   LET l_apcf.apcf114 = 0
   LET l_apcf.apcf115 = l_apcf.apcf113          #含稅未稅相同
   LET l_apcf.apcf123 = l_apcb123 - l_apcf123
   LET l_apcf.apcf124 = 0
   LET l_apcf.apcf125 = l_apcf.apcf113
   LET l_apcf.apcf133 = l_apcb133 - l_apcf133
   LET l_apcf.apcf134 = 0
   LET l_apcf.apcf135 = l_apcf.apcf133
   
   IF NOT l_apcf.apcf115 = 0  THEN
     #INSERT INTO apcf_t VALUES(l_apcf.*) #161111-00048#2 mark
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
      IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
      IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
      IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
      IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
      IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
      IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
      IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
      IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
      IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
      IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
      IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
      IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
      IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
      IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
      IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
      IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
      IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
      IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
      IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
      IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
      IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
      IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
      IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
      #180130-00050#5---add by 10554---(E) 
      #161111-00048#2 --s add
      INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                         apcfseq2,apcf001,apcf002,apcf007,apcf008,
                         apcf009,apcf010,apcf020,apcf021,apcf022,
                         apcf023,apcf024,apcf025,apcf026,apcf027,
                         apcf028,apcf029,apcf030,apcf031,apcf032,
                         apcf033,apcf034,apcf035,apcf036,apcf037,
                         apcf038,apcf039,apcf040,apcf041,apcf042,
                         apcf043,apcf044,apcf045,apcf046,apcf047,
                         apcf048,apcf049,apcf101,apcf102,apcf103,
                         apcf104,apcf105,apcf106,apcf111,apcf113,
                         apcf114,apcf115,apcf116,apcf117,apcf122,
                         apcf123,apcf124,apcf125,apcf126,apcf127,
                         apcf132,apcf133,apcf134,apcf135,apcf136,
                         apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                         apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                         apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                         apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                         apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                         apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                         apcfud030)
      VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
             l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
             l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
             l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
             l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
             l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
             l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
             l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
             l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
             l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
             l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
             l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
             l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
             l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
             l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
             l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
             l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
             l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
             l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
             l_apcf.apcfud030)
      #161111-00048#2 --e add
   END IF
   
   #產生雜項沖暫估150203---(E)
END FUNCTION

################################################################################
# Descriptions...: 抓取收貨單的發票&寫入發票檔
# Memo...........: 150821-00003#4
# Usage..........: CALL s_aapp131_ins_isam_from_pmdw((p_wc,p_array)
# Date & Author..: 2015/08/21 By Hans
# Modify.........: 
################################################################################
PUBLIC FUNCTION s_aapp131_ins_isam_from_pmdw(p_wc,p_array)
DEFINE p_wc       STRING
DEFINE p_array    DYNAMIC ARRAY OF  RECORD
         chr      LIKE type_t.chr1000,
         dat      LIKE type_t.dat
              END RECORD
DEFINE l_master   RECORD
         l_docno     LIKE apca_t.apcadocno,
         l_ld        LIKE apca_t.apcald
              END RECORD
DEFINE r_success        LIKE type_t.num5
DEFINE l_receiveno      LIKE pmds_t.pmds006  #收貨單號
DEFINE l_pmdw           RECORD
          pmdw001       LIKE pmdw_t.pmdw001,
          pmdw002       LIKE pmdw_t.pmdw002,
          pmdw008       LIKE pmdw_t.pmdw008,
          pmdw009       LIKE pmdw_t.pmdw009,
          pmdw010       LIKE pmdw_t.pmdw010,
          pmdw011       LIKE pmdw_t.pmdw011,
          pmdw012       LIKE pmdw_t.pmdw012,
          pmdw0121      LIKE pmdw_t.pmdw0121,
          pmdw013       LIKE pmdw_t.pmdw013,
          pmdw014       LIKE pmdw_t.pmdw014,
          pmdw015       LIKE pmdw_t.pmdw015,
          pmdw016       LIKE pmdw_t.pmdw016,
          pmdw017       LIKE pmdw_t.pmdw017,
          pmdw018       LIKE pmdw_t.pmdw018,
          pmdw019       LIKE pmdw_t.pmdw019,
          pmdw020       LIKE pmdw_t.pmdw020,
          pmdw021       LIKE pmdw_t.pmdw021,
          pmdw022       LIKE pmdw_t.pmdw022,
          pmdw023       LIKE pmdw_t.pmdw023,
          pmdw024       LIKE pmdw_t.pmdw024,
          pmdw025       LIKE pmdw_t.pmdw025,
          pmdw026       LIKE pmdw_t.pmdw026,
          pmdw027       LIKE pmdw_t.pmdw027,
          pmdw028       LIKE pmdw_t.pmdw028,
          pmdw029       LIKE pmdw_t.pmdw029,
          pmdw030       LIKE pmdw_t.pmdw030,
          pmdw031       LIKE pmdw_t.pmdw031,
          pmdw032       LIKE pmdw_t.pmdw032,
          pmdw033       LIKE pmdw_t.pmdw033,
          pmdw034       LIKE pmdw_t.pmdw034,
          pmdw035       LIKE pmdw_t.pmdw035,
          pmdw036       LIKE pmdw_t.pmdw036,
          pmdw037       LIKE pmdw_t.pmdw037,
          pmdw038       LIKE pmdw_t.pmdw038,
          pmdw039       LIKE pmdw_t.pmdw039,
          pmdw040       LIKE pmdw_t.pmdw040,
          pmdw041       LIKE pmdw_t.pmdw041,
          pmdw042       LIKE pmdw_t.pmdw042,
          pmdw043       LIKE pmdw_t.pmdw043,
          pmdw045       LIKE pmdw_t.pmdw045,
          pmdw046       LIKE pmdw_t.pmdw046,
          pmdw047       LIKE pmdw_t.pmdw047,
          pmdw048       LIKE pmdw_t.pmdw048,
          pmdw049       LIKE pmdw_t.pmdw049,
          pmdw201       LIKE pmdw_t.pmdw201,
          pmdw202       LIKE pmdw_t.pmdw202,
          pmdw203       LIKE pmdw_t.pmdw203,
          pmdw204       LIKE pmdw_t.pmdw204,
          pmdw205       LIKE pmdw_t.pmdw205,
          pmdw206       LIKE pmdw_t.pmdw206,
          pmdw207       LIKE pmdw_t.pmdw207
                    END RECORD
DEFINE l_isamseq        LIKE isam_t.isamseq  #發票項次
DEFINE l_cnt            LIKE type_t.num5
DEFINE l_cnt2           LIKE type_t.num5
DEFINE l_isai002        LIKE isai_t.isai002
DEFINE l_gzcb004        LIKE gzcb_t.gzcb004
DEFINE l_isac008        LIKE isac_t.isac008   #150812-00010#2
DEFINE l_isao001        LIKE isao_t.isao001
DEFINE l_isao002        LIKE isao_t.isao002
DEFINE l_isao003        LIKE isao_t.isao003
DEFINE l_isao004        LIKE isao_t.isao004
DEFINE l_isao005        LIKE isao_t.isao005
DEFINE l_isam029        LIKE isam_t.isam029
DEFINE l_isak008        LIKE isak_t.isak008
DEFINE l_isak009        LIKE isak_t.isak009
DEFINE l_isak010        LIKE isak_t.isak010
DEFINE l_isak011        LIKE isak_t.isak011
DEFINE l_isak012        LIKE isak_t.isak012
DEFINE l_ooef002        LIKE ooef_t.ooef002 
DEFINE l_ooef019        LIKE ooef_t.ooef019           #稅區
#DEFINE l_isam           RECORD LIKE isam_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_isam RECORD  #進項發票主檔
       isament LIKE isam_t.isament, #企業編號
       isamownid LIKE isam_t.isamownid, #資料所有者
       isamowndp LIKE isam_t.isamowndp, #資料所屬部門
       isamcrtid LIKE isam_t.isamcrtid, #資料建立者
       isamcrtdp LIKE isam_t.isamcrtdp, #資料建立部門
       isamcrtdt LIKE isam_t.isamcrtdt, #資料創建日
       isammodid LIKE isam_t.isammodid, #資料修改者
       isammoddt LIKE isam_t.isammoddt, #最近修改日
       isamcnfid LIKE isam_t.isamcnfid, #資料確認者
       isamcnfdt LIKE isam_t.isamcnfdt, #資料確認日
       isamstus LIKE isam_t.isamstus, #狀態碼
       isamcomp LIKE isam_t.isamcomp, #法人
       isamdocno LIKE isam_t.isamdocno, #收票單號
       isamseq LIKE isam_t.isamseq, #項次
       isam001 LIKE isam_t.isam001, #發票來源
       isam002 LIKE isam_t.isam002, #開發票人
       isam004 LIKE isam_t.isam004, #帳務中心(業務組織)
       isam006 LIKE isam_t.isam006, #業務部門(登錄部門)
       isam008 LIKE isam_t.isam008, #發票類型
       isam009 LIKE isam_t.isam009, #銷方發票編號
       isam010 LIKE isam_t.isam010, #發票號碼
       isam011 LIKE isam_t.isam011, #發票日期
       isam012 LIKE isam_t.isam012, #稅別
       isam0121 LIKE isam_t.isam0121, #含稅否
       isam013 LIKE isam_t.isam013, #稅率
       isam014 LIKE isam_t.isam014, #幣別
       isam015 LIKE isam_t.isam015, #匯率
       isam016 LIKE isam_t.isam016, #購貨方名稱
       isam017 LIKE isam_t.isam017, #購貨方統一編號
       isam018 LIKE isam_t.isam018, #購貨方地址
       isam019 LIKE isam_t.isam019, #購貨方電話
       isam020 LIKE isam_t.isam020, #購貨方開戶銀行
       isam021 LIKE isam_t.isam021, #購貨方帳戶編碼
       isam022 LIKE isam_t.isam022, #銷方銀行帳戶編碼
       isam023 LIKE isam_t.isam023, #發票原幣未稅金額
       isam024 LIKE isam_t.isam024, #發票原幣稅額
       isam025 LIKE isam_t.isam025, #發票原幣含稅金額
       isam026 LIKE isam_t.isam026, #發票本幣未稅金額
       isam027 LIKE isam_t.isam027, #發票本幣稅額
       isam028 LIKE isam_t.isam028, #發票本幣含稅金額
       isam029 LIKE isam_t.isam029, #銷貨方名稱
       isam030 LIKE isam_t.isam030, #統一編號
       isam031 LIKE isam_t.isam031, #銷貨方地址
       isam032 LIKE isam_t.isam032, #銷貨方電話
       isam033 LIKE isam_t.isam033, #銷貨方開戶銀行
       isam034 LIKE isam_t.isam034, #銷貨方帳號
       isam035 LIKE isam_t.isam035, #申報數量
       isam036 LIKE isam_t.isam036, #異動狀態
       isam037 LIKE isam_t.isam037, #可扣抵編號
       isam038 LIKE isam_t.isam038, #作廢(註銷)理由碼
       isam039 LIKE isam_t.isam039, #作廢日期
       isam040 LIKE isam_t.isam040, #作廢時間
       isam041 LIKE isam_t.isam041, #作廢人員
       isam042 LIKE isam_t.isam042, #專案作廢核准文號
       isam043 LIKE isam_t.isam043, #通關方式註記
       isam044 LIKE isam_t.isam044, #列印次數
       isam045 LIKE isam_t.isam045, #支付工具卡號1
       isam046 LIKE isam_t.isam046, #支付工具卡號2
       isam047 LIKE isam_t.isam047, #支付工具卡號3
       isam048 LIKE isam_t.isam048, #通關註記
       isam049 LIKE isam_t.isam049, #備註說明
       isam050 LIKE isam_t.isam050, #立帳單號
       isam107 LIKE isam_t.isam107, #發票原幣已折金額
       isam108 LIKE isam_t.isam108, #發票原幣已折稅額
       isam117 LIKE isam_t.isam117, #發票本幣已折金額
       isam118 LIKE isam_t.isam118, #發票本幣已折稅額
       isam200 LIKE isam_t.isam200, #電子發票否
       isam201 LIKE isam_t.isam201, #愛心碼
       isam202 LIKE isam_t.isam202, #載具類別號碼
       isam203 LIKE isam_t.isam203, #載具顯碼 ID
       isam204 LIKE isam_t.isam204, #載具隱碼 ID
       isam205 LIKE isam_t.isam205, #電子發票匯出狀態
       isam206 LIKE isam_t.isam206, #電子發票匯出序號
       isam207 LIKE isam_t.isam207, #電子發票領取方式
       isam208 LIKE isam_t.isam208, #申報年度
       isam209 LIKE isam_t.isam209, #申報月份
       isam210 LIKE isam_t.isam210, #申報據點
       isamud001 LIKE isam_t.isamud001, #自定義欄位(文字)001
       isamud002 LIKE isam_t.isamud002, #自定義欄位(文字)002
       isamud003 LIKE isam_t.isamud003, #自定義欄位(文字)003
       isamud004 LIKE isam_t.isamud004, #自定義欄位(文字)004
       isamud005 LIKE isam_t.isamud005, #自定義欄位(文字)005
       isamud006 LIKE isam_t.isamud006, #自定義欄位(文字)006
       isamud007 LIKE isam_t.isamud007, #自定義欄位(文字)007
       isamud008 LIKE isam_t.isamud008, #自定義欄位(文字)008
       isamud009 LIKE isam_t.isamud009, #自定義欄位(文字)009
       isamud010 LIKE isam_t.isamud010, #自定義欄位(文字)010
       isamud011 LIKE isam_t.isamud011, #自定義欄位(數字)011
       isamud012 LIKE isam_t.isamud012, #自定義欄位(數字)012
       isamud013 LIKE isam_t.isamud013, #自定義欄位(數字)013
       isamud014 LIKE isam_t.isamud014, #自定義欄位(數字)014
       isamud015 LIKE isam_t.isamud015, #自定義欄位(數字)015
       isamud016 LIKE isam_t.isamud016, #自定義欄位(數字)016
       isamud017 LIKE isam_t.isamud017, #自定義欄位(數字)017
       isamud018 LIKE isam_t.isamud018, #自定義欄位(數字)018
       isamud019 LIKE isam_t.isamud019, #自定義欄位(數字)019
       isamud020 LIKE isam_t.isamud020, #自定義欄位(數字)020
       isamud021 LIKE isam_t.isamud021, #自定義欄位(日期時間)021
       isamud022 LIKE isam_t.isamud022, #自定義欄位(日期時間)022
       isamud023 LIKE isam_t.isamud023, #自定義欄位(日期時間)023
       isamud024 LIKE isam_t.isamud024, #自定義欄位(日期時間)024
       isamud025 LIKE isam_t.isamud025, #自定義欄位(日期時間)025
       isamud026 LIKE isam_t.isamud026, #自定義欄位(日期時間)026
       isamud027 LIKE isam_t.isamud027, #自定義欄位(日期時間)027
       isamud028 LIKE isam_t.isamud028, #自定義欄位(日期時間)028
       isamud029 LIKE isam_t.isamud029, #自定義欄位(日期時間)029
       isamud030 LIKE isam_t.isamud030, #自定義欄位(日期時間)030
       isam051 LIKE isam_t.isam051  #認證否
END RECORD
#161111-00048#2 --e add
DEFINE l_pmds           RECORD 
          pmdsdocdt     LIKE pmds_t.pmdsdocdt,
          pmdssite      LIKE pmds_t.pmdssite,
          pmds000       LIKE pmds_t.pmds000,
          pmds008       LIKE pmds_t.pmds008,
          pmds033       LIKE pmds_t.pmds033,
          pmds034       LIKE pmds_t.pmds034,
          pmds035       LIKE pmds_t.pmds035,
          pmds037       LIKE pmds_t.pmds037,
          pmds038       LIKE pmds_t.pmds038,    
          #150921--s          
          pmds043       LIKE pmds_t.pmds043,
          pmds046       LIKE pmds_t.pmds046,
          pmds044       LIKE pmds_t.pmds044,
          #150921--e          
          pmds006       LIKE pmds_t.pmds006     #倉退對應的入庫單號   #albireo 151021 add
                         END RECORD
DEFINE l_pmdt           RECORD 
        pmdt024        LIKE pmdt_t.pmdt024,
        pmdt038        LIKE pmdt_t.pmdt038,
        pmdt039        LIKE pmdt_t.pmdt039,
        pmdt047        LIKE pmdt_t.pmdt047,
        pmdt049        LIKE pmdt_t.pmdt049,
        pmdt050        LIKE pmdt_t.pmdt050          
                        END RECORD
#DEFINE l_apca           RECORD LIKE apca_t.* #161111-00048#2 mark
#DEFINE l_apbb           RECORD LIKE apbb_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE l_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE l_apbb RECORD  #進項發票對帳主檔
       apbbent LIKE apbb_t.apbbent, #企業編號
       apbbownid LIKE apbb_t.apbbownid, #資料所有者
       apbbowndp LIKE apbb_t.apbbowndp, #資料所屬部門
       apbbcrtid LIKE apbb_t.apbbcrtid, #資料建立者
       apbbcrtdp LIKE apbb_t.apbbcrtdp, #資料建立部門
       apbbcrtdt LIKE apbb_t.apbbcrtdt, #資料創建日
       apbbmodid LIKE apbb_t.apbbmodid, #資料修改者
       apbbmoddt LIKE apbb_t.apbbmoddt, #最近修改日
       apbbcnfid LIKE apbb_t.apbbcnfid, #資料確認者
       apbbcnfdt LIKE apbb_t.apbbcnfdt, #資料確認日
       apbbstus LIKE apbb_t.apbbstus, #狀態碼
       apbbcomp LIKE apbb_t.apbbcomp, #法人
       apbbdocno LIKE apbb_t.apbbdocno, #對帳單號碼
       apbbseq LIKE apbb_t.apbbseq, #項次
       apbbdocdt LIKE apbb_t.apbbdocdt, #單據日期
       apbb001 LIKE apbb_t.apbb001, #發票來源
       apbb002 LIKE apbb_t.apbb002, #開發票人
       apbb004 LIKE apbb_t.apbb004, #帳務中心(業務組織)
       apbb006 LIKE apbb_t.apbb006, #業務部門(登入部門)
       apbb008 LIKE apbb_t.apbb008, #發票類型
       apbb009 LIKE apbb_t.apbb009, #銷方發票編號
       apbb010 LIKE apbb_t.apbb010, #發票號碼
       apbb011 LIKE apbb_t.apbb011, #發票日期
       apbb012 LIKE apbb_t.apbb012, #稅別
       apbb0121 LIKE apbb_t.apbb0121, #含稅否
       apbb013 LIKE apbb_t.apbb013, #稅率
       apbb014 LIKE apbb_t.apbb014, #幣別
       apbb015 LIKE apbb_t.apbb015, #匯率
       apbb016 LIKE apbb_t.apbb016, #購貨方名稱
       apbb017 LIKE apbb_t.apbb017, #購貨方統一編號
       apbb018 LIKE apbb_t.apbb018, #購貨方地址
       apbb019 LIKE apbb_t.apbb019, #購貨方電話
       apbb020 LIKE apbb_t.apbb020, #購貨方開戶銀行
       apbb021 LIKE apbb_t.apbb021, #購貨方帳戶編碼
       apbb022 LIKE apbb_t.apbb022, #銷方銀行帳戶編碼
       apbb023 LIKE apbb_t.apbb023, #發票原幣未稅金額
       apbb024 LIKE apbb_t.apbb024, #發票原幣稅額
       apbb025 LIKE apbb_t.apbb025, #發票原幣含稅金額
       apbb026 LIKE apbb_t.apbb026, #發票本幣未稅金額
       apbb027 LIKE apbb_t.apbb027, #發票本幣稅額
       apbb028 LIKE apbb_t.apbb028, #發票本幣含稅金額
       apbb029 LIKE apbb_t.apbb029, #銷貨方名稱
       apbb030 LIKE apbb_t.apbb030, #統一編號
       apbb031 LIKE apbb_t.apbb031, #銷貨方地址
       apbb032 LIKE apbb_t.apbb032, #銷貨方電話
       apbb033 LIKE apbb_t.apbb033, #銷貨方開戶銀行
       apbb034 LIKE apbb_t.apbb034, #銷貨方帳號
       apbb035 LIKE apbb_t.apbb035, #申報數量
       apbb036 LIKE apbb_t.apbb036, #異動狀態
       apbb037 LIKE apbb_t.apbb037, #可扣抵編號
       apbb038 LIKE apbb_t.apbb038, #作廢(登出)理由碼
       apbb039 LIKE apbb_t.apbb039, #作廢日期
       apbb040 LIKE apbb_t.apbb040, #作廢時間
       apbb041 LIKE apbb_t.apbb041, #作廢人員
       apbb042 LIKE apbb_t.apbb042, #專案作廢核准文號
       apbb043 LIKE apbb_t.apbb043, #通關方式註記
       apbb044 LIKE apbb_t.apbb044, #列印次數
       apbb045 LIKE apbb_t.apbb045, #支付工具卡號1
       apbb046 LIKE apbb_t.apbb046, #支付工具卡號2
       apbb047 LIKE apbb_t.apbb047, #支付工具卡號3
       apbb048 LIKE apbb_t.apbb048, #通關註記
       apbb049 LIKE apbb_t.apbb049, #備註說明
       apbb050 LIKE apbb_t.apbb050, #發票性質
       apbb051 LIKE apbb_t.apbb051, #採購人員
       apbb052 LIKE apbb_t.apbb052, #採購部門
       apbb053 LIKE apbb_t.apbb053, #登入日期
       apbb054 LIKE apbb_t.apbb054, #付款條件
       apbb107 LIKE apbb_t.apbb107, #發票原幣已折金額
       apbb108 LIKE apbb_t.apbb108, #發票原幣已折稅額
       apbb117 LIKE apbb_t.apbb117, #發票本幣已折金額
       apbb118 LIKE apbb_t.apbb118, #發票本幣已折稅額
       apbb200 LIKE apbb_t.apbb200, #電子發票否
       apbb201 LIKE apbb_t.apbb201, #愛心碼
       apbb202 LIKE apbb_t.apbb202, #載具類別號碼
       apbb203 LIKE apbb_t.apbb203, #載具顯碼 ID
       apbb204 LIKE apbb_t.apbb204, #載具隱碼 ID
       apbb205 LIKE apbb_t.apbb205, #電子發票匯出狀態
       apbb206 LIKE apbb_t.apbb206, #電子發票匯出序號
       apbb207 LIKE apbb_t.apbb207, #電子發票領取方式
       apbb208 LIKE apbb_t.apbb208, #申報年度
       apbb209 LIKE apbb_t.apbb209, #申報月份
       apbb210 LIKE apbb_t.apbb210, #申報據點
       apbbud001 LIKE apbb_t.apbbud001, #自定義欄位(文字)001
       apbbud002 LIKE apbb_t.apbbud002, #自定義欄位(文字)002
       apbbud003 LIKE apbb_t.apbbud003, #自定義欄位(文字)003
       apbbud004 LIKE apbb_t.apbbud004, #自定義欄位(文字)004
       apbbud005 LIKE apbb_t.apbbud005, #自定義欄位(文字)005
       apbbud006 LIKE apbb_t.apbbud006, #自定義欄位(文字)006
       apbbud007 LIKE apbb_t.apbbud007, #自定義欄位(文字)007
       apbbud008 LIKE apbb_t.apbbud008, #自定義欄位(文字)008
       apbbud009 LIKE apbb_t.apbbud009, #自定義欄位(文字)009
       apbbud010 LIKE apbb_t.apbbud010, #自定義欄位(文字)010
       apbbud011 LIKE apbb_t.apbbud011, #自定義欄位(數字)011
       apbbud012 LIKE apbb_t.apbbud012, #自定義欄位(數字)012
       apbbud013 LIKE apbb_t.apbbud013, #自定義欄位(數字)013
       apbbud014 LIKE apbb_t.apbbud014, #自定義欄位(數字)014
       apbbud015 LIKE apbb_t.apbbud015, #自定義欄位(數字)015
       apbbud016 LIKE apbb_t.apbbud016, #自定義欄位(數字)016
       apbbud017 LIKE apbb_t.apbbud017, #自定義欄位(數字)017
       apbbud018 LIKE apbb_t.apbbud018, #自定義欄位(數字)018
       apbbud019 LIKE apbb_t.apbbud019, #自定義欄位(數字)019
       apbbud020 LIKE apbb_t.apbbud020, #自定義欄位(數字)020
       apbbud021 LIKE apbb_t.apbbud021, #自定義欄位(日期時間)021
       apbbud022 LIKE apbb_t.apbbud022, #自定義欄位(日期時間)022
       apbbud023 LIKE apbb_t.apbbud023, #自定義欄位(日期時間)023
       apbbud024 LIKE apbb_t.apbbud024, #自定義欄位(日期時間)024
       apbbud025 LIKE apbb_t.apbbud025, #自定義欄位(日期時間)025
       apbbud026 LIKE apbb_t.apbbud026, #自定義欄位(日期時間)026
       apbbud027 LIKE apbb_t.apbbud027, #自定義欄位(日期時間)027
       apbbud028 LIKE apbb_t.apbbud028, #自定義欄位(日期時間)028
       apbbud029 LIKE apbb_t.apbbud029, #自定義欄位(日期時間)029
       apbbud030 LIKE apbb_t.apbbud030, #自定義欄位(日期時間)030
       apbb055 LIKE apbb_t.apbb055, #付款到期日
       apbb056 LIKE apbb_t.apbb056, #for流通
       apbb057 LIKE apbb_t.apbb057, #應付單號
       apbb058 LIKE apbb_t.apbb058, #經營方式
       apbb003 LIKE apbb_t.apbb003  #對帳來源
END RECORD
#161111-00048#2 --e add
DEFINE l_pmaa003        LIKE pmaa_t.pmaa003
DEFINE l_way            LIKE type_t.chr10
DEFINE l_apcb002        LIKE apcb_t.apcb002
DEFINE l_sql  STRING
DEFINE l_apcb           RECORD                     #151230-00005#2--(S)--add
         apcb027        LIKE apcb_t.apcb027,
         apcb028        LIKE apcb_t.apcb028,
         apcb103        LIKE apcb_t.apcb103,
         apcb104        LIKE apcb_t.apcb104,
         apcb105        LIKE apcb_t.apcb105,
         apcb113        LIKE apcb_t.apcb113,
         apcb114        LIKE apcb_t.apcb114,
         apcb115        LIKE apcb_t.apcb115
                    END RECORD                     #151230-00005#2--(E)--add

WHENEVER ERROR CONTINUE

#先撈出這張入庫單的收貨單號
#再撈出這張收貨單號的發票
#check這張發票有沒有存在isam_t
#沒有就寫入
   
   #這裡的r_success一律先給TRUE，因為這裡只是有發票就輔助帶入，若執行失敗不代表整體程式執行失敗
   LET r_success = TRUE
   
   INITIALIZE l_master.* TO NULL
   LET l_master.l_docno = p_array[1].chr
   LET l_master.l_ld    = p_array[2].chr      

   INITIALIZE l_apca.* TO NULL
   SELECT * INTO l_apca.* FROM apca_t WHERE apcaent = g_enterprise AND apcadocno = l_master.l_docno AND apcald = l_master.l_ld   #161208-00026#22   mark
   #161208-00026#22   add---s
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073
     INTO l_apca.*
     FROM apca_t
    WHERE apcaent = g_enterprise 
      AND apcadocno = l_master.l_docno 
      AND apcald = l_master.l_ld
   #161208-00026#22   add---e
   INITIALIZE l_pmds.pmds000  TO NULL
  #SELECT pmds000 INTO l_pmds.pmds000 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = l_apca.apca018 #150921 mark
  #150921--s
  SELECT pmds000,pmds043,pmds046,pmds044 INTO l_pmds.pmds000,l_pmds.pmds043,l_pmds.pmds046,l_pmds.pmds044
    FROM pmds_t    
   WHERE pmdsent = g_enterprise 
     AND pmdsdocno = l_apca.apca018   
  #150921--e
  
   CALL s_fin_get_scc_value('2060',l_pmds.pmds000,'2')RETURNING l_way  #判斷是正向還是負向

   
   #購貨方名稱
   SELECT ooefl004 INTO l_pmdw.pmdw016 FROM ooefl_t
    WHERE ooeflent = g_enterprise
      AND ooefl001 = l_apca.apcasite
      AND ooefl002 = g_lang
         
   #納稅人識別號/開立發票地址/開立發票電話/開立發票銀行名稱   
   SELECT isao001,isao002,isao003,isao004,isao005
     INTO l_isao001,l_isao002,l_isao003,l_isao004,l_isao005
     FROM isao_t
    WHERE isaoent = g_enterprise
      AND isaosite= l_apca.apcasite
   
   #抓取稅區
    SELECT ooef019 INTO l_ooef019
      FROM ooef_t
     WHERE ooefent = g_enterprise
       AND ooef001 = l_apca.apcacomp
            
    SELECT isak008,isak009,isak010,isak011,isak012
      INTO l_isak008,l_isak009,l_isak010,l_isak011,l_isak012
      FROM isak_t
     WHERE isakent = g_enterprise
       AND isak001 = l_apca.apca004
       AND isak002 = l_ooef019
        
   #銷貨方名稱        
   SELECT pmaal003 INTO l_isam029 FROM pmaal_t
    WHERE pmaalent = g_enterprise
      AND pmaal001 = l_apca.apca004
      AND pmaal002 = g_dlang
           
   #稅務編號/統一編號
   SELECT ooef002 INTO l_ooef002
     FROM ooef_t
    WHERE ooef001 = l_apca.apcasite
      AND ooefent = g_enterprise   
           
   SELECT pmaa003 INTO l_pmaa003 FROM pmaa_t
    WHERE pmaaent = g_enterprise
      AND pmaa001 = l_pmds.pmds008
   
   #發票編碼方式
   SELECT isai002 INTO l_isai002
     FROM ooef_t
     LEFT JOIN isai_t ON ooefent = isaient AND ooef019 = isai001
    WHERE ooefent = g_enterprise
      AND ooef001 = l_apca.apcacomp        
    
   IF l_way = '1' THEN
      LET l_sql = " SELECT DISTINCT apcb002  ",
                  "   FROM apcb_t            ",
                  "  WHERE apcbent = '",g_enterprise,"' ",
                  "    AND apcbdocno = '",l_apca.apcadocno,"' ",
                  "    AND apcbld ='",l_apca.apcald ,"' "
      PREPARE s_aapp131_prep2 FROM l_sql
      DECLARE s_aapp131_curs2 CURSOR FOR s_aapp131_prep2
      FOREACH s_aapp131_curs2 INTO l_apcb002 #來源單號入庫單
         SELECT pmds000 INTO l_pmds.pmds000 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = l_apcb002  
                  
         IF l_pmds.pmds000 MATCHES '[34]' OR l_pmds.pmds000 = '20' THEN  
            LET l_receiveno = l_apcb002
         END IF
         IF SQLCA.SQLcode OR cl_null(l_receiveno) THEN
            #因為樣板是用SQLCA.SQLcode來判斷程式有沒有執行錯誤，這裡若錯誤會影響判斷，因此要給0
            LET SQLCA.SQLcode = 0  
            RETURN r_success
         END IF      
         SELECT pmdw001,pmdw002,pmdw008,pmdw009,pmdw010,
                pmdw011,pmdw012,pmdw0121,pmdw013,pmdw014,
                pmdw015,pmdw016,pmdw017,pmdw018,pmdw019,
                pmdw020,pmdw021,pmdw022,pmdw023,pmdw024,
                pmdw025,pmdw026,pmdw027,pmdw028,pmdw029,
                pmdw030,pmdw031,pmdw032,pmdw033,pmdw034,
                pmdw035,pmdw036,pmdw037,pmdw038,pmdw039,
                pmdw040,pmdw041,pmdw042,pmdw043,pmdw045,
                pmdw046,pmdw047,pmdw048,pmdw049,
                pmdw201,pmdw202,pmdw203,pmdw204,pmdw205,
                pmdw206,pmdw207
           INTO l_pmdw.pmdw001,l_pmdw.pmdw002,l_pmdw.pmdw008,l_pmdw.pmdw009,l_pmdw.pmdw010,
                l_pmdw.pmdw011,l_pmdw.pmdw012,l_pmdw.pmdw0121,l_pmdw.pmdw013,l_pmdw.pmdw014,
                l_pmdw.pmdw015,l_pmdw.pmdw016,l_pmdw.pmdw017,l_pmdw.pmdw018,l_pmdw.pmdw019,
                l_pmdw.pmdw020,l_pmdw.pmdw021,l_pmdw.pmdw022,l_pmdw.pmdw023,l_pmdw.pmdw024,
                l_pmdw.pmdw025,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028,l_pmdw.pmdw029,
                l_pmdw.pmdw030,l_pmdw.pmdw031,l_pmdw.pmdw032,l_pmdw.pmdw033,l_pmdw.pmdw034,
                l_pmdw.pmdw035,l_pmdw.pmdw036,l_pmdw.pmdw037,l_pmdw.pmdw038,l_pmdw.pmdw039,
                l_pmdw.pmdw040,l_pmdw.pmdw041,l_pmdw.pmdw042,l_pmdw.pmdw043,l_pmdw.pmdw045,
                l_pmdw.pmdw046,l_pmdw.pmdw047,l_pmdw.pmdw048,l_pmdw.pmdw049,
                l_pmdw.pmdw201,l_pmdw.pmdw202,l_pmdw.pmdw203,l_pmdw.pmdw204,l_pmdw.pmdw205,
                l_pmdw.pmdw206,l_pmdw.pmdw207
           FROM pmdw_t
          WHERE pmdwent = g_enterprise
            AND pmdwdocno = l_receiveno
         IF SQLCA.SQLcode OR cl_null(l_pmdw.pmdw010) THEN
            #因為樣板是用SQLCA.SQLcode來判斷程式有沒有執行錯誤，這裡若錯誤會影響判斷，因此要給0
            LET SQLCA.SQLcode = 0  
            RETURN r_success
         END IF     
         SELECT pmds037 INTO l_pmdw.pmdw014 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = l_apcb002 #180725-00057 add     
         LET l_cnt = 0
      
         IF l_isai002 = "1" THEN
            #SELECT COUNT(*) INTO l_cnt         #161114-00009#1 mark
            SELECT COUNT(isamdocno) INTO l_cnt  #161114-00009#1 add
              FROM isam_t,apbb_t
             WHERE isament = apbbent AND isamdocno = apbbdocno
               AND isament = g_enterprise
               AND apbbstus <> 'X'
               AND isam010 = l_pmdw.pmdw010
               
             #SELECT COUNT(*) INTO l_cnt2          #161114-00009#1 mark
             SELECT COUNT(isamdocno) INTO l_cnt2   #161114-00009#1 add
              FROM isam_t,apca_t
             WHERE isament = apcaent AND isamdocno = apcadocno
               AND isament = g_enterprise
               AND apcastus <> 'X'
               AND isam010 = l_pmdw.pmdw010
         
            #抓取發票聯別，若是0、4無論是否存在aapt110,一律產生
            SELECT isac008 INTO l_isac008
              FROM isac_t
              LEFT JOIN ooef_t ON ooefent = isacent AND ooef019 = isac001
             WHERE isacent = g_enterprise
               AND ooef001 = l_apbb.apbbcomp  #150921
               AND isac002 = l_pmdw.pmdw008
            IF l_isac008 MATCHES '[04]' THEN
               LET l_cnt = 0
            END IF      
         ELSE 
            #SELECT COUNT(*) INTO l_cnt        #161114-00009#1 mark
            SELECT COUNT(isamdocno) INTO l_cnt #161114-00009#1 add
              FROM isam_t,apbb_t
             WHERE isament = apbbent AND isamdocno = apbbdocno
               AND isament = g_enterprise
               AND apbbstus <> 'X'
               AND isam009 = l_pmdw.pmdw009
               AND isam010 = l_pmdw.pmdw010
               
           #SELECT COUNT(*)INTO l_cnt2        #161114-00009#1 mark
           SELECT COUNT(isamdocno)INTO l_cnt2 #161114-00009#1 add
             FROM isam_t,apca_t
             WHERE isament = apcaent 
               AND isament = g_enterprise #170615-00061#1 add
               AND isamdocno = apcadocno
               AND apcastus <> 'X'
               AND isam009 = l_pmdw.pmdw009
               AND isam010 = l_pmdw.pmdw010
               
         END IF
      
         IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         IF cl_null(l_cnt2) THEN LET l_cnt2 = 0 END IF
                      
         IF l_cnt = 0 AND l_cnt2 = 0 THEN
            #項次
            SELECT MAX(isamseq)+1 INTO l_isamseq FROM isam_t
             WHERE isament = g_enterprise AND isamdocno = l_apca.apcadocno
            IF cl_null(l_isamseq) OR l_isamseq = 0 THEN
               LET l_isamseq = 1
            END IF   
            IF cl_null(l_pmdw.pmdw017) THEN LET l_pmdw.pmdw017 = l_isao001 END IF
            IF cl_null(l_pmdw.pmdw018) THEN LET l_pmdw.pmdw018 = l_isao002 END IF
            IF cl_null(l_pmdw.pmdw019) THEN LET l_pmdw.pmdw019 = l_isao003 END IF
            IF cl_null(l_pmdw.pmdw020) THEN LET l_pmdw.pmdw020 = l_isao004 END IF
            IF cl_null(l_pmdw.pmdw021) THEN LET l_pmdw.pmdw021 = l_isao005 END IF
            IF cl_null(l_pmdw.pmdw022) THEN LET l_pmdw.pmdw022 = '' END IF
            
            IF cl_null(l_pmdw.pmdw029) THEN LET l_pmdw.pmdw029 = l_isam029 END IF
            IF cl_null(l_pmdw.pmdw030) THEN LET l_pmdw.pmdw030 = l_ooef002 END IF
            IF cl_null(l_pmdw.pmdw031) THEN LET l_pmdw.pmdw031 = l_isak009 END IF
            IF cl_null(l_pmdw.pmdw032) THEN LET l_pmdw.pmdw032 = l_isak010 END IF
            IF cl_null(l_pmdw.pmdw033) THEN LET l_pmdw.pmdw033 = l_isak011 END IF
            IF cl_null(l_pmdw.pmdw034) THEN LET l_pmdw.pmdw034 = l_isak012 END IF
           
           #150921 mark--s
           ##重新計算本幣金額
           ##規則：匯率=1則本幣=原幣，若<>1則call s_tax重算本幣
           #IF l_pmdw.pmdw015 = 1 THEN
           #   LET l_pmdw.pmdw026 = l_pmdw.pmdw023
           #   LET l_pmdw.pmdw027 = l_pmdw.pmdw024
           #   LET l_pmdw.pmdw028 = l_pmdw.pmdw025
           #ELSE
           #   IF l_apca.apca013 = "Y" THEN
           #      CALL s_tax_count(l_apca.apcacomp,l_apca.apca011,l_pmdw.pmdw025,1,l_apca.apca100,l_apca.apca101)
           #           RETURNING l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025
           #                    ,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028
           #   ELSE
           #      CALL s_tax_count(l_apca.apcacomp,l_apca.apca011,l_pmdw.pmdw023,1,l_apca.apca100,l_apca.apca101)
           #           RETURNING l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025
           #                    ,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028
           #   END IF
           #END IF    
           #150921 mark--e
            LET l_gzcb004 = s_fin_get_scc_value('2060',l_pmds.pmds000,'2')            
            IF l_gzcb004 = 1 THEN            
               LET l_pmdw.pmdw036 = '11'
            ELSE
               LET l_pmdw.pmdw036 = '21'
            END IF
            
            LET l_pmdw.pmdw038 = ''
            LET l_pmdw.pmdw039 = ''
         
            #160906-00005#1 -----s
            LET l_pmdw.pmdw001 = 'aapt300'
            #160906-00005#1 -----e
            
            #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
            IF cl_null(l_pmdw.pmdw015) THEN LET l_pmdw.pmdw015 = 0 END IF  #原幣單價
            IF cl_null(l_pmdw.pmdw026) THEN LET l_pmdw.pmdw026 = 0 END IF  #原幣匯率
            IF cl_null(l_pmdw.pmdw027) THEN LET l_pmdw.pmdw027 = 0 END IF  #原幣未稅金額
            IF cl_null(l_pmdw.pmdw028) THEN LET l_pmdw.pmdw028 = 0 END IF  #原幣稅額
            IF cl_null(l_pmdw.pmdw023) THEN LET l_pmdw.pmdw023 = 0 END IF  #原幣含稅金額
            IF cl_null(l_pmdw.pmdw024) THEN LET l_pmdw.pmdw024 = 0 END IF  #原幣沖銷差異金額
            IF cl_null(l_pmdw.pmdw025) THEN LET l_pmdw.pmdw025 = 0 END IF  #本幣單價
            #180130-00050#5---add by 10554---(E)
            
            INSERT INTO isam_t
                  (isament,isamdocno,isamseq,isamstus,isamcomp,
                   isam001,isam002,isam004,isam008,isam009,
                   isam010,isam011,isam012,isam0121,isam013,
                   isam014,isam015,isam016,isam017,isam018,
                   isam019,isam020,isam021,isam022,isam023,
                   isam024,isam025,isam026,isam027,isam028,
                   isam029,isam030,isam031,isam032,isam033,
                   isam034,isam035,isam036,isam037,isam038,
                   isam039,isam040,isam041,isam042,isam043,
                   isam044,isam045,isam046,isam047,isam048,
                   isam049,isam050,isam053,   #171005-00006#18 add isam053
                   isam107,isam108,isam117,isam118,isam200,
                   isam201,isam202,isam203,isam204,isam205,
                   isam206,isam207,isam208,isam209,isam210
                  )
            VALUES(g_enterprise,l_apca.apcadocno,l_isamseq,'Y',l_apca.apcacomp,
                   l_pmdw.pmdw001,l_pmdw.pmdw002,l_apca.apca015,l_pmdw.pmdw008,l_pmdw.pmdw009,
                   l_pmdw.pmdw010,l_pmdw.pmdw011,l_pmdw.pmdw012,l_pmdw.pmdw0121,l_pmdw.pmdw013,
                   l_pmdw.pmdw014,l_pmdw.pmdw015,l_pmdw.pmdw016,l_pmdw.pmdw017,l_pmdw.pmdw018,
                  #l_pmdw.pmdw019,l_pmdw.pmdw020,l_pmdw.pmdw021,l_pmdw.pmdw022,l_pmdw.pmdw023,  #150921 mark
                  #l_pmdw.pmdw024,l_pmdw.pmdw025,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028,  #150921 mark
                  #l_pmdw.pmdw019,l_pmdw.pmdw020,l_pmdw.pmdw021,l_pmdw.pmdw022,l_pmds.pmds043,  #150921 #151124 mark
                  #l_pmds.pmds046,l_pmds.pmds044,l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025,  #150921 #151124 mark
                   l_pmdw.pmdw019,l_pmdw.pmdw020,l_pmdw.pmdw021,l_pmdw.pmdw022,l_pmdw.pmdw026,  #151124 by albireo 
                   l_pmdw.pmdw027,l_pmdw.pmdw028,l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025,  #151124 by albireo
                   l_pmdw.pmdw029,l_pmdw.pmdw030,l_pmdw.pmdw031,l_pmdw.pmdw032,l_pmdw.pmdw033,
                   l_pmdw.pmdw034,l_pmdw.pmdw035,l_pmdw.pmdw036,l_pmdw.pmdw037,l_pmdw.pmdw038,
                   l_pmdw.pmdw039,l_pmdw.pmdw040,l_pmdw.pmdw041,l_pmdw.pmdw042,l_pmdw.pmdw043,
                   0,l_pmdw.pmdw045,l_pmdw.pmdw046,l_pmdw.pmdw047,l_pmdw.pmdw048,
                   l_pmdw.pmdw049,l_apca.apcadocno,l_pmdw.pmdw036,   #171005-00006#18 add l_pmdw.pmdw036
                   0,0,0,0,'N',
                   l_pmdw.pmdw201,l_pmdw.pmdw202,l_pmdw.pmdw203,l_pmdw.pmdw204,l_pmdw.pmdw205,
                   l_pmdw.pmdw206,l_pmdw.pmdw207,'','',''
                   )
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = "INSERT isam_t wrong!"
               LET g_errparam.code   = SQLCA.sqlcode
               LET g_errparam.popup  = TRUE
               CALL cl_err()
            END IF
         END IF
      END FOREACH
   ELSE
     #151230-00005#2--(S)
     # LET l_sql = " SELECT DISTINCT apcb002  ",
     #             "   FROM apcb_t            ",
     #             "  WHERE apcbent = '",g_enterprise,"' ",
     #             "    AND apcbdocno = '",l_apca.apcadocno,"' ",
     #             "    AND apcbld ='",l_apca.apcald ,"' "
      LET l_sql = " SELECT apcb002  ",
                     "   FROM apcb_t            ",
                     "  WHERE apcbent = '",g_enterprise,"' ",
                     "    AND apcbdocno = '",l_apca.apcadocno,"' ",
                     "    AND apcbld ='",l_apca.apcald ,"' ",
                     "    AND apcb028 = ? ",
                     " ORDER BY apcbseq"
      DECLARE ins_isam_get_apcb002_c SCROLL CURSOR FROM l_sql
      LET l_sql = " SELECT apcb027,apcb028,  ",
                  "        SUM(apcb103),SUM(apcb104),SUM(apcb105), ",
                  "        SUM(apcb113),SUM(apcb114),SUM(apcb115)  ",
                  "   FROM apcb_t            ",
                  "  WHERE apcbent = '",g_enterprise,"' ",
                  "    AND apcbdocno = '",l_apca.apcadocno,"' ",
                  "    AND apcbld ='",l_apca.apcald ,"' ",
                  "    AND apcb028 IS NOT NULL",
                  "  GROUP BY apcb027,apcb028 "
     #151230-00005#2--(E)
      PREPARE s_aapp131_prep3 FROM l_sql
      DECLARE s_aapp131_curs3 CURSOR FOR s_aapp131_prep3
     #FOREACH s_aapp131_curs3 INTO l_apcb002 #來源單號入庫單 #151230-00005#2 mark
      FOREACH s_aapp131_curs3 INTO l_apcb.apcb027,l_apcb.apcb028,                #151230-00005#2 add
                                   l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105, #151230-00005#2 add
                                   l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115  #151230-00005#2 add
         
         OPEN ins_isam_get_apcb002_c USING l_apcb.apcb028   #151230-00005#2
         FETCH FIRST ins_isam_get_apcb002_c INTO l_apcb002  #151230-00005#2
         
         SELECT pmds000,pmds008,pmdsdocdt,pmds033,
                pmds034,pmds035,pmds037,pmds038,pmdssite 
               ,pmds043,pmds046,pmds044,       #150921   
               pmds006       #albireo 151021 add
          INTO l_pmds.pmds000,l_pmds.pmds008,l_pmds.pmdsdocdt,l_pmds.pmds033,
               l_pmds.pmds034,l_pmds.pmds035,l_pmds.pmds037,l_pmds.pmds038,l_pmds.pmdssite  
              ,l_pmds.pmds043,l_pmds.pmds046,l_pmds.pmds044,   #150921                 
               l_pmds.pmds006   #albireo 151021 add              
          FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = l_apcb002
          
         SELECT ooefl004 INTO l_pmdw.pmdw016 FROM ooefl_t
          WHERE ooeflent = g_enterprise
            AND ooefl001 = l_pmds.pmdssite
            AND ooefl002 = g_dlang  
      
         LET l_sql = " SELECT pmdt024,pmdt038,pmdt039, ",
                     "        pmdt047,pmdt049,pmdt050  ",
                     "   FROM pmdt_t               ",
                     "  WHERE pmdtent = '",g_enterprise,"' ",
                     "    AND pmdtdocno ='",l_apcb002,"' ",
                     "    AND pmdt050 IS NOT NULL   "   
         PREPARE s_aapp131_pere  FROM l_sql  
         DECLARE s_aapp131_curs  CURSOR FOR s_aapp131_pere
         FOREACH  s_aapp131_curs INTO l_pmdt.pmdt024,l_pmdt.pmdt038,l_pmdt.pmdt039,
                                      l_pmdt.pmdt047,l_pmdt.pmdt049,l_pmdt.pmdt050         
            IF SQLCA.SQLCODE THEN
               EXIT FOREACH
            END IF                       
                  
            LET l_pmdw.pmdw001 = ''
            LET l_pmdw.pmdw002 = l_pmds.pmds008
            LET l_pmdw.pmdw008 = ''
            LET l_pmdw.pmdw009 = l_pmdt.pmdt049
            LET l_pmdw.pmdw010 = l_pmdt.pmdt050
            LET l_pmdw.pmdw011 = l_pmds.pmdsdocdt
            LET l_pmdw.pmdw012 = l_pmds.pmds033
            LET l_pmdw.pmdw0121 =l_pmds.pmds035
            LET l_pmdw.pmdw013 = l_pmds.pmds034
            LET l_pmdw.pmdw014 = l_pmds.pmds037
            LET l_pmdw.pmdw015 = l_pmds.pmds038
            
            #LET l_pmdw.pmdw017 = l_isao001  #albireo mark 151021
            #albireo 151021-----s
            SELECT ooef002 INTO l_pmdw.pmdw017 FROM ooef_t
             WHERE ooefent = g_enterprise
               AND ooef001 = l_apca.apcacomp
            #albireo 151021-----e
            LET l_pmdw.pmdw018 = l_isao002
            LET l_pmdw.pmdw019 = l_isao003
            LET l_pmdw.pmdw020 = l_isao004
            LET l_pmdw.pmdw021 = l_isao005
            LET l_pmdw.pmdw022 = ''
            
            LET l_pmdw.pmdw023 = l_pmdt.pmdt038 #發票原幣未稅金額
            LET l_pmdw.pmdw024 = l_pmdt.pmdt047 #發票原幣稅額
            LET l_pmdw.pmdw025 = l_pmdt.pmdt039 #發票原幣含稅金額
         
         
            LET l_pmdw.pmdw026 = '' #發票本幣未稅金額
            LET l_pmdw.pmdw027 = '' #發票本幣稅額 
            LET l_pmdw.pmdw028 = '' #發票本幣稅額
            
            LET l_pmdw.pmdw029 = l_isam029
            LET l_pmdw.pmdw030 = l_pmaa003
            LET l_pmdw.pmdw031 = l_isak009
            LET l_pmdw.pmdw032 = l_isak010
            LET l_pmdw.pmdw033 = l_isak011
            LET l_pmdw.pmdw034 = l_isak012
            LET l_pmdw.pmdw035 = l_pmdt.pmdt024
            LET l_pmdw.pmdw036 = ''
            LET l_pmdw.pmdw037 = '1'
            LET l_pmdw.pmdw038 =  ''
            LET l_pmdw.pmdw039 =  ''
            LET l_pmdw.pmdw040 =  ''
            LET l_pmdw.pmdw041 =  ''
            LET l_pmdw.pmdw042 =  ''
            LET l_pmdw.pmdw043 =  ''
            LET l_pmdw.pmdw045 =  ''
            LET l_pmdw.pmdw046 =  ''
            LET l_pmdw.pmdw047 =  ''
            LET l_pmdw.pmdw048 =  ''
            LET l_pmdw.pmdw049 =  ''
            LET l_pmdw.pmdw201 =  ''
            LET l_pmdw.pmdw202 =  ''
            LET l_pmdw.pmdw203 =  ''
            LET l_pmdw.pmdw204 =  ''
            LET l_pmdw.pmdw205 =  ''
            LET l_pmdw.pmdw206 =  ''
            LET l_pmdw.pmdw207 =  ''

         #################################
           #150904 by 03538 mark --s 同aapp320折單一律不考慮發票重複                        
           #IF l_isai002 = "1" THEN           
           #   SELECT COUNT(*) INTO l_cnt
           #     FROM isam_t,apbb_t
           #    WHERE isament = apbbent AND isamdocno = apbbdocno
           #      AND isament = g_enterprise
           #      AND apbbstus <> 'X'
           #      AND isam010 = l_pmdw.pmdw010
           #   
           #    SELECT COUNT(*) INTO l_cnt2
           #     FROM isam_t,apca_t
           #    WHERE isament = apcaent AND isamdocno = apcadocno
           #      AND isament = g_enterprise
           #      AND apcastus <> 'X'
           #      AND isam010 = l_pmdw.pmdw010
           #
           #     #抓取發票聯別，若是0、4無論是否存在aapt110,一律產生
           #     SELECT isac008 INTO l_isac008
           #       FROM isac_t
           #       LEFT JOIN ooef_t ON ooefent = isacent AND ooef019 = isac001
           #      WHERE isacent = g_enterprise
           #        AND ooef001 = l_apbb.apbbcomp
           #        AND isac002 = l_pmdw.pmdw008
           #     IF l_isac008 MATCHES '[04]' THEN
           #        LET l_cnt = 0
           #     END IF       
           #ELSE
           #   SELECT COUNT(*) INTO l_cnt
           #     FROM isam_t,apbb_t
           #    WHERE isament = apbbent AND isamdocno = apbbdocno
           #      AND isament = g_enterprise
           #      AND apbbstus <> 'X'
           #      AND isam009 = l_pmdw.pmdw009
           #      AND isam010 = l_pmdw.pmdw010
           #   
           #   SELECT COUNT(*)INTO l_cnt2
           #     FROM isam_t,apca_t
           #     WHERE isament = apcaent 
           #       AND isamdocno = apcadocno
           #       AND apcastus <> 'X'
           #       AND isam009 = l_pmdw.pmdw009
           #       AND isam010 = l_pmdw.pmdw010
           #   
           #END IF
           #150904 by 03538 mark --e            
            
            IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
            IF cl_null(l_cnt2) THEN LET l_cnt2 = 0 END IF
                   
            IF l_cnt = 0 AND l_cnt2 = 0 THEN
               #項次
               SELECT MAX(isamseq)+1 INTO l_isamseq FROM isam_t
                WHERE isament = g_enterprise AND isamdocno = l_apca.apcadocno
               IF cl_null(l_isamseq) OR l_isamseq = 0 THEN
                  LET l_isamseq = 1
               END IF      
              
              #150921 mark--s               
              ##重新計算本幣金額
              ##規則：匯率=1則本幣=原幣，若<>1則call s_tax重算本幣
              #IF l_pmdw.pmdw015 = 1 THEN
              #   LET l_pmdw.pmdw026 = l_pmdw.pmdw023
              #   LET l_pmdw.pmdw027 = l_pmdw.pmdw024
              #   LET l_pmdw.pmdw028 = l_pmdw.pmdw025
              #ELSE
              #   IF l_apca.apca013 = "Y" THEN
              #      CALL s_tax_count(l_apca.apcacomp,l_apca.apca011,l_pmdw.pmdw025,1,l_apca.apca100,l_apca.apca101)
              #           RETURNING l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025
              #                    ,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028
              #   ELSE
              #      CALL s_tax_count(l_apca.apcacomp,l_apca.apca011,l_pmdw.pmdw023,1,l_apca.apca100,l_apca.apca101)
              #           RETURNING l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025
              #                    ,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028
              #   END IF
              #END IF   
              #150921 mark--e 
               
               LET l_gzcb004 = s_fin_get_scc_value('2060',l_pmds.pmds000,'2')
               
               IF l_gzcb004 = 1 THEN
               
                  LET l_pmdw.pmdw036 = '11'
               ELSE
                  LET l_pmdw.pmdw036 = '21'
               END IF
               
               LET l_pmdw.pmdw038 = ''
               LET l_pmdw.pmdw039 = ''
               #151230-00005#2--(S)
               ##albireo 151014-----s
               #LET l_pmds.pmds043 = l_pmds.pmds043 * -1
               #LET l_pmds.pmds046 = l_pmds.pmds046 * -1
               #LET l_pmds.pmds044 = l_pmds.pmds044 * -1
               #LET l_pmdw.pmdw023 = l_pmdw.pmdw023 * -1
               #LET l_pmdw.pmdw024 = l_pmdw.pmdw024 * -1
               #LET l_pmdw.pmdw025 = l_pmdw.pmdw025 * -1
               ##albireo 151014-----e
               LET l_pmds.pmds043 = l_apcb.apcb103 * -1     #原幣未稅
               LET l_pmds.pmds046 = l_apcb.apcb104 * -1     #原幣稅額
               LET l_pmds.pmds044 = l_apcb.apcb105 * -1     #原幣含稅
               IF l_pmdw.pmdw015 = 1 THEN
                  LET l_pmdw.pmdw023 = l_apcb.apcb113 * -1     #本幣未稅
                  LET l_pmdw.pmdw024 = l_apcb.apcb114 * -1     #本幣稅額
                  LET l_pmdw.pmdw025 = l_apcb.apcb115 * -1     #本幣含稅
               ELSE
                  IF l_pmdw.pmdw0121 = "Y" THEN
                     CALL s_tax_count(l_apca.apcacomp,l_pmdw.pmdw012,l_pmds.pmds044,1,l_pmdw.pmdw014,l_pmdw.pmdw015)
                          RETURNING l_pmdw.pmdw028,l_pmdw.pmdw028,l_pmdw.pmdw028,
                                    l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025
                  ELSE
                     CALL s_tax_count(l_apca.apcacomp,l_pmdw.pmdw012,l_pmds.pmds043,1,l_pmdw.pmdw014,l_pmdw.pmdw015)
                          RETURNING l_pmdw.pmdw028,l_pmdw.pmdw028,l_pmdw.pmdw028,
                                    l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025
                  END IF
               END IF
               #151230-00005#2--(E)
               SELECT pmdw008 INTO l_pmdw.pmdw008 FROM pmdw_t
                WHERE pmdwent = g_enterprise
                  AND pmdwdocno = l_pmds.pmds006               
               #albireo 151021-----e
               
               #160906-00005#1 -----s
               LET l_pmdw.pmdw001 = 'aapt340'
               #160906-00005#1 -----e
               #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
               IF cl_null(l_pmdw.pmdw015) THEN LET l_pmdw.pmdw015 = 0 END IF  #原幣單價
               IF cl_null(l_pmdw.pmdw026) THEN LET l_pmdw.pmdw026 = 0 END IF  #原幣匯率
               IF cl_null(l_pmdw.pmdw027) THEN LET l_pmdw.pmdw027 = 0 END IF  #原幣未稅金額
               IF cl_null(l_pmdw.pmdw028) THEN LET l_pmdw.pmdw028 = 0 END IF  #原幣稅額
               IF cl_null(l_pmdw.pmdw023) THEN LET l_pmdw.pmdw023 = 0 END IF  #原幣含稅金額
               IF cl_null(l_pmdw.pmdw024) THEN LET l_pmdw.pmdw024 = 0 END IF  #原幣沖銷差異金額
               IF cl_null(l_pmdw.pmdw025) THEN LET l_pmdw.pmdw025 = 0 END IF  #本幣單價
               #180130-00050#5---add by 10554---(E)
               INSERT INTO isam_t
                     (isament,isamdocno,isamseq,isamstus,isamcomp,
                      isam001,isam002,isam004,isam008,isam009,
                      isam010,isam011,isam012,isam0121,isam013,
                      isam014,isam015,isam016,isam017,isam018,
                      isam019,isam020,isam021,isam022,isam023,
                      isam024,isam025,isam026,isam027,isam028,
                      isam029,isam030,isam031,isam032,isam033,
                      isam034,isam035,isam036,isam037,isam038,
                      isam039,isam040,isam041,isam042,isam043,
                      isam044,isam045,isam046,isam047,isam048,
                      isam049,isam050,isam053,   #171005-00006#18 add isam053
                      isam107,isam108,isam117,isam118,isam200,
                      isam201,isam202,isam203,isam204,isam205,
                      isam206,isam207,isam208,isam209,isam210
                     )
               VALUES(g_enterprise,l_apca.apcadocno,l_isamseq,'Y',l_apca.apcacomp,
                      l_pmdw.pmdw001,l_pmdw.pmdw002,l_apca.apca015,l_pmdw.pmdw008,l_pmdw.pmdw009,
                      l_pmdw.pmdw010,l_pmdw.pmdw011,l_pmdw.pmdw012,l_pmdw.pmdw0121,l_pmdw.pmdw013,
                      l_pmdw.pmdw014,l_pmdw.pmdw015,l_pmdw.pmdw016,l_pmdw.pmdw017,l_pmdw.pmdw018,
                     #l_pmdw.pmdw019,l_pmdw.pmdw020,l_pmdw.pmdw021,l_pmdw.pmdw022,l_pmdw.pmdw023,  #150921 mark
                     #l_pmdw.pmdw024,l_pmdw.pmdw025,l_pmdw.pmdw026,l_pmdw.pmdw027,l_pmdw.pmdw028,  #150921 mark
                      l_pmdw.pmdw019,l_pmdw.pmdw020,l_pmdw.pmdw021,l_pmdw.pmdw022,l_pmds.pmds043,  #150921
                      l_pmds.pmds046,l_pmds.pmds044,l_pmdw.pmdw023,l_pmdw.pmdw024,l_pmdw.pmdw025,  #150921
                      l_pmdw.pmdw029,l_pmdw.pmdw030,l_pmdw.pmdw031,l_pmdw.pmdw032,l_pmdw.pmdw033,
                      l_pmdw.pmdw034,l_pmdw.pmdw035,l_pmdw.pmdw036,l_pmdw.pmdw037,l_pmdw.pmdw038,
                      l_pmdw.pmdw039,l_pmdw.pmdw040,l_pmdw.pmdw041,l_pmdw.pmdw042,l_pmdw.pmdw043,
                      0,l_pmdw.pmdw045,l_pmdw.pmdw046,l_pmdw.pmdw047,l_pmdw.pmdw048,
                      l_pmdw.pmdw049,l_apca.apcadocno,l_pmdw.pmdw036,   #171005-00006#18 add l_pmdw.pmdw036
                      0,0,0,0,'N',
                      l_pmdw.pmdw201,l_pmdw.pmdw202,l_pmdw.pmdw203,l_pmdw.pmdw204,l_pmdw.pmdw205,
                      l_pmdw.pmdw206,l_pmdw.pmdw207,'','',''
                      )
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "INSERT isam_t wrong!"
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
               END IF
            END IF
            CLOSE ins_isam_get_apcb002_c
         END FOREACH            
      END FOREACH              
   END IF
   #因為樣板是用SQLCA.SQLcode來判斷程式有沒有執行錯誤，這裡若錯誤會影響判斷，因此要給0  
   LET SQLCA.SQLcode = 0    
   RETURN r_success   
END FUNCTION

################################################################################
# Descriptions...: 批次立账作业立即审核
# Memo...........:
# Usage..........: CALL s_aapp131_immediately_conf(p_apcald,p_apcacomp,p_apcadocno)
#                  RETURNING r_success
# Input parameter: p_apcald     账套
#                : p_apcacomp   法人
#                : p_apcadocno  单号
# Return code....: r_success     TRUE/FALSE
#                : 
# Date & Author..: 2015/12/07 By 06421
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_immediately_conf(p_apcald,p_apcacomp,p_apcadocno)
   DEFINE p_apcald          LIKE apca_t.apcald
   DEFINE p_apcadocno      LIKE apca_t.apcadocno
   DEFINE p_apcacomp       LIKE apca_t.apcacomp
   DEFINE r_success        LIKE type_t.num5      #处理状态TRUE/FALSE
  #DEFINE l_apca           RECORD LIKE apca_t.* #161111-00048#2 mark
   #161111-00048#2 --s add
   DEFINE l_apca RECORD  #應付憑單單頭
          apcaent LIKE apca_t.apcaent, #企業編號
          apcaownid LIKE apca_t.apcaownid, #資料所有者
          apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
          apcacrtid LIKE apca_t.apcacrtid, #資料建立者
          apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
          apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
          apcamodid LIKE apca_t.apcamodid, #資料修改者
          apcamoddt LIKE apca_t.apcamoddt, #最近修改日
          apcacnfid LIKE apca_t.apcacnfid, #資料確認者
          apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
          apcapstid LIKE apca_t.apcapstid, #資料過帳者
          apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
          apcastus LIKE apca_t.apcastus, #狀態碼
          apcald LIKE apca_t.apcald, #帳套
          apcacomp LIKE apca_t.apcacomp, #法人
          apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
          apcadocdt LIKE apca_t.apcadocdt, #帳款日期
          apcasite LIKE apca_t.apcasite, #帳務中心
          apca001 LIKE apca_t.apca001, #帳款單性質
          apca003 LIKE apca_t.apca003, #帳務人員
          apca004 LIKE apca_t.apca004, #帳款對象編號
          apca005 LIKE apca_t.apca005, #付款對象
          apca006 LIKE apca_t.apca006, #供應商分類
          apca007 LIKE apca_t.apca007, #帳款類別
          apca008 LIKE apca_t.apca008, #付款條件編號
          apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
          apca010 LIKE apca_t.apca010, #容許票據到期日
          apca011 LIKE apca_t.apca011, #稅別
          apca012 LIKE apca_t.apca012, #稅率
          apca013 LIKE apca_t.apca013, #含稅否
          apca014 LIKE apca_t.apca014, #人員編號
          apca015 LIKE apca_t.apca015, #部門編號
          apca016 LIKE apca_t.apca016, #來源作業類型
          apca017 LIKE apca_t.apca017, #產生方式
          apca018 LIKE apca_t.apca018, #來源參考單號
          apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
          apca020 LIKE apca_t.apca020, #信用狀付款否
          apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
          apca022 LIKE apca_t.apca022, #進口報單號碼
          apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
          apca026 LIKE apca_t.apca026, #原幣未稅差異
          apca027 LIKE apca_t.apca027, #原幣稅額差異
          apca028 LIKE apca_t.apca028, #本幣未稅差異
          apca029 LIKE apca_t.apca029, #本幣幣稅額差異
          apca030 LIKE apca_t.apca030, #差異科目
          apca031 LIKE apca_t.apca031, #產生之差異折讓單號
          apca032 LIKE apca_t.apca032, #發票類型
          apca033 LIKE apca_t.apca033, #專案編號
          apca034 LIKE apca_t.apca034, #責任中心
          apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
          apca036 LIKE apca_t.apca036, #費用(借方)科目編號
          apca037 LIKE apca_t.apca037, #產生傳票否
          apca038 LIKE apca_t.apca038, #拋轉傳票號碼
          apca039 LIKE apca_t.apca039, #會計檢核附件份數
          apca040 LIKE apca_t.apca040, #留置否
          apca041 LIKE apca_t.apca041, #留置理由碼
          apca042 LIKE apca_t.apca042, #留置設定日期
          apca043 LIKE apca_t.apca043, #留置解除日期
          apca044 LIKE apca_t.apca044, #留置原幣金額
          apca045 LIKE apca_t.apca045, #留置說明
          apca046 LIKE apca_t.apca046, #關係人否
          apca047 LIKE apca_t.apca047, #多角序號
          apca048 LIKE apca_t.apca048, #集團代付/代付單號
          apca049 LIKE apca_t.apca049, #來源營運中心編號
          apca050 LIKE apca_t.apca050, #交易原始單據份數
          apca051 LIKE apca_t.apca051, #作廢理由碼
          apca052 LIKE apca_t.apca052, #列印次數
          apca053 LIKE apca_t.apca053, #備註
          apca054 LIKE apca_t.apca054, #多帳期設定
          apca055 LIKE apca_t.apca055, #繳款優惠條件
          apca056 LIKE apca_t.apca056, #會計檢核附件狀態
          apca057 LIKE apca_t.apca057, #交易對象識別碼
          apca058 LIKE apca_t.apca058, #稅別交易類型
          apca059 LIKE apca_t.apca059, #預算編號
          apca060 LIKE apca_t.apca060, #發票開立方式
          apca061 LIKE apca_t.apca061, #預開發票基準日
          apca062 LIKE apca_t.apca062, #多角性質
          apca063 LIKE apca_t.apca063, #整帳批序號
          apca064 LIKE apca_t.apca064, #訂金序次
          apca065 LIKE apca_t.apca065, #發票編號
          apca066 LIKE apca_t.apca066, #發票號碼
          apca100 LIKE apca_t.apca100, #交易原幣別
          apca101 LIKE apca_t.apca101, #原幣匯率
          apca103 LIKE apca_t.apca103, #原幣未稅金額
          apca104 LIKE apca_t.apca104, #原幣稅額
          apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
          apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
          apca108 LIKE apca_t.apca108, #原幣應付金額
          apca113 LIKE apca_t.apca113, #本幣未稅金額
          apca114 LIKE apca_t.apca114, #本幣稅額
          apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
          apca117 LIKE apca_t.apca117, #NO USE
          apca118 LIKE apca_t.apca118, #本幣應付金額
          apca120 LIKE apca_t.apca120, #本位幣二幣別
          apca121 LIKE apca_t.apca121, #本位幣二匯率
          apca123 LIKE apca_t.apca123, #本位幣二未稅金額
          apca124 LIKE apca_t.apca124, #本位幣二稅額
          apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
          apca127 LIKE apca_t.apca127, #NO USE
          apca128 LIKE apca_t.apca128, #本位幣二應付金額
          apca130 LIKE apca_t.apca130, #本位幣三幣別
          apca131 LIKE apca_t.apca131, #本位幣三匯率
          apca133 LIKE apca_t.apca133, #本位幣三未稅金額
          apca134 LIKE apca_t.apca134, #本位幣三稅額
          apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
          apca137 LIKE apca_t.apca137, #NO USE
          apca138 LIKE apca_t.apca138, #本位幣三應付金額
          apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
          apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
          apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
          apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
          apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
          apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
          apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
          apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
          apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
          apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
          apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
          apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
          apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
          apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
          apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
          apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
          apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
          apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
          apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
          apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
          apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
          apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
          apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
          apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
          apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
          apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
          apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
          apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
          apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
          apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
          apca067 LIKE apca_t.apca067, #管理品類
          apca068 LIKE apca_t.apca068, #經營方式
          apca069 LIKE apca_t.apca069, #no use
          apca070 LIKE apca_t.apca070, #no use
          apca071 LIKE apca_t.apca071, #no use
          apca072 LIKE apca_t.apca072, #no use
          apca073 LIKE apca_t.apca073  #L/C No.
   END RECORD
   #161111-00048#2 --e add
   LET r_success = TRUE

   
   #CALL cl_err_collect_init()
   #CALL s_transaction_begin()

   WHENEVER ERROR CONTINUE
   #SELECT * INTO l_apca.* FROM apca_t WHERE apcaent = g_enterprise AND apcald = p_apcald AND apcadocno = p_apcadocno   #161208-00026#22   mark
   #161208-00026#22   add---s
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073
     INTO l_apca.*
     FROM apca_t
    WHERE apcaent = g_enterprise 
      AND apcald = p_apcald 
      AND apcadocno = p_apcadocno
   #161208-00026#22   add---e
   
   CALL s_aapt300_prepare_declare()  #aapt300 aapt310 aapt320 aapt340 

   IF NOT s_aapt300_conf_chk(l_apca.apcald,l_apca.apcadocno) THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   #170323-00106#1---add---start---
   #IF g_prog = 'aapp134' THEN   #191126-00047#1 mark
   IF g_prog = 'aapp134' OR l_apca.apca001 = '11' THEN  #191126-00047#1 add
      IF NOT s_aapt310_conf_upd(l_apca.apcald,l_apca.apcadocno) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   ELSE
   #170323-00106#1---add---start---
      IF NOT s_aapt300_conf_upd(l_apca.apcald,l_apca.apcadocno) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF           #170323-00106#1 add 
   

  #異動狀態碼欄位/修改人/修改日期
   LET l_apca.apcamoddt = cl_get_current()
   LET l_apca.apcacnfdt = cl_get_current()
   UPDATE apca_t SET apcastus = 'Y',
                     apcamodid= g_user,
                     apcamoddt= l_apca.apcamoddt,
                     apcacnfid= g_user,
                     apcacnfdt= l_apca.apcacnfdt
    WHERE apcaent = g_enterprise AND apcald = l_apca.apcald
      AND apcadocno = l_apca.apcadocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 批次立账作业立即过账
# Memo...........:
# Usage..........: CALL s_aapp131_immediately_gen(p_apcald,p_apcacomp,p_apcadocno)
#                  RETURNING ---
# Input parameter: p_apcald     账套
#                : p_apcacomp   法人
#                : p_apcadocno  编号
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2015/12/07 By 06421
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_immediately_gen(p_apcald,p_apcacomp,p_apcadocno)
   DEFINE l_success         LIKE type_t.num5
   DEFINE l_doc_success     LIKE type_t.num5
   DEFINE l_slip            LIKE ooba_t.ooba002
   DEFINE l_dfin0032        LIKE type_t.chr1
   DEFINE l_count           LIKE type_t.num5
   DEFINE l_glap001         LIKE glap_t.glap001
   DEFINE la_param          RECORD
          prog              STRING,
          param             DYNAMIC ARRAY OF STRING
                            END RECORD
   DEFINE ls_js             STRING
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_ooac004         LIKE ooac_t.ooac004
   DEFINE l_chr             LIKE type_t.chr1       #狀態碼
   DEFINE l_gl_slip         LIKE ooba_t.ooba002      #總帳單別
   DEFINE p_apcald          LIKE apca_t.apcald
   DEFINE p_apcadocno      LIKE apca_t.apcadocno
   DEFINE p_apcacomp       LIKE apca_t.apcacomp
   DEFINE r_success        LIKE type_t.num5      #处理状态TRUE/FALSE
  #DEFINE l_apca           RECORD LIKE apca_t.* #161111-00048#2 mark
   #161111-00048#2 --s add
   DEFINE l_apca RECORD  #應付憑單單頭
          apcaent LIKE apca_t.apcaent, #企業編號
          apcaownid LIKE apca_t.apcaownid, #資料所有者
          apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
          apcacrtid LIKE apca_t.apcacrtid, #資料建立者
          apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
          apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
          apcamodid LIKE apca_t.apcamodid, #資料修改者
          apcamoddt LIKE apca_t.apcamoddt, #最近修改日
          apcacnfid LIKE apca_t.apcacnfid, #資料確認者
          apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
          apcapstid LIKE apca_t.apcapstid, #資料過帳者
          apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
          apcastus LIKE apca_t.apcastus, #狀態碼
          apcald LIKE apca_t.apcald, #帳套
          apcacomp LIKE apca_t.apcacomp, #法人
          apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
          apcadocdt LIKE apca_t.apcadocdt, #帳款日期
          apcasite LIKE apca_t.apcasite, #帳務中心
          apca001 LIKE apca_t.apca001, #帳款單性質
          apca003 LIKE apca_t.apca003, #帳務人員
          apca004 LIKE apca_t.apca004, #帳款對象編號
          apca005 LIKE apca_t.apca005, #付款對象
          apca006 LIKE apca_t.apca006, #供應商分類
          apca007 LIKE apca_t.apca007, #帳款類別
          apca008 LIKE apca_t.apca008, #付款條件編號
          apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
          apca010 LIKE apca_t.apca010, #容許票據到期日
          apca011 LIKE apca_t.apca011, #稅別
          apca012 LIKE apca_t.apca012, #稅率
          apca013 LIKE apca_t.apca013, #含稅否
          apca014 LIKE apca_t.apca014, #人員編號
          apca015 LIKE apca_t.apca015, #部門編號
          apca016 LIKE apca_t.apca016, #來源作業類型
          apca017 LIKE apca_t.apca017, #產生方式
          apca018 LIKE apca_t.apca018, #來源參考單號
          apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
          apca020 LIKE apca_t.apca020, #信用狀付款否
          apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
          apca022 LIKE apca_t.apca022, #進口報單號碼
          apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
          apca026 LIKE apca_t.apca026, #原幣未稅差異
          apca027 LIKE apca_t.apca027, #原幣稅額差異
          apca028 LIKE apca_t.apca028, #本幣未稅差異
          apca029 LIKE apca_t.apca029, #本幣幣稅額差異
          apca030 LIKE apca_t.apca030, #差異科目
          apca031 LIKE apca_t.apca031, #產生之差異折讓單號
          apca032 LIKE apca_t.apca032, #發票類型
          apca033 LIKE apca_t.apca033, #專案編號
          apca034 LIKE apca_t.apca034, #責任中心
          apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
          apca036 LIKE apca_t.apca036, #費用(借方)科目編號
          apca037 LIKE apca_t.apca037, #產生傳票否
          apca038 LIKE apca_t.apca038, #拋轉傳票號碼
          apca039 LIKE apca_t.apca039, #會計檢核附件份數
          apca040 LIKE apca_t.apca040, #留置否
          apca041 LIKE apca_t.apca041, #留置理由碼
          apca042 LIKE apca_t.apca042, #留置設定日期
          apca043 LIKE apca_t.apca043, #留置解除日期
          apca044 LIKE apca_t.apca044, #留置原幣金額
          apca045 LIKE apca_t.apca045, #留置說明
          apca046 LIKE apca_t.apca046, #關係人否
          apca047 LIKE apca_t.apca047, #多角序號
          apca048 LIKE apca_t.apca048, #集團代付/代付單號
          apca049 LIKE apca_t.apca049, #來源營運中心編號
          apca050 LIKE apca_t.apca050, #交易原始單據份數
          apca051 LIKE apca_t.apca051, #作廢理由碼
          apca052 LIKE apca_t.apca052, #列印次數
          apca053 LIKE apca_t.apca053, #備註
          apca054 LIKE apca_t.apca054, #多帳期設定
          apca055 LIKE apca_t.apca055, #繳款優惠條件
          apca056 LIKE apca_t.apca056, #會計檢核附件狀態
          apca057 LIKE apca_t.apca057, #交易對象識別碼
          apca058 LIKE apca_t.apca058, #稅別交易類型
          apca059 LIKE apca_t.apca059, #預算編號
          apca060 LIKE apca_t.apca060, #發票開立方式
          apca061 LIKE apca_t.apca061, #預開發票基準日
          apca062 LIKE apca_t.apca062, #多角性質
          apca063 LIKE apca_t.apca063, #整帳批序號
          apca064 LIKE apca_t.apca064, #訂金序次
          apca065 LIKE apca_t.apca065, #發票編號
          apca066 LIKE apca_t.apca066, #發票號碼
          apca100 LIKE apca_t.apca100, #交易原幣別
          apca101 LIKE apca_t.apca101, #原幣匯率
          apca103 LIKE apca_t.apca103, #原幣未稅金額
          apca104 LIKE apca_t.apca104, #原幣稅額
          apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
          apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
          apca108 LIKE apca_t.apca108, #原幣應付金額
          apca113 LIKE apca_t.apca113, #本幣未稅金額
          apca114 LIKE apca_t.apca114, #本幣稅額
          apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
          apca117 LIKE apca_t.apca117, #NO USE
          apca118 LIKE apca_t.apca118, #本幣應付金額
          apca120 LIKE apca_t.apca120, #本位幣二幣別
          apca121 LIKE apca_t.apca121, #本位幣二匯率
          apca123 LIKE apca_t.apca123, #本位幣二未稅金額
          apca124 LIKE apca_t.apca124, #本位幣二稅額
          apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
          apca127 LIKE apca_t.apca127, #NO USE
          apca128 LIKE apca_t.apca128, #本位幣二應付金額
          apca130 LIKE apca_t.apca130, #本位幣三幣別
          apca131 LIKE apca_t.apca131, #本位幣三匯率
          apca133 LIKE apca_t.apca133, #本位幣三未稅金額
          apca134 LIKE apca_t.apca134, #本位幣三稅額
          apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
          apca137 LIKE apca_t.apca137, #NO USE
          apca138 LIKE apca_t.apca138, #本位幣三應付金額
          apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
          apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
          apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
          apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
          apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
          apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
          apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
          apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
          apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
          apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
          apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
          apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
          apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
          apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
          apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
          apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
          apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
          apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
          apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
          apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
          apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
          apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
          apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
          apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
          apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
          apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
          apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
          apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
          apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
          apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
          apca067 LIKE apca_t.apca067, #管理品類
          apca068 LIKE apca_t.apca068, #經營方式
          apca069 LIKE apca_t.apca069, #no use
          apca070 LIKE apca_t.apca070, #no use
          apca071 LIKE apca_t.apca071, #no use
          apca072 LIKE apca_t.apca072, #no use
          apca073 LIKE apca_t.apca073  #L/C No.
   END RECORD
   #161111-00048#2 --e add
   DEFINE l_glaa013        LIKE glaa_t.glaa013
   DEFINE l_glaa121        LIKE glaa_t.glaa121
   DEFINE l_glaa102        LIKE glaa_t.glaa102
   DEFINE l_glaa003        LIKE glaa_t.glaa003
   DEFINE l_start_no      LIKE glap_t.glapdocno
   DEFINE l_end_no        LIKE glap_t.glapdocno
   DEFINE l_year          LIKE type_t.num5
   DEFINE l_month         LIKE type_t.num5
   DEFINE l_pdate_s       LIKE glav_t.glav004   #當期起始日
   DEFINE l_pdate_e       LIKE glav_t.glav004   #當期截止日
   DEFINE l_glav002       LIKE glav_t.glav002
   DEFINE l_glav005       LIKE glav_t.glav005
   DEFINE l_glav006       LIKE glav_t.glav006
   DEFINE l_glav007       LIKE glav_t.glav007
   DEFINE l_wdate         LIKE glav_t.glav004
   DEFINE l_flag          LIKE type_t.chr1
   
   WHENEVER ERROR CONTINUE
   
   IF cl_null(p_apcald)    THEN RETURN END IF   #無資料直接返回不做處理
   IF cl_null(p_apcacomp)  THEN RETURN END IF   #無資料直接返回不做處理
   IF cl_null(p_apcadocno) THEN RETURN END IF   #無資料直接返回不做處理
   
   #SELECT * INTO l_apca.*   #161208-00026#22   mark
   #161208-00026#22   add---s
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073
     INTO l_apca.*
   #161208-00026#22   add---e
     FROM apca_t 
    WHERE apcaent = g_enterprise 
      AND apcadocno = p_apcadocno 
      AND apcald = p_apcald 
      AND apcacomp = p_apcacomp

   IF l_apca.apcastus <> 'Y' OR cl_null(l_apca.apcastus)  THEN RETURN END IF

   IF NOT cl_null(l_apca.apca038)  THEN RETURN END IF #传票号码已经存在返回不做处理



  #取得單別
   CALL s_aooi200_fin_get_slip(l_apca.apcadocno) RETURNING l_success,l_slip
  #取得單別設置的"是否直接抛转凭证"參數
   CALL s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,l_slip,'D-FIN-0032') RETURNING l_dfin0032

   IF cl_null(l_dfin0032) OR l_dfin0032 MATCHES '[Nn]' THEN #參數值為空或為N則不做直接抛转凭证邏輯
      RETURN 
   END IF 

   #是否产生分录传票
   CALL s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,l_slip,'D-FIN-0030') RETURNING l_chr
   IF l_chr <> 'Y'  THEN
      RETURN 
   END IF
   
   #取得傳票單別(D-FIN-2002:產生之總帳傳票單別)
   LET l_gl_slip = ''
   CALL s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,l_slip,'D-FIN-2002') RETURNING l_gl_slip

   #IF NOT cl_ask_confirm('aap-00404') THEN RETURN END IF  #询问是否直接抛转凭证

   IF NOT cl_null(l_gl_slip) THEN 
        #LET la_param.param[6] = 'Y' #不弹窗
        #生成凭证
         IF (g_prog NOT MATCHES 'axrp14[12]*') AND (g_prog NOT MATCHES 'aapp14[12]*') THEN  #180802-00062#1 add
            CALL s_transaction_begin()
         #END IF        #180802-00062#1 add  #180803-00010#1 mark 
            #当axrp141/aapp141执行时，不可在事务中create tmp，导致rollback失败，提交事务
            #此段放到axrp141/aapp141中去定义            
            CALL s_aapp330_cre_tmp() RETURNING g_sub_success
            CALL s_pre_voucher_cre_tmp_table() RETURNING g_sub_success
            CALL s_fin_create_account_center_tmp()     
            CALL s_fin_continue_no_tmp() 
         END IF  #180803-00010#1 add        
         DELETE  FROM s_voucher_tmp
         CALL cl_err_collect_init()
        
         #若以原單據日期立帳
         SELECT glaa013,glaa121,glaa102,glaa003 INTO l_glaa013,l_glaa121,l_glaa102,l_glaa003
              FROM glaa_t
             WHERE glaaent = g_enterprise AND glaald = l_apca.apcald
         IF cl_null(l_apca.apcadocdt) OR l_apca.apcadocdt < = l_glaa013 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'aap-00077'
           
            LET g_errparam.extend = ''                                  
            LET g_errparam.popup = TRUE
            LET g_errparam.coll_vals[1]  = l_apca.apcadocno
            CALL cl_err()  
            #180802-00062#1 --s add
            IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN            
               CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'aap-00077','N')
               RETURN
            END IF      
            #180802-00062#1 --e add             
            CALL s_transaction_end('N','Y')               
         END IF
         
         #判斷傳票日期有值否，有值用此來推算出當期會計週期起始日，單據的立帳日必須在這區間內
         IF NOT cl_null(l_apca.apcadocdt) THEN
            #取得會計週期參照表
            LET l_year = YEAR(l_apca.apcadocdt)
            LET l_month = MONTH(l_apca.apcadocdt)
            #取得會計當期起始日
            CALL s_get_accdate(l_glaa003,'',l_year,l_month)
                  RETURNING l_flag,g_errno,l_glav002,l_glav005,l_wdate,l_wdate,
                            l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate,l_wdate
            IF NOT cl_null(l_pdate_s) AND NOT cl_null(l_pdate_e) THEN
               IF l_apca.apcadocdt < l_pdate_s OR l_apca.apcadocdt > l_pdate_e THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code ='aap-00340'
                 
                  LET g_errparam.extend = ''                                  
                  LET g_errparam.popup = TRUE
                  LET g_errparam.coll_vals[1]  = l_apca.apcadocno
                  CALL cl_err()   
                  #180802-00062#1 --s add
                  IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN            
                     CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'aap-00340','N')
                     RETURN
                  END IF      
                  #180802-00062#1 --e add                    
                  CALL s_transaction_end('N','Y')                
               END IF
            END IF
         END IF
               
     #    CALL cl_err_collect_show()
      
         INSERT INTO s_voucher_tmp (docno,type)
               VALUES ( l_apca.apcadocno , '0' )
        
         IF NOT l_glaa121 = 'Y' THEN                 
            CALL s_aapp330_gen_ac('1','P10',l_apca.apcald,'','','1','!#@','Y') RETURNING g_sub_success,l_start_no,l_end_no
         END IF
         IF g_sub_success THEN
            IF (g_prog NOT MATCHES 'axrp14[12]*') AND (g_prog NOT MATCHES 'aapp14[12]*') THEN  #180802-00062#1 add
               CALL s_transaction_end('Y','Y')
            END IF #180802-00062#1 add
         ELSE
            #180802-00062#1 --s add
            IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN            
               CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'axr-00120','N')
               RETURN
            END IF      
            #180802-00062#1 --e add             
            CALL s_transaction_end('N','Y')
         END IF   
               
         IF (g_prog NOT MATCHES 'axrp14[12]*') AND (g_prog NOT MATCHES 'aapp14[12]*') THEN  #180802-00062#1 add
            CALL s_transaction_begin()               
         END IF #180802-00062#1 add
     #    CALL cl_err_collect_init()
         CALL s_aapp330_generate_voucher('P10',l_gl_slip,l_apca.apcadocdt,l_apca.apcald,'1','Y',l_glaa102,'AP')
              RETURNING g_sub_success,l_apca.apca038,l_apca.apca038
         #CALL cl_err_collect_show()   
         IF g_sub_success AND NOT cl_null(l_apca.apca038) THEN
            IF (g_prog NOT MATCHES 'axrp14[12]*') AND (g_prog NOT MATCHES 'aapp14[12]*') THEN  #180802-00062#1 add
                CALL s_transaction_end('Y','Y')
            END IF #180802-00062#1 add
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = 'adz-00217'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         ELSE
            #180802-00062#1 --s add
            IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN            
               CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'adz-00218','N')
               RETURN
            END IF      
            #180802-00062#1 --e add           
            CALL s_transaction_end('N','Y')
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'adz-00218'
            LET g_errparam.popup = TRUE
            CALL cl_err()           
            RETURN
         END IF
              
         #生成凭证
      ELSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'aap-00421'
         LET g_errparam.extend = l_gl_slip
         LET g_errparam.popup = TRUE
         CALL cl_err()
         #180802-00062#1 --s add
         IF (g_prog MATCHES 'axrp14[12]*') OR (g_prog MATCHES 'aapp14[12]*') THEN            
            CALL s_axrp133_success_tmp_ins('',l_apca.apcadocno,0,0,'aap-00421','N')
         END IF      
         #180802-00062#1 --e add          
         RETURN
   END IF
   #CALL cl_err_collect_show()    
END FUNCTION

################################################################################
# Descriptions...: 取得标准成本
# Date & Author..: 16/03/29 By Belle
# Modify.........: 170430-00006#2 17/05/17 By Sabrina
################################################################################
PUBLIC FUNCTION s_aapp131_get_apcb1x6(p_apcb,p_round_type,p_ooaj004,p_ooaj004_g,p_ooaj004_g2,p_ooaj004_g3)
#DEFINE p_apcb        RECORD LIKE apcb_t.* #161111-00048#2 mark
#161111-00048#2 --s add
DEFINE p_apcb RECORD  #應付憑單單身
       apcbent LIKE apcb_t.apcbent, #企業編號
       apcbld LIKE apcb_t.apcbld, #帳套
       apcblegl LIKE apcb_t.apcblegl, #核算組織
       apcborga LIKE apcb_t.apcborga, #帳務歸屬組織(來源組織)
       apcbsite LIKE apcb_t.apcbsite, #應付帳務組織
       apcbdocno LIKE apcb_t.apcbdocno, #單號
       apcbseq LIKE apcb_t.apcbseq, #項次
       apcb001 LIKE apcb_t.apcb001, #來源類型
       apcb002 LIKE apcb_t.apcb002, #來源業務單據號碼
       apcb003 LIKE apcb_t.apcb003, #來源業務單據項次
       apcb004 LIKE apcb_t.apcb004, #產品編號
       apcb005 LIKE apcb_t.apcb005, #品名規格
       apcb006 LIKE apcb_t.apcb006, #單位
       apcb007 LIKE apcb_t.apcb007, #計價數量
       apcb008 LIKE apcb_t.apcb008, #參考單據號碼
       apcb009 LIKE apcb_t.apcb009, #參考單據項次
       apcb010 LIKE apcb_t.apcb010, #業務部門
       apcb011 LIKE apcb_t.apcb011, #責任中心
       apcb012 LIKE apcb_t.apcb012, #產品類別
       apcb013 LIKE apcb_t.apcb013, #搭贈
       apcb014 LIKE apcb_t.apcb014, #理由碼
       apcb015 LIKE apcb_t.apcb015, #專案編號
       apcb016 LIKE apcb_t.apcb016, #WBS編號
       apcb017 LIKE apcb_t.apcb017, #預算細項
       apcb018 LIKE apcb_t.apcb018, #专柜编号
       apcb019 LIKE apcb_t.apcb019, #開票性質
       apcb020 LIKE apcb_t.apcb020, #稅別
       apcb021 LIKE apcb_t.apcb021, #費用會計科目
       apcb022 LIKE apcb_t.apcb022, #正負值
       apcb023 LIKE apcb_t.apcb023, #沖暫估單否
       apcb024 LIKE apcb_t.apcb024, #區域
       apcb025 LIKE apcb_t.apcb025, #傳票號碼
       apcb026 LIKE apcb_t.apcb026, #傳票項次
       apcb027 LIKE apcb_t.apcb027, #發票編號
       apcb028 LIKE apcb_t.apcb028, #發票號碼
       apcb029 LIKE apcb_t.apcb029, #應付帳款科目
       apcb030 LIKE apcb_t.apcb030, #付款條件
       apcb032 LIKE apcb_t.apcb032, #訂金序次
       apcb033 LIKE apcb_t.apcb033, #經營方式
       apcb034 LIKE apcb_t.apcb034, #通路
       apcb035 LIKE apcb_t.apcb035, #品牌
       apcb036 LIKE apcb_t.apcb036, #客群
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046, #自由核算項十
       apcb047 LIKE apcb_t.apcb047, #摘要
       apcb048 LIKE apcb_t.apcb048, #來源訂購單號
       apcb049 LIKE apcb_t.apcb049, #開票單號
       apcb050 LIKE apcb_t.apcb050, #開票項次
       apcb051 LIKE apcb_t.apcb051, #業務人員
       apcb100 LIKE apcb_t.apcb100, #交易原幣
       apcb101 LIKE apcb_t.apcb101, #交易原幣單價
       apcb102 LIKE apcb_t.apcb102, #原幣匯率
       apcb103 LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104 LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105 LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb106 LIKE apcb_t.apcb106, #交易幣標準成本金額
       apcb107 LIKE apcb_t.apcb107, #入庫單單價
       apcb108 LIKE apcb_t.apcb108, #交易原幣成本認列金額
       apcb111 LIKE apcb_t.apcb111, #本幣單價
       apcb113 LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114 LIKE apcb_t.apcb114, #本幣稅額
       apcb115 LIKE apcb_t.apcb115, #本幣含稅金額
       apcb116 LIKE apcb_t.apcb116, #本幣標準成本金額
       apcb117 LIKE apcb_t.apcb117, #NO USE
       apcb118 LIKE apcb_t.apcb118, #本幣成本認列金額
       apcb119 LIKE apcb_t.apcb119, #應開發票含稅金額
       apcb121 LIKE apcb_t.apcb121, #本位幣二匯率
       apcb123 LIKE apcb_t.apcb123, #本位幣二未稅金額
       apcb124 LIKE apcb_t.apcb124, #本位幣二稅額
       apcb125 LIKE apcb_t.apcb125, #本位幣二含稅金額
       apcb126 LIKE apcb_t.apcb126, #本幣二標準成本金額
       apcb127 LIKE apcb_t.apcb127, #NO USE
       apcb128 LIKE apcb_t.apcb128, #本位幣二成本認列金額
       apcb131 LIKE apcb_t.apcb131, #本位幣三匯率
       apcb133 LIKE apcb_t.apcb133, #本位幣三未稅金額
       apcb134 LIKE apcb_t.apcb134, #本位幣三稅額
       apcb135 LIKE apcb_t.apcb135, #本位幣三含稅金額
       apcb136 LIKE apcb_t.apcb136, #本幣三標準成本金額
       apcb137 LIKE apcb_t.apcb137, #NO USE
       apcb138 LIKE apcb_t.apcb138, #本位幣三成本認列金額
       apcbud001 LIKE apcb_t.apcbud001, #自定義欄位(文字)001
       apcbud002 LIKE apcb_t.apcbud002, #自定義欄位(文字)002
       apcbud003 LIKE apcb_t.apcbud003, #自定義欄位(文字)003
       apcbud004 LIKE apcb_t.apcbud004, #自定義欄位(文字)004
       apcbud005 LIKE apcb_t.apcbud005, #自定義欄位(文字)005
       apcbud006 LIKE apcb_t.apcbud006, #自定義欄位(文字)006
       apcbud007 LIKE apcb_t.apcbud007, #自定義欄位(文字)007
       apcbud008 LIKE apcb_t.apcbud008, #自定義欄位(文字)008
       apcbud009 LIKE apcb_t.apcbud009, #自定義欄位(文字)009
       apcbud010 LIKE apcb_t.apcbud010, #自定義欄位(文字)010
       apcbud011 LIKE apcb_t.apcbud011, #自定義欄位(數字)011
       apcbud012 LIKE apcb_t.apcbud012, #自定義欄位(數字)012
       apcbud013 LIKE apcb_t.apcbud013, #自定義欄位(數字)013
       apcbud014 LIKE apcb_t.apcbud014, #自定義欄位(數字)014
       apcbud015 LIKE apcb_t.apcbud015, #自定義欄位(數字)015
       apcbud016 LIKE apcb_t.apcbud016, #自定義欄位(數字)016
       apcbud017 LIKE apcb_t.apcbud017, #自定義欄位(數字)017
       apcbud018 LIKE apcb_t.apcbud018, #自定義欄位(數字)018
       apcbud019 LIKE apcb_t.apcbud019, #自定義欄位(數字)019
       apcbud020 LIKE apcb_t.apcbud020, #自定義欄位(數字)020
       apcbud021 LIKE apcb_t.apcbud021, #自定義欄位(日期時間)021
       apcbud022 LIKE apcb_t.apcbud022, #自定義欄位(日期時間)022
       apcbud023 LIKE apcb_t.apcbud023, #自定義欄位(日期時間)023
       apcbud024 LIKE apcb_t.apcbud024, #自定義欄位(日期時間)024
       apcbud025 LIKE apcb_t.apcbud025, #自定義欄位(日期時間)025
       apcbud026 LIKE apcb_t.apcbud026, #自定義欄位(日期時間)026
       apcbud027 LIKE apcb_t.apcbud027, #自定義欄位(日期時間)027
       apcbud028 LIKE apcb_t.apcbud028, #自定義欄位(日期時間)028
       apcbud029 LIKE apcb_t.apcbud029, #自定義欄位(日期時間)029
       apcbud030 LIKE apcb_t.apcbud030, #自定義欄位(日期時間)030
       apcb052 LIKE apcb_t.apcb052, #稅額
       apcb053 LIKE apcb_t.apcb053, #含稅金額
       apcb054 LIKE apcb_t.apcb054, #帳款對象
       apcb055 LIKE apcb_t.apcb055  #付款對象
END RECORD
#161111-00048#2 --e add
DEFINE r_apcb106     LIKE apcb_t.apcb106
DEFINE r_apcb116     LIKE apcb_t.apcb116
DEFINE r_apcb126     LIKE apcb_t.apcb126
DEFINE r_apcb136     LIKE apcb_t.apcb136
DEFINE l_std_cost    type_g_std_cost
DEFINE p_round_type  LIKE ooaa_t.ooaa002     #170430-00006#2
DEFINE p_ooaj004     LIKE ooaj_t.ooaj004     #170430-00006#2
DEFINE p_ooaj004_g   LIKE ooaj_t.ooaj004     #170430-00006#2
DEFINE p_ooaj004_g2  LIKE ooaj_t.ooaj004     #170430-00006#2
DEFINE p_ooaj004_g3  LIKE ooaj_t.ooaj004     #170430-00006#2
DEFINE l_pmdt007     LIKE pmdt_t.pmdt007     #171211-00028#13 add
   
   WHENEVER ERROR CONTINUE
   IF g_xcat005 = 'Y' AND NOT cl_null(p_apcb.apcb004) 
      AND (p_apcb.apcb001 = '11' OR p_apcb.apcb001 MATCHES '2[01]') THEN     
      
      #2.呼叫s_axcp500_std的CURSOR定义     
      CALL s_axcp500_std_def_cursor() RETURNING g_sub_success
      
      #3.取标准成本
      #3.1取料件的标准成本
      #171211-00028#13 add-S
      #获取料件的产品特征
      SELECT pmdt007 INTO l_pmdt007
        FROM pmdt_t
       WHERE pmdtdocno = p_apcb.apcb002
         AND pmdtseq = p_apcb.apcb003
         AND pmdtent = g_enterprise
      IF cl_null(l_pmdt007) THEN
         LET l_pmdt007 = ' '
      END IF
      #171211-00028#13 add-E
#      CALL s_axcp500_std_get_std_cost('1',g_apcacomp,g_xcag001,p_apcb.apcb004) RETURNING g_sub_success,l_std_cost.* #171211-00028#13 mark  
      CALL s_axcp500_std_get_std_cost1('1',g_apcacomp,g_xcag001,p_apcb.apcb004,l_pmdt007) RETURNING g_sub_success,l_std_cost.*  #171211-00028#13 mod
      LET r_apcb116 = l_std_cost.sum * p_apcb.apcb007
      LET r_apcb106 = r_apcb116 / g_apca101_std
     #CALL s_curr_round_ld('1',p_apcb.apcbld,g_apca100_std,r_apcb106,2) RETURNING g_sub_success,g_errno,r_apcb106    #170430-00006#2 mark
     #CALL s_curr_round_ld('1',p_apcb.apcbld,g_curr[1].curr,r_apcb116,2)   RETURNING g_sub_success,g_errno,r_apcb116 #170430-00006#2 mark
      CALL s_num_round(p_round_type,r_apcb106,p_ooaj004) RETURNING r_apcb106      #170430-00006#2 add 
      CALL s_num_round(p_round_type,r_apcb116,p_ooaj004_g)   RETURNING r_apcb116  #170430-00006#2 add
      IF g_glaa015 = 'Y' THEN
#         CALL s_axcp500_std_get_std_cost('2',g_apcacomp,g_xcag001,p_apcb.apcb004) RETURNING g_sub_success,l_std_cost.* #171211-00028#13 mark  
         CALL s_axcp500_std_get_std_cost1('2',g_apcacomp,g_xcag001,p_apcb.apcb004,l_pmdt007) RETURNING g_sub_success,l_std_cost.*  #171211-00028#13 mod
         LET r_apcb126 = l_std_cost.sum * p_apcb.apcb007
        #CALL s_curr_round_ld('1',p_apcb.apcbld,g_curr[2].curr,r_apcb126,2)   RETURNING g_sub_success,g_errno,r_apcb126    #170430-00006#2 mark
         CALL s_num_round(p_round_type,r_apcb126,p_ooaj004_g2)  RETURNING r_apcb126    #170430-00006#2 add
      END IF
      IF g_glaa019 = 'Y' THEN
#         CALL s_axcp500_std_get_std_cost('3',g_apcacomp,g_xcag001,p_apcb.apcb004) RETURNING g_sub_success,l_std_cost.* #171211-00028#13 mark  
         CALL s_axcp500_std_get_std_cost1('3',g_apcacomp,g_xcag001,p_apcb.apcb004,l_pmdt007) RETURNING g_sub_success,l_std_cost.*  #171211-00028#13 mod
         LET r_apcb136 = l_std_cost.sum * p_apcb.apcb007
        #CALL s_curr_round_ld('1',p_apcb.apcbld,g_curr[3].curr,r_apcb136,2)   RETURNING g_sub_success,g_errno,r_apcb136   #170430-00006#2 mark
         CALL s_num_round(p_round_type,r_apcb136,p_ooaj004_g3)   RETURNING r_apcb136     #170430-00006#2 add
      END IF
   END IF
   IF cl_null(r_apcb106) THEN LET r_apcb106 = 0 END IF
   IF cl_null(r_apcb116) THEN LET r_apcb116 = 0 END IF
   IF cl_null(r_apcb126) THEN LET r_apcb126 = 0 END IF
   IF cl_null(r_apcb136) THEN LET r_apcb136 = 0 END IF
   
   RETURN r_apcb106,r_apcb116,r_apcb126,r_apcb136
   
END FUNCTION

################################################################################
# Descriptions...: (部分沖帳diff)將立帳與沖帳差異金額寫入apde差異檔案
# Memo...........: #161202-00051#1
# Usage..........: CALL s_aapp131_ins_apce_diff_part(p_ld,p_docno)
# Input parameter: p_ld    帳套
#                : p_docno 立帳單據
# Date & Author..: 170306 By 06821
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apce_diff_part(p_ld,p_docno)
DEFINE p_ld             LIKE apca_t.apcald     #帳套
DEFINE p_docno          LIKE apca_t.apcadocno  #立帳單據
DEFINE l_sql            STRING
DEFINE l_apce003        LIKE apce_t.apce003    #沖銷帳款單單號
DEFINE l_apce004        LIKE apce_t.apce004    #沖銷帳款單項次
DEFINE l_apce109        LIKE apce_t.apce109    #原幣金額
DEFINE l_diff_amt       LIKE apde_t.apde109    #紀錄匯差金額
DEFINE l_diff           LIKE apde_t.apde109    #單張待抵單匯差金額
DEFINE l_percent        LIKE type_t.num20_6    #紀錄比率
DEFINE l_apca           RECORD                            
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca101        LIKE apca_t.apca101,
         apca100        LIKE apca_t.apca100    #170324-00130#1 add
         ,apca118        LIKE apca_t.apca118   #171120-00011#1 add 
                        END RECORD
DEFINE l_apde           RECORD                 #付款及差異處理明細檔
         apdeent        LIKE apde_t.apdeent,   #企業編號
         apdecomp       LIKE apde_t.apdecomp,  #法人
         apdeld         LIKE apde_t.apdeld,    #帳套
         apdedocno      LIKE apde_t.apdedocno, #沖銷單單號
         apdeseq        LIKE apde_t.apdeseq,   #項次
         apdesite       LIKE apde_t.apdesite,  #帳務中心
         apdeorga       LIKE apde_t.apdeorga,  #帳務歸屬組織
         apde001        LIKE apde_t.apde001,   #來源作業
         apde002        LIKE apde_t.apde002,   #沖銷帳款類型
         apde003        LIKE apde_t.apde003,   #已付款單號
         apde004        LIKE apde_t.apde004,   #沖銷單項次
         apde006        LIKE apde_t.apde006,   #款別編號
         apde008        LIKE apde_t.apde008,   #帳戶/票券號碼
         apde009        LIKE apde_t.apde009,   #已轉資料
         apde010        LIKE apde_t.apde010,   #摘要說明
         apde011        LIKE apde_t.apde011,   #銀行存提碼
         apde012        LIKE apde_t.apde012,   #現金變動碼
         apde013        LIKE apde_t.apde013,   #轉入客商碼
         apde014        LIKE apde_t.apde014,   #轉入帳款單編號
         apde015        LIKE apde_t.apde015,   #沖銷加減項
         apde016        LIKE apde_t.apde016,   #沖銷會科
         apde017        LIKE apde_t.apde017,   #業務人員
         apde018        LIKE apde_t.apde018,   #業務部門
         apde019        LIKE apde_t.apde019,   #責任中心
         apde020        LIKE apde_t.apde020,   #產品類別
         apde021        LIKE apde_t.apde021,   #票據類型
         apde022        LIKE apde_t.apde022,   #專案編號
         apde023        LIKE apde_t.apde023,   #WBS編號
         apde024        LIKE apde_t.apde024,   #票據號碼
         apde028        LIKE apde_t.apde028,   #產生方式
         apde029        LIKE apde_t.apde029,   #傳票號碼
         apde030        LIKE apde_t.apde030,   #傳票項次
         apde032        LIKE apde_t.apde032,   #付款日
         apde035        LIKE apde_t.apde035,   #區域
         apde036        LIKE apde_t.apde036,   #客群
         apde038        LIKE apde_t.apde038,   #對象
         apde039        LIKE apde_t.apde039,   #受款銀行
         apde040        LIKE apde_t.apde040,   #受款帳號
         apde041        LIKE apde_t.apde041,   #受款人全名
         apde042        LIKE apde_t.apde042,   #經營方式
         apde043        LIKE apde_t.apde043,   #通路
         apde044        LIKE apde_t.apde044,   #品牌
         apde045        LIKE apde_t.apde045,   #摘要
         apde046        LIKE apde_t.apde046,   #付款申請單
         apde047        LIKE apde_t.apde047,   #付款申請單項次
         apde051        LIKE apde_t.apde051,   #自由核算項一
         apde052        LIKE apde_t.apde052,   #自由核算項二
         apde053        LIKE apde_t.apde053,   #自由核算項三
         apde054        LIKE apde_t.apde054,   #自由核算項四
         apde055        LIKE apde_t.apde055,   #自由核算項五
         apde056        LIKE apde_t.apde056,   #自由核算項六
         apde057        LIKE apde_t.apde057,   #自由核算項七
         apde058        LIKE apde_t.apde058,   #自由核算項八
         apde059        LIKE apde_t.apde059,   #自由核算項九
         apde060        LIKE apde_t.apde060,   #自由核算項十
         apde100        LIKE apde_t.apde100,   #幣別
         apde101        LIKE apde_t.apde101,   #匯率
         apde104        LIKE apde_t.apde104,   #原幣應稅折抵稅額
         apde109        LIKE apde_t.apde109,   #原幣沖帳金額
         apde119        LIKE apde_t.apde119,   #本幣沖帳金額
         apde120        LIKE apde_t.apde120,   #本位幣二幣別
         apde121        LIKE apde_t.apde121,   #本位幣二匯率
         apde129        LIKE apde_t.apde129,   #本位幣二沖帳金額
         apde130        LIKE apde_t.apde130,   #本位幣三幣別
         apde131        LIKE apde_t.apde131,   #本位幣三匯率
         apde139        LIKE apde_t.apde139,   #本位幣三沖帳金額
         apde061        LIKE apde_t.apde061    #應付來源
                        END RECORD
DEFINE l_glaa001        LIKE glaa_t.glaa001   
DEFINE l_apcc100        LIKE apcc_t.apcc100
DEFINE l_apcc101        LIKE apcc_t.apcc101
DEFINE l_pmdl041        LIKE pmdl_t.pmdl041
DEFINE l_apce109_amt    LIKE apce_t.apce109
DEFINE l_apce119_amt    LIKE apce_t.apce119
DEFINE l_tot_apcc108    LIKE apcc_t.apcc108
DEFINE l_tot_apcc118    LIKE apcc_t.apcc118 
DEFINE l_tot_apcc109    LIKE apcc_t.apcc109
DEFINE l_tot_apcc119    LIKE apcc_t.apcc119 
DEFINE l_tot_apcc113    LIKE apcc_t.apcc113   #180425-00047#1 add
DEFINE l_apca001        LIKE apca_t.apca001
DEFINE l_apcb105        LIKE apcb_t.apcb105
DEFINE l_amt            LIKE apde_t.apde109   #171129-00009#1 add
DEFINE l_cnt_diff       LIKE type_t.num5      #180605-00079#1 add 紀錄立帳單與待抵單匯率不相同筆數
#190329-00027#1---add---str
DEFINE l_apce109_sum    LIKE apce_t.apce109
DEFINE l_apce119_sum    LIKE apce_t.apce119
DEFINE l_apca108        LIKE apca_t.apca108
DEFINE l_apca118        LIKE apca_t.apca118
#190329-00027#1---add---end

   LET l_diff_amt = 0  #紀錄匯差金額
   
   #應付帳款單匯率
   LET l_apca.apca101 = ''
#   SELECT apca101 INTO l_apca.apca101  #171120-00011#1 mark
   SELECT apca101,apca118 INTO l_apca.apca101,l_apca.apca118   #171120-00011#1 add    
     FROM apca_t  
    WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_docno AND apcastus <> 'X'
      
   #本幣幣別
   CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_glaa001
   
   #DECLARE ----------------- s
   #取帳款單性質判斷是否有來源採購單
   LET l_sql = " SELECT apca001 ",
               "   FROM apca_t  ",
               "  WHERE apcaent = ",g_enterprise," AND apcadocno = ? AND apcald = '",p_ld,"' ",
               "    AND apcastus NOT IN ('X') "
   PREPARE s_aapp131_get_apca001p FROM l_sql
   
   #計算預付待抵總額 
   LET l_sql = " SELECT SUM(apcc108),SUM(apcc118),SUM(apcc109),SUM(apcc119),SUM(apcc113) ", #180425-00047#1 add apcc113
               "   FROM apca_t,apcc_t   ",
               "  WHERE apccent = ",g_enterprise," AND apccld = '",p_ld,"' AND apccdocno = ? ",
               "    AND apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno ",
               "    AND apcastus <> 'X' "
   PREPARE s_aapp131_get_apcc108p FROM l_sql     
   
   #來源採購單金額資訊(for計算比率)
   LET l_sql = " SELECT SUM(pmdl041) FROM pmdl_t ",
               "  WHERE pmdlent = ",g_enterprise,"  ",
               "    AND pmdldocno = (SELECT apcb002 FROM apca_t,apcb_t ",
               "                      WHERE apcaent = apcbent AND apcald = apcbld  ",
               "                        AND apcadocno = apcbdocno AND apcaent = ",g_enterprise," AND apcald = '",p_ld,"'  ",
               "                        AND apcadocno = (SELECT apca018 FROM apca_t WHERE apcaent = ",g_enterprise,"  ",
               "                                            AND apcald = '",p_ld,"' AND apcadocno = ? )  ",
               "                        AND apcb001 = '10' AND apcastus <> 'X' ) "
   PREPARE s_aapp131_get_pmdl041p FROM l_sql    

   #180605-00079#1 --s add 
   #立帳單與待抵單匯率是否存在不相同
   LET l_sql = " SELECT COUNT (apcadocno) ",
               #"   FROM apca_t   ",           #180718-00024#1 mark
               "   FROM apca_t,apcc_t   ",     #180718-00024#1 add               
               "  WHERE apcaent = ",g_enterprise," AND apcald = '",p_ld,"'  ",
               "    AND apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno    ", #180718-00024#1 add
               "    AND apcadocno = ? AND apcastus <> 'X'  ",
               #"    AND apca101 <> (SELECT DISTINCT t1.apca101 FROM apca_t t1  ",            #180718-00024#1 mark
               "    AND apcc102 <> (SELECT DISTINCT t1.apca101 FROM apca_t t1  ",             #180718-00024#1 add               
               "                     WHERE t1.apcaent = ",g_enterprise," AND t1.apcald = '",p_ld,"' ",
               "                       AND t1.apcadocno = '",p_docno,"'  AND t1.apcastus <> 'X' ) "
   PREPARE s_aapp131_get_101diff FROM l_sql
   #180605-00079#1 --e add
   
   #DECLARE ----------------- e

   LET l_apce003 = ''
   LET l_apce004 = ''
   LET l_apce109 = 0
   #取得應付沖帳明細資訊 沖銷帳款單單號/ 沖銷帳款單項次 / 原幣沖帳金額
   LET l_sql = " SELECT apce003,apce004,apce109 ",
               "   FROM apca_t,apce_t ",
               "  WHERE apceent = ",g_enterprise," AND apceld = '",p_ld,"' AND apcedocno = '",p_docno,"' ",
               "    AND apcaent = apceent AND apcald = apceld AND apcadocno = apcedocno ",
               "    AND apcastus <> 'X' ",
               "    AND apce001 <> 'aapt430' ",
               "    AND apce100 = apca100 ", #180809-00013#1 add 針對立帳單原幣與待抵單幣別相同的進行推算
               "  ORDER BY apceseq "
   PREPARE s_aapp131_get_apcep FROM l_sql
   DECLARE s_aapp131_get_apcec CURSOR FOR s_aapp131_get_apcep
   FOREACH s_aapp131_get_apcec INTO l_apce003,l_apce004,l_apce109
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:s_aapp131_get_apcec" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      IF cl_null(l_apce109) THEN LET l_apce109 = 0 END IF
      LET l_diff = 0      #單張待抵單匯差金額
      LET l_percent  = 0  #紀錄比率

      #180605-00079#1 --s add
      #立帳單與待抵單匯率是否存在不相同; 是: 進行匯差計算 / 否: 跳過往下執行下一筆
      LET l_cnt_diff = 0
      EXECUTE s_aapp131_get_101diff USING l_apce003 INTO l_cnt_diff
      IF cl_null(l_cnt_diff) THEN LET l_cnt_diff = 0 END IF      
      IF l_cnt_diff = 0 THEN CONTINUE FOREACH END IF
      #180605-00079#1 --e add
      
      #取帳款單性質判斷是否有來源採購單
      LET l_apca001 = ''
      EXECUTE s_aapp131_get_apca001p USING l_apce003 INTO l_apca001 
      
      #計算待抵原幣總額/本幣總額
      LET l_tot_apcc108 = 0
      LET l_tot_apcc118 = 0  
      LET l_tot_apcc109 = 0
      LET l_tot_apcc119 = 0
      LET l_tot_apcc113 = 0  #180425-00047#1 add
      EXECUTE s_aapp131_get_apcc108p USING l_apce003 INTO l_tot_apcc108,l_tot_apcc118,l_tot_apcc109,l_tot_apcc119,l_tot_apcc113  #180425-00047#1 add
      IF cl_null(l_tot_apcc108)THEN LET l_tot_apcc108 = 0 END IF
      IF cl_null(l_tot_apcc118)THEN LET l_tot_apcc118 = 0 END IF
      IF cl_null(l_tot_apcc109)THEN LET l_tot_apcc109 = 0 END IF
      IF cl_null(l_tot_apcc119)THEN LET l_tot_apcc119 = 0 END IF
      IF cl_null(l_tot_apcc113)THEN LET l_tot_apcc113 = 0 END IF  #180425-00047#1 add
      
      #取待抵原幣幣別/匯率
      LET l_apcc100 = '' 
      LET l_apcc101 = 0
      #SELECT apcc100,apcc101 INTO l_apcc100,l_apcc101 #180718-00024#1 mark
      SELECT apcc100,apcc102 INTO l_apcc100,l_apcc101  #180718-00024#1 add 改用重評價匯率     
        FROM apca_t,apcc_t 
       WHERE apccent = g_enterprise AND apccld = p_ld AND apccdocno = l_apce003  
         AND apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno  
         AND apcastus <> 'X'         

      #180307-00027#1 --s add 來源採購單金額資訊(for計算比率) 並為判斷是否有採購金額依據
      LET l_pmdl041 = 0            
      EXECUTE s_aapp131_get_pmdl041p USING l_apce003 INTO l_pmdl041          
      IF cl_null(l_pmdl041)THEN LET l_pmdl041 = 0 END IF
      #180307-00027#1 --e add

      #IF l_apca001 MATCHES '2[13]' THEN                       #180307-00027#1 mark
      IF (l_apca001 MATCHES '2[13]') AND (l_pmdl041 > 0 ) THEN #180307-00027#1 add
      #歸類有採購的待抵單-----------####   
         #180307-00027#1 --s mark 提到外圈當作有來源採購單依據
         ##來源採購單金額資訊(for計算比率)
         #LET l_pmdl041 = 0            
         #EXECUTE s_aapp131_get_pmdl041p USING l_apce003 INTO l_pmdl041          
         #IF cl_null(l_pmdl041)THEN LET l_pmdl041 = 0 END IF
         #180307-00027#1 --e mark
         
         #回串對帳單對應aapt110入庫單原幣金額
         LET l_apcb105 = 0
         SELECT SUM(apcb105) INTO l_apcb105
           FROM apca_t,apcb_t
          WHERE apcaent = apcbent AND apcadocno = apcbdocno AND apcald = apcbld
            AND apcbent = g_enterprise   AND apcbld = p_ld AND apcbdocno = p_docno
            AND apcb001 = '11' AND apcastus <> 'X' #入庫單
         
         IF cl_null(l_apcb105) THEN LET l_apcb105 = 0 END IF   #171120-00011#1 add
         #先檢查是否為最後一次立帳(用入庫單金額與採購單金額比對)
         IF l_apcb105 = l_pmdl041 THEN 
         #IF (l_tot_apcc109+l_apce109) = l_pmdl041 THEN
            #表示為最後一次沖帳,金額倒扣計算
            #預付沖原幣(原幣應付金額-原幣付款沖帳金額)
            LET l_apce109_amt = l_tot_apcc108 - l_tot_apcc109
            CALL s_curr_round_ld('1',p_ld,l_apcc100,l_apce109_amt,2) RETURNING g_sub_success,g_errno,l_apce109_amt
            IF cl_null(l_apce109_amt)THEN LET l_apce109_amt = 0 END IF
            
            #預付沖本幣(本幣應付金額-本幣付款沖帳金額)
            #LET l_apce119_amt = l_tot_apcc118 - l_tot_apcc119
            LET l_apce119_amt = l_tot_apcc118 + l_tot_apcc113 - l_tot_apcc119  #180425-00047#1mod
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce119_amt,2) RETURNING g_sub_success,g_errno,l_apce119_amt
            IF cl_null(l_apce119_amt)THEN LET l_apce119_amt = 0 END IF
            
            #匯差金額(預付沖本幣-應付帳款單匯率*預付沖原幣)
            #171129-00009#1 --s add
            LET l_amt = 0
#            LET l_amt = l_apca.apca101 * l_apce109_amt  #180510-00093#1---mark
            LET l_amt = l_apca.apca101 * l_apce109  #180510-00093#1---add
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_amt,2) RETURNING g_sub_success,g_errno,l_amt
            
            LET l_apce119_amt = l_apcc101 * l_apce109 #180510-00093#1---add
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce119_amt,2) RETURNING g_sub_success,g_errno,l_apce119_amt #180510-00093#1---add
            IF cl_null(l_apce119_amt)THEN LET l_apce119_amt = 0 END IF #180510-00093#1---add
            #171129-00009#1 --e add
            #LET l_diff = l_apce119_amt - (l_apca.apca101 * l_apce109_amt)  #171120-00011#1 mark    #171215-00036#1 remark #171129-00009#1 mark
            LET l_diff = l_apce119_amt - l_amt                              #171129-00009#1 add
            #LET l_diff = l_apce119_amt - l_apca.apca118                     #171120-00011#1 add   #171215-00036#1 mark
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_diff,2) RETURNING g_sub_success,g_errno,l_diff
            IF cl_null(l_diff)THEN LET l_diff = 0 END IF            
         ELSE
            #預付沖原幣(aapt110那邊為部分沖所以為人工調算,直接取apce109寫入)
            LET l_apce109_amt = l_apce109          

            #預付沖本幣(來源待抵預付匯率*預付沖原幣)
            LET l_apce119_amt = l_apcc101 * l_apce109_amt
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce119_amt,2) RETURNING g_sub_success,g_errno,l_apce119_amt
            IF cl_null(l_apce119_amt)THEN LET l_apce119_amt = 0 END IF
            
            #匯差金額(預付沖本幣-應付帳款單匯率*預付沖原幣)
            #171129-00009#1 --s add
            LET l_amt = 0
            LET l_amt = l_apca.apca101 * l_apce109_amt
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_amt,2) RETURNING g_sub_success,g_errno,l_amt
            #171129-00009#1 --e add            
            #LET l_diff = l_apce119_amt - (l_apca.apca101 * l_apce109_amt)   #171120-00011#1 mark   #171215-00036#1 remark #171129-00009#1 mark
            LET l_diff = l_apce119_amt - l_amt                               #171129-00009#1 add
            #LET l_diff = l_apce119_amt - l_apca.apca118                     #171120-00011#1 add   #171215-00036#1 mark
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_diff,2) RETURNING g_sub_success,g_errno,l_diff
            IF cl_null(l_diff)THEN LET l_diff = 0 END IF
         END IF
         
      ELSE
      #歸類其他待抵單------------####   
         #先檢查是否為最後一次立帳
         IF (l_tot_apcc109+l_apce109) = l_tot_apcc108 THEN
            #表示為最後一次沖帳,金額倒扣計算            
            #預付沖原幣(原幣應付金額-原幣付款沖帳金額)
            LET l_apce109_amt = l_tot_apcc108 - l_tot_apcc109
            CALL s_curr_round_ld('1',p_ld,l_apcc100,l_apce109_amt,2) RETURNING g_sub_success,g_errno,l_apce109_amt
            IF cl_null(l_apce109_amt)THEN LET l_apce109_amt = 0 END IF
            
            #預付沖本幣(本幣應付金額-本幣付款沖帳金額)
            #LET l_apce119_amt = l_tot_apcc118 - l_tot_apcc119
            LET l_apce119_amt = l_tot_apcc118 + l_tot_apcc113 - l_tot_apcc119  #180425-00047#1 mod
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce119_amt,2) RETURNING g_sub_success,g_errno,l_apce119_amt
            IF cl_null(l_apce119_amt)THEN LET l_apce119_amt = 0 END IF
            
            #匯差金額(預付沖本幣-應付帳款單匯率*預付沖原幣)
            #171129-00009#1 --s add
            LET l_amt = 0
            LET l_amt = l_apca.apca101 * l_apce109_amt
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_amt,2) RETURNING g_sub_success,g_errno,l_amt
            #171129-00009#1 --e add              
            #LET l_diff = l_apce119_amt - (l_apca.apca101 * l_apce109_amt)  #171120-00011#1 mark   #171215-00036#1 remark #171129-00009#1 mark
            LET l_diff = l_apce119_amt - l_amt                              #171129-00009#1 add
            #LET l_diff = l_apce119_amt - l_apca.apca118     #171120-00011#1 add   #171215-00036#1 mark
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_diff,2) RETURNING g_sub_success,g_errno,l_diff
            IF cl_null(l_diff)THEN LET l_diff = 0 END IF   
         ELSE
            #計算比率
            LET l_percent = l_apce109 / l_tot_apcc108
            
            #預付沖原幣(來源待抵預付總額*比率)
            LET l_apce109_amt = l_tot_apcc108 * l_percent
            CALL s_curr_round_ld('1',p_ld,l_apcc100,l_apce109_amt,2) RETURNING g_sub_success,g_errno,l_apce109_amt
            IF cl_null(l_apce109_amt)THEN LET l_apce109_amt = 0 END IF
            
            #預付沖本幣(來源待抵預付匯率*預付沖原幣)
            LET l_apce119_amt = l_apcc101 * l_apce109_amt
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce119_amt,2) RETURNING g_sub_success,g_errno,l_apce119_amt
            IF cl_null(l_apce119_amt)THEN LET l_apce119_amt = 0 END IF
            
            #匯差金額(預付沖本幣-應付帳款單匯率*預付沖原幣)
            #171129-00009#1 --s add
            LET l_amt = 0
            LET l_amt = l_apca.apca101 * l_apce109_amt
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_amt,2) RETURNING g_sub_success,g_errno,l_amt
            #171129-00009#1 --e add               
            #LET l_diff = l_apce119_amt - (l_apca.apca101 * l_apce109_amt)  #171120-00011#1 mark   #171215-00036#1 remark #171129-00009#1 mark
            LET l_diff = l_apce119_amt - l_amt                               #171129-00009#1 add
            #LET l_diff = l_apce119_amt - l_apca.apca118     #171120-00011#1 add   #171215-00036#1 mark
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_diff,2) RETURNING g_sub_success,g_errno,l_diff
            IF cl_null(l_diff)THEN LET l_diff = 0 END IF
         END IF         
      END IF
      
      #匯差只會產生一筆,匯總顯示
      LET l_diff_amt = l_diff_amt + l_diff
      
   END FOREACH
   
   #190329-00027#1---add---str
  
   LET l_apce109_sum = 0
   #直接冲账里的合计原币金额          
   SELECT SUM(apce109) INTO l_apce109_sum
     FROM apca_t,apce_t 
     WHERE apceent = g_enterprise 
       AND apceld = p_ld 
       AND apcedocno = p_docno
       AND apcaent = apceent 
       AND apcald = apceld 
       AND apcadocno = apcedocno 
       AND apcastus <> 'X' 
       AND apce001 <> 'aapt430' 
       AND apce100 = apca100 
       #ORDER BY apceseq #200828-00021#1 mark
    LET l_apca108 = 0
    #aapt300立账的原币金额
    SELECT apca108 INTO l_apca108
      FROM apca_t
     WHERE apcaent = g_enterprise
       AND apcadocno = p_docno
       AND apcastus <> 'X'
    
    #如果相等说明原币已经冲完
    IF l_apce109_sum = l_apca108 THEN
       LET l_apce119_sum = 0
       #获得冲销的本币金额    
       SELECT SUM(apce119) INTO l_apce119_sum
       FROM apca_t,apce_t 
       WHERE apceent = g_enterprise 
         AND apceld = p_ld 
         AND apcedocno = p_docno
         AND apcaent = apceent 
         AND apcald = apceld 
         AND apcadocno = apcedocno 
         AND apcastus <> 'X' 
         AND apce001 <> 'aapt430' 
         AND apce100 = apca100 
         #ORDER BY apceseq  #200828-00021#1 mark
       
       LET l_apca118 = 0
       #aapt300立账的本币金额
       SELECT apca118 INTO l_apca118
         FROM apca_t
        WHERE apcaent = g_enterprise
          AND apcadocno = p_docno
          AND apcastus <> 'X'  
       
       LET l_diff_amt = l_apce119_sum - l_apca118   #直接冲账的本币和aapt300的本币获得差额
       
    END IF
   #190329-00027#1---add---str
   
   IF l_diff_amt <> 0 THEN
      #取得應付帳款單資訊
      LET l_apca.apcacomp = ''
      LET l_apca.apcasite = ''
      LET l_apca.apcadocdt = ''
      LET l_apca.apca101 = ''
      LET l_apca.apca100 = '' #170324-00130#1 add
      #SELECT apcacomp,apcasite,apcadocdt,apca101         #170324-00130#1 mark
      SELECT apcacomp,apcasite,apcadocdt,apca101,apca100  #170324-00130#1 add apca100
        #INTO l_apca.apcacomp,l_apca.apcasite,l_apca.apcadocdt,l_apca.apca101               #170324-00130#1 mark
        INTO l_apca.apcacomp,l_apca.apcasite,l_apca.apcadocdt,l_apca.apca101,l_apca.apca100 #170324-00130#1 add l_apca.apca100
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_docno AND apcastus <> 'X'
   
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent   = g_enterprise
      LET l_apde.apdeld    = p_ld
      LET l_apde.apdecomp  = l_apca.apcacomp
      LET l_apde.apdeorga  = l_apca.apcacomp
      LET l_apde.apdesite  = l_apca.apcasite
      LET l_apde.apdedocno = p_docno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent = l_apde.apdeent AND apdeld = l_apde.apdeld AND apdedocno = l_apde.apdedocno
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      LET l_apde.apde001 = 'aapt300'
      LET l_apde.apde009 = 'N'
      LET l_apde.apde028 = '0'
      LET l_apde.apde006 = '10'      #預設現金
      #IF l_diff_amt < 0 THEN         #立帳 < 沖帳:屬於匯兌損失  #170322-00082#1 mark
      IF l_diff_amt > 0 THEN         #立帳 < 沖帳:屬於匯兌損失   #170322-00082#1 add
         LET l_apde.apde002 = '11'
         LET l_apde.apde016 = s_aapt420_bring_acc_code2(l_apde.apdeld,l_apde.apdesite,l_apde.apde038,l_apde.apde002,l_apde.apde006,l_apde.apde008)
         LET l_apde.apde006 = '' #180823-00003#1 add
      ELSE                           #立帳 > 沖帳:屬於匯兌收益
         LET l_apde.apde002 = '12'   
         LET l_apde.apde016 = s_aapt420_bring_acc_code2(l_apde.apdeld,l_apde.apdesite,l_apde.apde038,l_apde.apde002,l_apde.apde006,l_apde.apde008)
         LET l_apde.apde006 = '' #180823-00003#1 add
      END IF
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
      #LET l_apde.apde100 = l_glaa001     #170324-00130#1 mark
      LET l_apde.apde100 = l_apca.apca100 #170324-00130#1 add 以原幣幣別寫入直接付款
#      LET l_apde.apde101 = 1                 #170725-00041#1---mark
      LET l_apde.apde101 = l_apca.apca101  #170725-00041#1---add    
      LET l_apde.apde109 = 0
      #判斷完匯兌損失/匯兌收益後,將金額轉正顯示
      LET l_apde.apde119 = s_math_abs(l_diff_amt)
      LET l_apde.apde011 = '' #銀行存提碼
      LET l_apde.apde012 = '' #現金變動碼
      LET l_apde.apde013 = ''
      LET l_apde.apde014 = ''
      LET l_apde.apde032 = l_apca.apcadocdt
      #180130-00050#5---add by 10554---(S) 金額/匯率為空預設0
      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 0 END IF
      IF cl_null(l_apde.apde119) THEN LET l_apde.apde119 = 0 END IF
      #180130-00050#5---add by 10554---(E)
      INSERT INTO apde_t(apdeent,
                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                         apde001,apde009,apde028,apde002,apde015,
                         apde003,apde004,apdeorga,apde006,apde011,
                         apde012,apde013,apde014,apde016,apde017,
                         apde018,apde021,apde032,apde100,apde101,
                         apde109,apde119)
             VALUES(l_apde.apdeent,
                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                    l_apde.apde109,l_apde.apde119)
      IF SQLCA.SQLCODE THEN END IF
   END IF      
END FUNCTION
################################################################################
# Descriptions...: 如有產生待抵單,單據執行失敗要rollback
# Memo...........: #170518-00041#1 add
# Usage..........: CALL s_aapp131_del_341(p_ld,p_docdt,p_strno1,p_endno1)
#                  RETURNING 回传参数
# Input parameter: p_ld       傳入帳套
#                : p_docdt    傳入日期
#                : p_strno1   待抵單號起
#                : p_endno1   待抵單號止
# Date & Author..: 170915 By 06821
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_del_341(p_ld,p_docdt,p_strno1,p_endno1)
DEFINE p_ld            LIKE apca_t.apcald
DEFINE p_docdt         LIKE apca_t.apcadocdt
DEFINE p_strno1        LIKE apca_t.apcadocno
DEFINE p_endno1        LIKE apca_t.apcadocno   
DEFINE l_apcbdocno_341 LIKE apcb_t.apcbdocno
DEFINE l_success       LIKE type_t.num5
DEFINE l_prog          LIKE gzza_t.gzza001
DEFINE l_sql           STRING

   WHENEVER ERROR CONTINUE

   IF cl_null(p_strno1) OR cl_null(p_endno1) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-00228'
      LET g_errparam.extend = "FOREACH:del_341c"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET l_success = FALSE   
      RETURN
   END IF

   LET l_success = TRUE
   LET l_apcbdocno_341 = ''
   LET l_sql = " SELECT DISTINCT apcbdocno ", 
               "   FROM apcb_t ",
               "  WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"' ",
               "    AND apcbdocno BETWEEN '",p_strno1,"' AND '",p_endno1,"' "
   PREPARE del_341p FROM l_sql
   DECLARE del_341c CURSOR FOR del_341p                                
   FOREACH del_341c INTO l_apcbdocno_341
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:del_341c"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      
      #刪除 aapt341單頭
      DELETE FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = l_apcbdocno_341
         
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = l_apcbdocno_341,":",SQLERRMESSAGE  
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      
      LET l_prog = g_prog #備份
      LET g_prog = 'aapt341'
      IF NOT s_aooi200_fin_del_docno(p_ld,l_apcbdocno_341,p_docdt) THEN
         LET g_prog = l_prog
         LET l_success = FALSE
         EXIT FOREACH
      END IF 
      LET g_prog = l_prog         
      
      #刪除 aapt341單身
      DELETE FROM apcb_t
       WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = l_apcbdocno_341
       
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = l_apcbdocno_341,"apcb_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         LET l_success = FALSE
         EXIT FOREACH
      END IF    
      
      #刪除多帳期資訊
      DELETE FROM apcc_t
       WHERE apccent = g_enterprise AND apccld = p_ld AND apccdocno = l_apcbdocno_341
       
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = l_apcbdocno_341,"apcc_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         LET l_success = FALSE
         EXIT FOREACH
      END IF      
      
      #清空aapt110 交易單號/項次
      UPDATE apba_t SET apba005 = '',apba006 = ''
       WHERE apbaent = g_enterprise AND apba004 = '18' AND apba005 = l_apcbdocno_341 AND apba006 = '1'
   
   END FOREACH
   
   RETURN l_success
END FUNCTION

################################################################################
# Descriptions...: 依照訂金匯率重算本幣金額
# Memo...........: #171109-00014#2
# Usage..........: CALL s_aapp131_count_115()
# Date & Author..: 2017/12/25 By Reanna
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_count_115(ls_js)
DEFINE ls_js             STRING
DEFINE lc_param_115      RECORD
          ld                LIKE apca_t.apcald,
          pmdt001           LIKE pmdt_t.pmdt001,
          pmdtdocno         LIKE pmdt_t.pmdtdocno,
          apcbdocno         LIKE apcb_t.apcbdocno,
          apcbseq           LIKE apcb_t.apcbseq,
          apcb103           LIKE apcb_t.apcb103,
          apca012           LIKE apca_t.apca012,
          apca101           LIKE apca_t.apca101
                         END RECORD
DEFINE l_glaacomp        LIKE glaa_t.glaacomp
DEFINE l_glaa001         LIKE glaa_t.glaa001
DEFINE l_sfin3035        LIKE type_t.chr100
DEFINE l_sfin3020        LIKE type_t.chr100
DEFINE l_glca004         LIKE glca_t.glca004
DEFINE l_sum_pmdt038     LIKE pmdt_t.pmdt038
DEFINE l_apca100         LIKE apca_t.apca100
DEFINE l_sql             STRING
DEFINE l_apce101         LIKE apce_t.apce101
DEFINE l_apce103         LIKE apce_t.apce103
DEFINE l_paid            LIKE apcb_t.apcb103
DEFINE l_paid2           LIKE apcb_t.apcb103
DEFINE l_paid_sum        LIKE apcb_t.apcb103
DEFINE l_paid_sum_orig   LIKE apcb_t.apcb103
DEFINE l_last            LIKE apcb_t.apcb103
DEFINE r_success         LIKE type_t.num5
DEFINE r_flag            LIKE type_t.chr10
DEFINE r_apcb113         LIKE apcb_t.apcb113
DEFINE r_apcb114         LIKE apcb_t.apcb114
DEFINE r_apcb115         LIKE apcb_t.apcb115


   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   LET r_flag = 'N'
   
   CALL util.JSON.parse(ls_js,lc_param_115)
   
   IF cl_null(lc_param_115.pmdt001) THEN
      RETURN r_success,r_flag,r_apcb113,r_apcb114,r_apcb115
   END IF
   
   #若有啟用aoos020的"預付沖銷時，是否以歷史匯率確認存貨科目本幣金額"(S-FIN-3035)
   # & agli171設訂預收預付參與重評=N
   # & S-FIN-3020：是否按採購單核銷訂金=Y
   #三者成立，才依照新算法推金額
   #EX：採購單訂金200，項次一400，項次二600，匯率30.1
   #依照訂金比例拆算，項次一80(200*400/(400+600))，項次二120(200*600/(400+600))
   #尾款：項次一320(400-80)，項次二480(600-120)
   #立帳時，匯率是30.5，金額就是：訂金金額*訂金匯率+尾款*尾款立帳時匯率
   #項次一：80*30.1+320*30.5
   #項次二：120*30.1+480*30.5
   
   SELECT glaacomp,glaa001 INTO l_glaacomp,l_glaa001
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald=lc_param_115.ld
   
   #S-FIN-3035：預付沖銷時，是否以歷史匯率確認存貨科目本幣金額
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3035') RETURNING l_sfin3035
   #S-FIN-3020：是否按採購單核銷訂金
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3020') RETURNING l_sfin3020
   #200904-00065#1 add -s
   IF g_prog MATCHES 'axrp141*' OR g_prog MATCHES 'aapp141*' THEN
      LET l_sfin3020 = 'Y'
   END IF
   #200904-00065#1 add -e
   LET l_glca004 = NULL
   #agli171設訂預收預付參與重評
   SELECT glca004 INTO l_glca004
     FROM glca_t
    WHERE glcaent = g_enterprise
      AND glcald = lc_param_115.ld
      AND glca001 = 'AP'
   
   LET r_apcb113 = 0
   LET r_apcb114 = 0
   LET r_apcb115 = 0
   
   IF l_sfin3035 = 'Y' AND l_sfin3020 = 'Y' AND l_glca004 = 'Y' THEN
      #入庫單身總額
      SELECT SUM(pmdt038) INTO l_sum_pmdt038
        FROM pmdt_t
       WHERE pmdtent = g_enterprise
         AND pmdtdocno = lc_param_115.pmdtdocno
      IF cl_null(l_sum_pmdt038) THEN LET l_sum_pmdt038 = 0 END IF
      
      #取立帳幣別
      SELECT apca100 INTO l_apca100
        FROM apca_t
       WHERE apcaent = g_enterprise
         AND apcadocno = lc_param_115.apcbdocno
      
      #取得該張立帳單有直接沖帳的所有訂金待抵單
      LET l_sql = "SELECT SUM(apce103),apce101",
                  "  FROM apce_t",
                  " WHERE apceent = ",g_enterprise,
                  "   AND apcedocno = '",lc_param_115.apcbdocno,"'",
                  "   AND apce002 = '41'",   #41:應付待抵單沖銷
                  " GROUP BY apce101"
      PREPARE s_aapp131_sel_pr1 FROM l_sql
      DECLARE s_aapp131_sel_cs1 CURSOR FOR s_aapp131_sel_pr1
      LET l_paid_sum = 0
      LET l_paid_sum_orig = 0
      FOREACH s_aapp131_sel_cs1 INTO l_apce103,l_apce101
         IF cl_null(l_apce103) THEN LET l_apce103 = 0 END IF
         IF cl_null(l_apce101) THEN LET l_apce101 = 0 END IF
         
         #依照總額算出這一筆項次訂金多少(原幣)
         LET l_paid = l_apce103*lc_param_115.apcb103/l_sum_pmdt038
         IF cl_null(l_paid) THEN LET l_paid = 0 END IF
         CALL s_curr_round_ld('1',lc_param_115.ld,l_apca100,l_paid,2) RETURNING g_sub_success,g_errno,l_paid
         #這項次比例的訂金*匯率算成本幣
         LET l_paid2 = l_paid * l_apce101
         CALL s_curr_round_ld('1',lc_param_115.ld,l_glaa001,l_paid2,2) RETURNING g_sub_success,g_errno,l_paid2
         #統計一下目前訂金被分攤了多少(原幣)
         LET l_paid_sum = l_paid_sum + l_paid
         #(本幣)
         LET l_paid_sum_orig = l_paid_sum_orig + l_paid2
      END FOREACH
      
      
      #該筆項次剩下的錢
      LET l_last = lc_param_115.apcb103 - l_paid_sum
      #乘上匯率算出本幣(未稅)
      LET r_apcb113 = l_paid_sum_orig+l_last*lc_param_115.apca101
      IF cl_null(r_apcb113) THEN LET r_apcb113 = 0 END IF
      CALL s_curr_round_ld('1',lc_param_115.ld,l_glaa001,r_apcb113,2) RETURNING g_sub_success,g_errno,r_apcb113
      #本幣稅額
      LET r_apcb114 = r_apcb113 * lc_param_115.apca012 / 100
      IF cl_null(r_apcb114) THEN LET r_apcb114 = 0 END IF
      CALL s_curr_round_ld('1',lc_param_115.ld,l_glaa001,r_apcb114,2) RETURNING g_sub_success,g_errno,r_apcb114
      #本幣含稅
      LET r_apcb115 = r_apcb113 + r_apcb114
      
      UPDATE xrcd_t
         SET xrcd113 = r_apcb113,
             xrcd114 = r_apcb114,
             xrcd115 = r_apcb115
       WHERE xrcdent = g_enterprise
         AND xrcdld = lc_param_115.ld
         AND xrcddocno = lc_param_115.apcbdocno
         AND xrcdseq = lc_param_115.apcbseq
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         RETURN r_success,r_flag,r_apcb113,r_apcb114,r_apcb115
      ELSE
         LET r_flag = 'Y'
      END IF 
   END IF
   
   RETURN r_success,r_flag,r_apcb113,r_apcb114,r_apcb115
   
END FUNCTION

################################################################################
# Descriptions...: 根據agli043設定,預帶自由核算項值
# Memo...........:
# Usage..........: CALL s_aapp131_upd_accitem_free(p_ld,p_docno,p_seq,p_apcb021,p_apcb029,p_array)
# Input parameter: p_prog1   程式代號
#                  p_ld      帳套
#                  p_docno   單號
#                  p_seq     項次
#                  p_apcb021 費用會計科目
#                  p_apcb029 應付帳款科目
#                  p_array   自由核算項1~10
# Date & Author..: 2018/08/23 By 10043
# Modify.........: #180704-00022#1 add
################################################################################
PUBLIC FUNCTION s_aapp131_upd_accitem_free(p_prog,p_ld,p_docno,p_seq,p_apcb021,p_apcb029,p_array)
DEFINE p_prog     STRING
DEFINE p_ld       LIKE apca_t.apcald
DEFINE p_docno    LIKE apca_t.apcadocno
DEFINE p_seq      LIKE apcb_t.apcbseq
DEFINE p_apcb021  LIKE apcb_t.apcb021
DEFINE p_apcb029  LIKE apcb_t.apcb029
DEFINE p_array    DYNAMIC ARRAY OF RECORD
       chr  LIKE type_t.chr1000
       END RECORD  
DEFINE l_apcb RECORD
       apcb037 LIKE apcb_t.apcb037, #自由核算項一
       apcb038 LIKE apcb_t.apcb038, #自由核算項二
       apcb039 LIKE apcb_t.apcb039, #自由核算項三
       apcb040 LIKE apcb_t.apcb040, #自由核算項四
       apcb041 LIKE apcb_t.apcb041, #自由核算項五
       apcb042 LIKE apcb_t.apcb042, #自由核算項六
       apcb043 LIKE apcb_t.apcb043, #自由核算項七
       apcb044 LIKE apcb_t.apcb044, #自由核算項八
       apcb045 LIKE apcb_t.apcb045, #自由核算項九
       apcb046 LIKE apcb_t.apcb046  #自由核算項十
       END RECORD
#自由核算項啟用否       
DEFINE l_glad     RECORD      
       glad017    LIKE glad_t.glad017,
       glad018    LIKE glad_t.glad018,
       glad019    LIKE glad_t.glad019,
       glad020    LIKE glad_t.glad020,
       glad021    LIKE glad_t.glad021,
       glad022    LIKE glad_t.glad022,
       glad023    LIKE glad_t.glad023,
       glad024    LIKE glad_t.glad024,
       glad025    LIKE glad_t.glad025,
       glad026    LIKE glad_t.glad026
       END RECORD
#自由核算項啟用否       
DEFINE r_glad     RECORD      
       glad017    LIKE glad_t.glad017,
       glad018    LIKE glad_t.glad018,
       glad019    LIKE glad_t.glad019,
       glad020    LIKE glad_t.glad020,
       glad021    LIKE glad_t.glad021,
       glad022    LIKE glad_t.glad022,
       glad023    LIKE glad_t.glad023,
       glad024    LIKE glad_t.glad024,
       glad025    LIKE glad_t.glad025,
       glad026    LIKE glad_t.glad026
       END RECORD
#抓自由核算項預設值用
DEFINE l_field    RECORD
       field1     LIKE type_t.chr10, 
       field2     LIKE type_t.chr10,
       field3     LIKE type_t.chr10, 
       field4     LIKE type_t.chr10,
       field5     LIKE type_t.chr10, 
       field6     LIKE type_t.chr10,
       field7     LIKE type_t.chr10, 
       field8     LIKE type_t.chr10,
       field9     LIKE type_t.chr10,     
       field10    LIKE type_t.chr10            
       END RECORD

   INITIALIZE l_field.* TO NULL
   
   LET l_apcb.apcb037 = p_array[1].chr   
   LET l_apcb.apcb038 = p_array[2].chr   
   LET l_apcb.apcb039 = p_array[3].chr   
   LET l_apcb.apcb040 = p_array[4].chr   
   LET l_apcb.apcb041 = p_array[5].chr   
   LET l_apcb.apcb042 = p_array[6].chr   
   LET l_apcb.apcb043 = p_array[7].chr   
   LET l_apcb.apcb044 = p_array[8].chr   
   LET l_apcb.apcb045 = p_array[9].chr   
   LET l_apcb.apcb046 = p_array[10].chr  
   
   LET l_field.field1 = 'apcb037'
   LET l_field.field2 = 'apcb038'
   LET l_field.field3 = 'apcb039'
   LET l_field.field4 = 'apcb040'
   LET l_field.field5 = 'apcb041'
   LET l_field.field6 = 'apcb042'
   LET l_field.field7 = 'apcb043'
   LET l_field.field8 = 'apcb044'
   LET l_field.field9 = 'apcb045'
   LET l_field.field10 = 'apcb046'
                 
   #取科目聯集
   LET l_glad.glad017 = 'N' #自由核算項一控制方式
   LET l_glad.glad018 = 'N'
   LET l_glad.glad019 = 'N'
   LET l_glad.glad020 = 'N'
   LET l_glad.glad021 = 'N'
   LET l_glad.glad022 = 'N'
   LET l_glad.glad023 = 'N'
   LET l_glad.glad024 = 'N'
   LET l_glad.glad025 = 'N'
   LET l_glad.glad026 = 'N'
   
   IF NOT cl_null(p_apcb021) THEN
      #費用會計科目
      CALL s_account_item_free(p_ld,p_apcb021,p_prog,p_docno,p_seq,'',l_apcb.*,l_field.*)
      RETURNING l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,l_apcb.apcb040,l_apcb.apcb041,
             l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,l_apcb.apcb045,l_apcb.apcb046
                  
      CALL s_fin_sel_glad(p_ld,p_apcb021,'glad017|glad018|glad019|glad020||glad021|glad022|glad023|glad024|glad025|glad026') 
      RETURNING g_errno,r_glad.*
      IF r_glad.glad017 = 'Y' THEN LET l_glad.glad017 = 'Y' END IF
      IF r_glad.glad018 = 'Y' THEN LET l_glad.glad018 = 'Y' END IF
      IF r_glad.glad019 = 'Y' THEN LET l_glad.glad019 = 'Y' END IF
      IF r_glad.glad020 = 'Y' THEN LET l_glad.glad020 = 'Y' END IF 
      IF r_glad.glad021 = 'Y' THEN LET l_glad.glad021 = 'Y' END IF 
      IF r_glad.glad022 = 'Y' THEN LET l_glad.glad022 = 'Y' END IF 
      IF r_glad.glad023 = 'Y' THEN LET l_glad.glad023 = 'Y' END IF 
      IF r_glad.glad024 = 'Y' THEN LET l_glad.glad024 = 'Y' END IF 
      IF r_glad.glad025 = 'Y' THEN LET l_glad.glad025 = 'Y' END IF 
      IF r_glad.glad026 = 'Y' THEN LET l_glad.glad026 = 'Y' END IF
   END IF
             
   IF NOT cl_null(p_apcb029) THEN
      #應付帳款科目                   
      CALL s_account_item_free(p_ld,p_apcb029,p_prog,p_docno,p_seq,'',l_apcb.*,l_field.*)
      RETURNING l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,l_apcb.apcb040,l_apcb.apcb041,
                l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,l_apcb.apcb045,l_apcb.apcb046
            
      CALL s_fin_sel_glad(p_ld,p_apcb029,'glad017|glad018|glad019|glad020||glad021|glad022|glad023|glad024|glad025|glad026') 
      RETURNING g_errno,r_glad.*
      IF r_glad.glad017 = 'Y' THEN LET l_glad.glad017 = 'Y' END IF
      IF r_glad.glad018 = 'Y' THEN LET l_glad.glad018 = 'Y' END IF
      IF r_glad.glad019 = 'Y' THEN LET l_glad.glad019 = 'Y' END IF
      IF r_glad.glad020 = 'Y' THEN LET l_glad.glad020 = 'Y' END IF 
      IF r_glad.glad021 = 'Y' THEN LET l_glad.glad021 = 'Y' END IF 
      IF r_glad.glad022 = 'Y' THEN LET l_glad.glad022 = 'Y' END IF 
      IF r_glad.glad023 = 'Y' THEN LET l_glad.glad023 = 'Y' END IF 
      IF r_glad.glad024 = 'Y' THEN LET l_glad.glad024 = 'Y' END IF 
      IF r_glad.glad025 = 'Y' THEN LET l_glad.glad025 = 'Y' END IF 
      IF r_glad.glad026 = 'Y' THEN LET l_glad.glad026 = 'Y' END IF
   END IF
        
   #若沒有啟用自由核算項,清空值
   IF l_glad.glad017 <> 'Y' THEN LET l_apcb.apcb037 = ' ' END IF
   IF l_glad.glad018 <> 'Y' THEN LET l_apcb.apcb038 = ' ' END IF
   IF l_glad.glad019 <> 'Y' THEN LET l_apcb.apcb039 = ' ' END IF
   IF l_glad.glad020 <> 'Y' THEN LET l_apcb.apcb040 = ' ' END IF
   IF l_glad.glad021 <> 'Y' THEN LET l_apcb.apcb041 = ' ' END IF
   IF l_glad.glad022 <> 'Y' THEN LET l_apcb.apcb042 = ' ' END IF
   IF l_glad.glad023 <> 'Y' THEN LET l_apcb.apcb043 = ' ' END IF
   IF l_glad.glad024 <> 'Y' THEN LET l_apcb.apcb044 = ' ' END IF
   IF l_glad.glad025 <> 'Y' THEN LET l_apcb.apcb045 = ' ' END IF
   IF l_glad.glad026 <> 'Y' THEN LET l_apcb.apcb046 = ' ' END IF
   
   RETURN l_apcb.apcb037,l_apcb.apcb038,l_apcb.apcb039,l_apcb.apcb040,l_apcb.apcb041,
          l_apcb.apcb042,l_apcb.apcb043,l_apcb.apcb044,l_apcb.apcb045,l_apcb.apcb046
END FUNCTION

################################################################################
# Descriptions...: 取固定核算项设定值
# Memo...........:
# Usage..........: CALL s_aapp131_get_accitem(p_ld,p_apcb021,p_apcb029,p_xrcd009,p_apcb)
#                     RETURNING r_apcb.*
# Input parameter: p_ld          账套
#                : p_apcb021     费用会计科目
#                : p_apcb029     应付账款科目
#                : p_xrcd009     税额科目
#                : p_apcb        固定核算项
# Return code....: r_apcb        固定核算项
# Date & Author..: #180705-00083#1 20181015 add by 08172
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_get_accitem(p_ld,p_apcb021,p_apcb029,p_xrcd009,p_apcb)
   DEFINE p_ld          LIKE apcb_t.apcbld
   DEFINE p_apcb029     LIKE apcb_t.apcb029
   DEFINE p_apcb021     LIKE apcb_t.apcb021
   DEFINE p_xrcd009     LIKE xrcd_t.xrcd009
   DEFINE p_apcb        RECORD
       apcb054          LIKE apcb_t.apcb054,
       apcb055          LIKE apcb_t.apcb055,
       apcb051          LIKE apcb_t.apcb051,
       apcb010          LIKE apcb_t.apcb010,
       apcb011          LIKE apcb_t.apcb011,
       apcb024          LIKE apcb_t.apcb024,
       apcb036          LIKE apcb_t.apcb036,
       apcb012          LIKE apcb_t.apcb012,
       apcb033          LIKE apcb_t.apcb033,
       apcb034          LIKE apcb_t.apcb034,
       apcb035          LIKE apcb_t.apcb035,
       apcb015          LIKE apcb_t.apcb015,
       apcb016          LIKE apcb_t.apcb016
                        END RECORD
   DEFINE r_apcb        RECORD
       apcb054          LIKE apcb_t.apcb054,
       apcb055          LIKE apcb_t.apcb055,
       apcb051          LIKE apcb_t.apcb051,
       apcb010          LIKE apcb_t.apcb010,
       apcb011          LIKE apcb_t.apcb011,
       apcb024          LIKE apcb_t.apcb024,
       apcb036          LIKE apcb_t.apcb036,
       apcb012          LIKE apcb_t.apcb012,
       apcb033          LIKE apcb_t.apcb033,
       apcb034          LIKE apcb_t.apcb034,
       apcb035          LIKE apcb_t.apcb035,
       apcb015          LIKE apcb_t.apcb015,
       apcb016          LIKE apcb_t.apcb016
                        END RECORD                     
   #固定科目核算项 -费用会计科目
   DEFINE l_glad007     LIKE glad_t.glad007
   DEFINE l_glad008     LIKE glad_t.glad008
   DEFINE l_glad009     LIKE glad_t.glad009
   DEFINE l_glad010     LIKE glad_t.glad010
   DEFINE l_glad027     LIKE glad_t.glad027
   DEFINE l_glad011     LIKE glad_t.glad011
   DEFINE l_glad012     LIKE glad_t.glad012
   DEFINE l_glad013     LIKE glad_t.glad013
   DEFINE l_glad015     LIKE glad_t.glad015
   DEFINE l_glad016     LIKE glad_t.glad016
   DEFINE l_glad031     LIKE glad_t.glad031
   DEFINE l_glad032     LIKE glad_t.glad032
   DEFINE l_glad033     LIKE glad_t.glad033
   #固定科目核算项 -应付账款科目
   DEFINE l_glad007b    LIKE glad_t.glad007
   DEFINE l_glad008b    LIKE glad_t.glad008
   DEFINE l_glad009b    LIKE glad_t.glad009
   DEFINE l_glad010b    LIKE glad_t.glad010
   DEFINE l_glad027b    LIKE glad_t.glad027
   DEFINE l_glad011b    LIKE glad_t.glad011
   DEFINE l_glad012b    LIKE glad_t.glad012
   DEFINE l_glad013b    LIKE glad_t.glad013
   DEFINE l_glad015b    LIKE glad_t.glad015
   DEFINE l_glad016b    LIKE glad_t.glad016
   DEFINE l_glad031b    LIKE glad_t.glad031
   DEFINE l_glad032b    LIKE glad_t.glad032
   DEFINE l_glad033b    LIKE glad_t.glad033
   #固定科目核算项 -税额科目
   DEFINE l_glad007c    LIKE glad_t.glad007
   DEFINE l_glad008c    LIKE glad_t.glad008
   DEFINE l_glad009c    LIKE glad_t.glad009
   DEFINE l_glad010c    LIKE glad_t.glad010
   DEFINE l_glad027c    LIKE glad_t.glad027
   DEFINE l_glad011c    LIKE glad_t.glad011
   DEFINE l_glad012c    LIKE glad_t.glad012
   DEFINE l_glad013c    LIKE glad_t.glad013
   DEFINE l_glad015c    LIKE glad_t.glad015
   DEFINE l_glad016c    LIKE glad_t.glad016
   DEFINE l_glad031c    LIKE glad_t.glad031
   DEFINE l_glad032c    LIKE glad_t.glad032
   DEFINE l_glad033c    LIKE glad_t.glad033
  #DEFINE l_sfin9025    LIKE type_t.chr1     #190423-00042#1 add #190423-00042#38 mark
   DEFINE l_sfin9026    LIKE type_t.chr1     #190423-00042#38 add
   DEFINE l_comp        LIKE glaa_t.glaacomp #190423-00042#1 add

   #190423-00042#1---s--- #依專案進行帳務管理否
   SELECT glaacomp INTO l_comp FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_ld   
   #190423-00042#38---mark---(S)
   #LET l_sfin9025 = ''
   #CALL cl_get_para(g_enterprise,l_comp,'S-FIN-9025') RETURNING l_sfin9025
   #IF cl_null(l_sfin9025) THEN LET l_sfin9025 = 'N' END IF   
   #190423-00042#38---mark---(E)
   #190423-00042#38---add---(S)
   LET l_sfin9026 = ''
   CALL cl_get_para(g_enterprise,l_comp,'S-FIN-9026') RETURNING l_sfin9026
   IF cl_null(l_sfin9026) THEN LET l_sfin9026 = 'N' END IF   
   #190423-00042#38---add---(E)
   #190423-00042#1---s---
   
   INITIALIZE r_apcb.* TO NULL
   #固定核算项默认值  费用会计科目 -> 应付账款科目 -> 税额科目
   #账款科目固定核算项开启
   CALL s_voucher_fix_acc_open_chk(p_ld,p_apcb021)
   RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,
             l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,
             l_glad033      
   #收入科目固定核算项开启
   CALL s_voucher_fix_acc_open_chk(p_ld,p_apcb029)
   RETURNING l_glad007b,l_glad008b,l_glad009b,l_glad010b,l_glad027b,l_glad011b,
             l_glad012b,l_glad013b,l_glad015b,l_glad016b,l_glad031b,l_glad032b,
             l_glad033b
   #税额科目固定核算项开启
   CALL s_voucher_fix_acc_open_chk(p_ld,p_xrcd009)
   RETURNING l_glad007c,l_glad008c,l_glad009c,l_glad010c,l_glad027c,l_glad011c,
             l_glad012c,l_glad013c,l_glad015c,l_glad016c,l_glad031c,l_glad032c,
             l_glad033c          
   #账款对象
   LET r_apcb.apcb054 = p_apcb.apcb054
   #收付款对象
   LET r_apcb.apcb055 = p_apcb.apcb055
   #业务人员
   LET r_apcb.apcb051 = p_apcb.apcb051
   #业务部门
   LET r_apcb.apcb010 = p_apcb.apcb010
   #利润成本/责任中心
   IF (l_glad008 <> 'Y' OR l_glad008 IS NULL) AND (l_glad008b <> 'Y' OR l_glad008b IS NULL) AND (l_glad008c <> 'Y' OR l_glad008c IS NULL) THEN   
      LET r_apcb.apcb011 = ' '      
   ELSE
      LET r_apcb.apcb011 = p_apcb.apcb011
   END IF 
   #区域
   IF (l_glad009 <> 'Y' OR l_glad009 IS NULL) AND (l_glad009b <> 'Y' OR l_glad009b IS NULL) AND (l_glad009c <> 'Y' OR l_glad009c IS NULL) THEN 
      LET r_apcb.apcb024 = ' '
   ELSE
      IF cl_null(p_apcb.apcb024) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'4') RETURNING r_apcb.apcb024
         IF cl_null(r_apcb.apcb024) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'4') RETURNING r_apcb.apcb024
         END IF
         IF cl_null(r_apcb.apcb024) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'4') RETURNING r_apcb.apcb024
         END IF
      ELSE
         LET r_apcb.apcb024 = p_apcb.apcb024
      END IF
   END IF 
   #客群
   IF (l_glad011 <> 'Y' OR l_glad011 IS NULL) AND (l_glad011b <> 'Y' OR l_glad011b IS NULL) AND (l_glad011c <> 'Y' OR l_glad011c IS NULL) THEN 
      LET r_apcb.apcb036 = ' '     
   ELSE
      IF cl_null(p_apcb.apcb036) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'7') RETURNING r_apcb.apcb036
         IF cl_null(r_apcb.apcb036) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'7') RETURNING r_apcb.apcb036
         END IF 
         IF cl_null(r_apcb.apcb036) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'7') RETURNING r_apcb.apcb036
         END IF 
      ELSE
         LET r_apcb.apcb036 = p_apcb.apcb036
      END IF 
   END IF 
   #产品类别
   IF (l_glad012 <> 'Y' OR l_glad012 IS NULL) AND (l_glad012b <> 'Y' OR l_glad012b IS NULL) AND (l_glad012c <> 'Y' OR l_glad012c IS NULL) THEN 
      LET r_apcb.apcb012 = ' '    
   ELSE
      IF cl_null(p_apcb.apcb012) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'8') RETURNING r_apcb.apcb012
         IF cl_null(r_apcb.apcb012) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'8') RETURNING r_apcb.apcb012
         END IF
         IF cl_null(r_apcb.apcb012) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'8') RETURNING r_apcb.apcb012
         END IF
      ELSE
         LET r_apcb.apcb012 = p_apcb.apcb012
      END IF
   END IF 
   #经营方式
   IF (l_glad031 <> 'Y' OR l_glad031 IS NULL) AND (l_glad031b <> 'Y' OR l_glad031b IS NULL) AND (l_glad031c <> 'Y' OR l_glad031c IS NULL) THEN 
      LET r_apcb.apcb033 = ' '   
   ELSE
      IF cl_null(p_apcb.apcb033) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'9') RETURNING r_apcb.apcb033
         IF cl_null(r_apcb.apcb033) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'9') RETURNING r_apcb.apcb033
         END IF
         IF cl_null(r_apcb.apcb033) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'9') RETURNING r_apcb.apcb033
         END IF
      ELSE
         LET r_apcb.apcb033 = p_apcb.apcb033
      END IF
   END IF
   #渠道
   IF (l_glad032 <> 'Y' OR l_glad032 IS NULL) AND (l_glad032b <> 'Y' OR l_glad032b IS NULL) AND (l_glad032c <> 'Y' OR l_glad032c IS NULL) THEN 
      LET r_apcb.apcb034 = ' '    
   ELSE
      IF cl_null(p_apcb.apcb034) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'10') RETURNING r_apcb.apcb034
         IF cl_null(r_apcb.apcb034) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'10') RETURNING r_apcb.apcb034
         END IF
         IF cl_null(r_apcb.apcb034) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'10') RETURNING r_apcb.apcb034
         END IF
      ELSE
         LET r_apcb.apcb034 = p_apcb.apcb034
      END IF
   END IF
   #品牌
   IF (l_glad033 <> 'Y' OR l_glad033 IS NULL) AND (l_glad033b <> 'Y' OR l_glad033b IS NULL) AND (l_glad033c <> 'Y' OR l_glad033c IS NULL) THEN 
      LET r_apcb.apcb035 = ' '    
   ELSE
      IF cl_null(p_apcb.apcb035) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'11') RETURNING r_apcb.apcb035
         IF cl_null(r_apcb.apcb035) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'11') RETURNING r_apcb.apcb035
         END IF
         IF cl_null(r_apcb.apcb035) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'11') RETURNING r_apcb.apcb035
         END IF
      ELSE
         LET r_apcb.apcb035 = p_apcb.apcb035
      END IF
   END IF
   
   #项目
   IF (l_glad015 <> 'Y' OR l_glad015 IS NULL) AND (l_glad015b <> 'Y' OR l_glad015b IS NULL) AND (l_glad015c <> 'Y' OR l_glad015c IS NULL) THEN 
         LET r_apcb.apcb015 = ' '
        #IF l_sfin9025 = 'Y' THEN LET r_apcb.apcb015 = p_apcb.apcb015 END IF #190423-00042#1 add  #190423-00042#38 mark
         IF l_sfin9026 = 'Y' THEN LET r_apcb.apcb015 = p_apcb.apcb015 END IF #190423-00042#38 add        
   ELSE
      IF cl_null(p_apcb.apcb015) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'13') RETURNING r_apcb.apcb015
         IF cl_null(r_apcb.apcb015) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'13') RETURNING r_apcb.apcb015
         END IF 
         IF cl_null(r_apcb.apcb015) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'13') RETURNING r_apcb.apcb015
         END IF
      ELSE
         LET r_apcb.apcb015 = p_apcb.apcb015
      END IF 
   END IF 
   #WBS
   IF (l_glad016 <> 'Y' OR l_glad016 IS NULL) AND (l_glad016b <> 'Y' OR l_glad016b IS NULL) AND (l_glad016c <> 'Y' OR l_glad016c IS NULL) THEN
         LET r_apcb.apcb016 = ' '
        #IF l_sfin9025 = 'Y' THEN LET r_apcb.apcb016 = p_apcb.apcb016 END IF #190423-00042#1 add #190423-00042#38 mark
         IF l_sfin9026 = 'Y' THEN LET r_apcb.apcb016 = p_apcb.apcb016 END IF #190423-00042#38 add     
   ELSE
      IF cl_null(p_apcb.apcb016) THEN
         CALL s_voucher_get_fix_default_value(p_ld,p_apcb021,'14') RETURNING r_apcb.apcb016
         IF cl_null(r_apcb.apcb016) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_apcb029,'14') RETURNING r_apcb.apcb016
         END IF
         IF cl_null(r_apcb.apcb016) THEN
            CALL s_voucher_get_fix_default_value(p_ld,p_xrcd009,'14') RETURNING r_apcb.apcb016
         END IF
      ELSE
         LET r_apcb.apcb016 = p_apcb.apcb016
      END IF
   END IF
   
   IF cl_null(r_apcb.apcb010) THEN LET r_apcb.apcb010 = " " END IF #業務部門
   IF cl_null(r_apcb.apcb011) THEN LET r_apcb.apcb011 = " " END IF #責任中心
   IF cl_null(r_apcb.apcb012) THEN LET r_apcb.apcb012 = " " END IF #產品類別
   IF cl_null(r_apcb.apcb015) THEN LET r_apcb.apcb015 = " " END IF #專案編號
   IF cl_null(r_apcb.apcb016) THEN LET r_apcb.apcb016 = " " END IF #WBS編號
   IF cl_null(r_apcb.apcb024) THEN LET r_apcb.apcb024 = " " END IF #區域
   IF cl_null(r_apcb.apcb033) THEN LET r_apcb.apcb033 = " " END IF #經營方式
   IF cl_null(r_apcb.apcb034) THEN LET r_apcb.apcb034 = " " END IF #通路
   IF cl_null(r_apcb.apcb035) THEN LET r_apcb.apcb035 = " " END IF #品牌
   IF cl_null(r_apcb.apcb036) THEN LET r_apcb.apcb036 = " " END IF #客群
   IF cl_null(r_apcb.apcb051) THEN LET r_apcb.apcb051 = " " END IF #業務人員
   IF cl_null(r_apcb.apcb054) THEN LET r_apcb.apcb054 = " " END IF #帳款對象
   IF cl_null(r_apcb.apcb055) THEN LET r_apcb.apcb055 = " " END IF #收款對象
   
   RETURN r_apcb.*
END FUNCTION

################################################################################
# Descriptions...: 取自由核算项设定值
# Memo...........:
# Usage..........: CALL s_aapp131_get_accitem_free(p_prog,p_ld,p_docno,p_seq,p_apcb021,p_apcb029,p_xrcd009,p_apcb)
# Input parameter: p_prog        程序代号
#                : p_ld          账套
#                : p_docno       单号
#                : p_seq         项次
#                : p_apcb021     费用会计科目
#                : p_apcb029     应付账款科目
#                : p_xrcd009     税额科目
#                : p_apcb        自由核算项1~10
# Return code....: 
# Date & Author..: #180705-00083#1 20181010 add by 08172
# Modify.........:  
################################################################################
PUBLIC FUNCTION s_aapp131_get_accitem_free(p_prog,p_ld,p_docno,p_seq,p_apcb021,p_apcb029,p_xrcd009,p_apcb)
   DEFINE p_prog       STRING
   DEFINE p_ld         LIKE apcb_t.apcbld
   DEFINE p_docno      LIKE apcb_t.apcbdocno
   DEFINE p_seq        LIKE apcb_t.apcbseq
   DEFINE p_apcb021    LIKE apcb_t.apcb021
   DEFINE p_apcb029    LIKE apcb_t.apcb029
   DEFINE p_xrcd009    LIKE xrcd_t.xrcd009
   DEFINE p_apcb       RECORD
       apcb037         LIKE apcb_t.apcb037, 
       apcb038         LIKE apcb_t.apcb038,
       apcb039         LIKE apcb_t.apcb039, 
       apcb040         LIKE apcb_t.apcb040,
       apcb041         LIKE apcb_t.apcb041, 
       apcb042         LIKE apcb_t.apcb042,
       apcb043         LIKE apcb_t.apcb043, 
       apcb044         LIKE apcb_t.apcb044,
       apcb045         LIKE apcb_t.apcb045,     
       apcb046         LIKE apcb_t.apcb046            
                       END RECORD
   DEFINE l_field_m    RECORD
       field1          LIKE type_t.chr10, 
       field2          LIKE type_t.chr10,
       field3          LIKE type_t.chr10, 
       field4          LIKE type_t.chr10,
       field5          LIKE type_t.chr10, 
       field6          LIKE type_t.chr10,
       field7          LIKE type_t.chr10, 
       field8          LIKE type_t.chr10,
       field9          LIKE type_t.chr10,     
       field10         LIKE type_t.chr10            
                       END RECORD
                          
   #是否做自由科目核算项管理 -费用会计科目
   DEFINE l_glad017    LIKE glad_t.glad017
   DEFINE l_glad018    LIKE glad_t.glad018
   DEFINE l_glad019    LIKE glad_t.glad019
   DEFINE l_glad020    LIKE glad_t.glad020
   DEFINE l_glad021    LIKE glad_t.glad021
   DEFINE l_glad022    LIKE glad_t.glad022
   DEFINE l_glad023    LIKE glad_t.glad023
   DEFINE l_glad024    LIKE glad_t.glad024
   DEFINE l_glad025    LIKE glad_t.glad025
   DEFINE l_glad026    LIKE glad_t.glad026
   #是否做自由科目核算项管理 -应付账款科目
   DEFINE l_glad017b   LIKE glad_t.glad017
   DEFINE l_glad018b   LIKE glad_t.glad018
   DEFINE l_glad019b   LIKE glad_t.glad019
   DEFINE l_glad020b   LIKE glad_t.glad020
   DEFINE l_glad021b   LIKE glad_t.glad021
   DEFINE l_glad022b   LIKE glad_t.glad022
   DEFINE l_glad023b   LIKE glad_t.glad023
   DEFINE l_glad024b   LIKE glad_t.glad024
   DEFINE l_glad025b   LIKE glad_t.glad025
   DEFINE l_glad026b   LIKE glad_t.glad026
   #是否做自由科目核算项管理 -税额科目
   DEFINE l_glad017c   LIKE glad_t.glad017
   DEFINE l_glad018c   LIKE glad_t.glad018
   DEFINE l_glad019c   LIKE glad_t.glad019
   DEFINE l_glad020c   LIKE glad_t.glad020
   DEFINE l_glad021c   LIKE glad_t.glad021
   DEFINE l_glad022c   LIKE glad_t.glad022
   DEFINE l_glad023c   LIKE glad_t.glad023
   DEFINE l_glad024c   LIKE glad_t.glad024
   DEFINE l_glad025c   LIKE glad_t.glad025
   DEFINE l_glad026c   LIKE glad_t.glad026
   
   
   #账款科目自由核算项开启
   SELECT glad017,glad018,glad019,glad020,glad021,glad022,
          glad023,glad024,glad025,glad026
    INTO  l_glad017,l_glad018,l_glad019,l_glad020,l_glad021,l_glad022,
          l_glad023,l_glad024,l_glad025,l_glad026
    FROM  glad_t
    WHERE gladent = g_enterprise
      AND gladld = p_ld
      AND glad001 = p_apcb021
   #收入科目自由核算项开启
   SELECT glad017,glad018,glad019,glad020,glad021,glad022,
          glad023,glad024,glad025,glad026
    INTO  l_glad017b,l_glad018b,l_glad019b,l_glad020b,l_glad021b,l_glad022b,
          l_glad023b,l_glad024b,l_glad025b,l_glad026b
    FROM  glad_t
    WHERE gladent = g_enterprise
      AND gladld = p_ld
      AND glad001 = p_apcb029 
   #税额科目自由核算项开启
   SELECT glad017,glad018,glad019,glad020,glad021,glad022,
          glad023,glad024,glad025,glad026
    INTO  l_glad017c,l_glad018c,l_glad019c,l_glad020c,l_glad021c,l_glad022c,
          l_glad023c,l_glad024c,l_glad025c,l_glad026c
    FROM  glad_t
    WHERE gladent = g_enterprise
      AND gladld = p_ld
      AND glad001 = p_xrcd009      
   #自由核算項傳入科目取用順序 帳款科目 -> 收入科目 -> 税额科目
   LET l_field_m.field1 = 'apcb037'
   LET l_field_m.field2 = 'apcb038'
   LET l_field_m.field3 = 'apcb039'
   LET l_field_m.field4 = 'apcb040'
   LET l_field_m.field5 = 'apcb041'
   LET l_field_m.field6 = 'apcb042'
   LET l_field_m.field7 = 'apcb043'
   LET l_field_m.field8 = 'apcb044'
   LET l_field_m.field9 = 'apcb045'
   LET l_field_m.field10 = 'apcb046'     
   
   #1.帳款科目---------------------------------------------
   CALL s_account_item_free(p_ld,p_apcb021,p_prog,p_docno,p_seq,'',p_apcb.*,l_field_m.*)
   RETURNING p_apcb.apcb037,p_apcb.apcb038,p_apcb.apcb039,p_apcb.apcb040,p_apcb.apcb041,
             p_apcb.apcb042,p_apcb.apcb043,p_apcb.apcb044,p_apcb.apcb045,p_apcb.apcb046   
             
   #2.收入科目---------------------------------------------
   CALL s_account_item_free(p_ld,p_apcb029,p_prog,p_docno,p_seq,'',p_apcb.*,l_field_m.*)
   RETURNING p_apcb.apcb037,p_apcb.apcb038,p_apcb.apcb039,p_apcb.apcb040,p_apcb.apcb041,
             p_apcb.apcb042,p_apcb.apcb043,p_apcb.apcb044,p_apcb.apcb045,p_apcb.apcb046
   
   #2.税额科目---------------------------------------------
   CALL s_account_item_free(p_ld,p_xrcd009,p_prog,p_docno,p_seq,'',p_apcb.*,l_field_m.*)
   RETURNING p_apcb.apcb037,p_apcb.apcb038,p_apcb.apcb039,p_apcb.apcb040,p_apcb.apcb041,
             p_apcb.apcb042,p_apcb.apcb043,p_apcb.apcb044,p_apcb.apcb045,p_apcb.apcb046
   
   #自由核算项一
   IF (l_glad017 <> 'Y' OR l_glad017 IS NULL) AND (l_glad017b <> 'Y' OR l_glad017b IS NULL) AND (l_glad017c <> 'Y' OR l_glad017c IS NULL) THEN 
      LET p_apcb.apcb037 = ' '   
   END IF
   #自由核算项二
   IF (l_glad018 <> 'Y' OR l_glad018 IS NULL) AND (l_glad018b <> 'Y' OR l_glad018b IS NULL) AND (l_glad018c <> 'Y' OR l_glad018c IS NULL) THEN 
      LET p_apcb.apcb038 = ' '   
   END IF
   #自由核算项三
   IF (l_glad019 <> 'Y' OR l_glad019 IS NULL) AND (l_glad019b <> 'Y' OR l_glad019b IS NULL) AND (l_glad019c <> 'Y' OR l_glad019c IS NULL) THEN 
      LET p_apcb.apcb039 = ' '   
   END IF
   #自由核算项四
   IF (l_glad020 <> 'Y' OR l_glad020 IS NULL) AND (l_glad020b <> 'Y' OR l_glad020b IS NULL) AND (l_glad020c <> 'Y' OR l_glad020c IS NULL)THEN 
      LET p_apcb.apcb040 = ' '   
   END IF
   #自由核算项五
   IF (l_glad021 <> 'Y' OR l_glad021 IS NULL) AND (l_glad021b <> 'Y' OR l_glad021b IS NULL) AND (l_glad021c <> 'Y' OR l_glad021c IS NULL) THEN 
      LET p_apcb.apcb041 = ' '   
   END IF
   #自由核算项六
   IF (l_glad022 <> 'Y' OR l_glad022 IS NULL) AND (l_glad022b <> 'Y' OR l_glad022b IS NULL) AND (l_glad022c <> 'Y' OR l_glad022c IS NULL) THEN 
      LET p_apcb.apcb042 = ' '   
   END IF
   #自由核算项七
   IF (l_glad023 <> 'Y' OR l_glad023 IS NULL) AND (l_glad023b <> 'Y' OR l_glad023b IS NULL) AND (l_glad023c <> 'Y' OR l_glad023c IS NULL) THEN 
      LET p_apcb.apcb043 = ' '   
   END IF
   #自由核算项八
   IF (l_glad024 <> 'Y' OR l_glad024 IS NULL) AND (l_glad024b <> 'Y' OR l_glad024b IS NULL) AND (l_glad024c <> 'Y' OR l_glad024c IS NULL) THEN 
      LET p_apcb.apcb044 = ' '   
   END IF
   #自由核算项九
   IF (l_glad025 <> 'Y' OR l_glad025 IS NULL) AND (l_glad025b <> 'Y' OR l_glad025b IS NULL) AND (l_glad025c <> 'Y' OR l_glad025c IS NULL) THEN 
      LET p_apcb.apcb045 = ' '   
   END IF
   #自由核算项十
   IF (l_glad026 <> 'Y' OR l_glad026 IS NULL) AND (l_glad026b <> 'Y' OR l_glad026b IS NULL) AND (l_glad026c <> 'Y' OR l_glad026c IS NULL) THEN 
      LET p_apcb.apcb046 = ' '   
   END IF
   
   IF cl_null(p_apcb.apcb037) THEN LET p_apcb.apcb037 = " " END IF #自由核算項一
   IF cl_null(p_apcb.apcb038) THEN LET p_apcb.apcb038 = " " END IF #自由核算項二
   IF cl_null(p_apcb.apcb039) THEN LET p_apcb.apcb039 = " " END IF #自由核算項三
   IF cl_null(p_apcb.apcb040) THEN LET p_apcb.apcb040 = " " END IF #自由核算項四
   IF cl_null(p_apcb.apcb041) THEN LET p_apcb.apcb041 = " " END IF #自由核算項五
   IF cl_null(p_apcb.apcb042) THEN LET p_apcb.apcb042 = " " END IF #自由核算項六
   IF cl_null(p_apcb.apcb043) THEN LET p_apcb.apcb043 = " " END IF #自由核算項七
   IF cl_null(p_apcb.apcb044) THEN LET p_apcb.apcb044 = " " END IF #自由核算項八
   IF cl_null(p_apcb.apcb045) THEN LET p_apcb.apcb045 = " " END IF #自由核算項九
   IF cl_null(p_apcb.apcb046) THEN LET p_apcb.apcb046 = " " END IF #自由核算項十
   
   #更新核算項
   UPDATE apcb_t SET apcb037 = p_apcb.apcb037,apcb038 = p_apcb.apcb038,apcb039 = p_apcb.apcb039,
                     apcb040 = p_apcb.apcb040,apcb041 = p_apcb.apcb041,apcb042 = p_apcb.apcb042,
                     apcb043 = p_apcb.apcb043,apcb044 = p_apcb.apcb044,apcb045 = p_apcb.apcb045,
                     apcb046 = p_apcb.apcb046
    WHERE apcbent = g_enterprise 
      AND apcbld = p_ld 
      AND apcbdocno = p_docno 
      AND apcbseq = p_seq
END FUNCTION

################################################################################
# Descriptions...: 取得可沖暫估資料,取代s_aapp131_get_apcf
# Memo...........: 180821-00038#16 create
# Usage..........: s_aapp131_get_apcf2(p_ld,p_apcadocno,p_type,p_apcborga,p_apca,p_apcc)
#                  RETURNING r_flag,r_apcf.*,l_apcf_tmp
# Date & Author..: 181225 By 10554
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_get_apcf2(p_ld,p_apcadocno,p_type,p_apcborga,p_apca,p_apcc)
DEFINE p_ld          LIKE apca_t.apcald
DEFINE p_apcadocno   LIKE apca_t.apcadocno   #立帳單據
DEFINE p_type        LIKE type_t.chr1        #1:非雜項/2:雜項
DEFINE p_apcborga    LIKE apcb_t.apcborga    #组织 
DEFINE p_apca RECORD  #應付憑單單頭
       apcaent LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus LIKE apca_t.apcastus, #狀態碼
       apcald LIKE apca_t.apcald, #帳套
       apcacomp LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite LIKE apca_t.apcasite, #帳務中心
       apca001 LIKE apca_t.apca001, #帳款單性質
       apca003 LIKE apca_t.apca003, #帳務人員
       apca004 LIKE apca_t.apca004, #帳款對象編號
       apca005 LIKE apca_t.apca005, #付款對象
       apca006 LIKE apca_t.apca006, #供應商分類
       apca007 LIKE apca_t.apca007, #帳款類別
       apca008 LIKE apca_t.apca008, #付款條件編號
       apca009 LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010 LIKE apca_t.apca010, #容許票據到期日
       apca011 LIKE apca_t.apca011, #稅別
       apca012 LIKE apca_t.apca012, #稅率
       apca013 LIKE apca_t.apca013, #含稅否
       apca014 LIKE apca_t.apca014, #人員編號
       apca015 LIKE apca_t.apca015, #部門編號
       apca016 LIKE apca_t.apca016, #來源作業類型
       apca017 LIKE apca_t.apca017, #產生方式
       apca018 LIKE apca_t.apca018, #來源參考單號
       apca019 LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020 LIKE apca_t.apca020, #信用狀付款否
       apca021 LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022 LIKE apca_t.apca022, #進口報單號碼
       apca025 LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026 LIKE apca_t.apca026, #原幣未稅差異
       apca027 LIKE apca_t.apca027, #原幣稅額差異
       apca028 LIKE apca_t.apca028, #本幣未稅差異
       apca029 LIKE apca_t.apca029, #本幣幣稅額差異
       apca030 LIKE apca_t.apca030, #差異科目
       apca031 LIKE apca_t.apca031, #產生之差異折讓單號
       apca032 LIKE apca_t.apca032, #發票類型
       apca033 LIKE apca_t.apca033, #專案編號
       apca034 LIKE apca_t.apca034, #責任中心
       apca035 LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036 LIKE apca_t.apca036, #費用(借方)科目編號
       apca037 LIKE apca_t.apca037, #產生傳票否
       apca038 LIKE apca_t.apca038, #拋轉傳票號碼
       apca039 LIKE apca_t.apca039, #會計檢核附件份數
       apca040 LIKE apca_t.apca040, #留置否
       apca041 LIKE apca_t.apca041, #留置理由碼
       apca042 LIKE apca_t.apca042, #留置設定日期
       apca043 LIKE apca_t.apca043, #留置解除日期
       apca044 LIKE apca_t.apca044, #留置原幣金額
       apca045 LIKE apca_t.apca045, #留置說明
       apca046 LIKE apca_t.apca046, #關係人否
       apca047 LIKE apca_t.apca047, #多角序號
       apca048 LIKE apca_t.apca048, #集團代付/代付單號
       apca049 LIKE apca_t.apca049, #來源營運中心編號
       apca050 LIKE apca_t.apca050, #交易原始單據份數
       apca051 LIKE apca_t.apca051, #作廢理由碼
       apca052 LIKE apca_t.apca052, #列印次數
       apca053 LIKE apca_t.apca053, #備註
       apca054 LIKE apca_t.apca054, #多帳期設定
       apca055 LIKE apca_t.apca055, #繳款優惠條件
       apca056 LIKE apca_t.apca056, #會計檢核附件狀態
       apca057 LIKE apca_t.apca057, #交易對象識別碼
       apca058 LIKE apca_t.apca058, #稅別交易類型
       apca059 LIKE apca_t.apca059, #預算編號
       apca060 LIKE apca_t.apca060, #發票開立方式
       apca061 LIKE apca_t.apca061, #預開發票基準日
       apca062 LIKE apca_t.apca062, #多角性質
       apca063 LIKE apca_t.apca063, #整帳批序號
       apca064 LIKE apca_t.apca064, #訂金序次
       apca065 LIKE apca_t.apca065, #發票編號
       apca066 LIKE apca_t.apca066, #發票號碼
       apca100 LIKE apca_t.apca100, #交易原幣別
       apca101 LIKE apca_t.apca101, #原幣匯率
       apca103 LIKE apca_t.apca103, #原幣未稅金額
       apca104 LIKE apca_t.apca104, #原幣稅額
       apca106 LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107 LIKE apca_t.apca107, #原幣直接沖帳(調整)合計金額
       apca108 LIKE apca_t.apca108, #原幣應付金額
       apca113 LIKE apca_t.apca113, #本幣未稅金額
       apca114 LIKE apca_t.apca114, #本幣稅額
       apca116 LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117 LIKE apca_t.apca117, #NO USE
       apca118 LIKE apca_t.apca118, #本幣應付金額
       apca120 LIKE apca_t.apca120, #本位幣二幣別
       apca121 LIKE apca_t.apca121, #本位幣二匯率
       apca123 LIKE apca_t.apca123, #本位幣二未稅金額
       apca124 LIKE apca_t.apca124, #本位幣二稅額
       apca126 LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127 LIKE apca_t.apca127, #NO USE
       apca128 LIKE apca_t.apca128, #本位幣二應付金額
       apca130 LIKE apca_t.apca130, #本位幣三幣別
       apca131 LIKE apca_t.apca131, #本位幣三匯率
       apca133 LIKE apca_t.apca133, #本位幣三未稅金額
       apca134 LIKE apca_t.apca134, #本位幣三稅額
       apca136 LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137 LIKE apca_t.apca137, #NO USE
       apca138 LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067 LIKE apca_t.apca067, #管理品類
       apca068 LIKE apca_t.apca068, #經營方式
       apca069 LIKE apca_t.apca069, #no use
       apca070 LIKE apca_t.apca070, #no use
       apca071 LIKE apca_t.apca071, #no use
       apca072 LIKE apca_t.apca072, #no use
       apca073 LIKE apca_t.apca073  #L/C No.
END RECORD
DEFINE p_apcc RECORD  #應付多帳期檔
       apccent LIKE apcc_t.apccent, #企業編號
       apccld LIKE apcc_t.apccld, #帳套
       apcccomp LIKE apcc_t.apcccomp, #法人
       apcclegl LIKE apcc_t.apcclegl, #核算組織
       apccsite LIKE apcc_t.apccsite, #帳務中心
       apccdocno LIKE apcc_t.apccdocno, #應付帳款單號碼
       apccseq LIKE apcc_t.apccseq, #項次
       apcc001 LIKE apcc_t.apcc001, #分期帳款序
       apcc002 LIKE apcc_t.apcc002, #應付款別性質
       apcc003 LIKE apcc_t.apcc003, #應付款日
       apcc004 LIKE apcc_t.apcc004, #容許票據到期日
       apcc005 LIKE apcc_t.apcc005, #帳款起算日
       apcc006 LIKE apcc_t.apcc006, #正負值
       apcc007 LIKE apcc_t.apcc007, #原幣已請款金額
       apcc008 LIKE apcc_t.apcc008, #發票編號
       apcc009 LIKE apcc_t.apcc009, #發票號碼
       apcc010 LIKE apcc_t.apcc010, #發票日期
       apcc011 LIKE apcc_t.apcc011, #交易單據日期
       apcc012 LIKE apcc_t.apcc012, #立帳日期
       apcc013 LIKE apcc_t.apcc013, #交易認定日期
       apcc014 LIKE apcc_t.apcc014, #出入庫扣帳日期
       apcc100 LIKE apcc_t.apcc100, #交易原幣別
       apcc101 LIKE apcc_t.apcc101, #原幣匯率
       apcc102 LIKE apcc_t.apcc102, #原幣重估後匯率
       apcc103 LIKE apcc_t.apcc103, #NO USE
       apcc104 LIKE apcc_t.apcc104, #NO USE
       apcc105 LIKE apcc_t.apcc105, #NO USE
       apcc106 LIKE apcc_t.apcc106, #NO USE
       apcc107 LIKE apcc_t.apcc107, #NO USE
       apcc108 LIKE apcc_t.apcc108, #原幣應付金額
       apcc109 LIKE apcc_t.apcc109, #原幣付款沖帳金額
       apcc113 LIKE apcc_t.apcc113, #重評價調整數
       apcc114 LIKE apcc_t.apcc114, #NO USE
       apcc115 LIKE apcc_t.apcc115, #NO USE
       apcc116 LIKE apcc_t.apcc116, #NO USE
       apcc117 LIKE apcc_t.apcc117, #NO USE
       apcc118 LIKE apcc_t.apcc118, #本幣應付金額
       apcc119 LIKE apcc_t.apcc119, #本幣付款沖帳金額
       apcc120 LIKE apcc_t.apcc120, #本位幣二幣別
       apcc121 LIKE apcc_t.apcc121, #本位幣二匯率
       apcc122 LIKE apcc_t.apcc122, #本位幣二重估後匯率
       apcc123 LIKE apcc_t.apcc123, #重評價調整數
       apcc124 LIKE apcc_t.apcc124, #NO USE
       apcc125 LIKE apcc_t.apcc125, #NO USE
       apcc126 LIKE apcc_t.apcc126, #NO USE
       apcc127 LIKE apcc_t.apcc127, #NO USE
       apcc128 LIKE apcc_t.apcc128, #本位幣二應付金額
       apcc129 LIKE apcc_t.apcc129, #本位幣二付款沖帳金額
       apcc130 LIKE apcc_t.apcc130, #本位幣三幣別
       apcc131 LIKE apcc_t.apcc131, #本位幣三匯率
       apcc132 LIKE apcc_t.apcc132, #本位幣三重估後匯率
       apcc133 LIKE apcc_t.apcc133, #重評價調整數
       apcc134 LIKE apcc_t.apcc134, #NO USE
       apcc135 LIKE apcc_t.apcc135, #NO USE
       apcc136 LIKE apcc_t.apcc136, #NO USE
       apcc137 LIKE apcc_t.apcc137, #NO USE
       apcc138 LIKE apcc_t.apcc138, #本位幣三應付金額
       apcc139 LIKE apcc_t.apcc139, #本位幣三付款沖帳金額
       apccud001 LIKE apcc_t.apccud001, #自定義欄位(文字)001
       apccud002 LIKE apcc_t.apccud002, #自定義欄位(文字)002
       apccud003 LIKE apcc_t.apccud003, #自定義欄位(文字)003
       apccud004 LIKE apcc_t.apccud004, #自定義欄位(文字)004
       apccud005 LIKE apcc_t.apccud005, #自定義欄位(文字)005
       apccud006 LIKE apcc_t.apccud006, #自定義欄位(文字)006
       apccud007 LIKE apcc_t.apccud007, #自定義欄位(文字)007
       apccud008 LIKE apcc_t.apccud008, #自定義欄位(文字)008
       apccud009 LIKE apcc_t.apccud009, #自定義欄位(文字)009
       apccud010 LIKE apcc_t.apccud010, #自定義欄位(文字)010
       apccud011 LIKE apcc_t.apccud011, #自定義欄位(數字)011
       apccud012 LIKE apcc_t.apccud012, #自定義欄位(數字)012
       apccud013 LIKE apcc_t.apccud013, #自定義欄位(數字)013
       apccud014 LIKE apcc_t.apccud014, #自定義欄位(數字)014
       apccud015 LIKE apcc_t.apccud015, #自定義欄位(數字)015
       apccud016 LIKE apcc_t.apccud016, #自定義欄位(數字)016
       apccud017 LIKE apcc_t.apccud017, #自定義欄位(數字)017
       apccud018 LIKE apcc_t.apccud018, #自定義欄位(數字)018
       apccud019 LIKE apcc_t.apccud019, #自定義欄位(數字)019
       apccud020 LIKE apcc_t.apccud020, #自定義欄位(數字)020
       apccud021 LIKE apcc_t.apccud021, #自定義欄位(日期時間)021
       apccud022 LIKE apcc_t.apccud022, #自定義欄位(日期時間)022
       apccud023 LIKE apcc_t.apccud023, #自定義欄位(日期時間)023
       apccud024 LIKE apcc_t.apccud024, #自定義欄位(日期時間)024
       apccud025 LIKE apcc_t.apccud025, #自定義欄位(日期時間)025
       apccud026 LIKE apcc_t.apccud026, #自定義欄位(日期時間)026
       apccud027 LIKE apcc_t.apccud027, #自定義欄位(日期時間)027
       apccud028 LIKE apcc_t.apccud028, #自定義欄位(日期時間)028
       apccud029 LIKE apcc_t.apccud029, #自定義欄位(日期時間)029
       apccud030 LIKE apcc_t.apccud030, #自定義欄位(日期時間)030
       apcc015 LIKE apcc_t.apcc015, #付款條件
       apcc016 LIKE apcc_t.apcc016, #帳款類型
       apcc017 LIKE apcc_t.apcc017, #採購單號  #190423-00042#17 add ,
       apcc018 LIKE apcc_t.apcc018, #專案編號  #190423-00042#17 add
       apcc019 LIKE apcc_t.apcc019  #WBS編號   #190423-00042#17 add
END RECORD
DEFINE r_flag        LIKE type_t.chr1        
DEFINE r_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD

DEFINE l_sfin2011    LIKE type_t.chr1        #迴轉否
DEFINE l_sfin3011    LIKE type_t.chr1        #迴轉否  
DEFINE l_sfin3012    LIKE type_t.chr1        #含稅立帳否
DEFINE l_glaacomp    LIKE glaa_t.glaacomp    #所屬法人
DEFINE l_glaa001     LIKE glaa_t.glaa001
DEFINE l_glaa004     LIKE glaa_t.glaa004     #會計科目參照表
DEFINE l_glaa015     LIKE glaa_t.glaa015     #本位幣二啟用
DEFINE l_glaa016     LIKE glaa_t.glaa016     #本位幣二
DEFINE l_glaa017     LIKE glaa_t.glaa017     #本位幣二換算基準
DEFINE l_glaa019     LIKE glaa_t.glaa019     #本位幣三啟用
DEFINE l_glaa020     LIKE glaa_t.glaa020     #本位幣三
DEFINE l_glaa021     LIKE glaa_t.glaa021     #本位幣三換算基準
DEFINE l_glaa025     LIKE glaa_t.glaa025     #本位幣一換算基準
DEFINE l_glac007     LIKE glac_t.glac007     #科目性質

DEFINE l_apca007     LIKE apca_t.apca007
DEFINE l_apca035     LIKE apca_t.apca035
DEFINE l_apca036     LIKE apca_t.apca036
DEFINE l_apca100     LIKE apca_t.apca100     #交易幣幣別
DEFINE l_apca101     LIKE apca_t.apca101     #本幣匯率
DEFINE l_apca121     LIKE apca_t.apca121
DEFINE l_apca131     LIKE apca_t.apca131
DEFINE l_apcb001     LIKE apcb_t.apcb001     #單據性質
DEFINE l_apcb101     LIKE apcb_t.apcb101     #t320暫估單價
DEFINE l_apcc108     LIKE apcc_t.apcc108     #計算用
DEFINE l_apcf105_sum LIKE apcf_t.apcf105     #t300中本暂估单已计算到的被冲的原币总金额
DEFINE l_apcf105_b   LIKE apcf_t.apcf105     #t300中本暂估单非本t300单的被冲的原币总金额
DEFINE l_apcc118     LIKE apcc_t.apcc118     #用于赋值
DEFINE l_apcf115_sum LIKE apcf_t.apcf115     #用于赋值
DEFINE l_apcf115_b   LIKE apcf_t.apcf115     #用于赋值
DEFINE l_apcf103     LIKE apcf_t.apcf103     #計算用
DEFINE l_apcf105     LIKE apcf_t.apcf105     #計算用
DEFINE l_apcb103     LIKE apcb_t.apcb105     #計算用
DEFINE l_apcb105     LIKE apcb_t.apcb105     #計算用
DEFINE l_apcf007     LIKE apcf_t.apcf007     #320可沖帳數量
DEFINE l_apcf0071    LIKE apcf_t.apcf007     #320已沖帳數量
DEFINE l_apcf1       RECORD                  #t320已沖帳
         apcf103     LIKE apcf_t.apcf103,    #原幣未稅金額
         apcf104     LIKE apcf_t.apcf104,    #原幣稅額
         apcf105     LIKE apcf_t.apcf105,    #原幣含稅金額
         apcf113     LIKE apcf_t.apcf113,    #本幣未稅金額
         apcf114     LIKE apcf_t.apcf114,    #本幣稅額
         apcf115     LIKE apcf_t.apcf115,    #本幣含稅金額
         apcf123     LIKE apcf_t.apcf123,    #本幣二未稅金額
         apcf124     LIKE apcf_t.apcf124,    #本幣二稅額
         apcf125     LIKE apcf_t.apcf125,    #本幣二含稅金額
         apcf133     LIKE apcf_t.apcf133,    #本幣三未稅金額
         apcf134     LIKE apcf_t.apcf134,    #本幣三稅額
         apcf135     LIKE apcf_t.apcf135     #本幣三含稅金額
                 END RECORD
DEFINE l_apcf2       RECORD                  #t320立帳數量
         apcf103     LIKE apcf_t.apcf103,
         apcf104     LIKE apcf_t.apcf104,
         apcf105     LIKE apcf_t.apcf105,
         apcf113     LIKE apcf_t.apcf113,
         apcf114     LIKE apcf_t.apcf114,
         apcf115     LIKE apcf_t.apcf115,
         apcf123     LIKE apcf_t.apcf123,
         apcf124     LIKE apcf_t.apcf124,
         apcf125     LIKE apcf_t.apcf125,
         apcf133     LIKE apcf_t.apcf133,
         apcf134     LIKE apcf_t.apcf134,
         apcf135     LIKE apcf_t.apcf135              
                 END RECORD
DEFINE l_apcb002     LIKE apcb_t.apcb002     #t300此次要沖帳-入庫單號
DEFINE l_apcb003     LIKE apcb_t.apcb003     #t300此次要沖帳-入庫單項次
DEFINE l_apcb007     LIKE apcb_t.apcb007     #t300此次要沖帳-入庫單數量
DEFINE l_apcb0071    LIKE apcb_t.apcb007     
DEFINE l_apcb1       RECORD                  #t300此次要沖帳
         apcb101     LIKE apcb_t.apcb101,
         apcb103     LIKE apcb_t.apcb103,
         apcb104     LIKE apcb_t.apcb104,
         apcb105     LIKE apcb_t.apcb105,
         apcb113     LIKE apcb_t.apcb113,
         apcb114     LIKE apcb_t.apcb114,
         apcb115     LIKE apcb_t.apcb115,
         apcb123     LIKE apcb_t.apcb123,
         apcb124     LIKE apcb_t.apcb124,
         apcb125     LIKE apcb_t.apcb125,
         apcb133     LIKE apcb_t.apcb133,
         apcb134     LIKE apcb_t.apcb134,
         apcb135     LIKE apcb_t.apcb135,
         apcborga    LIKE apcb_t.apcborga,         #來源組織
         apcb010     LIKE apcb_t.apcb010,          #業務部門
         apcb011     LIKE apcb_t.apcb011,          #責任中心
         apcb024     LIKE apcb_t.apcb024,          #區域
         apcb036     LIKE apcb_t.apcb036,          #客群
         apcb004     LIKE apcb_t.apcb004,          #產品類別
         apcb051     LIKE apcb_t.apcb051,          #業務人員
         apcb015     LIKE apcb_t.apcb015,          #專案編號
         apcb016     LIKE apcb_t.apcb016,          #WBS
         apcb033     LIKE apcb_t.apcb033,          #經營方式
         apcb034     LIKE apcb_t.apcb034,          #渠道
         apcb035     LIKE apcb_t.apcb035,          #品牌
         apcb037     LIKE apcb_t.apcb037,          #自由核算項1
         apcb038     LIKE apcb_t.apcb038,          #自由核算項2
         apcb039     LIKE apcb_t.apcb039,          #自由核算項3
         apcb040     LIKE apcb_t.apcb040,          #自由核算項4
         apcb041     LIKE apcb_t.apcb041,          #自由核算項5
         apcb042     LIKE apcb_t.apcb042,          #自由核算項6
         apcb043     LIKE apcb_t.apcb043,          #自由核算項7
         apcb044     LIKE apcb_t.apcb044,          #自由核算項8
         apcb045     LIKE apcb_t.apcb045,          #自由核算項9
         apcb046     LIKE apcb_t.apcb046,          #自由核算項10
         apcb047     LIKE apcb_t.apcb047,          #摘要
         apcb021     LIKE apcb_t.apcb021,          #費用會計科目
         apcb020     LIKE apcb_t.apcb020,          #税别 
         apcb029     LIKE apcb_t.apcb029,          #應付帳款科目
         apcb012     LIKE apcb_t.apcb012
                 END RECORD
DEFINE lc_param      RECORD
         type        LIKE type_t.chr1,     #類型
         apca004     LIKE apca_t.apca004   #交易對象
                 END RECORD
DEFINE l_desc        LIKE type_t.chr500   #接沒有用到的參數用
DEFINE ls_js         STRING
DEFINE l_apcf_tmp    DYNAMIC ARRAY OF type_apcf_tmp 
DEFINE l_i,l_cnt     LIKE type_t.num5
DEFINE l_rate        LIKE apcf_t.apcf102
DEFINE l_sql         STRING
DEFINE l_sql2        STRING #190423-00042#17 add
DEFINE l_apcadocdt1  LIKE apca_t.apcadocdt   #立帳單據-立帳日期
DEFINE l_apcadocdt2  LIKE apca_t.apcadocdt   #暫估單據-立帳日期
DEFINE l_oodb004     LIKE oodb_t.oodb004
DEFINE l_oodb005     LIKE oodb_t.oodb005
DEFINE l_oodb006     LIKE oodb_t.oodb006
DEFINE l_oodb011     LIKE oodb_t.oodb011
DEFINE l_apca012     LIKE apca_t.apca012
DEFINE l_apca011     LIKE apca_t.apca011
DEFINE l_apcacomp    LIKE apca_t.apcacomp
DEFINE l_pmdt036     LIKE pmdt_t.pmdt036 
DEFINE l_no_use      LIKE apcf_t.apcf116 
DEFINE l_t320_apcb020 LIKE apcb_t.apcb020
DEFINE l_t320_apca100 LIKE apca_t.apca100
DEFINE l_t320_apca101 LIKE apca_t.apca101
DEFINE l_tax_apcf103  LIKE apcb_t.apcb103
DEFINE l_diff_apcf106 LIKE apcf_t.apcf106
DEFINE l_t320_apca012 LIKE apca_t.apca012    
DEFINE l_apcc102      LIKE apcc_t.apcc102
DEFINE l_apcc101      LIKE apcc_t.apcc101  #未考虑重评价调整
DEFINE l_apch         RECORD                 #沖暫估明細檔
         apchent      LIKE apch_t.apchent,   #企業編號
         apchcomp     LIKE apch_t.apchcomp,  #法人
         apchsite     LIKE apch_t.apchsite,  #帳務組織
         apchdocno    LIKE apch_t.apchdocno, #單據號碼
         apchseq      LIKE apch_t.apchseq,   #項次
         apch001      LIKE apch_t.apch001,   #暫估單號
         apch002      LIKE apch_t.apch002,   #暫估項次
         apch003      LIKE apch_t.apch003,   #入庫單號
         apch004      LIKE apch_t.apch004,   #入庫單項次
         apch005      LIKE apch_t.apch005,   #產品編號
         apch006      LIKE apch_t.apch006,   #沖暫估數量
         apch007      LIKE apch_t.apch007,   #原幣未稅單價
         apch008      LIKE apch_t.apch008,   #本幣未稅單價
         apch009      LIKE apch_t.apch009,   #DIFF 原幣價差金額
         apch010      LIKE apch_t.apch010,   #DIFF 本幣價差金額
         apch011      LIKE apch_t.apch011,   #DIFF 本幣匯差金額
         apch012      LIKE apch_t.apch012,   #DIFF 原幣價差單價
         apch013      LIKE apch_t.apch013,   #DIFF 本幣價差單價
         apch014      LIKE apch_t.apch014,   #DIFF 本幣匯差單價
         apchud001    LIKE apch_t.apchud001, #自定義欄位(文字)001
         apchud002    LIKE apch_t.apchud002, #自定義欄位(文字)002
         apchud003    LIKE apch_t.apchud003, #自定義欄位(文字)003
         apchud004    LIKE apch_t.apchud004, #自定義欄位(文字)004
         apchud005    LIKE apch_t.apchud005, #自定義欄位(文字)005
         apchud006    LIKE apch_t.apchud006, #自定義欄位(文字)006
         apchud007    LIKE apch_t.apchud007, #自定義欄位(文字)007
         apchud008    LIKE apch_t.apchud008, #自定義欄位(文字)008
         apchud009    LIKE apch_t.apchud009, #自定義欄位(文字)009
         apchud010    LIKE apch_t.apchud010, #自定義欄位(文字)010
         apchud011    LIKE apch_t.apchud011, #自定義欄位(數字)011
         apchud012    LIKE apch_t.apchud012, #自定義欄位(數字)012
         apchud013    LIKE apch_t.apchud013, #自定義欄位(數字)013
         apchud014    LIKE apch_t.apchud014, #自定義欄位(數字)014
         apchud015    LIKE apch_t.apchud015, #自定義欄位(數字)015
         apchud016    LIKE apch_t.apchud016, #自定義欄位(數字)016
         apchud017    LIKE apch_t.apchud017, #自定義欄位(數字)017
         apchud018    LIKE apch_t.apchud018, #自定義欄位(數字)018
         apchud019    LIKE apch_t.apchud019, #自定義欄位(數字)019
         apchud020    LIKE apch_t.apchud020, #自定義欄位(數字)020
         apchud021    LIKE apch_t.apchud021, #自定義欄位(日期時間)021
         apchud022    LIKE apch_t.apchud022, #自定義欄位(日期時間)022
         apchud023    LIKE apch_t.apchud023, #自定義欄位(日期時間)023
         apchud024    LIKE apch_t.apchud024, #自定義欄位(日期時間)024
         apchud025    LIKE apch_t.apchud025, #自定義欄位(日期時間)025
         apchud026    LIKE apch_t.apchud026, #自定義欄位(日期時間)026
         apchud027    LIKE apch_t.apchud027, #自定義欄位(日期時間)027
         apchud028    LIKE apch_t.apchud028, #自定義欄位(日期時間)028
         apchud029    LIKE apch_t.apchud029, #自定義欄位(日期時間)029
         apchud030    LIKE apch_t.apchud030, #自定義欄位(日期時間)030
         apch015      LIKE apch_t.apch015,   #DIFF 純差異原幣金額
         apch016      LIKE apch_t.apch016,   #DIFF 純差異本幣金額
         apch017      LIKE apch_t.apch017,   #原幣沖銷未稅金額
         apch018      LIKE apch_t.apch018,   #原幣沖銷稅額
         apch019      LIKE apch_t.apch019,   #原幣沖銷含稅金額
         apch020      LIKE apch_t.apch020,   #本幣沖銷未稅金額
         apch021      LIKE apch_t.apch021,   #本幣沖銷稅額
         apch022      LIKE apch_t.apch022,   #本幣沖銷含稅金額
         apch023      LIKE apch_t.apch023,   #暫估匯率
         apch024      LIKE apch_t.apch024,   #沖暫估匯率
         apch025      LIKE apch_t.apch025   #暫估帳款性質
                      END RECORD
DEFINE l_apcf3       RECORD                  #t300已沖帳
         apcf007     LIKE apcf_t.apcf007,   
         apcf103     LIKE apcf_t.apcf103,    #原幣未稅金額
         apcf104     LIKE apcf_t.apcf104,    #原幣稅額
         apcf105     LIKE apcf_t.apcf105,    #原幣含稅金額
         apcf113     LIKE apcf_t.apcf113,    #本幣未稅金額
         apcf114     LIKE apcf_t.apcf114,    #本幣稅額
         apcf115     LIKE apcf_t.apcf115,    #本幣含稅金額
         apcf123     LIKE apcf_t.apcf123,    #本幣二未稅金額
         apcf124     LIKE apcf_t.apcf124,    #本幣二稅額
         apcf125     LIKE apcf_t.apcf125,    #本幣二含稅金額
         apcf133     LIKE apcf_t.apcf133,    #本幣三未稅金額
         apcf134     LIKE apcf_t.apcf134,    #本幣三稅額
         apcf135     LIKE apcf_t.apcf135,    #本幣三含稅金額 
         apcf009     LIKE apcf_t.apcf009    
                 END RECORD
DEFINE l_tax_apcf1031  LIKE apcb_t.apcb103
DEFINE l_tax_apcf1131  LIKE apcb_t.apcb113 
DEFINE l_apcf_diff     LIKE apcf_t.apcf103
DEFINE l_apcf_diff2    LIKE apcf_t.apcf105
DEFINE l_sfin3034      LIKE type_t.chr1      #暫估期初迴轉,沖暫估時認列差異否
DEFINE l_sfin2002      LIKE type_t.chr1
#DEFINE l_sfin9025      LIKE type_t.chr1 #190423-00042#17 add #190423-00042#38 mark
DEFINE l_sfin9026      LIKE type_t.chr1 #190423-00042#38 add
DEFINE l_apcb103_do    LIKE apcb_t.apcb103
DEFINE l_apcb105_do    LIKE apcb_t.apcb105
DEFINE l_seqcnt        LIKE type_t.num5
DEFINE g_sum           LIKE type_t.num20_6  #t300整張單原幣總合
DEFINE g_sum1          LIKE type_t.num20_6  #t300整張單本幣總合
DEFINE l_sum1          LIKE type_t.num20_6  #t320整張單本幣總和
DEFINE l_diff          LIKE type_t.num20_6  #原幣相同時的t300-t320本幣差異
DEFINE l_aapt320_apcb002 LIKE apcb_t.apcb002
DEFINE l_aapt320_apcb003 LIKE apcb_t.apcb003
DEFINE l_sum2          LIKE type_t.num20_6    
DEFINE l_cnt1          LIKE type_t.num5       
DEFINE l_apcb002t      LIKE apcb_t.apcb002    
DEFINE l_apcb003t      LIKE apcb_t.apcb003 
DEFINE l_apch015       LIKE apch_t.apch015   #DIFF 純差異原幣金額
DEFINE l_apch016       LIKE apch_t.apch016   #DIFF 純差異本幣金額
DEFINE l_amount        LIKE apcb_t.apcb007   #剩餘可沖暫估量
DEFINE l_errno         LIKE gzze_t.gzze001
DEFINE l_success       LIKE type_t.num5
DEFINE l_apcb_o RECORD
       apcb103       LIKE apcb_t.apcb103, #交易原幣未稅金額
       apcb104       LIKE apcb_t.apcb104, #交易原幣稅額
       apcb105       LIKE apcb_t.apcb105, #交易原幣含稅金額
       apcb113       LIKE apcb_t.apcb113, #本幣未稅金額
       apcb114       LIKE apcb_t.apcb114, #本幣稅額
       apcb115       LIKE apcb_t.apcb115, #本幣含稅金額
       apcb020       LIKE apcb_t.apcb020, #稅別
       apca101       LIKE apca_t.apca101, #匯率
       apcb101       LIKE apcb_t.apcb101, #單價
       apcb007       LIKE apcb_t.apcb007  #數量
   END RECORD
DEFINE l_apcbseq     LIKE apcb_t.apcbseq #t300項次
DEFINE l_t320_seq    LIKE apcb_t.apcbseq #t320項次 
DEFINE l_ooaj003     LIKE ooaj_t.ooaj003
DEFINE l_num         LIKE apcf_t.apcf106 #允許誤差範圍
DEFINE l_apcf       DYNAMIC ARRAY OF RECORD  
       apcf007  LIKE apcf_t.apcf007          
       END RECORD                            
DEFINE l_pmdt046     LIKE pmdt_t.pmdt046 #180124-00045#1 add
#190402-00043#1---add---(S)
DEFINE l_sum_apch019  LIKE apch_t.apch019
DEFINE l_sum_apch022  LIKE apch_t.apch022
DEFINE l_sum_apch0191 LIKE apch_t.apch019
DEFINE l_sum_apch0221 LIKE apch_t.apch022
DEFINE l_min_apch022  LIKE apch_t.apch022
DEFINE l_apch_o      RECORD
       apch002       LIKE apch_t.apch002,
       apch011       LIKE apch_t.apch011,
       apch020       LIKE apch_t.apch020,
       apch022       LIKE apch_t.apch022
       END RECORD
DEFINE l_sum_apcf      RECORD
       apcf007       LIKE apcf_t.apcf007,
       apcf103       LIKE apcf_t.apcf103,
       apcf104       LIKE apcf_t.apcf104,
       apcf105       LIKE apcf_t.apcf105,
       apcf106       LIKE apcf_t.apcf106,
       apcf113       LIKE apcf_t.apcf113,
       apcf114       LIKE apcf_t.apcf114,
       apcf115       LIKE apcf_t.apcf115,
       apcf116       LIKE apcf_t.apcf116,
       apcf117       LIKE apcf_t.apcf117
       END RECORD
DEFINE l_apch_105    LIKE apcf_t.apcf105
DEFINE l_apch_115    LIKE apcf_t.apcf115
DEFINE l_adjust      LIKE apcf_t.apcf115 #分攤金額
DEFINE l_flag        LIKE type_t.chr1    #分攤flag
DEFINE l_diff_left   LIKE type_t.num20_6 
#190402-00043#1---add---(E)               
   #l_apca/l_apcb(現在立帳的立帳單--aapt300)
   #p_apca/p_apcb(抓出來沖的暫估單--aapt320)
   
   WHENEVER ERROR CONTINUE
   
   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa001|glaa004|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa025')
        RETURNING g_sub_success,l_glaacomp,l_glaa001,l_glaa004,
                  l_glaa015,l_glaa016,l_glaa017,l_glaa019,l_glaa020,
                  l_glaa021,l_glaa025
   
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3011') RETURNING l_sfin3011  
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3034') RETURNING l_sfin3034   
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2002') RETURNING l_sfin2002  
  #CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-9025') RETURNING l_sfin9025 #190423-00042#17 add  #190423-00042#38 mark
  #IF cl_null(l_sfin9025) THEN LET l_sfin9025='N' END IF  #190423-00042#17 add #190423-00042#38 mark
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-9026') RETURNING l_sfin9026 #190423-00042#38 add
   IF cl_null(l_sfin9026) THEN LET l_sfin9026 = 'N' END IF  #190423-00042#38 add

   SELECT apca007,apca035,apca036,apca101,apca100,
          apca121,apca131,apca012,apca011,apcacomp
     INTO l_apca007,l_apca035,l_apca036,l_apca101,l_apca100,
          l_apca121,l_apca131,l_apca012,l_apca011,l_apcacomp
     FROM apca_t
    WHERE apcaent = g_enterprise
      AND apcald = p_ld AND apcadocno= p_apcadocno 
   
   INITIALIZE r_apcf.* TO NULL
   CALL l_apcf_tmp.clear()
   CALL l_apcf.clear() 
   LET g_sum   = 0 
   LET g_sum1  = 0 
   LET l_sum1  = 0 
   LET l_diff  = 0 
   #t320本幣加總
   #LET l_sum1 = p_apcc.apcc118 + p_apcc.apcc113 #190402-00043#2 mark p_apcc.apcc118已經包含apcc113了
   LET l_sum1 = p_apcc.apcc118 #190402-00043#2 add
   
   #为了判断是不是最后一次冲的处理，防止有重评价的情况导致的小数误差
   LET l_apcc108 = 0      #暂估单的原币总金额(以整张暂估单的概念算)
   LET l_apcf105_b = 0    #该暂估单除本张立账单的其他已冲原币总金额(以整张暂估单的概念算)
   LET l_apcf105_sum = 0  #本张t300中此暂估单已计算到的被冲的原币总金额(以整张暂估单的概念算)
   LET l_apcc118 = 0
   LET l_apcf115_b = 0  
   LET l_apcf115_sum = 0
   #获取此暂估单的原币总金额
   SELECT SUM(apcc108),SUM(apcc118+apcc113) INTO l_apcc108,l_apcc118
     FROM apcc_t
    WHERE apccent = g_enterprise
      AND apccld  = p_ld AND apccdocno = p_apca.apcadocno
   IF cl_null(l_apcc108) THEN LET l_apcc108 = 0 END IF
   IF cl_null(l_apcc118) THEN LET l_apcc118 = 0 END IF
   
   #获取该暂估单除本张立账单的其他已冲原币总金额
   SELECT SUM(apcf105),SUM(apcf115) INTO l_apcf105_b,l_apcf115_b
     FROM apca_t,apcf_t
    WHERE apcaent = apcfent AND apcadocno = apcfdocno 
      AND apcastus NOT IN ('X')
      AND apcaent = g_enterprise
      AND apcald  = p_ld AND apcf008 = p_apca.apcadocno
      AND apcfdocno != p_apcadocno
   IF cl_null(l_apcf105_b) THEN LET l_apcf105_b = 0 END IF
   IF cl_null(l_apcf115_b) THEN LET l_apcf115_b = 0 END IF
   #小数误差调整
   
   #檢查t300是否沖完暫估(若立帳單沖完以後 就表示不用沖暫估了)
   LET l_apcb103 = NULL
   LET l_apcb105 = NULL
   LET l_apcf103 = NULL
   LET l_apcf105 = NULL
   #非雜項看t320的 apcb立了幾個沖暫估
   LET l_cnt = 0
   IF p_type = '1' THEN  #非雜項
      LET l_sql = " SELECT SUM(apcb007) ",
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno  ",
                  "    AND apcastus NOT IN ('X','Y')  ",
                  "    AND apcaent = ",g_enterprise," ",
                  "    AND apcald  = ? AND apcbdocno <> ? ",
                  "    AND apcb002 = ? AND apcb003 = ? ",
                  "    AND apcb023 = 'Y'  "
   ELSE
      LET l_sql = " SELECT SUM(apcb007) ",
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno  ",
                  "    AND apcastus <> 'X'  ",
                  "    AND apcaent = ",g_enterprise," ",
                  "    AND apcald  = ? AND apcbdocno <> ? ",
                  "    AND apcb002 = ? AND apcb003 = ? ",
                  "    AND apcb023 = 'Y'  "
   END IF
   PREPARE s_aapp131_apcb0072p FROM l_sql 
   #取t320的資料      
   IF p_type = '1' THEN  #非雜項 抓來源單號/項次/數量
      LET l_sql = "SELECT apcb002,apcb003,apcb007 ",
                "    FROM apca_t,apcb_t",
                "   WHERE apcaent = apcbent AND apcadocno = apcbdocno ",
                "     AND apca001 IN ('01','02') ",
                "     AND apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                "     AND apcbdocno = '",p_apca.apcadocno,"' ",
                "     AND apcb001 IN ('11','20','21') ",
                "     AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL "
   ELSE    #雜項 抓暫估單號/項次/數量
      LET l_sql = "SELECT apcbdocno,apcbseq,apcb007 ", 
                "    FROM apca_t,apcb_t",
                "   WHERE apcaent = apcbent AND apcadocno = apcbdocno ",
                "     AND apca001 IN ('03','04') ",
                "     AND apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                "     AND apcbdocno = '",p_apca.apcadocno,"' ",
                "     AND apcb001 IN ('19','29') "
   END IF
   PREPARE s_aapp131_get_apcf_p2 FROM l_sql
   DECLARE s_aapp131_get_apcf_c2 CURSOR FOR s_aapp131_get_apcf_p2
   FOREACH s_aapp131_get_apcf_c2 INTO l_apcb002,l_apcb003,l_apcb007
      #計算已沖 暫估數量(不含本張單沖銷的數量)   
      LET l_apcb0071 = 0
      EXECUTE s_aapp131_apcb0072p USING p_ld,p_apcadocno,l_apcb002,l_apcb003 INTO l_apcb0071 
      IF cl_null(l_apcb007)  THEN LET l_apcb007 = 0 END IF
      IF cl_null(l_apcb0071) THEN LET l_apcb0071= 0 END IF
      IF l_apcb007 - l_apcb0071 <> 0 THEN
         LET l_cnt = 1
         EXIT FOREACH
      END IF
   END FOREACH
   IF l_cnt = 0 THEN          #表示這一張暫估單已經沖完了/要抓下一筆t320繼續沖
      LET r_flag = 1          #CONTINUE FOREACH
      IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
      IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
      IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
      IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
      IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
      IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
      IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
      IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
      IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
      IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
      IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
      IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
      IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
      IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
      IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
      IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
      IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
      IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
      IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
      IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
      IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
      IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
      IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十      
      RETURN r_flag,r_apcf.*,l_apcf_tmp
   END IF  
   LET r_apcf.apcf029 = p_apca.apca005       #交易客商
   LET r_apcf.apcf030 = p_apca.apca004       #帳款客商
   
   LET r_apcf.apcf101 = ''                   #NO USE
   LET r_apcf.apcf102 = p_apca.apca101       #本幣一匯率
   LET r_apcf.apcf111 = ''                   #NO USE
   LET r_apcf.apcf122 = p_apca.apca121       #本幣二匯率
   LET r_apcf.apcf132 = p_apca.apca131       #本幣三匯率
   
   #原取暫估單的立帳匯率,改取重評後匯率apcc102
   LET l_apcc102 = ''
   SELECT apcc101,apcc102 INTO l_apcc101,l_apcc102 FROM apcc_t
    WHERE apccent = g_enterprise AND apccld  = p_ld AND apccdocno = p_apca.apcadocno
      AND apccseq = p_apcc.apccseq AND apcc001 = p_apcc.apcc001        
   LET r_apcf.apcf102 = l_apcc102   
   
   LET l_cnt = 0
   LET l_sum2 = 0 #记录同一个单号里这个入库单同一个项次 每次得数据
   #已沖暫估數改抓apch_t
   LET l_sql = " SELECT SUM(apch006), ",
               "        SUM(apch017),SUM(apch018),SUM(apch019),SUM(apch020),SUM(apch021),SUM(apch022), ",
               "        0,0,0,0,0,0 ",
               "   FROM apch_t ",
               "  WHERE apchent = ",g_enterprise,
               "    AND apchcomp = ?  ",        
               "    AND apchdocno <> ?  ",
               "    AND apch001 = ? AND apch002 = ? "
   PREPARE s_aapp131_get_apcf1p2 FROM l_sql     
   
   IF p_type = '1' THEN #非雜項
      LET l_sql = " SELECT apcb001,apcb007,apcb101,apcb103,apcb104,apcb105,apcb113, ",
                  "        apcb114,apcb115,apcb123,apcb124,apcb125,apcb133, ",
                  "        apcb134,apcb135,apcb020,apca100,apca101,apcb107  ",                    
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
                  "    AND apcbent = ",g_enterprise,"   ",
                  "    AND apcbld = ? AND apcbdocno = ? ",
                  "    AND apcb002= ? AND apcb003 = ?   "
   ELSE   #雜項
      LET l_sql = " SELECT apcb001,apcb007,apcb101,apcb103,apcb104,apcb105,apcb113, ",
                  "        apcb114,apcb115,apcb123,apcb124,apcb125,apcb133, ",
                  "        apcb134,apcb135,apcb020,apca100,apca101,apcb101  ", #雜項的pmdt036要抓aapt320的單價     
                  "   FROM apca_t,apcb_t ",
                  "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
                  "    AND apcbent = ",g_enterprise,"   ",
                  "    AND apcbld = ? AND apcbdocno = ? ",
                  "    AND apcbseq= ? "
   END IF
   PREPARE s_aapp131_get_apcf320p2 FROM l_sql 
   #抓t300有沖過的單(以整張單的角度去抓數字)
   LET l_sql = "  SELECT SUM(apcf007), ",
               "         SUM(apcf103),SUM(apcf104),SUM(apcf105),SUM(apcf113),SUM(apcf114),SUM(apcf115),", 
               "         SUM(apcf123),SUM(apcf124),SUM(apcf125),SUM(apcf133),SUM(apcf134),SUM(apcf135),",
               "         apcf009 ",
               "    FROM apcf_t",
               "   WHERE apcfent = ",g_enterprise," AND apcfld  = ? AND apcfdocno <> ?  ",
               "     AND apcf008 = ? ",        
               "     AND apcfdocno NOT IN (SELECT apcadocno FROM apca_t WHERE apcaent= ",g_enterprise,
               "     AND apcald= ? ",
               "     AND apcastus = 'X')",
               "   GROUP BY apcf009"     
   PREPARE s_aapp131_get_apcf3p2 FROM l_sql
   EXECUTE s_aapp131_get_apcf3p2 USING p_ld,p_apcadocno,p_apca.apcadocno,p_ld INTO l_apcf3.*  
   IF cl_null(l_apcf3.apcf103) THEN LET l_apcf3.apcf103 = 0 END IF
   IF cl_null(l_apcf3.apcf104) THEN LET l_apcf3.apcf104 = 0 END IF
   IF cl_null(l_apcf3.apcf105) THEN LET l_apcf3.apcf105 = 0 END IF
   IF cl_null(l_apcf3.apcf113) THEN LET l_apcf3.apcf113 = 0 END IF
   IF cl_null(l_apcf3.apcf114) THEN LET l_apcf3.apcf114 = 0 END IF
   IF cl_null(l_apcf3.apcf115) THEN LET l_apcf3.apcf115 = 0 END IF
   IF cl_null(l_apcf3.apcf123) THEN LET l_apcf3.apcf123 = 0 END IF
   IF cl_null(l_apcf3.apcf124) THEN LET l_apcf3.apcf124 = 0 END IF
   IF cl_null(l_apcf3.apcf125) THEN LET l_apcf3.apcf125 = 0 END IF
   IF cl_null(l_apcf3.apcf133) THEN LET l_apcf3.apcf133 = 0 END IF
   IF cl_null(l_apcf3.apcf134) THEN LET l_apcf3.apcf134 = 0 END IF
   IF cl_null(l_apcf3.apcf135) THEN LET l_apcf3.apcf135 = 0 END IF
   IF p_type = '1' THEN
      LET l_sql = "SELECT apcbseq,apcb002,apcb003,apcb007,",
                  "       apcb101,",
                  "       apcb103,apcb104,apcb105,apcb113,apcb114,apcb115,",
                  "       apcb123,apcb124,apcb125,apcb133,apcb134,apcb135,",
                  "       apcborga,",
                  "       apcb010,apcb011,apcb024,apcb036,apcb004,",
                  "       apcb051,apcb015,apcb016,apcb033,apcb034,",
                  "       apcb035,apcb037,apcb038,apcb039,apcb040,",
                  "       apcb041,apcb042,apcb043,apcb044,apcb045,",
                  "       apcb046,apcb047,apcb021,apcb020,apcb029,apcb012 ",        
                  "  FROM apcb_t",
                  " WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                  "   AND apcbdocno = '",p_apcadocno,"' ",
                  "   AND apcborga = '",p_apcborga,"' ",   
                  "   AND apcb001 IN ('1','2','11','20','21') ",
                  "   AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL ",
                  "   AND apcb023 = 'Y' "
   ELSE  #雜項沖暫估的來源單號apcb002/apcb003是暫估單號/項次 
      LET l_sql = "SELECT apcbseq,apcb002,apcb003,apcb007,",
                  "       apcb101,",
                  "       apcb103,apcb104,apcb105,apcb113,apcb114,apcb115,",
                  "       apcb123,apcb124,apcb125,apcb133,apcb134,apcb135,",
                  "       apcborga,",
                  "       apcb010,apcb011,apcb024,apcb036,apcb004,",
                  "       apcb051,apcb015,apcb016,apcb033,apcb034,",
                  "       apcb035,apcb037,apcb038,apcb039,apcb040,",
                  "       apcb041,apcb042,apcb043,apcb044,apcb045,",
                  "       apcb046,apcb047,apcb021,apcb020,apcb029,apcb012 ",        
                  "  FROM apcb_t",
                  " WHERE apcbent = ",g_enterprise," AND apcbld = '",p_ld,"'",
                  "   AND apcbdocno = '",p_apcadocno,"' ",
                  "   AND apcborga = '",p_apcborga,"' ",   
                  "   AND apcb001 IN ('19','29') ",
                  "   AND apcb002 IS NOT NULL AND apcb003 IS NOT NULL ",
                  "   AND apcb023 = 'Y' "
           LET l_sql = l_sql,"  AND apcb002 = '",p_apcc.apccdocno,"'  "#190214-00031#1 add
   END IF           
   #190423-00042#17 add ---s
   #IF l_sfin2002 MATCHES '[12]' AND l_sfin9025 = 'Y' THEN #190423-00042#38 mark
   IF l_sfin2002 MATCHES '[12]' AND l_sfin9026 = 'Y' THEN  #190423-00042#38 add
      IF p_apcc.apcc018 IS NOT NULL THEN
         LET l_sql = l_sql," AND apcb015 = '",p_apcc.apcc018,"' "
      ELSE 
         LET l_sql = l_sql," AND apcb015 IS NULL "
      END IF
      IF p_apcc.apcc019 IS NOT NULL THEN
         LET l_sql = l_sql," AND apcb016 = '",p_apcc.apcc019,"' "
      ELSE 
         LET l_sql = l_sql," AND apcb016 IS NULL "
      END IF
   END IF
   #190423-00042#17 add ---e   
   #因多賬期參數3時,暫估單展到項次,因此不能做匯總產生應以單筆項次去計算
   IF l_sfin2002 = '3' THEN
      #如果参数冲到明细的话，aapt320暂估单的单身和多账期是一一对应的
      #所以要先根据传参进来的暂估单p_apcc.*找到对应那一笔的暂估单单身中的入库单+项次
      #然后下面才可以根据这个入库单+项次去aapt300账款单身找出哪些账款单身是关联冲这个暂估单多账期的
      #step1:抓出暂估apcc对应的暂估单单身入库单+项次
      IF p_type = '1' THEN #非雜項才有入庫單可抓
         SELECT DISTINCT apcb002,apcb003 INTO l_aapt320_apcb002,l_aapt320_apcb003
           FROM apcb_t
          WHERE apcbent   = g_enterprise
            AND apcbld    = p_ld
            AND apcbdocno = p_apcc.apccdocno
            AND apcbseq   = p_apcc.apccseq
      
         #step2:关联到主sql中，找到对应的入库单+项次，应该只有一笔才对
         LET l_sql = l_sql,"  AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' "
      ELSE
         # LET l_sql = l_sql,"  AND apcb002 = '",p_apcc.apccdocno,"'  AND apcb003 = '",p_apcc.apccseq,"' " #190214-00031#1 add 
          LET l_sql = l_sql,"   AND apcb003 = '",p_apcc.apccseq,"' "                                       #190214-00031#1 add          
      END IF      
   END IF    
   LET l_sql = l_sql,"  ORDER BY apcb002,apcb003 "    
   PREPARE s_aapp131_get_t300apcb_p2 FROM l_sql
   DECLARE s_aapp131_get_t300apcb_c2 CURSOR FOR s_aapp131_get_t300apcb_p2
   
   #190124-00045#1---add---(S)
   #LET l_sql = "SELECT COUNT(1) FROM (",l_sql,") tsed" #如果沒有資料就不寫入apcf_t所以要給flag=1   #PGS(D)-00824 mark
   LET l_sql = "SELECT COUNT(1) FROM (",l_sql,") t51 " #如果沒有資料就不寫入apcf_t所以要給flag=1   #PGS(D)-00824
   PREPARE s_aapp131_get_cnt FROM l_sql
   LET l_cnt = 0 
   EXECUTE s_aapp131_get_cnt INTO l_cnt
   IF l_cnt = 0 THEN 
      LET r_flag = 1
   END IF   
   LET l_cnt = 0  #下面FOREACH裡面要用所以要歸0 
   #190124-00045#1---add---(E)
   
   FOREACH s_aapp131_get_t300apcb_c2 INTO l_apcbseq,l_apcb002,l_apcb003,l_apcb007,l_apcb1.*  #t300中本次冲暂估的明细信息
      LET l_apcf007 = 0 
      LET l_apcf0071= 0
      #t300計算已沖暫估數量(不含本張單沖銷的)l_apcf0071
      INITIALIZE l_apcf1.* TO NULL
      LET l_apcf0071 = ''
      EXECUTE s_aapp131_get_apcf1p2 USING l_apcacomp,p_apcadocno,l_apcb002,l_apcb003 #改抓apch_t作為已沖暫估數
         INTO l_apcf0071,l_apcf1.*             
      LET l_t320_apcb020 = ''
      LET l_t320_apca100 = ''
      LET l_t320_apca101 = ''
      LET l_pmdt036 = 0        #非雜項:入庫單單價 #雜項:暫估單單價
         
      #t320立暫估數量l_apcf007
      LET l_apcf007 = ''
      LET l_apcb101 = ''
      INITIALIZE l_apcf2.* TO NULL
      IF p_type = '1' THEN
         EXECUTE s_aapp131_get_apcf320p2 USING p_ld,p_apca.apcadocno,l_apcb002,l_apcb003
            INTO l_apcb001,l_apcf007,l_apcb101,l_apcf2.*,  #t320立暫估數量，交易原币单价，t320冲暂估单身的明细金额（满足与冲暂估单上相同来源业务单据号码的）
                 l_t320_apcb020,l_t320_apca100,l_t320_apca101,l_pmdt036
      ELSE
         EXECUTE s_aapp131_get_apcf320p2 USING p_ld,l_apcb002,l_apcb003
            INTO l_apcb001,l_apcf007,l_apcb101,l_apcf2.*,  
                 l_t320_apcb020,l_t320_apca100,l_t320_apca101,l_pmdt036
      END IF
      #入庫單價
      IF cl_null(l_pmdt036) THEN LET l_pmdt036 = 0 END IF
      IF p_apca.apca001 MATCHES '0[12]' AND l_pmdt036 = 0 THEN
         SELECT pmdt036 INTO l_pmdt036 FROM pmdt_t
          WHERE pmdtent = g_enterprise
            AND pmdtdocno = l_apcb002
            AND pmdtseq = l_apcb003
         IF cl_null(l_pmdt036) THEN LET l_pmdt036 = 0 END IF
      END IF
      #180124-00045#1---add---(S)
      IF p_apca.apca001 MATCHES '0[12]' THEN #有來源單要抓入庫單稅別
         SELECT pmdt046 INTO l_pmdt046 FROM pmdt_t
          WHERE pmdtent = g_enterprise
            AND pmdtdocno = l_apcb002
            AND pmdtseq = l_apcb003
      END IF
      #180124-00045#1---add---(E)
      
   
      IF cl_null(l_apcb007) THEN LET l_apcb007 = 0 END IF
      IF cl_null(l_apcf007) THEN LET l_apcf007 = 0 END IF
      IF cl_null(l_apcf0071)THEN LET l_apcf0071= 0 END IF
      IF cl_null(l_apcf1.apcf103) THEN LET l_apcf1.apcf103 = 0 END IF      IF cl_null(l_apcf1.apcf113) THEN LET l_apcf1.apcf113 = 0 END IF
      IF cl_null(l_apcf1.apcf104) THEN LET l_apcf1.apcf104 = 0 END IF      IF cl_null(l_apcf1.apcf114) THEN LET l_apcf1.apcf114 = 0 END IF
      IF cl_null(l_apcf1.apcf105) THEN LET l_apcf1.apcf105 = 0 END IF      IF cl_null(l_apcf1.apcf115) THEN LET l_apcf1.apcf115 = 0 END IF
      IF cl_null(l_apcf2.apcf103) THEN LET l_apcf2.apcf103 = 0 END IF      IF cl_null(l_apcf2.apcf113) THEN LET l_apcf2.apcf113 = 0 END IF
      IF cl_null(l_apcf2.apcf104) THEN LET l_apcf2.apcf104 = 0 END IF      IF cl_null(l_apcf2.apcf114) THEN LET l_apcf2.apcf114 = 0 END IF
      IF cl_null(l_apcf2.apcf105) THEN LET l_apcf2.apcf105 = 0 END IF      IF cl_null(l_apcf2.apcf115) THEN LET l_apcf2.apcf115 = 0 END IF
      IF l_apcf007 = l_apcf0071 THEN CONTINUE FOREACH END IF              #立暂估数量与已冲暂估数量相等，即代表已冲完，没必要再冲暂估
      IF l_apcf007 = 0 THEN CONTINUE FOREACH END IF                       #立暂估数量为0没必要冲暂估
      IF cl_null(r_apcf.apcforga)THEN LET r_apcf.apcforga= l_apcb1.apcborga END IF      #來源組織
      IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = l_apcb1.apcb010 END IF       #業務部門
      IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = l_apcb1.apcb011 END IF       #責任中心
      IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = l_apcb1.apcb024 END IF       #區域
      IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = l_apcb1.apcb036 END IF       #客群
      IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = l_apcb1.apcb012 END IF       #產品類別 
      IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = l_apcb1.apcb051 END IF       #業務人員
      IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = l_apcb1.apcb015 END IF       #專案編號
      IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = l_apcb1.apcb016 END IF       #WBS
      IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = l_apcb1.apcb033 END IF       #經營方式
      IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = l_apcb1.apcb034 END IF       #渠道
      IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = l_apcb1.apcb035 END IF       #品牌
      IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = l_apcb1.apcb037 END IF       #自由核算項1
      IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = l_apcb1.apcb038 END IF       #自由核算項2
      IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = l_apcb1.apcb039 END IF       #自由核算項3
      IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = l_apcb1.apcb040 END IF       #自由核算項4
      IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = l_apcb1.apcb041 END IF       #自由核算項5
      IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = l_apcb1.apcb042 END IF       #自由核算項6
      IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = l_apcb1.apcb043 END IF       #自由核算項7
      IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = l_apcb1.apcb044 END IF       #自由核算項8
      IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = l_apcb1.apcb045 END IF       #自由核算項9
      IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = l_apcb1.apcb046 END IF       #自由核算項10
      IF cl_null(r_apcf.apcf049) THEN LET r_apcf.apcf049 = l_apcb1.apcb047 END IF       #摘要
      IF cl_null(r_apcf.apcf022) THEN LET r_apcf.apcf022 = l_apcb1.apcb021 END IF       #費用會計科目
   
      #沖暫估訊息金額為: aapt300數量 * aapt320單價, 依aapt320 含稅否, 若Y 則表示含稅金額, 用aapt320的稅別推出未稅及稅額
      LET l_oodb004 = ''
      LET l_oodb005 = ''
      LET l_oodb006 = ''
      LET l_oodb011 = ''
      IF p_apca.apca001 MATCHES '0[34]' THEN #雜項要抓t320的稅別
         CALL s_tax_chk(l_apcacomp,l_t320_apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
      ELSE
         #CALL s_tax_chk(l_apcacomp,l_apcb1.apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011   #190516-00015#1 mark
         CALL s_tax_chk(l_apcacomp,l_pmdt046) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011   #190516-00015#1 add         
      END IF
      CASE
          WHEN l_sfin3012 ='1'    #1:立帳不含稅
               LET l_cnt = l_cnt +1 
               #立帳不含稅(參數為 立帳不含稅 且 含稅稅別,則用入庫單單價與t300帳款單稅率 推出 未稅單價)    
               #若來源單單價含稅則需要換算為不含稅的單價
               IF l_oodb005 = 'Y' THEN  
                  LET l_apcb101 = l_pmdt036 / (1 + l_oodb006/100)
                  IF cl_null(l_apcb101) THEN LET l_apcb101 = 0 END IF
                  CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_apcb101,1) RETURNING g_sub_success,g_errno,l_apcb101
               END IF
               
               #(t320立暫估數-t300不含本張沖暫估數) > t300這次要沖的暫估數
               IF (l_apcf007 - l_apcf0071) >  l_apcb007 THEN
                  LET l_apcf007 = l_apcb007  #計算匯差價差要以沖暫估數量
                  LET l_tax_apcf103 = 0
                  LET l_tax_apcf103 = l_apcb101 * l_apcb007 #計稅基礎 (t320交易原幣單價 * t300沖暫估數量)
                  
                  #判断这个入库单同一个项次是否是分多笔录入
                  LET l_cnt1 = 0
                  
                  SELECT count(1) INTO l_cnt1 FROM apcb_t
                   WHERE apcbent = g_enterprise
                     AND apcbld = p_ld
                     AND apcbdocno = p_apcadocno
                     AND apcb002 = l_apcb002
                     AND apcb003 = l_apcb003
                  
                  IF l_cnt1 > 1 THEN #l_cnt 大于 1 说明同一个单号里这个入库单同一个项次 他分两笔立账了
                     IF (not cl_null(l_apcb002t) AND NOT cl_null(l_apcb003t) ) AND (l_apcb002t = l_apcb002 AND l_apcb003t = l_apcb003) THEN
                        #因为同一个项次得入库单分多个项次立账导致这边得金额会比暂估单得大
                        IF (p_apcc.apcc108 - l_sum2) < l_tax_apcf103 THEN
                           LET l_tax_apcf103 = p_apcc.apcc108 - l_sum2
                        END IF
                     ELSE
                        LET l_sum2 = 0  #假如A入库单循环后循环到B入库单，需要将l_sum2重新合计
                     END IF
                     LET l_sum2 = l_tax_apcf103 + l_sum2
                     LET l_apcb002t = l_apcb002              #记录本次循环单号，让下一次循环比较
                     LET l_apcb003t = l_apcb003              #记录本次循环单号项次，让下一次循环比较 
                  END IF 
                  
                  CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_tax_apcf103,2) RETURNING g_sub_success,g_errno,l_tax_apcf103 
                  LET l_apcf_tmp[l_cnt].apcf103 = l_tax_apcf103
                  LET l_apcf_tmp[l_cnt].apcf104 = 0
                  LET l_apcf_tmp[l_cnt].apcf105 = l_tax_apcf103
                  LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  #小数误差调整
                  #本幣要等於原幣*原立暫估匯率
                  LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102    
                  LET l_apcf_tmp[l_cnt].apcf114 = 0
                  LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102       
                  LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  #小数误差调整
               ELSE
                  LET l_apcf007 = l_apcf007 - l_apcf0071   #暂估单上剩余待冲暂估数
                  #代表這個入庫單+項次是最後一次沖
                  IF l_apcf0071 > 0 THEN  #t300不含本張沖暫估數
                     #有分次沖,所以要沖剩餘可沖金額,且因為aapt300單身入庫單+項次的單價不一定與aapt320入庫單+項次的單價一樣,所以已沖暫估數要另外計算                        
                     LET l_tax_apcf1031 = l_apcb101 * l_apcf0071 #計稅基礎 (t320交易原幣單價 * t300已沖暫估數量)
                     CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_tax_apcf1031,2) RETURNING g_sub_success,g_errno,l_tax_apcf1031
                     LET l_tax_apcf1131 = l_tax_apcf1031 * l_apcc102
                     LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_tax_apcf1031    #(立暫估數-已沖暫估數)
                     #再檢查有沒有超沖
                     IF (l_tax_apcf1031 + l_apcf_tmp[l_cnt].apcf103) != l_apcf2.apcf103 THEN                    
                        LET l_apcf_diff = l_apcf2.apcf103 - (l_tax_apcf1031 + l_apcf_tmp[l_cnt].apcf103)    
                        LET l_apcf_tmp[l_cnt].apcf103 = l_apcf_tmp[l_cnt].apcf103 + l_apcf_diff
                     END IF
                     LET l_apcf_tmp[l_cnt].apcf104 = 0
                     LET l_apcf_tmp[l_cnt].apcf105 = l_apcf_tmp[l_cnt].apcf103
                     LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  # 小数误差调整
                     
                     LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102 
                     IF (l_tax_apcf1131 + l_apcf_tmp[l_cnt].apcf113) != l_apcf2.apcf113 THEN                    
                        LET l_apcf_diff2 = l_apcf2.apcf113 - ( l_tax_apcf1131 + l_apcf_tmp[l_cnt].apcf113)  
                        LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf113 + l_apcf_diff2
                     END IF
                     LET l_apcf_tmp[l_cnt].apcf114 = 0
                     LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf113
                     LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  #小数误差调整
                     
                  ELSE
                     #表示第一次沖,也是最後一次沖
                     LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103   
                     LET l_apcf_tmp[l_cnt].apcf104 = 0
                     LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf103
                     LET l_apcf105_sum = l_apcf105_sum + l_apcf_tmp[l_cnt].apcf105  #小数误差调整
                     
                     #小数误差调整
                     #     最后一次冲的话，考虑下重评价的情况，可能有小数误差（apcc与apcb不一一对应的情况下）
                     #     因此这边再拿原币总金额判断下，若平了，本币金额也直接平
                     #为节省效能，在前面先获取以下资料
                     #           暂估单的原币总金额l_apcc108
                     #           暂估单除本张立账单的其他已冲原币总金额l_apcf105_b
                     #其他立账单冲暂估的原币总金额+本立账单冲暂估的原币总金额 = 立暂估的原币总金额 ，即冲完
                     IF l_apcf105_b + l_apcf105_sum = l_apcc108 THEN
                        LET l_apcf_tmp[l_cnt].apcf113 = l_apcc118 - l_apcf115_b - l_apcf115_sum
                        LET l_apcf_tmp[l_cnt].apcf114 = 0
                        LET l_apcf_tmp[l_cnt].apcf115 = l_apcc118 - l_apcf115_b - l_apcf115_sum
                     ELSE
                     #小数误差调整
                        IF l_apcc101 = l_apcc102 THEN  #未考虑重评价调整
                           LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf113
                           LET l_apcf_tmp[l_cnt].apcf114 = 0
                           LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf113
                        #未考虑重评价调整
                        ELSE
                           LET l_apcf_tmp[l_cnt].apcf113 = l_apcf2.apcf103*l_apcc102
                           LET l_apcf_tmp[l_cnt].apcf114 = 0
                           LET l_apcf_tmp[l_cnt].apcf115 = l_apcf2.apcf103*l_apcc102
                        END IF
                        #未考虑重评价调整
                        LET l_apcf115_sum = l_apcf115_sum + l_apcf_tmp[l_cnt].apcf115  #小数误差调整
                     END IF #for 小数误差调整
                     
                  END IF
               END IF
               
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
               CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115 

          WHEN l_sfin3012 ='2'    #2:立帳含稅
               LET l_cnt = l_cnt +1 
               
               LET l_tax_apcf103 = 0
               LET l_tax_apcf103  = l_apcb101 * l_apcb007 #計稅基礎 (t320交易原幣單價 * t300沖暫估數量)
               CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_tax_apcf103,2) RETURNING g_sub_success,g_errno,l_tax_apcf103 
      
               #(t320立暫估數-t300不含本張沖暫估數) > t300這次要沖的暫估數
               IF (l_apcf007 - l_apcf0071) >  l_apcb007 THEN
                  LET l_apcf007 = l_apcb007  #計算匯差價差要以沖暫估數量
                  #l_glaacomp營運據點/p_oodb002稅別/p_money計稅基礎/p_num數量/p_curr幣別/p_rate匯率
                  CALL s_tax_count(l_glaacomp,l_t320_apcb020,l_tax_apcf103,l_apcf007,l_t320_apca100,l_apcc102)     
                       RETURNING l_apcf_tmp[l_cnt].apcf103,l_apcf_tmp[l_cnt].apcf104,l_apcf_tmp[l_cnt].apcf105,
                                 l_apcf_tmp[l_cnt].apcf113,l_apcf_tmp[l_cnt].apcf114,l_apcf_tmp[l_cnt].apcf115
               ELSE
                  #最後一次
                  LET l_apcf007 = l_apcf007 - l_apcf0071
                  LET l_apcf_tmp[l_cnt].apcf103 = l_apcf2.apcf103 - l_apcf1.apcf103   #(立暫估數-沖暫估數)
                  LET l_apcf_tmp[l_cnt].apcf104 = l_apcf2.apcf104 - l_apcf1.apcf104
                  LET l_apcf_tmp[l_cnt].apcf105 = l_apcf2.apcf105 - l_apcf1.apcf105
                  LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf103 * l_apcc102
                  LET l_apcf_tmp[l_cnt].apcf114 = l_apcf_tmp[l_cnt].apcf104 * l_apcc102
                  LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf105 * l_apcc102
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf113,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf113
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf114,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf114
                  CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf115,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf115                                       
               END IF
      END CASE      
      LET l_apcf[l_cnt].apcf007 = l_apcf007
           
      #判斷是否為最後一筆 aapt320立暫估量-aapt3*已沖暫估量(apch_t)
      #暫估項次
      IF p_type = '1' THEN #非雜項
         SELECT apcbseq INTO l_t320_seq FROM apcb_t  
          WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno 
            AND apcb002 = l_apcb002 AND apcb003 = l_apcb003
      ELSE #雜項
         LET l_t320_seq = l_apcb003
      END IF      
      CALL s_aapt300_estimate_get(p_ld,p_apcadocno,l_apcbseq,p_apca.apcadocno,l_t320_seq,'3') RETURNING l_amount
      
      #若為最後一筆要做尾差處理
      IF l_apcb007 = l_amount THEN
         INITIALIZE l_apcb_o.* TO NULL
         LET l_apcb_o.apcb103 = l_apcf_tmp[l_cnt].apcf103
         LET l_apcb_o.apcb104 = l_apcf_tmp[l_cnt].apcf104
         LET l_apcb_o.apcb105 = l_apcf_tmp[l_cnt].apcf105
         LET l_apcb_o.apcb113 = l_apcf_tmp[l_cnt].apcf113 
         LET l_apcb_o.apcb114 = l_apcf_tmp[l_cnt].apcf114
         LET l_apcb_o.apcb115 = l_apcf_tmp[l_cnt].apcf115
         LET l_apcb_o.apcb020 = l_apcb1.apcb020
         LET l_apcb_o.apca101 = p_apca.apca101
         LET l_apcb_o.apcb101 = l_apcb1.apcb101 #t300單身單價
         LET l_apcb_o.apcb007 = l_apcb007
         LET ls_js = util.JSON.stringify(l_apcb_o)
         CALL s_aapt300_diff_adjust(p_ld,p_apcadocno,l_apcbseq,p_apca.apcadocno,l_t320_seq,ls_js,'2') #t320-t300
            RETURNING g_sub_success,g_errno,
                      l_apcb_o.apcb103,l_apcb_o.apcb104,l_apcb_o.apcb105,
                      l_apcb_o.apcb113,l_apcb_o.apcb114,l_apcb_o.apcb115
         IF g_sub_success THEN
            LET l_apcf_tmp[l_cnt].apcf103 = l_apcb_o.apcb103
            LET l_apcf_tmp[l_cnt].apcf104 = l_apcb_o.apcb104
            LET l_apcf_tmp[l_cnt].apcf105 = l_apcb_o.apcb105
            LET l_apcf_tmp[l_cnt].apcf113 = l_apcb_o.apcb113
            LET l_apcf_tmp[l_cnt].apcf114 = l_apcb_o.apcb114
            LET l_apcf_tmp[l_cnt].apcf115 = l_apcb_o.apcb115
         ELSE
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code  = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF

      LET l_apcf_tmp[l_cnt].apca001 = p_apca.apca001
      LET l_apcf_tmp[l_cnt].apcborga= l_apcb1.apcborga   
      #計算價差匯差
      IF l_apca100 = p_apca.apca100 THEN     #相同幣別沖暫估者，則以原暫估單匯率 
         LET l_rate = l_apcc102    
      ELSE
         #不同幣別沖暫估,直接取現在立帳的單頭匯率來換算本幣,不重取匯率
         LET l_rate = l_apca101      
      END IF
      LET l_oodb004 = ''
      LET l_oodb005 = ''
      LET l_oodb006 = ''
      LET l_oodb011 = ''
      CALL s_tax_chk(l_apcacomp,l_apcb1.apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
      
   
      #計算入庫未稅單價
      LET l_oodb004 = ''
      LET l_oodb005 = ''
      LET l_oodb006 = ''
      LET l_oodb011 = ''
      #190124-00045#1---add---(S) 
      IF p_type = '1' THEN #非雜項 使用入庫單稅別l_pmdt046
         CALL s_tax_chk(l_apcacomp,l_pmdt046) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011     
      ELSE
      #190124-00045#1---add---(E) 雜項 使用t320稅別
         CALL s_tax_chk(l_apcacomp,l_t320_apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011  
      END IF #190124-00045#1 add
      IF l_oodb005 = 'Y' THEN
         LET l_pmdt036 = l_pmdt036 / (1 + l_oodb006/100)    
      END IF
      
      #計算沖帳未稅單價
      LET l_oodb004 = ''
      LET l_oodb005 = ''
      LET l_oodb006 = ''
      LET l_oodb011 = ''
      CALL s_tax_chk(l_apcacomp,l_apcb1.apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011         
      IF l_oodb005 = 'Y' THEN
         LET l_apcb1.apcb101  = l_apcb1.apcb101  / (1 + l_oodb006/100)    
      END IF    
      #單價和匯率相等->純差異
      SELECT ooaj003 INTO l_ooaj003
        FROM ooaj_t
       WHERE ooajent = g_enterprise
         AND ooaj001 = (SELECT glaa026 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_ld)           
         AND ooaj002 = l_apca100
      #l_num = 允許誤差值 
      #允許誤差值 = 0.01(依aapt300單頭幣別設定檔-aooi150單價位數決定是0.01 or 0.001 or 0.0001)
      LET l_num = 1/(10**l_ooaj003)
      
      LET l_apcf_tmp[l_cnt].apcf106 = 0
      LET l_apcf_tmp[l_cnt].apcf116 = 0
      LET l_apcf_tmp[l_cnt].apcf107 = 0
      LET l_apcf_tmp[l_cnt].apcf117 = 0
      #在可容許誤差範圍內则表示无差异
      #價差
      LET l_apcf_tmp[l_cnt].apcf106 = (l_apcb1.apcb101-l_pmdt036) * l_apcf007
      IF cl_null(l_apcf_tmp[l_cnt].apcf106) THEN LET l_apcf_tmp[l_cnt].apcf106 = 0 END IF
      CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf_tmp[l_cnt].apcf106,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf106 
      
      #本幣價差
      LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf106 * l_apca101
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf116,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf116          
       
      #先計算差異金額,比對交易幣別=本幣幣別 OR 匯率相等,表示沒有匯差,則差異應列入價差
      #差異金額: 該項次原幣未稅金額-立暫估時原幣未稅金額-原幣價差
      LET l_diff_apcf106 = 0
      LET l_diff_apcf106 = l_apcb1.apcb103 - l_apcf_tmp[l_cnt].apcf103 - l_apcf_tmp[l_cnt].apcf106 
      IF l_diff_apcf106 <> 0 THEN
         IF l_apca100 = p_apca.apca100 OR l_apca101 = l_apcc102 THEN   
            LET l_apcf_tmp[l_cnt].apcf106 = l_apcf_tmp[l_cnt].apcf106 + l_diff_apcf106
            LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf106 * l_apca101       #用t300匯率計算
            CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf116,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf116   
         END IF  
      END IF
      DISPLAY "價差處理"
      #若價差在誤差範圍內就給0
      IF (l_apcb1.apcb101 - l_pmdt036)>= l_num*-1 AND (l_apcb1.apcb101 - l_pmdt036) <= l_num THEN
         #價差在誤差範圍內寫入DIFF1=0
         LET l_apcf_tmp[l_cnt].apcf106 = 0
         LET l_apcf_tmp[l_cnt].apcf116 = 0
      END IF
      
      #匯差
      LET l_apcf_tmp[l_cnt].apcf117 = l_apcb1.apcb113 - l_apcf_tmp[l_cnt].apcf113 -l_apcf_tmp[l_cnt].apcf116
      #沒有匯差DIFF2就寫入0
      IF l_apca101 = l_apcc102 THEN
         LET l_apcf_tmp[l_cnt].apcf117 = 0
      END IF
      
      #計算DIFF3原幣apch015 = aapt3*原幣未稅 - apch_t原幣未稅 - 價差原幣未稅 
      LET l_apch015 = l_apcb1.apcb103 - l_apcf_tmp[l_cnt].apcf103 - l_apcf_tmp[l_cnt].apcf106
      
      #若匯差不為0要扣DIFF3原幣*t300匯率
      IF l_apcf_tmp[l_cnt].apcf117 <> 0 THEN
         LET l_apcf_tmp[l_cnt].apcf117 = l_apcf_tmp[l_cnt].apcf117 - l_apch015 * l_apca101
      END IF     
      
      #DIFF3本幣:apch016 = aapt3*本幣未稅 - apch_t本幣未稅 - 價差本幣未稅 - 匯差未稅 
      LET l_apch016 = l_apcb1.apcb113 - l_apcf_tmp[l_cnt].apcf113 - l_apcf_tmp[l_cnt].apcf116 - l_apcf_tmp[l_cnt].apcf117
      
      #判斷若為最後一筆,寫DIFF3不為0,就要把原幣攤給DIFF1原幣,原幣*t300匯率攤給DIFF1本幣
      #若DIFF3本幣-(DIFF3原幣*t300匯率)不等於0時就攤給DIFF2
      IF l_apcb007 = l_amount AND ( l_apch015 <> 0 OR l_apch016 <> 0 ) THEN
         #DIFF3原幣攤到DIFF1原幣
         LET l_apcf_tmp[l_cnt].apcf106 = l_apcf_tmp[l_cnt].apcf106 + l_apch015 
         #DIFF3原幣*t300匯率攤到DIFF1本幣
         LET l_apcf_tmp[l_cnt].apcf116 = l_apcf_tmp[l_cnt].apcf116 + l_apch015 * l_apca101 
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf_tmp[l_cnt].apcf116,2) RETURNING g_sub_success,g_errno,l_apcf_tmp[l_cnt].apcf116
         #DIFF3本幣 = DIFF3本幣 - 分攤金額
         LET l_apch016 = l_apch016 - l_apch015 * l_apca101 
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch016,2) RETURNING g_sub_success,g_errno,l_apch016
         #DIFF3原幣攤完給0
         LET l_apch015 = 0
         #剩下的DIFF3本幣攤給DIFF2
         LET l_apcf_tmp[l_cnt].apcf117 = l_apcf_tmp[l_cnt].apcf117 + l_apch016
         LET l_apch016 = 0
      END IF
      
      #無論有沒有價匯差都要寫入apch_t 沖暫估明細檔
      INITIALIZE l_apch.* TO NULL      
      LET l_apch.apchent  = g_enterprise    #企業編號
      LET l_apch.apchcomp = l_apcacomp      #法人
      
      
      #帳務組織
      SELECT DISTINCT apcasite INTO l_apch.apchsite FROM apca_t  
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apcadocno
                   
      LET l_apch.apchdocno = p_apcadocno    #單據號碼
      
      #項次 #aapt110拋aapt3*的apcb002.003可能會重複,所以改給aapt3*的項次
      LET l_apch.apchseq = l_apcbseq         
      
      LET l_apch.apch001 = p_apca.apcadocno #暫估單號
      
      #暫估項次
      IF p_type = '1' THEN #非雜項
         SELECT apcbseq INTO l_apch.apch002 FROM apcb_t  
          WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno 
            AND apcb002 = l_apcb002 AND apcb003 = l_apcb003
      ELSE #雜項
         LET l_apch.apch002 = l_apcb003
      END IF      
      LET l_apch.apch003 = l_apcb002        #入庫單號
      LET l_apch.apch004 = l_apcb003        #入庫單項次
      LET l_apch.apch005 = l_apcb1.apcb004  #產品編號
      LET l_apch.apch006 = l_apcb007        #沖暫估數量
      
      #取來源暫估單稅別含稅否
      LET l_oodb004 = '' LET l_oodb005 = '' LET l_oodb006 = '' LET l_oodb011 = ''
      CALL s_tax_chk(l_apch.apchcomp,l_t320_apcb020) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
      #若來源單單價含稅則需要換算為不含稅的單價
      IF l_oodb005 = 'Y' THEN  
         #原幣未稅單價apch007 =原幣未稅金額/原幣數量 ; apch008 =本幣未稅金額/本幣數量 
         IF p_type = '1' THEN
            SELECT (apcb103/apcb007),(apcb113/apcb007) INTO l_apch.apch007,l_apch.apch008 FROM apcb_t  
             WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno AND apcb002 = l_apcb002 AND apcb003 = l_apcb003         
         ELSE #雜項的l_apcb003就是暫估單的項次
            SELECT (apcb103/apcb007),(apcb113/apcb007) INTO l_apch.apch007,l_apch.apch008 FROM apcb_t  
             WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno AND apcbseq = l_apcb003         
         END IF
         CALL s_curr_round_ld('1',p_ld,l_t320_apca100,l_apch.apch007,1) RETURNING g_sub_success,g_errno,l_apch.apch007
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch.apch008,1) RETURNING g_sub_success,g_errno,l_apch.apch008
      ELSE                 
         #apch007 =原幣未稅單價 ; apch008 =本幣未稅單價 
         IF p_type = '1' THEN
            SELECT apcb101,apcb111 INTO l_apch.apch007,l_apch.apch008 FROM apcb_t  
             WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno AND apcb002 = l_apcb002 AND apcb003 = l_apcb003         
         ELSE #雜項的l_apcb003就是暫估單的項次
            SELECT apcb101,apcb111 INTO l_apch.apch007,l_apch.apch008 FROM apcb_t  
             WHERE apcbent = g_enterprise AND apcbld = p_apca.apcald AND apcbdocno = p_apca.apcadocno AND apcbseq = l_apcb003          
         END IF
      END IF         
      
      IF cl_null(l_apcf_tmp[l_cnt].apcf106) THEN LET l_apcf_tmp[l_cnt].apcf106 = 0 END IF
      IF cl_null(l_apcf_tmp[l_cnt].apcf116) THEN LET l_apcf_tmp[l_cnt].apcf116 = 0 END IF
      IF cl_null(l_apcf_tmp[l_cnt].apcf117) THEN LET l_apcf_tmp[l_cnt].apcf117 = 0 END IF

      LET l_apch.apch009 = l_apcf_tmp[l_cnt].apcf106  #DIFF 原幣價差金額
      LET l_apch.apch010 = l_apcf_tmp[l_cnt].apcf116  #DIFF 本幣價差金額
      LET l_apch.apch011 = l_apcf_tmp[l_cnt].apcf117  #DIFF 本幣匯差金額
      LET l_apch.apch015 = l_apch015                  #DIFF3原幣金額
      LET l_apch.apch016 = l_apch016                  #DIFF3本幣金額
      
      LET l_apch.apch012 = l_apch.apch009 / l_apcf007 #DIFF 原幣價差單價
      CALL s_curr_round_ld('1',p_ld,l_apca100,l_apch.apch012,1) RETURNING g_sub_success,g_errno,l_apch.apch012
      LET l_apch.apch013 = l_apch.apch010 / l_apcf007 #DIFF 本幣價差單價
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch.apch013,1) RETURNING g_sub_success,g_errno,l_apch.apch013
      LET l_apch.apch014 = l_apch.apch011 / l_apcf007 #DIFF 本幣匯差單價        
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apch.apch014,1) RETURNING g_sub_success,g_errno,l_apch.apch014
      LET l_apch.apch017 = l_apcf_tmp[l_cnt].apcf103  #原幣沖銷未稅金額
      LET l_apch.apch018 = l_apcf_tmp[l_cnt].apcf104  #原幣沖銷稅額
      LET l_apch.apch019 = l_apcf_tmp[l_cnt].apcf105  #原幣沖銷含稅金額
      LET l_apch.apch020 = l_apcf_tmp[l_cnt].apcf113  #本幣沖銷未稅金額
      LET l_apch.apch021 = l_apcf_tmp[l_cnt].apcf114  #本幣沖銷稅額
      LET l_apch.apch022 = l_apcf_tmp[l_cnt].apcf115  #本幣沖銷含稅金額
      
      #未稅&含稅金額加上DIFF3,以利後續apcf_t加總時用
      LET l_apcf_tmp[l_cnt].apcf103 = l_apcf_tmp[l_cnt].apcf103 + l_apch.apch015
      LET l_apcf_tmp[l_cnt].apcf105 = l_apcf_tmp[l_cnt].apcf105 + l_apch.apch015
      LET l_apcf_tmp[l_cnt].apcf113 = l_apcf_tmp[l_cnt].apcf113 + l_apch.apch016
      LET l_apcf_tmp[l_cnt].apcf115 = l_apcf_tmp[l_cnt].apcf115 + l_apch.apch016
      
      LET l_apch.apch023 = l_apcc102                  #暫估匯率
      LET l_apch.apch024 = l_apca101                  #沖暫估匯率
      LET l_apch.apch025 = p_apca.apca001             #暫估帳款性質
      
      #金額/匯率為空預設0
      IF cl_null(l_apch.apch007) THEN LET l_apch.apch007 = 0 END IF   #原幣未稅單價
      IF cl_null(l_apch.apch008) THEN LET l_apch.apch008 = 0 END IF   #本幣未稅單價
      IF cl_null(l_apch.apch009) THEN LET l_apch.apch009 = 0 END IF   #DIFF 原幣價差金額
      IF cl_null(l_apch.apch010) THEN LET l_apch.apch010 = 0 END IF   #DIFF 本幣價差金額
      IF cl_null(l_apch.apch011) THEN LET l_apch.apch011 = 0 END IF   #DIFF 本幣匯差金額
      IF cl_null(l_apch.apch012) THEN LET l_apch.apch012 = 0 END IF   #DIFF 原幣價差單價
      IF cl_null(l_apch.apch013) THEN LET l_apch.apch013 = 0 END IF   #DIFF 本幣價差單價
      IF cl_null(l_apch.apch014) THEN LET l_apch.apch014 = 0 END IF   #DIFF 本幣匯差單價
      IF cl_null(l_apch.apch015) THEN LET l_apch.apch015 = 0 END IF   #DIFF 純差異原幣金額
      IF cl_null(l_apch.apch016) THEN LET l_apch.apch016 = 0 END IF   #DIFF 純差異本幣金額
      IF cl_null(l_apch.apch017) THEN LET l_apch.apch017 = 0 END IF   #原幣沖銷未稅金額
      IF cl_null(l_apch.apch018) THEN LET l_apch.apch018 = 0 END IF   #原幣沖銷稅額
      IF cl_null(l_apch.apch019) THEN LET l_apch.apch019 = 0 END IF   #原幣沖銷含稅金額
      IF cl_null(l_apch.apch020) THEN LET l_apch.apch020 = 0 END IF   #本幣沖銷未稅金額
      IF cl_null(l_apch.apch021) THEN LET l_apch.apch021 = 0 END IF   #本幣沖銷稅額
      IF cl_null(l_apch.apch022) THEN LET l_apch.apch022 = 0 END IF   #本幣沖銷含稅金額
      IF cl_null(l_apch.apch023) THEN LET l_apch.apch023 = 0 END IF   #暫估匯率
      IF cl_null(l_apch.apch024) THEN LET l_apch.apch024 = 0 END IF   #沖暫估匯率
       
      INSERT INTO apch_t(apchent,apchcomp,apchsite,apchdocno,apchseq,
                         apch001,apch002,apch003,apch004,apch005,
                         apch006,apch007,apch008,apch009,apch010,
                         apch011,apch012,apch013,apch014,apch015,
                         apch016,apch017,apch018,apch019,apch020,
                         apch021,apch022,apch023,apch024,apch025,
                         apchud011,apchud012)
                  VALUES(l_apch.apchent,l_apch.apchcomp,l_apch.apchsite,l_apch.apchdocno,l_apch.apchseq,
                         l_apch.apch001,l_apch.apch002,l_apch.apch003,l_apch.apch004,l_apch.apch005,
                         l_apch.apch006,l_apch.apch007,l_apch.apch008,l_apch.apch009,l_apch.apch010,
                         l_apch.apch011,l_apch.apch012,l_apch.apch013,l_apch.apch014,l_apch.apch015,
                         l_apch.apch016,l_apch.apch017,l_apch.apch018,l_apch.apch019,l_apch.apch020,
                         l_apch.apch021,l_apch.apch022,l_apch.apch023,l_apch.apch024,l_apch.apch025,
                         l_apch.apchud011,l_apch.apchud012)              
   END FOREACH
   #190402-00043#1---add---(S)抓寫好的apch擬apcf後比較apcc
   #本次沖銷的apch加總
   LET l_sql = " SELECT SUM(apch019+apch015),SUM(apch022+apch016)",
               "   FROM apch_t ",
               "  WHERE apchent = ",g_enterprise,
               "    AND apchcomp = '",l_apcacomp,"'",
               "    AND apchdocno = '",p_apcadocno,"'",
               "    AND apch001 = '",p_apca.apcadocno,"'"
   #190423-00042#17 add ---s
  #IF l_sfin2002 MATCHES '[12]' AND l_sfin9025='Y' THEN #190423-00042#38 mark
   IF l_sfin2002 MATCHES '[12]' AND l_sfin9026='Y' THEN #190423-00042#38 add
      LET l_sql2 = "SELECT apcbseq FROM apcb_t ",
                   " WHERE apcbent = ",g_enterprise," AND apcbld = '",p_apca.apcald,"' AND apcbdocno = '",p_apca.apcadocno,"'"  
      IF p_apcc.apcc018 IS NOT NULL THEN
         LET l_sql2 = l_sql2," AND apcb015 ='",p_apcc.apcc018,"'"
      ELSE 
         LET l_sql2 = l_sql2," AND apcb015 IS NULL "
      END IF
      IF p_apcc.apcc019 IS NOT NULL THEN
         LET l_sql2 = l_sql2," AND apcb016 ='",p_apcc.apcc019,"'"
      ELSE 
         LET l_sql2 = l_sql2," AND apcb016 IS NULL "
      END IF
   END IF
   #190423-00042#17 add ---e
   IF l_sfin2002 MATCHES '[12]' THEN #依單號沖暫估
      #190423-00042#17 add ---s
     #IF l_sfin9025= 'Y' THEN  #190423-00042#38 mark
      IF l_sfin9026= 'Y' THEN  #190423-00042#38 add
         LET l_sql = l_sql," AND apch002 IN (",l_sql2,")"
      END IF
      #190423-00042#17 add ---e
   ELSE #依單號+項次沖暫估
      IF p_type = '1' THEN #非雜項
         LET l_sql = l_sql,"  AND apch002 = (SELECT apcbseq FROM apcb_t ",
                           "                  WHERE apcbent = ",g_enterprise," AND apcbld = '",p_apca.apcald,"' AND apcbdocno = '",p_apca.apcadocno,"'", 
                           "                    AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' )"
      ELSE #雜項
         LET l_sql = l_sql,"  AND apch002 = '",p_apcc.apccseq,"' "
      END IF
   END IF
   PREPARE s_aapp131_get_sumapch FROM l_sql
   
   #非本次沖銷且未確認的apch已沖金額
   LET l_sql = " SELECT SUM(apch019+apch015),SUM(apch022+apch016)",
               "   FROM apch_t ",
               "   LEFT JOIN apca_t ON apcaent = apchent AND apcacomp = apchcomp AND apcadocno = apchdocno",
               "  WHERE apchent = ",g_enterprise,
               "    AND apchcomp = '",l_apcacomp,"'",
               "    AND apchdocno <> '",p_apcadocno,"'",
               "    AND apch001 = '",p_apca.apcadocno,"'",
               "    AND apcastus = 'N'"
   IF l_sfin2002 MATCHES '[12]' THEN #依單號沖暫估
      #190423-00042#17 add ---s
     #IF l_sfin9025= 'Y' THEN #190423-00042#38 mark
      IF l_sfin9026= 'Y' THEN #190423-00042#38 add
         LET l_sql = l_sql," AND apch002 IN (",l_sql2,")"
      END IF
      #190423-00042#17 add ---e
   ELSE #依單號+項次沖暫估
      IF p_type = '1' THEN #非雜項
         LET l_sql = l_sql,"  AND apch002 = (SELECT apcbseq FROM apcb_t ",
                           "                  WHERE apcbent = ",g_enterprise," AND apcbld = '",p_apca.apcald,"' AND apcbdocno = '",p_apca.apcadocno,"'", 
                           "                    AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' )"
      ELSE #雜項
         LET l_sql = l_sql,"  AND apch002 = '",p_apcc.apccseq,"' "
      END IF
   END IF
   PREPARE s_aapp131_get_sumapch2 FROM l_sql
   #apch依apch022由大到小排序
   LET l_sql = " SELECT apch002,apch011,apch020,apch022 ",
               "   FROM apch_t ",
               "  WHERE apchent = ",g_enterprise,
               "    AND apchcomp = '",l_apcacomp,"'",
               "    AND apchdocno = '",p_apcadocno,"'",
               "    AND apch001 = '",p_apca.apcadocno,"'"
   IF l_sfin2002 MATCHES '[12]' THEN #依單號沖暫估
      #190423-00042#17 add ---s
     #IF l_sfin9025= 'Y' THEN #190423-00042#38 mark
      IF l_sfin9026= 'Y' THEN #190423-00042#38 add
         LET l_sql = l_sql," AND apch002 IN (",l_sql2,")"
      END IF
      #190423-00042#17 add ---e
   ELSE #依單號+項次沖暫估
      IF p_type = '1' THEN #非雜項
         LET l_sql = l_sql,"  AND apch002 = (SELECT apcbseq FROM apcb_t ",
                           "                  WHERE apcbent = ",g_enterprise," AND apcbld = '",p_apca.apcald,"' AND apcbdocno = '",p_apca.apcadocno,"'", 
                           "                    AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' )"
      ELSE #雜項
         LET l_sql = l_sql,"  AND apch002 = '",p_apcc.apccseq,"' "
      END IF
   END IF
   LET l_sql = l_sql,"ORDER BY apch022 DESC" 
   PREPARE s_aapp131_get_apch FROM l_sql
   DECLARE s_aapp131_get_apch_c CURSOR FOR s_aapp131_get_apch
   
   LET l_sql = " SELECT MIN(apch022) ",
               "   FROM apch_t ",
               "  WHERE apchent = ",g_enterprise,
               "    AND apchcomp = '",l_apcacomp,"'",
               "    AND apchdocno = '",p_apcadocno,"'",
               "    AND apch001 = '",p_apca.apcadocno,"'"
   IF l_sfin2002 MATCHES '[12]' THEN #依單號沖暫估
      #190423-00042#17 add ---s
     #IF l_sfin9025= 'Y' THEN #190423-00042#38 mark
      IF l_sfin9026= 'Y' THEN #190423-00042#38 add
         LET l_sql = l_sql," AND apch002 IN (",l_sql2,")"
      END IF
      #190423-00042#17 add ---e
   ELSE #依單號+項次沖暫估
      IF p_type = '1' THEN #非雜項
         LET l_sql = l_sql,"  AND apch002 = (SELECT apcbseq FROM apcb_t ",
                           "                  WHERE apcbent = ",g_enterprise," AND apcbld = '",p_apca.apcald,"' AND apcbdocno = '",p_apca.apcadocno,"'", 
                           "                    AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' )"
      ELSE #雜項
         LET l_sql = l_sql,"  AND apch002 = '",p_apcc.apccseq,"' "
      END IF
   END IF
   PREPARE s_aapp131_min_apch022 FROM l_sql
   
   LET l_sql = " UPDATE apch_t SET apch011 = ? ,apch020 = ?, apch022 = ?",
               "  WHERE apchent = ",g_enterprise,
               "    AND apchcomp = '",l_apcacomp,"'",
               "    AND apchdocno = '",p_apcadocno,"'",
               "    AND apch001 = '",p_apca.apcadocno,"'",
               "    AND apch002 = ? "
   PREPARE s_aapp131_upd_apch FROM l_sql
   
   EXECUTE s_aapp131_get_sumapch INTO l_sum_apch019,l_sum_apch022    
   EXECUTE s_aapp131_get_sumapch2 INTO l_sum_apch0191,l_sum_apch0221         
   LET l_apch_105 = l_sum_apch019 + l_sum_apch0191
   LET l_apch_115 = l_sum_apch022 + l_sum_apch0221
   LET l_diff = 0
   LET l_diff_left = 0
   LET l_flag = 'N'
   IF ((p_apcc.apcc108 - p_apcc.apcc109) - l_apch_105) = 0 #沖暫估原幣-未沖原幣=0 但 沖暫估本幣-未沖本幣<>0  
     #AND ((p_apcc.apcc118 + p_apcc.apcc113 - p_apcc.apcc119) - l_apch_115) <> 0 THEN #190402-00043#2 mark
      AND ((p_apcc.apcc118 - p_apcc.apcc119) - l_apch_115) <> 0 THEN #190402-00043#2 add
      LET l_flag = 'Y'
     #LET l_diff =  (p_apcc.apcc118 + p_apcc.apcc113 - p_apcc.apcc119) - l_apch_115  #190402-00043#2 mark
      LET l_diff =  (p_apcc.apcc118 - p_apcc.apcc119) - l_apch_115  #190402-00043#2 add
      LET l_diff_left = l_diff
      EXECUTE s_aapp131_min_apch022 INTO l_min_apch022
      #取apch022由大到小排序
      FOREACH s_aapp131_get_apch_c INTO l_apch_o.apch002,l_apch_o.apch011,l_apch_o.apch020,l_apch_o.apch022
         LET l_adjust = (l_apch_o.apch022/l_sum_apch022) * l_diff #計算apch022佔總apch022的比率 * diff
         IF l_adjust = 0 OR l_apch_o.apch022 = l_min_apch022 THEN LET l_adjust = l_diff_left END IF #未分攤完但分攤金額為0時,把剩下的分攤金額歸在此筆
         CALL s_curr_round_ld('1',p_ld,l_glaa001,l_adjust,2) RETURNING g_sub_success,g_errno,l_adjust
         LET l_apch_o.apch011 = l_apch_o.apch011 + l_adjust
         LET l_apch_o.apch020 = l_apch_o.apch020 + l_adjust
         LET l_apch_o.apch022 = l_apch_o.apch022 + l_adjust
         EXECUTE s_aapp131_upd_apch USING l_apch_o.apch011,l_apch_o.apch020,l_apch_o.apch022,l_apch_o.apch002
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.SQLCODE
            LET g_errparam.extend = "s_aapp131_upd_apch err"
            LET g_errparam.popup = TRUE
            CALL cl_err()            
         END IF
         LET l_apch_o.apch011 = 0
         LET l_apch_o.apch020 = 0
         LET l_apch_o.apch022 = 0
         LET l_diff_left = l_diff_left - l_adjust
         IF l_diff_left = 0 THEN EXIT FOREACH END IF #分攤完了就跳出
      END FOREACH
   END IF
   #190402-00043#1---add---(E)
   LET r_apcf.apcf103 = 0     LET r_apcf.apcf113 = 0      
   LET r_apcf.apcf104 = 0     LET r_apcf.apcf114 = 0
   LET r_apcf.apcf105 = 0     LET r_apcf.apcf115 = 0
   LET r_apcf.apcf007 = 0 
   
   #190402-00043#1---add---(S)
   IF l_flag = 'Y' THEN #重新抓取分攤後的apch丟回l_apcf_tmp做apcf加總
      LET l_sql = " SELECT apch006,apch009,apch010,apch011,",
                  "        (apch017+apch015),apch018,(apch019+apch015),",
                  "        (apch020+apch016),apch021,(apch022+apch016) ",
                  "   FROM apch_t ",
                  "  WHERE apchent = ",g_enterprise,
                  "    AND apchcomp = '",l_apcacomp,"'",
                  "    AND apchdocno = '",p_apcadocno,"'",
                  "    AND apch001 = '",p_apca.apcadocno,"'"
      IF l_sfin2002 MATCHES '[12]' THEN #依單號沖暫估
         #190423-00042#17 add ---s
        #IF l_sfin9025= 'Y' THEN #190423-00042#38 mark
         IF l_sfin9026= 'Y' THEN #190423-00042#38 add
            LET l_sql = l_sql," AND apch002 IN (",l_sql2,")"
         END IF
         #190423-00042#17 add ---e
      ELSE #依單號+項次沖暫估
         IF p_type = '1' THEN #非雜項
            LET l_sql = l_sql,"  AND apch002 = (SELECT apcbseq FROM apcb_t ",
                              "                  WHERE apcbent = ",g_enterprise," AND apcbld = '",p_apca.apcald,"' AND apcbdocno = '",p_apca.apcadocno,"'", 
                              "                    AND apcb002 = '",l_aapt320_apcb002,"' AND apcb003 = '",l_aapt320_apcb003,"' )"
         ELSE #雜項
            LET l_sql = l_sql,"  AND apch002 = '",p_apcc.apccseq,"' "
         END IF
      END IF
      PREPARE s_aapp131_get_apch2 FROM l_sql
      DECLARE s_aapp131_get_apch_c2 CURSOR FOR s_aapp131_get_apch2
      LET l_i = 0
      FOREACH s_aapp131_get_apch_c2 INTO l_sum_apcf.apcf007,l_sum_apcf.apcf106,l_sum_apcf.apcf116,l_sum_apcf.apcf117,
                                         l_sum_apcf.apcf103,l_sum_apcf.apcf104,l_sum_apcf.apcf105,   
                                         l_sum_apcf.apcf113,l_sum_apcf.apcf114,l_sum_apcf.apcf115
         LET l_i = l_i + 1
         LET l_apcf_tmp[l_i].apcf103 = l_sum_apcf.apcf103
         LET l_apcf_tmp[l_i].apcf104 = l_sum_apcf.apcf104
         LET l_apcf_tmp[l_i].apcf105 = l_sum_apcf.apcf105
         LET l_apcf_tmp[l_i].apcf106 = l_sum_apcf.apcf106
         LET l_apcf_tmp[l_i].apcf113 = l_sum_apcf.apcf113
         LET l_apcf_tmp[l_i].apcf114 = l_sum_apcf.apcf114
         LET l_apcf_tmp[l_i].apcf115 = l_sum_apcf.apcf115
         LET l_apcf_tmp[l_i].apcf116 = l_sum_apcf.apcf116
         LET l_apcf_tmp[l_i].apcf117 = l_sum_apcf.apcf117
         LET l_apcf[l_i].apcf007     = l_sum_apcf.apcf007
         LET r_apcf.apcf103 = r_apcf.apcf103 + l_apcf_tmp[l_i].apcf103
         LET r_apcf.apcf104 = r_apcf.apcf104 + l_apcf_tmp[l_i].apcf104
         LET r_apcf.apcf105 = r_apcf.apcf105 + l_apcf_tmp[l_i].apcf105
         LET r_apcf.apcf113 = r_apcf.apcf113 + l_apcf_tmp[l_i].apcf113
         LET r_apcf.apcf114 = r_apcf.apcf114 + l_apcf_tmp[l_i].apcf114
         LET r_apcf.apcf115 = r_apcf.apcf115 + l_apcf_tmp[l_i].apcf115
         LET r_apcf.apcf007 = r_apcf.apcf007 + l_apcf[l_i].apcf007 
         INITIALIZE l_sum_apcf.apcf103 TO NULL
      END FOREACH
   ELSE   
   #190402-00043#1---add---(E)沒有分攤才走原來的apcf合計
      FOR l_i = 1 TO l_apcf_tmp.getLength()
         LET r_apcf.apcf103 = r_apcf.apcf103 + l_apcf_tmp[l_i].apcf103
         LET r_apcf.apcf104 = r_apcf.apcf104 + l_apcf_tmp[l_i].apcf104
         LET r_apcf.apcf105 = r_apcf.apcf105 + l_apcf_tmp[l_i].apcf105
         LET r_apcf.apcf113 = r_apcf.apcf113 + l_apcf_tmp[l_i].apcf113
         LET r_apcf.apcf114 = r_apcf.apcf114 + l_apcf_tmp[l_i].apcf114
         LET r_apcf.apcf115 = r_apcf.apcf115 + l_apcf_tmp[l_i].apcf115
         LET r_apcf.apcf007 = r_apcf.apcf007 + l_apcf[l_i].apcf007     #apcf007 = apch006加總
      END FOR
   END IF  #190402-00043#1 add
   
   LET r_apcf.apcfent = g_enterprise
   LET r_apcf.apcfld  = p_ld
   LET r_apcf.apcfdocno=p_apcadocno
   SELECT MAX(apcfseq) + 1 INTO r_apcf.apcfseq
     FROM apcf_t
    WHERE apcfent = g_enterprise AND apcfld = p_ld
      AND apcfdocno=p_apcadocno  
   IF cl_null(r_apcf.apcfseq) THEN LET r_apcf.apcfseq = 1 END IF
   LET r_apcf.apcfseq2 = 0
   LET r_apcf.apcf001 = 'aapt300'
   LET r_apcf.apcf002 = '01'                 #固定值
   LET r_apcf.apcf008 = p_apca.apcadocno
   LET r_apcf.apcf009 = p_apcc.apccseq
   LET r_apcf.apcf010 = p_apcc.apcc001       #期別:暫估原則上只有一期
   LET r_apcf.apcf020 = p_apca.apca011       #稅別   
  
   CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_11') RETURNING g_sub_success,r_apcf.apcf024,g_errno 
   CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_12') RETURNING g_sub_success,r_apcf.apcf025,g_errno 
  
   IF l_sfin3011 = 'N' THEN      #不迴轉(Y代表回转。N不回转:抓apcf)
      LET r_apcf.apcf021 = p_apca.apca035   
      IF l_sfin2002 = '3' THEN
         SELECT apcb029 INTO r_apcf.apcf021
           FROM apcb_t
          WHERE apcbent = g_enterprise
            AND apcbld = p_ld
            AND apcbdocno = p_apca.apcadocno
            AND apcbseq = p_apcc.apccseq
      END IF
      LET r_apcf.apcf022 = p_apca.apca036
      CALL s_fin_get_account(p_ld,'13',p_apca.apca007,'8504_08') RETURNING g_sub_success,r_apcf.apcf023,g_errno
   ELSE
      #冲暂估明细里面的科目应该根据对应的暂估立账单上的账款科目带过来
      LET r_apcf.apcf021 = p_apca.apca035      
      SELECT glac007 INTO l_glac007       #取得科目性質
        FROM glac_t        
       WHERE glacent = g_enterprise AND glac001 = l_glaa004 AND glac002 = l_apca036
      IF cl_null(l_glac007) THEN LET l_glac007 = 0 END IF  
      SELECT apcadocdt INTO l_apcadocdt1  #立帳單的立帳日期
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apcadocno
       SELECT apcadocdt INTO l_apcadocdt2 #暫估單的立帳日期
        FROM apca_t
       WHERE apcaent = g_enterprise AND apcald = p_ld AND apcadocno = p_apca.apcadocno
      #當期沖暫估的科目及資產類科目
      IF l_glac007 NOT MATCHES '[45]' OR (YEAR(l_apcadocdt1) = YEAR(l_apcadocdt2) AND MONTH(l_apcadocdt1) = MONTH(l_apcadocdt2)) THEN
         LET r_apcf.apcf022 = p_apca.apca036
      ELSE
         LET r_apcf.apcf022 = l_apca036
      END IF
      #科目應該使用暫估稅額科目
      CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_08') RETURNING g_sub_success,r_apcf.apcf023,g_errno    
       
      #若aoos020暫估回轉=Y and立暫估年月<>沖暫估年月,則沖暫估訊息apcf科目給null
      IF l_sfin3011 = 'Y' AND (NOT(YEAR(l_apcadocdt1) = YEAR(l_apcadocdt2) AND MONTH(l_apcadocdt1) = MONTH(l_apcadocdt2))) THEN 
         LET r_apcf.apcf021  = ''
         LET r_apcf.apcf022  = ''
         LET r_apcf.apcf023  = ''
         LET r_apcf.apcf024  = ''
         LET r_apcf.apcf025  = ''
      END IF
      
   END IF

   IF cl_null(r_apcf.apcf026) THEN LET r_apcf.apcf026 = " " END IF #業務部門
   IF cl_null(r_apcf.apcf027) THEN LET r_apcf.apcf027 = " " END IF #責任中心
   IF cl_null(r_apcf.apcf028) THEN LET r_apcf.apcf028 = " " END IF #區域
   IF cl_null(r_apcf.apcf029) THEN LET r_apcf.apcf029 = " " END IF #收付款客商
   IF cl_null(r_apcf.apcf030) THEN LET r_apcf.apcf030 = " " END IF #帳款客商
   IF cl_null(r_apcf.apcf031) THEN LET r_apcf.apcf031 = " " END IF #客群
   IF cl_null(r_apcf.apcf032) THEN LET r_apcf.apcf032 = " " END IF #產品類別
   IF cl_null(r_apcf.apcf033) THEN LET r_apcf.apcf033 = " " END IF #業務人員
   IF cl_null(r_apcf.apcf034) THEN LET r_apcf.apcf034 = " " END IF #專案編號
   IF cl_null(r_apcf.apcf035) THEN LET r_apcf.apcf035 = " " END IF #WBS
   IF cl_null(r_apcf.apcf036) THEN LET r_apcf.apcf036 = " " END IF #經營方式
   IF cl_null(r_apcf.apcf037) THEN LET r_apcf.apcf037 = " " END IF #通路
   IF cl_null(r_apcf.apcf038) THEN LET r_apcf.apcf038 = " " END IF #品牌
   IF cl_null(r_apcf.apcf039) THEN LET r_apcf.apcf039 = " " END IF #自由核算項一
   IF cl_null(r_apcf.apcf040) THEN LET r_apcf.apcf040 = " " END IF #自由核算項二
   IF cl_null(r_apcf.apcf041) THEN LET r_apcf.apcf041 = " " END IF #自由核算項三
   IF cl_null(r_apcf.apcf042) THEN LET r_apcf.apcf042 = " " END IF #自由核算項四
   IF cl_null(r_apcf.apcf043) THEN LET r_apcf.apcf043 = " " END IF #自由核算項五
   IF cl_null(r_apcf.apcf044) THEN LET r_apcf.apcf044 = " " END IF #自由核算項六
   IF cl_null(r_apcf.apcf045) THEN LET r_apcf.apcf045 = " " END IF #自由核算項七
   IF cl_null(r_apcf.apcf046) THEN LET r_apcf.apcf046 = " " END IF #自由核算項八
   IF cl_null(r_apcf.apcf047) THEN LET r_apcf.apcf047 = " " END IF #自由核算項九
   IF cl_null(r_apcf.apcf048) THEN LET r_apcf.apcf048 = " " END IF #自由核算項十      

   
   RETURN r_flag,r_apcf.*,l_apcf_tmp
END FUNCTION

################################################################################
# Descriptions...: 寫入暫估差異(取代s_aapp131_ins_apcf_diff)
# Memo...........: 180821-00038#16 create
# Usage..........: s_aapp131_ins_apcf_diff2(p_ld,p_apcadocno)
# Date & Author..: 181225 By 10554
# Modify.........: 
################################################################################
PUBLIC FUNCTION s_aapp131_ins_apcf_diff2(p_ld,p_apcadocno)
DEFINE p_type        LIKE type_t.chr1
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_apcadocno   LIKE apca_t.apcadocno   #立帳單據
DEFINE l_apcf RECORD  #應付沖暫估明細檔
       apcfent LIKE apcf_t.apcfent, #企業編號
       apcfld LIKE apcf_t.apcfld, #帳套
       apcforga LIKE apcf_t.apcforga, #來源組織
       apcfdocno LIKE apcf_t.apcfdocno, #單號
       apcfseq LIKE apcf_t.apcfseq, #項次
       apcfseq2 LIKE apcf_t.apcfseq2, #項次2
       apcf001 LIKE apcf_t.apcf001, #作業別
       apcf002 LIKE apcf_t.apcf002, #沖銷類型
       apcf007 LIKE apcf_t.apcf007, #沖銷數量
       apcf008 LIKE apcf_t.apcf008, #暫估單號碼
       apcf009 LIKE apcf_t.apcf009, #暫估單號項次
       apcf010 LIKE apcf_t.apcf010, #期別
       apcf020 LIKE apcf_t.apcf020, #稅別
       apcf021 LIKE apcf_t.apcf021, #待沖銷應付會科
       apcf022 LIKE apcf_t.apcf022, #待沖銷未稅會科
       apcf023 LIKE apcf_t.apcf023, #待沖銷稅額會科
       apcf024 LIKE apcf_t.apcf024, #沖銷價差科目
       apcf025 LIKE apcf_t.apcf025, #沖銷匯差科目
       apcf026 LIKE apcf_t.apcf026, #業務部門
       apcf027 LIKE apcf_t.apcf027, #責任中心
       apcf028 LIKE apcf_t.apcf028, #區域
       apcf029 LIKE apcf_t.apcf029, #收付款客商
       apcf030 LIKE apcf_t.apcf030, #帳款客商
       apcf031 LIKE apcf_t.apcf031, #客群
       apcf032 LIKE apcf_t.apcf032, #產品類別
       apcf033 LIKE apcf_t.apcf033, #業務人員
       apcf034 LIKE apcf_t.apcf034, #專案編號
       apcf035 LIKE apcf_t.apcf035, #WBS
       apcf036 LIKE apcf_t.apcf036, #經營方式
       apcf037 LIKE apcf_t.apcf037, #通路
       apcf038 LIKE apcf_t.apcf038, #品牌
       apcf039 LIKE apcf_t.apcf039, #自由核算項一
       apcf040 LIKE apcf_t.apcf040, #自由核算項二
       apcf041 LIKE apcf_t.apcf041, #自由核算項三
       apcf042 LIKE apcf_t.apcf042, #自由核算項四
       apcf043 LIKE apcf_t.apcf043, #自由核算項五
       apcf044 LIKE apcf_t.apcf044, #自由核算項六
       apcf045 LIKE apcf_t.apcf045, #自由核算項七
       apcf046 LIKE apcf_t.apcf046, #自由核算項八
       apcf047 LIKE apcf_t.apcf047, #自由核算項九
       apcf048 LIKE apcf_t.apcf048, #自由核算項十
       apcf049 LIKE apcf_t.apcf049, #摘要
       apcf101 LIKE apcf_t.apcf101, #原幣單價
       apcf102 LIKE apcf_t.apcf102, #原幣匯率
       apcf103 LIKE apcf_t.apcf103, #原幣未稅金額
       apcf104 LIKE apcf_t.apcf104, #原幣稅額
       apcf105 LIKE apcf_t.apcf105, #原幣含稅金額
       apcf106 LIKE apcf_t.apcf106, #原幣沖銷差異金額
       apcf111 LIKE apcf_t.apcf111, #本幣單價
       apcf113 LIKE apcf_t.apcf113, #本幣未稅金額
       apcf114 LIKE apcf_t.apcf114, #本幣稅額
       apcf115 LIKE apcf_t.apcf115, #本幣含稅金額
       apcf116 LIKE apcf_t.apcf116, #本幣價差金額
       apcf117 LIKE apcf_t.apcf117, #本幣匯差金額
       apcf122 LIKE apcf_t.apcf122, #暫估本未幣二匯率
       apcf123 LIKE apcf_t.apcf123, #本位幣二未稅金額
       apcf124 LIKE apcf_t.apcf124, #本位幣二稅額
       apcf125 LIKE apcf_t.apcf125, #本位幣二含稅金額
       apcf126 LIKE apcf_t.apcf126, #本位幣二價格差異金額
       apcf127 LIKE apcf_t.apcf127, #本位幣二匯差
       apcf132 LIKE apcf_t.apcf132, #暫估本位幣三匯率
       apcf133 LIKE apcf_t.apcf133, #本位幣三未稅金額
       apcf134 LIKE apcf_t.apcf134, #本位幣三稅額
       apcf135 LIKE apcf_t.apcf135, #本位幣三含稅金額
       apcf136 LIKE apcf_t.apcf136, #本位幣三價格差異金額
       apcf137 LIKE apcf_t.apcf137, #本位幣三匯差
       apcfud001 LIKE apcf_t.apcfud001, #自定義欄位(文字)001
       apcfud002 LIKE apcf_t.apcfud002, #自定義欄位(文字)002
       apcfud003 LIKE apcf_t.apcfud003, #自定義欄位(文字)003
       apcfud004 LIKE apcf_t.apcfud004, #自定義欄位(文字)004
       apcfud005 LIKE apcf_t.apcfud005, #自定義欄位(文字)005
       apcfud006 LIKE apcf_t.apcfud006, #自定義欄位(文字)006
       apcfud007 LIKE apcf_t.apcfud007, #自定義欄位(文字)007
       apcfud008 LIKE apcf_t.apcfud008, #自定義欄位(文字)008
       apcfud009 LIKE apcf_t.apcfud009, #自定義欄位(文字)009
       apcfud010 LIKE apcf_t.apcfud010, #自定義欄位(文字)010
       apcfud011 LIKE apcf_t.apcfud011, #自定義欄位(數字)011
       apcfud012 LIKE apcf_t.apcfud012, #自定義欄位(數字)012
       apcfud013 LIKE apcf_t.apcfud013, #自定義欄位(數字)013
       apcfud014 LIKE apcf_t.apcfud014, #自定義欄位(數字)014
       apcfud015 LIKE apcf_t.apcfud015, #自定義欄位(數字)015
       apcfud016 LIKE apcf_t.apcfud016, #自定義欄位(數字)016
       apcfud017 LIKE apcf_t.apcfud017, #自定義欄位(數字)017
       apcfud018 LIKE apcf_t.apcfud018, #自定義欄位(數字)018
       apcfud019 LIKE apcf_t.apcfud019, #自定義欄位(數字)019
       apcfud020 LIKE apcf_t.apcfud020, #自定義欄位(數字)020
       apcfud021 LIKE apcf_t.apcfud021, #自定義欄位(日期時間)021
       apcfud022 LIKE apcf_t.apcfud022, #自定義欄位(日期時間)022
       apcfud023 LIKE apcf_t.apcfud023, #自定義欄位(日期時間)023
       apcfud024 LIKE apcf_t.apcfud024, #自定義欄位(日期時間)024
       apcfud025 LIKE apcf_t.apcfud025, #自定義欄位(日期時間)025
       apcfud026 LIKE apcf_t.apcfud026, #自定義欄位(日期時間)026
       apcfud027 LIKE apcf_t.apcfud027, #自定義欄位(日期時間)027
       apcfud028 LIKE apcf_t.apcfud028, #自定義欄位(日期時間)028
       apcfud029 LIKE apcf_t.apcfud029, #自定義欄位(日期時間)029
       apcfud030 LIKE apcf_t.apcfud030  #自定義欄位(日期時間)030
END RECORD
DEFINE l_sql         STRING
DEFINE l_apca007     LIKE apca_t.apca007
DEFINE l_apca101     LIKE apca_t.apca101
DEFINE l_apca100     LIKE apca_t.apca100
DEFINE l_glaacomp    LIKE glaa_t.glaacomp
DEFINE l_glaa001     LIKE glaa_t.glaa001
DEFINE l_apcf106     LIKE apcf_t.apcf106
DEFINE l_apcf116     LIKE apcf_t.apcf116
DEFINE l_i,l_cnt     LIKE type_t.num5
DEFINE l_apcb113     LIKE apcb_t.apcb105
DEFINE l_apcb123     LIKE apcb_t.apcb105
DEFINE l_apcb133     LIKE apcb_t.apcb105
DEFINE l_apcf101     LIKE apcf_t.apcf101
DEFINE l_apcf111     LIKE apcf_t.apcf111
DEFINE l_apcf113     LIKE apcf_t.apcf113
DEFINE l_apcf123     LIKE apcf_t.apcf123
DEFINE l_apcf133     LIKE apcf_t.apcf133
DEFINE l_apcf1131    LIKE apcf_t.apcf113
DEFINE l_apcf1231    LIKE apcf_t.apcf123
DEFINE l_apcf1331    LIKE apcf_t.apcf133
DEFINE l_sfin2011    LIKE type_t.chr1   
DEFINE l_sfin3011    LIKE type_t.chr1        #迴轉否  
DEFINE l_sfin3012    LIKE type_t.chr1
DEFINE l_apcborga    LIKE apcb_t.apcborga
DEFINE l_apcadocdt    LIKE apca_t.apcadocdt           
DEFINE l_apcf021_null LIKE type_t.chr1                #清空科目否
DEFINE l_sfin3034     LIKE type_t.chr1                #暫估期初迴轉,沖暫估時認列差異否
DEFINE l_apca015     LIKE apca_t.apca015
DEFINE l_glad007     LIKE glad_t.glad007     
DEFINE l_amt_apcf113 LIKE apcf_t.apcf113 
DEFINE l_amt_apcf114 LIKE apcf_t.apcf114 
DEFINE l_amt_apcf115 LIKE apcf_t.apcf115 
DEFINE l_amt_apcf123 LIKE apcf_t.apcf123 
DEFINE l_amt_apcf124 LIKE apcf_t.apcf124 
DEFINE l_amt_apcf125 LIKE apcf_t.apcf125 
DEFINE l_amt_apcf133 LIKE apcf_t.apcf133 
DEFINE l_amt_apcf134 LIKE apcf_t.apcf134 
DEFINE l_amt_apcf135 LIKE apcf_t.apcf135 
DEFINE l_apch015     LIKE apch_t.apch015
DEFINE l_apch016     LIKE apch_t.apch016
DEFINE l_apca001     LIKE apca_t.apca001
DEFINE l_apch001     LIKE apch_t.apch001
DEFINE l_apcf117     LIKE apcf_t.apcf117
#201223-00041#1 add(s)
DEFINE l_apca004     LIKE apca_t.apca004 
DEFINE l_apca005     LIKE apca_t.apca005 
DEFINE l_glad010     LIKE glad_t.glad010 
DEFINE l_glad027     LIKE glad_t.glad027
#201223-00041#1 add(e)

   WHENEVER ERROR CONTINUE
   
   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa001')
        RETURNING  g_sub_success,l_glaacomp,l_glaa001
   
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3011') RETURNING l_sfin3011  
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3012') RETURNING l_sfin3012
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3034') RETURNING l_sfin3034  
 
   LET l_apcadocdt = ''
   
   #SELECT apca007,apca101,apca100,apcadocdt,apca015 #201223-00041#1 mark
   SELECT apca007,apca101,apca100,apcadocdt,apca015,apca004,apca005 #201223-00041#1 add   
     #INTO l_apca007,l_apca101,l_apca100,l_apcadocdt,l_apca015 #201223-00041#1 mark
     INTO l_apca007,l_apca101,l_apca100,l_apcadocdt,l_apca015,l_apca004,l_apca005 #201223-00041#1 add    
     FROM apca_t
    WHERE apcaent = g_enterprise
      AND apcald  = p_ld AND apcadocno = p_apcadocno
   
   SELECT count(apcfdocno) INTO l_cnt 
     FROM apcf_t,apca_t
    WHERE apcaent = apcfent AND apcald = apcfld AND apcadocno = apcf008
      AND apcfent = g_enterprise
      AND apcfld  = p_ld AND apcfdocno = p_apcadocno
      AND apca001 IN ('01','02','03','04')
   IF l_cnt = 0 THEN #若無0*單據不沖暫估
      RETURN
   END IF

   #若期初回轉否=Y,沖暫估訊息中非diff單據,有沖非本月份的,則將科目清空
   LET l_apcf021_null = 'N'
   IF (l_sfin3011 = 'Y') AND (l_sfin3034 = 'N') THEN 
      LET l_cnt = 0
      SELECT COUNT(apcfdocno) INTO l_cnt 
        FROM apcf_t,apca_t
       WHERE apcaent = apcfent AND apcald = apcfld AND apcadocno = apcf008
         AND apcfent = g_enterprise AND apcfld = p_ld 
         AND apcfdocno = p_apcadocno AND apcf008 <> 'DIFF' 
         AND apca001 IN ('01','02','03','04')
         AND (to_char(apcadocdt,'yyyy') = to_char(l_apcadocdt,'yyyy') AND to_char(apcadocdt,'mm') = to_char(l_apcadocdt,'mm'))
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt = 0 THEN   #表示有沖非本月份的
         LET l_apcf021_null = 'Y'
      END IF
   END IF
   #取帳務歸屬組織
   LET l_sql = " SELECT DISTINCT apcborga FROM apcb_t",
               "  WHERE apcbent = ",g_enterprise,
               "    AND apcbld = '",p_ld,"' AND apcbdocno = '",p_apcadocno,"' AND apcb023 = 'Y' "
   PREPARE s_aapp130_get_orga_p FROM l_sql
   DECLARE s_aapp130_get_orga_c CURSOR FOR s_aapp130_get_orga_p
   
   #依帳務歸屬組織把價差匯差寫入apcf_t
   FOREACH s_aapp130_get_orga_c INTO l_apcborga
      INITIALIZE l_apcf.* TO NULL
      LET l_apcf.apcfent   = g_enterprise
      LET l_apcf.apcfld    = p_ld
      LET l_apcf.apcforga  = l_apcborga 
      LET l_apcf.apcfdocno = p_apcadocno
      LET l_apcf.apcfseq2  = 0 
      LET l_apcf.apcf001   = 'aapt300'
      LET l_apcf.apcf002   = '01'              #固定值
      LET l_apcf.apcf007   = 1
      LET l_apcf.apcf008   = 'DIFF'
      LET l_apcf.apcf009   = 0
      LET l_apcf.apcf010   = 0
      LET l_apcf.apcf020   = ''
      LET l_apcf.apcf022   = ''
      LET l_apcf.apcf023   = ''
      LET l_apcf.apcf024   = ''
      LET l_apcf.apcf025   = ''
      LET l_apcf.apcf022   = ''
      LET l_apcf.apcf101   = 0
      LET l_apcf.apcf104   = 0
      LET l_apcf.apcf106   = 0
      LET l_apcf.apcf111   = 0
      LET l_apcf.apcf114   = 0
      LET l_apcf.apcf116   = 0
      LET l_apcf.apcf117   = 0
      
      #抓取暫估單號&帳款單性質&價差原幣&價差本幣
      LET l_sql = " SELECT apch001,apch025,apch009,apch010 ",
                  "   FROM apch_t ",
                  "  WHERE apchent = ",g_enterprise,
                  "    AND apchdocno = '",p_apcadocno,"'",
                  "    AND apchseq IN (SELECT apcbseq FROM apcb_t ",
                  "                     WHERE apcbent = ",g_enterprise,
                  "                       AND apcbld = '",p_ld,"' AND apcbdocno = '",p_apcadocno,"' ",
                  "                       AND apcb023 = 'Y' AND apcborga = '",l_apcborga,"')"
      PREPARE s_aapp130_get_apch_diff1_p FROM l_sql
      DECLARE s_aapp130_get_apch_diff1_c CURSOR FOR s_aapp130_get_apch_diff1_p
      
      #抓取暫估單號&帳款單性質&匯差本幣
      LET l_sql = " SELECT apch001,apch025,apch011 ",
                  "   FROM apch_t ",
                  "  WHERE apchent = ",g_enterprise,
                  "    AND apchdocno = '",p_apcadocno,"'",
                  "    AND apchseq IN (SELECT apcbseq FROM apcb_t ",
                  "                     WHERE apcbent = ",g_enterprise,
                  "                       AND apcbld = '",p_ld,"' AND apcbdocno = '",p_apcadocno,"' ",
                  "                       AND apcb023 = 'Y' AND apcborga = '",l_apcborga,"')"
      PREPARE s_aapp130_get_apch_diff2_p FROM l_sql
      DECLARE s_aapp130_get_apch_diff2_c CURSOR FOR s_aapp130_get_apch_diff2_p
      
      #抓取暫估單的帳款單性質
      LET l_sql = " SELECT apca001 FROM apca_t",
                  "  WHERE apcaent = ",g_enterprise,
                  "    AND apcadocno = ? "
      PREPARE s_aapp130_get_apca001_p FROM l_sql
      
      #產生價差數據---(S)---
      LET l_apcf101 = 0
      LET l_apcf111 = 0
      CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_11') RETURNING g_sub_success,l_apcf.apcf021,g_errno
      LET l_apcf.apcf102 = l_apca101
      SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
        FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
        AND apcfdocno = p_apcadocno  
      IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
      LET l_apca001 = ''
      
      FOREACH s_aapp130_get_apch_diff1_c INTO l_apch001,l_apca001,l_apcf101,l_apcf111
         IF cl_null(l_apca001) THEN #如果apch025沒存帳款單性質就從t320抓
            EXECUTE s_aapp130_get_apca001_p USING l_apch001 INTO l_apca001
         END IF
         IF cl_null(l_apcf101) THEN LET l_apcf101 = 0 END IF
         IF cl_null(l_apcf111) THEN LET l_apcf111 = 0 END IF
         #待抵單要*-1後再加總
         IF l_apca001 MATCHES '0[24]' THEN
            LET l_apcf101 = l_apcf101 * -1
            LET l_apcf111 = l_apcf111 * -1
         END IF
         LET l_apcf.apcf101 = l_apcf.apcf101 + l_apcf101
         LET l_apcf.apcf111 = l_apcf.apcf111 + l_apcf111
      END FOREACH
      LET l_apcf.apcf103 = l_apcf.apcf007 * l_apcf.apcf101
      LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111  
      CALL s_curr_round_ld('1',p_ld,l_apca100,l_apcf.apcf103,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103 
      LET l_apcf.apcf105 = l_apcf.apcf103
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113 
      LET l_apcf.apcf115 = l_apcf.apcf113
      IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
         LET l_apcf.apcf021 = ''
      END IF
      #判斷是否啟用"部門"核算項
      LET l_glad007=''
      #201223-00041#1 add(s)
      LET l_glad010 = ''  
      LET l_glad027 = ''
      #201223-00041#1 add(e)
      #SELECT glad007 INTO l_glad007 #201223-00041#1 mark
      SELECT glad007,glad010,glad027 INTO l_glad007,l_glad010,l_glad027 #201223-00041#1 add
        FROM glad_t
       WHERE gladent = g_enterprise
         AND gladld  = p_ld
         AND glad001 = l_apcf.apcf021 
      
      IF l_glad007 = 'Y' THEN
         LET l_apcf.apcf026 = l_apca015
      ELSE
         LET l_apcf.apcf026 = ''
      END IF
      #201223-00041#1 add(s)
      IF l_glad010 = 'Y' THEN
         LET l_apcf.apcf029 = l_apca005
      ELSE
         LET l_apcf.apcf029 = ''
      END IF
      
      IF l_glad027 = 'Y' THEN
         LET l_apcf.apcf030 = l_apca004
      ELSE
         LET l_apcf.apcf030 = ''
      END IF
      #201223-00041#1 add(e)
      LET l_apcf.apcf002 = 'D1'  #價差類型D1
      
      IF NOT (l_apcf.apcf103 = 0 AND l_apcf.apcf113 = 0) THEN
         IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
         IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
         IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
         IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
         IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
         IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
         IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
         IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
         IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
         IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
         IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
         IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
         IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
         IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
         IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
         IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
         IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
         IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
         IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
         IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
         IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
         IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
         IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十     
      
         #金額/匯率為空預設0
         IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
         IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
         IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
         IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
         IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
         IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
         IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
         IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
         IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
         IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
         IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
         IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
         IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
         IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
         IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
         IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
         IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
         IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
         IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
         IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
         IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
         IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
         IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
         IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
         
         INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                            apcfseq2,apcf001,apcf002,apcf007,apcf008,
                            apcf009,apcf010,apcf020,apcf021,apcf022,
                            apcf023,apcf024,apcf025,apcf026,apcf027,
                            apcf028,apcf029,apcf030,apcf031,apcf032,
                            apcf033,apcf034,apcf035,apcf036,apcf037,
                            apcf038,apcf039,apcf040,apcf041,apcf042,
                            apcf043,apcf044,apcf045,apcf046,apcf047,
                            apcf048,apcf049,apcf101,apcf102,apcf103,
                            apcf104,apcf105,apcf106,apcf111,apcf113,
                            apcf114,apcf115,apcf116,apcf117,apcf122,
                            apcf123,apcf124,apcf125,apcf126,apcf127,
                            apcf132,apcf133,apcf134,apcf135,apcf136,
                            apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                            apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                            apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                            apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                            apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                            apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                            apcfud030)
         VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                l_apcf.apcfud030)
      END IF
      #產生價差數據---(E)---
      #產生匯差數據---(S)---
      LET l_apcf.apcf101 = 0          #匯差單價0
      LET l_apcf.apcf102 = l_apca101  #改放t300匯率
      LET l_apcf.apcf103 = 0
      LET l_apcf.apcf105 = 0
      LET l_apcf.apcf106 = 0
      LET l_apcf.apcf111 = 0
      LET l_apcf.apcf113 = 0
      LET l_apcf.apcf115 = 0
      LET l_apcf.apcf116 = 0
      CALL s_fin_get_account(p_ld,'13',l_apca007,'8504_12') RETURNING g_sub_success,l_apcf.apcf021,g_errno
      SELECT MAX(apcfseq) + 1 INTO l_apcf.apcfseq
        FROM apcf_t
       WHERE apcfent = g_enterprise AND apcfld = p_ld
         AND apcfdocno=p_apcadocno  
      IF cl_null(l_apcf.apcfseq) THEN LET l_apcf.apcfseq = 1 END IF
      FOREACH s_aapp130_get_apch_diff2_c INTO l_apch001,l_apca001,l_apcf117
         IF cl_null(l_apca001) THEN #如果apch025沒存帳款單性質就從t320抓
            EXECUTE s_aapp130_get_apca001_p USING l_apch001 INTO l_apca001
         END IF
         IF NOT cl_null(l_apcf117) AND l_apcf117 <> 0 THEN
            #待抵單要*-1後再加總
            IF l_apca001 MATCHES '0[24]' THEN
               LET l_apcf117 = l_apcf117 * -1
            END IF
            LET l_apcf.apcf111 = l_apcf.apcf111 + l_apcf117
            #匯差僅本幣金額,原幣金額給0
            LET l_apcf.apcf103 = 0
            LET l_apcf.apcf105 = 0
          END IF
      END FOREACH
      LET l_apcf.apcf113 = l_apcf.apcf007 * l_apcf.apcf111
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf103,2) RETURNING g_sub_success,g_errno,l_apcf.apcf103  
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apcf.apcf113,2) RETURNING g_sub_success,g_errno,l_apcf.apcf113    
      LET l_apcf.apcf115 = l_apcf.apcf113
      IF l_sfin3011 = 'Y' AND l_apcf021_null = 'Y' THEN
         LET l_apcf.apcf021 = ''
      END IF
      IF l_apcf.apcf111 <> 0 THEN
         #匯差僅本幣金額,原幣金額給0
         LET l_apcf.apcf103 = 0
         LET l_apcf.apcf105 = 0
         
         #判斷是否啟用"部門"核算項
         LET l_glad007=''
         SELECT glad007 INTO l_glad007
           FROM glad_t
          WHERE gladent = g_enterprise
            AND gladld  = p_ld
            AND glad001 = l_apcf.apcf021 
         
         IF l_glad007='Y' THEN
            LET l_apcf.apcf026 = l_apca015
         ELSE
            LET l_apcf.apcf026 = ''
         END IF
         
         IF cl_null(l_apcf.apcf026) THEN LET l_apcf.apcf026 = " " END IF #業務部門
         IF cl_null(l_apcf.apcf027) THEN LET l_apcf.apcf027 = " " END IF #責任中心
         IF cl_null(l_apcf.apcf028) THEN LET l_apcf.apcf028 = " " END IF #區域
         IF cl_null(l_apcf.apcf029) THEN LET l_apcf.apcf029 = " " END IF #收付款客商
         IF cl_null(l_apcf.apcf030) THEN LET l_apcf.apcf030 = " " END IF #帳款客商
         IF cl_null(l_apcf.apcf031) THEN LET l_apcf.apcf031 = " " END IF #客群
         IF cl_null(l_apcf.apcf032) THEN LET l_apcf.apcf032 = " " END IF #產品類別
         IF cl_null(l_apcf.apcf033) THEN LET l_apcf.apcf033 = " " END IF #業務人員
         IF cl_null(l_apcf.apcf034) THEN LET l_apcf.apcf034 = " " END IF #專案編號
         IF cl_null(l_apcf.apcf035) THEN LET l_apcf.apcf035 = " " END IF #WBS
         IF cl_null(l_apcf.apcf036) THEN LET l_apcf.apcf036 = " " END IF #經營方式
         IF cl_null(l_apcf.apcf037) THEN LET l_apcf.apcf037 = " " END IF #通路
         IF cl_null(l_apcf.apcf038) THEN LET l_apcf.apcf038 = " " END IF #品牌
         IF cl_null(l_apcf.apcf039) THEN LET l_apcf.apcf039 = " " END IF #自由核算項一
         IF cl_null(l_apcf.apcf040) THEN LET l_apcf.apcf040 = " " END IF #自由核算項二
         IF cl_null(l_apcf.apcf041) THEN LET l_apcf.apcf041 = " " END IF #自由核算項三
         IF cl_null(l_apcf.apcf042) THEN LET l_apcf.apcf042 = " " END IF #自由核算項四
         IF cl_null(l_apcf.apcf043) THEN LET l_apcf.apcf043 = " " END IF #自由核算項五
         IF cl_null(l_apcf.apcf044) THEN LET l_apcf.apcf044 = " " END IF #自由核算項六
         IF cl_null(l_apcf.apcf045) THEN LET l_apcf.apcf045 = " " END IF #自由核算項七
         IF cl_null(l_apcf.apcf046) THEN LET l_apcf.apcf046 = " " END IF #自由核算項八
         IF cl_null(l_apcf.apcf047) THEN LET l_apcf.apcf047 = " " END IF #自由核算項九
         IF cl_null(l_apcf.apcf048) THEN LET l_apcf.apcf048 = " " END IF #自由核算項十    
         
         LET l_apcf.apcf002 = 'D2'  #匯差類型D2
       
         #金額/匯率為空預設0
         IF cl_null(l_apcf.apcf101) THEN LET l_apcf.apcf101 = 0 END IF  #原幣單價
         IF cl_null(l_apcf.apcf102) THEN LET l_apcf.apcf102 = 0 END IF  #原幣匯率
         IF cl_null(l_apcf.apcf103) THEN LET l_apcf.apcf103 = 0 END IF  #原幣未稅金額
         IF cl_null(l_apcf.apcf104) THEN LET l_apcf.apcf104 = 0 END IF  #原幣稅額
         IF cl_null(l_apcf.apcf105) THEN LET l_apcf.apcf105 = 0 END IF  #原幣含稅金額
         IF cl_null(l_apcf.apcf106) THEN LET l_apcf.apcf106 = 0 END IF  #原幣沖銷差異金額
         IF cl_null(l_apcf.apcf111) THEN LET l_apcf.apcf111 = 0 END IF  #本幣單價
         IF cl_null(l_apcf.apcf113) THEN LET l_apcf.apcf113 = 0 END IF  #本幣未稅金額
         IF cl_null(l_apcf.apcf114) THEN LET l_apcf.apcf114 = 0 END IF  #本幣稅額
         IF cl_null(l_apcf.apcf115) THEN LET l_apcf.apcf115 = 0 END IF  #本幣含稅金額
         IF cl_null(l_apcf.apcf116) THEN LET l_apcf.apcf116 = 0 END IF  #本幣價差金額
         IF cl_null(l_apcf.apcf117) THEN LET l_apcf.apcf117 = 0 END IF  #本幣匯差金額
         IF cl_null(l_apcf.apcf122) THEN LET l_apcf.apcf122 = 0 END IF  #暫估本未幣二匯率
         IF cl_null(l_apcf.apcf123) THEN LET l_apcf.apcf123 = 0 END IF  #本位幣二未稅金額
         IF cl_null(l_apcf.apcf124) THEN LET l_apcf.apcf124 = 0 END IF  #本位幣二稅額
         IF cl_null(l_apcf.apcf125) THEN LET l_apcf.apcf125 = 0 END IF  #本位幣二含稅金額
         IF cl_null(l_apcf.apcf126) THEN LET l_apcf.apcf126 = 0 END IF  #本位幣二價格差異金額
         IF cl_null(l_apcf.apcf127) THEN LET l_apcf.apcf127 = 0 END IF  #本位幣二匯差
         IF cl_null(l_apcf.apcf132) THEN LET l_apcf.apcf132 = 0 END IF  #暫估本位幣三匯率
         IF cl_null(l_apcf.apcf133) THEN LET l_apcf.apcf133 = 0 END IF  #本位幣三未稅金額
         IF cl_null(l_apcf.apcf134) THEN LET l_apcf.apcf134 = 0 END IF  #本位幣三稅額
         IF cl_null(l_apcf.apcf135) THEN LET l_apcf.apcf135 = 0 END IF  #本位幣三含稅金額
         IF cl_null(l_apcf.apcf136) THEN LET l_apcf.apcf136 = 0 END IF  #本位幣三價格差異金額
         IF cl_null(l_apcf.apcf137) THEN LET l_apcf.apcf137 = 0 END IF  #本位幣三匯差
         
         INSERT INTO apcf_t(apcfent,apcfld,apcforga,apcfdocno,apcfseq,
                            apcfseq2,apcf001,apcf002,apcf007,apcf008,
                            apcf009,apcf010,apcf020,apcf021,apcf022,
                            apcf023,apcf024,apcf025,apcf026,apcf027,
                            apcf028,apcf029,apcf030,apcf031,apcf032,
                            apcf033,apcf034,apcf035,apcf036,apcf037,
                            apcf038,apcf039,apcf040,apcf041,apcf042,
                            apcf043,apcf044,apcf045,apcf046,apcf047,
                            apcf048,apcf049,apcf101,apcf102,apcf103,
                            apcf104,apcf105,apcf106,apcf111,apcf113,
                            apcf114,apcf115,apcf116,apcf117,apcf122,
                            apcf123,apcf124,apcf125,apcf126,apcf127,
                            apcf132,apcf133,apcf134,apcf135,apcf136,
                            apcf137,apcfud001,apcfud002,apcfud003,apcfud004,
                            apcfud005,apcfud006,apcfud007,apcfud008,apcfud009,
                            apcfud010,apcfud011,apcfud012,apcfud013,apcfud014,
                            apcfud015,apcfud016,apcfud017,apcfud018,apcfud019,
                            apcfud020,apcfud021,apcfud022,apcfud023,apcfud024,
                            apcfud025,apcfud026,apcfud027,apcfud028,apcfud029,
                            apcfud030)
         VALUES(l_apcf.apcfent,l_apcf.apcfld,l_apcf.apcforga,l_apcf.apcfdocno,l_apcf.apcfseq,
                l_apcf.apcfseq2,l_apcf.apcf001,l_apcf.apcf002,l_apcf.apcf007,l_apcf.apcf008,
                l_apcf.apcf009,l_apcf.apcf010,l_apcf.apcf020,l_apcf.apcf021,l_apcf.apcf022,
                l_apcf.apcf023,l_apcf.apcf024,l_apcf.apcf025,l_apcf.apcf026,l_apcf.apcf027,
                l_apcf.apcf028,l_apcf.apcf029,l_apcf.apcf030,l_apcf.apcf031,l_apcf.apcf032,
                l_apcf.apcf033,l_apcf.apcf034,l_apcf.apcf035,l_apcf.apcf036,l_apcf.apcf037,
                l_apcf.apcf038,l_apcf.apcf039,l_apcf.apcf040,l_apcf.apcf041,l_apcf.apcf042,
                l_apcf.apcf043,l_apcf.apcf044,l_apcf.apcf045,l_apcf.apcf046,l_apcf.apcf047,
                l_apcf.apcf048,l_apcf.apcf049,l_apcf.apcf101,l_apcf.apcf102,l_apcf.apcf103,
                l_apcf.apcf104,l_apcf.apcf105,l_apcf.apcf106,l_apcf.apcf111,l_apcf.apcf113,
                l_apcf.apcf114,l_apcf.apcf115,l_apcf.apcf116,l_apcf.apcf117,l_apcf.apcf122,
                l_apcf.apcf123,l_apcf.apcf124,l_apcf.apcf125,l_apcf.apcf126,l_apcf.apcf127,
                l_apcf.apcf132,l_apcf.apcf133,l_apcf.apcf134,l_apcf.apcf135,l_apcf.apcf136,
                l_apcf.apcf137,l_apcf.apcfud001,l_apcf.apcfud002,l_apcf.apcfud003,l_apcf.apcfud004,
                l_apcf.apcfud005,l_apcf.apcfud006,l_apcf.apcfud007,l_apcf.apcfud008,l_apcf.apcfud009,
                l_apcf.apcfud010,l_apcf.apcfud011,l_apcf.apcfud012,l_apcf.apcfud013,l_apcf.apcfud014,
                l_apcf.apcfud015,l_apcf.apcfud016,l_apcf.apcfud017,l_apcf.apcfud018,l_apcf.apcfud019,
                l_apcf.apcfud020,l_apcf.apcfud021,l_apcf.apcfud022,l_apcf.apcfud023,l_apcf.apcfud024,
                l_apcf.apcfud025,l_apcf.apcfud026,l_apcf.apcfud027,l_apcf.apcfud028,l_apcf.apcfud029,
                l_apcf.apcfud030)
      END IF
      #產生匯差數據---(E)---
   END FOREACH
END FUNCTION

################################################################################
# Descriptions...: 取產品科目編號
# Memo...........:
# Usage..........: CALL s_get_item_acc_fetch(p_ld,p_type,p_item,p_kind,p_trade,p_site,p_ware)
#                  RETURNING r_acc
# Input parameter: p_type         取得科目類型
#                : p_item         料件編號
# Return code....: r_acc          科目編號
#                : r_success      TRUE/FALSE
# Date & Author..: 2019/08/19 By 05795
# Modify.........: #190815-00012#1 add 判断这个库位是否存在科目
################################################################################
PUBLIC FUNCTION s_aapp131_item_acc_fetch(p_ld,p_type,p_item,p_kind,p_trade,p_site,p_ware)
    DEFINE p_ld      LIKE glcc_t.glccld
DEFINE p_type    LIKE type_t.num5
DEFINE p_item    LIKE glcc_t.glcc016
DEFINE p_kind    LIKE glcc_t.glcc012
DEFINE p_trade   LIKE glcc_t.glcc013
DEFINE p_site    LIKE glcc_t.glcc014
DEFINE p_ware    LIKE glcc_t.glcc015
DEFINE r_success LIKE type_t.num5
DEFINE r_acc     LIKE glcc_t.glcc002
DEFINE l_ooag004 LIKE ooag_t.ooag004
DEFINE l_ooef017 LIKE ooef_t.ooef017
DEFINE l_imag011 LIKE imag_t.imag011
DEFINE l_glcc001 LIKE glcc_t.glcc001
DEFINE l_glcc002 LIKE glcc_t.glcc002
DEFINE l_glcc003 LIKE glcc_t.glcc003
DEFINE l_glcc004 LIKE glcc_t.glcc004
DEFINE l_glcc005 LIKE glcc_t.glcc005
DEFINE l_glcc006 LIKE glcc_t.glcc006
DEFINE l_glcc017 LIKE glcc_t.glcc017
DEFINE l_glcc018 LIKE glcc_t.glcc018
DEFINE l_glcc019 LIKE glcc_t.glcc019
DEFINE l_glcc020 LIKE glcc_t.glcc020
DEFINE l_item_flag    LIKE type_t.num5
DEFINE l_imag011_flag LIKE type_t.num5
DEFINE l_kind_flag    LIKE type_t.num5
DEFINE l_trade_flag   LIKE type_t.num5
DEFINE l_site_flag    LIKE type_t.num5
DEFINE l_ware_flag    LIKE type_t.num5
DEFINE l_sql   STRING
   
   LET r_success = TRUE
   
   LET l_sql = " SELECT glcc002",  
               "   FROM glcc_t",
               "  WHERE glccent = ",g_enterprise,
               "    AND glcc001 = ?",
               "    AND glccld = ?",      
               "    AND glccstus = 'Y'",  
               #料件編號
               "    AND (COALESCE(glcc016,' ') = COALESCE(?,' ')  OR 1=?)",
               #成本分群(不管有沒有值，還是要與axct701產生的glcc_t一樣)
               "    AND (COALESCE(glcc011,' ') = COALESCE(?,' ') OR 1=?)",
               #採購(銷售)分群
               "    AND (COALESCE(glcc012,' ') = COALESCE(?,' ') OR 1=?)",
               #交易通路
               "    AND (COALESCE(glcc013,' ') = COALESCE(?,' ') OR 1=?)",
               #營運據點
               "    AND (COALESCE(glcc014,' ') = COALESCE(?,' ') OR 1=?)",
               #倉庫別
               "    AND (COALESCE(glcc015,' ') = COALESCE(?,' ') OR 1=?)",
               #順序是 料號優先、成本分群、倉庫別....
               "  ORDER BY glcc016 DESC,glcc011 DESC,glcc015 DESC,glcc014 DESC,glcc013 DESC,glcc012 DESC,glccseq "
               
   PREPARE s_aapp131_acc_pre1 FROM l_sql
   DECLARE s_aapp131_acc_curs1 SCROLL CURSOR FOR s_aapp131_acc_pre1
   
   LET l_sql = " SELECT COALESCE(a1,a2) FROM (",
               " SELECT imag011 a1,'' a2 FROM imag_t",
               "  WHERE imagent = ",g_enterprise,
               "    AND imag001 = ?",
               "    AND imagsite = (SELECT glaacomp FROM glaa_t WHERE glaaent = ",g_enterprise," AND glaald = ?)",
               "  UNION ALL ",   
               " SELECT '' a1,imag011 a2 FROM imag_t",
               "  WHERE imagent = ",g_enterprise,
               "    AND imag001 = ?",
               "    AND imagsite = 'ALL'",
               #" ) " #PGS(D)-01531 mark
               " ) t51 " #PGS(D)-01531 add
   PREPARE s_aapp131_acc_pre2 FROM l_sql
   DECLARE s_aapp131_acc_curs2 SCROLL CURSOR FOR s_aapp131_acc_pre2
    
  
   IF p_type = '1' OR p_type = '2' OR p_type = '17' OR p_type = '23'  THEN    
      LET l_glcc001 = '1'
   END IF
   IF p_type = '16' THEN
      LET l_glcc001 = '1'
      LET p_type = '11'
   END IF
   IF cl_null(l_glcc001) THEN
      RETURN 0,''
   END IF
   
   #空白無值者，則取登錄人員之歸屬據點－＞歸屬法人－＞法人之主帳套
   IF cl_null(p_ld) THEN
      SELECT ooag004 INTO l_ooag004 
        FROM ooag_t
       WHERE ooagent = g_enterprise
         AND ooag001 = g_user
      SELECT ooef017 INTO l_ooef017
        FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_ooga004
      SELECT glaald INTO p_ld
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaacomp = l_ooef017
         AND glaa014 = 'Y'         
   END IF
   
 
   LET l_item_flag    = ""
   LET l_imag011_flag = ""
   LET l_kind_flag    = ""
   LET l_trade_flag   = ""
   LET l_site_flag    = ""
   LET l_ware_flag    = ""
   
   #當p_itemt有值時，才要過濾glcc016，所以傳參為NULL值時增加OR 1=1條件，傳參非NULL時增加OR 1=2條件；其他條件也是類似的處理
   IF cl_null(p_item) THEN
      LET l_item_flag = 1
      LET l_imag011_flag = 1
   ELSE
      LET l_item_flag = 2
      
      LET l_imag011 = ''
      OPEN s_aapp131_acc_curs2 USING p_item,p_ld,p_item
      FETCH FIRST s_aapp131_acc_curs2 INTO l_imag011      
      IF cl_null(l_imag011) THEN
         LET l_imag011_flag = 1
      ELSE
         LET l_imag011_flag = 2
      END IF
   END IF
   
   IF cl_null(p_kind) THEN
      LET l_kind_flag = 1
   ELSE
      LET l_kind_flag = 2
   END IF 
   
   IF cl_null(p_trade) THEN
      LET l_trade_flag = 1
   ELSE
      LET l_trade_flag = 2
   END IF 
   
   IF cl_null(p_site) THEN
      LET l_site_flag = 1
   ELSE
      LET l_site_flag = 2
   END IF 
   
   IF cl_null(p_ware) THEN
      LET l_ware_flag = 1
   ELSE
      LET l_ware_flag = 2
   END IF 
   
   
   OPEN s_aapp131_acc_curs1 USING l_glcc001,p_ld,p_item,l_item_flag,l_imag011,l_imag011_flag,p_kind,l_kind_flag,
                        p_trade,l_trade_flag,p_site,l_site_flag,p_ware,l_ware_flag
   FETCH FIRST s_aapp131_acc_curs1 INTO l_glcc002
   IF SQLCA.sqlcode THEN
      LET r_success = FALSE
      LET r_acc = ''
      RETURN r_success,r_acc
   END IF
   
  
   
   CLOSE s_aapp131_acc_curs1
   CLOSE s_aapp131_acc_curs2
   
   RETURN r_success,r_acc
END FUNCTION

################################################################################
# Descriptions...: 多角帳務單據寫入商用發票號碼(Invoice No.)
# Memo...........:
# Usage..........: CALL s_aapp131_get_invoice(p_prog,p_ld,p_apcadocno)
#                  
# Input parameter: p_prog         程式代號
#                : p_ld           帳套
#                : p_apcadocno    帳務單號(AP/AR)
# Return code....: 
# Date & Author..: 2020/09/10 By 07804   #200909-00012#1 add
# Modify.........:
################################################################################
PUBLIC FUNCTION s_aapp131_get_invoice(p_prog,p_ld,p_apcadocno)
   DEFINE p_prog      LIKE type_t.chr20     #作業編號
   DEFINE p_ld        LIKE apca_t.apcald
   DEFINE p_apcadocno LIKE apca_t.apcadocno
   DEFINE l_sql       STRING
   DEFINE l_tmp       RECORD
                      apcbdocno LIKE apcb_t.apcbdocno,                      
                      apcb002   LIKE apcb_t.apcb002
                      END RECORD  
   DEFINE l_xmdk056   LIKE xmdk_t.xmdk056  #Invoice No.
   
   
   #情境: aapi011 摘要設定了商用發票號碼取值,若不先在此段處理,則會取不到資料
   CASE 
      WHEN (p_prog MATCHES 'axrp141*')
      
         #抓應付單對應入庫單號
         LET l_sql = " SELECT DISTINCT apcbdocno, apcb002 ",
                     "   FROM apcb_t ",
                     "  WHERE apcbent =",g_enterprise," AND apcbld ='",p_ld,"' AND apcbdocno ='",p_apcadocno,"' AND apcb001 = '11' "

         PREPARE s_aapp131_sel_tmp2p1 FROM l_sql
         DECLARE s_aapp131_sel_tmp2c1 CURSOR FOR s_aapp131_sel_tmp2p1
         

         #抓出貨單對應目標站的應付單據,多角流水號依照來源單只會有一張, 取得出貨單的Invoice No.
         LET l_sql = " SELECT xmdk056 ", 
                     "   FROM xmdk_t ",
                     "  WHERE xmdkent = ",g_enterprise,
                     "    AND xmdksite = (SELECT A.icab003 FROM icab_t A  WHERE A.icabent = ",g_enterprise, 
                     "                       AND (A.icab001,A.icab002) ",
                     "                           IN (SELECT B.icab001,B.icab002+1 FROM icab_t B ",
                     "                                WHERE B.icabent = ",g_enterprise,
                     "                                 AND (B.icab001,B.icab003) = (SELECT C.pmds053,C.pmdssite FROM pmds_t C WHERE C.pmdsent = ",g_enterprise,
                     "                                                                 AND C.pmdsdocno = ?) ",
                     "                              )",
                     "                   )",
                     "    AND xmdk035 = (SELECT D.pmds041 FROM pmds_t D WHERE D.pmdsent = ",g_enterprise," AND D.pmdsdocno = ?) " 
         
         PREPARE s_aapp131_sel_tmp2p2 FROM l_sql
         
         FOREACH s_aapp131_sel_tmp2c1 INTO l_tmp.*
            IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
                        
            EXECUTE s_aapp131_sel_tmp2p2 USING l_tmp.apcb002,l_tmp.apcb002 INTO l_xmdk056
            IF cl_null(l_xmdk056)THEN CONTINUE FOREACH END IF
         
            #回寫單據
            UPDATE apca_t SET apca021 = l_xmdk056
             WHERE apcaent = g_enterprise
               AND apcald  = p_ld
               AND apcadocno = l_tmp.apcbdocno
            IF SQLCA.SQLCODE THEN CONTINUE FOREACH END IF
            DISPLAY p_prog," SUCCESS:",l_tmp.apcbdocno,",",l_xmdk056
         END FOREACH      
   END CASE
END FUNCTION

 
{</section>}
 
